
Процедура ОткрытьКассовуюСмену(ККТ) Экспорт

	ОбработкаОбслуживания = Неопределено;
	ОбъектДрайвера = Неопределено;
	
	Если ТипЗнч(ККТ) = Тип("СправочникСсылка.КассыККМ") тогда
		ВыбКассаККМ=ККТ;
	иначе
		ВыбКассаККМ=ККТ.КассаККМ;
	КонецЕсли;

	Если ВыбКассаККМ<> Неопределено Тогда
		ИскомаяСтрока = глТорговоеОборудование.млККТ.Найти(ВыбКассаККМ, "КассаККМ");
		ОбъектДрайвера = ИскомаяСтрока.Объект;
		Ответ = "";
	КонецЕсли;
	
	
	//ПолучитьСерверТО().ПолучитьОбъектДрайвера(ККТ, ОбработкаОбслуживания, ОбъектДрайвера);
	//  
	    ФормаОбработки = глТорговоеОборудование.ПолучитьФормуОбработки(ИскомаяСтрока.Модель.ОбработкаОбслуживания);
		РезультатВыполнения = ФормаОбработки.ОткрытьСмену(ОбъектДрайвера);
		
		Если РезультатВыполнения <> ПредопределенноеЗначение("Перечисление.ТООшибкиОбщие.ПустаяСсылка") Тогда
			СообщитьОбОшибке(ОбъектДрайвера.ОписаниеОшибки);
		Иначе
			//КассаККМ = ПолучитьСерверТО().ПолучитьКассуККМ(ККТ);
			
			ПараметрыКоманды = Новый Структура();
			ПараметрыКоманды.Вставить("ВыполняемаяКоманда", "ОткрытьСмену");
			ПараметрыКоманды.Вставить("ФискальноеУстройство", ККТ);
			ПараметрыКоманды.Вставить("КассаККМ", ВыбКассаККМ);
			
			///Переделать!
			Организация = ВыбКассаККМ.Владелец;
			
			ПараметрыКоманды.Вставить("Организация", Организация);
			
			КассовыеСменыВызовСервера.ПослеВыполненияКомандыФискальнымУстройством(ПараметрыКоманды);
		КонецЕсли;


КонецПроцедуры

Процедура ЗакрытьКассовуюСмену(ККТ, ДокументКассоваяСмена, ОбрабатыватьЧекиККМ = Истина) Экспорт
	
	ОбработкаОбслуживания = Неопределено;
	ОбъектДрайвера = Неопределено;
	
	
	Если ККТ<> Неопределено Тогда
		ИскомаяСтрока = глТорговоеОборудование.млККТ.Найти(ККТ, "КассаККМ");
		ОбъектДрайвера = ИскомаяСтрока.Объект;
		Ответ = "";
	КонецЕсли;
	
	ФормаОбработки = глТорговоеОборудование.ПолучитьФормуОбработки(ИскомаяСтрока.Модель.ОбработкаОбслуживания);
	РезультатВыполнения = ФормаОбработки.ЗакрытьСмену(ОбъектДрайвера);
	
	
	Если РезультатВыполнения <> ПредопределенноеЗначение("Перечисление.ТООшибкиОбщие.ПустаяСсылка") Тогда
		СообщитьОбОшибке(ИскомаяСтрока.Объект.ОписаниеОшибки);
	Иначе
		ПараметрыКоманды = Новый Структура();
		ПараметрыКоманды.Вставить("ВыполняемаяКоманда", "ЗакрытьСмену");
		ПараметрыКоманды.Вставить("КассоваяСмена", ДокументКассоваяСмена);
		ПараметрыКоманды.Вставить("ОбрабатыватьЧекиККМ", ОбрабатыватьЧекиККМ);
		
		Если (ОбъектДрайвера.ВыходныеПараметры.Количество() > 4) И ОбъектДрайвера.ВыходныеПараметры[4] <> Неопределено Тогда
			ПараметрыКоманды.Вставить("ФискальныеДанныеСтруктура", ОбъектДрайвера.ВыходныеПараметры[4]);
		КонецЕсли;
		Если (ОбъектДрайвера.ВыходныеПараметры.Количество() > 5) И ОбъектДрайвера.ВыходныеПараметры[5] <> Неопределено Тогда
			ПараметрыКоманды.Вставить("ФискальныеДанныеXMLСтрока", ОбъектДрайвера.ВыходныеПараметры[5]);
		КонецЕсли;
		КассовыеСменыВызовСервера.ПослеВыполненияКомандыФискальнымУстройством(ПараметрыКоманды);
		СозданныеДокументы = Новый Массив;
		Если ПараметрыКоманды.Свойство("СозданныеДокументы", СозданныеДокументы) Тогда
			Для Каждого СозданныйДокумент Из СозданныеДокументы Цикл
				СозданныйДокумент.ПолучитьФорму().Открыть();
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры
