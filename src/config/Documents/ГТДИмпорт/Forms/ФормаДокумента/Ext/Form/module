////////////////////////////////////////////////////////////////////////////////
// ПЕРЕМЕННЫЕ МОДУЛЯ

// Хранит текущую дату документа - для проверки перехода документа в другой период установки номера
Перем мТекущаяДатаДокумента; 

// Хранит валюту взаиморасчетов, установленную в текущем договоре взаиморасчетов,
// используется для определения необходимости пересчетов при изменении договора.
Перем мТекущаяВалютаВзаиморасчетов; 

// Хранит текущий договор контрагента
// используется для восстановления старого договора в случае некорректного выбора нового
Перем мТекущийДоговорКонтрагента; 

Перем мКолонкиТовары;

////////////////////////////////////////////////////////////////////////////////
// ЭКСПОРТНЫЕ ПРОЦЕДУРЫ 

// Вычисляем суммы по данному разделу.
//
//  Раздел - строка табличной части, определяет раздел, по которому надо посчитать суммы.
//
Процедура ВычислимСуммы(Раздел)

	ВсегоСтоимость = 0;
	ВсегоПошлина   = 0;
	ВсегоНДС       = 0;
	
	НомерРаздела = Разделы.Индекс(Раздел) + 1;
	
	ПосчитатьИтогиПоРазделу(НомерРаздела, ВсегоСтоимость, ВсегоПошлина, ВсегоНДС);

	ЭлементыФормы.Всего.Значение        = ФорматСумм(ВсегоСтоимость);
	ЭлементыФормы.ВсегоПошлина.Значение = ФорматСумм(ВсегоПошлина);
	ЭлементыФормы.ВсегоНДС.Значение     = ФорматСумм(ВсегоНДС);

	Раздел.ТаможеннаяСтоимость = ВсегоСтоимость;
	
	Раздел.СуммаПошлины = 
	       РассчитатьСуммуПошлиныГТД(Раздел.ТаможеннаяСтоимость, Раздел.ТаможеннаяСтоимостьВВалютеРеглУчета, Раздел.СтавкаПошлины, Раздел.ПошлинаВВалюте);

	Раздел.СуммаНДС = 
	       РассчитатьСуммуНДСГТД(Раздел.ТаможеннаяСтоимость, Раздел.ТаможеннаяСтоимостьВВалютеРеглУчета, Раздел.СуммаПошлины, Раздел.ПошлинаВВалюте, Раздел.СтавкаНДС, Раздел.НДСВВалюте);

КонецПроцедуры // ВычислимСуммы()

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ОБЩЕГО НАЗНАЧЕНИЯ

// Считает итоги по ТЧ Товары и выводит строку в подвале.
//
// Параметры
//  Раздел          - строка табличной части, определяет раздел, по которому надо посчитать суммы.
//  ВсегоСтоимость  – число, в этот параметр будет возвращен итог по колонке "ФактурнаяСтоимость",
//  ВсегоПошлина    – число, в этот параметр будет возвращен итог по колонке "СуммаПошлины",
//  ВсегоНДС        – число, в этот параметр будет возвращен итог по колонке "СуммаНДС",
//
Процедура ПосчитатьИтогиПоТОварам(Раздел, ВсегоСтоимость, ВсегоПошлина, ВсегоНДС)
	
	НомерРаздела = Разделы.Индекс(Раздел) + 1;
	
	ПосчитатьИтогиПоРазделу(НомерРаздела, ВсегоСтоимость, ВсегоПошлина, ВсегоНДС);

	ЭлементыФормы.Всего.Значение        = ФорматСумм(ВсегоСтоимость);
	ЭлементыФормы.ВсегоПошлина.Значение = ФорматСумм(ВсегоПошлина);
	ЭлементыФормы.ВсегоНДС.Значение     = ФорматСумм(ВсегоНДС);

КонецПроцедуры // ПосчитатьИтогиПоТоварам()

// Расчитывает сумму таможенной пошлины.
//
// Параметры
//  ТаможеннаяСтоимость        - число, величина таможенной стоимости в валюте документа,
//  ТаможеннаяСтоимостьВРублях - булево, признак того, что таможенная стоимость задается в рублях, иначе - в валюте документа,
//  СтавкаПошлины              - число, ставка пошлины, 
//  ПошлинаВВалюте             - булево, признак того, что пошлину надо платить в валюте основного договора с таможней.
//
// Возвращаемое значение:
//   Число  – сумма пошлины.
//
Функция РассчитатьСуммуПошлиныГТД(ТаможеннаяСтоимость, ТаможеннаяСтоимостьВРублях, СтавкаПошлины, ПошлинаВВалюте)


	Если ТаможеннаяСтоимостьВРублях Тогда 
		ВалютаТаможеннойСтоимости    = мВалютаРегламентированногоУчета;
		КурсТаможеннойСтоимости      = 1;
		КратностьТаможеннойСтоимости = 1;
	Иначе
		ВалютаТаможеннойСтоимости    = ВалютаДокумента;
		КурсТаможеннойСтоимости      = КурсДокумента;
		КратностьТаможеннойСтоимости = КратностьДокумента;
	КонецЕсли;
	

	Если ЗначениеНеЗаполнено(ВалютаДокумента) 
	   И ВалютаТаможеннойСтоимости = ВалютаДокумента Тогда

		Предупреждение("Не выбрана валюта документа!");
		ТаможеннаяСтоимостьВал = ТаможеннаяСтоимость;
	
	ИначеЕсли ПошлинаВВалюте Тогда

		Если ЗначениеНеЗаполнено(мТекущаяВалютаВзаиморасчетов) Тогда

			Предупреждение("Не выбран договор с таможней, который определяет валюту таможенных платежей!");
			ТаможеннаяСтоимостьВал = ТаможеннаяСтоимость;

		Иначе

			ТаможеннаяСтоимостьВал = ПересчитатьИзВалютыВВалюту(ТаможеннаяСтоимость,
			                         ВалютаТаможеннойСтоимости, мТекущаяВалютаВзаиморасчетов, КурсТаможеннойСтоимости,
			                         КурсВзаиморасчетов, КратностьТаможеннойСтоимости, КратностьВзаиморасчетов);
		КонецЕсли;

	
	Иначе

		ТаможеннаяСтоимостьВал = ПересчитатьИзВалютыВВалюту(ТаможеннаяСтоимость,
		                         ВалютаТаможеннойСтоимости, мВалютаРегламентированногоУчета,
		                         КурсТаможеннойСтоимости,1,
		                         КратностьТаможеннойСтоимости, 1);

	КонецЕсли;

	Возврат ТаможеннаяСтоимостьВал * СтавкаПошлины / 100;

КонецФункции // РассчитатьСуммуПошлиныГТД()

// Расчитывает сумму таможенной пошлины.
//
// Параметры
//  ТаможеннаяСтоимость        -  число, величина таможенной стоимости в валюте документа,
//  ТаможеннаяСтоимостьВРублях - булево, признак того, что таможенная стоимость задается в рублях, иначе - в валюте документа,
//  СуммаПошлины               - число, сумма пошлины, 
//  СтавкаПошлины              - число, ставка пошлины, 
//  ПошлинаВВалюте             - булево, признак того, что пошлина в валюте основного договора с таможней (иначе в валюте регл. учета).
//  СтавкаНДС                  - ссылка на перечисление, определяющая ставку НДС, 
//  НДСВВалюте                 - булево, признак того, что НДС надо считать в валюте основного договора с таможней (иначе в валюте регл. учета).
//
// Возвращаемое значение:
//   Число  – сумма НДС.
//
Функция РассчитатьСуммуНДСГТД(ТаможеннаяСтоимость, ТаможеннаяСтоимостьВРублях, СуммаПошлины, ПошлинаВВалюте, СтавкаНДС, НДСВВалюте)

	Если ТаможеннаяСтоимостьВРублях Тогда 
		ВалютаТаможеннойСтоимости    = мВалютаРегламентированногоУчета;
		КурсТаможеннойСтоимости      = 1;
		КратностьТаможеннойСтоимости = 1;
	Иначе
		ВалютаТаможеннойСтоимости    = ВалютаДокумента;
		КурсТаможеннойСтоимости      = КурсДокумента;
		КратностьТаможеннойСтоимости = КратностьДокумента;
	КонецЕсли;
	

	Если ЗначениеНеЗаполнено(ВалютаДокумента) 
	   И ВалютаТаможеннойСтоимости = ВалютаДокумента Тогда

		Предупреждение("Не выбрана валюта документа!");
		БазаНДС = 0;

	ИначеЕсли НДСВВалюте Тогда  // Надо все пересчитать в валюту расчетов с таможней.

		Если ЗначениеНеЗаполнено(мТекущаяВалютаВзаиморасчетов) Тогда
			Предупреждение("Не выбран договор с таможней, который определяет валюту таможенных платежей!");
			ТаможеннаяСтоимостьВал = ТаможеннаяСтоимость;

		Иначе

			ТаможеннаяСтоимостьВал = ПересчитатьИзВалютыВВалюту(ТаможеннаяСтоимость,
			                         ВалютаТаможеннойСтоимости, мТекущаяВалютаВзаиморасчетов, КурсТаможеннойСтоимости,
			                         КурсВзаиморасчетов, КратностьТаможеннойСтоимости, КратностьВзаиморасчетов);
		КонецЕсли;

		Если ПошлинаВВалюте Тогда
			СуммаПошлиныВал = СуммаПошлины;
		Иначе
			СуммаПошлиныВал = ПересчитатьИзВалютыВВалюту(СуммаПошлины,
			                   мВалютаРегламентированногоУчета, мТекущаяВалютаВзаиморасчетов,
			                   1, КурсВзаиморасчетов, 1, КратностьВзаиморасчетов);
		КонецЕсли;

		БазаНДС = ТаможеннаяСтоимостьВал + СуммаПошлиныВал;
	
	Иначе // Надо все пересчитать в валюту регл. учета.

		ТаможеннаяСтоимостьВал = ПересчитатьИзВалютыВВалюту(ТаможеннаяСтоимость,
		                         ВалютаТаможеннойСтоимости, мВалютаРегламентированногоУчета,
		                         КурсТаможеннойСтоимости,1,
		                         КратностьТаможеннойСтоимости, 1);

		Если ПошлинаВВалюте Тогда

			СуммаПошлиныВал = ПересчитатьИзВалютыВВалюту(СуммаПошлины,
			                   мТекущаяВалютаВзаиморасчетов, мВалютаРегламентированногоУчета,
			                   КурсВзаиморасчетов, 1, КратностьВзаиморасчетов, 1);
		Иначе
			СуммаПошлиныВал = СуммаПошлины;
		КонецЕсли;

		БазаНДС = ТаможеннаяСтоимостьВал + СуммаПошлиныВал;
	
	КонецЕсли;

	Возврат РассчитатьСуммуНДС(БазаНДС, Истина, Ложь, ПолучитьСтавкуНДС(СтавкаНДС)); // УчитыватьНДС, Сумма не включает НДС.

КонецФункции // РассчитатьСуммуНДСГТД()

// Функция формирует список запросов для передачи в форму подбора.
//
// Параметры:
//  ТабличнаяЧасть - табличная часть, для подбора в которую формируется список запросов.
//
// Возвращаемое значение:
//  Список значений - список запросов.
//
Функция СформироватьСписокЗапросовДляПодбора(ТабличнаяЧасть)

	СписокЗапросов = Новый СписокЗначений();
	СписокЗапросов.Добавить(,"По справочнику");

	Возврат СписокЗапросов;

КонецФункции // СформироватьСписокЗапросовДляПодбора()

// Процедура обновляет параметры в форме подбора, если она открыта.
//
// Параметры:
//  Реквизит - измененный реквизит.
//
Процедура ОбновитьФормуПодбора(Реквизит)

	ОбновитьПараметрыИФормуПодбора(ЭтотОбъект, ЭтаФорма, Реквизит);

КонецПроцедуры // ОбновитьФормуПодбора()

// Процедура вызывает сервисный механизм для подбора номеклатуры в табличную часть.
//
// Параметры:
//  ТабличнаяЧасть - табличная часть, в которую осуществляется подбор.
//
Процедура ДействиеПодбор(ТабличнаяЧасть)

	Перем Команда, Валюта;

	ЕстьЦена  = Ложь;
	ЕстьСерия = Истина;

	Команда = "ПодборВТабличнуюЧастьТовары";
	Валюта  = ВалютаДокумента;
	ИмяТабличнойЧасти = "Товары";
	
	СписокВидовПодбора = СформироватьСписокЗапросовДляПодбора(ТабличнаяЧасть);
	ПредставлениеДок = Метаданные().Представление();

	СтруктураПараметровПодбора = Новый Структура();
	СтруктураПараметровПодбора.Вставить("Команда"              , Команда);
	СтруктураПараметровПодбора.Вставить("СписокВидовПодбора"   , СписокВидовПодбора);
	
	СтруктураПараметровПодбора.Вставить("Организация"          , Организация);
	
	СтруктураПараметровПодбора.Вставить("ЕстьЦена"             , ЕстьЦена);
	СтруктураПараметровПодбора.Вставить("ЕстьСерия"            , ЕстьСерия);
	СтруктураПараметровПодбора.Вставить("ВалютаДокумента"      , Валюта);
	СтруктураПараметровПодбора.Вставить("Заголовок", "Подбор номенклатуры в документ " + 
	                                    ПредставлениеДок + " № " + Номер + " (" + ИмяТабличнойЧасти + ")");

	ОткрытьПодборНоменклатуры(ЭтаФорма, СтруктураПараметровПодбора);

КонецПроцедуры // ДействиеПодбор()

// Производит заполнение документа переданными из формы подбора данными.
//
// Параметры:
//  ТабличнаяЧасть    - табличная часть, в которую надо добавлять подобранную позицию номенклатуры;
//  ЗначениеВыбора    - структура, содержащая параметры подбора.
//
Процедура ОбработкаПодбора(ТабличнаяЧасть, ЗначениеВыбора) Экспорт

	Перем СпособЗаполненияЦен, ВалютаЦены;
	Перем Номенклатура, ЕдиницаИзмерения, Количество, КоличествоМест, Цена, Характеристика, Серия;

	// Получим параметры подбора из структуры подбора.
	ЗначениеВыбора.Свойство("Номенклатура"    , Номенклатура);
	ЗначениеВыбора.Свойство("ЕдиницаИзмерения", ЕдиницаИзмерения);
	ЗначениеВыбора.Свойство("Количество"      , Количество);
	ЗначениеВыбора.Свойство("КоличествоМест"  , КоличествоМест);
	ЗначениеВыбора.Свойство("Характеристика"  , Характеристика);
	ЗначениеВыбора.Свойство("Серия"           , Серия);

	Если Номенклатура.Услуга Тогда
		Предупреждение("В данном контексте услуги не подбираются!");
		Возврат;
	КонецЕсли;

	// Ищем выбранную позицию в таблице подобранной номенклатуры.
	//  Если найдем - увеличим количество; не найдем - добавим новую строку.
	СтруктураОтбора = Новый Структура();

	СтруктураОтбора.Вставить("ЕдиницаИзмерения", ЕдиницаИзмерения);
	СтруктураОтбора.Вставить("ХарактеристикаНоменклатуры", Характеристика);
	СтруктураОтбора.Вставить("СерияНоменклатуры"         , Серия);

	СтрокаТабличнойЧасти = НайтиСтрокуТабЧасти(ТабличнаяЧасть, СтруктураОтбора);
	Если СтрокаТабличнойЧасти <> Неопределено Тогда

			// Нашли, увеличиваем количество в первой найденной строке.
			СтрокаТабличнойЧасти.Количество = СтрокаТабличнойЧасти.Количество + Количество;
			РассчитатьКоличествоМестТабЧасти(СтрокаТабличнойЧасти, ЭтотОбъект);

	Иначе

		// Не нашли - добавляем новую строку.
		СтрокаТабличнойЧасти = ТабличнаяЧасть.Добавить();
		СтрокаТабличнойЧасти.НомерРаздела     = Разделы.Индекс(ЭлементыФормы.Разделы.ТекущиеДанные) + 1;
		СтрокаТабличнойЧасти.Номенклатура     = Номенклатура;
		СтрокаТабличнойЧасти.Количество       = Количество;
		СтрокаТабличнойЧасти.ЕдиницаИзмерения = ЕдиницаИзмерения;
		СтрокаТабличнойЧасти.Коэффициент      = СтрокаТабличнойЧасти.ЕдиницаИзмерения.Коэффициент;
		СтрокаТабличнойЧасти.ХарактеристикаНоменклатуры = Характеристика;
		СтрокаТабличнойЧасти.СерияНоменклатуры          = Серия;

		РассчитатьКоличествоМестТабЧасти(СтрокаТабличнойЧасти, ЭтотОбъект);

	КонецЕсли; // СтрокаТабличнойЧасти <> Неопределено

	ЭлементыФормы["Товары"].ТекущаяСтрока = СтрокаТабличнойЧасти;
	ЭлементыФормы["Товары"].ТекущаяКолонка = ЭлементыФормы["Товары"].Колонки["Количество"];

КонецПроцедуры // ОбработкаПодбора()

// Процедура выполняет необходимые действия при изменении договора взаиморасчетов
// с контрагентом.
//
Процедура ПриИзмененииДоговора()

	НоваяВалютаВзаиморасчетов = ДоговорКонтрагента.ВалютаВзаиморасчетов;
	СтруктураКурса = ПолучитьКурсВалюты(НоваяВалютаВзаиморасчетов, Дата);
	//Предложим пересчитать Таможенный сбор и штрафы
	Если Не ЗначениеНеЗаполнено(мТекущаяВалютаВзаиморасчетов)
	   И Не ЗначениеНеЗаполнено(НоваяВалютаВзаиморасчетов)
	   И (Не ЗначениеНеЗаполнено(ТаможенныйСборВал)
		  Или Не ЗначениеНеЗаполнено(ТаможенныйШтрафВал))
	   И (мТекущаяВалютаВзаиморасчетов <> НоваяВалютаВзаиморасчетов) Тогда

		Ответ = Вопрос("Изменилась валюта таможенных платежей. Пересчитать суммы таможенного сбора и шрафа? ", РежимДиалогаВопрос.ДаНет);
		Если Ответ = КодВозвратаДиалога.Да Тогда

			ТаможенныйСборВал  = ПересчитатьИзВалютыВВалюту(ТаможенныйСборВал, мТекущаяВалютаВзаиморасчетов, НоваяВалютаВзаиморасчетов,
			                                               КурсВзаиморасчетов, СтруктураКурса.Курс, КратностьВзаиморасчетов, СтруктураКурса.Кратность);
		
			ТаможенныйШтрафВал = ПересчитатьИзВалютыВВалюту(ТаможенныйШтрафВал, мТекущаяВалютаВзаиморасчетов, НоваяВалютаВзаиморасчетов,
			                                               КурсВзаиморасчетов, СтруктураКурса.Курс, КратностьВзаиморасчетов, СтруктураКурса.Кратность);
		КонецЕсли;

	КонецЕсли;

	// Присвоим новые значения
	мТекущаяВалютаВзаиморасчетов = НоваяВалютаВзаиморасчетов;
	КурсВзаиморасчетов           = СтруктураКурса.Курс;
	КратностьВзаиморасчетов      = СтруктураКурса.Кратность;

	// Установим заголовки по новой валюте взаиморасчетов:
	ПоменятьНадписи();

	УстановитьВидимость();

КонецПроцедуры // ПриИзмененииДоговора()

// Процедура добавляет строку в ТЧ Разделы и заполняет ее значениями по умолчанию.
//
Процедура ДобавитьРазделГТД()

	ЭлементыФормы.Разделы.ТекущаяСтрока = ДобавитьРаздел();
	УстановитьСтраницуПоРазделамГТД();

КонецПроцедуры // ДобавитьРазделГТД()

// Определяет, какую страницу нужно показывать по разделам ГТД.
//
Процедура УстановитьСтраницуПоРазделамГТД()

//	УстановитьТекущуюСтраницу("ПанельРазделов",ЭлементыФормы.ОсновнаяПанель);

	Если Разделы.Количество() < 2 Тогда // есть только один раздел
		УстановитьТекущуюСтраницу("ОдинРаздел", ЭлементыФормы.ПанельРазделов);

	Иначе
		УстановитьТекущуюСтраницу("НесколькоРазделов", ЭлементыФормы.ПанельРазделов);

	КонецЕсли;

	НомерРаздела = Разделы.Индекс(ЭлементыФормы.Разделы.ТекущиеДанные) + 1;
	ЭлементыФормы.Товары.ОтборСтрок.НомерРаздела.Использование = Истина;
	ЭлементыФормы.Товары.ОтборСтрок.НомерРаздела.Значение      = НомерРаздела;
	
КонецПроцедуры // УстановитьСтраницуПоРазделамГТД()

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ДЛЯ УПРАВЛЕНИЯ ВНЕШНИМ ВИДОМ ФОРМЫ

// Формирует заголовок исходя из переданной валюты (добавляет валюту в конец заголовка).
//
// Параметры
//  ТекстЗаголовка  – строка, текст заголовка,
//  Валюта          – ссылка на справочник валют.
//
Функция СформироватьЗаголовокПоВалюте(ТекстЗаголовка, Валюта)

	Если ЗначениеНеЗаполнено(Валюта) Тогда
		ТекстЗаголовка  = ТекстЗаголовка + " (<>):";
	Иначе
		ТекстЗаголовка  = ТекстЗаголовка + " (" + СокрЛП(Валюта) + "):";
	КонецЕсли;

	Возврат ТекстЗаголовка;

КонецФункции // СформироватьЗаголовокПоВалюте()

// Процедура устанавливает видимость для тех колонок в табличной части 
// "Товары", видимость которых определяется реквизитами документа.
//
// Параметры:
//  Нет.
//
Процедура УстановитьВидимость()

	Колонки = ЭлементыФормы.Товары.Колонки;

	ЭлементыФормы.ОтражатьВНалоговомУчете.Доступность = ОтражатьВБухгалтерскомУчете;
	
	ВидимостьРеквизитаПроект(ЭтотОбъект, ЭлементыФормы, "Товары.Проект");

КонецПроцедуры // УстановитьВидимость()

// Процедура устанавливает доступность для тех элементов формы, доступность которых определяется реквизитами документа.
//
// Параметры:
//  Нет.
//
Процедура УстановитьДоступность()

	ДоступностьВалютыТаможеннойСтоимости = НЕ (ЗначениеНеЗаполнено(ВалютаДокумента) ИЛИ (ВалютаДокумента = мВалютаРегламентированногоУчета));

	ЭлементыФормы.Разделы.Колонки.ТаможеннаяСтоимостьВВалютеРеглУчета.Доступность = ДоступностьВалютыТаможеннойСтоимости;
	ЭлементыФормы.ТаможеннаяСтоимостьВВалютеРеглУчета.Доступность                 = ДоступностьВалютыТаможеннойСтоимости;

КонецПроцедуры // УстановитьДоступность()

// Формирует надписи элементов формы, в частности при смене валют
//
Процедура ПоменятьНадписи()

	Если ЭлементыФормы.Разделы.ТекущиеДанные.ПошлинаВВалюте Тогда
		ЭлементыФормы.НадписьСуммаПошлины.Заголовок           = СформироватьЗаголовокПоВалюте("Пошлина", мТекущаяВалютаВзаиморасчетов);
		ЭлементыФормы.Товары.Колонки.СуммаПошлины.ТекстШапки  = СформироватьЗаголовокПоВалюте("Пошлина", мТекущаяВалютаВзаиморасчетов);
		ЭлементыФормы.НадписьВсегоПошлина.Заголовок           = СформироватьЗаголовокПоВалюте("Пошлина", мТекущаяВалютаВзаиморасчетов);
	Иначе
		ЭлементыФормы.НадписьСуммаПошлины.Заголовок           = СформироватьЗаголовокПоВалюте("Пошлина",мВалютаРегламентированногоУчета);
		ЭлементыФормы.Товары.Колонки.СуммаПошлины.ТекстШапки  = СформироватьЗаголовокПоВалюте("Пошлина", мВалютаРегламентированногоУчета);
		ЭлементыФормы.НадписьВсегоПошлина.Заголовок           = СформироватьЗаголовокПоВалюте("Пошлина", мВалютаРегламентированногоУчета);
	КонецЕсли;
	
	Если ЭлементыФормы.Разделы.ТекущиеДанные.НДСВВалюте Тогда
		ЭлементыФормы.НадписьСуммаНДС.Заголовок           = СформироватьЗаголовокПоВалюте("НДС",мТекущаяВалютаВзаиморасчетов);
		ЭлементыФормы.Товары.Колонки.СуммаНДС.ТекстШапки  = СформироватьЗаголовокПоВалюте("НДС", мТекущаяВалютаВзаиморасчетов);
		ЭлементыФормы.НадписьВсегоНДС.Заголовок           = СформироватьЗаголовокПоВалюте("НДС", мТекущаяВалютаВзаиморасчетов);
	Иначе
		ЭлементыФормы.НадписьСуммаНДС.Заголовок           = СформироватьЗаголовокПоВалюте("НДС",мВалютаРегламентированногоУчета);
		ЭлементыФормы.Товары.Колонки.СуммаНДС.ТекстШапки  = СформироватьЗаголовокПоВалюте("НДС", мВалютаРегламентированногоУчета);
		ЭлементыФормы.НадписьВсегоНДС.Заголовок           = СформироватьЗаголовокПоВалюте("НДС", мВалютаРегламентированногоУчета);
	КонецЕсли;

	ЭлементыФормы.НадписьВсего.Заголовок                  = СформироватьЗаголовокПоВалюте("Всего", ВалютаДокумента);

	Если ЭлементыФормы.Разделы.ТекущиеДанные.ТаможеннаяСтоимостьВВалютеРеглУчета Тогда
		ЭлементыФормы .НадписьТаможеннаяСтоимость.Заголовок = СформироватьЗаголовокПоВалюте("Таможенная стоимость", мВалютаРегламентированногоУчета);
	Иначе
		ЭлементыФормы .НадписьТаможеннаяСтоимость.Заголовок = СформироватьЗаголовокПоВалюте("Таможенная стоимость", ВалютаДокумента);
	КонецЕсли;

	ЭлементыФормы.ИнфНадписьКурса.Заголовок = "(" + ПолучитьИнформациюКурсаВалютыСтрокой(ВалютаДокумента, 
	                                                                                     КурсДокумента,
	                                                                                     КратностьДокумента,
	                                                                                     мВалютаРегламентированногоУчета)+ ")";

	ЭлементыФормы.НадписьДоговорРегл.Заголовок     = СформироватьЗаголовокПоВалюте("Депозит на таможне", мВалютаРегламентированногоУчета);
	ЭлементыФормы.НадписьТаможенныйСбор.Заголовок  = СформироватьЗаголовокПоВалюте("Таможенный сбор",    мВалютаРегламентированногоУчета);
	ЭлементыФормы.НадписьТаможенныйШтраф.Заголовок = СформироватьЗаголовокПоВалюте("Таможенный штраф",   мВалютаРегламентированногоУчета);

	ЭлементыФормы.НадписьДоговор.Заголовок            = СформироватьЗаголовокПоВалюте("Валютный депозит", мТекущаяВалютаВзаиморасчетов);
	ЭлементыФормы.НадписьТаможенныйСборВал.Заголовок  = СформироватьЗаголовокПоВалюте("Таможенный сбор",            мТекущаяВалютаВзаиморасчетов);
	ЭлементыФормы.НадписьТаможенныйШтрафВал.Заголовок = СформироватьЗаголовокПоВалюте("Таможенный штраф",           мТекущаяВалютаВзаиморасчетов);

	ЭлементыФормы.РамкаТоварыРаздела.Заголовок = "Товары по разделу " + (Разделы.Индекс(ЭлементыФормы.Разделы.ТекущиеДанные) + 1);

	Если ЗначениеНеЗаполнено(мТекущаяВалютаВзаиморасчетов) Тогда
		ФорматнаяСтрока = "БЛ='" + СокрЛП(мВалютаРегламентированногоУчета) + "'; БИ='не выбрана'";
	Иначе
		ФорматнаяСтрока = "БЛ='" + СокрЛП(мВалютаРегламентированногоУчета) + "'; БИ='" + СокрЛП(мТекущаяВалютаВзаиморасчетов) + "'";
	КонецЕсли;

	ЭлементыФормы.Разделы.Колонки.ПошлинаВВалюте.Формат                   = ФорматнаяСтрока;
	ЭлементыФормы.Разделы.Колонки.ПошлинаВВалюте.ЭлементУправления.Формат = ФорматнаяСтрока;
	ЭлементыФормы.Разделы.Колонки.НДСВВалюте.Формат                       = ФорматнаяСтрока;
	ЭлементыФормы.Разделы.Колонки.НДСВВалюте.ЭлементУправления.Формат     = ФорматнаяСтрока;

	Если ЗначениеНеЗаполнено(ВалютаДокумента)
	 ИЛИ (ВалютаДокумента = мВалютаРегламентированногоУчета) Тогда
		ФорматнаяСтрока = "БЛ='не выбрана'; БИ='" + СокрЛП(мВалютаРегламентированногоУчета) + "'";
	Иначе
		ФорматнаяСтрока = "БЛ='" + СокрЛП(ВалютаДокумента) + "'; БИ='" + СокрЛП(мВалютаРегламентированногоУчета) + "'";
	КонецЕсли;

	ЭлементыФормы.Разделы.Колонки.ТаможеннаяСтоимостьВВалютеРеглУчета.Формат                   = ФорматнаяСтрока;
	ЭлементыФормы.Разделы.Колонки.ТаможеннаяСтоимостьВВалютеРеглУчета.ЭлементУправления.Формат = ФорматнаяСтрока;

КонецПроцедуры // ПоменятьНадписи()

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ

// Процедура - обработчик события "ПередОткрытием" формы.
//
Процедура ПередОткрытием(Отказ, СтандартнаяОбработка)

	Если ТипЗнч(ПараметрОснование) = Тип("ДокументСсылка.ПоступлениеТоваровУслугВНеавтоматизированнуюТорговуюТочку")
	   И (Не ПараметрОснование.ВидОперации = Перечисления.ВидыОперацийПоступлениеТоваровУслугВНеавтоматизированнуюТорговуюТочку.ОтПоставщика) Тогда
		Предупреждение("Документ можно вводить только на основании документа """ + СокрЛП(ПараметрОснование.Метаданные().Представление())
		               + """ с видом операции """ + СокрЛП(Перечисления.ВидыОперацийПоступлениеТоваровУслугВНеавтоматизированнуюТорговуюТочку.ОтПоставщика)
		               + """.");
		Отказ = Истина;
		Возврат;
	КонецЕсли;

КонецПроцедуры // ПередОткрытием()

// Процедура - обработчик события "ПриОткрытии" формы
//
Процедура ПриОткрытии()

	Если ЭтоНовый() Тогда // проверить объект на то, что он еще не внесен в ИБ

		// Заполнить реквизиты значениями по умолчанию.
		ЗаполнитьШапкуДокумента(ЭтотОбъект, глТекущийПользователь, мВалютаРегламентированногоУчета, "Покупка");
		УстановитьНомерДокумента(ЭтотОбъект);

		Если Разделы.Количество() = 0 Тогда
			ДобавитьРазделГТД(); // В ГТД должен быть хотя бы один раздел.
		КонецЕсли;

	КонецЕсли;
	
	СтруктураКолонок = Новый Структура();

	// Установить колонки, видимостью которых пользователь управлять не может.
	СтруктураКолонок.Вставить("Номенклатура");
	СтруктураКолонок.Вставить("ЕдиницаИзмерения");
	СтруктураКолонок.Вставить("Количество");
	СтруктураКолонок.Вставить("ФактурнаяСтоимость");
	СтруктураКолонок.Вставить("СуммаНДС");
	СтруктураКолонок.Вставить("СуммаПошлины");

	УстановитьИзменятьВидимостьКолонокТабЧасти(ЭлементыФормы.Товары.Колонки, СтруктураКолонок);

	СтруктураКолонок = Новый Структура();

	// Установить колонки, видимостью которых пользователь управлять не может.
	СтруктураКолонок.Вставить("ТаможеннаяСтоимость");
	СтруктураКолонок.Вставить("СтавкаПошлины");
	СтруктураКолонок.Вставить("СтавкаНДС");
	СтруктураКолонок.Вставить("СуммаПошлины");
	СтруктураКолонок.Вставить("СуммаНДС");

	УстановитьИзменятьВидимостьКолонокТабЧасти(ЭлементыФормы.Разделы.Колонки, СтруктураКолонок);

	// Вывести в заголовке формы вид операции.
	УстановитьЗаголовокФормыДокумента("", ЭтотОбъект, ЭтаФорма);

	// Запомнить текущие значения реквизитов формы.
	мТекущаяДатаДокумента        = Дата;
	мТекущаяВалютаВзаиморасчетов = ДоговорКонтрагента.ВалютаВзаиморасчетов;

	// Установить видимость колонок "ХарактеристикаНоменклатуры" и "СерияНоменклатуры"
	УстановитьВидимостьХарактеристикиНоменклатуры(мКолонкиТовары);
	УстановитьВидимостьСерииНоменклатуры(мКолонкиТовары);

	// Установить видимость реквизитов и заголовков колонок.
	УстановитьВидимость();
	УстановитьДоступность();

	ЭлементыФормы.Разделы.ТекущаяСтрока =Разделы[0];

	// Установим страницу по разделам ГТД.
	УстановитьСтраницуПоРазделамГТД();

	ПоменятьНадписи();

	// Установить активный реквизит.
	АктивизироватьРеквизитВФорме(ЭтотОбъект, ЭтаФорма);

	Если НЕ ЭтоНовый() Тогда
		
		УстановитьЭлементыИсторииКнопка(Ссылка, ЭтаФорма);
		
	КонецЕсли; 

	
КонецПроцедуры

Процедура ВыводИстории(Элемент)
	
	ВывестиИсторию(Ссылка, ЭтаФорма);
	
КонецПроцедуры
	
	

// Процедура - обработчик события "ОбработкаВыбора" формы.
//
Процедура ОбработкаВыбора(ЗначениеВыбора, Источник)

	Перем Команда;

	Если ТипЗнч(ЗначениеВыбора) = Тип("Структура") Тогда
		ЗначениеВыбора.Свойство("Команда", Команда);

		Если Команда = "ПодборВТабличнуюЧастьТовары" Тогда
			ОбработкаПодбора(Товары, ЗначениеВыбора);
		КонецЕсли;
	КонецЕсли;

КонецПроцедуры // ОбработкаВыбора()

// Обработчик внешнего события.
//
Процедура ВнешнееСобытие(Источник, Событие, Данные)

	Если Не ВводДоступен() Тогда
		Возврат;
	КонецЕсли;

	Если глТорговоеОборудование <> Неопределено Тогда
		Если Событие = "BarCodeValue" Тогда

			Команда         = "ПодборВТабличнуюЧастьТовары";
			Валюта          = ВалютаДокумента;
			ИмяТабличнойЧасти = "Товары";

			ВременнаяДатаРасчетов = ?(НачалоДня(Дата) = НачалоДня(ТекущаяДата()), Неопределено, Дата);

			СтруктураПараметров = Новый Структура();
			СтруктураПараметров.Вставить("Команда"              , Команда);
			СтруктураПараметров.Вставить("ДатаРасчетов"         , ВременнаяДатаРасчетов);
			СтруктураПараметров.Вставить("ИмяТабличнойЧасти"    , ИмяТабличнойЧасти);

			глТорговоеОборудование.ОбработатьВнешнееСобытиеОтСканераДляФормы(ЭтаФорма, ЭтотОбъект, СтруктураПараметров, Данные);

		КонецЕсли;
	КонецЕсли;

КонецПроцедуры // ВнешнееСобытие()

// Процедура - обработчик события "ПослеЗаписи" формы.
//
Процедура ПослеЗаписи()

	// Вывести в заголовке формы вид операции и статус документа (новый, не проведен, проведен).
	УстановитьЗаголовокФормыДокумента("", ЭтотОбъект, ЭтаФорма);

КонецПроцедуры // ПослеЗаписи()

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ДЕЙСТВИЯ КОМАНДНЫХ ПАНЕЛЕЙ ФОРМЫ

// Процедура вызывается при нажатии кнопки "ЦеныВалюта" командной панели
// формы, вызывает сервисный механизм для изменения
// общих для всей табличной части "Товары" реквизитов.
//
Процедура КоманднаяПанельТоварыДействиеЦеныВалюта(Кнопка)

	СпособЗаполненияЦен = Перечисления.СпособыЗаполненияЦен.ПустаяСсылка();
	// Задать набор реквизитов для редактирования.
	СтруктураРеквизитовДокумента = ПолучитьСтруктуруРеквизитовДокументаДляЦенообразования(ЭтотОбъект);

	ТекущаяВалютаДокумента = ВалютаДокумента;

	// Вызов общей формы "Цены и валюта" и пересчеты по результатам выбора в этой форме.
	СтруктураЗначений = ОткрытьФормуЦеныИВалюта(ДокументОбъект, СтруктураРеквизитовДокумента, мВалютаРегламентированногоУчета,
	                                            , "Товары");
	Если СтруктураЗначений <> Неопределено Тогда
		ИзменитьЦеныВалюту(ЭтотОбъект, СпособЗаполненияЦен, СтруктураРеквизитовДокумента, , "Товары", мВалютаРегламентированногоУчета, , СтруктураЗначений);

		ИзменитьВалютуТаможеннойСтоимости = (ЗначениеНеЗаполнено(ВалютаДокумента) ИЛИ (ВалютаДокумента = мВалютаРегламентированногоУчета));

		// рассчитаем недостающие реквизиты
		Для Каждого СтрокаТабличнойЧасти Из Разделы Цикл

			// Валюта таможенной стоимости
			Если ИзменитьВалютуТаможеннойСтоимости Тогда
				СтрокаТабличнойЧасти.ТаможеннаяСтоимостьВВалютеРеглУчета = Истина;
			КонецЕсли;

			// Посчитаем суммы
			ВычислимСуммы(СтрокаТабличнойЧасти);

		КонецЦикла;

	КонецЕсли;

	УстановитьВидимость();
	УстановитьДоступность();
	ПоменятьНадписи();

КонецПроцедуры // КоманднаяПанельТоварыКнопкаЦеныВалюта()

// Процедура вызывается при нажатии кнопки "Подбор" командной панели
// табличного поля "Товары", вызывает сервисный механизм для
// подбора номеклатуры в табличную часть "Товары".
//
Процедура КоманднаяПанельТоварыДействиеПодбор(Кнопка)

	ДействиеПодбор(Товары);

КонецПроцедуры // КоманднаяПанельТоварыДействиеПодбор()

// Процедура вызывается при выборе пункта подменю "Движения документа по регистрам" меню "Перейти".
// командной панели формы. Процедура отрабатывает печать движений документа по регистрам.
//
Процедура ДействияФормыДвиженияДокументаПоРегистрам(Кнопка)

	НапечататьДвиженияДокумента(Ссылка);

КонецПроцедуры // ДействияФормыДвиженияДокументаПоРегистрам()

// Процедура вызывается при нажатии кнопки "ЦеныВалюта" командной панели
// формы, вызывает процедуру добавления раздела ГТД.
//
Процедура ДействияФормыДобавитьРаздел(Кнопка)

	ДобавитьРазделГТД();

КонецПроцедуры // ДействияФормыДобавитьРаздел()

// Процедура вызывается при нажатии кнопки "УдалитьРаздел" командной панели
// формы, вызывает процедуру добавления раздела ГТД.
//
Процедура ДействияФормыУдалитьРаздел(Кнопка)

	Если Разделы.Количество() = 1 Тогда 
		Предупреждение("В ГТД должен быть хотя бы один раздел!");
		Возврат;
	КонецЕсли;
	
	НомерРаздела = Разделы.Индекс(ЭлементыФормы.Разделы.ТекущиеДанные) + 1;
	Разделы.Удалить(Разделы[НомерРаздела - 1]);
	
	//Надо грохнуть все записи этого раздела
	МассивСтрок = Товары.НайтиСтроки(Новый Структура("НомерРаздела", НомерРаздела));
	Для каждого ЭлементМассива Из МассивСтрок Цикл
		Товары.Удалить(ЭлементМассива);
	КонецЦикла;
	
	// Надо переименовать все последующие разделы.
	Для Сч = НомерРаздела + 1 По Разделы.Количество()+ 1 Цикл
	
		МассивСтрок = Товары.НайтиСтроки(Новый Структура("НомерРаздела", Сч));
		КоличествоСтрок = МассивСтрок.Количество();
		Для каждого ЭлементМассива Из МассивСтрок Цикл
			ЭлементМассива.НомерРаздела = Сч - 1;
		КонецЦикла;
		
	КонецЦикла;
	
	НомерРаздела = ?(НомерРаздела > 2,НомерРаздела - 1 , 1);
	ЭлементыФормы.Разделы.ТекущаяСтрока = Разделы[НомерРаздела - 1];

	УстановитьСтраницуПоРазделамГТД();

КонецПроцедуры // ДействияФормыУдалитьРаздел()

// Процедура вызывается при нажатии кнопки "Распределить" командной панели
// ТЧ Товары, вызывает распределение сумм пошлины и НДС по строкам раздела.
//
Процедура КоманднаяПанельТоварыРаспределить(Кнопка)

	// Проверим, есть ли что распределять.
	СуммаПошлины = ЭлементыФормы.Разделы.ТекущиеДанные.СуммаПошлины;
	СуммаНДС     = ЭлементыФормы.Разделы.ТекущиеДанные.СуммаНДС;

	Если СуммаНДС = 0 Тогда
		Предупреждение("Для данного раздела сумма НДС равна нулю, распределение невозможно!");
		Возврат;
	КонецЕсли; 

	Если СуммаПошлины = 0 Тогда
		Предупреждение("Для данного раздела сумма пошлины равна нулю, распределение невозможно!");
		Возврат;
	КонецЕсли; 

	// Посчитаема общую помеченных позиций
	НомерРаздела = Разделы.Индекс(ЭлементыФормы.Разделы.ТекущиеДанные) + 1;
	МассивСтрок  = Товары.НайтиСтроки(Новый Структура("НомерРаздела", НомерРаздела));

	ВсегоСтоимость = 0;
	Для каждого ЭлементМассива Из МассивСтрок Цикл
		ВсегоСтоимость = ВсегоСтоимость + ЭлементМассива.ФактурнаяСтоимость;
	КонецЦикла;

	Если ВсегоСтоимость = 0 Тогда
		Предупреждение("Общая сумма фактурной стоимости раздела нулевая!
		               |Распределение невозможно.");
		Возврат;
	КонецЕсли;

	// Теперь рспределяем
	СтрокаМаксимальнойСуммы  = Неопределено; // На эту строку будем относить остаток после распределения (ошибки округления)
	МаксимальнаяСумма        = 0; // Значение максимальной суммы.
	НепогашеннаяСуммаПошлины = СуммаПошлины;
	НепогашеннаяСуммаНДС     = СуммаНДС;
	Для каждого ЭлементМассива Из МассивСтрок Цикл

		ДельтаПошлины = СуммаПошлины * ЭлементМассива.ФактурнаяСтоимость / ВсегоСтоимость;

		// Если Дельта по модулю оказалась больше, чем осталось погасить
		Если ДельтаПошлины < 0 Тогда
			ДельтаПошлины = Макс(НепогашеннаяСуммаПошлины, ДельтаПошлины)
		Иначе
			ДельтаПошлины = Мин(НепогашеннаяСуммаПошлины, ДельтаПошлины)
		КонецЕсли; 

		ДельтаНДС = СуммаНДС * ЭлементМассива.ФактурнаяСтоимость / ВсегоСтоимость;

		// Если Дельта по модулю оказалась больше, чем осталось погасить
		Если ДельтаНДС < 0 Тогда
			ДельтаНДС = Макс(НепогашеннаяСуммаНДС, ДельтаНДС)
		Иначе
			ДельтаНДС = Мин(НепогашеннаяСуммаНДС, ДельтаНДС)
		КонецЕсли; 

		// Проверим текущую сумму на максимум.
		Если ЭлементМассива.ФактурнаяСтоимость > МаксимальнаяСумма  Тогда
			МаксимальнаяСумма       = ЭлементМассива.ФактурнаяСтоимость;
			СтрокаМаксимальнойСуммы = ЭлементМассива;
		КонецЕсли;

		// Учеличиваем значения.
		ЭлементМассива.СуммаПошлины = ДельтаПошлины;

		// Остаток нераспределенной суммы надо уменьшать на реальное изменение
		НепогашеннаяСуммаПошлины = НепогашеннаяСуммаПошлины - ЭлементМассива.СуммаПошлины;

		ЭлементМассива.СуммаНДС = ДельтаНДС;

		// Остаток нераспределенной суммы надо уменьшать на реальное изменение
		НепогашеннаяСуммаНДС = НепогашеннаяСуммаНДС - ЭлементМассива.СуммаНДС;

	КонецЦикла;

	// Если что-то осталось, кидаем на строку с максимальной суммой.
	Если НепогашеннаяСуммаПошлины > 0
	   И СтрокаМаксимальнойСуммы <> Неопределено Тогда

		СтрокаМаксимальнойСуммы.СуммаПошлины = СтрокаМаксимальнойСуммы.СуммаПошлины + НепогашеннаяСуммаПошлины;
	КонецЕсли;
	
	// Если что-то осталось, кидаем на строку с максимальной суммой.
	Если НепогашеннаяСуммаНДС > 0
	   И СтрокаМаксимальнойСуммы <> Неопределено Тогда

		СтрокаМаксимальнойСуммы.СуммаНДС = СтрокаМаксимальнойСуммы.СуммаНДС + НепогашеннаяСуммаНДС;
	КонецЕсли;

	// Посчитаем суммы
	ВсегоСтоимость = 0;
	ВсегоПошлина   = 0;
	ВсегоНДС       = 0;

	ПосчитатьИтогиПоРазделу(НомерРаздела, ВсегоСтоимость, ВсегоПошлина, ВсегоНДС);

	ЭлементыФормы.Всего.Значение        = ФорматСумм(ВсегоСтоимость);
	ЭлементыФормы.ВсегоПошлина.Значение = ФорматСумм(ВсегоПошлина);
	ЭлементыФормы.ВсегоНДС.Значение     = ФорматСумм(ВсегоНДС);

	ПоменятьНадписи();

КонецПроцедуры //  КоманднаяПанельТоварыРаспределить()

// Процедура вызывается при нажатии кнопки "ДобавитьИзПоступления" командной панели
// табличного поля "Товары".
//
Процедура КоманднаяПанельТоварыДобавитьИзПоступления(Кнопка)

	НомерРаздела = Разделы.Индекс(ЭлементыФормы.Разделы.ТекущиеДанные) + 1;

	ДокументПоступления = Документы.ПоступлениеТоваровУслуг.ПустаяСсылка();
	Если ВвестиЗначение(ДокументПоступления, "Выберите документ поступления") Тогда

		ЗаполнитьПоПоступлению(ДокументПоступления, НомерРаздела);

	КонецЕсли;

	// Посчитаем суммы
	ВычислимСуммы(ЭлементыФормы.Разделы.ТекущиеДанные);

КонецПроцедуры // КоманднаяПанельТоварыДобавитьИзПоступления()

// Процедура вызывается при нажатии кнопки "ДобавитьИзПоступленияНТТ" командной панели
// табличного поля "Товары".
//
Процедура КоманднаяПанельТоварыДобавитьИзПоступленияНТТ(Кнопка)

	НомерРаздела = Разделы.Индекс(ЭлементыФормы.Разделы.ТекущиеДанные) + 1;

	ДокументПоступления = Документы.ПоступлениеТоваровУслугВНеавтоматизированнуюТорговуюТочку.ПустаяСсылка();
	Если ВвестиЗначение(ДокументПоступления, "Выберите документ поступления в НТТ") Тогда

		ЗаполнитьПоПоступлению(ДокументПоступления, НомерРаздела);

	КонецЕсли;

	// Посчитаем суммы
	ВычислимСуммы(ЭлементыФормы.Разделы.ТекущиеДанные);

КонецПроцедуры // КоманднаяПанельТоварыДобавитьИзПоступленияНТТ()

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ ОБРАБОТКИ СВОЙСТВ И КАТЕГОРИЙ

// Процедура выполняет открытие формы работы со свойствами документа
//
Процедура ДействияФормыДействиеОткрытьСвойства(Кнопка)

	ОткрытьСвойстваДокумента(ЭтотОбъект, ЭтаФорма);

КонецПроцедуры

// Процедура выполняет открытие формы работы с категориями документа
//
Процедура ДействияФормыДействиеОткрытьКатегории(Кнопка)

	ОткрытьКатегорииДокумента(ЭтотОбъект, ЭтаФорма);

КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ РЕКВИЗИТОВ ШАПКИ

// Процедура - обработчик события "ПриИзменении" поля ввода даты документа.
//
Процедура ДатаПриИзменении(Элемент)

	ПроверитьНомерДокумента(ЭтотОбъект, мТекущаяДатаДокумента);
	ПриИзмененииЗначенияДатыДокумента(ЭтотОбъект, мВалютаРегламентированногоУчета);

	мТекущаяДатаДокумента = Дата; // запомним текущую дату документа для контроля номера документа

КонецПроцедуры // ДатаПриИзменении()

// Процедура - обработчик события "ПриИзменении" флага отражения
// документа в бухгалтерском учете.
//
Процедура ОтражатьВБухгалтерскомУчетаПриИзменении(Элемент)

	ОтражатьВНалоговомУчете = ОтражатьВБухгалтерскомУчете;

	УстановитьВидимость();

КонецПроцедуры // ОтражатьВБухгалтерскомУчетеПриИзменении()

// Процедура - обработчик события "ПриИзменении" флага отражения
// документа в налоговом учете.
//
// Процедура - обработчик события "ПриИзменении" поля ввода организации.
//
Процедура ОрганизацияПриИзменении(Элемент)

	УстановитьНомерДокумента(ЭтотОбъект);

КонецПроцедуры // ОрганизацияПриИзменении()

// Процедура - обработчик события "ПриИзменении" поля ввода контрагента.
//
Процедура КонтрагентПриИзменении(Элемент)

	// Выполняем общие действия для всех документов при изменении Контрагент.
	ПриИзмененииЗначенияКонтрагента(ЭтотОбъект);

	// Очистим договор при смене владельца.
	Если ДоговорКонтрагентаРегл.Владелец <> Контрагент Тогда
		ДоговорКонтрагентаРегл = Неопределено;
	КонецЕсли;

	// Очистим договор если он не валютный.
	Если НЕ ЗначениеНеЗаполнено(ДоговорКонтрагента)
	   И ДоговорКонтрагента.ВалютаВзаиморасчетов = мВалютаРегламентированногоУчета Тогда
		ДоговорКонтрагента = Неопределено;
	КонецЕсли;

	// Могли поменять договор.
	ПриИзмененииДоговора();

КонецПроцедуры // КонтрагентПриИзменении()

// Процедура - обработчик события "НачалоВыбора" поля ввода ДоговорКонтрагента
//
Процедура ДоговорКонтрагентаНачалоВыбора(Элемент, СтандартнаяОбработка)

	// сохраним договор контрагента, возможно понадобится к нему вернуться
	мТекущийДоговорКонтрагента = ДоговорКонтрагента;

	// Нам нужны договоры с валютой взаиморасчетов, отличной от валюты регл. учета.
	СтруктураДополнительныхПараметров = Новый Структура();

	СтруктураОтбора = Новый Структура();
	СтруктураОтбора.Вставить("ЗначениеОтбора",     мВалютаРегламентированногоУчета);
	СтруктураОтбора.Вставить("ВидСравненияОтбора", ВидСравнения.НеРавно);
	СтруктураДополнительныхПараметров.Вставить("ВалютаВзаиморасчетов", СтруктураОтбора);

	СтруктураОтбора = Новый Структура();
	СтруктураОтбора.Вставить("ЗначениеОтбора",     Перечисления.ВедениеВзаиморасчетовПоДоговорам.ПоДоговоруВЦелом);
	СтруктураОтбора.Вставить("ВидСравненияОтбора", ВидСравнения.Равно);
	СтруктураДополнительныхПараметров.Вставить("ВедениеВзаиморасчетов", СтруктураОтбора);

	НачалоВыбораЗначенияДоговораКонтрагента(ЭтотОбъект, ЭтаФорма, Элемент, Контрагент, ДоговорКонтрагента,
	                                        Перечисления.ВидыДоговоровКонтрагентов.Прочее, СтандартнаяОбработка, СтруктураДополнительныхПараметров)

КонецПроцедуры // ДоговорКонтрагентаНачалоВыбора()

// Процедура - обработчик события "ПриИзменении" поля ввода
// "ДоговорКонтрагента". Процедура выполняет действия при изменении договора
// взаиморасчетов с контрагентом.
//
Процедура ДоговорКонтрагентаПриИзменении(Элемент)

	ПриИзмененииДоговора();

КонецПроцедуры // ДоговорКонтрагентаПриИзменении()

// Процедура - обработчик события "НачалоВыбора" поля ввода ДоговорКонтрагентаРегл
//
Процедура ДоговорКонтрагентаРеглНачалоВыбора(Элемент, СтандартнаяОбработка)

	// сохраним договор контрагента, возможно понадобится к нему вернуться
	мТекущийДоговорКонтрагента = ДоговорКонтрагента;

	// Нам нужны договоры с валютой взаиморасчетов, равной валюте регл. учета.
	СтруктураДополнительныхПараметров = Новый Структура();

	СтруктураОтбора = Новый Структура();
	СтруктураОтбора.Вставить("ЗначениеОтбора", мВалютаРегламентированногоУчета);
	СтруктураОтбора.Вставить("ВидСравненияОтбора", ВидСравнения.Равно);
	СтруктураДополнительныхПараметров.Вставить("ВалютаВзаиморасчетов", СтруктураОтбора);

	СтруктураОтбора = Новый Структура();
	СтруктураОтбора.Вставить("ЗначениеОтбора", Перечисления.ВедениеВзаиморасчетовПоДоговорам.ПоДоговоруВЦелом);
	СтруктураОтбора.Вставить("ВидСравненияОтбора", ВидСравнения.Равно);
	СтруктураДополнительныхПараметров.Вставить("ВедениеВзаиморасчетов", СтруктураОтбора);

	НачалоВыбораЗначенияДоговораКонтрагента(ЭтотОбъект, ЭтаФорма, Элемент, Контрагент, ДоговорКонтрагентаРегл,
	                                        Перечисления.ВидыДоговоровКонтрагентов.Прочее, СтандартнаяОбработка, СтруктураДополнительныхПараметров)

КонецПроцедуры // ДоговорКонтрагентаРеглНачалоВыбора()

// Процедура - обработчик события "НачалоВыбора" поля ввода "КурсВзаиморасчетов".
//
Процедура КурсВзаиморасчетовНачалоВыбора(Элемент, СтандартнаяОбработка)

	// Отменить стандартную обработку.
	СтандартнаяОбработка = Ложь;

	// Выберать дату курса и заполнить курс взаиморасчетов.
	ВыбратьКурсВзаиморасчетов(ЭтотОбъект);

КонецПроцедуры // КурсВзаиморасчетовНачалоВыбора()

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ РЕКВИЗИТОВ ТЧ РАЗДЕЛЫ

// Процедура - обработчик события "ПриИзменении" поля ТаможеннаяСтоимостьВВалютеРеглУчета
//
Процедура ТаможеннаяСтоимостьВВалютеРеглУчетаПриИзменении(Элемент)

	СтоимостьВРублях    = ЭлементыФормы.Разделы.ТекущиеДанные.ТаможеннаяСтоимостьВВалютеРеглУчета;
	ТаможеннаяСтоимость = ЭлементыФормы.Разделы.ТекущиеДанные.ТаможеннаяСтоимость;
	СтавкаПошлины       = ЭлементыФормы.Разделы.ТекущиеДанные.СтавкаПошлины;
	СуммаПошлины        = ЭлементыФормы.Разделы.ТекущиеДанные.СуммаПошлины;
	ПошлинаВВалюте      = ЭлементыФормы.Разделы.ТекущиеДанные.ПошлинаВВалюте;
	СтавкаНДС           = ЭлементыФормы.Разделы.ТекущиеДанные.СтавкаНДС;
	НДСВВалюте          = ЭлементыФормы.Разделы.ТекущиеДанные.НДСВВалюте;

	Если Не ЗначениеНеЗаполнено(ТаможеннаяСтоимость) Тогда
	
		Ответ = Вопрос("Пересчитать таможенную стоимость, сумму пошлины и сумму НДС?", РежимДиалогаВопрос.ДаНет);
		Если Ответ = КодВозвратаДиалога.Да Тогда
		
			Если СтоимостьВРублях Тогда // была не в рублях, надо пересчитывать в рубли

				ТаможеннаяСтоимость = ПересчитатьИзВалютыВВалюту(ТаможеннаяСтоимость,
				                         ВалютаДокумента, мВалютаРегламентированногоУчета, 
				                         КурсДокумента, 1, КратностьДокумента, 1);

			Иначе // Была в раблях, надо пересчитывать в валюту документа.

				ТаможеннаяСтоимость = ПересчитатьИзВалютыВВалюту(ТаможеннаяСтоимость,
				                         мВалютаРегламентированногоУчета, ВалютаДокумента,
				                         1, КурсДокумента, 1, КратностьДокумента);

			КонецЕсли; 

			ЭлементыФормы.Разделы.ТекущиеДанные.ТаможеннаяСтоимость = ТаможеннаяСтоимость;
			ЭлементыФормы.Разделы.ТекущиеДанные.СуммаПошлины = 
			       РассчитатьСуммуПошлиныГТД(ТаможеннаяСтоимость, СтоимостьВРублях, СтавкаПошлины, ПошлинаВВалюте);
			ЭлементыФормы.Разделы.ТекущиеДанные.СуммаНДС     = 
			       РассчитатьСуммуНДСГТД(ТаможеннаяСтоимость, СтоимостьВРублях, СуммаПошлины, ПошлинаВВалюте, СтавкаНДС, НДСВВалюте);

		КонецЕсли; 

	КонецЕсли;

	// Поменяем надписи
	ПоменятьНадписи();

КонецПроцедуры // ТаможеннаяСтоимостьВВалютеРеглУчетаПриИзменении()

// Процедура - обработчик события "ПриИзменении" поля ТаможеннаяСтоимостьВВалютеРеглУчета
//
Процедура РазделыТаможеннаяСтоимостьВВалютеРеглУчетаПриИзменении(Элемент)

	ТаможеннаяСтоимостьВВалютеРеглУчетаПриИзменении(Элемент);

КонецПроцедуры

// Процедура - обработчик события "ПриИзменении" поля ПошлинаВВалюте
//
Процедура РазделыПошлинаВВалютеПриИзменении(Элемент)

	ТаможеннаяСтоимость = ЭлементыФормы.Разделы.ТекущиеДанные.ТаможеннаяСтоимость;
	СтоимостьВРублях    = ЭлементыФормы.Разделы.ТекущиеДанные.ТаможеннаяСтоимостьВВалютеРеглУчета;
	СтавкаПошлины       = ЭлементыФормы.Разделы.ТекущиеДанные.СтавкаПошлины;
	СуммаПошлины        = ЭлементыФормы.Разделы.ТекущиеДанные.СуммаПошлины;
	ПошлинаВВалюте      = ЭлементыФормы.Разделы.ТекущиеДанные.ПошлинаВВалюте;
	СтавкаНДС           = ЭлементыФормы.Разделы.ТекущиеДанные.СтавкаНДС;
	НДСВВалюте          = ЭлементыФормы.Разделы.ТекущиеДанные.НДСВВалюте;

	Если Не ЗначениеНеЗаполнено(СуммаПошлины) Тогда
	
		Ответ = Вопрос("Пересчитать сумму пошлины и сумму НДС?", РежимДиалогаВопрос.ДаНет);
		Если Ответ = КодВозвратаДиалога.Да Тогда
		
			Если ПошлинаВВалюте Тогда // была не в валюте, надо пересчитывать в валюту

				СуммаПошлины = ПересчитатьИзВалютыВВалюту(СуммаПошлины,
				                         мВалютаРегламентированногоУчета, мТекущаяВалютаВзаиморасчетов,
				                         1, КурсВзаиморасчетов, 1, КратностьВзаиморасчетов);

			Иначе // Была в валюте, надо пересчитывать в регл. учет.

				СуммаПошлины = ПересчитатьИзВалютыВВалюту(СуммаПошлины,
				                         мТекущаяВалютаВзаиморасчетов, мВалютаРегламентированногоУчета, 
				                         КурсВзаиморасчетов, 1, КратностьВзаиморасчетов, 1);

			КонецЕсли; 

			ЭлементыФормы.Разделы.ТекущиеДанные.СуммаПошлины = СуммаПошлины;
			ЭлементыФормы.Разделы.ТекущиеДанные.СуммаНДС     = 
			      РассчитатьСуммуНДСГТД(ТаможеннаяСтоимость, СтоимостьВРублях, СуммаПошлины, ПошлинаВВалюте, СтавкаНДС, НДСВВалюте);

		КонецЕсли; 

	КонецЕсли;

	// Поменяем надписи
	ПоменятьНадписи();

КонецПроцедуры // РазделыПошлинаВВалютеПриИзменении()

// Процедура - обработчик события "ПриИзменении" поля НДСВВалюте
//
Процедура РазделыНДСВВалютеПриИзменении(Элемент)

	НДСВВалюте          = ЭлементыФормы.Разделы.ТекущиеДанные.НДСВВалюте;
	СуммаНДС            = ЭлементыФормы.Разделы.ТекущиеДанные.СуммаНДС;

	Если Не ЗначениеНеЗаполнено(СуммаНДС) Тогда

		Ответ = Вопрос("Пересчитать сумму НДС?", РежимДиалогаВопрос.ДаНет);
		Если Ответ = КодВозвратаДиалога.Да Тогда

			Если НДСВВалюте Тогда // была не в валюте, надо пересчитывать в валюту

				СуммаНДС = ПересчитатьИзВалютыВВалюту(СуммаНДС,
				                         мВалютаРегламентированногоУчета, мТекущаяВалютаВзаиморасчетов,
				                         1, КурсВзаиморасчетов, 1, КратностьВзаиморасчетов);

			Иначе // Была в валюте, надо пересчитывать в регл. учет.

				СуммаНДС = ПересчитатьИзВалютыВВалюту(СуммаНДС,
				                         мТекущаяВалютаВзаиморасчетов, мВалютаРегламентированногоУчета, 
				                         КурсВзаиморасчетов, 1, КратностьВзаиморасчетов, 1);

			КонецЕсли; 

			ЭлементыФормы.Разделы.ТекущиеДанные.СуммаНДС = СуммаНДС;

		КонецЕсли; 

	КонецЕсли;

	// Поменяем надписи.
	ПоменятьНадписи();

КонецПроцедуры // РазделыНДСВВалютеПриИзменении()

// Процедура - обработчик события "ПриИзменении" поля ТаможеннаяСтоимость
//
Процедура РазделыТаможеннаяСтоимостьПриИзменении(Элемент)

	СтоимостьВРублях    = ЭлементыФормы.Разделы.ТекущиеДанные.ТаможеннаяСтоимостьВВалютеРеглУчета;
	ТаможеннаяСтоимость = ЭлементыФормы.Разделы.ТекущиеДанные.ТаможеннаяСтоимость;
	СтавкаПошлины       = ЭлементыФормы.Разделы.ТекущиеДанные.СтавкаПошлины;
	ПошлинаВВалюте      = ЭлементыФормы.Разделы.ТекущиеДанные.ПошлинаВВалюте;
	СтавкаНДС           = ЭлементыФормы.Разделы.ТекущиеДанные.СтавкаНДС;
	НДСВВалюте          = ЭлементыФормы.Разделы.ТекущиеДанные.НДСВВалюте;
	
	СуммаПошлины = 
	       РассчитатьСуммуПошлиныГТД(ТаможеннаяСтоимость, СтоимостьВРублях, СтавкаПошлины, ПошлинаВВалюте);

	ЭлементыФормы.Разделы.ТекущиеДанные.СуммаПошлины = СуммаПошлины ;
	
	ЭлементыФормы.Разделы.ТекущиеДанные.СуммаНДС = 
	       РассчитатьСуммуНДСГТД(ТаможеннаяСтоимость, СтоимостьВРублях, СуммаПошлины, ПошлинаВВалюте, СтавкаНДС, НДСВВалюте);

КонецПроцедуры // РазделыТаможеннаяСтоимостьПриИзменении()

// Процедура - обработчик события "ПриИзменении" поля СтавкаПошлины
//
Процедура РазделыСтавкаПошлиныПриИзменении(Элемент)

	СохранитьЗначение("СтавкаТаможеннойПошлины", ЭлементыФормы.Разделы.ТекущиеДанные.СтавкаПошлины);
	
	СтоимостьВРублях    = ЭлементыФормы.Разделы.ТекущиеДанные.ТаможеннаяСтоимостьВВалютеРеглУчета;
	ТаможеннаяСтоимость = ЭлементыФормы.Разделы.ТекущиеДанные.ТаможеннаяСтоимость;
	СтавкаПошлины       = ЭлементыФормы.Разделы.ТекущиеДанные.СтавкаПошлины;
	ПошлинаВВалюте      = ЭлементыФормы.Разделы.ТекущиеДанные.ПошлинаВВалюте;
	СтавкаНДС           = ЭлементыФормы.Разделы.ТекущиеДанные.СтавкаНДС;
	НДСВВалюте          = ЭлементыФормы.Разделы.ТекущиеДанные.НДСВВалюте;
	
	СуммаПошлины = 
	       РассчитатьСуммуПошлиныГТД(ТаможеннаяСтоимость, СтоимостьВРублях, СтавкаПошлины, ПошлинаВВалюте);

	ЭлементыФормы.Разделы.ТекущиеДанные.СуммаПошлины = СуммаПошлины ;
	
	ЭлементыФормы.Разделы.ТекущиеДанные.СуммаНДС = 
	       РассчитатьСуммуНДСГТД(ТаможеннаяСтоимость, СтоимостьВРублях, СуммаПошлины, ПошлинаВВалюте, СтавкаНДС, НДСВВалюте);

КонецПроцедуры // РазделыСтавкаПошлиныПриИзменении()

// Процедура - обработчик события "ПриИзменении" поля СуммаПошлины
//
Процедура РазделыСуммаПошлиныПриИзменении(Элемент)

	СтоимостьВРублях    = ЭлементыФормы.Разделы.ТекущиеДанные.ТаможеннаяСтоимостьВВалютеРеглУчета;
	ТаможеннаяСтоимость = ЭлементыФормы.Разделы.ТекущиеДанные.ТаможеннаяСтоимость;
	СуммаПошлины        = ЭлементыФормы.Разделы.ТекущиеДанные.СуммаПошлины;
	ПошлинаВВалюте      = ЭлементыФормы.Разделы.ТекущиеДанные.ПошлинаВВалюте;
	СтавкаНДС           = ЭлементыФормы.Разделы.ТекущиеДанные.СтавкаНДС;
	НДСВВалюте          = ЭлементыФормы.Разделы.ТекущиеДанные.НДСВВалюте;
	
	ЭлементыФормы.Разделы.ТекущиеДанные.СуммаНДС = 
	     РассчитатьСуммуНДСГТД(ТаможеннаяСтоимость, СтоимостьВРублях, СуммаПошлины, ПошлинаВВалюте, СтавкаНДС, НДСВВалюте);

КонецПроцедуры // РазделыСуммаПошлиныПриИзменении()

// Процедура - обработчик события "ПриИзменении" поля СтавкаНДС
//
Процедура РазделыСтавкаНДСПриИзменении(Элемент)

	СтоимостьВРублях    = ЭлементыФормы.Разделы.ТекущиеДанные.ТаможеннаяСтоимостьВВалютеРеглУчета;
	ТаможеннаяСтоимость = ЭлементыФормы.Разделы.ТекущиеДанные.ТаможеннаяСтоимость;
	СтавкаПошлины       = ЭлементыФормы.Разделы.ТекущиеДанные.СтавкаПошлины;
	ПошлинаВВалюте      = ЭлементыФормы.Разделы.ТекущиеДанные.ПошлинаВВалюте;
	СуммаПошлины        = ЭлементыФормы.Разделы.ТекущиеДанные.СуммаПошлины;
	СтавкаНДС           = ЭлементыФормы.Разделы.ТекущиеДанные.СтавкаНДС;
	НДСВВалюте          = ЭлементыФормы.Разделы.ТекущиеДанные.НДСВВалюте;
	
	ЭлементыФормы.Разделы.ТекущиеДанные.СуммаНДС = 
	     РассчитатьСуммуНДСГТД(ТаможеннаяСтоимость, СтоимостьВРублях, СуммаПошлины, ПошлинаВВалюте, СтавкаНДС, НДСВВалюте);
	
КонецПроцедуры // РазделыСтавкаНДСПриИзменении()

// Процедура - обработчик события "ПриАктивизацииСтроки" табличной части "Разделы"
//
Процедура РазделыПриАктивизацииСтроки(Элемент)

	НомерРаздела = Разделы.Индекс(ЭлементыФормы.Разделы.ТекущиеДанные) + 1;
	ЭлементыФормы.Разделы.ТекущаяСтрока = Разделы[НомерРаздела - 1];
	
	ЭлементыФормы.Товары.ОтборСтрок.НомерРаздела.Использование = Истина;
	ЭлементыФормы.Товары.ОтборСтрок.НомерРаздела.Значение      = НомерРаздела;

	// Посчитаем суммы
	ВсегоСтоимость = 0;
	ВсегоПошлина   = 0;
	ВсегоНДС       = 0;
	ПосчитатьИтогиПоТОварам(ЭлементыФормы.Разделы.ТекущиеДанные, ВсегоСтоимость, ВсегоПошлина, ВсегоНДС);

	// Поменяем надписи.
	ПоменятьНадписи();

КонецПроцедуры //РазделыПриАктивизацииСтроки()

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ РЕКВИЗИТОВ ТЧ ТОВАРЫ

// Процедура - обработчик события "ПриНачалеРедактирования" табличной части "Товары".
//
Процедура ТоварыПриНачалеРедактирования(Элемент, НоваяСтрока)
	
	Если НоваяСтрока Тогда
		ЭлементыФормы.Товары.ТекущиеДанные.НомерРаздела = ЭлементыФормы.Товары.ОтборСтрок.НомерРаздела.Значение;
	КонецЕсли; 
	
КонецПроцедуры // ТоварыПриНачалеРедактирования()

// Процедура - обработчик события "ПриОкончанииРедактирования" табличной части "Товары".
//
Процедура ТоварыПриОкончанииРедактирования(Элемент, НоваяСтрока, ОтменаРедактирования)

	// Посчитаем суммы
	ВычислимСуммы(ЭлементыФормы.Разделы.ТекущиеДанные);

КонецПроцедуры // ТоварыПриОкончанииРедактирования()

// Процедура - обработчик события "ПослеУдаления" табличной части "Товары".
//
Процедура ТоварыПослеУдаления(Элемент)

	// Посчитаем суммы
	ВычислимСуммы(ЭлементыФормы.Разделы.ТекущиеДанные);

КонецПроцедуры // ТоварыПослеУдаления()

// Процедура - обработчик события "ПриВыводеСтроки" табличной части
// "Товары". Формирует данные в колонке "Всего" и "ЕдиницаХранения".
//
Процедура ТоварыПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки)

	ПоказатьКоэффициентМест(мКолонкиТовары, ОформлениеСтроки.Ячейки, ДанныеСтроки.ЕдиницаИзмеренияМест);
	ПоказатьКодАртикул(мКолонкиТовары, ОформлениеСтроки.Ячейки, ДанныеСтроки.Номенклатура);

	Если НЕ ЗначениеНеЗаполнено(ДанныеСтроки.СерияНоменклатуры) Тогда
		Если ЭлементыФормы.Товары.Колонки.Найти("СтранаПроисхождения") <> Неопределено
		   И ЭлементыФормы.Товары.Колонки.СтранаПроисхождения.Видимость Тогда
			ОформлениеСтроки.Ячейки.СтранаПроисхождения.ОтображатьТекст = Истина;
			ОформлениеСтроки.Ячейки.СтранаПроисхождения.Текст = ДанныеСтроки.СерияНоменклатуры.СтранаПроисхождения;
		КонецЕсли;
	КонецЕсли;

КонецПроцедуры // ТоварыПриВыводеСтроки()

// Процедура - обработчик события "ПриИзменении" поля ввода номенклатуры
// в строке табличной части "Товары".
//
Процедура ТоварыНоменклатураПриИзменении(Элемент)

	СтрокаТЧ = ЭлементыФормы.Товары.ТекущиеДанные;

	// Выполнить общие действия для всех документов при изменении номенклатуры.
	ПриИзмененииНоменклатурыТабЧасти(СтрокаТЧ, ЭтотОбъект);

	СтрокаТЧ.ЕдиницаИзмерения = СтрокаТЧ.Номенклатура.ЕдиницаХраненияОстатков;
	СтрокаТЧ.Коэффициент      = СтрокаТЧ.ЕдиницаИзмерения.Коэффициент;

КонецПроцедуры // ТоварыНоменклатураПриИзменении()

// Процедура - обработчик события "ПриИзменении" поля ввода серии номенклатуры
// в строке табличной части "Товары".
//
Процедура ТоварыСерияНоменклатурыПриИзменении(Элемент)

	СтрокаТабличнойЧасти = ЭлементыФормы.Товары.ТекущиеДанные;

КонецПроцедуры // ТоварыЕдиницаПриИзменении()

// Процедура - обработчик события "ПриИзменении" поля ввода единицы
// в строке табличной части "Товары".
//
Процедура ТоварыЕдиницаИзмеренияПриИзменении(Элемент)

	// Выполнить общие действия для всех документов при изменении Единица.
	ПриИзмененииЕдиницыТабЧасти(ЭлементыФормы.Товары.ТекущиеДанные, ЭтотОбъект);

КонецПроцедуры // ТоварыЕдиницаПриИзменении()

// Процедура - обработчик события "ПриИзменении" поля ввода единицы мест
// в строке табличной части "Товары".
//
Процедура ТоварыЕдиницаМестПриИзменении(Элемент)

	// Выполнить общие действия для всех документов при изменении ЕдиницаМест.
	ПриИзмененииЕдиницыМестТабЧасти(ЭлементыФормы.Товары.ТекущиеДанные, ЭтотОбъект);

КонецПроцедуры

// Процедура - обработчик события "ПриИзменении" поля ввода количества
// в строке табличной части "Товары".
//
Процедура ТоварыКоличествоПриИзменении(Элемент)

	// Рассчитать реквизиты табличной части.
	РассчитатьКоличествоМестТабЧасти(ЭлементыФормы.Товары.ТекущиеДанные, ДокументОбъект);

КонецПроцедуры // ТоварыКоличествоПриИзменении()

// Процедура - обработчик события "ПриИзменении" поля ввода количества мест
// в строке табличной части "Товары".
//
Процедура ТоварыКоличествоМестПриИзменении(Элемент)

	// Рассчитать новое количество
	РассчитатьКоличествоТабЧасти(ЭлементыФормы.Товары.ТекущиеДанные, ЭтотОбъект);
	
КонецПроцедуры

Процедура ТоварыДокументПартииНачалоВыбора(Элемент, СтандартнаяОбработка)
	НачалоВыбораЗначенияДокументаСоставногоТипа(ЭтотОбъект, ЭтаФорма, Элемент, СтандартнаяОбработка, Новый Структура(), "Товары");

КонецПроцедуры

// Процедура - обработчик события "НачалоВыбора" поля ввода серии номенклатуры
// в строке табличной части "Товары".
//
Процедура ТоварыСерияНоменклатурыНачалоВыбора(Элемент, СтандартнаяОбработка)

	СтандартнаяОбработка = Ложь;

	// В качестве владельца формы выбора устанавливаем данный элемент,
	// чтобы выбранное значение было присвоено стандартно.
	ФормаВыбора = Справочники.СерииНоменклатуры.ПолучитьФормуВыбора(,Элемент,);

	// Отфильруем список документов по договору.
	Если НЕ ЗначениеНеЗаполнено(НомерГТД) Тогда
		ФормаВыбора.Отбор.НомерГТД.Значение      = НомерГТД;
		ФормаВыбора.Отбор.НомерГТД.Использование = Истина;
	КонецЕсли;

	ФормаВыбора.ПараметрВыборПоВладельцу = ЭлементыФормы.Товары.ТекущиеДанные.Номенклатура;
	ФормаВыбора.ПараметрОтборПоВладельцу = ЭлементыФормы.Товары.ТекущиеДанные.Номенклатура;

	ФормаВыбора.Открыть();

КонецПроцедуры

// Процедура вызова структуры подчиненности документа
Процедура ДействияФормыСтруктураПодчиненностиДокумента(Кнопка)
	ПоказатьСтруктуруПодчиненностиДокумента(Ссылка);
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ ПЕРЕТАСКИВАНИЕ НОМЕНКЛАТУРЫ

// Процедура - обработчик события "ПроверкаПеретаскивания" табличной части "Товары".
//
Процедура ТоварыПроверкаПеретаскивания(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Строка, Колонка)

	Если ЭтоПеретаскиваниеИзПодбора(ПараметрыПеретаскивания) Тогда
		ПроверкаПеретаскиванияИзПодбора(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Ссылка, "Товары");
	Иначе
		ПеретаскиваниеОтменить(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка);
	КонецЕсли;

КонецПроцедуры // ТоварыПроверкаПеретаскивания()

// Процедура - обработчик события "Перетаскивание" табличной части "Товары".
//
Процедура ТоварыПеретаскивание(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Строка, Колонка)

	Если ЭтоПеретаскиваниеИзПодбора(ПараметрыПеретаскивания) Тогда
		ПеретаскиваниеИзПодбора(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка);
	Иначе
		ПеретаскиваниеОтменить(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка);
	КонецЕсли;

КонецПроцедуры // ТоварыПеретаскивание()


////////////////////////////////////////////////////////////////////////////////
// ОПЕРАТОРЫ ОСНОВНОЙ ПРОГРАММЫ

мКолонкиТовары = ЭлементыФормы.Товары.Колонки;

