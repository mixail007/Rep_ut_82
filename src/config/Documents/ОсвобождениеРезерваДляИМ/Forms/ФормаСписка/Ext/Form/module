
Процедура ПередОткрытием(Отказ, СтандартнаяОбработка)
	
	Если Не Отказ Тогда 
		Отказ = ПроверитьДоступностьДокумента();
	КонецЕсли;	

КонецПроцедуры


Функция ПроверитьДоступностьДокумента()
	
	//Разрешаем только пользователю у которого полные права 
	//и основному менеджеру контрагента "Резерв для ИМ"
	
//КонтрагентДляИМ = Справочники.Контрагенты.НайтиПоКоду("П004703");
Запрос = Новый Запрос;  //23.01.2017 - теперь не 1 а много контр. резервов
Запрос.Текст = "ВЫБРАТЬ различные
               |	Контрагенты.ОсновнойМенеджерКонтрагента
               |ИЗ
               |	Справочник.Контрагенты КАК Контрагенты
               |ГДЕ
               |	Контрагенты.КонтрагентДляРезерваИМ = Контрагенты.Ссылка
               |	И Контрагенты.ПометкаУдаления = ЛОЖЬ
               |	И Контрагенты.ЭтоГруппа = ЛОЖЬ";

Результат = Запрос.Выполнить();
табл = Результат.Выгрузить();
	
	РазрешитьРедактировать = РольДоступна("ПолныеПрава") 
							ИЛИ табл.Найти(глТекущийПользователь,"ОсновнойМенеджерКонтрагента")<>Неопределено 
						//	ИЛИ СокрЛП(глТекущийПользователь.Код) = "Смирнов А"
						;
  
	
	Возврат Не РазрешитьРедактировать;
	
КонецФункции
