
Процедура ПериодПланированияПриИзменении(Элемент)
	ПланЗатрат.Очистить();
	ДеревоЗатрат.Строки.очистить();
    УстановитьВидимость();
КонецПроцедуры
 
Процедура КоманднаяПанель1добавитьКомментарий(Кнопка)
Название = ЭлементыФормы.ДеревоЗатрат.ТекущаяКолонка.Имя;
Если Найти(Название,"Месяц")<>0 тогда
	номер = сред(Название,6);
	ЭлементыФормы.ДеревоЗатрат.Колонки["Ком"+Номер].видимость = Истина;
конецЕсли;	

КонецПроцедуры

Процедура ПриОткрытии()
	Если ИзменяюСвоиСтатьи тогда
		ЭлементыФормы.ДеревоЗатрат.Видимость = Ложь;
		ЭлементыФормы.СамНаСебя.Видимость = Ложь;
		ЭлементыФормы.СписокПодразделений.Видимость = Ложь;
		Элементыформы.КоманднаяПанель1.видимость = Ложь;
		ЭлементыФормы.Добавитькомментарий.Видимость = Истина;
		
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	Таблица.СтатьяЗатрат
		|ПОМЕСТИТЬ ВТ
		|ИЗ
		|	&Таблица КАК Таблица
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ.СтатьяЗатрат
		|ИЗ
		|	ВТ КАК ВТ
		|ГДЕ
		|	ВТ.СтатьяЗатрат.Ответственный = &Ответственный";
		
		Запрос.УстановитьПараметр("Ответственный", глТекущийПользователь);
		Запрос.УстановитьПараметр("Таблица", планЗатрат);
		
		
		Результат = Запрос.Выполнить().Выгрузить();
		
		Список = Новый СписокЗначений;
		Список.ЗагрузитьЗначения(Результат.ВыгрузитьКолонку("статьяЗатрат"));
		
		ЭлементыФормы.ПланЗатрат.ОтборСтрок.СтатьяЗатрат.ВидСравнения = ВидСравнения.ВСписке;
		ЭлементыФормы.ПланЗатрат.ОтборСтрок.СтатьяЗатрат.Значение = Список;
		ЭлементыФормы.ПланЗатрат.ОтборСтрок.СтатьяЗатрат.Использование = Истина;
		
		
		Если ЗначениеЗаполнено(ПериодПланирования) тогда
			//уберем видимость
			Для каждого колонка из Элементыформы.ПланЗатрат.Колонки цикл
				если Найти(колонка.Имя,"Месяц")<>0 тогда
					колонка.Видимость = Ложь;
				конецесли;	
			конеццикла;	
			
			//настроим видимость  	
			Если Число(Формат(ПериодПланирования.ДатаНачала,"ДФ=yyyy")) = Число(Формат(ПериодПланирования.ДатаКонца,"ДФ=yyyy")) Тогда	
				КоличествоМесяцев = Число(Формат(ПериодПланирования.ДатаКонца,"ДФ=MM")) - Число(Формат(ПериодПланирования.ДатаНачала,"ДФ=MM")) +1;
			иначе
				КоличествоМесяцев = 12 - Число(Формат(ПериодПланирования.ДатаНачала,"ДФ=MM")) +1 + Число(Формат(ПериодПланирования.ДатаКонца,"ДФ=MM"));
			КонецЕсли;
			
			для ии = 1 по КоличествоМесяцев Цикл
				ЭлементыФормы.ПланЗатрат.Колонки["Месяц"+ии].текстШапки = Формат(добавитьмесяц(ПериодПланирования.ДатаНачала,ии-1),"ДФ=MMMMгг");//+" "+Год(добавитьмесяц(ПериодПланирования.ДатаНачала,ии-1));
				ЭлементыФормы.ПланЗатрат.Колонки["Месяц"+ии].видимость = истина;
				//    ЭлементыФормы.ПланЗатрат.Колонки["ком"+ии].видимость = истина;
				ЭлементыФормы.ПланЗатрат.Колонки["ком"+ии].ширина = 3;
			конеццикла;
			
			для каждого стр из ПланЗатрат Цикл
				для ии = 1 по КоличествоМесяцев Цикл
					Если ЗначениеЗаполнено(СокрЛП(стр["ком"+ии])) тогда
						ЭлементыФормы.ПланЗатрат.Колонки["ком"+ии].видимость = истина;
						ЭлементыФормы.ПланЗатрат.Колонки["ком"+ии].ширина = 15;
						
					конецЕсли;	
				конецЦикла;
			конецЦикла;
		иначе
			Для каждого колонка из Элементыформы.ПланЗатрат.Колонки цикл
				если колонка.ТекстШапки <>"N" и колонка.ТекстШапки<>"Статья затрат" и колонка.ТекстШапки<>"Комментарий" тогда
					колонка.Видимость = Ложь;
				конецесли;	
			конеццикла;	
			
		конецЕсли;
	иначе
		
		Если не ЭтоНовый() тогда
			ЗаполнитьДерево();
		конецЕсли;
		
		
		Если ЗначениеЗаполнено(ПериодПланирования) тогда
			//уберем видимость
			Для каждого колонка из Элементыформы.ПланЗатрат.Колонки цикл
				если Найти(колонка.Имя,"Месяц")<>0 тогда
					колонка.Видимость = Ложь;
				конецесли;	
			конеццикла;	
			
			//настроим видимость  	
			Если Число(Формат(ПериодПланирования.ДатаНачала,"ДФ=yyyy")) = Число(Формат(ПериодПланирования.ДатаКонца,"ДФ=yyyy")) Тогда	
				КоличествоМесяцев = Число(Формат(ПериодПланирования.ДатаКонца,"ДФ=MM")) - Число(Формат(ПериодПланирования.ДатаНачала,"ДФ=MM")) +1;
			иначе
				КоличествоМесяцев = 12 - Число(Формат(ПериодПланирования.ДатаНачала,"ДФ=MM")) +1 + Число(Формат(ПериодПланирования.ДатаКонца,"ДФ=MM"));
			КонецЕсли;
			
			для ии = 1 по КоличествоМесяцев Цикл
				ЭлементыФормы.ДеревоЗатрат.Колонки["Месяц"+ии].текстШапки = Формат(добавитьмесяц(ПериодПланирования.ДатаНачала,ии-1),"ДФ=MMMMгг");//+" "+Год(добавитьмесяц(ПериодПланирования.ДатаНачала,ии-1));
				ЭлементыФормы.ДеревоЗатрат.Колонки["Месяц"+ии].видимость = истина;
				//    ЭлементыФормы.ПланЗатрат.Колонки["ком"+ии].видимость = истина;
				ЭлементыФормы.ДеревоЗатрат.Колонки["ком"+ии].ширина = 3;
			конеццикла;
			
			для каждого стр из ПланЗатрат Цикл
				для ии = 1 по КоличествоМесяцев Цикл
					Если ЗначениеЗаполнено(стр["ком"+ии]) тогда
						ЭлементыФормы.ДеревоЗатрат.Колонки["ком"+ии].видимость = истина;
						ЭлементыФормы.ДеревоЗатрат.Колонки["ком"+ии].ширина = 15;
						
					конецЕсли;	
				конецЦикла;
			конецЦикла;
		иначе
			Для каждого колонка из Элементыформы.ДеревоЗатрат.Колонки цикл
				если колонка.ТекстШапки <>"N" и колонка.ТекстШапки<>"Статья затрат" и колонка.ТекстШапки<>"Группа статьи" тогда
					колонка.Видимость = Ложь;
				конецесли;	
			конеццикла;	
		конецЕсли;
		
		Если СписокПодразделений тогда
			ЭлементыФормы.ДеревоЗатрат.Колонки.Подразделение.видимость = истина;
			ЭлементыФормы.ДеревоЗатрат.Колонки.РодительПодразделения.видимость = истина;
		иначе
			ЭлементыФормы.ДеревоЗатрат.Колонки.Подразделение.видимость = ложь;
			ЭлементыФормы.ДеревоЗатрат.Колонки.РодительПодразделения.видимость = ложь;
		конецесли;
		Если не ЗначениеЗаполнено(Исполнитель)Тогда
			исполнитель = глТекущийПользователь;
		конецЕсли;	
		
	конецЕсли;
КонецПроцедуры

процедура УстановитьВидимость()
	Если ЗначениеЗаполнено(ПериодПланирования) тогда
		//уберем видимость
		Для каждого колонка из Элементыформы.ПланЗатрат.Колонки цикл
			если Найти(колонка.Имя,"Месяц")<>0 тогда
				колонка.Видимость = Ложь;
			конецесли;	
		конеццикла;	
		
		//настроим видимость  	
		Если Число(Формат(ПериодПланирования.ДатаНачала,"ДФ=yyyy")) = Число(Формат(ПериодПланирования.ДатаКонца,"ДФ=yyyy")) Тогда	
			КоличествоМесяцев = Число(Формат(ПериодПланирования.ДатаКонца,"ДФ=MM")) - Число(Формат(ПериодПланирования.ДатаНачала,"ДФ=MM")) +1;
		иначе
			КоличествоМесяцев = 12 - Число(Формат(ПериодПланирования.ДатаНачала,"ДФ=MM")) +1 + Число(Формат(ПериодПланирования.ДатаКонца,"ДФ=MM"));
		КонецЕсли;
		
		для ии = 1 по КоличествоМесяцев Цикл
			ЭлементыФормы.ДеревоЗатрат.Колонки["Месяц"+ии].текстШапки = Формат(добавитьмесяц(ПериодПланирования.ДатаНачала,ии-1),"ДФ=MMMMгг");//+" "+Год(добавитьмесяц(ПериодПланирования.ДатаНачала,ии-1));
			ЭлементыФормы.ДеревоЗатрат.Колонки["Месяц"+ии].видимость = истина;
			//    ЭлементыФормы.ПланЗатрат.Колонки["ком"+ии].видимость = истина;
			ЭлементыФормы.ДеревоЗатрат.Колонки["ком"+ии].ширина = 3;
		конеццикла;
		
		для каждого стр из ПланЗатрат Цикл
			для ии = 1 по КоличествоМесяцев Цикл
				Если ЗначениеЗаполнено(стр["ком"+ии]) тогда
					ЭлементыФормы.ДеревоЗатрат.Колонки["ком"+ии].видимость = истина;
					ЭлементыФормы.ДеревоЗатрат.Колонки["ком"+ии].ширина = 15;
					
				конецЕсли;	
			конецЦикла;
		конецЦикла;
	иначе
		Для каждого колонка из Элементыформы.ДеревоЗатрат.Колонки цикл
			если колонка.ТекстШапки <>"N" и колонка.ТекстШапки<>"Статья затрат" и колонка.ТекстШапки<>"Группа статьи" тогда
				колонка.Видимость = Ложь;
			конецесли;	
		конеццикла;	
	конецЕсли;
	
	Если СписокПодразделений тогда
		ЭлементыФормы.ДеревоЗатрат.Колонки.Подразделение.видимость = истина;
		ЭлементыФормы.ДеревоЗатрат.Колонки.РодительПодразделения.видимость = истина;
	иначе
		ЭлементыФормы.ДеревоЗатрат.Колонки.Подразделение.видимость = ложь;
		ЭлементыФормы.ДеревоЗатрат.Колонки.РодительПодразделения.видимость = истина;
	конецесли;
	
	
	
	
	
конецПроцедуры	

Процедура СписокПодразделенийПриИзменении(Элемент)
	Если ДеревоЗатрат.Строки.Количество()>0 тогда	
		Ответ = Вопрос("Табличная часть будет очищена. Продолжить?", РежимДиалогаВопрос.ДаНет, 0);
		Если Ответ = КодВозвратаДиалога.Да Тогда
		ДеревоЗатрат.Строки.Очистить();		
		ЭлементыФормы.ДеревоЗатрат.Колонки.Подразделение.Видимость = СписокПодразделений;
	    иначе 
		ЭлементыФормы.ДеревоЗатрат.Колонки.Подразделение.Видимость = не СписокПодразделений;
		КонецЕсли;
	иначе
		ЭлементыФормы.ДеревоЗатрат.Колонки.Подразделение.Видимость = СписокПодразделений;
	конецесли;
	
	если СамНаСебя тогда
	СамНаСебя = не СписокПодразделений;
	конецесли;
КонецПроцедуры

Процедура КоманднаяПанель1Заполнить(Кнопка)
Если не ЗначениеЗаполнено(ПериодПланирования) тогда
 Сообщить("Заполните период планирования!");
иначе		
 ЗаполнитьДерево();	
 УстановитьВидимость();
конецЕсли;
КонецПроцедуры

процедура ЗаполнитьДерево()
	Если СписокПодразделений Тогда

	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	СтатьиЗатрат.Ссылка КАК СтатьяЗатрат,
		|	СтатьиЗатрат.Родитель,
		|	Подразделения.Ссылка КАК Подразделение,
		|	Подразделения.Родитель КАК РодительПодразделения
		|ПОМЕСТИТЬ Справочники
		|ИЗ
		|	Справочник.СтатьиЗатрат КАК СтатьиЗатрат
		|		ПОЛНОЕ СОЕДИНЕНИЕ Справочник.Подразделения КАК Подразделения
		|		ПО (ИСТИНА)
		|ГДЕ
		|	СтатьиЗатрат.Ответственный = &Ответственный
		|	И Подразделения.Планирование = ИСТИНА
		|	И (СтатьиЗатрат.ПланируетОтветственный = ИСТИНА
		|			ИЛИ СтатьиЗатрат.ПланируетРуководитель = ИСТИНА)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ТабЧасть.СтатьяЗатрат,
		|	ТабЧасть.Подразделение,
		|	ТабЧасть.Месяц1,
		|	ТабЧасть.Ком1,
		|	ТабЧасть.Месяц2,
		|	ТабЧасть.Ком2,
		|	ТабЧасть.Месяц3,
		|	ТабЧасть.Ком3,
		|	ТабЧасть.Месяц4,
		|	ТабЧасть.Ком4,
		|	ТабЧасть.Месяц5,
		|	ТабЧасть.Ком5,
		|	ТабЧасть.Месяц6,
		|	ТабЧасть.Ком6,
		|	ТабЧасть.Месяц7,
		|	ТабЧасть.Ком7,
		|	ТабЧасть.Месяц8,
		|	ТабЧасть.Ком8,
		|	ТабЧасть.Месяц9,
		|	ТабЧасть.Ком9,
		|	ТабЧасть.Месяц10,
		|	ТабЧасть.Ком10,
		|	ТабЧасть.Месяц11,
		|	ТабЧасть.Ком11,
		|	ТабЧасть.Месяц12,
		|	ТабЧасть.Ком12
		|ПОМЕСТИТЬ Документ
		|ИЗ
		|	&ТабЧасть КАК ТабЧасть
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Справочники.СтатьяЗатрат КАК СтатьяЗатрат,
		|	Справочники.Родитель КАК Родитель,
		|	Справочники.Подразделение КАК Подразделение,
		|	ЕСТЬNULL(Документ.Месяц1, 0) КАК Месяц1,
		|	ЕСТЬNULL(Документ.Ком1, """") КАК Ком1,
		|	ЕСТЬNULL(Документ.Месяц2, 0) КАК Месяц2,
		|	ЕСТЬNULL(Документ.Ком2, """") КАК Ком2,
		|	ЕСТЬNULL(Документ.Месяц3, 0) КАК Месяц3,
		|	ЕСТЬNULL(Документ.Ком3, """") КАК Ком3,
		|	ЕСТЬNULL(Документ.Месяц4, 0) КАК Месяц4,
		|	ЕСТЬNULL(Документ.Ком4, """") КАК Ком4,
		|	ЕСТЬNULL(Документ.Месяц5, 0) КАК Месяц5,
		|	ЕСТЬNULL(Документ.Ком5, """") КАК Ком5,
		|	ЕСТЬNULL(Документ.Месяц6, 0) КАК Месяц6,
		|	ЕСТЬNULL(Документ.Ком6, """") КАК Ком6,
		|	ЕСТЬNULL(Документ.Месяц7, 0) КАК Месяц7,
		|	ЕСТЬNULL(Документ.Ком7, """") КАК Ком7,
		|	ЕСТЬNULL(Документ.Месяц8, 0) КАК Месяц8,
		|	ЕСТЬNULL(Документ.Ком8, """") КАК Ком8,
		|	ЕСТЬNULL(Документ.Месяц9, 0) КАК Месяц9,
		|	ЕСТЬNULL(Документ.Ком9, """") КАК Ком9,
		|	ЕСТЬNULL(Документ.Месяц10, 0) КАК Месяц10,
		|	ЕСТЬNULL(Документ.Ком10, """") КАК Ком10,
		|	ЕСТЬNULL(Документ.Месяц11, 0) КАК Месяц11,
		|	ЕСТЬNULL(Документ.Ком11, """") КАК Ком11,
		|	ЕСТЬNULL(Документ.Месяц12, 0) КАК Месяц12,
		|	ЕСТЬNULL(Документ.Ком12, """") КАК Ком12,
		|	Справочники.РодительПодразделения КАК РодительПодразделения,
		|	ЕСТЬNULL(Документ.Месяц1, 0) + ЕСТЬNULL(Документ.Месяц2, 0) + ЕСТЬNULL(Документ.Месяц3, 0) + ЕСТЬNULL(Документ.Месяц4, 0) + ЕСТЬNULL(Документ.Месяц5, 0) + ЕСТЬNULL(Документ.Месяц6, 0) + ЕСТЬNULL(Документ.Месяц7, 0) + ЕСТЬNULL(Документ.Месяц8, 0) + ЕСТЬNULL(Документ.Месяц9, 0) + ЕСТЬNULL(Документ.Месяц10, 0) + ЕСТЬNULL(Документ.Месяц11, 0) + ЕСТЬNULL(Документ.Месяц12, 0) КАК Итого
		|ИЗ
		|	Справочники КАК Справочники
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ КАК Документ
		|		ПО Справочники.СтатьяЗатрат = Документ.СтатьяЗатрат
		|			И Справочники.Подразделение = Документ.Подразделение
		|
		|УПОРЯДОЧИТЬ ПО
		|	Справочники.Родитель.Наименование,
		|	Справочники.СтатьяЗатрат.Наименование,
		|	Справочники.РодительПодразделения.Наименование,
		|	Справочники.Подразделение.Наименование
		|ИТОГИ
		|	СУММА(Месяц1),
		|	СУММА(Месяц2),
		|	СУММА(Месяц3),
		|	СУММА(Месяц4),
		|	СУММА(Месяц5),
		|	СУММА(Месяц6),
		|	СУММА(Месяц7),
		|	СУММА(Месяц8),
		|	СУММА(Месяц9),
		|	СУММА(Месяц10),
		|	СУММА(Месяц11),
		|	СУММА(Месяц12),
		|	СУММА(Итого)
		|ПО
		|	Родитель,
		|	СтатьяЗатрат,
		|	РодительПодразделения";

	Запрос.УстановитьПараметр("Ответственный", Исполнитель);
	Запрос.УстановитьПараметр("ТабЧасть",ПланЗатрат);
	Результат = Запрос.Выполнить();

   ЭлементыФормы.ДеревоЗатрат.Значение  = Результат.Выгрузить(ОбходРезультатаЗапроса.ПоГруппировкам);		
		
		
	иначе

	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	СтатьиЗатрат.Ссылка КАК СтатьяЗатрат,
		|	СтатьиЗатрат.Родитель
		|ПОМЕСТИТЬ Справочники
		|ИЗ
		|	Справочник.СтатьиЗатрат КАК СтатьиЗатрат
		|ГДЕ
		|	99 = 99
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ТабЧасть.СтатьяЗатрат,
		|	ТабЧасть.Подразделение,
		|	ТабЧасть.Месяц1,
		|	ТабЧасть.Ком1,
		|	ТабЧасть.Месяц2,
		|	ТабЧасть.Ком2,
		|	ТабЧасть.Месяц3,
		|	ТабЧасть.Ком3,
		|	ТабЧасть.Месяц4,
		|	ТабЧасть.Ком4,
		|	ТабЧасть.Месяц5,
		|	ТабЧасть.Ком5,
		|	ТабЧасть.Месяц6,
		|	ТабЧасть.Ком6,
		|	ТабЧасть.Месяц7,
		|	ТабЧасть.Ком7,
		|	ТабЧасть.Месяц8,
		|	ТабЧасть.Ком8,
		|	ТабЧасть.Месяц9,
		|	ТабЧасть.Ком9,
		|	ТабЧасть.Месяц10,
		|	ТабЧасть.Ком10,
		|	ТабЧасть.Месяц11,
		|	ТабЧасть.Ком11,
		|	ТабЧасть.Месяц12,
		|	ТабЧасть.Ком12
		|ПОМЕСТИТЬ Документ
		|ИЗ
		|	&ТабЧасть КАК ТабЧасть
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Справочники.СтатьяЗатрат КАК СтатьяЗатрат,
		|	Справочники.Родитель КАК Родитель,
		|	ЕСТЬNULL(Документ.Месяц1, 0) КАК Месяц1,
		|	ЕСТЬNULL(Документ.Ком1, """") КАК Ком1,
		|	ЕСТЬNULL(Документ.Месяц2, 0) КАК Месяц2,
		|	ЕСТЬNULL(Документ.Ком2, """") КАК Ком2,
		|	ЕСТЬNULL(Документ.Месяц3, 0) КАК Месяц3,
		|	ЕСТЬNULL(Документ.Ком3, """") КАК Ком3,
		|	ЕСТЬNULL(Документ.Месяц4, 0) КАК Месяц4,
		|	ЕСТЬNULL(Документ.Ком4, """") КАК Ком4,
		|	ЕСТЬNULL(Документ.Месяц5, 0) КАК Месяц5,
		|	ЕСТЬNULL(Документ.Ком5, """") КАК Ком5,
		|	ЕСТЬNULL(Документ.Месяц6, 0) КАК Месяц6,
		|	ЕСТЬNULL(Документ.Ком6, """") КАК Ком6,
		|	ЕСТЬNULL(Документ.Месяц7, 0) КАК Месяц7,
		|	ЕСТЬNULL(Документ.Ком7, """") КАК Ком7,
		|	ЕСТЬNULL(Документ.Месяц8, 0) КАК Месяц8,
		|	ЕСТЬNULL(Документ.Ком8, """") КАК Ком8,
		|	ЕСТЬNULL(Документ.Месяц9, 0) КАК Месяц9,
		|	ЕСТЬNULL(Документ.Ком9, """") КАК Ком9,
		|	ЕСТЬNULL(Документ.Месяц10, 0) КАК Месяц10,
		|	ЕСТЬNULL(Документ.Ком10, """") КАК Ком10,
		|	ЕСТЬNULL(Документ.Месяц11, 0) КАК Месяц11,
		|	ЕСТЬNULL(Документ.Ком11, """") КАК Ком11,
		|	ЕСТЬNULL(Документ.Месяц12, 0) КАК Месяц12,
		|	ЕСТЬNULL(Документ.Ком12, """") КАК Ком12,
		|	Документ.Подразделение,
		|	ЕСТЬNULL(Документ.Месяц1, 0) + ЕСТЬNULL(Документ.Месяц2, 0) + ЕСТЬNULL(Документ.Месяц3, 0) + ЕСТЬNULL(Документ.Месяц4, 0) + ЕСТЬNULL(Документ.Месяц5, 0) + ЕСТЬNULL(Документ.Месяц6, 0) + ЕСТЬNULL(Документ.Месяц7, 0) + ЕСТЬNULL(Документ.Месяц8, 0) + ЕСТЬNULL(Документ.Месяц9, 0) + ЕСТЬNULL(Документ.Месяц10, 0) + ЕСТЬNULL(Документ.Месяц11, 0) + ЕСТЬNULL(Документ.Месяц12, 0) КАК Итого,
		|	NULL КАК РодительПодразделения
		|ИЗ
		|	Справочники КАК Справочники
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ КАК Документ
		|		ПО Справочники.СтатьяЗатрат = Документ.СтатьяЗатрат
		|
		|УПОРЯДОЧИТЬ ПО
		|	Справочники.Родитель.Наименование,
		|	Справочники.СтатьяЗатрат.Наименование
		|ИТОГИ
		|	СУММА(Месяц1),
		|	СУММА(Месяц2),
		|	СУММА(Месяц3),
		|	СУММА(Месяц4),
		|	СУММА(Месяц5),
		|	СУММА(Месяц6),
		|	СУММА(Месяц7),
		|	СУММА(Месяц8),
		|	СУММА(Месяц9),
		|	СУММА(Месяц10),
		|	СУММА(Месяц11),
		|	СУММА(Месяц12),
		|	СУММА(Итого)
		|ПО
		|	Родитель";

	Если не СамНаСебя тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст,"99 = 99","СтатьиЗатрат.ПланируетРуководитель");
	иначе                                                                                                
		Запрос.Текст = СтрЗаменить(Запрос.Текст,"99 = 99","СтатьиЗатрат.Ответственный = &Ответственный и (СтатьиЗатрат.ПланируетРуководитель или СтатьиЗатрат.Планируетответственный)");
	конецЕсли;		
		
	Запрос.УстановитьПараметр("Ответственный", Исполнитель);
	Запрос.УстановитьПараметр("ТабЧасть",ПланЗатрат);
	Результат = Запрос.Выполнить();

   ЭлементыФормы.ДеревоЗатрат.Значение  = Результат.Выгрузить(ОбходРезультатаЗапроса.ПоГруппировкам);		
	конецЕсли;	
пересчетПодвала();	
конецпроцедуры

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	Если не ИзменяюСвоиСтатьи Тогда
	ПеренестиДанныеВДокумент();
	конецЕсли;
КонецПроцедуры

процедура ПеренестиДанныеВДокумент()
ПланЗатрат.Очистить();
ПеренестиДанные(ДеревоЗатрат);
конецпроцедуры

процедура перенестиДанные(Строка)
Для каждого стр из Строка.Строки Цикл
	Если стр.Строки.Количество()=0 тогда//запишем документ
	НовСтр = ПланЗатрат.Добавить();
	ЗаполнитьЗначенияСвойств(НовСтр,стр);	
	иначе
	перенестиДанные(стр);
	конецЕсли;
конецЦикла;	
	
конецпроцедуры	

Процедура ДеревоЗатратПриПолученииДанных(Элемент, ОформленияСтрок)
	Для каждого ОформлениеСтроки из Оформлениястрок Цикл
		
		Если не ЗначениеЗаполнено(ОформлениеСтроки.ДанныеСтроки.статьяЗатрат)  Тогда
			Если СписокПодразделений тогда
				ОформлениеСтроки.ЦветФона = webцвета.БледноЗеленый;	
	
				Для каждого яч из ОформлениеСтроки.ячейки	Цикл
					Яч.ТолькоПросмотр = Истина;
					Яч.Шрифт =  Новый Шрифт(,10,Истина,,,);
				конецЦикла;
			иначе
			ОформлениеСтроки.ЦветФона = webцвета.БледноЗолотистый;	
	
				Для каждого яч из ОформлениеСтроки.ячейки	Цикл
					Яч.ТолькоПросмотр = Истина;
					Яч.Шрифт =  Новый Шрифт(,9,Истина,,,);
				конецЦикла;
			конецЕсли;
		конецЕсли;
		
		Если не ЗначениеЗаполнено(ОформлениеСтроки.ДанныеСтроки.Подразделение) и не ЗначениеЗаполнено(ОформлениеСтроки.ДанныеСтроки.РодительПодразделения) и ЗначениеЗаполнено(ОформлениеСтроки.ДанныеСтроки.статьяЗатрат)и СписокПодразделений  Тогда
			ОформлениеСтроки.ЦветФона = webцвета.БледноЗолотистый;	
			Для каждого яч из ОформлениеСтроки.ячейки	Цикл
					Яч.ТолькоПросмотр = Истина;
					Яч.Шрифт =  Новый Шрифт(,9,Истина,,,);
				конецЦикла;
		конецЕсли;
        		Если не ЗначениеЗаполнено(ОформлениеСтроки.ДанныеСтроки.Подразделение) и  ЗначениеЗаполнено(ОформлениеСтроки.ДанныеСтроки.РодительПодразделения) и ЗначениеЗаполнено(ОформлениеСтроки.ДанныеСтроки.статьяЗатрат)и СписокПодразделений  Тогда
			ОформлениеСтроки.ЦветФона = webцвета.БледноМиндальный;	
			Для каждого яч из ОформлениеСтроки.ячейки	Цикл
					Яч.ТолькоПросмотр = Истина;
					Яч.Шрифт =  Новый Шрифт(,9,Истина,,,);
				конецЦикла;
		конецЕсли;
     ОформлениеСтроки.ячейки.Итого.ТолькоПросмотр = Истина;
	конецЦикла;	
КонецПроцедуры

процедура пересчетИтогов(стр);
	РодительскаяСтрока = Стр.Родитель;
	Если РодительскаяСтрока <> Неопределено Тогда
		Месяц1 =0;
		Месяц2 =0;
		Месяц3 =0;
		Месяц4 =0;
		Месяц5 =0;
		Месяц6 =0;
		Месяц7 =0;
		Месяц8 =0;
		Месяц9 =0;
		Месяц10 =0;
		Месяц11 =0;
		Месяц12 =0;
		Для каждого ст из РодительскаяСтрока.Строки  Цикл
		Месяц1 =Месяц1 +ст.Месяц1;
		Месяц2 =Месяц2 +ст.Месяц2;
		Месяц3 =Месяц3 +ст.Месяц3;
		Месяц4 =Месяц4 +ст.Месяц4;
		Месяц5 =Месяц5 +ст.Месяц5;
		Месяц6 =Месяц6 +ст.Месяц6;
		Месяц7 =Месяц7 +ст.Месяц7;
		Месяц8 =Месяц8 +ст.Месяц8;
		Месяц9 =Месяц9 +ст.Месяц9;
		Месяц10 =Месяц10 +ст.Месяц10;
		Месяц11 =Месяц11 +ст.Месяц11;
		Месяц12 =Месяц12 +ст.Месяц12;
		ст.Итого = ст.Месяц1+ст.Месяц2+ст.Месяц3+ст.Месяц4+ст.Месяц5+ст.Месяц6+ст.Месяц7+ст.Месяц8+ст.Месяц9+ст.Месяц10+ст.Месяц11+ст.Месяц12;

		конецЦикла; 
		РодительскаяСтрока.Месяц1 =Месяц1;
		РодительскаяСтрока.Месяц2 =Месяц2;
		РодительскаяСтрока.Месяц3 =Месяц3;
		РодительскаяСтрока.Месяц4 =Месяц4;
		РодительскаяСтрока.Месяц5 =Месяц5;
		РодительскаяСтрока.Месяц6 =Месяц6;
		РодительскаяСтрока.Месяц7 =Месяц7;
		РодительскаяСтрока.Месяц8 =Месяц8;
		РодительскаяСтрока.Месяц9 =Месяц9;
		РодительскаяСтрока.Месяц10 =Месяц10;
		РодительскаяСтрока.Месяц11 =Месяц11;
		РодительскаяСтрока.Месяц12 =Месяц12;
		РодительскаяСтрока.Итого =Месяц1+Месяц2+Месяц3+Месяц4+Месяц5+Месяц6+Месяц7+Месяц8+Месяц9+Месяц10+Месяц11+Месяц12;

		пересчетИтогов(РодительскаяСтрока);	 
	конецЕсли;	 
конецПроцедуры

Процедура ДеревоЗатратПриОкончанииРедактирования(Элемент, НоваяСтрока, ОтменаРедактирования)
	ТекущаяСтрока = ЭлементыФормы.ДеревоЗатрат.ТекущиеДанные;
	пересчетИтогов(ТекущаяСтрока);
	пересчетПодвала();
КонецПроцедуры

процедура пересчетПодвала()
		Месяц1 =0;
		Месяц2 =0;
		Месяц3 =0;
		Месяц4 =0;
		Месяц5 =0;
		Месяц6 =0;
		Месяц7 =0;
		Месяц8 =0;
		Месяц9 =0;
		Месяц10 =0;
		Месяц11 =0;
		Месяц12 =0;
		Для каждого ст из ДеревоЗатрат.Строки  Цикл
		Месяц1 =Месяц1 +ст.Месяц1;
		Месяц2 =Месяц2 +ст.Месяц2;
		Месяц3 =Месяц3 +ст.Месяц3;
		Месяц4 =Месяц4 +ст.Месяц4;
		Месяц5 =Месяц5 +ст.Месяц5;
		Месяц6 =Месяц6 +ст.Месяц6;
		Месяц7 =Месяц7 +ст.Месяц7;
		Месяц8 =Месяц8 +ст.Месяц8;
		Месяц9 =Месяц9 +ст.Месяц9;
		Месяц10 =Месяц10 +ст.Месяц10;
		Месяц11 =Месяц11 +ст.Месяц11;
		Месяц12 =Месяц12 +ст.Месяц12;
	конецЦикла;
	    ЭлементыФормы.ДеревоЗатрат.Колонки.СтатьяЗатрат.ТекстПодвала = "Итого";
		ЭлементыФормы.ДеревоЗатрат.Колонки.Месяц1.ТекстПодвала = Месяц1;
		ЭлементыФормы.ДеревоЗатрат.Колонки.Месяц2.ТекстПодвала = Месяц2;
		ЭлементыФормы.ДеревоЗатрат.Колонки.Месяц3.ТекстПодвала = Месяц3;
		ЭлементыФормы.ДеревоЗатрат.Колонки.Месяц4.ТекстПодвала = Месяц4;
		ЭлементыФормы.ДеревоЗатрат.Колонки.Месяц5.ТекстПодвала = Месяц5;
		ЭлементыФормы.ДеревоЗатрат.Колонки.Месяц6.ТекстПодвала = Месяц6;
		ЭлементыФормы.ДеревоЗатрат.Колонки.Месяц7.ТекстПодвала = Месяц7;
		ЭлементыФормы.ДеревоЗатрат.Колонки.Месяц8.ТекстПодвала = Месяц8;
		ЭлементыФормы.ДеревоЗатрат.Колонки.Месяц9.ТекстПодвала = Месяц9;
		ЭлементыФормы.ДеревоЗатрат.Колонки.Месяц10.ТекстПодвала = Месяц10;
		ЭлементыФормы.ДеревоЗатрат.Колонки.Месяц11.ТекстПодвала = Месяц1;
		ЭлементыФормы.ДеревоЗатрат.Колонки.Месяц12.ТекстПодвала = Месяц12;
		ЭлементыФормы.ДеревоЗатрат.Колонки.Итого.ТекстПодвала =Месяц1+Месяц2+Месяц3+Месяц4+Месяц5+Месяц6+Месяц7+Месяц8+Месяц9+Месяц10+Месяц11+Месяц12;
 конецПроцедуры

Процедура СамНаСебяПриИзменении(Элемент)
	 	Если ДеревоЗатрат.Строки.Количество()>0 тогда	
		Ответ = Вопрос("Табличная часть будет очищена. Продолжить?", РежимДиалогаВопрос.ДаНет, 0);
		Если Ответ = КодВозвратаДиалога.Да Тогда
		ДеревоЗатрат.Строки.Очистить();	
		если  СписокПодразделений тогда
		СписокПодразделений = не СамНаСебя;
		конецесли;
		ЭлементыФормы.ДеревоЗатрат.Колонки.Подразделение.Видимость = СписокПодразделений;
	    иначе 
		
		ЭлементыФормы.ДеревоЗатрат.Колонки.Подразделение.Видимость = не СписокПодразделений;
		КонецЕсли;
	иначе
		ЭлементыФормы.ДеревоЗатрат.Колонки.Подразделение.Видимость = СписокПодразделений;
	конецесли;

 КонецПроцедуры

Процедура ДобавитькомментарийНажатие(Элемент)
	 Название = ЭлементыФормы.планЗатрат.ТекущаяКолонка.Имя;
	 Если Найти(Название,"Месяц")<>0 тогда
		 номер = сред(Название,6);
		 ЭлементыФормы.планЗатрат.Колонки["Ком"+Номер].видимость = Истина;
	 конецЕсли;	
 КонецПроцедуры


 Процедура ДеревоЗатратПередУдалением(Элемент, Отказ)
	Отказ=Истина;
КонецПроцедуры


Процедура ДеревоЗатратПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель)
	отказ=Истина;
КонецПроцедуры


Процедура КоманднаяПанель1ЗаполнитьКомандировки(Кнопка)
	Месяца = Новый Соответствие;
	
Если Число(Формат(ПериодПланирования.ДатаНачала,"ДФ=yyyy")) = Число(Формат(ПериодПланирования.ДатаКонца,"ДФ=yyyy")) Тогда	
		КоличествоМесяцев = Число(Формат(ПериодПланирования.ДатаКонца,"ДФ=MM")) - Число(Формат(ПериодПланирования.ДатаНачала,"ДФ=MM")) +1;
	иначе
		КоличествоМесяцев = 12 - Число(Формат(ПериодПланирования.ДатаНачала,"ДФ=MM")) +1 + Число(Формат(ПериодПланирования.ДатаКонца,"ДФ=MM"));
	КонецЕсли;
	
	для ии = 1 по КоличествоМесяцев Цикл
		Месяца.Вставить(ДобавитьМесяц(ПериодПланирования.ДатаНачала,ии-1),ии);
	конецЦикла;

	
		//проезд
	Отбор =новый структура("СтатьяЗатрат",Справочники.СтатьиЗатрат.НайтиПоКоду("А0047"));
	строки = планЗатрат.НайтиСтроки(Отбор);
	для каждого стр из строки Цикл
	ПланЗатрат.Удалить(СТР);
	конецЦИкла;
	//Проживание
	Отбор = новый структура("СтатьяЗатрат",Справочники.СтатьиЗатрат.НайтиПоКоду("А0046"));
	строки = планЗатрат.НайтиСтроки(Отбор);
	для каждого стр из строки Цикл
	ПланЗатрат.Удалить(СТР);
	конецЦИкла;
	//ПрочиеРасходы
	Отбор = новый структура("СтатьяЗатрат",Справочники.СтатьиЗатрат.НайтиПоКоду("А0049"));
	строки = планЗатрат.НайтиСтроки(Отбор);
	для каждого стр из строки Цикл
	ПланЗатрат.Удалить(СТР);
	конецЦИкла;
	//Суточные
	Отбор = новый структура("СтатьяЗатрат",Справочники.СтатьиЗатрат.НайтиПоКоду("А0048"));
	строки = планЗатрат.НайтиСтроки(Отбор);
	для каждого стр из строки Цикл
	ПланЗатрат.Удалить(СТР);
	конецЦИкла;
	
	//суточныесверхнорм
	Отбор = новый структура("СтатьяЗатрат",Справочники.СтатьиЗатрат.НайтиПоКоду("А0195"));
	строки = планЗатрат.НайтиСтроки(Отбор);
	для каждого стр из строки Цикл
	ПланЗатрат.Удалить(СТР);
	конецЦИкла;
	
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	НАЧАЛОПЕРИОДА(ПланированиеКомандировок.Месяц, МЕСЯЦ) КАК месяц,
		|	ВЫБОР
		|		КОГДА ПланированиеКомандировок.Подразделение.Планирование
		|			ТОГДА ПланированиеКомандировок.Подразделение
		|		ИНАЧЕ ПланированиеКомандировок.Подразделение.Родитель
		|	КОНЕЦ КАК Подразделение,
		|	СУММА(ВЫБОР
		|			КОГДА ПланированиеКомандировок.Международная
		|				ТОГДА ПланированиеКомандировок.Суточные
		|			ИНАЧЕ ПланированиеКомандировок.Суточные * 0.7
		|		КОНЕЦ) КАК Суточные,
		|	СУММА(ПланированиеКомандировок.Проезд) КАК Проезд,
		|	СУММА(ПланированиеКомандировок.ПрочиеРасходы) КАК ПрочиеРасходы,
		|	СУММА(ПланированиеКомандировок.Проживание) КАК Проживание,
		|	СУММА(ВЫБОР
		|			КОГДА ПланированиеКомандировок.Международная
		|				ТОГДА 0
		|			ИНАЧЕ ПланированиеКомандировок.Суточные * 0.3
		|		КОНЕЦ) КАК СуточныеСверхНорм
		|ИЗ
		|	РегистрСведений.ПланированиеКомандировок КАК ПланированиеКомандировок
		|ГДЕ
		|	ПланированиеКомандировок.ПериодПланирования = &ПериодПланирования
		|	И ПланированиеКомандировок.ПериодБюджета = &ПериодБюджета
		|	И 99 = 99
		|	И ПланированиеКомандировок.УтвержденоНОК = ИСТИНА
		|{ГДЕ
		|	(НАЧАЛОПЕРИОДА(ПланированиеКомандировок.Месяц, МЕСЯЦ) = &НачалоМесяца) КАК Поле2}
		|
		|СГРУППИРОВАТЬ ПО
		|	ВЫБОР
		|		КОГДА ПланированиеКомандировок.Подразделение.Планирование
		|			ТОГДА ПланированиеКомандировок.Подразделение
		|		ИНАЧЕ ПланированиеКомандировок.Подразделение.Родитель
		|	КОНЕЦ,
		|	НАЧАЛОПЕРИОДА(ПланированиеКомандировок.Месяц, МЕСЯЦ)
		|ИТОГИ
		|	СУММА(Суточные),
		|	СУММА(Проезд),
		|	СУММА(ПрочиеРасходы),
		|	СУММА(Проживание),
		|	СУММА(СуточныеСверхНорм)
		|ПО
		|	Подразделение,
		|	месяц";

	Запрос.УстановитьПараметр("ПериодБюджета", ПериодПланирования);
	Запрос.УстановитьПараметр("ПериодПланирования", "Полугодие");
	Если исполнитель <> Справочники.Пользователи.НайтиПоКоду("Аверкина") тогда
	Запрос.Текст= СтрЗаменить(Запрос.Текст,"99 = 99","(ПланированиеКомандировок.Подразделение = &Подразделение)");	
	Запрос.УстановитьПараметр("Подразделение", "Подразделение");
	КонецЕсли;
	Результат = Запрос.Выполнить();

	ВыборкаПодразделение = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);

	Пока ВыборкаПодразделение.Следующий() Цикл
		новСтрПроезд = ПланЗатрат.Добавить();
		НовСтрПроезд.Подразделение = ВыборкаПодразделение.Подразделение;
		НовСтрПроезд.СтатьяЗатрат = Справочники.СтатьиЗатрат.НайтиПоКоду("А0047");
		
		новСтрПроживание = ПланЗатрат.Добавить();
		НовСтрПроживание.Подразделение = ВыборкаПодразделение.Подразделение;
		НовСтрПроживание.СтатьяЗатрат = Справочники.СтатьиЗатрат.НайтиПоКоду("А0046");
		
		новСтрПрочиеРасходы = ПланЗатрат.Добавить();
		НовСтрПрочиеРасходы.Подразделение = ВыборкаПодразделение.Подразделение;
		НовСтрПрочиеРасходы.СтатьяЗатрат = Справочники.СтатьиЗатрат.НайтиПоКоду("А0049");
		
		новСтрСуточные = ПланЗатрат.Добавить();
		НовСтрСуточные.Подразделение = ВыборкаПодразделение.Подразделение;
		НовСтрСуточные.СтатьяЗатрат = Справочники.СтатьиЗатрат.НайтиПоКоду("А0048");

		
		новСтрСуточныеСверхНорм = ПланЗатрат.Добавить();
		НовСтрСуточныеСверхНорм.Подразделение = ВыборкаПодразделение.Подразделение;
		НовСтрСуточныеСверхНорм.СтатьяЗатрат = Справочники.СтатьиЗатрат.НайтиПоКоду("А0195");
		
		 выборка = ВыборкаПодразделение.Выбрать();
		пока Выборка.Следующий()Цикл
			Номер =месяца.Получить(Выборка.месяц);
			новСтрПроезд["Месяц"+номер]=Выборка.Проезд;
			новСтрПроживание["Месяц"+номер]=Выборка.Проживание;
			новСтрПрочиеРасходы["Месяц"+номер]=Выборка.ПрочиеРасходы;
			новСтрСуточные["Месяц"+номер]=Выборка.Суточные;
			новСтрСуточныеСверхНорм["Месяц"+номер]=Выборка.СуточныеСверхНорм;
		конецЦикла;
	КонецЦикла;


	ЗаполнитьДерево();
	
	
	
	
	
	
	КонецПроцедуры

