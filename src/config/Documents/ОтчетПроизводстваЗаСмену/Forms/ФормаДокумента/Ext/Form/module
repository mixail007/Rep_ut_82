
процедура ЗаполнитьПоляПоУмолчанию()
	
	Ответственный = ПараметрыСеанса.ТекущийПользователь;
	
	Организация   = справочники.Организации.НайтиПоКоду("00001");
	Подразделение = справочники.Подразделения.НайтиПоНаименованию("Производство кованных дисков");
	
	СкладГотовойПродукции = справочники.Склады.НайтиПоНаименованию("Ангар-Ковка");
	
	НомГруппаЗатрат    = Справочники.НоменклатурныеГруппы.НайтиПоНаименованию("Производство кованных дисков");
	СтатьяМатЗатрат    = Справочники.СтатьиЗатрат.НайтиПоНаименованию("Производство кованных дисков");
	СтатьяМатЗатратУПР = Справочники.СтатьиЗатратУПР.НайтиПоНаименованию("Производство кованных дисков");

	СпособРаспределенияДопЗатрат = перечисления.СпособыРаспределенияДопРасходов.ПоСумме;
	
КонецПроцедуры

Процедура ПриОткрытии()
	Если ЭтоНовый() и Организация.Пустая() тогда  //не на основании
		ЗаполнитьПоляПоУмолчанию();
	КонецЕсли;	
КонецПроцедуры


Процедура КоманднаяПанель2Заполнить(Кнопка)
Запрос = новый Запрос; 
Запрос.УстановитьПараметр("ГотПрод", ГотоваяПродукция.Выгрузить(,"Номенклатура, Спецификация, Количество") );
Запрос.Текст = "ВЫБРАТЬ
               |	готПрод.Номенклатура КАК Продукт,
               |	готПрод.Спецификация,
               |	готПрод.Количество
               |ПОМЕСТИТЬ ВТ_Товары
               |ИЗ
               |	&ГотПрод КАК готПрод
               |;
               |
               |////////////////////////////////////////////////////////////////////////////////
               |ВЫБРАТЬ
               |	СпецификацияГотовойПродукцииСостав.Комплектующая,
               |	ПРЕДСТАВЛЕНИЕ(СпецификацияГотовойПродукцииСостав.Комплектующая) КАК КомплектующаяПредставление,
               |	СпецификацияГотовойПродукцииСостав.Комплектующая.Код КАК КомплектующаяКод,
               |	СУММА(СпецификацияГотовойПродукцииСостав.Количество * вт.Количество) КАК КоличествоНадо,
               |	МАКСИМУМ(НезавершенноеПроизводствоОбороты.КоличествоОстаток) КАК КоличествоЕсть,
               |	МАКСИМУМ(НезавершенноеПроизводствоОбороты.СуммаОстаток) КАК СуммаЕсть
               |ИЗ
               |	ВТ_Товары КАК вт
               |		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.СпецификацияГотовойПродукции.Состав КАК СпецификацияГотовойПродукцииСостав
               |		ПО вт.Спецификация = СпецификацияГотовойПродукцииСостав.Ссылка
               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.НезавершенноеПроизводство.Остатки(, ) КАК НезавершенноеПроизводствоОбороты
               |		ПО (НезавершенноеПроизводствоОбороты.Номенклатура = СпецификацияГотовойПродукцииСостав.Комплектующая)
               |
               |СГРУППИРОВАТЬ ПО
               |	СпецификацияГотовойПродукцииСостав.Комплектующая,
               |	СпецификацияГотовойПродукцииСостав.Комплектующая.Код";
результат = Запрос.Выполнить();
 выборка  = результат.Выбрать();
 
 Материалы.Очистить();  //---------------------- минимум по количеству -------------------------
 колНехватки = 0;
 Пока выборка.Следующий() цикл
	Если выборка.КоличествоЕсть>= выборка.КоличествоНадо тогда
	 кол = выборка.КоличествоНадо;
	 сум = ?(выборка.КоличествоЕсть=0, 0, выборка.СуммаЕсть * кол / выборка.КоличествоЕсть);
	иначе
	 кол = выборка.КоличествоЕсть;
	 сум = выборка.СуммаЕсть;
	 
	 кол1 = выборка.КоличествоНадо - кол;
	 колНехватки = колНехватки + кол1;
	 сообщить("Не хватает материала: "+ выборка.КомплектующаяКод + " - "+строка(выборка.КомплектующаяПредставление)
	 +" в количестве: "+строка(кол1)+ " шт. !", СтатусСообщения.Внимание);
	 
	КонецЕсли;	 

	Если кол>0 тогда
	стр1 = Материалы.Добавить();
	стр1.Номенклатура = выборка.Комплектующая;
	стр1.Количество   = кол;
	стр1.Сумма        = сум;
	КонецЕсли;
 КонецЦикла;	 
 
 Если колНехватки>0 тогда
	 Предупреждение("Недостаточно "+строка(колНехватки)+"шт. материалов для производства Готовой продукции
 			    |В Незавершенном Производстве!", 30);
 КонецЕсли;
				
КонецПроцедуры

Процедура КоманднаяПанель1Себестоимость(Кнопка)
	//сумма 1 готовой продукции = сумма материалов по спецификации  * КолГотПрод * КолКомплект
	// + доп.Затраты.Итог("Сумма") -> распределить по СпособРаспределенияДопЗатрат
	
	мРасчетСебестоимостиГотовойПродукции();
	
	ПолучитьПланСтоимостьГотПрод(); //17.07.2018  по  Константы.ТипЦенПлановойСебестоимостиНоменклатуры
	
КонецПроцедуры

процедура ПолучитьПланСтоимостьГотПрод()
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	ЦеныНоменклатурыСрезПоследних.Номенклатура,
	|	ЦеныНоменклатурыСрезПоследних.Цена
	|ИЗ
	|	РегистрСведений.ЦеныНоменклатуры.СрезПоследних( &Дата,
	|			ТипЦен = &ПланЦена
	|				И Номенклатура В (&СписНом)) КАК ЦеныНоменклатурыСрезПоследних";
	Запрос.УстановитьПараметр("Дата", Дата);
	Запрос.УстановитьПараметр("ТипЦен", Константы.ТипЦенПлановойСебестоимостиНоменклатуры.Получить() );
	Запрос.УстановитьПараметр("СписНом", ГотоваяПродукция.ВыгрузитьКолонку("Номенклатура") );
	
	Результат = Запрос.Выполнить();
	табл = Результат.Выгрузить();
	
	для каждого стр1 из ГотоваяПродукция Цикл 
		стрЦ = табл.Найти(стр1.Номенклатура, "Номенклатура");
		Если стрЦ=Неопределено 
			тогда Цена1 = 0
			иначе Цена1 = стрЦ.Цена;
		КонецЕсли;	
		стр1.СуммаПлан = Цена1 * стр1.Количество;
	КонецЦикла;	
	
КонецПроцедуры

функция ПолучитьСпецификациюПоТовару(тов)
рез = справочники.СпецификацияГотовойПродукции.ПустаяСсылка();
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
	|	СпецификацияГотовойПродукции.Ссылка,
	|	СпецификацияГотовойПродукции.Дата КАК Дата
	|ИЗ
	|	Справочник.СпецификацияГотовойПродукции КАК СпецификацияГотовойПродукции
	|ГДЕ
	|	СпецификацияГотовойПродукции.Номенклатура = &тов
	|
	|УПОРЯДОЧИТЬ ПО
	|	Дата УБЫВ
	|АВТОУПОРЯДОЧИВАНИЕ";
	Запрос.УстановитьПараметр("тов",тов );
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	Если Выборка.Следующий() тогда
		рез = выборка.Ссылка;
	КонецЕсли;
возврат рез;
КонецФункции	

Процедура ГотоваяПродукцияНоменклатураПриИзменении(Элемент)
	стр1 = ЭлементыФормы.ГотоваяПродукция.ТекущиеДанные;
	стр1.спецификация = справочники.СпецификацияГотовойПродукции.ПустаяСсылка();
	Если стр1.Номенклатура.Пустая() тогда
		стр1.спецификация = справочники.СпецификацияГотовойПродукции.ПустаяСсылка();
    иначе
		стр1.спецификация = ПолучитьСпецификациюПоТовару(стр1.Номенклатура);
	КонецЕсли;
КонецПроцедуры



