Перем МесяцДляВывода,Месячный;

Процедура ПриОткрытии()
	// Вставить содержимое обработчика.
	Если месяц=0 тогда 
		МесяцДляВывода=1;
	Иначе 
		МесяцДляВывода=Месяц;
	КонецЕсли;
	
	Если полугодие=0 тогда 
		Полугодие=1;
	Иначе 
		Полугодие=Полугодие;
	КонецЕсли;
	
	Месячный=1;
	
	ТекстЗаголовка=ПолучитьТекстМесяца(МесяцДляВывода,Полугодие);
	ЭлементыФормы.Месяц.Заголовок = ТекстЗаголовка;
КонецПроцедуры

Функция ПолучитьТекстМесяца(Месяц,Полугодие)
	
	Если Месяц=1 Тогда 
		ТекстЗаголовка=?(Полугодие=1,"Январь","Июль");
	ИначеЕсли Месяц=2 Тогда 
		ТекстЗаголовка=?(Полугодие=1,"Февраль","Август");
	ИначеЕсли Месяц=3 Тогда 
		ТекстЗаголовка=?(Полугодие=1,"Март","Сентябрь");
	ИначеЕсли Месяц=4 Тогда 
		ТекстЗаголовка=?(Полугодие=1,"Апрель","Октябрь");
	ИначеЕсли Месяц=5 Тогда 
		ТекстЗаголовка=?(Полугодие=1,"Май","Ноябрь");
	ИначеЕсли Месяц=6 Тогда 
		ТекстЗаголовка=?(Полугодие=1,"Июнь","Декабрь");
	КонецЕсли;
	
	Возврат ТекстЗаголовка;
КонецФункции

Процедура ДействияФормыСформировать(Кнопка)
	// Вставить содержимое обработчика.
	СформироватьОтчет();
КонецПроцедуры

Процедура СформироватьОтчет() Экспорт
	
	Если Месячный=0 Тогда 
		Запрос = Новый Запрос("ВЫБРАТЬ
		|	СЗ.Ответственный КАК Ответственный,
		|	СЗ.Ссылка КАК Статья,
		|	ВЫБОР
		|		КОГДА БюджетРасходов.месяц = 1
		|			ТОГДА &Месяц1
		|		ИНАЧЕ ВЫБОР
		|				КОГДА БюджетРасходов.месяц = 2
		|					ТОГДА &Месяц2
		|				ИНАЧЕ ВЫБОР
		|						КОГДА БюджетРасходов.месяц = 3
		|							ТОГДА &Месяц3
		|						ИНАЧЕ ВЫБОР
		|								КОГДА БюджетРасходов.месяц = 4
		|									ТОГДА &Месяц4
		|								ИНАЧЕ ВЫБОР
		|										КОГДА БюджетРасходов.месяц = 5
		|											ТОГДА &Месяц5
		|										ИНАЧЕ ВЫБОР
		|												КОГДА БюджетРасходов.месяц = 6
		|													ТОГДА &Месяц6
		|											КОНЕЦ
		|									КОНЕЦ
		|							КОНЕЦ
		|					КОНЕЦ
		|			КОНЕЦ
		|	КОНЕЦ КАК месяц,
		|	БюджетРасходов.Подразделение КАК Подразделение,
		|	БюджетРасходов.Состояние КАК Состояние,
		|	СУММА(БюджетРасходов.Сумма) КАК Сумма
		|ИЗ
		|	Справочник.СтатьиЗатрат КАК СЗ
		|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		|			БюджетРасходов.Период КАК Период,
		|			БюджетРасходов.Регистратор КАК Регистратор,
		|			БюджетРасходов.НомерСтроки КАК НомерСтроки,
		|			БюджетРасходов.Месяц КАК месяц,
		|			БюджетРасходов.Активность КАК Активность,
		|			БюджетРасходов.Статья КАК Статья,
		|			БюджетРасходов.Подразделение КАК Подразделение,
		|			БюджетРасходов.Состояние КАК Состояние,
		|			БюджетРасходов.Сумма КАК Сумма
		|		ИЗ
		|			РегистрСведений.БюджетРасходов КАК БюджетРасходов
		|		ГДЕ
		|			БюджетРасходов.Регистратор.Дата МЕЖДУ &датанач И &датакон) КАК БюджетРасходов
		|		ПО СЗ.Ссылка = БюджетРасходов.Статья
		|ГДЕ
		|	НЕ СЗ.Ссылка.ПометкаУдаления
		|	И НЕ СЗ.ЭтоГруппа И СЗ.Ответственный=&Ответственный
		|
		|СГРУППИРОВАТЬ ПО
		|	СЗ.Ответственный,
		|	СЗ.Ссылка,
		|	БюджетРасходов.месяц,
		|	БюджетРасходов.Подразделение,
		|	БюджетРасходов.Состояние");
	Иначе 
		Запрос = Новый Запрос("ВЫБРАТЬ
		                      |	СЗ.Ответственный КАК Ответственный,
		                      |	СЗ.Ссылка КАК Статья,
		                      |	БюджетРасходов.Состояние КАК Состояние,
		                      |	СУММА(ВЫБОР
		                      |			КОГДА БюджетРасходов.Подразделение = &Головное
		                      |				ТОГДА БюджетРасходов.Сумма
		                      |			ИНАЧЕ 0
		                      |		КОНЕЦ) КАК ГоловноеСумма,
		                      |	СУММА(ВЫБОР
		                      |			КОГДА БюджетРасходов.Подразделение = &СПБ
		                      |				ТОГДА БюджетРасходов.Сумма
		                      |			ИНАЧЕ 0
		                      |		КОНЕЦ) КАК СПБСумма,
		                      |	СУММА(ВЫБОР
		                      |			КОГДА БюджетРасходов.Подразделение = &Москва
		                      |				ТОГДА БюджетРасходов.Сумма
		                      |			ИНАЧЕ 0
		                      |		КОНЕЦ) КАК МоскваСумма,
		                      |	СУММА(ВЫБОР
		                      |			КОГДА БюджетРасходов.Подразделение = &РНД
		                      |				ТОГДА БюджетРасходов.Сумма
		                      |			ИНАЧЕ 0
		                      |		КОНЕЦ) КАК РНДСумма,
		                      |	СУММА(ВЫБОР
		                      |			КОГДА БюджетРасходов.Подразделение = &ЕКБ
		                      |				ТОГДА БюджетРасходов.Сумма
		                      |			ИНАЧЕ 0
		                      |		КОНЕЦ) КАК ЕКБСумма,
		                      |	СУММА(БюджетРасходов.Сумма) КАК ОбщСумма
		                      |ИЗ
		                      |	Справочник.СтатьиЗатрат КАК СЗ
		                      |		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		                      |			БюджетРасходов.Период КАК Период,
		                      |			БюджетРасходов.Регистратор КАК Регистратор,
		                      |			БюджетРасходов.НомерСтроки КАК НомерСтроки,
		                      |			БюджетРасходов.Месяц КАК месяц,
		                      |			БюджетРасходов.Активность КАК Активность,
		                      |			БюджетРасходов.Статья КАК Статья,
		                      |			БюджетРасходов.Подразделение КАК Подразделение,
		                      |			БюджетРасходов.Состояние КАК Состояние,
		                      |			БюджетРасходов.Сумма КАК Сумма
		                      |		ИЗ
		                      |			РегистрСведений.БюджетРасходовМесячный КАК БюджетРасходов
		                      |		ГДЕ
		                      |			БюджетРасходов.Регистратор.Дата МЕЖДУ &датанач И &датакон
		                      |			И БюджетРасходов.Месяц = &месяц) КАК БюджетРасходов
		                      |		ПО СЗ.Ссылка = БюджетРасходов.Статья
		                      |ГДЕ
		                      |	НЕ СЗ.Ссылка.ПометкаУдаления
		                      |	И НЕ СЗ.ЭтоГруппа
		                      |	И БюджетРасходов.Сумма <> 0
		                      |	И СЗ.Ответственный = &Ответственный
		                      |
		                      |СГРУППИРОВАТЬ ПО
		                      |	СЗ.Ответственный,
		                      |	СЗ.Ссылка,
		                      |	БюджетРасходов.Состояние
		                      |
		                      |УПОРЯДОЧИТЬ ПО
		                      |	СЗ.Ссылка.Наименование");		
	КонецЕсли;
	
	Если (Полугодие=1) Тогда 
		НачПериода = НачалоГода(Дата(Формат(Год(ТекущаяДата()),"ЧГ=0")+"0101000000"));
		КонПериода = КонецМесяца(ДобавитьМесяц(НачПериода,5));
	Иначе 
		КонПериода = КонецГода(Дата(Формат(Год(ТекущаяДата()),"ЧГ=0")+"0101000000"));
		НачПериода = НачалоМесяца(ДобавитьМесяц(КонПериода,-6));
	КонецЕсли;	
	
	ЭлементыФормы.ТабличныйДокумент.Очистить();

	//Подразделения.Добавить(Справочники.Подразделения.НайтиПоКоду("00005"));
	//Подразделения.Добавить(Справочники.Подразделения.НайтиПоКоду("00133"));
	//Подразделения.Добавить(Справочники.Подразделения.НайтиПоКоду("00112"));
	//Подразделения.Добавить(Справочники.Подразделения.НайтиПоКоду("00138"));
	//Подразделения.Добавить(Справочники.Подразделения.НайтиПоКоду("00106"));
	
	Запрос.Параметры.Вставить("датакон", КонПериода);
	Запрос.Параметры.Вставить("датанач", НачПериода);
	Запрос.Параметры.Вставить("Головное",Справочники.Подразделения.НайтиПоКоду("00005"));
	Запрос.Параметры.Вставить("СПБ",Справочники.Подразделения.НайтиПоКоду("00112"));
	Запрос.Параметры.Вставить("Москва",Справочники.Подразделения.НайтиПоКоду("00133"));
	Запрос.Параметры.Вставить("РНД",Справочники.Подразделения.НайтиПоКоду("00106"));
	Запрос.Параметры.Вставить("ЕКБ",Справочники.Подразделения.НайтиПоКоду("00138"));
	Запрос.Параметры.Вставить("месяц",МесяцДляВывода);
	Запрос.Параметры.Вставить("Ответственный",глТекущийПользователь);
	
	Выб = Запрос.Выполнить().Выгрузить();

	ИтогоГоловное	=0;
	ИтогоМосква		=0;
	ИтогоСПБ		=0;
	ИтогоЕКБ		=0;
	ИтогоРНД		=0;
	// Выводим 
	
	Если (Месячный=1) Тогда 
		Макет = Документы.БюджетРасходов.ПолучитьМакет("Бюджет");
		Шапка = Макет.ПолучитьОбласть("ШапкаМесяц");
		Строка = Макет.ПолучитьОбласть("СтрокаМесяц");
		Подвал = Макет.ПолучитьОбласть("ПодвалМесяц");
		Шапка.Параметры.ДатаНач = Формат(НачПериода,"ДЛФ=Д");
		Шапка.Параметры.ДатаКон = Формат(КонПериода,"ДЛФ=Д");	
		ЭлементыФормы.ТабличныйДокумент.Вывести(Шапка);	
		
		Для каждого Стрх из Выб Цикл
			Строка.Параметры.Статья 	= СтрХ.Статья;						
			Строка.Параметры.Головное 	= СтрХ.ГоловноеСумма;						
			Строка.Параметры.Москва 	= СтрХ.МоскваСумма;						
			Строка.Параметры.спб 		= СтрХ.СПБСумма;						
			Строка.Параметры.екб 		= СтрХ.ЕКБСумма;						
			Строка.Параметры.рнд 		= СтрХ.РНДСумма;
			Строка.Параметры.Итого 		= СтрХ.ГоловноеСумма +СтрХ.СПБСумма + СтрХ.МоскваСумма +СтрХ.ЕКБСумма + СтрХ.РНДСумма;
			
			ИтогоГоловное 	= ИтогоГоловное + СтрХ.ГоловноеСумма;
			ИтогоМосква 	= ИтогоМосква + СтрХ.МоскваСумма;
			ИтогоСПБ 		= ИтогоСПБ + СтрХ.СПБСумма;
			ИтогоРНД 		= ИтогоРНД + СтрХ.РНДСумма;
			ИтогоЕКБ 		= ИтогоЕКБ + СтрХ.ЕКБСумма;
			
			ЭлементыФормы.ТабличныйДокумент.Вывести(Строка);	
		КонецЦикла;
		
		Подвал.Параметры.Москва = ИтогоМосква;
		Подвал.Параметры.Головное = ИтогоГоловное;
		Подвал.Параметры.спб = Итогоспб;
		Подвал.Параметры.екб = Итогоекб;
		Подвал.Параметры.рнд = Итогорнд;
		Подвал.Параметры.итого = ИтогоМосква+ИтогоГоловное+Итогоспб+Итогоекб+Итогорнд;
		ЭлементыФормы.ТабличныйДокумент.Вывести(Подвал);	
	Иначе 
			
	КонецЕсли;
	
	ЭлементыФормы.ТабличныйДокумент.Показать();
	
КонецПроцедуры

Процедура МесяцНажатие(Элемент)
	// Вставить содержимое обработчика.
	Месяцы = Новый СписокЗначений;
	Если Полугодие=1 Тогда 
		Месяцы.Очистить();
		Месяцы.Добавить("Январь");
		Месяцы.Добавить("Февраль");
		Месяцы.Добавить("Март");
		Месяцы.Добавить("Апрель");
		Месяцы.Добавить("Май");
		Месяцы.Добавить("Июнь");		
	Иначе
		Месяцы.Очистить();
		Месяцы.Добавить("Июль");
		Месяцы.Добавить("Август");
		Месяцы.Добавить("Сентябрь");
		Месяцы.Добавить("Октябрь");
		Месяцы.Добавить("Ноябрь");
		Месяцы.Добавить("Декабрь");				
	КонецЕсли;    
	МесяцВ= ВыбратьИзСписка(Месяцы,Элемент);					
	Если не (Строка(ТипЗнч(МесяцВ))=("Элемент списка значений")) Тогда 
		МесяцВ=Месяцы[0];
	КонецЕсли;
	
	Если (МесяцВ.Значение = "Январь") или (МесяцВ.Значение = "Июль") Тогда
		МесяцДляВывода= 1;
	ИначеЕсли (МесяцВ.Значение = "Февраль") или (МесяцВ.Значение = "Август") Тогда
		МесяцДляВывода= 2;
	ИначеЕсли (МесяцВ.Значение = "Март") или (МесяцВ.Значение = "Сентябрь") Тогда
		МесяцДляВывода= 3;
	ИначеЕсли (МесяцВ.Значение = "Апрель") или (МесяцВ.Значение = "Октябрь") Тогда
		МесяцДляВывода= 4;
	ИначеЕсли (МесяцВ.Значение = "Май") или (МесяцВ.Значение = "Ноябрь") Тогда
		МесяцДляВывода= 5;
	Иначе
		МесяцДляВывода= 6;			
	КонецЕсли;
	ЭлементыФормы.Месяц.Заголовок = МесяцВ;
	
КонецПроцедуры
