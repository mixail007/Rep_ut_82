// Настройка периода
Перем НП Экспорт;

Процедура ПриОткрытии()
	
	Если НЕ ЭтоНовый() Тогда
		
		УстановитьЭлементыИсторииКнопка(Ссылка, ЭтаФорма);
		
	Иначе
		Статус = Перечисления.СтатусыЗаказовПоПрессформам.Новый;
	КонецЕсли; 
	
	
КонецПроцедуры

Процедура ВыводИстории(Элемент)
	
	ВывестиИсторию(Ссылка, ЭтаФорма);
	
КонецПроцедуры

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	Если Ответственный <> глТекущийПользователь Тогда
		Ответственный = глТекущийПользователь; 
	КонецЕсли;
	СуммаДокумента=ПрессФормы.Итог("Сумма");
КонецПроцедуры

//Орлов ++

// Процедура - обработчик нажатия кнопки настройки периода
//
Процедура КнопкаНастройкаПериодаНажатие(Элемент)
	
	Если НП.Редактировать() Тогда
		
		ДатаНачала = НП.ПолучитьДатуНачала();
		ДатаКонца  = НП.ПолучитьДатуОкончания();
		
	КонецЕсли;
	
КонецПроцедуры // КнопкаНастройкаПериодаНажатие()

Процедура ДействияФормыПоступленияПоЗаказу(Кнопка)
	
	ТЗПрессформ    = Новый ТаблицаЗначений; 
	ТЗПрессформ.Колонки.Добавить("Прессформа",Новый ОписаниеТипов("Строка",,Новый КвалификаторыСтроки(100)));
	
	
	//второе наименование
	Для Каждого СтрокаПрессформы Из ПрессФормы Цикл
		
		НаименованиеПрессформы = СтрокаПрессформы.ПрессФорма.ВтороеНаименование;
		Если Найти(НаименованиеПрессформы, ",") = 0 Тогда //одна прессформа
			НоваяСтрока = ТЗПрессформ.Добавить();
			//++20130123
			Если ВРег(Сред(НаименованиеПрессформы, 1, 3)) = "LA " Тогда
				ДлинаНаименования = СтрДлина(НаименованиеПрессформы);
				НаименованиеПрессформы = Прав(НаименованиеПрессформы, ДлинаНаименования - 3); 
			КонецЕсли;
			//--20130123
			НоваяСтрока.Прессформа = НаименованиеПрессформы;
		Иначе //несколько прессформ
			МассивСтрокПробел = РазложитьСтрокуВМассивПодстрок(НаименованиеПрессформы, " ");
			КолМассивСтрок = МассивСтрокПробел.Количество();
			//++13.08.2013
			МассивРадиусаИШирины = РазложитьСтрокуВМассивПодстрок(Строка(МассивСтрокПробел[КолМассивСтрок-1]), "x");
			//--13.08.2013
			ШиринаДиска = Строка(МассивРадиусаИШирины[0]);
			Радиус = Строка(МассивРадиусаИШирины[1]);
			
			МассивСтрокЗапятая = РазложитьСтрокуВМассивПодстрок(НаименованиеПрессформы, ",");
			КолМассивСтрокЗапятая = МассивСтрокЗапятая.Количество();
			
			Флаг = 0;
			
			Для Каждого СтрокаМассива Из МассивСтрокЗапятая Цикл
				//++20130123
				Если ВРег(Сред(СтрокаМассива, 1, 3)) = "LA " Тогда
					ДлинаНаименования = СтрДлина(СтрокаМассива);
					СтрокаМассива = Прав(СтрокаМассива, ДлинаНаименования - 3); 
				КонецЕсли;
				//--20130123
				Флаг = Флаг + 1;
				НоваяСтрока = ТЗПрессформ.Добавить();
				Если Флаг <> КолМассивСтрокЗапятая Тогда
					НоваяСтрока.Прессформа = СтрокаМассива+" "+ШиринаДиска+"x"+Радиус; 
				Иначе
					НоваяСтрока.Прессформа = СтрокаМассива;
				КонецЕсли;
				
			КонецЦикла;
		КонецЕсли;
		
	КонецЦикла;
	
	//первое наименование
	Для Каждого СтрокаПрессформы Из ПрессФормы Цикл
		
		НаименованиеПрессформы = СтрокаПрессформы.ПрессФорма.Наименование;
		Если Найти(НаименованиеПрессформы, ",") = 0 Тогда //одна прессформа
			НоваяСтрока = ТЗПрессформ.Добавить();
			//++20130123
			Если ВРег(Сред(НаименованиеПрессформы, 1, 3)) = "LA " Тогда
				ДлинаНаименования = СтрДлина(НаименованиеПрессформы);
				НаименованиеПрессформы = Прав(НаименованиеПрессформы, ДлинаНаименования - 3); 
			КонецЕсли;
			//--20130123
			НоваяСтрока.Прессформа = НаименованиеПрессформы;
		Иначе //несколько прессформ
			МассивСтрокПробел = РазложитьСтрокуВМассивПодстрок(НаименованиеПрессформы, " ");
			КолМассивСтрок = МассивСтрокПробел.Количество();

			ШиринаДиска = Строка(МассивСтрокПробел[3]);
			Радиус = Строка(МассивСтрокПробел[2]);
			
			МассивСтрокЗапятая = РазложитьСтрокуВМассивПодстрок(НаименованиеПрессформы, ",");
			КолМассивСтрокЗапятая = МассивСтрокЗапятая.Количество();
			
			Флаг = 0;
			
			Для Каждого СтрокаМассива Из МассивСтрокЗапятая Цикл
				//++20130123
				Если ВРег(Сред(СтрокаМассива, 1, 3)) = "LA " Тогда
					ДлинаНаименования = СтрДлина(СтрокаМассива);
					СтрокаМассива = Прав(СтрокаМассива, ДлинаНаименования - 3); 
				КонецЕсли;
				//--20130123
				Флаг = Флаг + 1;
				НоваяСтрока = ТЗПрессформ.Добавить();
				Если Флаг <> КолМассивСтрокЗапятая Тогда
					НоваяСтрока.Прессформа = СтрокаМассива+" "+Радиус+" "+ШиринаДиска; 
				Иначе
					НоваяСтрока.Прессформа = СтрокаМассива;
				КонецЕсли;
				
			КонецЦикла;
		КонецЕсли;
		
	КонецЦикла;
	//Смирнов сопоставляем в запросе
	Запрос = новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	""%"" + ПрессФормы.ПрессФорма + ""%"" КАК ПрессФорма
	|ПОМЕСТИТЬ втПрессФормы
	|ИЗ
	|	&ПрессФормы КАК ПрессФормы
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Номенклатура.Ссылка КАК Ссылка,
	|	Номенклатура.Наименование КАК Наименование
	|ПОМЕСТИТЬ втДиски
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|ГДЕ
	|	Номенклатура.ВидТовара = ЗНАЧЕНИЕ(Перечисление.ВидыТоваров.Диски)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	втПрессФормы.ПрессФорма,
	|	втДиски.Ссылка КАК Номенклатура
	|ПОМЕСТИТЬ втОснова
	|ИЗ
	|	втДиски КАК втДиски
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ втПрессФормы КАК втПрессФормы
	|		ПО (втДиски.Наименование ПОДОБНО втПрессФормы.ПрессФорма)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗакупкиОбороты.Номенклатура,
	|	СУММА(ЗакупкиОбороты.КоличествоОборот) КАК КоличествоОборот
	|ИЗ
	|	РегистрНакопления.Закупки.Обороты(
	|			&ДатаНачала,";
	Если ДатаКонца = Дата("00010101000000") Тогда
		Запрос.Текст = Запрос.Текст +
		"
		|			,";
	Иначе
		Запрос.Текст = Запрос.Текст + 
		"
		|			&ДатаКонца,";	
	КонецЕсли;
	
	Запрос.Текст = Запрос.Текст +
	"
	|			Регистратор,
	|			ДокументЗакупки ССЫЛКА Документ.ПоступлениеТоваровУслуг
	|			 И Номенклатура В
	|					(ВЫБРАТЬ
	|						втОснова.Номенклатура
	|					ИЗ
	|						втОснова КАК втОснова)) КАК ЗакупкиОбороты
	|
	|СГРУППИРОВАТЬ ПО
	|	ЗакупкиОбороты.Номенклатура";
	
	Запрос.УстановитьПараметр("ДатаНачала",НачалоДня(ДатаНачала));
	Запрос.УстановитьПараметр("ДатаКонца",КонецДня(ДатаКонца)+1);
	Запрос.УстановитьПараметр("ГруппаДиски", Справочники.Номенклатура.НайтиПоКоду("0001752"));
	Запрос.УстановитьПараметр("ПрессФормы", ТЗПрессформ);
	
	Рез=Запрос.Выполнить();
	ТЗНоменклатуры=Рез.Выгрузить();
	
	Если ТЗНоменклатуры.Количество() > 0  Тогда
		ТабДокумент = Новый ТабличныйДокумент;
		Макет = ПолучитьМакет("Макет");
		
		ОбластьМакетаШапка  = Макет.ПолучитьОбласть("Шапка");
		ОбластьМакетаСтрока = Макет.ПолучитьОбласть("Строка");
		ОбластьМакетаИтого  = Макет.ПолучитьОбласть("Итого");
		
		Итого = 0;
		НомерСтроки = 0;
		
		ОбластьМакетаШапка.Параметры.ДатаНачала = Формат(ДатаНачала, "ДФ=dd.MM.yyyy");
		Если ДатаКонца <> Дата("00010101000000") Тогда
		ОбластьМакетаШапка.Параметры.ДатаКонца = "по "+Формат(ДатаКонца, "ДФ=dd.MM.yyyy");
	КонецЕсли;
		ТабДокумент.Вывести(ОбластьМакетаШапка);
		
		Для Каждого Номенклатура Из ТЗНоменклатуры Цикл
								НомерСтроки = НомерСтроки + 1;
					ОбластьМакетаСтрока.Параметры.Номер = НомерСтроки; 
					ОбластьМакетаСтрока.Параметры.Номенклатура = Номенклатура.Номенклатура;
					ОбластьМакетаСтрока.Параметры.Количество = Номенклатура.КоличествоОборот;
					ТабДокумент.Вывести(ОбластьМакетаСтрока);				
					Итого = Итого + Номенклатура.КоличествоОборот;
		КонецЦикла;
		
		ОбластьМакетаИтого.Параметры.КоличествоИтого = Итого;
		ТабДокумент.Вывести(ОбластьМакетаИтого);
		
		ТабДокумент.Показать();	
	Иначе
		Если ТЗНоменклатуры.Количество() = 0 Тогда
			Сообщить("Нет поступлений по прессформам за выбранный период!");
		КонецЕсли;
		
		Если ТЗПрессформ.Количество() = 0 Тогда
			Сообщить("Не заполнены прессформы в заказе!");
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ДатаНачалаПриИзменении(Элемент)
	НП.ДатаНачала = НачалоДня(ДатаНачала);
КонецПроцедуры

Процедура ДатаКонцаПриИзменении(Элемент)
	НП.ДатаОкончания = КонецДня(ДатаКонца);
КонецПроцедуры

Процедура ДоговорКонтрагентаПриИзменении(Элемент)
	ВалютаДокумента=ДоговорКонтрагента.ВалютаВзаиморасчетов;
КонецПроцедуры

Процедура КоманднаяПанель1Действие9(Кнопка)
	Для каждого СтрПрессФорма из прессФормы цикл
		Диаметр=СтрПрессФорма.ПрессФорма.Радиус;
		стр=Диаметры.Найти(Диаметр,"Диаметр");
		Если Стр<>Неопределено тогда
			СтрПрессФорма.Сумма=стр.Стоимость;
		КонецЕсли;	
	КонецЦикла;	
КонецПроцедуры

Процедура ДиаметрыКоличествоЗачетаПриИзменении(Элемент)
	ОбщееЧислоДисковДляЗачета=Диаметры.Итог("КоличествоЗачета");
КонецПроцедуры

Процедура ДиаметрыПослеУдаления(Элемент)
	ОбщееЧислоДисковДляЗачета=Диаметры.Итог("КоличествоЗачета");
КонецПроцедуры

Процедура ДиаметрыПриОкончанииРедактирования(Элемент, НоваяСтрока, ОтменаРедактирования)
	ПересчитатьКоличествоДисковДляЗачета();
КонецПроцедуры

Процедура ПрессФормыПриОкончанииРедактирования(Элемент, НоваяСтрока, ОтменаРедактирования)
	Диаметр=Элемент.ТекущаяСтрока.ПрессФорма.Радиус;
	стр=Диаметры.Найти(Диаметр,"Диаметр");
	Если стр<>неопределено тогда
		Элемент.ТекущаяСтрока.Сумма=стр.Стоимость;
	КонецЕсли;
	ПересчитатьКоличествоДисковДляЗачета();
КонецПроцедуры

Процедура ПересчитатьКоличествоДисковДляЗачета()
	ДисковДляЗачета=0;
	тзРазмеров=Новый ТаблицаЗначений();
	тзРазмеров.Колонки.Добавить("Размер");
	тзРазмеров.Колонки.Добавить("Количество");
	Для Каждого строкаПФ из ПрессФормы цикл
		нстр=тзРазмеров.Добавить();
		Размер=строкаПФ.ПрессФорма.Радиус;
		нстр.Размер=Размер;
		нстр.Количество=1;
	КонецЦикла;
	
	тзРазмеров.Свернуть("Размер","Количество");
	
	Для каждого строкаДиаметры из Диаметры цикл
		ДляЗачетаПоДиаметру=0;
		стр=тзРазмеров.Найти(СтрокаДиаметры.Диаметр,"Размер");
		если стр<>неопределено тогда
			ДляЗачетаПоДиаметру=стр.Количество*строкаДиаметры.КоличествоЗачета;
		КонецЕсли;
		ДисковДляЗачета=ДисковДляЗачета+ДляЗачетаПоДиаметру;
	КонецЦикла;
	ОбщееЧислоДисковДляЗачета= ДисковДляЗачета;
КонецПроцедуры	
//Орлов --

////////////////////////////////////////////////////////////////////////////////
// ОПЕРАТОРЫ ОСНОВНОЙ ПРОГРАММЫ
// 

НП = Новый НастройкаПериода;