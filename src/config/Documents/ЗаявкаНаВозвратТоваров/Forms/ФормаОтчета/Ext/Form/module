
Процедура ПриОткрытии()
	Дата = ТекущаяДата();
	ТолькоСобственныеЗаявки = Истина;
	Сформировать();
КонецПроцедуры

Процедура Сформировать();
    ТабДок = Новый ТабличныйДокумент;
	ТабДок.ОтображатьСетку = Ложь;
	ТабДок.ТолькоПросмотр = Истина;
	Макет = Документы.ЗаявкаНаВозвратТоваров.ПолучитьМакет("МакетРеестр");	
	ОбластьЗаголовок = Макет.ПолучитьОбласть("Заголовок");
	ОбластьШапкаТаблицы = Макет.ПолучитьОбласть("ШапкаТаблицы");
	ОбластьСтрокаТаблицы = Макет.ПолучитьОбласть("СтрокаТаблицы");
	
	ОбластьЗаголовок.Параметры.Менеджер = глТекущийПользователь;
	ТабДок.Вывести(ОбластьЗаголовок);
	ТабДок.Вывести(ОбластьШапкаТаблицы);
	
	//ОбластьСтарые = Макет.ПолучитьОбласть("Старые");
	//ОбластьСегодня = Макет.ПолучитьОбласть("Сегодня");

	
	Запрос=новый Запрос;
	Запрос.Текст="ВЫБРАТЬ
	             |	ЗаявкаНаВозвратТоваровТовары.Номенклатура,
	             |	ЗаявкаНаВозвратТоваровТовары.Реализация,
	             |	ЗаявкаНаВозвратТоваровТовары.Ссылка,
	             |	СУММА(ЗаявкаНаВозвратТоваровТовары.Количество) КАК Количество
	             |ПОМЕСТИТЬ втЗаявка
	             |ИЗ
	             |	Документ.ЗаявкаНаВозвратТоваров.Товары КАК ЗаявкаНаВозвратТоваровТовары
	             |ГДЕ
				 //|	ЗаявкаНаВозвратТоваровТовары.Ссылка В(&СписЗаказовНаВозврат)
	             |	ЗаявкаНаВозвратТоваровТовары.Ссылка.Дата >= &НачПер
	             |	И ЗаявкаНаВозвратТоваровТовары.Ссылка.Дата <= &КонПер
				 |	И ЗаявкаНаВозвратТоваровТовары.Ссылка.Ответственный = &Пользователь
	             |
	             |СГРУППИРОВАТЬ ПО
	             |	ЗаявкаНаВозвратТоваровТовары.Номенклатура,
	             |	ЗаявкаНаВозвратТоваровТовары.Реализация,
	             |	ЗаявкаНаВозвратТоваровТовары.Ссылка
	             |;
	             |
	             |////////////////////////////////////////////////////////////////////////////////
	             |ВЫБРАТЬ
	             |	ПродажиОбороты.ДокументПродажи,
	             |	ПродажиОбороты.Номенклатура,
	             |	СУММА(ПродажиОбороты.КоличествоОборот) КАК КоличествоОборот,
	             |	ПродажиОбороты.Регистратор.ЗаявкаОснование
	             |ПОМЕСТИТЬ втВозвраты
	             |ИЗ
	             |	РегистрНакопления.Продажи.Обороты(
	             |			&НачВозврата,
	             |			,
	             |			Регистратор,
	             |			ДокументПродажи В
	             |					(ВЫБРАТЬ РАЗЛИЧНЫЕ
	             |						втЗаявка.Реализация
	             |					ИЗ
	             |						втЗаявка КАК втЗаявка)
	             |				И Номенклатура В
	             |					(ВЫБРАТЬ РАЗЛИЧНЫЕ
	             |						втЗаявка.Номенклатура
	             |					ИЗ
	             |						втЗаявка КАК втЗаявка)) КАК ПродажиОбороты
	             |ГДЕ
	             |	ПродажиОбороты.КоличествоОборот < 0
	             |	И ПродажиОбороты.Регистратор ССЫЛКА Документ.ВозвратТоваровОтПокупателя
	             |
	             |СГРУППИРОВАТЬ ПО
	             |	ПродажиОбороты.Номенклатура,
	             |	ПродажиОбороты.ДокументПродажи,
	             |	ПродажиОбороты.Регистратор.ЗаявкаОснование
	             |;
	             |
	             |////////////////////////////////////////////////////////////////////////////////
	             |ВЫБРАТЬ
	             |	ТоварыНаОтветственномХраненииОбороты.Номенклатура,
	             |	СУММА(ТоварыНаОтветственномХраненииОбороты.КоличествоОборот) КАК КоличествоОборот,
	             |	ТоварыНаОтветственномХраненииОбороты.Регистратор.ДокументОснование,
	             |	МАКСИМУМ(ТоварыНаОтветственномХраненииОбороты.Регистратор.Дата) КАК РегистраторДата
	             |ПОМЕСТИТЬ втОТХ
	             |ИЗ
	             |	РегистрНакопления.ТоварыНаОтветственномХранении.Обороты(
	             |			&НачВозврата,
	             |			,
	             |			Регистратор,
	             |			Номенклатура В
	             |				(ВЫБРАТЬ РАЗЛИЧНЫЕ
	             |					втЗаявка.Номенклатура
	             |				ИЗ
	             |					втЗаявка КАК втЗаявка)) КАК ТоварыНаОтветственномХраненииОбороты
	             |
	             |СГРУППИРОВАТЬ ПО
	             |	ТоварыНаОтветственномХраненииОбороты.Номенклатура,
	             |	ТоварыНаОтветственномХраненииОбороты.Регистратор.ДокументОснование
	             |;
	             |
	             |////////////////////////////////////////////////////////////////////////////////
	             |ВЫБРАТЬ
	             |	втЗаявка.Ссылка КАК Ссылка,
	             |	втЗаявка.Реализация КАК Реализация,
	             |	втЗаявка.Номенклатура КАК Номенклатура,
	             |	втЗаявка.Количество + ЕСТЬNULL(втВозвраты.КоличествоОборот, 0) КАК ЕстьВозврат,
	             |	втЗаявка.Количество КАК Количество,
	             |	втОТХ.КоличествоОборот КАК КоличествоОТХ,
	             |	втОТХ.РегистраторДата
	             |ПОМЕСТИТЬ Врем
	             |ИЗ
	             |	втЗаявка КАК втЗаявка
	             |		ЛЕВОЕ СОЕДИНЕНИЕ втВозвраты КАК втВозвраты
	             |		ПО втЗаявка.Номенклатура = втВозвраты.Номенклатура
	             |			И втЗаявка.Реализация = втВозвраты.ДокументПродажи
	             |			И втЗаявка.Ссылка = втВозвраты.РегистраторЗаявкаОснование
	             |		ЛЕВОЕ СОЕДИНЕНИЕ втОТХ КАК втОТХ
	             |		ПО втЗаявка.Номенклатура = втОТХ.Номенклатура
	             |			И втЗаявка.Ссылка = втОТХ.РегистраторДокументОснование
	             |;
	             |
	             |////////////////////////////////////////////////////////////////////////////////
	             |ВЫБРАТЬ
	             |	Врем.Ссылка,
	             |	СУММА(Врем.ЕстьВозврат) КАК ЕстьВозврат,
	             |	СУММА(Врем.Количество) КАК Количество,
	             |	СУММА(ЕСТЬNULL(Врем.КоличествоОТХ, 0)) КАК КоличествоОТХ,
	             |	МАКСИМУМ(ЕСТЬNULL(Врем.РегистраторДата, ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0))) КАК ДатаОТХ
	             |ИЗ
	             |	Врем КАК Врем
	             |
	             |СГРУППИРОВАТЬ ПО
	             |	Врем.Ссылка
	             |
	             |УПОРЯДОЧИТЬ ПО
	             |	Врем.Ссылка.Дата
	             |АВТОУПОРЯДОЧИВАНИЕ";
				 
				 	 
				 Запрос.УстановитьПараметр("НачПер", ДобавитьМесяц(Дата,-1));
				 Запрос.УстановитьПараметр("КонПер", КонецДня(Дата));
				 Запрос.УстановитьПараметр("Пользователь", глТекущийПользователь);
				 
				 НачВозвр = ДобавитьМесяц( НачалоМесяца(Дата) , -2);  //возвраты могут быть раньше заявок... на 2 месяца не более
				 Запрос.УстановитьПараметр("НачВозврата", НачВозвр);
				 
		табл = Запрос.Выполнить().Выгрузить();
		
		//табл.Свернуть("Ссылка","ЕстьВозврат,Количество,КоличествоОТХ");	///// Плотников
		
		табл.Колонки.Добавить("Статус");
		
		для каждого стр1 из табл цикл
			Если стр1.Количество=0 тогда
				стр1.Статус = "9.Нет товаров в заявке!";
			ИначеЕсли стр1.ЕстьВозврат=стр1.Количество тогда // по количеству в заявке!
				стр1.Статус = "0.Нет возвратов";
			ИначеЕсли стр1.ЕстьВозврат=0 тогда // кол в заявке = кол. всех возвратов
				стр1.Статус = "1.Есть все возвраты";
			иначеЕсли стр1.ЕстьВозврат>0 тогда
				стр1.Статус = "2.Возвраты есть частично";
			иначеЕсли стр1.ЕстьВозврат<0 тогда
				стр1.Статус = "3.Возврат больше заявки";
			КонецЕсли;	
		КонецЦикла;
		
		Для Каждого стр из табл Цикл
			//Если стр.Статус <> "1.Есть все возвраты" Тогда
				ОбластьСтрокаТаблицы.Параметры.Заявка = строка(стр.ссылка);
				ОбластьСтрокаТаблицы.Параметры.Ответственный = стр.ссылка.ответственный;
				если стр.Статус = "1.Есть все возвраты" тогда
					ОбластьСтрокаТаблицы.Параметры.Статус = стр.Статус;  
				ИначеЕсли стр.статус = "2.Возвраты есть частично" тогда
					ОбластьСтрокаТаблицы.Параметры.Статус = стр.Статус; 
					//Строка.ЦветФона =WebЦвета.ГолубойСоСтальнымОттенком;  
				ИначеЕсли стр.статус = "3.Возврат больше заявки" тогда
					ОбластьСтрокаТаблицы.Параметры.Статус = стр.Статус; //малиновый 
				ИначеЕсли стр.КоличествоОТХ > 0 и ТекущаяДата()-стр.ДатаОТХ < 60*60*24*7 Тогда   //Плотников++++
					ОбластьСтрокаТаблицы.Параметры.Статус = "На ОТХ";
				ИначеЕсли стр.КоличествоОТХ > 0 и ТекущаяДата()-стр.ДатаОТХ >= 60*60*24*7 Тогда   //Плотников++++
					ОбластьСтрокаТаблицы.Параметры.Статус = "На ОТХ больше недели";
				ИначеЕсли стр.ссылка.Вработе и ТекущаяДата()-стр.ссылка.ДатаВРаботе > 60*60*24 Тогда
					ОбластьСтрокаТаблицы.Параметры.Статус = "В работе";
				Иначе
					//если хотябы 1 позиция согласованна - подсвечиваем
					ОбластьСтрокаТаблицы.Параметры.Статус = ""
				конецЕсли;

				
				ОбластьСтрокаТаблицы.Параметры.Подразделение = стр.ссылка.Подразделение;
				ОбластьСтрокаТаблицы.Параметры.Контрагент = стр.ссылка.Контрагент;
				ОбластьСтрокаТаблицы.Параметры.Комментарий = стр.ссылка.Комментарий;
				ОбластьСтрокаТаблицы.Параметры.КомментарийСклада = стр.ссылка.КомментарийСклада;
				ОбластьСтрокаТаблицы.Параметры.Причина =стр.ссылка.ПричинаВозврата;	
				ТабДок.Вывести(ОбластьСтрокаТаблицы);
			//КонецЕсли;
		КонецЦикла;
		
		ЭлементыФормы.ПолеТабличногоДокумента1.Очистить();
		ЭлементыФормы.ПолеТабличногоДокумента1.Вывести(ТабДок);

КонецПроцедуры

Процедура ДатаПриИзменении(Элемент)
	Сформировать();
КонецПроцедуры
