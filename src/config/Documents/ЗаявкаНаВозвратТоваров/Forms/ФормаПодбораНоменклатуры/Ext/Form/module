перем Флажок0;

Процедура ВыбПериодНажатие(Элемент)
	НастройкаПериода = Новый НастройкаПериода;
	НастройкаПериода.РедактироватьКакИнтервал = Истина;
	НастройкаПериода.РедактироватьКакПериод = Истина;
	НастройкаПериода.ВариантНастройки = ВариантНастройкиПериода.Период;
	НастройкаПериода.УстановитьПериод(НачПериода, ?(КонПериода='0001-01-01', КонПериода, КонецДня(КонПериода)));
	Если НастройкаПериода.Редактировать() Тогда
		НачПериода = НастройкаПериода.ПолучитьДатуНачала();
		КонПериода = НастройкаПериода.ПолучитьДатуОкончания();
	КонецЕсли;
КонецПроцедуры

Процедура ОсновныеДействияФормыДействие(Кнопка)
	Запрос=Новый Запрос;
	Запрос.Текст="";
	Если ТипЗнч(Реализация) = тип("ДокументСсылка.ОтчетОРозничныхПродажах") 
		или ТипЗнч(Реализация) = тип("ДокументСсылка.РеализацияТоваровУслуг") 
		или ТипЗнч(Реализация) = тип("ДокументСсылка.ПеремещениеТоваров") тогда   //09.08.2017
		ТчПодобранныеТовары = ПодборПоДокументу();
	Иначе
		ТЧПодобранныеТовары = ПодборПоРеквизитам();
	КонецЕсли;
	
	
	
	Продажи=ТЧПодобранныеТовары;
	ЭлементыФормы.Продажи.СоздатьКолонки();
	ЭлементыФормы.Продажи.Колонки.Добавить("фл","фл");
	Колонки = ЭлементыФормы.Продажи.Колонки;
	Индекс=Колонки.Индекс(Колонки["фл"]);
	ЭлементыФормы.Продажи.Колонки.Сдвинуть(Колонки["фл"],-Индекс);
	ЭлементыФормы.Продажи.Колонки.фл.РежимРедактирования=РежимРедактированияКолонки.Непосредственно;
	ЭлементыФормы.Продажи.Колонки.фл.ДанныеФлажка="флажок";
	ЭлементыФормы.Продажи.Колонки.флажок.Видимость=ложь;
	
	КолонкаРеализация = ЭлементыФормы.Продажи.Колонки.Найти("Реализация");
	КолонкаРеализация.ТекстШапки = "Документ";
	КолонкаСкладРеализации = ЭлементыФормы.Продажи.Колонки.Найти("СкладРеализации");
	КолонкаСкладРеализации.ТекстШапки = "Склад";
КонецПроцедуры

Процедура ОсновныеДействияФормыПеренести(Кнопка)
	ОповеститьОВыборе(Продажи);
КонецПроцедуры

Процедура РеализацияОкончаниеВводаТекста(Элемент, Текст, Значение, СтандартнаяОбработка)
	
	Если СтрДлина(Текст)>11 тогда
		
		стандартнаяОбработка = Ложь;
		Организация = Лев(Текст,2);
		ВидПФ= Сред(Текст,3,1);
		
		номерДок = глТранслитОбратно(Сред(Текст,4,8));
		дата =  Число(Сред(Текст,12,6));
		ДатаДок = Дата(Формат(Дата, "ЧЦ=6; ЧРГ=.; ЧВН=; ЧГ=2,2,0")+" 00:00:00");
		ДатаДок = ДобавитьМесяц(ДатаДок,12*2000);
		кодКонтрагента = глТранслитОбратно(Сред(Текст,18,7));
		Суммастр = Сред(Текст,25);
		попытка
			Рубли =   Число (Лев(Суммастр,СтрДлина(суммастр)-2)) ;
			копейки = Число (Прав(Суммастр,2));
			Сумма= Рубли+копейки/100;
		исключение
		конецпопытки;
		
		НайденныйДокумент = Неопределено;
		
		штрихКод = стрЗаменить(Текст, "НЫ","YS");
		штрихКод = стрЗаменить(штрихКод, "ОФЫРЕ","ЯШТ");
		Док = ПолучитьДокументПоШК( штрихКод );
		
		Если Организация <> "10"  Тогда
			Предупреждение("Документ не Яршинторга!");
			Реализация="";
			Этаформа.ТекущийЭлемент = Элементыформы.Реализация;
			возврат;
		конецЕсли;
		
		//если ВидПФ <>"6" и ВидПФ <>"7"  тогда
		//	Док = Документы.РеализацияТоваровУслуг.НайтиПоНомеру(номердок,ДатаДок );
		Если ЗначениеНеЗаполнено(Док) Тогда 
			Предупреждение("Документ с номером " + НомерДок + " не найден!");
		иначе
			Таб = Новый ТаблицаЗначений;
			таб.колонки.Добавить("Реализация");
			Таб.колонки.Добавить("Количество");
			Таб.колонки.Добавить("ЦенаРеализации");
			Таб.колонки.Добавить("Код");
			Таб.колонки.Добавить("Артикул");
			Таб.колонки.Добавить("Номенклатура");					
			Таб.колонки.Добавить("Склад");
			Таб.колонки.Добавить("Флажок");
			
			
			Для каждого стр из Док.Товары Цикл
				ст = Таб.Добавить();
				ст.реализация = Док;
				ст.Количество = стр.Количество;
				ст.ценаРеализации = стр.Цена;
				ст.Код = Стр.Номенклатура.Код;
				ст.Артикул = Стр.Номенклатура.Артикул;
				ст.номенклатура = стр.Номенклатура;
				ст.склад = стр.Склад;
				ст.флажок = Флажок0;   //Сразу включаем все строки!
			конецЦикла;
			
			Продажи=Таб;
			ЭлементыФормы.Продажи.СоздатьКолонки();
			ЭлементыФормы.Продажи.Колонки.Добавить("фл","фл");
			Колонки = ЭлементыФормы.Продажи.Колонки;
			Индекс=Колонки.Индекс(Колонки["фл"]);
			ЭлементыФормы.Продажи.Колонки.Сдвинуть(Колонки["фл"],-Индекс);
			ЭлементыФормы.Продажи.Колонки.фл.РежимРедактирования=РежимРедактированияКолонки.Непосредственно;
			ЭлементыФормы.Продажи.Колонки.фл.ДанныеФлажка="флажок";
			ЭлементыФормы.Продажи.Колонки.флажок.Видимость=ложь;
			
		конецЕсли;	
		//иначе
		//	Сообщить("Этот штрихкод не принадлежит реализации!");
		//конецЕсли;	
		
		
	КонецЕсли;
	
КонецПроцедуры

Функция ПодборПоРеквизитам()
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Флажок0", Флажок0);
	
	Если СокрЛП(НомерВхДокумента)<>"" Тогда 
		Запрос.Текст ="ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ЗаказПокупателяТовары.Номенклатура,
		|	ЗаказПокупателяТовары.Ссылка
		|ПОМЕСТИТЬ втНомИзЗаказаА
		|ИЗ
		|	Документ.ЗаказПокупателя.Товары КАК ЗаказПокупателяТовары
		|ГДЕ
		|	ЗаказПокупателяТовары.Ссылка.НомерВходящегоДокумента ПОДОБНО &НомерВходящегоДокумента
		|	И ЗаказПокупателяТовары.Ссылка.Контрагент = &Контрагент
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	втНомИзЗаказаА.Номенклатура,
		|	втНомИзЗаказаА.Ссылка,
		|	ЗаказПокупателяЗаказы.Ссылка КАК ЗаказПокупателя
		|ПОМЕСТИТЬ втНомИзЗаказа
		|ИЗ
		|	втНомИзЗаказаА КАК втНомИзЗаказаА
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказПокупателя.Заказы КАК ЗаказПокупателяЗаказы
		|		ПО втНомИзЗаказаА.Ссылка = ЗаказПокупателяЗаказы.ЗаказПокупателя
		|;
		|";
	КонецЕсли;
	Запрос.Текст=Запрос.Текст+"ВЫБРАТЬ
	|	РеализацияТоваровУслугТовары.Ссылка КАК Реализация,
	|	РеализацияТоваровУслугТовары.Количество,
	|	выбор когда ВЫразить(РеализацияТоваровУслугТовары.Ссылка.Сделка как Документ.ЗаказПокупателя).БонусПрименен = истина Тогда
	|   ВЫразить(РеализацияТоваровУслугТовары.Цена *(100-ВЫразить(РеализацияТоваровУслугТовары.Ссылка.Сделка как Документ.ЗаказПокупателя).ПроцентСкидкиНал)/100  как Число(15,0))
	|   иначе
	|   РеализацияТоваровУслугТовары.Цена конец КАК ЦенаРеализации ,
	|	РеализацияТоваровУслугТовары.Номенклатура.Код КАК Код,
	|	РеализацияТоваровУслугТовары.Номенклатура,
	|	РеализацияТоваровУслугТовары.Склад КАК СкладРеализации,
	|	РеализацияТоваровУслугТовары.Ссылка.Сделка КАК ЗаказПокупателя,
	|	РеализацияТоваровУслугТовары.Ссылка.Сделка.НомерВходящегоДОкумента КАК НомерЗаказаИМ,
	|	&Флажок0 КАК флажок
	|	ПОМЕСТИТЬ вт
	|ИЗ
	|	Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
	|ГДЕ
	|	РеализацияТоваровУслугТовары.Ссылка.Проведен = ИСТИНА
	|	И РеализацияТоваровУслугТовары.Ссылка.Дата МЕЖДУ &ДатаН И &ДатаК
	|	И РеализацияТоваровУслугТовары.Ссылка.Контрагент = &Контрагент
	|	И РеализацияТоваровУслугТовары.Ссылка.Подразделение = &Подразделение
	|    //ЗаменитьНомРеализация";
	Если СокрЛП(НомерВхДокумента)<>"" Тогда 
		Запрос.Текст=Запрос.Текст+"
		|И РеализацияТоваровУслугТовары.Номенклатура В
		|			(ВЫБРАТЬ
		|				втномИзЗаказа.Номенклатура
		|			ИЗ
		|				втНомИзЗаказа КАК втномИзЗаказа)
		| И (РеализацияТоваровУслугТовары.Ссылка.Сделка В
		|		(ВЫБРАТЬ
		|			втномИзЗаказа.Ссылка
		|		ИЗ
		|			втНомИзЗаказа КАК втномИзЗаказа)
		|	ИЛИ РеализацияТоваровУслугТовары.Ссылка.Сделка В
		|		(ВЫБРАТЬ
		|			втномИзЗаказа.ЗаказПокупателя
		|		ИЗ
		|			втНомИзЗаказа КАК втномИзЗаказа))";
	КонецЕсли;
	
	//10.06.2016 добавлена возможность подбора из отчета о розничных продажах
	Запрос.Текст=Запрос.Текст+"
	|
	|Объединить все
	|
	|ВЫБРАТЬ
	|	ОтчетОРозничныхПродажахТовары.Ссылка КАК Реализация,
	|	ОтчетОРозничныхПродажахТовары.Количество,
	|	ОтчетОРозничныхПродажахТовары.Цена КАК ЦенаРеализации,
	|	ОтчетОРозничныхПродажахТовары.Номенклатура.Код КАК Код,
	|	ОтчетОРозничныхПродажахТовары.Номенклатура,
	|	ОтчетОРозничныхПродажахТовары.Склад КАК СкладРеализации,
	|	ОтчетОРозничныхПродажахТовары.ДокументОснование КАК ЗаказПокупателя,
	|	ОтчетОРозничныхПродажахТовары.ДокументОснование.НомерВходящегоДокумента КАК НомерЗаказаИМ,
	|	&Флажок0 КАК флажок	
	|ИЗ
	|	Документ.ОтчетОРозничныхПродажах.Товары КАК ОтчетОРозничныхПродажахТовары
	|ГДЕ
	|	ОтчетОРозничныхПродажахТовары.Ссылка.Проведен = ИСТИНА
	|	И ОтчетОРозничныхПродажахТовары.Ссылка.Дата МЕЖДУ &ДатаН И &ДатаК
	|	И ОтчетОРозничныхПродажахТовары.Ссылка.Контрагент = &Контрагент
	|	И ОтчетОРозничныхПродажахТовары.Ссылка.Подразделение = &Подразделение
	|    //ЗаменитьНомОтчетРозПр";
	Если СокрЛП(НомерВхДокумента)<>"" Тогда 
		Запрос.Текст=Запрос.Текст+"
		|И ОтчетОРозничныхПродажахТовары.Номенклатура В
		|			(ВЫБРАТЬ
		|				втномИзЗаказа.Номенклатура
		|			ИЗ
		|				втНомИзЗаказа КАК втномИзЗаказа)
		| И (ОтчетОРозничныхПродажахТовары.ДокументОснование В
		|		(ВЫБРАТЬ
		|			втномИзЗаказа.Ссылка
		|		ИЗ
		|			втНомИзЗаказа КАК втномИзЗаказа)
		|	ИЛИ ОтчетОРозничныхПродажахТовары.ДокументОснование В
		|		(ВЫБРАТЬ
		|			втномИзЗаказа.ЗаказПокупателя
		|		ИЗ
		|			втНомИзЗаказа КАК втномИзЗаказа))";
	КонецЕсли;
	
	
	Запрос.Текст=Запрос.Текст+"
	|
	|Объединить все
	|
	|ВЫБРАТЬ
	|	ПеремещениеТоваровТовары.Ссылка КАК Реализация,
	|	ПеремещениеТоваровТовары.Количество,
	|	ПеремещениеТоваровТовары.Цена КАК ЦенаРеализации,
	|	ПеремещениеТоваровТовары.Номенклатура.Код КАК Код,
	|	ПеремещениеТоваровТовары.Номенклатура,
	|	ПеремещениеТоваровТовары.Склад КАК СкладРеализации,
	|	ПеремещениеТоваровТовары.Ссылка.ВнутреннийЗаказ.ДокументОснование КАК ЗаказПокупателя,
	|	ПеремещениеТоваровТовары.Ссылка.ВнутреннийЗаказ.ДокументОснование.НомерВходящегоДокумента КАК НомерЗаказаИМ,
	|	&Флажок0 КАК флажок	
	|ИЗ
	|	Документ.ПеремещениеТоваров.Товары КАК ПеремещениеТоваровТовары
	|ГДЕ
	|	ПеремещениеТоваровТовары.Ссылка.Проведен = ИСТИНА
	|	И ПеремещениеТоваровТовары.Ссылка.Дата МЕЖДУ &ДатаН И &ДатаК
	|	И ПеремещениеТоваровТовары.Ссылка.ВнутреннийЗаказ.ДокументОснование.Контрагент = &Контрагент
	|	И ПеремещениеТоваровТовары.Ссылка.Подразделение = &Подразделение
	|    //ЗаменитьНомПеремещениеТов";
	Если СокрЛП(НомерВхДокумента)<>"" Тогда 
		Запрос.Текст=Запрос.Текст+"
		|И ПеремещениеТоваровТовары.Номенклатура В
		|			(ВЫБРАТЬ
		|				втномИзЗаказа.Номенклатура
		|			ИЗ
		|				втНомИзЗаказа КАК втномИзЗаказа)
		| И (ПеремещениеТоваровТовары.Ссылка.ВнутреннийЗаказ.ДокументОснование В
		|		(ВЫБРАТЬ
		|			втномИзЗаказа.Ссылка
		|		ИЗ
		|			втНомИзЗаказа КАК втномИзЗаказа)
		|	ИЛИ ПеремещениеТоваровТовары.Ссылка.ВнутреннийЗаказ.ДокументОснование В
		|		(ВЫБРАТЬ
		|			втномИзЗаказа.ЗаказПокупателя
		|		ИЗ
		|			втНомИзЗаказа КАК втномИзЗаказа))";
	КонецЕсли;

	
	Если ЗначениеЗаполнено(Номенклатура) тогда
		Запрос.Текст=СтрЗаменить(Запрос.Текст,"//ЗаменитьНомРеализация","И РеализацияТоваровУслугТовары.Номенклатура = &Номенклатура");
	КонецЕсли;
	
	//10.06.2016 добавлена возможность подбора из отчета о розничных продажах
	Если ЗначениеЗаполнено(Номенклатура) тогда
		Запрос.Текст=СтрЗаменить(Запрос.Текст,"//ЗаменитьНомОтчетРозПр","И ОтчетОРозничныхПродажахТовары.Номенклатура = &Номенклатура");
	КонецЕсли;
	
	//07.11.2017 Ошибка в условии перемещения, был //ЗаменитьНомОтчетРозПр поменял на //ЗаменитьНомПеремещениеТов и добавил замену
	Если ЗначениеЗаполнено(Номенклатура) тогда
		Запрос.Текст=СтрЗаменить(Запрос.Текст,"//ЗаменитьНомПеремещениеТов","И ПеремещениеТоваровТовары.Номенклатура = &Номенклатура");
	КонецЕсли;
	
	Если Контрагент = Справочники.Контрагенты.ПустаяСсылка() тогда
		Запрос.Текст=СтрЗаменить(Запрос.Текст,"И ЗаказПокупателяТовары.Ссылка.Контрагент = &Контрагент","");
		Запрос.Текст=СтрЗаменить(Запрос.Текст,"И РеализацияТоваровУслугТовары.Ссылка.Контрагент = &Контрагент","");		
		Запрос.Текст=СтрЗаменить(Запрос.Текст,"И ОтчетОРозничныхПродажахТовары.Ссылка.Контрагент = &Контрагент","");
	КонецЕсли;
	
	Если Подразделение = Справочники.Подразделения.ПустаяСсылка() тогда
		Запрос.Текст=СтрЗаменить(Запрос.Текст,"И ОтчетОРозничныхПродажахТовары.Ссылка.Подразделение = &Подразделение","");
		Запрос.Текст=СтрЗаменить(Запрос.Текст,"И РеализацияТоваровУслугТовары.Ссылка.Подразделение = &Подразделение","");
	КонецЕсли;
	//19.06.17 Смирнов
	//цену берем из регистра продажи, что б учитывались корректировки
	Запрос.Текст=Запрос.Текст+"
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
|	вт.Реализация,
|	выразить(вт.Количество как число(15,0)) как Количество,
|	ЕСТЬNULL(ПродажиОбороты.КоличествоОборот, 0) КАК КоличествоОстаток,
|	ЕСТЬNULL(ВложенныйЗапрос.ЦенаПродажи, вт.ЦенаРеализации) КАК ЦенаРеализации,
|	вт.Код,
|	вт.Номенклатура,
|	вт.Номенклатура.Артикул КАК Артикул,
|	вт.СкладРеализации,
|	вт.ЗаказПокупателя,
|	вт.НомерЗаказаИМ,
|	выбор когда вт.Количество<=ЕСТЬNULL(ПродажиОбороты.КоличествоОборот, 0) тогда истина иначе ложь конец как флажок
|ИЗ
|	вт КАК вт
|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
|			ЦеныПродаж.ДокументПродажи КАК ДокументПродажи,
|			ЦеныПродаж.Номенклатура КАК Номенклатура,
|			ВЫБОР
|				КОГДА ЦеныПродаж.КоличествоОборот <> 0
|					ТОГДА ВЫБОР
|							КОГДА ВЫРАЗИТЬ(ЦеныПродаж.ДокументПродажи.Сделка КАК Документ.ЗаказПокупателя).БонусПрименен = ИСТИНА
|								ТОГДА ВЫРАЗИТЬ(ЦеныПродаж.СтоимостьОборот / ЦеныПродаж.КоличествоОборот * (100 - ВЫРАЗИТЬ(ЦеныПродаж.ДокументПродажи.Сделка КАК Документ.ЗаказПокупателя).ПроцентСкидкиНал) / 100 КАК ЧИСЛО(15, 0))
|							ИНАЧЕ ЦеныПродаж.СтоимостьОборот / ЦеныПродаж.КоличествоОборот
|						КОНЕЦ
|				ИНАЧЕ 0
|			КОНЕЦ КАК ЦенаПродажи,
|			ЦеныПродаж.КоличествоОборот КАК Количество
|		ИЗ
|			(ВЫБРАТЬ
|				ПродажиОбороты.ДокументПродажи КАК ДокументПродажи,
|				ПродажиОбороты.Номенклатура КАК Номенклатура,
|				СУММА(ПродажиОбороты.СтоимостьОборот) КАК СтоимостьОборот,
|				СУММА(ПродажиОбороты.КоличествоОборот) КАК КоличествоОборот
|			ИЗ
|				РегистрНакопления.Продажи.Обороты(
|						,
|						,
|						Регистратор,
|						ДокументПродажи В
|							(ВЫБРАТЬ
|								вт.Реализация
|							ИЗ
|								вт)) КАК ПродажиОбороты
|			ГДЕ
|				НЕ ПродажиОбороты.Регистратор ССЫЛКА Документ.ВозвратТоваровОтПокупателя
|			
|			СГРУППИРОВАТЬ ПО
|				ПродажиОбороты.ДокументПродажи,
|				ПродажиОбороты.Номенклатура) КАК ЦеныПродаж) КАК ВложенныйЗапрос
|		ПО вт.Реализация = ВложенныйЗапрос.ДокументПродажи
|			И вт.Номенклатура = ВложенныйЗапрос.Номенклатура
|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.Продажи.Обороты КАК ПродажиОбороты
|		ПО вт.ЗаказПокупателя = ПродажиОбороты.ЗаказПокупателя
|			И вт.Номенклатура = ПродажиОбороты.Номенклатура";
	Запрос.УстановитьПараметр("ДатаН",НачПериода);
	КонПер=?(КонПериода=Дата(1,1,1),ТекущаяДата(),КонецДня(КонПериода));
	Запрос.УстановитьПараметр("ДатаК",КонецДня(КонПер));
	Запрос.УстановитьПараметр("Контрагент",Контрагент);
	Запрос.УстановитьПараметр("Номенклатура",Номенклатура);
	Запрос.УстановитьПараметр("Подразделение",?(Подразделение=Справочники.Подразделения.ПустаяСсылка(),Справочники.Подразделения.НайтиПоКоду("00005"),Подразделение));
	Запрос.УстановитьПараметр("НомерВходящегоДокумента",НомерВхДокумента);  	
	
	Возврат Запрос.Выполнить().Выгрузить();
КонецФункции	

Функция ПодборПоДокументу()
	
	Запрос = Новый запрос;
	Запрос.УстановитьПараметр("Флажок0", Флажок0);
	Запрос.Текст ="ВЫБРАТЬ
	              |	&Ссылка КАК Реализация,
	              |	ЕСТЬNULL(ВложенныйЗапрос.Количество, ДокументТовары.Количество) КАК Количество,
	              |	ЕСТЬNULL(ВложенныйЗапрос.Цена, ДокументТовары.Цена) КАК ЦенаРеализации,
	              |	ДокументТовары.Номенклатура.Код КАК Код,
	              |	ДокументТовары.Номенклатура,
				  |	ДокументТовары.Номенклатура.Артикул как Артикул,
	              |	ДокументТовары.Склад КАК СкладРеализации,
	              |	ДокументТовары.ДокументОснование КАК ЗаказПокупателя,
	              |	ДокументТовары.ДокументОснование.НомерВходящегоДокумента КАК НомерЗаказаИМ,
	              |	&Флажок0 КАК флажок
	              |ИЗ
	              |	Документ.ОтчетОРозничныхПродажах.Товары КАК ДокументТовары
	              |		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	              |			А.ДокументПродажи КАК ДокументПродажи,
	              |			А.Номенклатура КАК Номенклатура,
	              |			ВЫБОР
	              |				КОГДА А.КоличествоОборот <> 0
	              |					ТОГДА ВЫБОР
	              |							КОГДА ВЫРАЗИТЬ(А.ДокументПродажи.Сделка КАК Документ.ЗаказПокупателя).БонусПрименен = ИСТИНА
	              |								ТОГДА ВЫРАЗИТЬ(А.СтоимостьОборот / А.КоличествоОборот * (100 - ВЫРАЗИТЬ(А.ДокументПродажи.Сделка КАК Документ.ЗаказПокупателя).ПроцентСкидкиНал) / 100 КАК ЧИСЛО(15, 0))
	              |							ИНАЧЕ А.СтоимостьОборот / А.КоличествоОборот
	              |						КОНЕЦ
	              |				ИНАЧЕ 0
	              |			КОНЕЦ КАК Цена,
	              |			А.КоличествоОборот КАК Количество
	              |		ИЗ
	              |			(ВЫБРАТЬ
	              |				ПродажиОбороты.ДокументПродажи КАК ДокументПродажи,
	              |				ПродажиОбороты.Номенклатура КАК Номенклатура,
	              |				СУММА(ПродажиОбороты.СтоимостьОборот) КАК СтоимостьОборот,
	              |				СУММА(ПродажиОбороты.КоличествоОборот) КАК КоличествоОборот
	              |			ИЗ
	              |				РегистрНакопления.Продажи.Обороты(, , Регистратор, ДокументПродажи = &Ссылка) КАК ПродажиОбороты
	              |			ГДЕ
	              |				НЕ ПродажиОбороты.Регистратор ССЫЛКА Документ.ВозвратТоваровОтПокупателя
	              |			
	              |			СГРУППИРОВАТЬ ПО
	              |				ПродажиОбороты.ДокументПродажи,
	              |				ПродажиОбороты.Номенклатура) КАК А) КАК ВложенныйЗапрос
	              |		ПО ДокументТовары.Ссылка = ВложенныйЗапрос.ДокументПродажи
	              |			И ДокументТовары.Номенклатура = ВложенныйЗапрос.Номенклатура
	              |ГДЕ
	              |	ДокументТовары.Ссылка = &Ссылка
	              |	//ЗаменитьНом";
	
	
	Если ТипЗнч(Реализация) = Тип("ДокументСсылка.РеализацияТоваровУслуг") Тогда   //заказ - это Сделка
		Запрос.Текст=СтрЗаменить(Запрос.Текст,"ОтчетОРозничныхПродажах","РеализацияТоваровУслуг");
		Запрос.Текст=СтрЗаменить(Запрос.Текст,"ДокументТовары.ДокументОснование.НомерВходящегоДокумента","ДокументТовары.Ссылка.Сделка.НомерВходящегоДокумента");
		Запрос.Текст=СтрЗаменить(Запрос.Текст,"ДокументТовары.ДокументОснование","ДокументТовары.Ссылка.Сделка");		
	ИначеЕсли ТипЗнч(Реализация) = Тип("ДокументСсылка.ПеремещениеТоваров") Тогда  //08.08.2017 - Заказ - это ДокументОснование через ВнутреннийЗаказ
		Запрос.Текст=СтрЗаменить(Запрос.Текст,"ОтчетОРозничныхПродажах","ПеремещениеТоваров");
		Запрос.Текст=СтрЗаменить(Запрос.Текст,"ДокументТовары.ДокументОснование.НомерВходящегоДокумента","ДокументТовары.Ссылка.ВнутреннийЗаказ.ДокументОснование.НомерВходящегоДокумента");
		Запрос.Текст=СтрЗаменить(Запрос.Текст,"ДокументТовары.ДокументОснование","ДокументТовары.Ссылка.ВнутреннийЗаказ.ДокументОснование");	
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Номенклатура) тогда
		Запрос.Текст=СтрЗаменить(Запрос.Текст,"//ЗаменитьНом","И ДокументТовары.Номенклатура = &Номенклатура")
	Иначе
		Запрос.Текст=СтрЗаменить(Запрос.Текст,"//ЗаменитьНом","");
	КонецЕсли;
	
	
	Запрос.УстановитьПараметр("Номенклатура",Номенклатура);
	Запрос.УстановитьПараметр("Ссылка",Реализация);
	
	Возврат Запрос.Выполнить().Выгрузить();

КонецФункции	

Процедура РеализацияНачалоВыбора(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	//выбор между реализацией и отчетом о розничных продажах
	СписокТипов = Новый СписокЗначений; 	
	СписокТипов.Добавить(Метаданные.Документы["РеализацияТоваровУслуг"].Имя,    Метаданные.Документы["РеализацияТоваровУслуг"].Представление());
	СписокТипов.Добавить(Метаданные.Документы["ПеремещениеТоваров"].Имя,        Метаданные.Документы["ПеремещениеТоваров"].Представление());          //08.08.2017
	СписокТипов.Добавить(Метаданные.Документы["ОтчетОРозничныхПродажах"].Имя,	Метаданные.Документы["ОтчетОРозничныхПродажах"].Представление());
	СписокТипов.Добавить("ШтрихКод",);
	ВыбранныйЭлемент = ЭтаФорма.ВыбратьИзСписка(СписокТипов, Элемент);
	
	Если 		ВыбранныйЭлемент.Значение = "ШтрихКод" Тогда
	Иначе       Элемент.Значение = "";
		
		Если ВыбранныйЭлемент.Значение = "РеализацияТоваровУслуг" Тогда 
			ФормаВыбора = Документы.РеализацияТоваровУслуг.ПолучитьФормуВыбора(,Элемент,);
		ИначеЕсли ВыбранныйЭлемент.Значение = "ОтчетОРозничныхПродажах" Тогда 
			ФормаВыбора = Документы.ОтчетОРозничныхПродажах.ПолучитьФормуВыбора(,Элемент,);
		ИначеЕсли ВыбранныйЭлемент.Значение = "ПеремещениеТоваров" Тогда     //08.08.2017
			ФормаВыбора = Документы.ПеремещениеТоваров.ПолучитьФормуВыбора(,Элемент,);
		КонецЕсли;
		
		ДатаС = ?(ЗначениеЗаполнено(НачПериода),НачПериода,'00010101');
		ДатаПо = ?(ЗначениеЗаполнено(КонПериода),КонПериода,ТекущаяДата());
		ФормаВыбора.Отбор.Дата.ЗначениеС 		= ДатаС;
		ФормаВыбора.Отбор.Дата.ЗначениеПо 		= ДатаПо;
		ФормаВыбора.Отбор.Дата.Использование 	= Истина; 		
		ФормаВыбора.Открыть();					
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ПриОткрытии()
	Реализация = "";
	Флажок0 = Истина;
КонецПроцедуры


Процедура КоманднаяПанель1ВыделитьВсе(Кнопка)
	Флажок0=Истина;
	для каждого стр1 из Продажи цикл
		стр1.Флажок = Флажок0;
	КонецЦикла;	
КонецПроцедуры

Процедура КоманднаяПанель1НеВыделитьВсе(Кнопка)
	Флажок0=ЛОЖЬ;
	для каждого стр1 из Продажи цикл
		стр1.Флажок = Флажок0;
	КонецЦикла;	
КонецПроцедуры

Процедура ПродажиПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки)
	Попытка 
		Если ДанныеСтроки.Количество<=ДанныеСтроки.КоличествоОстаток тогда
			ОформлениеСтроки.ЦветФона = WebЦвета.БледноЗеленый;
		иначе
			ОформлениеСтроки.ЦветФона = WebЦвета.БледноКрасноФиолетовый;
		КонецЕсли;
	исключение
	КонецПопытки;
КонецПроцедуры

Процедура ПродажиПриИзмененииФлажка(Элемент, Колонка)
	Попытка
		Если Колонка.Имя = "фл" тогда
			Если Элемент.ТекущиеДанные.Количество>Элемент.ТекущиеДанные.КоличествоОстаток и Элемент.ТекущиеДанные.флажок =истина тогда
				Элемент.ТекущиеДанные.флажок = ложь;
				Предупреждение("Остаток по реализации меньше выбранного количества"+Символы.ПС+
				"(по реализации уже были возвраты или корректировки)");
			КонецЕсли;
		КонецЕсли;
	Исключение
КонецПопытки

КонецПроцедуры
