
Процедура КоманднаяПанель2кнПодборРасходы(Кнопка)
	ФормаПодбора = Справочники.СтатьиЗатрат.ПолучитьФорму("ФормаВыбора",ЭлементыФормы.Расходы);
	ФормаПодбора.ЗакрыватьПриВыборе=Ложь;
	ФормаПодбора.МножественныйВыбор=Истина;
	ФормаПодбора.РежимВыбора=Истина;
	ФормаПодбора.ОткрытьМодально();
КонецПроцедуры

Процедура РасходыОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	Если ТипЗнч(ВыбранноеЗначение) = Тип("СправочникСсылка.СтатьиЗатрат") Тогда
		НоваяСтрока = Расходы.Добавить();
		НоваяСтрока.СтатьяЗатрат = ВыбранноеЗначение;
	Иначе
		Для каждого СтрокаМассива Из ВыбранноеЗначение Цикл
			НоваяСтрока = Расходы.Добавить();
			НоваяСтрока.СтатьяЗатрат = СтрокаМассива;
		КонецЦикла; 
	КонецЕсли;
КонецПроцедуры

Процедура КоманднаяПанель2кнДобавитьВсеСтатьи(Кнопка)
	Запрос=Новый Запрос;
	Запрос.Текст="ВЫБРАТЬ
	|	СтатьиЗатрат.Ссылка
	|ИЗ
	|	Справочник.СтатьиЗатрат КАК СтатьиЗатрат
	|ГДЕ
	|	СтатьиЗатрат.ПометкаУдаления = ЛОЖЬ
	|
	|УПОРЯДОЧИТЬ ПО
	|	СтатьиЗатрат.Наименование
	|АВТОУПОРЯДОЧИВАНИЕ";
	Рез=Запрос.Выполнить().Выбрать();
	Пока Рез.Следующий() Цикл
		нстр=Расходы.Добавить();
		нстр.СтатьяЗатрат=Рез.Ссылка;
	КонецЦикла;
КонецПроцедуры

Процедура КоманднаяПанель1кнПодборДоходы(Кнопка)
	СписокЗн=Новый СписокЗначений;
	СписокЗн.Добавить("Производитель","Производитель");
	СписокЗн.Добавить("ВидНоменклатуры","Вид номенклатуры");
	Выб=СписокЗн.ВыбратьЭлемент("Подобрать по");
	Если Выб=СписокЗн.НайтиПоЗначению("Производитель") тогда
		 ФормаПодбора = Справочники.Производители.ПолучитьФорму("ФормаВыбора",ЭлементыФормы.Доходы);
	ИначеЕсли Выб=СписокЗн.НайтиПоЗначению("ВидНоменклатуры") тогда
		 ФормаПодбора = Перечисления.ВидыТоваров.ПолучитьФормуВыбора(,ЭлементыФормы.Доходы);
	КонецЕсли;
	//ФормаПодбора = Справочники.СтатьиЗатрат.ПолучитьФорму("ФормаВыбора",ЭлементыФормы.Расходы);
	ФормаПодбора.ЗакрыватьПриВыборе=Ложь;
	ФормаПодбора.МножественныйВыбор=Истина;
	ФормаПодбора.РежимВыбора=Истина;
	ФормаПодбора.ОткрытьМодально();
КонецПроцедуры

Процедура ДоходыОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	Если ТипЗнч(ВыбранноеЗначение) = Тип("СправочникСсылка.Производители") или ТипЗнч(ВыбранноеЗначение) = Тип("ПеречислениеСсылка.ВидыТоваров") Тогда
		НоваяСтрока = Доходы.Добавить();
		НоваяСтрока.ВидТовара = ВыбранноеЗначение;
	Иначе
		Для каждого СтрокаМассива Из ВыбранноеЗначение Цикл
			НоваяСтрока = Доходы.Добавить();
			НоваяСтрока.ВидТовара = СтрокаМассива;
		КонецЦикла; 
	КонецЕсли;
КонецПроцедуры

Процедура ДействияФормыкнУтвердить(Кнопка)
	Утвержден=Истина;
	Записать(РежимЗаписиДокумента.Проведение);
КонецПроцедуры

Процедура ПриОткрытии()
	ЭлементыФормы.ДействияФормы.Кнопки.кнУтвердить.Доступность=не Утвержден И РольДоступна("яштФинДиректор");
	Если ЭтоНовый() Тогда
	Иначе
		ТолькоПросмотр= Утвержден И не РольДоступна("яштФинДиректор");
		ЭтаФорма.ТолькоПросмотр = ТолькоПросмотр;
		ЭтаФорма.ЭлементыФормы.КоманднаяПанель1.Кнопки.кнПодборДоходы.Доступность = не ТолькоПросмотр;
		ЭтаФорма.ЭлементыФормы.КоманднаяПанель2.Кнопки.кнПодборРасходы.Доступность = не ТолькоПросмотр;
		ЭтаФорма.ЭлементыФормы.КоманднаяПанель2.Кнопки.кнДобавитьВсеСтатьи.Доступность = не ТолькоПросмотр;
	КонецЕсли;
КонецПроцедуры

Процедура ДоходыПроцентНаценкиПриИзменении(Элемент)
	СтрокаТабличнойЧасти = ЭлементыФормы.Доходы.ТекущиеДанные;
    СтрокаТабличнойЧасти.ВаловаяПрибыль =(СтрокаТабличнойЧасти.ПроцентНаценки*СтрокаТабличнойЧасти.Сумма)/(100+СтрокаТабличнойЧасти.ПроцентНаценки);
КонецПроцедуры

Процедура ДоходыСуммаПриИзменении(Элемент)
	СтрокаТабличнойЧасти = ЭлементыФормы.Доходы.ТекущиеДанные;
    СтрокаТабличнойЧасти.ВаловаяПрибыль =(СтрокаТабличнойЧасти.ПроцентНаценки*СтрокаТабличнойЧасти.Сумма)/(100+СтрокаТабличнойЧасти.ПроцентНаценки);
КонецПроцедуры

Процедура ДоходыВаловаяПрибыльПриИзменении(Элемент)
	СтрокаТабличнойЧасти = ЭлементыФормы.Доходы.ТекущиеДанные;
	Если (СтрокаТабличнойЧасти.Сумма-СтрокаТабличнойЧасти.ВаловаяПрибыль)<>0 тогда
		СтрокаТабличнойЧасти.ПроцентНаценки =СтрокаТабличнойЧасти.ВаловаяПрибыль/(СтрокаТабличнойЧасти.Сумма-СтрокаТабличнойЧасти.ВаловаяПрибыль)*100;
	КонецЕсли;
КонецПроцедуры

Процедура ОсновныеДействияФормыкнПланФакт(Кнопка)
	попытка
		ТекСсылка=Справочники.ВнешниеОбработки.НайтиПоНаименованию("Бюджет доходов-расходов"); 
		ИмяФайла = ПолучитьИмяВременногоФайла(); 
		ДвоичныеДанные = ТекСсылка.ХранилищеВнешнейОбработки.Получить(); 
		ДвоичныеДанные.Записать(ИмяФайла); 
		Если ТекСсылка.ВидОбработки = Перечисления.ВидыДополнительныхВнешнихОбработок.Отчет Тогда 
			БюджетДоходовРасходов = ВнешниеОтчеты.Создать(ИмяФайла,ложь); 
		Иначе 
			БюджетДоходовРасходов = ВнешниеОбработки.Создать(ИмяФайла,Ложь); 
		КонецЕсли; 
		БюджетДоходовРасходов.НачПериода=НачалоГода(ТекущаяДата());
		БюджетДоходовРасходов.КонПериода=КонецГода(ТекущаяДата());
		БюджетДоходовРасходов.Проект=Проект;
		ФормаБДиР=БюджетДоходовРасходов.ПолучитьФорму("ФормаОтчета");
		ФормаБДиР.Открыть();

	Исключение
		ЗаписьЖурналаРегистрации("Обработка <Получить заявки на брак>",
		УровеньЖурналаРегистрации.Информация,
		,
		,
		ОписаниеОшибки(),
		);
	КонецПопытки;

КонецПроцедуры
