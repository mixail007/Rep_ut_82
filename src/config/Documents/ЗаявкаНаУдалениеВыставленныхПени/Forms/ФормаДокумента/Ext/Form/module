
Процедура КоманднаяПанель1Подбор(Кнопка)
	ФормаПодбора = Документы.РеализацияТоваровУслуг.ПолучитьФормуСписка("ФормаСписка", ЭтаФорма);  
	ФормаПодбора.РежимВыбора=Истина;
	ФормаПодбора.ЗакрыватьПриВыборе = Ложь; 
	ФормаПодбора.ДокументСписок.Отбор.Контрагент.Значение = Контрагент;
	ФормаПодбора.ДокументСписок.Отбор.Контрагент.Использование=Истина;	
	ФормаПодбора.ДокументСписок.Отбор.Номер.ВидСравнения = ВидСравнения.Содержит;
	ФормаПодбора.ДокументСписок.Отбор.Номер.Значение = "ПЕ";
    ФормаПодбора.ДокументСписок.Отбор.Номер.Использование = Истина;
	ФормаПодбора.ДокументСписок.Отбор.ПометкаУдаления.ВидСравнения = ВидСравнения.Равно;
	ФормаПодбора.ДокументСписок.Отбор.ПометкаУдаления.Значение = Ложь;
    ФормаПодбора.ДокументСписок.Отбор.ПометкаУдаления.Использование = Истина;

	ФормаПодбора.Открыть(); 	
	


КонецПроцедуры



Процедура ПриОткрытии()
	Если ЭтоНовый() Тогда
		Организация =  Справочники.Организации.НайтиПоКоду("00001");
		Состояние = Перечисления.СостоянияОбъектов.Подготовлен;
		Согласованно = Ложь;
		Согласовал = Справочники.Пользователи.ПустаяСсылка();
		Ответственный = глТекущийПользователь;
		Выполнено = Ложь;
	КонецЕсли;
	
КонецПроцедуры

Процедура ОбработкаВыбора(ЗначениеВыбора, Источник)
	Если ТипЗнч(ЗначениеВыбора) = Тип("ДокументСсылка.РеализацияТоваровУслуг") Тогда 
		НовСтр = ВыставленныеПени.Добавить();
		НовСтр.Сумма = ЗначениеВыбора.СуммаДокумента;
		НовСтр.Реализация = ЗначениеВыбора.Ссылка;
		НовСтр.ДоговорНачисления = ЗначениеВыбора.ДоговорКонтрагента;
	КонецЕсли;
	
КонецПроцедуры

Процедура ОсновныеДействияФормыОтправитьНаСогласование(Кнопка)
	Записать();
	//Если Проведен =  Ложь Тогда
	//	Сообщить("Нельзя отправлять на согласование непроведенный документ! Необходимо провести документ!", СтатусСообщения.Внимание);
	//	Возврат;
	//КонецЕсли;

	Если Согласованно = Истина Тогда
		Сообщить("Заявка уже согласованна");
		Возврат;
	КонецЕсли;

	Режим = РежимДиалогаВопрос.ДаНет;
	Ответ = Вопрос("Отправить запрос на согласование?", Режим, 0);
	Если Ответ = КодВозвратаДиалога.Нет Тогда
		Возврат;
	КонецЕсли;	
	
	Задача = Задачи.ЗадачиПользователя.СоздатьЗадачу();
	ДопИнфоПоРеализациям = "";
	Для каждого СтрРеал из ВыставленныеПени Цикл
		ДопИнфоПоРеализациям = ДопИнфоПоРеализациям + СтрРеал.Реализация + Символы.ПС;
	КонецЦикла;

	Если ЗначениеНеЗаполнено(СтрРеал.ДоговорНачисления.ОтветственноеЛицо) Тогда
		Исполнитель = Справочники.Пользователи.НайтиПоКоду("Серков");
	Иначе
		Исполнитель =  ?(ЗначениеЗаполнено(СтрРеал.ДоговорНачисления.ОтветственноеЛицо.НаправлениеПродаж),СтрРеал.ДоговорНачисления.ОтветственноеЛицо.НаправлениеПродаж.Согласование,Справочники.Пользователи.НайтиПоКоду("Серков"));
	КонецЕсли;
	Если Исполнитель = Неопределено или Исполнитель = Справочники.Пользователи.ПустаяСсылка() Тогда
		Исполнитель = Справочники.Пользователи.НайтиПоКоду("Серков");
    КонецЕсли;
		

		Задача.Исполнитель = Исполнитель;		
		задача.НаСогласование = Истина;
		задача.Наименование = "Согласовать заявку на удаление выставленных пеней "; 
		задача.Описание = "Согласовать заявку на удаление выставленных пеней для клиента: "+строка(Контрагент.НаименованиеПолное)+ 
		" по реализациям: " + ДопИнфоПоРеализациям;
		
		задача.Инициатор   = глТекущийПользователь;
		задача.Объект   	 = ссылка;
		задача.Дата 		    = ТекущаяДата();
		задача.СрокИсполнения = КонецДня( ТекущаяДата() ); 	
		задача.Оповещение     = истина;
		задача.СрокОповещения = ТекущаяДата(); 
		задача.РеквизитДляСогласования = "Ссылка";
		задача.ЗначениеРеквизитаДляСогласования = "Согласование руководителя";
       
		Попытка
			задача.Записать();
			Сообщить(" + Сформирована ""Задача на согласование"" для сотрудника: "+строка(задача.Исполнитель), СтатусСообщения.Информация );	
		исключение
			Сообщить(" - Не удалось сформировать электронную Задачу на согласование для сотрудника: "+строка(задача.Исполнитель), СтатусСообщения.Внимание );	
		КонецПопытки;


КонецПроцедуры
