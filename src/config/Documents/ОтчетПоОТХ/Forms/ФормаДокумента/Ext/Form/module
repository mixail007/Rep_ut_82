
Процедура РазобратьПоFIFOНажатие(Элемент)
	РазобратьПоFIFO();
КонецПроцедуры

Процедура КоманднаяПанель1ПодобратьПоПродажам(Кнопка)
	ФормаЗаполнения = ПолучитьФорму("ФормаПодбра", ЭтаФорма);
	ФормаЗаполнения.Контрагент=Контрагент;
	ФормаЗаполнения.ДатаПо=ДатаПо;
	ФормаЗаполнения.ДатаС=ДатаС;
	ФормаЗаполнения.Открыть();

КонецПроцедуры


Процедура ОбработкаВыбора(ЗначениеВыбора, Источник)
	Если ТипЗнч(ЗначениеВыбора) = Тип("ТаблицаЗначений") Тогда
		Для каждого стр из ЗначениеВыбора цикл
		     если стр.количество <>0 тогда
				ст = товары.Добавить();
				ст.Номенклатура = стр.номенклатура;
				ст.Количество = стр.количество;
			 конецЕсли;	 
		конецЦикла;
	конецЕсли;	
	
КонецПроцедуры

Процедура СоздатьДокументыНажатие(Элемент)
	Ответственный = глТекущийПользователь;
	СоздатьПакетДокументов();
	Если ДокументыСформированы  тогда
		ЭлементыФормы.СтатусДокумент.Заголовок = "Документы сформированы";
		ЭлементыФормы.СтатусДокумент.ЦветТекста = Webцвета.Зеленый;
		ЭлементыФормы.КоманднаяПанель1.Кнопки.ПодобратьПоПродажам.Доступность = Истина;
		ЭлементыФормы.Товары.ТолькоПросмотр = Истина;
		ЭлементыФормы.ТоварыПоЗаказам.ТолькоПросмотр = истина;
		ЭлементыФормы.СоздатьДокументы.Доступность = Ложь;
	иначе	
		ЭлементыФормы.СтатусДокумент.Заголовок = "Документы не сформированы";
		ЭлементыФормы.СтатусДокумент.ЦветТекста = Webцвета.Красный;
	конецЕсли;		
КонецПроцедуры

Процедура ПриОткрытии()
	Если ДокументыСформированы  тогда
		ЭлементыФормы.СтатусДокумент.Заголовок = "Документы на отгрузку сформированы";
		ЭлементыФормы.СтатусДокумент.ЦветТекста = Webцвета.Зеленый;
		ЭлементыФормы.КоманднаяПанель1.Кнопки.ПодобратьПоПродажам.Доступность = Истина;
		ЭлементыФормы.Товары.ТолькоПросмотр = Истина;
		ЭлементыФормы.ТоварыПоЗаказам.ТолькоПросмотр = истина;
		ЭлементыФормы.СоздатьДокументы.Доступность = Ложь;
	иначе	
		ЭлементыФормы.СтатусДокумент.Заголовок = "Документы на отгрузку не сформированы";
		ЭлементыФормы.СтатусДокумент.ЦветТекста = Webцвета.Красный;
	конецЕсли;	
	Если не Рольдоступна("ПолныеПрава")  тогда
		//ТолькоПросмотр = истина;
		ЭлементыФормы.Панель1.Страницы.ПоЗаказам.Видимость = Ложь;
		ЭлементыФормы.СоздатьДокументы.Доступность = Ложь;
		ЭлементыФормы.РазобратьПоFIFO.Доступность = Ложь;
		ЭлементыФормы.кнПереоформитьДокументы.Доступность = ложь;
	конецЕсли;
	УстановитьВидимостьПодразделения();
КонецПроцедуры

Процедура ТоварыПриПолученииДанных(Элемент, ОформленияСтрок)
	Для каждого ОформлениеСтроки Из ОформленияСтрок Цикл
		Данныестроки = ОформлениеСтроки.Данныестроки;
		ОформлениеСтроки.Ячейки.Код.Текст = ДанныеСтроки.Номенклатура.Код;
		ОформлениеСтроки.Ячейки.Код.ОтображатьТекст = Истина;
	КонецЦикла;
КонецПроцедуры

Процедура ТоварыПоЗаказамПриПолученииДанных(Элемент, ОформленияСтрок)
	Для каждого ОформлениеСтроки Из ОформленияСтрок Цикл
		Данныестроки = ОформлениеСтроки.Данныестроки;
		ОформлениеСтроки.Ячейки.Код.Текст = ДанныеСтроки.Номенклатура.Код;
		ОформлениеСтроки.Ячейки.Код.ОтображатьТекст = Истина;
	КонецЦикла;

КонецПроцедуры

Процедура ДействияФормыСтруктураПодчиненностиДокумента(Кнопка)
	ПоказатьСтруктуруПодчиненностиДокумента(Ссылка);
КонецПроцедуры

Процедура кнОтправитьДокиНажатие(Элемент)
	Если Модифицированность тогда
		Ответ = Вопрос("Перед отправкой документов необходимо записать документ. 
		|Записать?", РежимДиалогаВопрос.ДаНет);
		Если Ответ = КодВозвратаДиалога.Да тогда
			Записать();
			ОтправитьДоки();
		КонецЕсли;
	иначе
		ОтправитьДоки();
	КонецЕсли;
КонецПроцедуры

Процедура СформированныеДокументыПриПолученииДанных(Элемент, ОформленияСтрок)
	ЭлементыФормы.СформированныеДокументы.Колонки.Сумма.ТекстПодвала = 0;

	
	табДок = новый ТаблицаЗначений;
	ТабДок.Колонки.Добавить("Документ");
	ТабДок.Колонки.Добавить("Сумма");
	
	для каждого стр из СформированныеДокументы цикл
		Если типЗнч(стр.Документ) = тип("ДокументСсылка.РеализацияТоваровУслуг") тогда
			нстр = табДок.Добавить();
			нстр.Документ = стр.Документ;
			нстр.Сумма = стр.Документ.СуммаДокумента;
		ИначеЕсли типЗнч(стр.Документ) = тип("ДокументСсылка.ВозвратТоваровОтПокупателя") тогда
			нстр = табДок.Добавить();
			нстр.Документ = стр.Документ;
			нстр.Сумма = - стр.Документ.СуммаДокумента;
		КонецЕсли;
	КонецЦикла;
	
	Для каждого ОформлениеСтроки из ОформленияСтрок цикл
		    НайденнаяСтрока = ТабДок.Найти(ОформлениеСтроки.ДанныеСтроки.Документ,"Документ");
			Если НайденнаяСтрока<>Неопределено тогда
				ОформлениеСтроки.Ячейки.Сумма.Значение = НайденнаяСтрока.Сумма;
			КонецЕсли;
	КонецЦикла;
	
	ЭлементыФормы.СформированныеДокументы.Колонки.Сумма.ТекстПодвала = Формат(ТабДок.Итог("Сумма"),"");
КонецПроцедуры


процедура УстановитьВидимостьПодразделения()
	ЭтоСкрипченко =  Контрагент = справочники.Контрагенты.НайтиПоКоду("П017979");
	ЭлементыФормы.НадписьПодразделение.Видимость = ЭтоСкрипченко;
	Элементыформы.Подразделение.Видимость = ЭтоСкрипченко;
конецПроцедуры	

Процедура КонтрагентПриИзменении(Элемент)
	УстановитьВидимостьПодразделения();
КонецПроцедуры

Процедура кнПереоформитьДокументыНажатие(Элемент)
	Если Проведен и ДокументыСформированы тогда
		НачатьТранзакцию();
		к = СформированныеДокументы.Количество();
		пока к>0 цикл
			докОб = СформированныеДокументы[к-1].Документ.ПолучитьОбъект();
			ДокОб.Комментарий = ДокОб.Комментарий+" #Отмена (Переоформлены документы ОТХ)#";
			Если типзнч(ДокОб) = тип("ДокументОбъект.ЗаказПокупателя") тогда
				ДокОб.Согласован = истина;
			КонецЕсли;
			ДокОб.Записать();
			ДокОб.УстановитьПометкуУдаления(истина);
			ДокОб.Записать();
			к=к-1;
		КонецЦикла;
		СформированныеДокументы.Очистить();
		
		ТоварыПоЗаказам.Очистить();
		
		РазобратьПоFIFO();
		СоздатьПакетДокументов();
		
		Комментарий = Комментарий +" пересчитан для НДС20%";
		
		ЗафиксироватьТранзакцию();
		
	КонецЕсли;
КонецПроцедуры
