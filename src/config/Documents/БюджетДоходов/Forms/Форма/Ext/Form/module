Перем ТЧ Экспорт;
Перем ПериодПланирования Экспорт;
Процедура ПриОткрытии()
	
	ТЧ.Колонки.Добавить("РучнойВвод");
	
	для каждого стр из ТЧ Цикл
		стр.РучнойВвод = Истина;
	КонецЦикла;
	
	ТЧНовая = ТЧ.Скопировать();
	ТЧНовая.Очистить();
	
	для каждого стр11 из ТЧ Цикл
		
		Нов = ТЧНовая.Добавить();
		ЗаполнитьЗначенияСвойств(Нов,стр11);
		
		Нов2 = ТЧНовая.Добавить();
		
		Нов2.Менеджер = стр11.Менеджер;
		Нов2.Разрез1 =  стр11.Разрез1;
		Нов2.Разрез2 =  стр11.Разрез2;
		Нов2.ВходнаяЦена = стр11.ВходнаяЦена;
		
	КонецЦикла;
	
	//////
	
	Запрос = Новый Запрос;
	запрос.УстановитьПараметр("Дата1",ПериодПланирования.ДатаНачала);
	запрос.УстановитьПараметр("Дата2",ПериодПланирования.ДатаКонца);
	запрос.Текст = "ВЫБРАТЬ
	               |	ЗаказыПоставщикамОстатки.Номенклатура.НоменклатурнаяГруппа КАК НоменклатурнаяГруппа,
	               |	ЗаказыПоставщикамОстатки.Номенклатура.Производитель КАК Производитель,
	               |	СУММА(ЗаказыПоставщикамОстатки.КоличествоОстаток) КАК КоличествоОстаток,
	               |	НАЧАЛОПЕРИОДА(ДОБАВИТЬКДАТЕ(ЗаказыПоставщикамОстатки.ЗаказПоставщику.ДатаПоступления, ДЕНЬ, 7), МЕСЯЦ) КАК ДатаПоступления
	               |ИЗ
	               |	РегистрНакопления.ЗаказыПоставщикам.Остатки КАК ЗаказыПоставщикамОстатки
	               |ГДЕ
	               |	ДОБАВИТЬКДАТЕ(ЗаказыПоставщикамОстатки.ЗаказПоставщику.ДатаПоступления, ДЕНЬ, 7) МЕЖДУ &дата1 И &дата2
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ЗаказыПоставщикамОстатки.Номенклатура.НоменклатурнаяГруппа,
	               |	ЗаказыПоставщикамОстатки.Номенклатура.Производитель,
	               |	НАЧАЛОПЕРИОДА(ДОБАВИТЬКДАТЕ(ЗаказыПоставщикамОстатки.ЗаказПоставщику.ДатаПоступления, ДЕНЬ, 7), МЕСЯЦ)";
				   
	Рез = запрос.Выполнить().Выгрузить();
	
	соответствие = Новый Соответствие;
	соответствие.Вставить(ПериодПланирования.ДатаНачала,"1");
	соответствие.Вставить(ДобавитьМесяц(ПериодПланирования.ДатаНачала,1),"2");
	соответствие.Вставить(ДобавитьМесяц(ПериодПланирования.ДатаНачала,2),"3");
	соответствие.Вставить(ДобавитьМесяц(ПериодПланирования.ДатаНачала,3),"4");
	соответствие.Вставить(ДобавитьМесяц(ПериодПланирования.ДатаНачала,4),"5");
	соответствие.Вставить(ДобавитьМесяц(ПериодПланирования.ДатаНачала,5),"6");
	соответствие.Вставить(ДобавитьМесяц(ПериодПланирования.ДатаНачала,6),"7");
	соответствие.Вставить(ДобавитьМесяц(ПериодПланирования.ДатаНачала,7),"8");
	соответствие.Вставить(ДобавитьМесяц(ПериодПланирования.ДатаНачала,8),"9");
	соответствие.Вставить(ДобавитьМесяц(ПериодПланирования.ДатаНачала,9),"10");
	соответствие.Вставить(ДобавитьМесяц(ПериодПланирования.ДатаНачала,10),"11");
	соответствие.Вставить(ДобавитьМесяц(ПериодПланирования.ДатаНачала,11),"12");

	
	Для каждого стр из Рез Цикл
		Отбор = НОвый Структура;
		отбор.Вставить("Разрез1",стр.НоменклатурнаяГруппа);
		отбор.Вставить("Разрез2",стр.Производитель);
		отбор.Вставить("РучнойВвод",Неопределено);
		
		НаборСтрок = ТЧНовая.НайтиСтроки(Отбор);
		
		если НаборСтрок.Количество()=0 тогда
			Отбор = НОвый Структура;
		    отбор.Вставить("Разрез1",стр.НоменклатурнаяГруппа);
			отбор.Вставить("РучнойВвод",Неопределено);
		    НаборСтрок = ТЧНовая.НайтиСтроки(Отбор);
		КонецЕсли;
		
		Если НаборСтрок.Количество() = 0 Тогда
			Продолжить;
		Иначе
			Для каждого стр11 из НаборСтрок Цикл
				стр11["Месяц"+соответствие.Получить(стр.ДатаПоступления)+ "Количество"]  = стр.КоличествоОстаток;
			КонецЦикла;	
		КонецЕсли;
	КонецЦикла;
	////////////

	
	Поступления = ТЧНовая;
	ЭлементыФормы.Поступления.СоздатьКолонки();
	Для Каждого колонка из ЭлементыФормы.Поступления.Колонки Цикл
		Если Найти(Колонка.Имя,"Месяц") > 0 Тогда
		    Колонка.ОтображатьИтогиВПодвале = Истина;
		КонецЕсли;
	КонецЦикла;
	
	соответствие = Новый Соответствие;
	соответствие.Вставить(1,"Январь");
	соответствие.Вставить(2,"Февраль");
	соответствие.Вставить(3,"Март");
	соответствие.Вставить(4,"Апрель");
	соответствие.Вставить(5,"Май");
	соответствие.Вставить(6,"Июнь");
	соответствие.Вставить(7,"Июль");
	соответствие.Вставить(8,"Август");
	соответствие.Вставить(9,"Сентябрь");
	соответствие.Вставить(10,"Октябрь");
	соответствие.Вставить(11,"Ноябрь");
	соответствие.Вставить(12,"Декабрь");
	
	Если Число(Формат(ПериодПланирования.ДатаНачала,"ДФ=yyyy")) = Число(Формат(ПериодПланирования.ДатаКонца,"ДФ=yyyy")) Тогда	
		КоличествоМесяцев = Число(Формат(ПериодПланирования.ДатаКонца,"ДФ=MM")) - Число(Формат(ПериодПланирования.ДатаНачала,"ДФ=MM")) +1;
	иначе
		КоличествоМесяцев = 12 - Число(Формат(ПериодПланирования.ДатаНачала,"ДФ=MM")) +1 + Число(Формат(ПериодПланирования.ДатаКонца,"ДФ=MM"));
	КонецЕсли;
	
	Датаии = ПериодПланирования.ДатаНачала;
	
	
	ЭлементыФормы.Поступления.Колонки["Менеджер"].Ширина = 20;
	ЭлементыФормы.Поступления.Колонки["Разрез1"].Ширина = 20;
	ЭлементыФормы.Поступления.Колонки["Разрез2"].Ширина = 20;
	ЭлементыФормы.Поступления.Колонки["ВходнаяЦена"].Ширина = 20;
	ЭлементыФормы.Поступления.Колонки["РучнойВвод"].Ширина = 5;
	ЭлементыФормы.Поступления.Колонки["НомерСтроки"].Видимость = Ложь;
	ЭлементыФормы.Поступления.Колонки["Разрез3"].Видимость = Ложь; 
	ЭлементыФормы.Поступления.Колонки["РаспределитьКоличество"].Видимость = Ложь;
	ЭлементыФормы.Поступления.Колонки["Комментарий"].Видимость = Ложь;
	
	ЭлементыФормы.Поступления.Колонки.Сдвинуть(ЭлементыФормы.Поступления.Колонки.Количество()-1,-31);
	
	для ии = 1 по КоличествоМесяцев Цикл
		
		ЭлементыФормы.Поступления.Колонки["Месяц"+Строка(ии)+ "Сумма"].ТекстШапки = соответствие.Получить(Число(Формат(Датаии,"ДФ=MM")))+ " Сумма";
		ЭлементыФормы.Поступления.Колонки["Месяц"+Строка(ии)+ "Количество"].ТекстШапки = соответствие.Получить(Число(Формат(Датаии,"ДФ=MM")))+ " Количество";
				
		ЭлементыФормы.Поступления.Колонки["Месяц"+Строка(ии)+ "Сумма"].Ширина = 15;
		ЭлементыФормы.Поступления.Колонки["Месяц"+Строка(ии)+ "Количество"].Ширина = 15;
				
		Датаии = ДобавитьМесяц(Датаии,1);
		
	КонецЦикла;
	
	для ии = (КоличествоМесяцев +1) по 12 Цикл
		
		ЭлементыФормы.Поступления.Колонки["Месяц"+Строка(ии)+ "Сумма"].Видимость = Ложь;
		ЭлементыФормы.Поступления.Колонки["Месяц"+Строка(ии)+ "Количество"].Видимость = Ложь;
						
	КонецЦикла;
	
КонецПроцедуры

Процедура ПоступленияПередОкончаниемРедактирования(Элемент, НоваяСтрока, ОтменаРедактирования, Отказ)
	ОбновитьСтроки();
КонецПроцедуры

Процедура ЗаполнитьПоЗаказамПоставщикамНажатие(Элемент)
	
	ЗаполнитьПоЗаказам();
	
КонецПроцедуры

процедура ОбновитьСтроки()	
	Для каждого СтрХ из Поступления Цикл
		СтрХ.Месяц1Сумма = СтрХ.Месяц1Количество*СтрХ.ВходнаяЦена;
		СтрХ.Месяц2Сумма = СтрХ.Месяц2Количество*СтрХ.ВходнаяЦена;
		СтрХ.Месяц3Сумма = СтрХ.Месяц3Количество*СтрХ.ВходнаяЦена;
		СтрХ.Месяц4Сумма = СтрХ.Месяц4Количество*СтрХ.ВходнаяЦена;
		СтрХ.Месяц5Сумма = СтрХ.Месяц5Количество*СтрХ.ВходнаяЦена;
		СтрХ.Месяц6Сумма = СтрХ.Месяц6Количество*СтрХ.ВходнаяЦена;
		
		СтрХ.Месяц7Сумма = СтрХ.Месяц7Количество*СтрХ.ВходнаяЦена;
		СтрХ.Месяц8Сумма = СтрХ.Месяц8Количество*СтрХ.ВходнаяЦена;
		СтрХ.Месяц9Сумма = СтрХ.Месяц9Количество*СтрХ.ВходнаяЦена;
		СтрХ.Месяц10Сумма = СтрХ.Месяц10Количество*СтрХ.ВходнаяЦена;
		СтрХ.Месяц11Сумма = СтрХ.Месяц11Количество*СтрХ.ВходнаяЦена;
		СтрХ.Месяц12Сумма = СтрХ.Месяц12Количество*СтрХ.ВходнаяЦена;
	КонецЦикла;	
КонецПроцедуры

процедура ЗаполнитьПоЗаказам()
	
	Для каждого СтрХ из Поступления Цикл
		Если СтрХ.РучнойВвод = неопределено Тогда			
			СтрХ.Месяц1Количество=0;
			СтрХ.Месяц2Количество=0;
			СтрХ.Месяц3Количество=0;
			СтрХ.Месяц4Количество=0;
			СтрХ.Месяц5Количество=0;
			СтрХ.Месяц6Количество=0;
			
			СтрХ.Месяц7Количество=0;
			СтрХ.Месяц8Количество=0;
			СтрХ.Месяц9Количество=0;
			СтрХ.Месяц10Количество=0;
			СтрХ.Месяц11Количество=0;
			СтрХ.Месяц12Количество=0;				
		КонецЕсли;	
	КонецЦикла;
	
	Запрос = Новый Запрос;
	запрос.УстановитьПараметр("Дата1",ПериодПланирования.ДатаНачала);
	запрос.УстановитьПараметр("Дата2",ПериодПланирования.ДатаКонца);
	запрос.Текст = "ВЫБРАТЬ
	               |	ЗаказыПоставщикамОстатки.Номенклатура.НоменклатурнаяГруппа КАК НоменклатурнаяГруппа,
	               |	ЗаказыПоставщикамОстатки.Номенклатура.Производитель КАК Производитель,
	               |	СУММА(ЗаказыПоставщикамОстатки.КоличествоОстаток) КАК КоличествоОстаток,
	               |	НАЧАЛОПЕРИОДА(ДОБАВИТЬКДАТЕ(ЗаказыПоставщикамОстатки.ЗаказПоставщику.ДатаПоступления, ДЕНЬ, 7), МЕСЯЦ) КАК ДатаПоступления
	               |ИЗ
	               |	РегистрНакопления.ЗаказыПоставщикам.Остатки КАК ЗаказыПоставщикамОстатки
	               |ГДЕ
	               |	ДОБАВИТЬКДАТЕ(ЗаказыПоставщикамОстатки.ЗаказПоставщику.ДатаПоступления, ДЕНЬ, 7) МЕЖДУ &дата1 И &дата2
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ЗаказыПоставщикамОстатки.Номенклатура.НоменклатурнаяГруппа,
	               |	ЗаказыПоставщикамОстатки.Номенклатура.Производитель,
	               |	НАЧАЛОПЕРИОДА(ДОБАВИТЬКДАТЕ(ЗаказыПоставщикамОстатки.ЗаказПоставщику.ДатаПоступления, ДЕНЬ, 7), МЕСЯЦ)";
				   
	Рез = запрос.Выполнить().Выгрузить();
	
	соответствие = Новый Соответствие;
	соответствие.Вставить(ПериодПланирования.ДатаНачала,"1");
	соответствие.Вставить(ДобавитьМесяц(ПериодПланирования.ДатаНачала,1),"2");
	соответствие.Вставить(ДобавитьМесяц(ПериодПланирования.ДатаНачала,2),"3");
	соответствие.Вставить(ДобавитьМесяц(ПериодПланирования.ДатаНачала,3),"4");
	соответствие.Вставить(ДобавитьМесяц(ПериодПланирования.ДатаНачала,4),"5");
	соответствие.Вставить(ДобавитьМесяц(ПериодПланирования.ДатаНачала,5),"6");
	соответствие.Вставить(ДобавитьМесяц(ПериодПланирования.ДатаНачала,6),"7");
	соответствие.Вставить(ДобавитьМесяц(ПериодПланирования.ДатаНачала,7),"8");
	соответствие.Вставить(ДобавитьМесяц(ПериодПланирования.ДатаНачала,8),"9");
	соответствие.Вставить(ДобавитьМесяц(ПериодПланирования.ДатаНачала,9),"10");
	соответствие.Вставить(ДобавитьМесяц(ПериодПланирования.ДатаНачала,10),"11");
	соответствие.Вставить(ДобавитьМесяц(ПериодПланирования.ДатаНачала,11),"12");

	
	Для каждого стр из Рез Цикл
		Отбор = НОвый Структура;
		отбор.Вставить("Разрез1",стр.НоменклатурнаяГруппа);
		отбор.Вставить("Разрез2",стр.Производитель);
		отбор.Вставить("РучнойВвод",Неопределено);
		
		НаборСтрок = Поступления.НайтиСтроки(Отбор);
		
		если НаборСтрок.Количество()=0 тогда
			Отбор = НОвый Структура;
		    отбор.Вставить("Разрез1",стр.НоменклатурнаяГруппа);
			отбор.Вставить("РучнойВвод",Неопределено);
		    НаборСтрок = Поступления.НайтиСтроки(Отбор);
		КонецЕсли;
		
		Если НаборСтрок.Количество() = 0 Тогда
			Продолжить;
		Иначе
			Для каждого стр11 из НаборСтрок Цикл
				стр11["Месяц"+соответствие.Получить(стр.ДатаПоступления)+ "Количество"]  = стр.КоличествоОстаток;
			КонецЦикла;	
		КонецЕсли;
	КонецЦикла;
	
	ОбновитьСтроки();
	
КонецПроцедуры
