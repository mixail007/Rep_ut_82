
Перем ТаблицаОтбора;

Процедура ПриОткрытии()

	ПодключитьОбработчикОжидания("ОбновлениеОтображения", 1800);
	
	//+++Шарафутдинов 15.05.2018 хотя бы при одной настройке, по идее все настройки надо бы обрабатывать...
	
	Если ПолучитьЗначениеПоУмолчанию(ПараметрыСеанса.ТекущийПользователь, "ИспользоватьОтбор") Тогда  		
		
		Если (ПолучитьЗначениеПоУмолчанию(ПараметрыСеанса.ТекущийПользователь, "ЖурналыОтборПоРегиону")) Тогда
			
			СписокКонтрагентовМенеджера = ПолучитьСписокКонтрагентовМенеджераПоРегиону(ПараметрыСеанса.ТекущийПользователь);
			Если ДокументСписок.Отбор.Найти("Контрагент") = Неопределено Тогда 
				ДокументСписок.Отбор.Добавить("Контрагент");
			КонецЕсли;
			ДокументСписок.Отбор["Контрагент"].Использование = Истина;
			ДокументСписок.Отбор["Контрагент"].ВидСравнения = ВидСравнения.ВСписке;
			ДокументСписок.Отбор["Контрагент"].Значение = СписокКонтрагентовМенеджера;
			//ЭлементыФормы.ДокументСписок.НастройкаОтбора["Контрагент"].Доступность = Ложь;  	
			
		КонецЕсли;
	КонецЕсли;
	
	//---Шарафутдинов 15.05.2018
		
КонецПроцедуры

Процедура ДокументСписокПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки)
	
	//Контроль сроков выполнения и выделение цветом просроченные
	//1. 1 месяц для заявок если брак обнаружен на складе
	//2. 1 месяц с момента операции поступления на ОТХ на основании заявки на брак и на возврат
	Если ДанныеСтроки.Ссылка.СостояниеЗаявки = Перечисления.СостоянияЗаявкиНаБрак.ПризнатьБрак 
		ИЛИ ДанныеСтроки.Ссылка.СостояниеЗаявки = Перечисления.СостоянияЗаявкиНаБрак.Отклонить Тогда
	Иначе
		//сначала поиск по таблице
		СтрокаТЗ = ТаблицаОтбора.Найти(ДанныеСтроки.Ссылка);
		Если НЕ СтрокаТЗ = Неопределено Тогда
			Если ДобавитьМесяц(СтрокаТЗ.ДатаКонтроля, 1) < ТекущаяДата() Тогда
				ОформлениеСтроки.ЦветФона = WebЦвета.ЛососьСветлый;
				ОформлениеСтроки.Ячейки.ДатаКонтроля.УстановитьТекст(СтрокаТЗ.ДатаКонтроля);
			КонецЕсли;
		Иначе
			Если ДанныеСтроки.Ссылка.БракОбнаруженНаСкладе Тогда
				Если ДобавитьМесяц(ДанныеСтроки.Ссылка.Дата, 1) < ТекущаяДата() Тогда
					ОформлениеСтроки.ЦветФона = WebЦвета.ЛососьСветлый;
				КонецЕсли;
			КонецЕсли;
			Если ЗначениеЗаполнено(ДанныеСтроки.Ссылка.ДокументОснование) И ТипЗНЧ(ДанныеСтроки.Ссылка.ДокументОснование) = Тип("ДокументСсылка.ЗаявкаНаВозвратТоваров") Тогда
				Запрос = Новый Запрос;
				Запрос.УстановитьПараметр("ДокументОснование", ДанныеСтроки.Ссылка.ДокументОснование);
				Запрос.Текст = "ВЫБРАТЬ
				               |	ЕСТЬNULL(ОперацияПоОтветственномуХранению.Ссылка, 0) КАК ОперацияОТХ,
				               |	ОперацияПоОтветственномуХранению.Дата
				               |ИЗ
				               |	Документ.ОперацияПоОтветственномуХранению КАК ОперацияПоОтветственномуХранению
				               |ГДЕ
				               |	ОперацияПоОтветственномуХранению.ДокументОснование = &ДокументОснование
				               |	И ОперацияПоОтветственномуХранению.Проведен";
				Результат = Запрос.Выполнить().Выбрать();
				Если Результат.Следующий() Тогда
					Если ДобавитьМесяц(Результат.Дата, 1) < ТекущаяДата() Тогда
						ОформлениеСтроки.ЦветФона = WebЦвета.ЛососьСветлый;
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура ОбновлениеОтображения()

	УстановитьФильтрНаШиныДиски();
	
	УстановитьФильтрПоСостояниюЗаявки();
	
КонецПроцедуры

Процедура УстановитьФильтрНаШиныДиски()
	
	Если глТекущийПользователь = Справочники.Пользователи.НайтиПоКоду("Левченко Ф.С.")
		ИЛИ глТекущийПользователь = Справочники.Пользователи.НайтиПоКоду("Капченко И.")
		Тогда 
		//Диски
		ОтборПоСписку				 = ДокументСписок.Отбор;
		ОтборПоТипу					 = ОтборПоСписку.ВидТовара;
		ОтборПоТипу.Использование	 = Истина;
		ОтборПоТипу.Значение		 = Перечисления.ВидыТоваров.Диски; 
		ОтборПоТипу.ВидСравнения	 = ВидСравнения.Равно;
	ИначеЕсли глТекущийПользователь	 = Справочники.Пользователи.НайтиПоКоду("Уманский В. А.") Тогда
		//аксы
		ОтборПоСписку				 = ДокументСписок.Отбор;
		ОтборПоТипу					 = ОтборПоСписку.ВидТовара;
		ОтборПоТипу.Использование	 = Истина;
		ОтборПоТипу.Значение		 = Перечисления.ВидыТоваров.Аксессуары; 
		ОтборПоТипу.ВидСравнения	 = ВидСравнения.Равно;		
	ИначеЕсли глТекущийПользователь	 = Справочники.Пользователи.НайтиПоКоду("Куртов К.Д.") Тогда
		//все остальное
		ОтборПоСписку				 = ДокументСписок.Отбор;
		ОтборПоТипу					 = ОтборПоСписку.ВидТовара;
		ОтборПоТипу.Использование	 = Истина;
		ОтборПоТипу.ВидСравнения	 = ВидСравнения.НеВСписке;		
		СписокВидов = Новый СписокЗначений;
		СписокВидов.Добавить(Перечисления.ВидыТоваров.Диски);
		СписокВидов.Добавить(Перечисления.ВидыТоваров.Аксессуары);
		ОтборПоТипу.Значение		 = СписокВидов; 
	КонецЕсли;
	
КонецПроцедуры

Процедура УстановитьФильтрПоСостояниюЗаявки()
	
	Если ПараметрыСеанса.ТекущийПользователь = Справочники.Пользователи.НайтиПоКоду("Левченко Ф.С.") 
		ИЛИ ПараметрыСеанса.ТекущийПользователь = Справочники.Пользователи.НайтиПоКоду("Капченко И.")
		ИЛИ ПараметрыСеанса.ТекущийПользователь = Справочники.Пользователи.НайтиПоКоду("Куртов К.Д.")
		ИЛИ ПараметрыСеанса.ТекущийПользователь = Справочники.Пользователи.НайтиПоКоду("Уманский В. А.")
		ИЛИ ПараметрыСеанса.ТекущийПользователь = Справочники.Пользователи.НайтиПоКоду("Федорова")
		Тогда
		//1. Отбор всех заявок с состоянием "Согласовано"
		//2. Если по заявке на брак есть заявка на возврат и Операция по ОТХ, то ее видно независимо от состояния заявки в п.1
		//3. Брак обнаружен на складе
		Запрос = Новый Запрос;
		Запрос.УстановитьПараметр("ПустаяСсылкаЗаявкаНаВозврат", Документы.ЗаявкаНаВозвратТоваров.ПустаяСсылка());
		Запрос.УстановитьПараметр("ПустаяСсылкаЗаявкаНаБрак", Документы.ЗаявкаНаБрак.ПустаяСсылка());
		Запрос.Текст = "ВЫБРАТЬ
		               |	ЗаявкаНаБрак.Ссылка,
		               |	ЗаявкаНаБрак.Дата КАК ДатаКонтроля
		               |ИЗ
		               |	Документ.ЗаявкаНаБрак КАК ЗаявкаНаБрак
		               |ГДЕ
		               |	(ЗаявкаНаБрак.СостояниеЗаявки = ЗНАЧЕНИЕ(Перечисление.СостоянияЗаявкиНаБрак.Согласовано)
		               |			ИЛИ ЗаявкаНаБрак.СостояниеЗаявки = ЗНАЧЕНИЕ(Перечисление.СостоянияЗаявкиНаБрак.ВРассмотрении)
		               |			ИЛИ ЗаявкаНаБрак.БракОбнаруженНаСкладе)
		               |
		               |ОБЪЕДИНИТЬ ВСЕ
		               |
		               |ВЫБРАТЬ
		               |	А.Ссылка,
		               |	А.ОперацияОТХ.Дата
		               |ИЗ
		               |	(ВЫБРАТЬ
		               |		ЗаявкаНаБрак.Ссылка КАК Ссылка,
		               |		ЗаявкаНаБрак.ДокументОснование КАК ДокументОснование,
		               |		ЕСТЬNULL(ОперацияПоОтветственномуХранению.Ссылка, 0) КАК ОперацияОТХ
		               |	ИЗ
		               |		Документ.ЗаявкаНаБрак КАК ЗаявкаНаБрак
		               |			ЛЕВОЕ СОЕДИНЕНИЕ Документ.ОперацияПоОтветственномуХранению КАК ОперацияПоОтветственномуХранению
		               |			ПО ЗаявкаНаБрак.ДокументОснование = ОперацияПоОтветственномуХранению.ДокументОснование
		               |				И (ОперацияПоОтветственномуХранению.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийПоОтветственномуХранению.Поступление))
		               |	ГДЕ
		               |		ЗаявкаНаБрак.ДокументОснование <> &ПустаяСсылкаЗаявкаНаВозврат
		               |		И ЗаявкаНаБрак.ДокументОснование ССЫЛКА Документ.ЗаявкаНаВозвратТоваров) КАК А
		               |ГДЕ
		               |	А.ОперацияОТХ <> 0
		               |	И А.ОперацияОТХ.Проведен
		               |
		               |ОБЪЕДИНИТЬ ВСЕ
		               |
		               |ВЫБРАТЬ
		               |	А.ДокументОснование,
		               |	А.ОперацияОТХ.Дата
		               |ИЗ
		               |	(ВЫБРАТЬ
		               |		ЗаявкаНаВозврат.Ссылка КАК Ссылка,
		               |		ЗаявкаНаВозврат.ДокументОснование КАК ДокументОснование,
		               |		ЕСТЬNULL(ОперацияПоОтветственномуХранению.Ссылка, 0) КАК ОперацияОТХ
		               |	ИЗ
		               |		Документ.ЗаявкаНаВозвратТоваров КАК ЗаявкаНаВозврат
		               |			ЛЕВОЕ СОЕДИНЕНИЕ Документ.ОперацияПоОтветственномуХранению КАК ОперацияПоОтветственномуХранению
		               |			ПО ЗаявкаНаВозврат.Ссылка = ОперацияПоОтветственномуХранению.ДокументОснование
		               |				И (ОперацияПоОтветственномуХранению.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийПоОтветственномуХранению.Поступление))
		               |	ГДЕ
		               |		ЗаявкаНаВозврат.ДокументОснование <> &ПустаяСсылкаЗаявкаНаБрак
		               |		И ЗаявкаНаВозврат.ДокументОснование ССЫЛКА Документ.ЗаявкаНаБрак) КАК А
		               |ГДЕ
		               |	А.ОперацияОТХ <> 0
		               |	И А.ОперацияОТХ.Проведен
		               |АВТОУПОРЯДОЧИВАНИЕ";
		МассивОтбора = Новый СписокЗначений;
		Результат = Запрос.Выполнить();
		ТаблицаОтбора = Результат.Выгрузить();
		Выборка = Результат.Выбрать();
		Пока Выборка.Следующий() Цикл
			МассивОтбора.Добавить(Выборка.Ссылка);
		КонецЦикла;
		
		ДокументСписок.Отбор.Ссылка.Использование = Истина;
		ДокументСписок.Отбор.Ссылка.ВидСравнения = ВидСравнения.ВСписке;
		ДокументСписок.Отбор.Ссылка.Значение = МассивОтбора; 
		
	КонецЕсли;
	
КонецПроцедуры;

ТаблицаОтбора = Новый ТаблицаЗначений;

