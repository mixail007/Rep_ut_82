
Процедура ОсновныеДействияФормыСоздатьДокументы(Кнопка)
	текущийКонтрагент = Неопределено;
	ТекущаяДата= Неопределено;
	ТекущаяЗаявка = Неопределено;
	Для  каждого стр из ДанныеДляЗаявок Цикл
	   Если стр.пометка тогда
		   Если Текущийконтрагент<>стр.контрагент и  Текущийконтрагент<>стр.датаРасхода тогда
			   Если ТекущаяЗаЯвка<> Неопределено Тогда
				ТекущаяЗаявка.записать();
				Форма = ТекущаяЗаявка.получитьформу();
				Форма.Открыть();
			   конецесли;	   
		   Заявка = Документы.ЗаявкаНаРасходованиеСредств.СоздатьДокумент();
		   Заявка.Контрагент = Стр.контрагент;
		   Заявка.ВалютаДокумента = Валюта;
		   Заявка.БанковскийСчетКонтрагента = стр.Контрагент.ОсновнойБанковскийСчет;
		   Заявка.ВидОперации = Перечисления.ВидыОперацийЗаявкиНаРасходование.ОплатаПоставщику;
		   Заявка.Организация = Справочники.Организации.НайтиПоКоду("00001");
		   Заявка.Ответственный = ОтветственноеЛицо;
		   Заявка.ЕстьРасчетыСКонтрагентами = Истина;
		   Заявка.ДатаРасхода =стр.датаРасхода;
		   Заявка.ФормаОплаты = Перечисления.ВидыДенежныхСредств.Безналичные;
		   Заявка.Дата = ТекущаяДата();
		   Заявка.Подразделение = ОтветственноеЛицо.ОсновноеПодразделение;
		   Заявка.ПериодПланирования = НачалоМесяца(стр.датаРасхода);
		   стрЗаявки = Заявка.РасшифровкаПлатежа.Добавить();
		   стрЗаявки.ДатаРасхода = Стр.ДатаРасхода;
		   стрЗаявки.ДоговорКонтрагента = Стр.Договорконтрагента;
		   стрЗаявки.КратностьВзаиморасчетов = 1;
		   СтрЗаявки.КурсВзаиморасчетов = 1;
		   СтрЗаявки.Сделка = стр.Сделка;
		   СтрЗаявки.СтавкаНДС = Перечисления.СтавкиНДС.НДС18;
		   стрЗаявки.СтатьяДвиженияДенежныхСредств = Справочники.СтатьиДвиженияДенежныхСредств.ОплатаПоставщику;
		   стрЗаявки.СтатьяРасхода = Справочники.СтатьиРасходов.ОплатаПоставщику;
		   СтрЗаявки.СуммаВзаиморасчетов = стр.суммаОплаты;
		   стрЗаявки.СуммаПлатежа = стр.СуммаОплаты;
		   Заявка.СуммаДокумента = Заявка.СуммаДокумента+стр.суммаОплаты;
	       текущийКонтрагент = стр.контрагент;
	       ТекущаяДата = стр.датаРасхода;
		   ТекущаяЗаявка = Заявка;
		   иначе
		   стрЗаявки = Заявка.РасшифровкаПлатежа.Добавить();
		   стрЗаявки.ДатаРасхода = Стр.ДатаРасхода;
		   стрЗаявки.ДоговорКонтрагента = Стр.Договорконтрагента;
		   стрЗаявки.КратностьВзаиморасчетов = 1;
		   СтрЗаявки.КурсВзаиморасчетов = 1;
		   СтрЗаявки.Сделка = стр.Сделка;
		   СтрЗаявки.СтавкаНДС = Перечисления.СтавкиНДС.НДС18;
		   стрЗаявки.СтатьяДвиженияДенежныхСредств = Справочники.СтатьиДвиженияДенежныхСредств.ОплатаПоставщику;
		   стрЗаявки.СтатьяРасхода = Справочники.СтатьиРасходов.ОплатаПоставщику;
		   СтрЗаявки.СуммаВзаиморасчетов = стр.суммаОплаты;
		   стрЗаявки.СуммаПлатежа = стр.СуммаОплаты;
		    Заявка.СуммаДокумента = Заявка.СуммаДокумента+стр.суммаОплаты;

	       конецесли;
	   конецЕсли;
   конецЦикла;
   			   Если ТекущаяЗаЯвка<> Неопределено Тогда
				ТекущаяЗаявка.записать();
				Форма = ТекущаяЗаявка.получитьформу();
				Форма.Открыть();
			   конецесли;	   

КонецПроцедуры

Процедура ДанныеДляЗаявокПриПолученииДанных(Элемент, ОформленияСтрок)
	Для каждого стр из ОформленияСтрок Цикл
		ДанныеСтроки= стр.ДанныеСтроки;
		стр.Ячейки.Пометка.ОтображатьФлажок = Истина;
		стр.Ячейки.Пометка.Флажок = ДанныеСтроки.Пометка;
	конецЦикла;	
КонецПроцедуры

Процедура ДействияФормыУстановитьФлаги(Кнопка)
	Для  каждого стр из ДанныеДляЗаявок Цикл
		Стр.пометка = Истина;	
	конецЦикла;	
КонецПроцедуры

Процедура ДействияФормыСнятьФлаги(Кнопка)
	Для  каждого стр из ДанныеДляЗаявок Цикл
		Стр.пометка = Ложь;	
	конецЦикла;	
КонецПроцедуры

Процедура ПриОткрытии()
		Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ПоступлениеТоваровУслугГрафикОплаты.Ссылка.Контрагент КАК Контрагент,
		|	ПоступлениеТоваровУслугГрафикОплаты.Ссылка.ДоговорКонтрагента КАК ДоговорКонтрагента,
		|	ПоступлениеТоваровУслугГрафикОплаты.Дата КАК ДатаРасхода,
		|	СУММА(ПоступлениеТоваровУслугГрафикОплаты.ПроцентОплаты * ПоступлениеТоваровУслугГрафикОплаты.Ссылка.СуммаДокумента / 100) КАК СуммаОплаты,
		|	ПоступлениеТоваровУслугГрафикОплаты.Ссылка.Сделка КАК Сделка,
		|	ПоступлениеТоваровУслугГрафикОплаты.Ссылка.СуммаДокумента,
		|	ЛОЖЬ КАК Пометка
		|ИЗ
		|	Документ.ПоступлениеТоваровУслуг.ГрафикОплаты КАК ПоступлениеТоваровУслугГрафикОплаты
		|ГДЕ
		|	ПоступлениеТоваровУслугГрафикОплаты.Дата МЕЖДУ &ДатаНач И &ДатаКон
		|	И ПоступлениеТоваровУслугГрафикОплаты.Ссылка.ДоговорКонтрагента.ОтветственноеЛицо = &ОтветственноеЛицо
		|	И ПоступлениеТоваровУслугГрафикОплаты.Ссылка.ВалютаДокумента = &Валюта
		|	И ПоступлениеТоваровУслугГрафикОплаты.Ссылка.Проведен = ИСТИНА
		|
		|СГРУППИРОВАТЬ ПО
		|	ПоступлениеТоваровУслугГрафикОплаты.Ссылка.Контрагент,
		|	ПоступлениеТоваровУслугГрафикОплаты.Ссылка.ДоговорКонтрагента,
		|	ПоступлениеТоваровУслугГрафикОплаты.Дата,
		|	ПоступлениеТоваровУслугГрафикОплаты.Ссылка.Сделка,
		|	ПоступлениеТоваровУслугГрафикОплаты.Ссылка.СуммаДокумента
		|
		|УПОРЯДОЧИТЬ ПО
		|	Контрагент,
		|	ДатаРасхода,
		|	Сделка";

		Запрос.УстановитьПараметр("ДатаНач", НачалоМесяца(ПлановыйПериод));
		Запрос.УстановитьПараметр("ДатаКон", КонецМесяца(ПлановыйПериод));
	   	Запрос.УстановитьПараметр("Валюта", Валюта);
		Запрос.УстановитьПараметр("ОтветственноеЛицо", ОтветственноеЛицо);

		ДанныеДляЗаявок= Запрос.Выполнить().Выгрузить();


КонецПроцедуры
