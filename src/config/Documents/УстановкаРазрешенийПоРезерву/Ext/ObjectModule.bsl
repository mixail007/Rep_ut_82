
Процедура ЗакрытиеСтарыхУстановок( Движения )
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	РазрешениеПоРезервуСрезПоследних.Контрагент,
	               |	РазрешениеПоРезервуСрезПоследних.ВариантКод,
	               |	РазрешениеПоРезервуСрезПоследних.ВидТовара,
	               |	РазрешениеПоРезервуСрезПоследних.НоменклатурнаяГруппа
	               |ИЗ
	               |	РегистрСведений.РезервРазрешения.СрезПоследних(&Дата,
	               |				Контрагент В (&СписКонтр)
	               |				И КонтрагентРезерв = &КонтрагентРезерв
	               |				И Подразделение = &Подразделение) КАК РазрешениеПоРезервуСрезПоследних
				   |ГДЕ ДатаОкончания = ДАТАВРЕМЯ(1, 1, 1)";
	Запрос.УстановитьПараметр("Дата", Дата);
	Запрос.УстановитьПараметр("КонтрагентРезерв", КонтрагентРезерв);
	Запрос.УстановитьПараметр("Подразделение",Подразделение);
	СписКонтр = новый СписокЗначений;
	СписКонтр.ЗагрузитьЗначения( Контрагенты.ВыгрузитьКолонку("Контрагент") );
	Запрос.УстановитьПараметр("СписКонтр", СписКонтр);

	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();

	Пока Выборка.Следующий() Цикл
		Движение = Движения.РезервРазрешения.Добавить();
		Движение.Период = Дата;
		Движение.КонтрагентРезерв = КонтрагентРезерв;
		Движение.Подразделение = Подразделение;
		Движение.ДатаОкончания = Дата - 1; // на 1 сек. раньше даты установки!
		
		Движение.Контрагент = выборка.Контрагент;
		Движение.ВариантКод = Выборка.ВариантКод;//все варианты закрываем!
		
		Движение.ВидТовара  = Выборка.ВидТовара;
		Движение.НоменклатурнаяГруппа = Выборка.НоменклатурнаяГруппа;
	КонецЦикла;
		
КонецПроцедуры


Процедура ОбработкаПроведения(Отказ, Режим)

	// регистр РазрешениеПоРезерву
	Движения.РезервРазрешения.Записывать = Истина;
	Движения.РезервРазрешения.Очистить();
	
	ЗакрытиеСтарыхУстановок(Движения);	

	Для Каждого ТекСтрокаКонтрагенты Из Контрагенты Цикл
		Для Каждого усл Из Условия Цикл
			
		Движение = Движения.РезервРазрешения.Добавить();
		Движение.Период = Дата;
		Движение.Подразделение    = Подразделение;
		Движение.КонтрагентРезерв = КонтрагентРезерв;
		Движение.ДатаОкончания    = '00010101'; // явно пропишем пустую дату!
		
		Движение.Контрагент 	  = ТекСтрокаКонтрагенты.Контрагент;
		
		Движение.ВариантКод = усл.ВариантКод; // фикс.название!
		Движение.ВидТовара  = усл.ВидТовара;
		Движение.НоменклатурнаяГруппа = усл.НоменклатурнаяГруппа;
		
		КонецЦикла;	
	КонецЦикла;

КонецПроцедуры
