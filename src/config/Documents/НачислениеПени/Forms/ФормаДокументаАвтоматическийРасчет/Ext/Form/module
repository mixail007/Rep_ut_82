
Процедура ОткрытьФайлНажатие(Элемент)

	ФормаФайлов = Справочники.ХранилищеДополнительнойИнформации.ПолучитьФорму("ФормаСпискаФайловИИзображений", ЭтаФорма);
	
	ФормаФайлов.ДополнительныеФайлы.Отбор.Объект.Использование                       = Истина;
	ФормаФайлов.ДополнительныеФайлы.Отбор.Объект.Значение                            = Ссылка;
	ФормаФайлов.ЭлементыФормы.ДополнительныеФайлы.НастройкаОтбора.Объект.Доступность = Ложь;
	ФормаФайлов.ЭлементыФормы.ДополнительныеФайлы.Колонки.Объект.Видимость           = Ложь;
	
	ОбязательныеОтборы = Новый Структура;
	
	ФормаФайлов.ЭлементыФормы.ПанельЗакладок.ТекущаяСтраница = ФормаФайлов.ЭлементыФормы.ПанельЗакладок.Страницы.Файлы;
	ФормаФайлов.ЭлементыФормы.ПанельЗакладок.Страницы.Изображения.Видимость = Ложь;
	ОбязательныеОтборы.Вставить("ВидДанных",Перечисления.ВидыДополнительнойИнформацииОбъектов.Файл);
	
	ОбязательныеОтборы.Вставить("Объект",Ссылка);
	
	ФормаФайлов.ОбязательныеОтборы = ОбязательныеОтборы;
	
	ФормаФайлов.Открыть();
	
КонецПроцедуры

Процедура ДоговорКонтрагентаНачалоВыбора(Элемент, СтандартнаяОбработка)
	
	СписокВидовДоговоров = Новый СписокЗначений;
	СписокВидовДоговоров.Добавить(Перечисления.ВидыДоговоровКонтрагентов.СПокупателем);
	СписокВидовДоговоров.Добавить(Перечисления.ВидыДоговоровКонтрагентов.СКомиссионером);
	СписокВидовДоговоров.Добавить(Перечисления.ВидыДоговоровКонтрагентов.СПоставщиком);
	СписокВидовДоговоров.Добавить(Перечисления.ВидыДоговоровКонтрагентов.СКомитентом);

	НачалоВыбораЗначенияДоговораКонтрагента(ЭтотОбъект, ЭтаФорма, Элемент, Контрагент, Элемент.Значение,
	                                        СписокВидовДоговоров , СтандартнаяОбработка, Неопределено);
	
КонецПроцедуры

Процедура ДействияФормыВыставитьИОтправитьСчет(Кнопка)
	
	Счет = Документы.СчетНаОплатуПокупателю.СоздатьДокумент();
	Счет.Дата = ТекущаяДата();
	Счет.Организация = Справочники.Организации.НайтиПоКоду("00001");
	Счет.СтруктурнаяЕдиница = Справочники.БанковскиеСчета.НайтиПоКоду("00334");
	Счет.Контрагент = Контрагент;
	Счет.ДоговорКонтрагента = Пени[0].ДоговорЗадолженности;
	Счет.Комментарий = "Сформирован из документа Начисление пени №" + СокрЛП(Номер) + " от " + Строка(Дата);
	Счет.УчитыватьНДС = Истина;
	Счет.СуммаВключаетНДС = Истина;
	Счет.КратностьВзаиморасчетов = 1;
	Счет.ВалютаДокумента = Справочники.Валюты.НайтиПоКоду("643");
	Счет.НачислениеПени = Ссылка;
	СтрУслуг = Счет.Услуги.Добавить();
	СтрУслуг.Номенклатура = Справочники.Номенклатура.НайтиПоКоду("9091939");
	СтрУслуг.Содержание = "Пени";
	СтрУслуг.Количество = 1;
	СтрУслуг.Цена = СуммаДокумента;
	СтрУслуг.Сумма = СуммаДокумента;
	СтрУслуг.СтавкаНДС = СтавкаНДСнаДату(Счет.Дата); //+++ 09.01.2019 Перечисления.СтавкиНДС.НДС18;
	РассчитатьСуммуНДСТабЧасти(СтрУслуг, Счет);
	РассчитатьСуммуТабЧасти(СтрУслуг, Счет);
	Счет.Записать(РежимЗаписиДокумента.Запись);
	
	УЗ =  ПолучитьЗначениеПоУмолчанию(глТекущийПользователь, "ОсновнаяУчетнаяЗапись");
	Если НЕ ЗначениеЗаполнено(УЗ) тогда
		УЗ = Справочники.УчетныеЗаписиЭлектроннойПочты.НайтиПоНаименованию("no-reply@yst76.ru");
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	КонтактнаяИнформация.Представление
	|ИЗ
	|	РегистрСведений.КонтактнаяИнформация КАК КонтактнаяИнформация
	|ГДЕ
	|	КонтактнаяИнформация.Объект = &Объект
	|	И КонтактнаяИнформация.Тип = &Тип
	|	И КонтактнаяИнформация.Вид = &Вид";
	
	Запрос.УстановитьПараметр("Объект", Контрагент);
	Запрос.УстановитьПараметр("Тип", Перечисления.ТипыКонтактнойИнформации.АдресЭлектроннойПочты);
	Запрос.УстановитьПараметр("Вид", Справочники.ВидыКонтактнойИнформации.АдресЭлектроннойПочтыДляОбменаДокументами);
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	АдресЭлПочтыКонтрагента = "";
	Если Выборка.Следующий() тогда
		АдресЭлПочтыКонтрагента = СокрЛП(выборка.Представление);
	Иначе
		Предупреждение("У контрагента "+строка(Контрагент)+" не задан эл.адрес.
		|Отправка письма невозможна",30);
		Возврат;
	КонецЕсли;
	
	Ответ = КодВозвратаДиалога.Нет;
	Если Вопрос("Вы действительно хотите отправить ""Счет на оплату пени""
		|для "+строка(Контрагент)+"
		|на адрес эл.почты: "+АдресЭлПочтыКонтрагента+"?", РежимДиалогаВопрос.ДаНет, 30) = КодВозвратаДиалога.Нет тогда
		Возврат;
	КонецЕсли;
	
	
	Состояние("Идет отправка письма...");  i=0;
	ВременнаяПапка = КаталогВременныхФайлов(); 
	
	СписокФайловВложений = Новый СписокЗначений;
	//Печатается 1-я форма
	ИмяФайлаСообщения = "Счет_ПЕНИ_№"+СтрЗаменить(СокрЛП(Счет.Номер),"/","_")+".xls";
	ТабличныйДокументОбъект = Счет.ПечатьСчетаЗаказа("Счет"); //Счет на оплату
	
	ТабличныйДокументОбъект.Записать(временнаяПапка+ИмяФайлаСообщения,ТипФайлаТабличногоДокумента.XLS);
	СписокФайловВложений.Добавить(ВременнаяПапка+ИмяФайлаСообщения);
	
		ТекстСообщения0 ="   Добрый день,
	|
	|Высылаем Вам копию Счета № "+Строка(Счет.Номер)+" от "+Формат(Счет.Дата,"ДЛФ=DD")+"
	|
	|
	|С уважением,
	|"+?(ЗначениеЗаполнено(ДоговорКонтрагента.ОтветственноеЛицо), "менеджер "+ДоговорКонтрагента.ОтветственноеЛицо.Наименование, Ответственный.Наименование)+",
	|
	|ЗАО Торговая Компания ""Яршинторг"", 
	|юр./факт.адрес: 150044, Ярославская обл, Ярославль г, Базовая ул, дом № 3, стр.2
	|тел./факс: (4852) 200-200, 67-11-67
	|Web-сайт : http://www.yst.ru
	|";
	
	
	ИПП=Новый ИнтернетПочтовыйПрофиль;
	ИПП.АдресСервераSMTP=УЗ.SMTPСервер;
	ИПП.ПортSMTP=УЗ.ПортSMTP;
	Если УЗ.ТребуетсяSMTPАутентификация Тогда
		ИПП.АутентификацияSMTP = СпособSMTPАутентификации.ПоУмолчанию;
		ИПП.ПарольSMTP         = УЗ.ПарольSMTP;
		ИПП.ПользовательSMTP   = УЗ.ЛогинSMTP;
	Иначе
		ИПП.АутентификацияSMTP = СпособSMTPАутентификации.БезАутентификации;
		ИПП.ПарольSMTP         = "";
		ИПП.ПользовательSMTP   = "";
	КонецЕсли;
	Письмо=Новый ИнтернетПочтовоеСообщение;
	Письмо.Отправитель=УЗ.АдресЭлектроннойПочты;
	
	i = Найти(АдресЭлПочтыКонтрагента,";"); j=Найти(АдресЭлПочтыКонтрагента, ",");
	k=?(i>0 и i>j,  i, ?(j>0 и j>i, j, 0) );
	
	Если i=0 и j=0 тогда
		Письмо.Получатели.Добавить(АдресЭлПочтыКонтрагента);
	иначе
		АдрОстаток = СокрЛП(АдресЭлПочтыКонтрагента);
		пока (k>0) цикл
			Адр1 = Лев(АдрОстаток, k-1);
			Если СокрЛП(Адр1)<>"" и Найти(Адр1,"@")>0 и Найти(Адр1,".")>0 тогда
				Письмо.Получатели.Добавить(Адр1);
			иначе
				Сообщить("Адрес '"+Адр1+"' не содержит @ или .");
			КонецЕсли;
			АдрОстаток = Прав(АдрОстаток, стрДлина(АдрОстаток)-k);
			i = Найти(АдрОстаток,";"); j=Найти(АдрОстаток, ",");
			k=?(i>0 и i>j,  i, ?(j>0 и j>i, j, 0) );
		КонецЦикла;
		Если СокрЛП(АдрОстаток)<>"" и Найти(АдрОстаток,"@")>0 и Найти(АдрОстаток,".")>0 тогда
			Письмо.Получатели.Добавить(АдрОстаток);
		КонецЕсли;
		
	КонецЕсли; //+++ )
	
	Если ЗначениеЗаполнено(СписокФайловВложений) И СписокФайловВложений.Количество()>0 Тогда
		Для Каждого ТекАдр Из СписокФайловВложений Цикл
			Письмо.Вложения.Добавить(ТекАдр.Значение);
		КонецЦикла;
	КонецЕсли;
	Письмо.Тема="Счет от ЗАО ТК Яршинторг";
	
	
	Письмо.ИмяОтправителя ="ЗАО ТК ""Яршинторг"", г.Ярославль";
	Письмо.Организация ="ЗАО ТК ""Яршинторг"", г.Ярославль";
	Письмо.Тексты.Добавить(ТекстСообщения0,ТипТекстаПочтовогоСообщения.простойТекст);
	
	Почта=Новый ИнтернетПочта;
	Почта.Подключиться(ИПП);
	
	Попытка
		Почта.Послать(Письмо);
		Почта.Отключиться();
		Предупреждение("Отправка файла "+ИмяФайлаСообщения+" 
		|на эл.адрес: "+АдресЭлПочтыКонтрагента+" завершена");
		ВыставленИОтправленСчет = Истина;
		ЭтотОбъект.Записать();
	Исключение
		сообщить("Не удалось отправить письмо! "+ОписаниеОшибки(), СтатусСообщения.Внимание);
	КонецПопытки;
	
	Состояние(" ");
	
КонецПроцедуры

Процедура ДействияФормыСтруктураПодчиненностиДокумента(Кнопка)
	ПоказатьСтруктуруПодчиненностиДокумента(Ссылка);
КонецПроцедуры

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	
	Если НЕ Пени.Итог("Пени") = 0 Тогда
		Если НЕ СуммаДокумента = Пени.Итог("Пени") Тогда
			Сообщить("Из-за округления различаются сумма документа и расшифровка начислений по заказм." + Символы.ПС + "Необходимо скорректировать суммы в расшифровке вручную на " + Строка(СуммаДокумента - Пени.Итог("Пени")) + " рублей.");
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура ПриОткрытии()
	
	ЭтаФорма.ТолькоПросмотр = Истина;
	
КонецПроцедуры

Процедура ДетальныйРасчетПоДнямПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки)
	
	ОформлениеСтроки.Ячейки.СуммаРеализации.УстановитьТекст(ДанныеСтроки.РеализацияТоваровУслуг.СуммаДокумента);
	
КонецПроцедуры


