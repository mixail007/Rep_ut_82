
Процедура ДействияФормыЗависшиеРезервы(Кнопка)
	
	Записать(РежимЗаписиДокумента.ОтменаПроведения);
	Резервирование.Очистить();
	Запрос = Новый Запрос;
	Запрос.Текст = "
		|Выбрать Номенклатура, ДокументРезерва, Сумма(КоличествоОст) КоличествоОстаток
		|ИЗ
		|(
		|Выбрать Номенклатура, ДокументРезерва, 	(Выбор 
		|										Когда 
		|												ВидДвижения = &ВидДвижения 
		|										Тогда -Количество
		|										Иначе Количество 
		|									Конец ) Как КоличествоОст											
		|Из РегистрНакопления.Резерв
		|Где 
		|ДобавитьКДате(ДокументРезерва.Дата,ДЕНЬ,ДокументРезерва.ДлинаРезерва)<&Дата
		|И Регистратор<>&Ссылка
		|)как ПЗ
		|Сгруппировать по 
		|ДокументРезерва,Номенклатура ";
	
	Запрос.УстановитьПараметр("Дата",Дата);	
	Запрос.УстановитьПараметр("ВидДвижения",ВидДвиженияНакопления.Расход);
	Запрос.УстановитьПараметр("Ссылка",Ссылка);
	Выб = Запрос.Выполнить().Выбрать();
	
	Пока Выб.Следующий() Цикл                         
		
		Если (Выб.КоличествоОстаток<>0) Тогда 
			Стр = Резервирование.Добавить();
			Стр.ВидДвижения = ?(Выб.КоличествоОстаток<0,Перечисления.ВидУстановкиРезерва.Установка,Перечисления.ВидУстановкиРезерва.Снятие);
			Стр.ДлинаРезерва = Выб.ДокументРезерва.ДлинаРезерва;
			Стр.ДокументРезерва	= Выб.ДокументРезерва;
			Стр.Количество = ?(Выб.КоличествоОстаток>0,Выб.КоличествоОстаток,-Выб.КоличествоОстаток);
			Стр.Номенклатура = Выб.Номенклатура;
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ДействияФормыВсеРезервы(Кнопка)

	Записать(РежимЗаписиДокумента.ОтменаПроведения);
	Резервирование.Очистить();
	Запрос = Новый Запрос;
	Запрос.Текст = "
		|Выбрать Номенклатура,ДокументРезерва,Сумма(КоличествоОстаток) как КоличествоОстаток
		|Из
		|(
		|Выбрать Номенклатура, ДокументРезерва, Регистратор,
		|	(Выбор Когда ВидДвижения = &ВидДвижения
		|	Тогда 	-Количество
		|		Иначе 
		|			Количество
		|	Конец) Как КоличествоОстаток
		|	Из РегистрНакопления.Резерв
		|) Как Резерв
		|Где Регистратор<>&Ссылка
		|и КоличествоОстаток <>0
		|Сгруппировать по ДокументРезерва,Номенклатура";
		
	Запрос.УстановитьПараметр("Ссылка",Ссылка);	
	Запрос.УстановитьПараметр("ВидДвижения",ВидДвиженияНакопления.Расход);
	Выб = Запрос.Выполнить().Выбрать();
	
	Пока Выб.Следующий() Цикл                         
		
		Если (Выб.КоличествоОстаток<>0) Тогда 
			Стр = Резервирование.Добавить();
			Стр.ВидДвижения = ?(Выб.КоличествоОстаток<0,Перечисления.ВидУстановкиРезерва.Установка,Перечисления.ВидУстановкиРезерва.Снятие);
			Стр.ДлинаРезерва = Выб.ДокументРезерва.ДлинаРезерва;
			Стр.ДокументРезерва	= Выб.ДокументРезерва;
			Стр.Количество = ?(Выб.КоличествоОстаток>0,Выб.КоличествоОстаток,-Выб.КоличествоОстаток);
			Стр.Номенклатура = Выб.Номенклатура;
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

Процедура КоманднаяПанель1ВыбратьРезерв(Кнопка)
	
	Форма = ПолучитьФорму("ОтборРезервов");
	Форма.Ссылка = Ссылка;
	Список = Форма.ОткрытьМодально();
	
	Если Список<>Неопределено Тогда 
		Резервирование.Очистить();
		
		Для Каждого СтрСп из Список Цикл                         
			
			Если (СтрСп.КоличествоОстаток<>0) Тогда 
				Стр = Резервирование.Добавить();
				Стр.ВидДвижения = ?(СтрСп.КоличествоОстаток<0,Перечисления.ВидУстановкиРезерва.Установка,Перечисления.ВидУстановкиРезерва.Снятие);
				Стр.ДлинаРезерва = СтрСп.ДокументРезерва.ДлинаРезерва;
				Стр.ДокументРезерва	= СтрСп.ДокументРезерва;
				Стр.Количество = ?(СтрСп.КоличествоОстаток>0,СтрСп.КоличествоОстаток,-СтрСп.КоличествоОстаток);
				Стр.Номенклатура = СтрСп.Номенклатура;
			КонецЕсли;
			
		КонецЦикла;
	КонецЕсли;
		
КонецПроцедуры
