
Процедура ОсновныеДействияФормыВыполнить(Кнопка)
	
	Запрос = новый Запрос;
	Запрос.Текст = "
		|Выбрать Номенклатура, ДокументРезерва, Сумма(КоличествоОст) КоличествоОстаток
		|ИЗ
		|(
		|Выбрать Номенклатура, ДокументРезерва, 	(Выбор 
		|												Когда 
		|												ВидДвижения = &ВидДвижения 
		|												Тогда -Количество
		|												Иначе Количество 
		|											Конец ) Как КоличествоОст											
		|Из РегистрНакопления.Резерв
		|Где 		
		|ДокументРезерва.Ответственный в иерархии (&Ответственный)
		|И
		|Номенклатура в иерархии (&Номенклатура)";
		
	Если  (Контрагент<>Справочники.Контрагенты.ПустаяСсылка()) Тогда 
		Запрос.Текст = Запрос.Текст + "	
		|И ДокументРезерва.Контрагент в иерархии (&Контрагент)";
	КонецЕсли;
		
	Если (ПоЗаказу<>Неопределено) Тогда 
		Запрос.Текст = Запрос.Текст + "
		|И ДокументРезерва=&Заказ";
	КонецЕсли;
	
	Если (НаДату<>'0001-01-01') и (не Зависшие) Тогда 
		Запрос.Текст = Запрос.Текст + "
		|И ДокументРезерва.Дата >=&ДатаРезНачало И ДокументРезерва.Дата <=&ДатаРезКонец";
	КонецЕсли;
		
	Если (Зависшие = Истина) Тогда 
		Запрос.Текст = Запрос.Текст + "
		|И ДобавитьКДате(ДокументРезерва.Дата,ДЕНЬ,ДокументРезерва.ДлинаРезерва+1)<&ДатаРезКонец";
	КонецЕсли;	
	
	Запрос.Текст = Запрос.Текст + "
		|И Регистратор<>&Ссылка
		|)как ПЗ
		|Сгруппировать по 
		|ДокументРезерва,Номенклатура";
		
	Если (ДокументРезерва = 1) Тогда 
		Запрос.Текст = Запрос.Текст + "
		|Упорядочить по ДокументРезерва,Номенклатура";
	Иначе 
		Запрос.Текст = Запрос.Текст + "
		|Упорядочить по Номенклатура.Наименование,ДокументРезерва";
	КонецЕсли;	
		
	Запрос.УстановитьПараметр("Ответственный",Ответственный);	
	Запрос.УстановитьПараметр("Контрагент",Контрагент);
	Запрос.УстановитьПараметр("Номенклатура",Номенклатура);
	Запрос.УстановитьПараметр("ВидДвижения",ВидДвиженияНакопления.Расход);
	Запрос.УстановитьПараметр("Дата",Ссылка.Дата);
	Запрос.УстановитьПараметр("Ссылка",Ссылка);
	Запрос.УстановитьПараметр("Заказ",ПоЗаказу);
	Запрос.УстановитьПараметр("ДатаРезНачало",НачалоДня(НаДату));
	Запрос.УстановитьПараметр("ДатаРезКонец",КонецДня(НаДату));
	Таблица = Запрос.Выполнить().Выгрузить();
	Закрыть(Таблица);
	

КонецПроцедуры
