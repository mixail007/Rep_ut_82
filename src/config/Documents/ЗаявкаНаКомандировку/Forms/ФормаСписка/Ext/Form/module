
Процедура ПриОткрытии()
	
	//	УстановитьОтборВЖурналеДокументов(ДокументСписок.Отбор, ЭлементыФормы.ДокументСписок);
		
	Если ПолучитьЗначениеПоУмолчанию(ПараметрыСеанса.ТекущийПользователь, "УчетТолькоПоПодразделениюПользователя") Тогда
		
		ДокументСписок.Отбор["Подразделение"].Использование = Истина;
				
		//+++( 27.05.2015 - отбор по 1 или нескольким подразделениям Ект и Обособка Ект
		ОдноПодразделение = ?(РольДоступна("Партнер"), ПолучитьЗначениеПоУмолчанию(ПараметрыСеанса.ТекущийПользователь, "ОсновноеПодразделение"), ПараметрыСеанса.ТекущийПользователь.ОсновноеПодразделение);
		списокПодразделенийПользователя = получитьСписокРазрешенныхОбъектовПользователя(ПараметрыСеанса.ТекущийПользователь, "Подразделения"); 
		если списокПодразделенийПользователя.Количество()=0 тогда // как было
			Отбор["Подразделение"].ВидСравнения = ВидСравнения.Равно;
			Отбор["Подразделение"].Значение = ОдноПодразделение;
		иначе	
			Отбор["Подразделение"].ВидСравнения = ВидСравнения.ВСписке;
			Отбор["Подразделение"].Значение = списокПодразделенийПользователя;
		КонецЕсли;
		//+++)
				
		ЭлементыФормы.ДокументСписок.НастройкаОтбора["Подразделение"].Доступность = Ложь;
	
	КонецЕсли;
	
	флУтверждения = ПолучитьЗначениеПоУмолчанию(глТекущийПользователь, "РазрешитьУтверждатьЗаявки")
	или (ПараметрыСеанса.ТекущийПользователь = ПараметрыСеанса.ТекущийПользователь.ОсновноеПодразделение.Руководитель);
	Если не флУтверждения тогда
	    Отбор["Ответственный"].ВидСравнения = ВидСравнения.Равно;
		Отбор["Ответственный"].Значение = глТекущийПользователь;
		Отбор["Ответственный"].Использование = истина;
		ЭлементыФормы.ДокументСписок.НастройкаОтбора["Ответственный"].Доступность = Ложь;
	КонецЕсли;
		
КонецПроцедуры

Процедура ДействияФормыСтруктураПодчиненностиДокумента(Кнопка)
	
	Если ЭлементыФормы.ДокументСписок.ТекущиеДанные = Неопределено тогда
		Возврат
	КонецЕсли;
	
	ПоказатьСтруктуруПодчиненностиДокумента(ЭтаФорма.ЭлементыФормы.ДокументСписок.ТекущаяСтрока);

КонецПроцедуры


Процедура ДокументСписокПриПолученииДанных(Элемент, ОформленияСтрок)
	ТекДата = ТекущаяДата();
	для каждого стр1 из ОформленияСтрок цикл
		стр2 = стр1.ДанныеСтроки;
		
	Если стр2.ДатаПрибытия < ТекДата тогда	
		стр1.ЦветТекста =  WebЦвета.ГрифельноСерый;
	Иначе	
		Если стр2.Состояние = перечисления.СостоянияОбъектов.Утвержден тогда
			стр1.ЦветФона = webЦвета.СветлоЗеленый;
		ИначеЕсли стр2.Состояние = перечисления.СостоянияОбъектов.Согласован тогда
			стр1.ЦветФона = webЦвета.СветлоЖелтый;
		ИначеЕсли стр2.Состояние = перечисления.СостоянияОбъектов.Отклонен тогда
			стр1.ЦветФона = webЦвета.светлоРозовый;
		КонецЕсли;
		
		Если ЕстьЗаявкаДС(стр2.Ссылка) тогда
			стр1.ЦветТекста =  WebЦвета.ТемноСиний;
			стр1.Шрифт = Новый Шрифт(,, Истина); // жирный
		КонецЕсли;	
	КонецЕсли;
	
	КонецЦикла;	
КонецПроцедуры


Функция ЕстьЗаявкаДС(Заявка)

	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ 
				   |	ЗаявкаНаРасходованиеСредствРасшифровкаПлатежа.Ссылка
	               |ИЗ
	               |	Документ.ЗаявкаНаРасходованиеСредств.РасшифровкаПлатежа КАК ЗаявкаНаРасходованиеСредствРасшифровкаПлатежа
	               |ГДЕ
	               |	(ВЫРАЗИТЬ(ЗаявкаНаРасходованиеСредствРасшифровкаПлатежа.Сделка КАК Документ.ЗаявкаНаКомандировку)) = &Сделка
	               |	И ЗаявкаНаРасходованиеСредствРасшифровкаПлатежа.Сделка.Дата >= &Дата
	               |	И ЗаявкаНаРасходованиеСредствРасшифровкаПлатежа.Ссылка.Проведен";

	Запрос.УстановитьПараметр("Дата", НачалоДня(Заявка.Дата) ); // не раньше чем Заявка на командировку!
	Запрос.УстановитьПараметр("Сделка", Заявка);

	Результат = Запрос.Выполнить();
	Рез = не результат.Пустой();	  
	возврат рез;
	
КонецФункции

