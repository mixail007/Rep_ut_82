////////////////////////////////////////////////////////////////////////////////
// ПЕРЕМЕННЫЕ МОДУЛЯ

Перем мСтараяТиповаяАнкета; // хранит старое значение элемент "Типовая анкета"
Перем мТекущаяДатаДокумента; // Хранит последнюю установленную дату документа - для проверки перехода документа в другой период
Перем ТаблицаВопросовОтветовПоАнкете;

////////////////////////////////////////////////////////////////////////////////
// ВСПОМОГАТЕЛЬНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ 

// Управление колонкой "Ответ". В  зависимости от вопроса, поведение колонки "Ответ"
//  будет разным.
//
// Параметры
//  ВыбраннаяСтрока  – Строка табличной части – строка, в которой необходимо ответить 
//                 на вопрос.
//  Отказ		  – Булево – отказ от ввода непосредственно в строке.
//
Процедура ПодоготовитьПолучениеОтвета(ВыбраннаяСтрока, Отказ)
	
	Если ВыбраннаяСтрока.Вопрос.ТипВопроса = Перечисления.ТипВопросаАнкеты.СправочникСсылка_ВариантыОтветов_Несколько или 
		 ВыбраннаяСтрока.Вопрос.ТипВопроса = Перечисления.ТипВопросаАнкеты.Табличный тогда
		 Отказ = Истина;
		 Возврат;
	КонецЕсли;
	ВопросыКонтактнаяИнформация = Новый СписокЗначений();
	ВопросыКонтактнаяИнформация.Добавить(Перечисления.ТипВопросаАнкеты.Адрес);
	ВопросыКонтактнаяИнформация.Добавить(Перечисления.ТипВопросаАнкеты.АдресЭлектроннойПочты);
	ВопросыКонтактнаяИнформация.Добавить(Перечисления.ТипВопросаАнкеты.ВебСтраница);
	ВопросыКонтактнаяИнформация.Добавить(Перечисления.ТипВопросаАнкеты.Другое);
	//ВопросыКонтактнаяИнформация.Добавить(Перечисления.ТипВопросаАнкеты.МестныйТелефон);
	//ВопросыКонтактнаяИнформация.Добавить(Перечисления.ТипВопросаАнкеты.ПроизвольныйАдрес);
	ВопросыКонтактнаяИнформация.Добавить(Перечисления.ТипВопросаАнкеты.Телефон);
	
	ТипВопроса = ВыбраннаяСтрока.Вопрос.ТипЗначения;
	Если ВопросыКонтактнаяИнформация.НайтиПоЗначению(ВыбраннаяСтрока.Вопрос.ТипВопроса) <> Неопределено Тогда
		
		Если ВыбраннаяСтрока.Вопрос.ТипВидКонтакнойИнформации.Тип = Перечисления.ТипыКонтактнойИнформации.Адрес Тогда
			
			ФормаРедактированияОтвета = ПолучитьФорму("ФормаВводаОтветаАдрес");
			ФормаРедактированияОтвета.ТиповойОтвет = ВыбраннаяСтрока.ТиповойОтвет;
			ФормаРедактированияОтвета.ОткрытьМодально();
			ВыбраннаяСтрока.ТиповойОтвет = ФормаРедактированияОтвета.ТиповойОтвет;
			Отказ = Истина;
			
		ИначеЕсли ВыбраннаяСтрока.Вопрос.ТипВидКонтакнойИнформации.Тип = Перечисления.ТипыКонтактнойИнформации.Телефон Тогда
			
			ФормаРедактированияОтвета = ПолучитьФорму("ФормаВводаОтветаТелефон");
			ФормаРедактированияОтвета.ТиповойОтвет = ВыбраннаяСтрока.ТиповойОтвет;
			ФормаРедактированияОтвета.ОткрытьМодально();
			ВыбраннаяСтрока.ТиповойОтвет = ФормаРедактированияОтвета.ТиповойОтвет;
			Отказ = Истина;
			
		Иначе
			
			ЭлементыФормы.ВопросыИОтветы.ТекущаяКолонка.ЭлементУправления.КнопкаВыбора  = Ложь;
			ЭлементыФормы.ВопросыИОтветы.ТекущаяКолонка.ЭлементУправления.КнопкаОчистки = Ложь;
			
		КонецЕсли;
		
	ИначеЕсли ТипВопроса.СодержитТип(Тип("Булево")) Тогда
		
		Отказ = Истина;  
		ВыбраннаяСтрока.ТиповойОтвет = НЕ ВыбраннаяСтрока.ТиповойОтвет;
		
	ИначеЕсли ТипВопроса.СодержитТип(Тип("Строка")) Тогда
		Если ВыбраннаяСтрока.Вопрос.ТипВопроса = Перечисления.ТипВопросаАнкеты.Текст тогда
			ФормаРедактированияОтвета = ПолучитьФорму("ФормаВводаОтветаТекст");
			ФормаРедактированияОтвета.ТиповойОтвет        = ВыбраннаяСтрока.ТиповойОтвет;
			ФормаРедактированияОтвета.ОткрытьМодально();
			ВыбраннаяСтрока.ТиповойОтвет = ФормаРедактированияОтвета.ТиповойОтвет;
			Отказ = Истина;
		Иначе
			ЭлементыФормы.ВопросыИОтветы.ТекущаяКолонка.ЭлементУправления.КнопкаВыбора  = Ложь;
			ЭлементыФормы.ВопросыИОтветы.ТекущаяКолонка.ЭлементУправления.КнопкаОчистки = Ложь;
		КонецЕсли;
	ИначеЕсли ТипВопроса.СодержитТип(Тип("Число")) или ТипВопроса.СодержитТип(Тип("Дата")) Тогда
		
		ЭлементыФормы.ВопросыИОтветы.ТекущаяКолонка.ЭлементУправления.КнопкаВыбора  = Истина;
		ЭлементыФормы.ВопросыИОтветы.ТекущаяКолонка.ЭлементУправления.КнопкаОчистки = Ложь;
		
	ИначеЕсли ТипВопроса.СодержитТип(Тип("СправочникСсылка.ВариантыОтветовОпросов")) и ВыбраннаяСтрока.Вопрос.ТипВопроса <> Перечисления.ТипВопросаАнкеты.СправочникСсылка_ВариантыОтветов_Несколько Тогда
		
		Отказ = Истина;
		
		СтруктураПоиска = Новый Структура("Вопрос");
		СтруктураПоиска.Вопрос = ВыбраннаяСтрока.Вопрос;
		МассивОтветов = ТаблицаВопросовОтветовПоАнкете.НайтиСтроки(СтруктураПоиска);
		
		ФормаРедактированияОтвета = ПолучитьФорму("ФормаВводаОтветаСписок");
		ФормаРедактированияОтвета.ФормулировкаВопроса = ВыбраннаяСтрока.Вопрос.ПолнаяФормулировка;
		ФормаРедактированияОтвета.МассивОтветов 	  = МассивОтветов;
		ФормаРедактированияОтвета.ТиповойОтвет        = ВыбраннаяСтрока.ТиповойОтвет;
		ФормаРедактированияОтвета.РазвернутыйОтвет    = ВыбраннаяСтрока.Ответ;
		
		ФормаРедактированияОтвета.ОткрытьМодально();
		ВыбраннаяСтрока.ТиповойОтвет = ФормаРедактированияОтвета.ТиповойОтвет;
		ВыбраннаяСтрока.Ответ        = ФормаРедактированияОтвета.РазвернутыйОтвет;
		
	Иначе
		
		ЭлементыФормы.ВопросыИОтветы.ТекущаяКолонка.ЭлементУправления.КнопкаВыбора  = Истина;
		ЭлементыФормы.ВопросыИОтветы.ТекущаяКолонка.ЭлементУправления.КнопкаОчистки = Истина;
		
	КонецЕсли;                                     
	
КонецПроцедуры

// Функция проверяет пустая строка или нет.
//
// Параметры
//  ВыбСтрока	 – Строка – проверяемая строка.
//                 
//  ПризнакЗапятой  – Булево  
//
// Возвращаемое значение:
//   Строка   – пустая строка.
//
Функция ПроверкаПустойСтроки(ВыбСтрока, ПризнакЗапятой = Истина)
	
	Если ПустаяСтрока(ВыбСтрока) Тогда
		Возврат "";
	Иначе
		Возврат ?(ПризнакЗапятой,",","")+" ";
	КонецЕсли; 
	
КонецФункции // ПроверкаПустойСтроки()

// Функция подготавливает таблицу с вопросами и возможными ответами к ней.
//
// Параметры
//  Анкета  – СправочникСсылка.ТиповыеАнкеты – анкета, по которой собираются
//                  данные.
//
// Возвращаемое значение:
//   ТаблицаЗначений   – таблица с вопросами и возможными ответами.
//
Функция ЗапросПоАнкете(Анкета)
	
	ЗапросКАнкете = Новый Запрос();
	ЗапросКАнкете.УстановитьПараметр("Анкета", Анкета);
	
    ТекстЗапроса = 
	"ВЫБРАТЬ
	|	ТиповыеАнкетыВопросыАнкеты.Вопрос,
	|	ВариантыОтветовОпросов.ТребуетРазвернутыйОтвет,
	|	ВариантыОтветовОпросов.Ссылка КАК Ответ
	|ИЗ
	|	Справочник.ТиповыеАнкеты.ВопросыАнкеты КАК ТиповыеАнкетыВопросыАнкеты
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВариантыОтветовОпросов КАК ВариантыОтветовОпросов
	|		ПО ТиповыеАнкетыВопросыАнкеты.Вопрос = ВариантыОтветовОпросов.Владелец
	|
	|ГДЕ
	|	ТиповыеАнкетыВопросыАнкеты.Ссылка = &Анкета";
	
	ЗапросКАнкете.Текст = ТекстЗапроса;

	ТаблицаВопросовОтветовПоАнкете = Новый ТаблицаЗначений;
	ТаблицаВопросовОтветовПоАнкете = ЗапросКАнкете.Выполнить().Выгрузить();
	
	Возврат  ТаблицаВопросовОтветовПоАнкете;
	
КонецФункции // ЗапросПоАнкете()

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ

// Процедура - обработчик события "ПриОткрытии" формы
//
Процедура ПриОткрытии()
	
	Если ЭтоНовый() Тогда // проверить объект на то, что он еще не внесен в ИБ
		
		// Заполнить реквизиты значениями по умолчанию.
		ЗаполнитьШапкуДокумента(ЭтотОбъект, глТекущийПользователь);
		УстановитьНомерДокумента(ЭтотОбъект);
		
	КонецЕсли;
	//Если ОбрабатыватьАвтоматически Тогда
	//	ЭлементыФормы.ВажнаяНадпись.Видимость = Истина;
	//	ЭлементыФормы.ВопросыИОтветы.Верх = ЭлементыФормы.ВопросыИОтветы.Верх + 21;
	//	ЭлементыФормы.ВопросыИОтветы.Высота = ЭлементыФормы.ВопросыИОтветы.Высота - 21;
	//КонецЕсли;
	
	// Вывести в заголовке формы статус документа (новый, не проведен, проведен).
	УстановитьЗаголовокФормыДокумента(, ЭтотОбъект, ЭтаФорма);
	
	// Запомнить текущие значения реквизитов формы.
	мТекущаяДатаДокумента = Дата;
	мСтараяТиповаяАнкета = ТиповаяАнкета;
	ТаблицаВопросовОтветовПоАнкете = ЗапросПоАнкете(ТиповаяАнкета);
	
КонецПроцедуры // ПриОткрытии()

// Процедура - обработчик события "ПослеЗаписи" формы.
//
Процедура ПослеЗаписи()
	
	// Вывести в заголовке формы статус документа (новый, не проведен, проведен).
	УстановитьЗаголовокФормыДокумента(, ЭтотОбъект, ЭтаФорма);
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ДЕЙСТВИЯ КОМАНДНЫХ ПАНЕЛЕЙ ФОРМЫ

// Формирует печатную форму документа
// 
// Параметры
//  Кнопка       - Элемент управления
//
Процедура КоманднаяПанельФормыДействиеПечать(Кнопка)
	
	Если ЭтоНовый() или Модифицированность() Тогда
		Вопрос = "Перед печатью необходимо записать документ. Записать?";
		Ответ  = Вопрос(Вопрос, РежимДиалогаВопрос.ОКОтмена);
		Если Ответ = КодВозвратаДиалога.ОК Тогда
			ЗаписатьВФорме();
		Иначе
			Возврат;
		КонецЕсли;
	КонецЕсли;
	Печать(Кнопка.Текст);
	
КонецПроцедуры

// Процедура вызывается при выборе пункта подменю "Движения документа по регистрам" меню "Перейти".
// командной панели формы. Процедура отрабатывает печать движений документа по регистрам.
//
Процедура ДействияФормыДвиженияДокументаПоРегистрам(Кнопка)

	НапечататьДвиженияДокумента(Ссылка);

КонецПроцедуры // ДействияФормыДвиженияДокументаПоРегистрам()

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ РЕКВИЗИТОВ ШАПКИ

// Процедура - обработчик события "ПриИзменении" поля ввода даты документа
//
Процедура ДатаПриИзменении(Элемент = Неопределено)
	
	ПроверитьНомерДокумента(ДокументОбъект, мТекущаяДатаДокумента);
	
	мТекущаяДатаДокумента = Дата;
	
КонецПроцедуры // ДатаПриИзменении

//  Процедура заполняет список вопросов по выбранной пользователем "Типовой анкете"
//
// Параметры:
//  Элемент      - элемент формы, который отображает типовую анкету.
//
Процедура ТиповаяАнкетаПриИзменении(Элемент)
	
	Если НЕ ЗначениеНеЗаполнено(ТиповаяАнкета) тогда
		Если Вопросы.Количество() > 0 тогда
			Если Вопрос("Список вопросов и ответов будет очищен и заполнен новыми данными! Продолжить?", РежимДиалогаВопрос.ДаНет,, КодВозвратаДиалога.Нет, ) = КодВозвратаДиалога.Да тогда
				Вопросы.Очистить();
				СоставнойОтвет.Очистить();
			Иначе
				ТиповаяАнкета = мСтараяТиповаяАнкета;
				Возврат;
			КонецЕсли;
		КонецЕсли;
		ЗаполнитьВопросыАнкеты(Элемент.Значение);
		ТаблицаВопросовОтветовПоАнкете = ЗапросПоАнкете(Элемент.Значение);
	КонецЕсли;
	мСтараяТиповаяАнкета = ТиповаяАнкета;
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ ТАБЛИЧНОГО ПОЛЯ ТЧ "ВОПРОСЫ И ОТВЕТЫ"

// Процедура - обработчик события "ПередНачаломИзменения" табличного поля.
Процедура ВопросыИОтветыПередНачаломИзменения(Элемент, Отказ)
	
	Если Элемент.ТекущаяКолонка.Имя = "ТиповойОтвет" Тогда
		ПодоготовитьПолучениеОтвета(Элемент.ТекущаяСтрока, Отказ);
	КонецЕсли;
	
КонецПроцедуры

// Процедура - обработчик события "ПриВыводеСтроки" табличного поля.
// сделаем поле развернутого ответа доступным тогда, когда это требует типовой ответ
//
// Параметры:
//  Элемент      - табличное поле, которое отображает т.ч.
//  
Процедура ВопросыИОтветыПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки)
	
	//Если ЭлементыФормы.ВопросыИОтветы.ТекущиеДанные <> Неопределено тогда
		Если Элемент.Колонки.ТиповойОтвет.Видимость тогда
			Если ДанныеСтроки.Вопрос.ТипВидКонтакнойИнформации.Тип = Перечисления.ТипыКонтактнойИнформации.Адрес тогда
				
				МассивПолей = РазложитьСтрокуВМассивПодстрок(ДанныеСтроки.ТиповойОтвет, "¤");
				Если МассивПолей.Количество() > 1 тогда
					Регион  = МассивПолей[1];
				КонецЕсли;
				Если МассивПолей.Количество() > 2 тогда
					Район   = МассивПолей[2];
				КонецЕсли;
				Если МассивПолей.Количество() > 3 тогда
					Город   = МассивПолей[3];
				КонецЕсли;
				Если МассивПолей.Количество() > 4 тогда
					НаселенныйПункт = МассивПолей[4];
				КонецЕсли;
				Если МассивПолей.Количество() > 5 тогда
					Улица   = МассивПолей[5];
				КонецЕсли;
				Если МассивПолей.Количество() > 6 тогда
					Дом     = МассивПолей[6];
				КонецЕсли;
				Если МассивПолей.Количество() > 7 тогда
					Корпус  = МассивПолей[7];
				КонецЕсли;
				Если МассивПолей.Количество() > 8 тогда
					Квартира= МассивПолей[8];
				КонецЕсли;
				Если МассивПолей.Количество() > 0 тогда
					Индекс  = МассивПолей[0];
				КонецЕсли;
				Если МассивПолей.Количество() > 9 тогда
					КомментарийАдреса  = МассивПолей[9];
				КонецЕсли;
				
				Представление = "";
				Если СокрЛП(Индекс) <> "" Тогда
					Представление = Представление + ", " + СокрЛП(Индекс);
				КонецЕсли;
				Если СокрЛП(Регион) <> "" Тогда
					Представление = Представление + ", " + СокрЛП(Регион);
				КонецЕсли;
				Если СокрЛП(Район) <> "" Тогда
					Представление = Представление + ", " + СокрЛП(Район);
				КонецЕсли;
				Если СокрЛП(Город) <> "" Тогда
					Представление = Представление + ", " + СокрЛП(Город);
				КонецЕсли;
				Если СокрЛП(НаселенныйПункт) <> "" Тогда
					Представление = Представление + ", " + СокрЛП(НаселенныйПункт);
				КонецЕсли;
				Если СокрЛП(Улица) <> "" Тогда
					Представление = Представление + ", " + СокрЛП(Улица);
				КонецЕсли;
				Если СокрЛП(Дом) <> "" Тогда
					Представление = Представление + ", д. " + СокрЛП(Дом);
				КонецЕсли;
				Если СокрЛП(Корпус) <> "" Тогда
					Представление = Представление + ", корп. " + СокрЛП(Корпус);
				КонецЕсли;
				Если СокрЛП(Квартира) <> "" Тогда
					Представление = Представление + ", кв. " + СокрЛП(Квартира);
				КонецЕсли;
				Если СокрЛП(КомментарийАдреса) <> "" Тогда
					Представление = Представление + ", " + СокрЛП(КомментарийАдреса);
				КонецЕсли;
							
				Если СтрДлина(Представление) > 2 Тогда
					Представление = Сред(Представление, 3);
				КонецЕсли;
				ОформлениеСтроки.Ячейки.ТиповойОтвет.Текст = Представление;
				
				//ОформлениеСтроки.Ячейки.ТиповойОтвет.Текст = СтрЗаменить(ОформлениеСтроки.Ячейки.ТиповойОтвет.Текст, "¤", ", ");
			ИначеЕсли ДанныеСтроки.Вопрос.ТипВидКонтакнойИнформации.Тип = Перечисления.ТипыКонтактнойИнформации.Телефон тогда
				МассивПолей = РазложитьСтрокуВМассивПодстрок(ДанныеСтроки.ТиповойОтвет, "¤");
				Если МассивПолей.Количество() > 0 тогда
					Поле1 = МассивПолей[0];
				КонецЕсли;
				Если МассивПолей.Количество() > 1 тогда
					Поле2 = МассивПолей[1];
				КонецЕсли;
				Если МассивПолей.Количество() > 2 тогда
					Поле3 = МассивПолей[2];
				КонецЕсли;
				Если МассивПолей.Количество() > 3 тогда
					Поле4 = МассивПолей[3];
				КонецЕсли;
				Если МассивПолей.Количество() > 4 тогда
					Коммент = МассивПолей[4];
				КонецЕсли;
				Предст = ""+?(Не ПустаяСтрока(Поле1),("+"+Поле1),"");
				Предст = Предст + ?((Не ПустаяСтрока(Поле2)),(ПроверкаПустойСтроки(Предст,Ложь)+"(" + Поле2 + ")"),"");
				Предст = Предст + ?((Не ПустаяСтрока(Поле3)),(ПроверкаПустойСтроки(Предст,ПустаяСтрока(Поле2))+Поле3),"");
				Предст = Предст + ?((Не ПустаяСтрока(Поле4)),(ПроверкаПустойСтроки(Предст)+"доб. " + Поле4),"");
				Предст = Предст + ?((Не ПустаяСтрока(Коммент)),(ПроверкаПустойСтроки(Предст)+" " + Коммент),"");
				ОформлениеСтроки.Ячейки.ТиповойОтвет.Текст = Предст;
			Иначе
				ОформлениеСтроки.Ячейки.ТиповойОтвет.Текст = ""+Формат(ДанныеСтроки.ТиповойОтвет, "ДФ=dd.MM.yyyy; ДП=; БЛ=Нет; БИ=Да")+ " " + ДанныеСтроки.Ответ;
			КонецЕсли;
		КонецЕсли;
	//КонецЕсли;
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ РЕКВИЗИТОВ ТЧ "ВОПРОСЫ И ОТВЕТЫ"

// Процедура - обработчик события "Очистка" поля ввода "Вопрос".
Процедура ВопросыИОтветыВопросОчистка(Элемент, СтандартнаяОбработка)
	ЭлементыФормы.ВопросыИОтветы.ТекущиеДанные.ТиповойОтвет = Справочники.ВариантыОтветовОпросов.ПустаяСсылка();
КонецПроцедуры

// Процедура - обработчик события "ПриИзменении" поля ввода "ТиповойОтвет".
// если типовой ответ не требует дополнительных пояснений - очистим развернутый ответ
Процедура ВопросыИОтветыТиповойОтветПриИзменении(Элемент)
	
	Если Не ЭлементыФормы.ВопросыИОтветы.ТекущиеДанные.Вопрос.Предопределенный тогда
		Если ТипЗнч(Элемент.Значение) = Тип("СправочникСсылка.ВариантыОтветовОпросов") тогда
			Если Не Элемент.Значение.ТребуетРазвернутыйОтвет Тогда
				ЭлементыФормы.ВопросыИОтветы.ТекущиеДанные.Ответ = ""
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ ОБРАБОТКИ СВОЙСТВ И КАТЕГОРИЙ

// Процедура выполняет открытие формы работы со свойствами документа
//
Процедура ДействияФормыДействиеОткрытьСвойства(Кнопка)

	ОткрытьСвойстваДокумента(ЭтотОбъект, ЭтаФорма);

КонецПроцедуры

// Процедура выполняет открытие формы работы с категориями документа
//
Процедура ДействияФормыДействиеОткрытьКатегории(Кнопка)

	ОткрытьКатегорииДокумента(ЭтотОбъект, ЭтаФорма);

КонецПроцедуры

Процедура ВопросыИОтветыПриАктивизацииСтроки(Элемент)
	ТаблицаСоставногоОтвета.Очистить();
	Если Элемент.ТекущиеДанные = Неопределено тогда
		Возврат;
	КонецЕсли;
	Если Элемент.ТекущиеДанные.Вопрос.ТипВопроса = Перечисления.ТипВопросаАнкеты.Табличный тогда
		ЭлементыФормы.ТабличноеПолеСоставногоОтвета.ИзменятьПорядокСтрок 	= Ложь;
		ЭлементыФормы.ТабличноеПолеСоставногоОтвета.ИзменятьСоставСтрок 	= Ложь;
		
		ТаблицаСоставногоОтвета = Новый ТаблицаЗначений;
		
		ТаблицаСоставногоОтвета.Колонки.Добавить("НомерСтроки", Новый ОписаниеТипов("Число"), "№");
		КолонкиТабличногоВопроса = Элемент.ТекущиеДанные.Вопрос.КолонкиТаблицы;
		Для каждого КолонкаТВ из КолонкиТабличногоВопроса Цикл
			ТаблицаСоставногоОтвета.Колонки.Добавить("колонка"+КолонкаТВ.НомерСтроки, КолонкаТВ.КолонкаТаблицы.ТипЗначения, КолонкаТВ.КолонкаТаблицы.Наименование);
		КонецЦикла;
		ЭлементыФормы.ТабличноеПолеСоставногоОтвета.СоздатьКолонки();
		ПараметрыПоиска = Новый Структура("ВопросВладелец");
		ПараметрыПоиска.ВопросВладелец = Элемент.ТекущиеДанные.Вопрос;
		МассивСтрок = СоставнойОтвет.НайтиСтроки(ПараметрыПоиска);
		СписокНомеровСтрок = Новый СписокЗначений;
		Для каждого ИндексНомераСтроки из МассивСтрок Цикл
			Если СписокНомеровСтрок.НайтиПоЗначению(ИндексНомераСтроки.НомерСтрокиВТаблице) = Неопределено тогда
				СписокНомеровСтрок.Добавить(ИндексНомераСтроки.НомерСтрокиВТаблице);
			КонецЕсли;
		КонецЦикла;
		
		ВсегоСтрок = 0;
		//Если СписокНомеровСтрок.Количество() > 0 тогда
		//	ВсегоСтрок = СписокНомеровСтрок[СписокНомеровСтрок.Количество()-1].Значение;
		//КонецЕсли;
		ВсегоСтрок = Элемент.ТекущиеДанные.Вопрос.КоличествоСтрокТаблицы;
		
		Для ИндексНомераСтроки = 1 по ВсегоСтрок Цикл
			ПараметрыПоиска = Новый Структура("ВопросВладелец, НомерСтрокиВТаблице");
			ПараметрыПоиска.ВопросВладелец = Элемент.ТекущиеДанные.Вопрос;
			ПараметрыПоиска.НомерСтрокиВТаблице = ИндексНомераСтроки;
			ОтветНаТабличныйВопрос = СоставнойОтвет.НайтиСтроки(ПараметрыПоиска);
			СтрокаОтвет = ТаблицаСоставногоОтвета.Добавить();
			СтрокаОтвет.НомерСтроки = ИндексНомераСтроки;
			НомерКолонки = 1; // пропустим номер строки
			Для каждого КолонкаОтвет из ОтветНаТабличныйВопрос Цикл
				СтрокаОтвет[НомерКолонки] = КолонкаОтвет.ТиповойОтвет;
				НомерКолонки = НомерКолонки + 1;
				Если НомерКолонки >= ТаблицаСоставногоОтвета.Колонки.Количество() тогда
					Прервать;
				КонецЕсли;
			КонецЦикла;
		КонецЦикла;
	ИначеЕсли Элемент.ТекущиеДанные.Вопрос.ТипВопроса = Перечисления.ТипВопросаАнкеты.СправочникСсылка_ВариантыОтветов_Несколько тогда
		ЭлементыФормы.ТабличноеПолеСоставногоОтвета.ИзменятьПорядокСтрок 	= Истина;
		ЭлементыФормы.ТабличноеПолеСоставногоОтвета.ИзменятьСоставСтрок 	= Истина;
		
		ТаблицаСоставногоОтвета = Новый ТаблицаЗначений;
		
		ТаблицаСоставногоОтвета.Колонки.Добавить("НомерСтроки", Новый ОписаниеТипов("Число"), "№");
		КолонкиТабличногоВопроса = Элемент.ТекущиеДанные.Вопрос.КолонкиТаблицы;
		ТаблицаСоставногоОтвета.Колонки.Добавить("ВариантОтвета", Элемент.ТекущиеДанные.Вопрос.ТипЗначения, "Составной ответ");
		ТаблицаСоставногоОтвета.Колонки.Добавить("Ответ", Новый ОписаниеТипов("Строка"), "Развернутый ответ");
		ЭлементыФормы.ТабличноеПолеСоставногоОтвета.СоздатьКолонки();
		ЭлементыФормы.ТабличноеПолеСоставногоОтвета.Колонки.ВариантОтвета.ЭлементУправления.ВыборПоВладельцу = Элемент.ТекущиеДанные.Вопрос;
		ПараметрыПоиска 				= Новый Структура("ВопросВладелец");
		ПараметрыПоиска.ВопросВладелец 	= Элемент.ТекущиеДанные.Вопрос;
		МассивСтрок 					= СоставнойОтвет.НайтиСтроки(ПараметрыПоиска);
		Для каждого ИндексНомераСтроки из МассивСтрок Цикл
			СтрокаОтвет 			 	= ТаблицаСоставногоОтвета.Добавить();
			СтрокаОтвет.НомерСтроки 	= ИндексНомераСтроки.НомерСтрокиВТаблице;
			СтрокаОтвет.ВариантОтвета	= ИндексНомераСтроки.ТиповойОтвет;
			СтрокаОтвет.Ответ			= ИндексНомераСтроки.Ответ;
		КонецЦикла;
	Иначе	
		ЭлементыФормы.ТабличноеПолеСоставногоОтвета.ИзменятьПорядокСтрок 	= Ложь;
		ЭлементыФормы.ТабличноеПолеСоставногоОтвета.ИзменятьСоставСтрок 	= Ложь;
		ЭлементыФормы.ТабличноеПолеСоставногоОтвета.Колонки.Очистить();
	КонецЕсли;
	
КонецПроцедуры

Процедура АктуализироватьТЧСоставногоОтвета(Элемент, Отказ)
	
	ТекСтрока = ЭлементыФормы.ВопросыИОтветы.ТекущаяСтрока;
	Если ТекСтрока <> Неопределено тогда
		ТекущийТабличныйВопрос 	= ТекСтрока.Вопрос;
		Если Элемент.ТекущаяСтрока <> Неопределено тогда
			Если ТекущийТабличныйВопрос.ТипВопроса = Перечисления.ТипВопросаАнкеты.Табличный тогда
				НомерСтроки				= Элемент.ТекущаяСтрока.НомерСтроки;
			КонецЕсли;
		КонецЕсли;
	Иначе
		Возврат;
	КонецЕсли;
	
	Если ТаблицаСоставногоОтвета.Количество() = 0 тогда
		
		СтруктураПоиска = Новый Структура("ВопросВладелец");
		СтруктураПоиска.Вставить("ВопросВладелец", 		ТекущийТабличныйВопрос); 
		
		СтрокиКУдалению = СоставнойОтвет.НайтиСтроки(СтруктураПоиска);
		Для каждого СтрокаДляУдаления из СтрокиКУдалению Цикл
			СоставнойОтвет.Удалить(СтрокаДляУдаления);
		КонецЦикла;
		
	Иначе
		
		// здесь при редактировании составного ответа удаляем все строки соответствуюшие вопросу владельцу
		// и заново их добавляем
		// для табличного вопроса удаляем все ответы соответствующие данной строке таблицы и заново их добавляем
		// связано с тем, что у табличного вопроса строки фиксированы, а у составного их может быть в общем случае
		// столько, сколько у него вариантов ответа
		
		Если ТекущийТабличныйВопрос.ТипВопроса = Перечисления.ТипВопросаАнкеты.Табличный тогда
			СтруктураПоиска = Новый Структура("НомерСтрокиВТаблице,ВопросВладелец");
			//для табличного вопроса будем искать еще и по номеру строки (это ноер строки в таблице табличного вопроса)
			СтруктураПоиска.Вставить("НомерСтрокиВТаблице", НомерСтроки); 
		Иначе
			СтруктураПоиска = Новый Структура("ВопросВладелец");
		КонецЕсли;
		СтруктураПоиска.Вставить("ВопросВладелец", 		ТекущийТабличныйВопрос); 
		
		СтрокиКУдалению = СоставнойОтвет.НайтиСтроки(СтруктураПоиска);
		Для каждого СтрокаДляУдаления из СтрокиКУдалению Цикл
			СоставнойОтвет.Удалить(СтрокаДляУдаления);
		КонецЦикла;
		
		СтрокаСоставногоВопроса 				= Элемент.ТекущаяСтрока;
		Если ТекущийТабличныйВопрос.ТипВопроса 	= Перечисления.ТипВопросаАнкеты.СправочникСсылка_ВариантыОтветов_Несколько тогда
			Для каждого СтрокаОтвета из ТаблицаСоставногоОтвета Цикл
				НоваяСтрокаОтвета 						= СоставнойОтвет.Добавить();
				НоваяСтрокаОтвета.Вопрос 				= ТекущийТабличныйВопрос;
				НоваяСтрокаОтвета.ВопросВладелец		= ТекущийТабличныйВопрос;
				НоваяСтрокаОтвета.НомерСтрокиВТаблице 	= СтрокаОтвета.НомерСтроки;
				НоваяСтрокаОтвета.ТиповойОтвет 			= СтрокаОтвета.ВариантОтвета;
				НоваяСтрокаОтвета.Ответ		 			= СтрокаОтвета.Ответ;
			КонецЦикла;
		Иначе
			КолонкиСоставногоОтвета = ТекСтрока.Вопрос.КолонкиТаблицы;
			//СтрокаСоставногоВопроса = Элемент.ТекущаяСтрока;
			
			Для каждого КолонкаОтвета из КолонкиСоставногоОтвета Цикл
				НоваяСтрокаОтвета 						= СоставнойОтвет.Добавить();
				НоваяСтрокаОтвета.Вопрос 				= КолонкаОтвета.КолонкаТаблицы;
				НоваяСтрокаОтвета.ВопросВладелец		= ТекущийТабличныйВопрос;
				НоваяСтрокаОтвета.НомерСтрокиВТаблице 	= НомерСтроки;
				НоваяСтрокаОтвета.ТиповойОтвет 			= СтрокаСоставногоВопроса["колонка"+КолонкаОтвета.НомерСтроки];
			КонецЦикла;
		КонецЕсли;
		
	КонецЕсли;
	
	
КонецПроцедуры

Процедура ТабличноеПолеСоставногоОтветаПередОкончаниемРедактирования(Элемент, НоваяСтрока, ОтменаРедактирования, Отказ)
	
	АктуализироватьТЧСоставногоОтвета(Элемент, Отказ);
	Если Элемент.ТекущиеДанные <> Неопределено тогда
		Если НЕ Элемент.ТекущиеДанные.ВариантОтвета.ТребуетРазвернутыйОтвет тогда
			Элемент.ТекущиеДанные.Ответ = "";
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура ТабличноеПолеСоставногоОтветаПриНачалеРедактирования(Элемент, НоваяСтрока)
	
	Если НоваяСтрока тогда
		Попытка
			Элемент.ТекущиеДанные.НомерСтроки = Элемент.Значение[ТаблицаСоставногоОтвета.Количество()-2].НомерСтроки+1;
		Исключение
			Элемент.ТекущиеДанные.НомерСтроки = 1;
		КонецПопытки;
	КонецЕсли;
	Попытка
		Элемент.Колонки.Ответ.ЭлементУправления.Доступность = Элемент.ТекущиеДанные.ВариантОтвета.ТребуетРазвернутыйОтвет;
		//будет срабатывать только для составных вопросов
	Исключение
	КонецПопытки
	
КонецПроцедуры

Процедура ТабличноеПолеСоставногоОтветаПриАктивизацииСтроки(Элемент)
	
	Если Элемент.ТекущаяСтрока = Неопределено тогда
		Возврат;
	КонецЕсли;
	
	Попытка
		Если Элемент.ТекущаяСтрока.ВариантОтвета.Владелец.ТипВопроса = Перечисления.ТипВопросаАнкеты.СправочникСсылка_ВариантыОтветов_Несколько тогда
			Элемент.Колонки.Ответ.ЭлементУправления.Доступность = Элемент.ТекущаяСтрока.ВариантОтвета.ТребуетРазвернутыйОтвет;
		КонецЕсли;
	Исключение
	КонецПопытки;
	
КонецПроцедуры

Процедура ВопросыИОтветыТиповойОтветОчистка(Элемент, СтандартнаяОбработка)
	
	ЭлементыФормы.ВопросыИОтветы.ТекущиеДанные.ТиповойОтвет = ПустоеЗначениеТипа(ЭлементыФормы.ВопросыИОтветы.ТекущиеДанные.Вопрос.ТипЗначения.Типы()[0]);
	
КонецПроцедуры

Процедура ТабличноеПолеСоставногоОтветаПослеУдаления(Элемент)
	
	АктуализироватьТЧСоставногоОтвета(Элемент, Ложь);
	
КонецПроцедуры

Процедура ДействияФормыHTML(Кнопка)
	
	Если Модифицированность() Тогда
		Вопрос = "Перед просмотром необходимо записать документ. Записать?";
		Ответ  = Вопрос(Вопрос, РежимДиалогаВопрос.ОКОтмена);

		Если Ответ = КодВозвратаДиалога.ОК Тогда
			ЗаписатьВФорме();
		Иначе
			Возврат;
		КонецЕсли;
	КонецЕсли;
	
	ИмяФайла     = "opros"+Число(Номер)+".xml";
	ОбъектАнкета = ТиповаяАнкета.ПолучитьОбъект();
	ОбъектАнкета.СформироватьВложение(ОпрашиваемоеЛицо, "", , Ссылка, ИмяФайла, Истина);
	ЗапуститьПриложение(КаталогВременныхФайлов() + ИмяФайла);
	
КонецПроцедуры

Процедура КоманднаяПанельВопросыИОтветыОбновить(Кнопка)
	
	Если ЭтоНовый() или Модифицированность() Тогда
		Вопрос = "Необходимо записать документ. Записать?";
		Ответ  = Вопрос(Вопрос, РежимДиалогаВопрос.ОКОтмена);
		Если Ответ = КодВозвратаДиалога.ОК Тогда
			ЗаписатьВФорме();
		Иначе
			Возврат;
		КонецЕсли;
	КонецЕсли;
	
	ТекстЗапроса = "ВЫБРАТЬ
	               |	ВопросыАнкеты.НомерСтроки КАК НомерСтроки,
	               |	ВопросыАнкеты.Вопрос КАК Вопрос,
	               |	ОпросВопросы.Ответ,
	               |	ОпросВопросы.ТиповойОтвет,
	               |	NULL КАК НомерСтрокиВТаблице,
	               |	NULL КАК КолонкаТаблицы,
	               |	ВопросыАнкеты.ТипВопроса КАК ТипВопроса,
	               |	NULL КАК НомерСтрокиКолонки
	               |ИЗ
	               |	(ВЫБРАТЬ
	               |		ТиповыеАнкетыВопросыАнкеты.Вопрос КАК Вопрос,
	               |		ТиповыеАнкетыВопросыАнкеты.НомерСтроки КАК НомерСтроки,
	               |		ТиповыеАнкетыВопросыАнкеты.Вопрос.ТипВопроса КАК ТипВопроса
	               |	ИЗ
	               |		Справочник.ТиповыеАнкеты.ВопросыАнкеты КАК ТиповыеАнкетыВопросыАнкеты
	               |	
	               |	ГДЕ
	               |		ТиповыеАнкетыВопросыАнкеты.Ссылка = &ТиповаяАнкета) КАК ВопросыАнкеты
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.Опрос.Вопросы КАК ОпросВопросы
	               |		ПО ВопросыАнкеты.Вопрос = ОпросВопросы.Вопрос И (ОпросВопросы.Ссылка = &ДокументОпрос)
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	ВопросыАнкеты.НомерСтроки,
	               |	ВопросыАнкеты.Вопрос,
	               |	ОпросСоставнойОтвет.Ответ,
	               |	ОпросСоставнойОтвет.ТиповойОтвет,
	               |	ОпросСоставнойОтвет.НомерСтрокиВТаблице,
	               |	ВопросыДляАнкетированияКолонкиТаблицы.КолонкаТаблицы,
	               |	ВопросыАнкеты.ТипВопроса,
	               |	ВопросыДляАнкетированияКолонкиТаблицы.НомерСтроки
	               |ИЗ
	               |	(ВЫБРАТЬ
	               |		ТиповыеАнкетыВопросыАнкеты.Вопрос КАК Вопрос,
	               |		ТиповыеАнкетыВопросыАнкеты.НомерСтроки КАК НомерСтроки,
	               |		ТиповыеАнкетыВопросыАнкеты.Вопрос.ТипВопроса КАК ТипВопроса
	               |	ИЗ
	               |		Справочник.ТиповыеАнкеты.ВопросыАнкеты КАК ТиповыеАнкетыВопросыАнкеты
	               |	
	               |	ГДЕ
	               |		ТиповыеАнкетыВопросыАнкеты.Ссылка = &ТиповаяАнкета) КАК ВопросыАнкеты
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.Опрос.СоставнойОтвет КАК ОпросСоставнойОтвет
	               |			ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.ВопросыДляАнкетирования.КолонкиТаблицы КАК ВопросыДляАнкетированияКолонкиТаблицы
	               |			ПО ОпросСоставнойОтвет.Вопрос = ВопросыДляАнкетированияКолонкиТаблицы.КолонкаТаблицы
	               |		ПО ВопросыАнкеты.Вопрос = ОпросСоставнойОтвет.ВопросВладелец И (ОпросСоставнойОтвет.Ссылка = &ДокументОпрос)
	               |
	               |ГДЕ
	               |	(ВопросыДляАнкетированияКолонкиТаблицы.Ссылка.КоличествоСтрокТаблицы >= ОпросСоставнойОтвет.НомерСтрокиВТаблице И ОпросСоставнойОтвет.ВопросВладелец.ТипВопроса = &Табличный ИЛИ ОпросСоставнойОтвет.ВопросВладелец.ТипВопроса = &ВВидеНесколькихОтветов)
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	НомерСтроки,
	               |	НомерСтрокиВТаблице,
	               |	НомерСтрокиКолонки
	               |
	               |ИТОГИ ПО
	               |	Вопрос";
				   
	Запрос = Новый Запрос(ТекстЗапроса);
	Запрос.УстановитьПараметр("ДокументОпрос", 			Ссылка);
	Запрос.УстановитьПараметр("ТиповаяАнкета", 			ТиповаяАнкета);
	Запрос.УстановитьПараметр("Табличный", 				Перечисления.ТипВопросаАнкеты.Табличный);
	Запрос.УстановитьПараметр("ВВидеНесколькихОтветов",	Перечисления.ТипВопросаАнкеты.СправочникСсылка_ВариантыОтветов_Несколько);
	РезультатЗапрос = Запрос.Выполнить();
	ВыборкаЗапроса					= РезультатЗапрос.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	Вопросы.Очистить();
	СоставнойОтвет.Очистить();
	Пока ВыборкаЗапроса.Следующий() Цикл
		Если ВыборкаЗапроса.Вопрос.ТипВопроса = Перечисления.ТипВопросаАнкеты.Табличный ИЛИ ВыборкаЗапроса.Вопрос.ТипВопроса = Перечисления.ТипВопросаАнкеты.СправочникСсылка_ВариантыОтветов_Несколько тогда
			//ТабличныйВопрос = ВыборкаЗапроса.Вопрос;
			НоваяСтрока 		= Вопросы.Добавить();
			НоваяСтрока.Вопрос 	= ВыборкаЗапроса.Вопрос;
			НоваяСтрока.ТиповойОтвет 	= ВыборкаЗапроса.ТиповойОтвет;
			НоваяСтрока.Ответ 			= ВыборкаЗапроса.Ответ;
			ВыборкаЗапросаТабличныйВопрос	= ВыборкаЗапроса.Выбрать();
			Пока ВыборкаЗапросаТабличныйВопрос.Следующий() Цикл
				Если ЗначениеНеЗаполнено(ВыборкаЗапросаТабличныйВопрос.КолонкаТаблицы) И (ВыборкаЗапросаТабличныйВопрос.ТипВопроса = Перечисления.ТипВопросаАнкеты.Табличный) тогда
					Продолжить;
				КонецЕСли;
				Если ЗначениеНеЗаполнено(ВыборкаЗапросаТабличныйВопрос.ТиповойОтвет) И (ВыборкаЗапросаТабличныйВопрос.Вопрос.ТипВопроса = Перечисления.ТипВопросаАнкеты.СправочникСсылка_ВариантыОтветов_Несколько) тогда
					Продолжить;
				КонецЕсли;
				НоваяСтрока 				= СоставнойОтвет.Добавить();
				Если ВыборкаЗапроса.Вопрос.ТипВопроса = Перечисления.ТипВопросаАнкеты.СправочникСсылка_ВариантыОтветов_Несколько тогда
					НоваяСтрока.Вопрос 			= ВыборкаЗапросаТабличныйВопрос.Вопрос;
				Иначе
					НоваяСтрока.Вопрос 			= ВыборкаЗапросаТабличныйВопрос.КолонкаТаблицы;
				КонецЕСли;
				НоваяСтрока.ВопросВладелец 	= ВыборкаЗапросаТабличныйВопрос.Вопрос;
				Если ЗначениеНеЗаполнено(ВыборкаЗапросаТабличныйВопрос.ТиповойОтвет) тогда
					НазначитьТипОтвета(НоваяСтрока);
				Иначе
					НоваяСтрока.ТиповойОтвет 	= ВыборкаЗапросаТабличныйВопрос.ТиповойОтвет;
				КонецЕсли;
				НоваяСтрока.Ответ 			= ВыборкаЗапросаТабличныйВопрос.Ответ;
				НоваяСтрока.НомерСтрокиВТаблице	= ВыборкаЗапросаТабличныйВопрос.НомерСтрокиВТаблице;
			КонецЦикла;
		Иначе
			НоваяСтрока 		= Вопросы.Добавить();
			НоваяСтрока.Вопрос 	= ВыборкаЗапроса.Вопрос;
			ВыборкаЗапросаОтвет	= ВыборкаЗапроса.Выбрать();
			Пока ВыборкаЗапросаОтвет.Следующий() Цикл
				Если ЗначениеНеЗаполнено(ВыборкаЗапросаОтвет.ТиповойОтвет) тогда
					НазначитьТипОтвета(НоваяСтрока);
					Продолжить;
				КонецЕсли;
				НоваяСтрока.ТиповойОтвет 	= ВыборкаЗапросаОтвет.ТиповойОтвет;
				НоваяСтрока.Ответ 			= ВыборкаЗапросаОтвет.Ответ;
			КонецЦикла;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	яштСменаПользователя(ЭтотОбъект, ЭтаФорма, глТекущийПользователь);
КонецПроцедуры

