
Процедура КоманднаяПанель1Заполнить(Кнопка)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ЗаказыПоставщикамСезонныеОстатки.Номенклатура,
		|	ЗаказыПоставщикамСезонныеОстатки.КоличествоОстаток КАК Количество
		|ИЗ
		|	РегистрНакопления.ЗаказыПоставщикамСезонные.Остатки(&Дата, ЗаказПоставщикуСезонный = &Заказ) КАК ЗаказыПоставщикамСезонныеОстатки";
		
	Запрос.УстановитьПараметр("Заказ", ЗаказПоставщикуСезонный);
	Если ЭтоНовый() Тогда
		Запрос.УстановитьПараметр("Дата", ТекущаяДата());
	Иначе	
		Запрос.УстановитьПараметр("Дата", Дата);
	КонецЕсли;
	Товары.Загрузить(Запрос.Выполнить().Выгрузить());
	
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ПараметрыДляНачисленияПениПоставщикам.Контрагент КАК Контрагент,
		|	ПараметрыДляНачисленияПениПоставщикам.КоличествоВСезонномЗаказе КАК КоличествоВСезонномЗаказе,
		|	ПараметрыДляНачисленияПениПоставщикам.ПроцентНедогруза,
		|	ПараметрыДляНачисленияПениПоставщикам.ПроцентПерегруза,
		|	ПараметрыДляНачисленияПениПоставщикам.ДеньНачисленияПени,
		|	ПараметрыДляНачисленияПениПоставщикам.ДеньШтрафа,
		|	ПараметрыДляНачисленияПениПоставщикам.РазмерПени,
		|	ПараметрыДляНачисленияПениПоставщикам.РазмерШтрафа,
		|	ПараметрыДляНачисленияПениПоставщикам.РазмерШтрафаПерегруз
		|ИЗ
		|	РегистрСведений.ПараметрыДляНачисленияПениПоставщикам КАК ПараметрыДляНачисленияПениПоставщикам
		|
		|УПОРЯДОЧИТЬ ПО
		|	Контрагент,
		|	КоличествоВСезонномЗаказе";
	
	
	ПараметрыНачисленияПеней = Запрос.Выполнить().Выгрузить();
	
	НужныеПараметры = ПараметрыНачисленияПеней.НайтиСтроки(Новый Структура("Контрагент",ЗаказПоставщикуСезонный.Контрагент));
	Если НужныеПараметры.Количество() = 0 Тогда //Если персональных нет, тогда по общим
		НужныеПараметры = ПараметрыНачисленияПеней.НайтиСтроки(Новый Структура("Контрагент",Справочники.Контрагенты.ПустаяСсылка()));
	КонецЕсли;
	табЗаказа = ЗаказПоставщикуСезонный.Товары.Выгрузить();
	Для каждого стр из Товары Цикл 
		Для каждого стрН из НужныеПараметры Цикл
			НужнаяСтрока = ТабЗаказа.Найти(стр.Номенклатура,"Номенклатура");
			КоличествоВзаказе = НужнаяСтрока.Количество;
			Если КоличествоВзаказе >= стрН.КоличествоВСезонномЗаказе Тогда
				РазрешенныйНедогруз = Окр(КоличествоВзаказе*стрН.ПроцентНедогруза/100,0);
				стр.РазрешенныйНедогруз = РазрешенныйНедогруз; 
				стр.РазмерШтрафа = стрН.РазмерШтрафа;
				Если стр.Количество> стр.РазрешенныйНедогруз Тогда
					стр.ШтрафЗаНедогруз = (стр.Количество-стр.РазрешенныйНедогруз)*стр.РазмерШтрафа/100;	
				КонецЕсли;	
			Иначе
				Прервать;
			КонецЕсли;	
		КонецЦикла;
	КонецЦикла;		

КонецПроцедуры

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	
	Если ЭтоНовый() Тогда
		Ответственный = глТекущийПользователь;	
	КонецЕсли;	
	
	Если РежимЗаписи = РежимЗаписиДокумента.Проведение и глТекущийпользователь <> Справочники.Пользователи.НайтиПоКоду("Малышев Егор") и глТекущийпользователь <> Справочники.Пользователи.НайтиПоКоду("Малышев Егор (снабжение)") Тогда	
		ЕгорМалышев = Справочники.Пользователи.НайтиПоКоду("Малышев Егор");				
		Инициатор = ПараметрыСеанса.ТекущийПользователь;
		
		Задача = Задачи.ЗадачиПользователя.СоздатьЗадачу();
		Задача.Дата = ТекущаяДата();
		Задача.Постановщик = ЕгорМалышев;
		Задача.Наименование = "Проведение отказа поставщика";
		Задача.Исполнитель = ЕгорМалышев;
		Задача.Описание = "Проведение отказа поставщика";	
		Если ЭтоНовый() Тогда
			НовыйСсылка = Документы.ОтказПоставщикаПоСезонномуЗаказу.ПолучитьСсылку(Новый УникальныйИдентификатор);	
			ЭтотОбъект.УстановитьСсылкуНового(НовыйСсылка);
			Задача.Объект = НовыйСсылка;
		Иначе 
			Задача.Объект = ЭтотОбъект.Ссылка;
		КонецЕсли;                             
		Задача.Инициатор = Инициатор;
		Задача.НаСогласование = Истина;
		Задача.РеквизитДляСогласования = "Ссылка";
		Задача.СрокОповещения = ТекущаяДата();
		Задача.Оповещение = Истина;
		Задача.Записать();  	
		Сообщить("Создана задача на проведение документа Егору Малышеву");
		РежимЗаписи = РежимЗаписиДокумента.Запись;
	КонецЕсли;	
   	
КонецПроцедуры

Процедура ТоварыПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки)
		ОформлениеСтроки.Ячейки.Код.УстановитьТекст(ДанныеСтроки.Номенклатура.Код);
КонецПроцедуры

Процедура ПриОткрытии()
	 Если проведен и глТекущийпользователь <> Справочники.Пользователи.НайтиПоКоду("Малышев Егор") и глТекущийпользователь <> Справочники.Пользователи.НайтиПоКоду("Малышев Егор (снабжение)") Тогда	
	  ЭтаФорма.ТолькоПросмотр = Истина;
	конецЕсли;	
КонецПроцедуры

Процедура ТоварыКоличествоПриИзменении(Элемент)
	стр = ЭлементыФормы.Товары.ТекущиеДанные;
	Если стр.Количество> стр.РазрешенныйНедогруз Тогда
		стр.ШтрафЗаНедогруз=(стр.Количество-стр.РазрешенныйНедогруз)*стр.РазмерШтрафа/100;	
	конецЕсли;	

КонецПроцедуры
