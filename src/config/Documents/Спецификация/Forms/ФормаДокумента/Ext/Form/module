Перем мПечатнаяФормаПоУмолчанию;

// Процедура вызывается при нажатии кнопки "Печать" командной панели формы,
// вызывает печать по умолчанию для формы документа.
//
Процедура ОсновныеДействияФормыДействиеПечать(Кнопка)

	НапечататьДокументПоУмолчанию(ЭтотОбъект, глТекущийПользователь, мПечатнаяФормаПоУмолчанию, ЭтаФорма);

КонецПроцедуры // ОсновныеДействияФормыДействиеПечать()

// Процедура вызывается при выборе пункта подменю "Печать" командной панели
// формы. Процедура отрабатывает выбор печатной формы.
//
Процедура КоманднаяПанельФормыДействиеВыбратьПечатнуюФормы(Кнопка)

	Если Кнопка <> Неопределено Тогда // найти новое значение вида операции
		ЭлементыФормы.ОсновныеДействияФормы.Кнопки.ДействиеПечать.Текст = Кнопка.Текст;
		СтруктураМакета = Новый Структура("Макет, ПредставлениеМакета");
		СписокМакетов = ПолучитьСписокПечатныхФорм();
		СтрокаМакетаВСписке = СписокМакетов.НайтиПоЗначению(Кнопка.Имя);
		Если СтрокаМакетаВСписке <> Неопределено Тогда
			Печать(СтрокаМакетаВСписке.Значение);
			СтруктураМакета.Макет = СтрокаМакетаВСписке.Значение;
			СтруктураМакета.ПредставлениеМакета = СтрокаМакетаВСписке.Представление;			
			
		Иначе
			СсылкаВнешнейФормы = Справочники.ДополнительныеПечатныеФормы.ПолучитьСсылку(Новый УникальныйИдентификатор(СтрЗаменить(Кнопка.Имя, "_", "-")));
			Печать(СсылкаВнешнейФормы,,,ЭтаФорма);
			СтруктураМакета.Макет = СсылкаВнешнейФормы;
			СтруктураМакета.ПредставлениеМакета = Кнопка.Текст;
		КонецЕсли;		
		
		мПечатнаяФормаПоУмолчанию = СтруктураМакета.Макет;
		СохранитьТекущуюКнопкуПечати(ЭтотОбъект.Метаданные().Имя, СтруктураМакета);
	КонецЕсли;

КонецПроцедуры // КоманднаяПанельФормыДействиеВыбратьПечатнуюФормы()

Процедура УстановитьНомерПечати()
	
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Контрагент", Контрагент);
	
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Спецификация.Ссылка КАК Ссылка
	|ИЗ
	|	Документ.Спецификация КАК Спецификация
	|ГДЕ
	|	Спецификация.Контрагент = &Контрагент";
	
	СледНомер = Строка(Запрос.Выполнить().Выбрать().Количество() + 1);
	
	НомерДляПечати = Номер + "/" + СледНомер;
	
	
	
КонецПроцедуры

//Процедура УстановитьУсловияДоговора()

//	Запрос = Новый Запрос;
//	Запрос.УстановитьПараметр("ДатаДокумента", ЭтотОбъект.Дата);
//	Запрос.УстановитьПараметр("ДоговорКонтрагента", ЭтотОбъект.ДоговорКонтрагента);
//	Запрос.Текст =
//	"ВЫБРАТЬ
//	|	УсловияДоговораСрезПоследних.СпособОтгрузкиТовара,
//	|	УсловияДоговораСрезПоследних.ДатаДоговора,
//	|	УсловияДоговораСрезПоследних.НомерДоговора,
//	|	УсловияДоговораСрезПоследних.Пени,
//	|	УсловияДоговораСрезПоследних.Отсрочка,
//	|	УсловияДоговораСрезПоследних.ДополнительныеУсловия
//	|ИЗ
//	|	РегистрСведений.УсловияДоговора.СрезПоследних(&ДатаДокумента, ) КАК УсловияДоговораСрезПоследних
//	|ГДЕ
//	|	УсловияДоговораСрезПоследних.ДоговорКонтрагента = &ДоговорКонтрагента";
//	
//	Результат = Запрос.Выполнить();
//	
//	Если Результат.Пустой() Тогда
//	
//		РасчитыватьАвтоматически = Истина;
//		Возврат;
//	
//	КонецЕсли;
//	
//	Выборка = Результат.Выбрать();
//	
//	Если Выборка.Следующий() Тогда 
//		
//		СпособОтгрузки = Выборка.СпособОтгрузкиТовара;
//		НомерДоговора = Выборка.НомерДоговора;
//		ДатаДоговора = Выборка.ДатаДоговора;
//		Пени = Выборка.Пени;
//		ДополнительныеУсловия = Выборка.ДополнительныеУсловия;
//		
//	КонецЕсли;

//КонецПроцедуры
 
 

Процедура ЗаполнитьДанные()

	УстановитьНомерПечати();
//	УстановитьУсловияДоговора();

КонецПроцедуры
 

Процедура ПриОткрытии()
	
	Если ЭтоНовый() Тогда
	
		УстановитьНомерДокумента(ЭтотОбъект);
	
	КонецЕсли; 
	
		// Заполнить подменю выбора печатных форм.
	СписокМакетов = ЭтотОбъект.ПолучитьСписокПечатныхФорм();
	УстановитьПодменюВыбораПечатнойФормы(ЭлементыФормы.ОсновныеДействияФормы.Кнопки.ПодменюПечати,
	                                       СписокМакетов,
	                                       Новый Действие("КоманднаяПанельФормыДействиеВыбратьПечатнуюФормы"));

	// Установить печатную форму по умолчанию.
	УстановитьКнопкуПечати(ЭтотОбъект.Метаданные().Имя, ЭтаФорма, СписокМакетов, мПечатнаяФормаПоУмолчанию);
	
	Если ЭтоНовый() Тогда
	
		ЗаполнитьДанные();
	
	КонецЕсли; 
	

	Если НЕ ЭтоНовый() Тогда
		
		УстановитьЭлементыИсторииКнопка(Ссылка, ЭтаФорма);
		
	КонецЕсли; 

	
КонецПроцедуры

Процедура ВыводИстории(Элемент)
	
	ВывестиИсторию(Ссылка, ЭтаФорма);
	
КонецПроцедуры
	
	

Процедура ОбновлениеОтображения()
	
	ЭлементыФормы.НадписьИнформацияОДоговоре.Заголовок="Договор №"+СокрЛП(ДоговорКонтрагента.Номер) +" от "+Формат(ДоговорКонтрагента.Дата, "ДФ=""дд ММММ гггг 'г.'"""); 
	
	Если (ТипЗнч(ДокументОснование.Сделка) = Тип("ДокументСсылка.ЗаказПокупателя"))
		 И НЕ (ЗначениеНеЗаполнено(ДокументОснование.Сделка)) Тогда
	
		ЭлементыФормы.НадписьЗаказПокупателя.Заголовок = "Заказ: " + Строка(ДокументОснование.Сделка);
		ЭлементыФормы.НадписьСрокОплаты.Заголовок = "Дата оплаты по заказу: " + Строка(ДокументОснование.Сделка.ДатаОплаты);
		
	Иначе
		
		ЭлементыФормы.НадписьЗаказПокупателя.Заголовок = "Реализация: " + Строка(ДокументОснование);
		ЭлементыФормы.НадписьСрокОплаты.Заголовок = "Дата оплаты: " + Строка(ДокументОснование.Дата);
	
	КонецЕсли; 
	
	ЭлементыФормы.НадписьДополнительныеУсловия.Заголовок = ?(ЗначениеНеЗаполнено(ДополнительныеУсловия), "", "Доп.условия: " + ДополнительныеУсловия);
	ЭлементыФормы.НадписьСуммаОтгрузки.Заголовок = "Сумма отгрузки: " + Строка(ДокументОснование.СуммаДокумента) + " " + ДокументОснование.ВалютаДокумента.Наименование;
	
КонецПроцедуры

Процедура ПередОткрытием(Отказ, СтандартнаяОбработка)
	
	Если ЭтоНовый() И ЗначениеНеЗаполнено(ДокументОснование) Тогда
	
		Предупреждение("Документ можно вводить только на основании!", 5);
		Отказ = Истина;
	
	КонецЕсли;
	
	Если ЭтоНовый() И НЕ ЗначениеНеЗаполнено(ДокументОснование) Тогда
		
		
		//+++ 16.09.2014 по просьбе Алёны Логовской
		Если НЕ ДокументОснование.Проведен Тогда
			Если РольДоступна("ПолныеПрава") тогда  // для бух ЯШТ
				Если Вопрос(" Документ реализации - еще НЕ проведен!
					        |Вы уверены в необходимости ввода Спецификации?",РежимДиалогаВопрос.ДаНет,0)=КодВозвратаДиалога.Нет тогда
				Отказ = Истина;
				КонецЕсли;
			Иначе //-------------------------как было раньше для всех--------------------------------------------
				Предупреждение("Документ можно вводить только на основании проведенного документа!", 5);
				Отказ = Истина;
			КонецЕсли;	
		КонецЕсли; 
	    
	КонецЕсли; 
	
	
КонецПроцедуры

Процедура НомерПриИзменении(Элемент)
	
	УстановитьНомерПечати();
	
КонецПроцедуры

