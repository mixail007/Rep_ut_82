
Процедура ПриОткрытии()
	Если ЭтоНовый() тогда
		НаправлениеПродаж = глТекущийПользователь.НаправлениеПродаж;
		Ответственный = глТекущийПользователь;
	КонецЕсли;
	ЭлементыФормы.Надпись1.Заголовок = формат(Период, "ДФ='MMMM гггг'")+"г.";
	
	//28.07.2016 руководитель направления - может менять ответственных в пределах своей группы!
	Если НаправлениеПродаж.Руководитель = глТекущийПользователь
		или Найти(глТекущийПользователь.Код, "Бондаренко")>0 тогда
		ЭлементыФормы.Ответственный.ТолькоПросмотр = ложь;
	КонецЕсли;	
КонецПроцедуры

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	
	Если Период = '00010101' тогда
	   Предупреждение("Не заполнено поле 'Период'.",5);
	   Отказ = истина;
    КонецЕсли;
   
	Если НаправлениеПродаж.Пустая() тогда
	   Предупреждение("Не заполнено поле 'Направление Продаж'.",5);
	   Отказ = истина;
	КонецЕсли;
	
	Если Планы.Количество()=0 тогда
	   Предупреждение("Нет ни одной строки Плана отгрузок.",5);
	   Отказ = истина;
	КонецЕсли;
	
	Если Ответственный.Пустая() тогда
		Ответственный = глТекущийПользователь; 
		дата = ТекущаяДата();
	КонецЕсли;

КонецПроцедуры

Процедура ПериодРегулирование(Элемент, Направление, СтандартнаяОбработка)
	СтандартнаяОбработка = ложь;
	Элемент.Значение = ДобавитьМесяц(Элемент.Значение, Направление);
	ЭлементыФормы.Надпись1.Заголовок = формат(Период, "ДФ='MMMM гггг'")+"г.";
КонецПроцедуры

Процедура ПериодПриИзменении(Элемент)
	Элемент.Значение = НачалоМесяца(Элемент.Значение);
	ЭлементыФормы.Надпись1.Заголовок = формат(Период, "ДФ='MMMM гггг'")+"г.";
КонецПроцедуры

Процедура КоманднаяПанель1Заполнить(Кнопка)
	
	  Запрос = Новый Запрос;
	  Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
	                 |	Контрагенты.Ссылка КАК Контрагент
	                 |ИЗ
	                 |	Справочник.Контрагенты КАК Контрагенты
	                 |ГДЕ
	                 |	Контрагенты.Покупатель
	                 |	И НЕ Контрагенты.ПометкаУдаления
	                 |	И (Контрагенты.ЯШТИнтернет ИЛИ Контрагенты.ЯШТТерминал)
					 |	И Контрагенты.ОсновнойДоговорКонтрагента.ТипДоговора = &ТипДоговора
					 
					 |	И Контрагенты.ОсновнойДоговорКонтрагента.ОтветственноеЛицо = &ОтветственноеЛицо";
					 
	Запрос.УстановитьПараметр("ТипДоговора", справочники.ТипыДоговоров.НайтиПоКоду("00001") );
	  Запрос.УстановитьПараметр("ОтветственноеЛицо", глТекущийПользователь);
	  
	  Результат = Запрос.Выполнить();
	  Выборка = Результат.Выбрать();
	  
	  Если Выборка.Количество()=0 тогда
		  Предупреждение("У Вас нет ни одного Клиента [v]Интернет или [v]Терминал
		  				 |по которому установлен Ваш основной договор (предоплаты).", 10);
		 Возврат;
	  КонецЕсли;	 
	  
	  Если Планы.Количество()>0 тогда
		  Если Вопрос("Таблица клиентов - не пустая!
			           |При заполнении все даннные будут удалены.
					   |Заполнить новым списком из "+строка(выборка.Количество())+" клиентов?", РежимДиалогаВопрос.ДаНет, 0)<>КодВозвратаДиалога.Да тогда
			  возврат;
		  КонецЕсли;	  
	  КонецЕсли;	  
	  
	  Планы.Очистить();
	  пока Выборка.Следующий() цикл
		  стр1 = Планы.Добавить();
		  ЗаполнитьЗначенияСвойств( стр1, выборка);
	  КонецЦикла;
	  
КонецПроцедуры

Процедура ОтветственныйПриИзменении(Элемент)
	Если НаправлениеПродаж <> Ответственный.НаправлениеПродаж
		и не Найти(глТекущийПользователь.Код, "Бондаренко")>0  тогда //28.07.2016 - ограничение!
		Предупреждение("Нельзя установить Ответственного из другого Направления продаж!", 30); 
		Ответственный = глТекущийПользователь; 
	КонецЕсли;	
КонецПроцедуры
