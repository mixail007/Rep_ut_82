Процедура СформироватьОтчет (ДокументРезультат,ОтборПоНаличию=Ложь) Экспорт
	
	Макет=ПолучитьМакет("МакетЗаказаПокупателя") ;
	
	ОбластьШапка=Макет.ПолучитьОбласть("Шапка");
	
	ОбластьШапка.Параметры.ЗаказПокупателя= "Отчет по :" +Строка(Заказ);
	ДокументРезультат.Вывести (ОбластьШапка);
	
	Запрос=Новый Запрос;
	Запрос.УстановитьПараметр("ТекущийДокумент",Заказ);
	Запрос.УстановитьПараметр("ОтборПоНаличию",ОтборПоНаличию);
	
	////+++ 15.12.2014 - в зависимости от документа, а не
	// В зависимости от подразделения пользователя происходит подбор по складам
	//Если НЕ ПолучитьЗначениеПоУмолчанию(глТекущийПользователь, "УчетТолькоПоПодразделениюПользователя") Тогда
	Если не Заказ.Транзит тогда
		Запрос.Текст=" ВЫБРАТЬ     ЕстьNULL(ЗаказПокупателяТовары.НомерСтроки,1000) НомерСтроки,
		|	ЗаказыПокупателейОстаткиИОбороты.Номенклатура КАК Номенклатура,
		|	ЗаказыПокупателейОстаткиИОбороты.Номенклатура.ЕдиницаХраненияОстатков КАК ЕдиницаХраненияОстатков,
		|	ЗаказыПокупателейОстаткиИОбороты.КоличествоПриход КАК Запланировано,
		|	ЗаказыПокупателейОстаткиИОбороты.КоличествоРасход КАК ОтгруженоОтменено,
		|	ЗаказыПокупателейОстаткиИОбороты.КоличествоКонечныйОстаток КАК ОсталосьОтгрузить,
		|   ЕстьNULL(ПродажиОбороты.КоличествоОборот,0) ТолькоКоличествоПродано,
		|	РезервыКомпании.КоличествоОстаток КАК Резерв,
		|	ЕстьNULL(ОстаткиТоваров.КоличествоОстаток,0) КоличествоОстаток,
		|	ЕстьNULL(ОстаткиТоваров.КоличествоОстаток,0)-ЕстьNULL(ЗаказыПокупателейОстаткиИОбороты.КоличествоКонечныйОстаток,0) ОстатокПослеОтгрузки,
		|	ЕстьNULL(ОстаткиТоваров.КоличествоОстаток,0)-ЕстьNULL(РезервыКомпании.КоличествоОстаток,0) СвободныйОстаток,
		|	ЕстьNULL(ОстаткиТоваров.КоличествоОстаток,0)-ЕстьNULL(РезервыКомпании.КоличествоОстаток,0)-ЕстьNULL(ЗаказыПокупателейОстаткиИОбороты.КоличествоКонечныйОстаток,0) СвободныйОстатокПослеОтгрузки
		|ИЗ
		|	РегистрНакопления.ЗаказыПокупателей.ОстаткиИОбороты(,,,,ЗаказПокупателя=&ТекущийДокумент) КАК ЗаказыПокупателейОстаткиИОбороты
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.Продажи.Обороты(, , , ЗаказПокупателя = &ТекущийДокумент) КАК ПродажиОбороты
		|ПО ЗаказыПокупателейОстаткиИОбороты.Номенклатура =  ПродажиОбороты.Номенклатура
		|И ЗаказыПокупателейОстаткиИОбороты.ХарактеристикаНоменклатуры =  ПродажиОбороты.ХарактеристикаНоменклатуры
        |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ЗаказыПокупателей.Остатки(, ЗаказПокупателя.Проверен  И ЗаказПокупателя<>&ТекущийДокумент
		|И НЕ ЗаказПокупателя.Транзит
		|		) КАК РезервыКомпании
		|		ПО ЗаказыПокупателейОстаткиИОбороты.ХарактеристикаНоменклатуры = РезервыКомпании.ХарактеристикаНоменклатуры 
		|			И ЗаказыПокупателейОстаткиИОбороты.Номенклатура = РезервыКомпании.Номенклатура
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыНаСкладах.Остатки(, НЕ Склад.ЗапретитьИспользование 
		|И НЕ Склад.Транзитный
		|		) КАК ОстаткиТоваров
		|		ПО ЗаказыПокупателейОстаткиИОбороты.Номенклатура = ОстаткиТоваров.Номенклатура 
		|			И ЗаказыПокупателейОстаткиИОбороты.ХарактеристикаНоменклатуры = ОстаткиТоваров.ХарактеристикаНоменклатуры
		|		ЛЕВОЕ СОЕДИНЕНИЕ
		|		(ВЫБРАТЬ НомерСтроки,Номенклатура,ХарактеристикаНоменклатуры ИЗ	Документ.ЗаказПокупателя.Товары ГДЕ Ссылка = &ТекущийДокумент) КАК ЗаказПокупателяТовары
		|		ПО	ЗаказыПокупателейОстаткиИОбороты.Номенклатура = ЗаказПокупателяТовары.Номенклатура И
		|		ЗаказыПокупателейОстаткиИОбороты.ХарактеристикаНоменклатуры = ЗаказПокупателяТовары.ХарактеристикаНоменклатуры
		| ГДЕ НЕ &ОтборПоНаличию ИЛИ ЕстьNULL(ОстаткиТоваров.КоличествоОстаток,0)-ЕстьNULL(ЗаказыПокупателейОстаткиИОбороты.КоличествоКонечныйОстаток,0)>=0
		|УПОРЯДОЧИТЬ ПО 	ЕстьNULL(ЗаказПокупателяТовары.НомерСтроки,1000)" ;
		
		//Запрос.УстановитьПараметр("ДатаНачалаОтчета",НачалоДня(Заказ.Дата) ); // с начада дня Заказа
		
	Иначе // транзитный заказ - по транзитным складам
		Запрос.Текст=" ВЫБРАТЬ  ЕстьNULL(ЗаказПокупателяТовары.НомерСтроки,1000) НомерСтроки,
		|	ЗаказыПокупателейОстаткиИОбороты.Номенклатура КАК Номенклатура,
		|	ЗаказыПокупателейОстаткиИОбороты.Номенклатура.ЕдиницаХраненияОстатков КАК ЕдиницаХраненияОстатков,
		|	ЗаказыПокупателейОстаткиИОбороты.КоличествоПриход КАК Запланировано,
		|	ЗаказыПокупателейОстаткиИОбороты.КоличествоРасход КАК ОтгруженоОтменено,
		|	ЗаказыПокупателейОстаткиИОбороты.КоличествоКонечныйОстаток КАК ОсталосьОтгрузить,
		|	РезервыКомпании.КоличествоОстаток КАК Резерв,
		|	ЕстьNULL(ОстаткиТоваров.КоличествоОстаток,0) КоличествоОстаток,
		|	ЕстьNULL(ОстаткиТоваров.КоличествоОстаток,0)-ЕстьNULL(ЗаказыПокупателейОстаткиИОбороты.КоличествоКонечныйОстаток,0) ОстатокПослеОтгрузки,
		|	ЕстьNULL(ОстаткиТоваров.КоличествоОстаток,0)-ЕстьNULL(РезервыКомпании.КоличествоОстаток,0) СвободныйОстаток,
		|	ЕстьNULL(ОстаткиТоваров.КоличествоОстаток,0)-ЕстьNULL(РезервыКомпании.КоличествоОстаток,0)-ЕстьNULL(ЗаказыПокупателейОстаткиИОбороты.КоличествоКонечныйОстаток,0) СвободныйОстатокПослеОтгрузки
		|ИЗ
		|	РегистрНакопления.ЗаказыПокупателей.ОстаткиИОбороты(,,,,ЗаказПокупателя=&ТекущийДокумент) КАК ЗаказыПокупателейОстаткиИОбороты
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ЗаказыПокупателей.Остатки(, ЗаказПокупателя.Проверен 
		|		И ЗаказПокупателя.Транзит И ЗаказПокупателя.Подразделение=&Подразделение И ЗаказПокупателя<>&ТекущийДокумент) КАК РезервыКомпании
		|		ПО ЗаказыПокупателейОстаткиИОбороты.ХарактеристикаНоменклатуры = РезервыКомпании.ХарактеристикаНоменклатуры 
		|			И ЗаказыПокупателейОстаткиИОбороты.Номенклатура = РезервыКомпании.Номенклатура
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыНаСкладах.Остатки(, НЕ Склад.ЗапретитьИспользование И Склад.Транзитный И Склад.Подразделение=&Подразделение) КАК ОстаткиТоваров
		|		ПО ЗаказыПокупателейОстаткиИОбороты.Номенклатура = ОстаткиТоваров.Номенклатура 
		|			И ЗаказыПокупателейОстаткиИОбороты.ХарактеристикаНоменклатуры = ОстаткиТоваров.ХарактеристикаНоменклатуры
		|		ЛЕВОЕ СОЕДИНЕНИЕ
		|		(ВЫБРАТЬ НомерСтроки,Номенклатура,ХарактеристикаНоменклатуры	ИЗ	Документ.ЗаказПокупателя.Товары ГДЕ Ссылка = &ТекущийДокумент) КАК ЗаказПокупателяТовары
		|		ПО	ЗаказыПокупателейОстаткиИОбороты.Номенклатура = ЗаказПокупателяТовары.Номенклатура И
		|		ЗаказыПокупателейОстаткиИОбороты.ХарактеристикаНоменклатуры = ЗаказПокупателяТовары.ХарактеристикаНоменклатуры
		| ГДЕ НЕ &ОтборПоНаличию ИЛИ ЕстьNULL(ОстаткиТоваров.КоличествоОстаток,0)-ЕстьNULL(ЗаказыПокупателейОстаткиИОбороты.КоличествоКонечныйОстаток,0)>=0
		|УПОРЯДОЧИТЬ ПО 	ЕстьNULL(ЗаказПокупателяТовары.НомерСтроки,1000)";
		
	//+++ 15.12.2014	Запрос.УстановитьПараметр("Подразделение",глТекущийПользователь.ОсновноеПодразделение);
	Запрос.УстановитьПараметр("Подразделение",Заказ.Подразделение);
	КонецЕсли;	
Выборка=Запрос.Выполнить().Выбрать();

Пока Выборка.Следующий() Цикл
	ОбластьСтрока=Макет.ПолучитьОбласть("Строка");
	ОбластьСтрока.Параметры.Заполнить(Выборка);
	ОбластьСтрока.Параметры.НомерПП=Выборка.НомерСтроки;
	Если Выборка.Номенклатура <> Null Тогда
		ОбластьСтрока.Параметры.Код=Выборка.Номенклатура.Код;
	КонецЕсли;
	ДокументРезультат.Вывести (ОбластьСтрока);
КонецЦикла;	

КонецПроцедуры	