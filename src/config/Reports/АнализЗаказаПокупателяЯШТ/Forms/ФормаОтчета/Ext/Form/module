
Процедура КнопкаСформироватьНажатие(Кнопка)
	// Вставить содержимое обработчика.
КонецПроцедуры

Процедура ДействияФормыСформировать(Кнопка)
	ЭлементыФормы.ДокументРезультат.Очистить();
	СформироватьОтчет(ЭлементыФормы.ДокументРезультат, ОтборПоНаличию);	
КонецПроцедуры

Процедура ДействияФормыОтправитьПоЭлектроннойПочте(Кнопка)
	
	Если Вопрос("Вы действительно желаете отправить заказ для клиента "+ Заказ.Контрагент.Наименование, РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Нет Тогда Возврат КонецЕсли;
	
	Запрос=Новый Запрос;
	Запрос.Текст="ВЫБРАТЬ
|	Объект,
|	Тип,
|	Представление
|ИЗ
|	РегистрСведений.КонтактнаяИнформация 
|	ГДЕ Тип=&Тип И Объект=&Объект";
Запрос.УстановитьПараметр("Объект",Заказ.Контрагент);
Запрос.УстановитьПараметр("Тип",Перечисления.ТипыКонтактнойИнформации.АдресЭлектроннойПочты);

Выборка=Запрос.Выполнить().Выбрать();

Если Выборка.Следующий() И СтрДлина(СокрЛП(Выборка.Представление))>0 Тогда
	СписокФайловВложений=Новый СписокЗначений;
	ИмяФайлаСообщения=Заказ.Номер+".xls";
	ЭлементыФормы.ДокументРезультат.Записать(КаталогВременныхФайлов()+ИмяФайлаСообщения,ТипФайлаТабличногоДокумента.XLS);
    СписокФайловВложений.Добавить(КаталогВременныхФайлов()+ИмяФайлаСообщения);
	Послать(Выборка.Представление,СписокФайловВложений);
Иначе
	СообщитьОбОшибке("Адрес электронной почты для клиента "+Заказ.Контрагент.Наименование + " не указан");
КонецЕсли;	
	
КонецПроцедуры


Процедура Послать(АдресПолучателя,СписокФайловВложений)
	   //ТекстПисьма = ЭтаФорма.ЭлементыФормы.ПолеHTMLДокумента.ПолучитьТекст();
	    УЗ=  ПолучитьЗначениеПоУмолчанию(глТекущийПользователь,"ОсновнаяУчетнаяЗапись");
	    ИПП=Новый ИнтернетПочтовыйПрофиль;
		ИПП.АдресСервераSMTP=УЗ.SMTPСервер;
		ИПП.ПортSMTP=УЗ.ПортSMTP;
		Если УЗ.ТребуетсяSMTPАутентификация Тогда
			ИПП.АутентификацияSMTP = СпособSMTPАутентификации.ПоУмолчанию;
			ИПП.ПарольSMTP         = УЗ.ПарольSMTP;
			ИПП.ПользовательSMTP   = УЗ.ЛогинSMTP;
		Иначе
			ИПП.АутентификацияSMTP = СпособSMTPАутентификации.БезАутентификации;
			ИПП.ПарольSMTP         = "";
			ИПП.ПользовательSMTP   = "";
		КонецЕсли;
		Письмо=Новый ИнтернетПочтовоеСообщение;
		Письмо.Отправитель=УЗ.АдресЭлектроннойПочты;
	    Письмо.Получатели.Добавить(АдресПолучателя);
		Если ЗначениеЗаполнено(СписокФайловВложений) И СписокФайловВложений.Количество()>0 Тогда
			Для Каждого ТекАдр Из СписокФайловВложений Цикл
				Письмо.Вложения.Добавить(ТекАдр.Значение);
			КонецЦикла;
		КонецЕсли;
        Письмо.Тема="Документы поставки от ЗАО ТК Яршинторг";
	    //Письмо.Тексты.Добавить(Документ.Body.InnerHTML,ТипТекстаПочтовогоСообщения.HTML);
	    Почта=Новый ИнтернетПочта;
	    Почта.Подключиться(ИПП);
	    Почта.Послать(Письмо);
	    Почта.Отключиться();
КонецПроцедуры
