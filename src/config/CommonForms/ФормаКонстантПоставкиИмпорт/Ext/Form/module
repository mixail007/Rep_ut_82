
Процедура ПередОткрытием(Отказ, СтандартнаяОбработка)
	
	Если РольДоступна("ПравоЗавершенияРаботыПользователей") ИЛИ 
		(ПараметрыСеанса.ТекущийПользователь = Справочники.Пользователи.НайтиПоКоду("Малышев Егор") ИЛИ ПараметрыСеанса.ТекущийПользователь = Справочники.Пользователи.НайтиПоКоду("Малышев Егор (снабжение)")) Тогда
	Иначе
		Предупреждение("Нарушение прав доступа");
		Отказ = Истина;
	КонецЕсли;
	
КонецПроцедуры

Процедура УдалитьНеактуальныеНачисленияПениШтрафовНажатие(Элемент)
	
	Если ЭтаФорма.Модифицированность Тогда
		Режим = РежимДиалогаВопрос.ДаНет;
		Текст = "Данные были изменены. Сохранить?";
		Ответ = Вопрос(Текст, Режим, 0);
		Если Ответ = КодВозвратаДиалога.Нет Тогда
			Возврат;
		Иначе
			Записать();
		КонецЕсли;
	КонецЕсли;
	
	ДатаНачалаРасчетаШтрафов = Константы.ДатаНачалаРасчетаШтрафовПоСезоннымЗаказамПоставщикам.Получить();
	
	Режим = РежимДиалогаВопрос.ДаНет;
	Текст = "Удалить начисленные пени/штрафы поставщикам по сезонным заказам до " + Строка(ДатаНачалаРасчетаШтрафов) + "?";
	Ответ = Вопрос(Текст, Режим, 0);
	Если Ответ = КодВозвратаДиалога.Нет Тогда
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос();
	Запрос.Текст = "ВЫБРАТЬ
	               |	ПениИШтрафыПоставщикамОбороты.Регистратор
	               |ИЗ
	               |	РегистрНакопления.ПениИШтрафыПоставщикам.Обороты(, , Регистратор, ) КАК ПениИШтрафыПоставщикамОбороты
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	ПениИШтрафыПоставщикамОбороты.Период
	               |АВТОУПОРЯДОЧИВАНИЕ";
	Результат = Запрос.Выполнить().Выбрать();
	Пока Результат.Следующий() Цикл
				
		Если ТипЗНЧ(Результат.Регистратор) = Тип("ДокументСсылка.ЗаказПоставщику") Тогда
						
			НаборЗаписейПениИШтрафыПоставщикам = РегистрыНакопления.ПениИШтрафыПоставщикам.СоздатьНаборЗаписей();
			НаборЗаписейПениИШтрафыПоставщикам.Отбор.Регистратор.Использование	 = Истина;
			НаборЗаписейПениИШтрафыПоставщикам.Отбор.Регистратор.Значение   	 = Результат.Регистратор;
			НаборЗаписейПениИШтрафыПоставщикам.Отбор.Регистратор.ВидСравнения 	 = ВидСравнения.Равно;
			НаборЗаписейПениИШтрафыПоставщикам.Прочитать();
			НаборЗаписейПениИШтрафыПоставщикам.Очистить();
			НаборЗаписейПениИШтрафыПоставщикам.Записать();
			
			ЗаказОбъект = Результат.Регистратор.ПолучитьОбъект();
			ЗаказОбъект.Движения.ЗаказыПоставщикамСезонные.Прочитать();
			ТабДвижений = ЗаказОбъект.Движения.ЗаказыПоставщикамСезонные.Выгрузить();
			ЗаказОбъект.ДвиженияПоРегиструПениШтрафыПоставщикам(ТабДвижений);
			ЗаказОбъект.Движения.ПениИШтрафыПоставщикам.Записать();
						
		ИначеЕсли ТипЗНЧ(Результат.Регистратор) = Тип("ДокументСсылка.ОтказПоставщикаПоСезонномуЗаказу") Тогда
			
			Если Результат.Регистратор.ЗаказПоставщикуСезонный.Дата >= ДатаНачалаРасчетаШтрафов И Результат.Регистратор.НачислятьШтраф Тогда
				//ничего не делаем
			Иначе
				НаборЗаписейПениИШтрафыПоставщикам = РегистрыНакопления.ПениИШтрафыПоставщикам.СоздатьНаборЗаписей();
				НаборЗаписейПениИШтрафыПоставщикам.Отбор.Регистратор.Использование	 = Истина;
				НаборЗаписейПениИШтрафыПоставщикам.Отбор.Регистратор.Значение   	 = Результат.Регистратор;
				НаборЗаписейПениИШтрафыПоставщикам.Отбор.Регистратор.ВидСравнения 	 = ВидСравнения.Равно;
				НаборЗаписейПениИШтрафыПоставщикам.Прочитать();
				НаборЗаписейПениИШтрафыПоставщикам.Очистить();
				НаборЗаписейПениИШтрафыПоставщикам.Записать();
			КонецЕсли;	
			
		ИначеЕсли ТипЗНЧ(Результат.Регистратор) = Тип("ДокументСсылка.НачислениеШтрафовПоставщикам") Тогда
			
			НаборЗаписейПениИШтрафыПоставщикам = РегистрыНакопления.ПениИШтрафыПоставщикам.СоздатьНаборЗаписей();
			НаборЗаписейПениИШтрафыПоставщикам.Отбор.Регистратор.Использование	 = Истина;
			НаборЗаписейПениИШтрафыПоставщикам.Отбор.Регистратор.Значение   	 = Результат.Регистратор;
			НаборЗаписейПениИШтрафыПоставщикам.Отбор.Регистратор.ВидСравнения 	 = ВидСравнения.Равно;
			НаборЗаписейПениИШтрафыПоставщикам.Прочитать();
			НаборЗаписейПениИШтрафыПоставщикам.Очистить();
			
			ТаблицаСезонныхЗаказов = Результат.Регистратор.Расшифровка.Выгрузить();
			Для Каждого СтрТЗ Из ТаблицаСезонныхЗаказов Цикл
				Если СтрТЗ.ЗаказПоставщикуСезонный.Дата >= ДатаНачалаРасчетаШтрафов Тогда
					ЗаписьПениИШтрафыПоставщикам             								 = НаборЗаписейПениИШтрафыПоставщикам.Добавить();
					ЗаписьПениИШтрафыПоставщикам.Период      								 = Результат.Регистратор.Дата;
					ЗаписьПениИШтрафыПоставщикам.Контрагент  								 = СтрТЗ.ЗаказПоставщикуСезонный.Контрагент;
					ЗаписьПениИШтрафыПоставщикам.ЗаказПоставщикуСезонный					 = СтрТЗ.ЗаказПоставщикуСезонный;
					ЗаписьПениИШтрафыПоставщикам.Номенклатура								 = СтрТЗ.Номенклатура;
					ЗаписьПениИШтрафыПоставщикам.Количество									 = СтрТЗ.Количество;
					ЗаписьПениИШтрафыПоставщикам.Штраф       								 = СтрТЗ.Штраф;
					ЗаписьПениИШтрафыПоставщикам.ШтрафЗаНевыполнениеМинимальногоОбъемаЗаказа = СтрТЗ.ШтрафЗаНевыполнениеМинимальногоОбъемаЗаказа;
				КонецЕсли;
			КонецЦикла;
			НаборЗаписейПениИШтрафыПоставщикам.Записать();
		КонецЕсли;
		
		Сообщить("Обработка документа " + Строка(Результат.Регистратор));
		
	КонецЦикла;
	
 
КонецПроцедуры
