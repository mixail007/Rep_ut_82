// хранит курсы и кратности валют до загрузки с РБК
// для возможности заполнения вычисляемых полей табличного поля
// при подборе валют
Перем ТаблицаКонСреза;

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ОБЩЕГО НАЗНАЧЕНИЯ

  // Обновляет поля табличного поля "ДатаКурса", 
 //	 "Курс", "Кратность"
 //
 // Параметры:
 //  Нет.
 //
 Процедура ОбновитьСписокВалют()

	ТаблицаКонСреза = Новый ТаблицаЗначений;
	РегВалют = РегистрыСведений.КурсыВалют;
	ТаблицаКонСреза = РегВалют.СрезПоследних();

	ЭтаФорма.Обновить();

КонецПроцедуры // ОбновитьСписокВалют()
 
////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ

Процедура ПриОткрытии()

	ТаблицаКонСреза = Новый ТаблицаЗначений;
	РегВалют = РегистрыСведений.КурсыВалют;
	ТаблицаКонСреза = РегВалют.СрезПоследних();
	
	НачДата = НачалоМесяца(ТекущаяДата());
	КонДата = КонецМесяца(ТекущаяДата());
	
КонецПроцедуры // ПриОткрытии()

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ, ВЫЗЫВАЕМЫЕ ИЗ ЭЛЕМЕНТОВ ФОРМЫ

// Обработчик события "Нажатие" кнопки "ВыбПериод"
Процедура ВыбПериодНажатие(Элемент)
	
	НастройкаПериода = Новый НастройкаПериода;
	НастройкаПериода.УстановитьПериод(НачДата, КонецДня(КонДата));
	НастройкаПериода.РедактироватьКакИнтервал = Истина;
	НастройкаПериода.РедактироватьКакПериод = Истина;
	НастройкаПериода.ВариантНастройки = ВариантНастройкиПериода.Период;
	НастройкаПериода.Редактировать();
	НачДата = НастройкаПериода.ПолучитьДатуНачала();
	КонДата = НастройкаПериода.ПолучитьДатуОкончания();
	
КонецПроцедуры // ВыбПериодНажатие()

// Обработчик события выбора элемента в справочнике "Валюты"
Процедура ОбработкаВыбора(ЗначениеВыбора, Источник)
	
	СтрокаСпВалют = СписокВалют.Добавить();
	СтрокаСпВалют.Валюта = ЗначениеВыбора;
	
КонецПроцедуры // ОбработкаВыбора(ЗначениеВыбора, Источник)

// Обработчик события "ПриВыводеСтроки" поля "Валюта" списка валют
Процедура СписокВалютПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки)
	
   	ВыбраннаяВалюта = ДанныеСтроки.Валюта;
	
	Если Элемент.Колонки.КодВалюты.Видимость Тогда
		ОформлениеСтроки.Ячейки.КодВалюты.Текст = СокрЛП(ВыбраннаяВалюта.Код);
		ОформлениеСтроки.Ячейки.КодВалюты.ОтображатьТекст = Истина;
	КонецЕсли;	

	Если ТаблицаКонСреза.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;

	НайденСтрока = ТаблицаКонСреза.Найти(ВыбраннаяВалюта,"Валюта");
	Если НайденСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;	

	Если Элемент.Колонки.ДатаКурса.Видимость Тогда
		ОформлениеСтроки.Ячейки.ДатаКурса.Текст = Формат(НайденСтрока.Период,"ДФ = 'дд.ММ.гггг'");
		ОформлениеСтроки.Ячейки.ДатаКурса.ОтображатьТекст = Истина;
	КонецЕсли;	

	Если Элемент.Колонки.Курс.Видимость Тогда
		ОформлениеСтроки.Ячейки.Курс.Текст      = НайденСтрока.Курс;
		ОформлениеСтроки.Ячейки.Курс.ОтображатьТекст      = Истина;
	КонецЕсли;	

	Если Элемент.Колонки.Кратность.Видимость Тогда
		ОформлениеСтроки.Ячейки.Кратность.ОтображатьТекст = Истина;
		ОформлениеСтроки.Ячейки.Кратность.Текст = НайденСтрока.Кратность;
	КонецЕсли;	
	
КонецПроцедуры // СписокВалютПриВыводеСтроки()

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ДЕЙСТВИЯ КОМАНДНЫХ ПАНЕЛЕЙ ФОРМЫ

// Обработчик действия командной панели "ДействиеЗагрузить"
Процедура КоманднаяПанельФормыДействиеЗагрузить(Элемент)
	
	Если СписокВалют.Количество() = 0 Тогда
		Предупреждение("Заполните список валют");
		Возврат;
	КонецЕсли;	
	
	ФормаИндикации = ПолучитьОбщуюФорму("ХодВыполненияОбработкиДанных");
	ФормаИндикации.НаименованиеОбработкиДанных = "Загрузка курсов валют с сайта РосБизнесКонсалтинг";
	ФормаИндикации.КомментарийЗначения         = "Загружено:";
	ФормаИндикации.МаксимальноеЗначение         = 100;
	ФормаИндикации.Открыть();
	
	ЭлементыФормы.ТекстЗавершения.Видимость   = Ложь;

	ЗагрузитьКурсыСРБК(ФормаИндикации.Значение,ФормаИндикации.КомментарийОбработкиДанных);
	ОбновитьСписокВалют();
	ФормаИндикации.Закрыть();
	
	ЭлементыФормы.ТекстЗавершения.Видимость   = Истина;
	
КонецПроцедуры // КнопкаЗаполнитьНажатие()

// Обработчик действия командной панели "ДействиеЗаполнить"
Процедура КоманднаяПанельФормыДействиеЗаполнить(Элемент)

	СписокВалют.Очистить();
	СправочникВалюты = Справочники.Валюты;
	ВыборкаВалют = СправочникВалюты.Выбрать();
	МакетОКВ = Справочники.Валюты.ПолучитьМакет("КлассификаторВалют");
	ОбластьКоды = МакетОКВ.Область("КодЧисловой");


	Пока ВыборкаВалют.Следующий() Цикл
		ТекущаяВалюта = ВыборкаВалют.Ссылка;
		КодТекущейВалюты = СокрЛП(ТекущаяВалюта.Код);
		НайденнаяОбласть = МакетОКВ.НайтиТекст(КодТекущейВалюты,,ОбластьКоды);
		Если НайденнаяОбласть = Неопределено ИЛИ НайденнаяОбласть.Верх=2 Тогда
			Продолжить;
		КонецЕсли;	

		СтрокаСпискаВалют = СписокВалют.Добавить();
		СтрокаСпискаВалют.Валюта = ТекущаяВалюта;
	КонецЦикла;	

КонецПроцедуры // КоманднаяПанельФормыДействиеЗаполнить()

// Обработчик действия командной панели "ДействиеОчистить"
Процедура КоманднаяПанельФормыДействиеОчистить(Элемент)
	СписокВалют.Очистить();
КонецПроцедуры

// Обработчик события "ДействиеПодбор" командной панели
Процедура КоманднаяПанельФормыДействиеПодбор(Элемент)
	
	СпрВалюты = Справочники["Валюты"];
	СпрВалютыВыбор = СпрВалюты.ПолучитьФормуВыбора(,ЭтаФорма);
	СпрВалютыВыбор.РежимВыбора = Истина;
	СпрВалютыВыбор.ЗакрыватьПриВыборе = Ложь;
	СпрВалютыВыбор.Открыть();
	
КонецПроцедуры // КоманднаяПанельФормыДействиеПодбор()








