	
Процедура ПриОткрытии()
	
	ЭтаФорма.Заголовок=?(ТипЗадолженности=">0","Дебиторская","Кредиторская")+" задолженность. Подбор для контрагента "+Контрагент;
	
	ЗапрашиватьСуммуПлатежа       		= ВосстановитьЗначение("ЗапрашиватьСуммуПлатежаПриПодборе");
	ЗапрашиватьСуммуВзаиморасчетов      = ВосстановитьЗначение("ЗапрашиватьСуммуВзаиморасчетовПриПодборе");
	ЗапрашиватьКурсВзаиморасчетов       = ВосстановитьЗначение("ЗапрашиватьКурсВзаиморасчетовПриПодборе");
	ЗапрашиватьДокументПланирования     = ВосстановитьЗначение("ЗапрашиватьПланируемоеДвижениеПриПодборе");
	
	Если ИмяРегистраДолг="" Тогда
		ИмяРегистраДолг="ВзаиморасчетыСКонтрагентами";
	КонецЕсли;
	
	Если ТипЗадолженности=">0" Тогда
		ЭлементыФормы.ЗапрашиватьДокументПланирования.Заголовок="Планируемое поступление денежных средств";
	Иначе
		ЭлементыФормы.ЗапрашиватьДокументПланирования.Заголовок="Заявка на расходование средств";
	КонецЕсли;
	
	ТекстВидОперации=ВидОперацииДок.Метаданные().Имя;
	
	Если ТекстВидОперации="ВидыОперацийЗаявкиНаРасходование"
		ИЛИ ТекстВидОперации="ВидыОперацийПланируемоеПоступлениеДС" Тогда
		ЭлементыФормы.ЗапрашиватьДокументПланирования.Видимость=Ложь;
		
	Иначе	
		ЭлементыФормы.ЗапрашиватьДокументПланирования.Видимость=Истина;
	КонецЕсли;
	
	СформироватьСписокДолгов();
		
КонецПроцедуры

Процедура Переключатель1ПриИзменении(Элемент)
	
	СформироватьСписокДолгов();
	
КонецПроцедуры

Процедура ЗадолженностьДляОплатыВыбор(Элемент, ВыбраннаяСтрока, Колонка, СтандартнаяОбработка)
	
	Перем КурсВзаиморасчетов,КратностьВзаиморасчетов,СуммаПлатежа,СуммаВзаиморасчетов;
		
	Если ТипЗнч(ВыбраннаяСтрока)=Тип("Массив") Тогда
		СтрокаДоговор=ВыбраннаяСтрока[0];
	Иначе
		СтрокаДоговор=ВыбраннаяСтрока;
	КонецЕсли;
	
	ДоговорКонтрагента=СтрокаДоговор.ДоговорКонтрагента;
	Сделка=СтрокаДоговор.Сделка;
	КратностьВзаиморасчетов=СтрокаДоговор.КратностьВзаиморасчетов;
	
	СтруктураПодбора=Новый Структура;
	
	Если ЗапрашиватьКурсВзаиморасчетов 
		ИЛИ ЗапрашиватьСуммуПлатежа
		ИЛИ ЗапрашиватьСуммуВзаиморасчетов 
		ИЛИ ЗапрашиватьДокументПланирования Тогда
		
		Если ЗапрашиватьДокументПланирования И ЭлементыФормы.ЗапрашиватьДокументПланирования.Видимость Тогда
			ФормаВводПараметров = ПолучитьФорму("ВводПланируемогоДвиженияСуммыИКурса", ЭтаФорма);
		Иначе
			ФормаВводПараметров = ПолучитьФорму("ВводСуммыИКурса", ЭтаФорма);
		КонецЕсли;
		
		ФормаВводПараметров.КурсВзаиморасчетов=СтрокаДоговор.КурсВзаиморасчетов;
		ФормаВводПараметров.КратностьВзаиморасчетов=КратностьВзаиморасчетов;
		ФормаВводПараметров.СуммаПлатежа=СтрокаДоговор.СуммаПлатежа;
		ФормаВводПараметров.СуммаВзаиморасчетов=СтрокаДоговор.СуммаВзаиморасчетов;
		ФормаВводПараметров.ДатаПлатежа=ДатаДок;
	
		СтруктураПараметров = ФормаВводПараметров.ОткрытьМодально();
		
		Если ТипЗнч(СтруктураПараметров) = Тип("Структура") Тогда
			СуммаПлатежа=СтруктураПараметров.СуммаПлатежа;
			КурсВзаиморасчетов=СтруктураПараметров.КурсВзаиморасчетов;
			СуммаВзаиморасчетов=СтруктураПараметров.СуммаВзаиморасчетов;
			
			Если СтруктураПараметров.Свойство("ДокументПланирования") Тогда
				
				СтруктураПодбора.Вставить("ДокументПланирования",СтруктураПараметров.ДокументПланирования);
				СтруктураПодбора.Вставить("СтатьяДвиженияДенежныхСредств",СтатьяДвиженияДенежныхСредств);
				СтруктураПодбора.Вставить("Проект",Проект);
				СтруктураПодбора.Вставить("СуммаПлатежаПлан",СтруктураПараметров.СуммаПлатежаПлан);
				СтруктураПодбора.Вставить("КурсВзаиморасчетовПлан",СтруктураПараметров.КурсВзаиморасчетовПлан);
				
			КонецЕсли;
			
			СтруктураПодбора.Вставить("ДоговорКонтрагента",ДоговорКонтрагента);
			СтруктураПодбора.Вставить("Сделка",Сделка);
			СтруктураПодбора.Вставить("СуммаПлатежа",СуммаПлатежа);
			СтруктураПодбора.Вставить("КурсВзаиморасчетов",КурсВзаиморасчетов);
			СтруктураПодбора.Вставить("КратностьВзаиморасчетов",КратностьВзаиморасчетов);
			СтруктураПодбора.Вставить("СуммаВзаиморасчетов",СуммаВзаиморасчетов);
			
			ОповеститьОВыборе(СтруктураПодбора);
				
		ИначеЕсли СтруктураПараметров="АвтоПодбор" Тогда
						
			ОповеститьОВыборе(СтруктураПараметров);
			
		Иначе
			
			Возврат; // форма ввода параметров расшифровки закрыта не по кнопке "ОК"
			
		КонецЕсли;
		
	Иначе
		
		СуммаПлатежа=СтрокаДоговор.СуммаПлатежа;
		КурсВзаиморасчетов=СтрокаДоговор.КурсВзаиморасчетов;
		СуммаВзаиморасчетов=СтрокаДоговор.СуммаВзаиморасчетов;
		
		СтруктураПодбора.Вставить("ДоговорКонтрагента",ДоговорКонтрагента);
		СтруктураПодбора.Вставить("Сделка",Сделка);
		СтруктураПодбора.Вставить("СуммаПлатежа",СуммаПлатежа);
		СтруктураПодбора.Вставить("КурсВзаиморасчетов",КурсВзаиморасчетов);
		СтруктураПодбора.Вставить("КратностьВзаиморасчетов",КратностьВзаиморасчетов);
		СтруктураПодбора.Вставить("СуммаВзаиморасчетов",СуммаВзаиморасчетов);
		
		ОповеститьОВыборе(СтруктураПодбора);
		
	КонецЕсли;
				
КонецПроцедуры

Процедура ПриЗакрытии()
	
	СохранитьЗначение("ЗапрашиватьСуммуПлатежаПриПодборе", ЗапрашиватьСуммуПлатежа);
	СохранитьЗначение("ЗапрашиватьСуммуВзаиморасчетовПриПодборе", ЗапрашиватьСуммуВзаиморасчетов);
	СохранитьЗначение("ЗапрашиватьПланируемоеДвижениеПриПодборе", ЗапрашиватьДокументПланирования);
	СохранитьЗначение("ЗапрашиватьКурсВзаиморасчетовПриПодборе", ЗапрашиватьКурсВзаиморасчетов);
	
КонецПроцедуры

Процедура ЗадолженностьДляОплатыПриПолученииДанных(Элемент, ОформленияСтрок)
	
	Для Каждого Строка Из ОформленияСтрок Цикл
		Если ТипЗнч(Строка.ДанныеСтроки.Сделка)=Тип("ДокументСсылка.ПоступлениеТоваровУслуг") Тогда
			Строка.Ячейки.ВходящийНомер.Значение=Строка.ДанныеСтроки.Сделка.НомерВходящегоДокумента;
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры






