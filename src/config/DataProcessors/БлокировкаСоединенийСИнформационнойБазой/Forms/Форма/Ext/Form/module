////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ

// Процедура - обработчик события "ПередОткрытием" формы
//
Процедура ПередОткрытием(Отказ, СтандартнаяОбработка)
	
	// получаем значения параметров ранее установленной блокировки	
	ТекущийРежим = ПолучитьБлокировкуУстановкиСоединений();
	
	УстановитьБлокировкуСоединений 	= ТекущийРежим.Установлена;
	Сообщение						= ТекущийРежим.Сообщение;
	КодРазрешения					= ТекущийРежим.КодРазрешения;
	
	Если УстановитьБлокировкуСоединений Тогда
		НачалоБлокировки 				= ТекущийРежим.Начало;
		ОкончаниеБлокировки				= ТекущийРежим.Конец;
		
		Предупреждение("Блокировка уже включена
		|c "+НачалоБлокировки+" по "+ОкончаниеБлокировки+"
		|Код: "+КодРазрешения, 30);
		
	Иначе	
		// если блокировка не установлена, можно предположить, что
		// пользователь открыл форму для установки блокировки. 
		// Поэтому устанавливаем дату блокировки равной текущей дате	
		УстановитьБлокировкуСоединений 	= Истина;
		НачалоБлокировки    = ТекущаяДата() + 3*60; //через 3 мин.
		ОкончаниеБлокировки = НачалоБлокировки + 10 * 60; // на 7 мин.
		Сообщение						= "Доступ к этой база 1С будет закрыт с "+Формат(НачалоБлокировки,"ДФ=HH:mm")+" по "+Формат(ОкончаниеБлокировки,"ДФ=HH:mm");
		КодРазрешения = "1234";
		
	КонецЕсли;			
КонецПроцедуры // ПередОткрытием

// Процедура - обработчик события "ПриОткрытии" формы
//
Процедура ПриОткрытии()
	
	ЭлементыФормы.ПанельКодРазрешения.Свертка = РежимСверткиЭлементаУправления.Нет;
	
	// в случае, если пользователь не имеет административных прав - 
	// предоставляем ему возможность только просмотра данных блокировки!
	Если Не  (РольДоступна("ПолныеПрава") или РольДоступна("ПравоЗавершенияРаботыПользователей") )  Тогда
		ТолькоПросмотр = Истина;
		ЭлементыФормы.ПанельКодРазрешения.Свертка = РежимСверткиЭлементаУправления.Низ;
		ЭлементыФормы.Сообщение.УстановитьПривязку(ГраницаЭлементаУправления.Низ,
		                                             ЭлементыФормы.ПанельКодРазрешения, ГраницаЭлементаУправления.Верх);
		Предупреждение("Данная обработка доступна только для Пользователей с полными правами!", 30);
	КонецЕсли;		
КонецПроцедуры // ПриОткрытии()


////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ ЭЛЕМЕНТОВ ФОРМЫ

// Процедура устанавливает блокировку соединений
//
Процедура КнопкаВыполнитьНажатие(Кнопка)
	
	Если УстановитьБлокировкуСоединений Тогда
		
		// проверки возможности установки блокировки				
		Если ЗначениеЗаполнено(ОкончаниеБлокировки) и  НачалоБлокировки > ОкончаниеБлокировки Тогда
			Сообщить("Дата окончания блокировки не может быть меньше даты начала блокировки. Блокировка не установлена...", СтатусСообщения.Важное);
			Возврат;
		КонецЕсли;	
				
		ТекстВопроса = "После установки блокировки в информационной базе будет запущен 
		|режим завершения работы всех пользователей на период действия блокировки.
		|Вы действительно хотите установить блокировку?";
		
		Ответ = Вопрос(ТекстВопроса, РежимДиалогаВопрос.ДаНетОтмена, 60,КодВозвратаДиалога.Нет, "Установка блокировки соединений с информационной базой");
		
		Если Ответ <> КодВозвратаДиалога.Да Тогда
			Возврат;
        КонецЕсли;	       
	КонецЕсли;	
	
	УстановитьБлокировку(); 		
КонецПроцедуры // КнопкаВыполнитьНажатие(Кнопка)

// Процедура выбора периода блокировки
//
Процедура ВыбПериодНажатие(Элемент)
	НастройкаПериода = Новый НастройкаПериода;
	
	НастройкаПериода.УстановитьПериод(НачалоБлокировки, ?(ОкончаниеБлокировки = '0001-01-01', ОкончаниеБлокировки, КонецДня(ОкончаниеБлокировки)));
	
	НастройкаПериода.РедактироватьКакИнтервал 	= Истина;
	НастройкаПериода.РедактироватьКакПериод 	= Истина;
	НастройкаПериода.ВариантНастройки 			= ВариантНастройкиПериода.Период;
	
	Если НастройкаПериода.Редактировать() Тогда
		НачалоБлокировки 	= НастройкаПериода.ПолучитьДатуНачала();
		ОкончаниеБлокировки = НастройкаПериода.ПолучитьДатуОкончания();
	КонецЕсли;
	
	Сообщение	= "Доступ к этой база 1С будет закрыт с "+Формат(НачалоБлокировки,"ДФ=HH:mm")+" по "+Формат(ОкончаниеБлокировки,"ДФ=HH:mm");

КонецПроцедуры // ВыбПериодНажатие


Процедура НачалоБлокировкиПриИзменении(Элемент)
	ОкончаниеБлокировки = НачалоБлокировки + 10 * 60; // на 10 мин.
	Сообщение	= "Доступ к этой база 1С будет закрыт с "+Формат(НачалоБлокировки,"ДФ=HH:mm")+" по "+Формат(ОкончаниеБлокировки,"ДФ=HH:mm");
КонецПроцедуры

Процедура ОкончаниеБлокировкиПриИзменении(Элемент)
		Сообщение	= "Доступ к этой база 1С будет закрыт с "+Формат(НачалоБлокировки,"ДФ=HH:mm")+" по "+Формат(ОкончаниеБлокировки,"ДФ=HH:mm");
КонецПроцедуры



