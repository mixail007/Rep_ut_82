Процедура АвтообменФайловыйВариантПриИзменении(Элемент)
	
	АвтообменНастроитьВидимостьЭлементов();
	
КонецПроцедуры

Процедура АвтообменСерверныйВариантПриИзменении(Элемент)
	
	АвтообменНастроитьВидимостьЭлементов();
	
КонецПроцедуры

Процедура АвтообменПутьКБазеНачалоВыбора(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	Режим = РежимДиалогаВыбораФайла.ВыборКаталога;
	ДиалогВыбораКаталога = Новый ДиалогВыбораФайла(Режим);
	ДиалогВыбораКаталога.Каталог = Элемент.Значение;
	ДиалогВыбораКаталога.Заголовок = "Укажите расположение базы данных...";
	Если ДиалогВыбораКаталога.Выбрать() Тогда
		Элемент.Значение = ДиалогВыбораКаталога.Каталог;
	Иначе
	    Предупреждение("Каталог базы данных не выбран!");	    
	КонецЕсли;
	
КонецПроцедуры

Процедура АвтообменПользовательНачалоВыбора(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	МассивПользователейИБ = ПользователиИнформационнойБазы.ПолучитьПользователей();
	
	Если МассивПользователейИБ.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	СписокПользователейИБ = Новый СписокЗначений;
	Для Каждого Элемент Из МассивПользователейИБ Цикл
		СписокПользователейИБ.Добавить(Элемент.Имя);
	КонецЦикла;
		
	Результат = СписокПользователейИБ.ВыбратьЭлемент("Выберите пользователя ...");
	Если Не Результат = Неопределено Тогда
		АвтообменПользователь = Результат.Значение;
	КонецЕсли;
	
КонецПроцедуры

Процедура АвтообменПутьКМодулюНачалоВыбора(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка 		= Ложь;
	МодульСохраненВСправочнике 	= Ложь;
	ВыбиратьМодульНаДиске		= Истина;
	
	ИмяФайла = Элемент.Значение;
	
	Попытка
		Если Прав(СокрЛП(ЭтотОбъект.ИспользуемоеИмяФайла),3) = "tmp" Тогда 
			МодульСохраненВСправочнике = Истина;		
		КонецЕсли;
	Исключение
	КонецПопытки;
	
	Если Не ЗначениеЗаполнено(ИмяФайла) И МодульСохраненВСправочнике Тогда
		
		Кнопки = Новый СписокЗначений;
		Кнопки.Добавить(КодВозвратаДиалога.Да, 	"Да, хочу сохранить");
		Кнопки.Добавить(КодВозвратаДиалога.Нет,	"Нет, выберу файл модуля");
		Ответ = Вопрос("Запущенная версия модуля сохранена в справочнике ""Внешние обработки""." + Символы.ПС + "Хотите сохранить модуль на диск и использовать его автообмена?", Кнопки, , КодВозвратаДиалога.Нет, "Сохранение модуля...");
		
		Если Ответ = КодВозвратаДиалога.Да Тогда
			
			Запрос = Новый Запрос();
			Запрос.Текст = 
			"ВЫБРАТЬ
           	|	ВнешниеОбработки.Ссылка
           	|ИЗ
           	|	Справочник.ВнешниеОбработки КАК ВнешниеОбработки
           	|ГДЕ
           	|	ВнешниеОбработки.ВидОбработки = &ВидОбработки
           	|    И НЕ ВнешниеОбработки.ПометкаУдаления
           	|УПОРЯДОЧИТЬ ПО
           	|	ВнешниеОбработки.Наименование";					   
			Запрос.УстановитьПараметр("ВидОбработки",Перечисления.ВидыДополнительныхВнешнихОбработок.Обработка);	
			ТЗ = Запрос.Выполнить().Выгрузить();
			
			ВыбраннаяСтрока = ТЗ.ВыбратьСтроку("Выберите обработку с модулем Контур.Фокус");
			Если НЕ ВыбраннаяСтрока = Неопределено Тогда
				
				МодульОбъект 	= ВыбраннаяСтрока.Ссылка.ПолучитьОбъект();
							
				Режим = РежимДиалогаВыбораФайла.Сохранение;
				ДиалогСохраненияФайла = Новый ДиалогВыбораФайла(Режим);
				ДиалогСохраненияФайла.ПолноеИмяФайла = "Контур.Фокус";
				Фильтр = "Внешняя обработка 1С:Предприятия 8 " + "(*.epf)|*.epf";
				ДиалогСохраненияФайла.Фильтр = Фильтр;
				ДиалогСохраненияФайла.МножественныйВыбор = Ложь;
				ДиалогСохраненияФайла.Заголовок = "Выберите место сохранения файла ...";
				Если ДиалогСохраненияФайла.Выбрать() Тогда
					МассивФайлов = ДиалогСохраненияФайла.ВыбранныеФайлы;
					ИмяФайла = МассивФайлов[0];
				Иначе
					Предупреждение("Файл автозапуска не сохранен!");
					Возврат;
				КонецЕсли;
								
				ДвоичныеДанные 	= МодульОбъект.ХранилищеВнешнейОбработки.Получить();
				ДвоичныеДанные.Записать(ИмяФайла);
				
				ВыбиратьМодульНаДиске = Ложь;
				
			Иначе
				Возврат;
			КонецЕсли;
			
		КонецЕсли;
			
	КонецЕсли;
	
	Если ВыбиратьМодульНаДиске Тогда
	
		Режим = РежимДиалогаВыбораФайла.Открытие;
		ДиалогОткрытияФайла = Новый ДиалогВыбораФайла(Режим);
		ДиалогОткрытияФайла.ПолноеИмяФайла = "";
		Фильтр = "Внешняя обработка 1С:Предприятия 8 " + "(*.epf)|*.epf";
		ДиалогОткрытияФайла.Фильтр = Фильтр;
		ДиалогОткрытияФайла.МножественныйВыбор = Ложь;
		ДиалогОткрытияФайла.Заголовок = "Укажите расположение файла модуля ""Контур.Фокус""...";
		Если ДиалогОткрытияФайла.Выбрать() Тогда
		    МассивФайлов = ДиалогОткрытияФайла.ВыбранныеФайлы;
			ИмяФайла = МассивФайлов[0];
		Иначе
		    Предупреждение("Файл модуля ""Контур.Фокус"" не выбран!");	    
		КонецЕсли;
		
	КонецЕсли;
 
    Элемент.Значение = ИмяФайла;
	
КонецПроцедуры

Процедура АвтообменНастроитьВидимостьЭлементов()
	
	Если АвтообменВариантБазыДанных = "ФайловыйВариант" Тогда
		ЭлементыФормы.НадписьАвтообменПутьКБазе.Видимость 		= Истина;
		ЭлементыФормы.АвтообменПутьКБазе.Видимость				= Истина;
		ЭлементыФормы.НадписьАвтообменСерверИмяБазы.Видимость 	= Ложь;
		ЭлементыФормы.НадписьАвтообменРазделитель.Видимость 	= Ложь;
		ЭлементыФормы.АвтообменСервер.Видимость 				= Ложь;
		ЭлементыФормы.АвтообменИмяБазы.Видимость 				= Ложь;
	ИначеЕсли АвтообменВариантБазыДанных = "СерверныйВариант" Тогда
		ЭлементыФормы.НадписьАвтообменСерверИмяБазы.Видимость 	= Истина;
		ЭлементыФормы.НадписьАвтообменРазделитель.Видимость 	= Истина;
		ЭлементыФормы.АвтообменСервер.Видимость 				= Истина;
		ЭлементыФормы.АвтообменИмяБазы.Видимость 				= Истина;
		ЭлементыФормы.НадписьАвтообменПутьКБазе.Видимость 		= Ложь;
		ЭлементыФормы.АвтообменПутьКБазе.Видимость				= Ложь;
	КонецЕсли;			
	
КонецПроцедуры

Процедура АвтообменСохранитьБатФайлНажатие(Элемент)
	
	ЕстьОшибки = Ложь;
	
	Если АвтообменВариантБазыДанных = "ФайловыйВариант" Тогда
		Если Не ЗначениеЗаполнено(АвтообменПутьКБазе) Тогда
			Сообщить("Не заполнено обязательное поле ""Путь к базе""");
			ЕстьОшибки = Истина;
		КонецЕсли;
	ИначеЕсли АвтообменВариантБазыДанных = "СерверныйВариант" Тогда
		Если Не ЗначениеЗаполнено(АвтообменСервер) Тогда
			Сообщить("Не заполнено обязательное поле ""Сервер""");
			ЕстьОшибки = Истина;
		КонецЕсли;
		Если Не ЗначениеЗаполнено(АвтообменИмяБазы) Тогда
			Сообщить("Не заполнено обязательное поле ""Имя базы""");
			ЕстьОшибки = Истина;
		КонецЕсли;
	КонецЕсли;
		
	Если Не ЗначениеЗаполнено(АвтообменПользователь) Тогда
		Сообщить("Не заполнено необязательное поле ""Пользователь""");
	КонецЕсли;
	Если Не ЗначениеЗаполнено(АвтообменПутьКМодулю) Тогда
		Сообщить("Не заполнено обязательное поле ""Путь к модулю""");
		ЕстьОшибки = Истина;
	КонецЕсли;
	
	Если ЕстьОшибки Тогда
		Предупреждение("Не заполнены одно или несколько обязательных полей!");
		Возврат;
	КонецЕсли;		
	
	ПакетнаяКоманда = "";
	
	ПакетнаяКоманда = ПакетнаяКоманда + """" + КаталогПрограммы() + "1cv8.exe" + """ ";
	ПакетнаяКоманда = ПакетнаяКоманда + "enterprise ";
	Если АвтообменВариантБазыДанных = "ФайловыйВариант" Тогда
		ПакетнаяКоманда = ПакетнаяКоманда + "/F" + " " + """" + АвтообменПутьКБазе + """ ";
	ИначеЕсли АвтообменВариантБазыДанных = "СерверныйВариант" Тогда
		ПакетнаяКоманда = ПакетнаяКоманда + "/S" + " " + """" + АвтообменСервер + "\" + АвтообменИмяБазы + """ ";	
	КонецЕсли;
	ПакетнаяКоманда = ПакетнаяКоманда + "/N" + " " + """" + АвтообменПользователь + """" + " " + "/P" + " " + """" + АвтообменПароль + """ ";
	ПакетнаяКоманда = ПакетнаяКоманда + "/Execute" + " " + """" + АвтообменПутьКМодулю + """";
	
	ИмяБатФайла = "";
	
	Режим = РежимДиалогаВыбораФайла.Сохранение;
	ДиалогСохраненияФайла = Новый ДиалогВыбораФайла(Режим);
	ДиалогСохраненияФайла.ПолноеИмяФайла = "Автозапуск Контур.Фокус";
	Фильтр = "Пакетный файл Windows" + "(*.bat)|*.bat";
	ДиалогСохраненияФайла.Фильтр = Фильтр;
	ДиалогСохраненияФайла.МножественныйВыбор = Ложь;
	ДиалогСохраненияФайла.Заголовок = "Выберите место сохранения файла ...";
	Если ДиалогСохраненияФайла.Выбрать() Тогда
		МассивФайлов = ДиалогСохраненияФайла.ВыбранныеФайлы;
		ИмяБатФайла = МассивФайлов[0];
	Иначе
		Предупреждение("Файл автозапуска не сохранен!");	    
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ИмяБатФайла) Тогда
		Попытка
			БатФайл = Новый ЗаписьТекста(ИмяБатФайла, КодировкаТекста.OEM);
			БатФайл.ЗаписатьСтроку(ПакетнаяКоманда);
			БатФайл.Закрыть();
			Предупреждение("Файл автозапуска успешно сохранен!");
		Исключение
			Сообщить("Не удалось записать файл: " + ОписаниеОшибки());
		КонецПопытки;
	КонецЕсли;
	
КонецПроцедуры

