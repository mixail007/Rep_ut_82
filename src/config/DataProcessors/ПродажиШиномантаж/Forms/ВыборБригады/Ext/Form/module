Перем ТаблицаРаботников;
Перем Подразделение;

Процедура КнопкаВыполнитьНажатие(Кнопка)
	// Вставить содержимое обработчика.
КонецПроцедуры

Процедура ОсновныеДействияФормыОК(Кнопка)
	
	ТаблицаРаботников = новый ТаблицаЗначений;
	ТаблицаРаботников.Колонки.Добавить("ФизЛицо");
	ТаблицаРаботников.Колонки.Добавить("Пользователь");
	ТаблицаРаботников.Колонки.Добавить("Коэффициент");
	ТаблицаРаботников.Колонки.Добавить("Сумма");
	ТаблицаРаботников.Колонки.Добавить("Подразделение");
	
	СуммаКоэффициентов = ПолучитьСуммуКоэффициентов();
	
	Для Каждого Стр из СоставБригады Цикл
		Если (Стр.ЕстьФл) Тогда 
			СтрДоб 					= ТаблицаРаботников.Добавить();
			СтрДоб.ФизЛицо 			= Стр.ФизическоеЛицо;
			СтрДоб.Пользователь		= Стр.Пользователь;
			СтрДоб.Коэффициент 		= Стр.Коэффициент;
			СтрДоб.Сумма			= Цел(Сумма/СуммаКоэффициентов*100)/100 * ?(Стр.Коэффициент=0,1,Стр.Коэффициент); 
			СтрДоб.Подразделение 	= Стр.Подразделение;
		КонецЕсли;
	КонецЦикла;
	
	Закрыть(ТаблицаРаботников);            
	
КонецПроцедуры

Функция ПолучитьСуммуКоэффициентов()
	
	СуммаКоэфф = 0;
	Для Каждого Стр из СоставБригады Цикл
		Если (Стр.ЕстьФл) Тогда 
			СуммаКоэфф = СуммаКоэфф + ?(Стр.Коэффициент=0,1,Стр.Коэффициент); 
		КонецЕсли;
	КонецЦикла;

	Возврат ?(СуммаКоэфф=0,1,СуммаКоэфф);
	
КонецФункции

Процедура ПередЗакрытием(Отказ, СтандартнаяОбработка)
	
	Если ((ТаблицаРаботников = Неопределено)) Тогда 
		Сообщить("Должен быть выбран хотя бы один работник.");	
		Отказ = Истина;
	Иначе 
		Если (ТаблицаРаботников.Количество()=0) Тогда 
			Сообщить("Должен быть выбран хотя бы один работник.");		
			Отказ = Истина;
		КонецЕсли;			
	КонецЕсли;
КонецПроцедуры

Процедура ДеревоВыбор(Элемент, ВыбраннаяСтрока, Колонка, СтандартнаяОбработка)
	
	СоставБригады.Очистить();
	ЗаполнитьБригаду(ВыбраннаяСтрока);
	Подразделение = ВыбраннаяСтрока.Подразделение;
	СтандартнаяОбработка = Ложь;
	
КонецПроцедуры

Процедура ЗаполнитьБригаду(ВыбраннаяСтрока)
	
	Если (ТипЗнч(ВыбраннаяСтрока) = ТипЗнч(Справочники.БригадыРаботниковСферыУслуг.ПустаяСсылка())) Тогда 
		
		Для Каждого Стр из ВыбраннаяСтрока.ФизическиеЛица Цикл
			
			СтрДоб = СоставБригады.Добавить();
			СтрДоб.ЕстьФл = Истина;
			СтрДоб.ФизическоеЛицо = Стр.ФизическоеЛицо;
			СтрДоб.Коэффициент = Стр.Коэффициент;
			
		КонецЦикла
		
	КонецЕсли;
		
КонецПроцедуры

Процедура ПриОткрытии()
	Подразделение = Справочники.Подразделения.ПустаяСсылка();
	
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|Выбрать СФЛ.Ссылка как Ссылка, СПП.Ссылка как Пользователь из 
	|Справочник.ФизическиеЛица как СФЛ
	|Левое Соединение
	|Справочник.Пользователи как СПП 
	|По СФЛ.ССылка = СПП.ФизЛицо 
	|Левое соединение
	|РегистрСведений.НастройкиПользователей как РНП 
	|По
	|СПП.Ссылка = РНП.Пользователь
	|Левое соединение
	|ПланВидовХарактеристик.НастройкиПользователей как ПНП По 
	|РНП.Настройка = ПНП.Ссылка
	|Где (РНП.Настройка=&Настройка) и (РНП.Значение=&Подразделение) И
	|(СФЛ.Ссылка.ПометкаУдаления = Ложь) и (СПП.Ссылка.ПометкаУдаления = Ложь)";
	
	Запрос.УстановитьПараметр("Настройка",ПланыВидовХарактеристик.НастройкиПользователей.ОсновноеПодразделение);
	Запрос.УстановитьПараметр("Подразделение",ПолучитьЗначениеПоУмолчанию(глТекущийПользователь,"ОсновноеПодразделение"));
	
	Выб = Запрос.Выполнить().Выбрать();
	
	Пока Выб.Следующий() Цикл
		
		Стр = СоставБригады.Добавить();
		Стр.ФизическоеЛицо = Выб.Ссылка;
		Стр.Пользователь = Выб.Пользователь;
		Стр.ЕстьФл = Ложь;
		Стр.Подразделение = ПолучитьЗначениеПоУмолчанию(Выб.Пользователь,"ОсновноеПодразделение");		
		
	КонецЦикла
	
КонецПроцедуры

Процедура ОКНажатие(Элемент)
	ОсновныеДействияФормыОК(ЭлементыФормы.КоманднаяПанель2.Кнопки.Действие8);
КонецПроцедуры
                