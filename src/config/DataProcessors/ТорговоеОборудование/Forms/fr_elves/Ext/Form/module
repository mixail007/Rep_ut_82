// Установление соединения с ФР
//
// Параметры:
//  Объект       - возвращаемый объект подключенного торгового оборудования
//  Пароль       - пароль пользователя
//  НомерЛУ      - номер логического устройства с который связан Объект
//
// Возвращаемое значение:
//  строка с представлением ошибки если она произошла, иначе пустая строка
//
Функция ПодключитьсяКФР(Объект, Пароль, НомерЛУ)

	Попытка
		Объект.LDNumber = Число(НомерЛУ);
		Объект.SetActiveLD();
	Исключение
	КонецПопытки;

	Объект.Password = Пароль;
	Объект.Connect();

	Если Объект.ResultCode<>0 Тогда
		ОписаниеРезультата = Объект.ResultCodeDescription;
		Объект.Disconnect();
		Возврат ОписаниеРезультата;
	КонецЕсли;

	Возврат "";

КонецФункции // ПодключитьсяКФР()

// Отключение от ФР
//
// Параметры:
//  Объект       - возвращаемый объект подключенного торгового оборудования
//  Пароль       - пароль пользователя
//  НомерЛУ      - номер логического устройства с который связан Объект
//
// Возвращаемое значение:
//  строка с представлением ошибки если она произошла, иначе пустая строка
//
Функция ОтключитьсяОтФР(Объект, Пароль, НомерЛУ) Экспорт

	Попытка
		Объект.LDNumber = Число(НомерЛУ);
		Объект.SetActiveLD();
	Исключение
	КонецПопытки;

	Объект.Password = Пароль;
	Объект.Disconnect();

	Если Объект.ResultCode<>0 Тогда
		ОписаниеРезультата = Объект.ResultCodeDescription;
		Возврат ОписаниеРезультата;
	КонецЕсли;

	Возврат "";

КонецФункции

// Отрезание чека на ФР
//
// Параметры:
//  Объект       - объект фискальный регистратор
//  Пароль       - пароль пользователя
//
Процедура ОтрезатьЧек(Объект, Пароль)

	Ошибка=80;	//Идет печать предыдущей команды
	
	Пока Ошибка=80 Цикл
		Попытка
			Объект.Password = Пароль;
			Объект.CutType  = 1;
			Объект.CutCheck();
	
			Ошибка = Объект.ResultCode;
		Исключение
			Ошибка = -1;
		КонецПопытки;
	КонецЦикла;
	
КонецПроцедуры // ОтрезатьЧек()

// Анулирование чека на ФР
//
// Параметры:
//  Объект       - объект фискальный регистратор
//  Пароль       - пароль пользователя
//
Функция АннулироватьЧек(Объект, Пароль, НомерЛУ = 1, Подключаться = Ложь) Экспорт;

	ЗаписатьСтрокуЛогаКассы("Начало аннулирования.(АннулироватьЧекЭлвес)");
	Если Подключаться Тогда

		Если Объект = Неопределено Тогда
			ОписаниеРезультата = "устройство не подключено";
			Возврат ОписаниеРезультата;
		КонецЕсли;
		
        ЗаписатьСтрокуЛогаКассы("Подключиться к ФР. (АннулироватьЧекЭлвес)");
		ОписаниеРезультата = ПодключитьсяКФР(Объект, Пароль, НомерЛУ);
		ЗаписатьСтрокуЛогаКассы("Завершение подключения к ФР. (АннулироватьЧекЭлвес)");
		Если НЕ ПустаяСтрока(ОписаниеРезультата) Тогда
			Возврат ОписаниеРезультата;
		КонецЕсли;

	КонецЕсли;

	ОписаниеРезультата = "";
	Попытка
		Если Объект.ECRMode = 8 И Объект.ECRAdvancedMode = 3 Тогда
			Попытка
				ЗаписатьСтрокуЛогаКассы("Объект.ContinuePrint().АннулироватьЧекЭлвес");
				Объект.ContinuePrint();
			Исключение
			КонецПопытки;
		КонецЕсли;
		Объект.Password=Пароль;
		ЗаписатьСтрокуЛогаКассы("Объект.CancelCheck().АннулироватьЧекЭлвес");
		Объект.CancelCheck();
	Исключение
		Если Объект.ResultCode <> 0 Тогда
			ОписаниеРезультата = Объект.ResultCodeDescription;
			ЗаписатьСтрокуЛогаКассы("ОтключитьсяОтФР.АннулироватьЧекЭлвес");
			ОтключитьсяОтФР(Объект, Пароль, НомерЛУ);
			Возврат ОписаниеРезультата;
		Иначе
			ОписаниеРезультата = "Неизвестная ошибка";
			Возврат ОписаниеРезультата;
		КонецЕсли;
	КонецПопытки;
	
	ЗаписатьСтрокуЛогаКассы("Конец аннулирования.АннулироватьЧекЭлвес");
	Возврат ОтключитьсяОтФР(Объект, Пароль, НомерЛУ);

КонецФункции // АннулироватьЧек()

// Открыть ящик ФР
//
// Параметры:
//  Объект       - объект фискальный регистратор
//  Пароль       - пароль пользователя
//
Функция ОткрытьЯщик(Объект, Пароль, НомерЛУ = 1);

	Если Объект = Неопределено Тогда
		ОписаниеРезультата = "устройство не подключено";
		Возврат ОписаниеРезультата;
	КонецЕсли;

	ОписаниеРезультата = ПодключитьсяКФР(Объект, Пароль, НомерЛУ);
	Если НЕ ПустаяСтрока(ОписаниеРезультата) Тогда
		Возврат ОписаниеРезультата;
	КонецЕсли;

	ОписаниеРезультата = "";
	Попытка

		Объект.Password=Пароль;
		Объект.DrawerNumber = 0;
		Объект.OpenDrawer();

		Если Объект.ResultCode <> 0 Тогда
			ОписаниеРезультата = Объект.ResultCodeDescription;
			ОтключитьсяОтФР(Объект, Пароль, НомерЛУ);
			Возврат ОписаниеРезультата;
		КонецЕсли;

	Исключение
		Если Объект.ResultCode <> 0 Тогда
			ОписаниеРезультата = Объект.ResultCodeDescription;
			ОтключитьсяОтФР(Объект, Пароль, НомерЛУ);
			Возврат ОписаниеРезультата;
		Иначе
			ОписаниеРезультата = "Неизвестная ошибка";
			Возврат ОписаниеРезультата;
		КонецЕсли;
	КонецПопытки;

	Возврат ОтключитьсяОтФР(Объект, Пароль, НомерЛУ);

КонецФункции // ОткрытьЯщик()

// Внести сумму в ящик ФР
//
// Параметры:
//  Объект       - объект фискальный регистратор
//  Пароль       - пароль пользователя
//
Функция ВнестиСумму(Объект, Пароль, Сумма, НомерЛУ = 1);

	Если Объект = Неопределено Тогда
		ОписаниеРезультата = "устройство не подключено";
		Возврат ОписаниеРезультата;
	КонецЕсли;

	ОписаниеРезультата = ПодключитьсяКФР(Объект, Пароль, НомерЛУ);
	Если НЕ ПустаяСтрока(ОписаниеРезультата) Тогда
		Возврат ОписаниеРезультата;
	КонецЕсли;

	ОписаниеРезультата = "";
	Попытка

		Объект.Password=Пароль;
		Объект.Summ1 = Сумма;
		Объект.CashIncome();

	Исключение
		Если Объект.ResultCode <> 0 Тогда
			ОписаниеРезультата = Объект.ResultCodeDescription;
			ОтключитьсяОтФР(Объект, Пароль, НомерЛУ);
			Возврат ОписаниеРезультата;
		Иначе
			ОписаниеРезультата = "Неизвестная ошибка";
			Возврат ОписаниеРезультата;
		КонецЕсли;
	КонецПопытки;

	Возврат ОтключитьсяОтФР(Объект, Пароль, НомерЛУ);
	
КонецФункции // ВнестиСумму()

// Изъять сумму из ящика ФР
//
// Параметры:
//  Объект       - объект фискальный регистратор
//  Пароль       - пароль пользователя
//
Функция ИзъятьСумму(Объект, Пароль, Сумма, НомерЛУ = 1);

	Если Объект = Неопределено Тогда
		ОписаниеРезультата = "устройство не подключено";
		Возврат ОписаниеРезультата;
	КонецЕсли;

	ОписаниеРезультата = ПодключитьсяКФР(Объект, Пароль, НомерЛУ);
	Если НЕ ПустаяСтрока(ОписаниеРезультата) Тогда
		Возврат ОписаниеРезультата;
	КонецЕсли;

	ОписаниеРезультата = "";
	Попытка

		Объект.Password=Пароль;
		Объект.Summ1 = Сумма;
		Объект.CashOutcome();

	Исключение
		Если Объект.ResultCode <> 0 Тогда
			ОписаниеРезультата = Объект.ResultCodeDescription;
			ОтключитьсяОтФР(Объект, Пароль, НомерЛУ);
			Возврат ОписаниеРезультата;
		Иначе
			ОписаниеРезультата = "Неизвестная ошибка";
			Возврат ОписаниеРезультата;
		КонецЕсли;
	КонецПопытки;

	Возврат ОтключитьсяОтФР(Объект, Пароль, НомерЛУ);

КонецФункции // ИзъятьСумму()

// Напечатать Х-отчет ФР
//
// Параметры:
//  Объект       - объект фискальный регистратор
//  Пароль       - пароль пользователя
//
Функция ХОтчет(Объект, Пароль, НомерЛУ = 1);

	Если Объект = Неопределено Тогда
		ОписаниеРезультата = "устройство не подключено";
		Возврат ОписаниеРезультата;
	КонецЕсли;

	ОписаниеРезультата = ПодключитьсяКФР(Объект, Пароль, НомерЛУ);
	Если НЕ ПустаяСтрока(ОписаниеРезультата) Тогда
		Возврат ОписаниеРезультата;
	КонецЕсли;

	ОписаниеРезультата = "";
	Попытка

		Объект.Password=Пароль;
		Объект.PrintReportWithoutCleaning();

	Исключение
		Если Объект.ResultCode <> 0 Тогда
			ОписаниеРезультата = Объект.ResultCodeDescription;
			ОтключитьсяОтФР(Объект, Пароль, НомерЛУ);
			Возврат ОписаниеРезультата;
		Иначе
			ОписаниеРезультата = "Неизвестная ошибка";
			Возврат ОписаниеРезультата;
		КонецЕсли;
	КонецПопытки;

	Возврат ОтключитьсяОтФР(Объект, Пароль, НомерЛУ);

КонецФункции // ХОтчет()

// Печать чека на ФР
//
// Параметры:
//  Объект       - объект фискальный регистратор
//  Пароль       - пароль пользователя
//  ТаблицаТоваров - таблица товаров, их цен и количества
//  Скидка       - скидка на чек
//  ПризнВозврата - признак возврата товара
//  НомерСекции  - номер секции, в которой печатается чек
//  НомерЧека    - возвращаемый номер чека
//  НомерЛУ      - номер логического устройства с который связан Объект
//
// Возвращаемое значение:
//  строка с представлением ошибки если она произошла, иначе пустая строка
//
Функция ПечататьЧек(Объект, Пароль, ТаблицаТоваров, Получено, Скидка, ПризнВозврата, НомерСекции, НомерЧека, НомерСмены, НомерЛУ)

	ЗаписатьСтрокуЛогаКассы("Начало печати чека на ФР (Элвес).ПечататьЧекЭлвес");
	Если Объект = Неопределено Тогда
		ОписаниеРезультата = "устройство не подключено";
		Возврат ОписаниеРезультата;
	КонецЕсли;

	ЗаписатьСтрокуЛогаКассы("Подключение к ФР.ПечататьЧекЭлвес");
	ОписаниеРезультата = ПодключитьсяКФР(Объект, Пароль, НомерЛУ);
	ЗаписатьСтрокуЛогаКассы("Подключились к ФР.ПечататьЧекПечататьЧекЭлвес");
	Если НЕ ПустаяСтрока(ОписаниеРезультата) Тогда
		Возврат ОписаниеРезультата;
	КонецЕсли;

	// регистрация товаров
	ЗаписатьСтрокуЛогаКассы("Регистрация товаров.ПечататьЧекЭлвес");
	Для Каждого СтрокаИзСписка Из ТаблицаТоваров Цикл
		Объект.Password          = Пароль;
		
		//Объект.StringForPrinting = СтрокаИзСписка.Товар;
		
		Если СтрДлина(СтрокаИзСписка.Товар) > Константы.ДлинаНаименованияККМ.Получить() Тогда
			
			Объект.StringForPrinting = ?(Константы.ДлинаНаименованияККМ.Получить() <> 0, Лев(СтрокаИзСписка.Товар, Константы.ДлинаНаименованияККМ.Получить()), СтрокаИзСписка.Товар);	
			
		Иначе
			
			Объект.StringForPrinting = СтрокаИзСписка.Товар;
			
		КонецЕсли; 
		
		
		Объект.Price             = СтрокаИзСписка.Цена;
		Объект.Quantity          = СтрокаИзСписка.Колво;
		Объект.Department        = НомерСекции;		
		
		Если ПризнВозврата Тогда
			Объект.ReturnSale();
		Иначе
			Объект.Sale();
		КонецЕсли;
		
		Если Объект.ResultCode <> 0 Тогда
			ОписаниеРезультата = Объект.ResultCodeDescription;
			ЗаписатьСтрокуЛогаКассы("Ошибочен результат.ПечататьЧекЭлвес");
			ЗаписатьСтрокуЛогаКассы("Аннулирование чека.ПечататьЧекЭлвес");
			АннулироватьЧек(Объект, Пароль);
			ЗаписатьСтрокуЛогаКассы("Отрезание чека.ПечататьЧекЭлвес");
			ОтрезатьЧек(Объект, Пароль);
			ЗаписатьСтрокуЛогаКассы("Отключение от ФР.ПечататьЧекЭлвес");
			ОтключитьсяОтФР(Объект, Пароль, НомерЛУ);
            ЗаписатьСтрокуЛогаКассы("Возврат в процедуру.ПечататьЧекЭлвес");
			Возврат ОписаниеРезультата;
		КонецЕсли;
	КонецЦикла;

	//Если НЕ ПризнВозврата Тогда
	ЗаписатьСтрокуЛогаКассы("Скидки.ПечататьЧекЭлвес");
		Объект.StringForPrinting = " ";
		Объект.Summ1             = Скидка;
		Если (Скидка > 0) Тогда
			Объект.Discount();
		ИначеЕсли (Скидка < 0) Тогда
			Объект.Charge();
		КонецЕсли;
		Если Объект.ResultCode <> 0 Тогда
			ЗаписатьСтрокуЛогаКассы("Ошибочен результат.ПечататьЧекЭлвес");
			ОписаниеРезультата = Объект.ResultCodeDescription;
			ЗаписатьСтрокуЛогаКассы("Аннулирование чека.ПечататьЧекЭлвес");			
			АннулироватьЧек(Объект, Пароль);
			ЗаписатьСтрокуЛогаКассы("Отрезание чека.ПечататьЧекЭлвес");
			ОтрезатьЧек(Объект, Пароль);
			ЗаписатьСтрокуЛогаКассы("Отключение от ФР.ПечататьЧекЭлвес");
			ОтключитьсяОтФР(Объект, Пароль, НомерЛУ);
            ЗаписатьСтрокуЛогаКассы("Возврат в процедуру.ПечататьЧекЭлвес");
			Возврат ОписаниеРезультата;
		КонецЕсли;

	//КонецЕсли;

	ЗаписатьСтрокуЛогаКассы("Проверки.ПечататьЧекЭлвес");
	
	Объект.Password          = Пароль;
	Объект.Summ1             = Получено; 
	Объект.Summ2             = 0; 
	Объект.Summ3             = 0; 
	Объект.Summ4             = 0; 
	Объект.StringForPrinting = " ";
	Объект.CloseCheck();

	Если Объект.ResultCode <> 0 Тогда
		ЗаписатьСтрокуЛогаКассы("Ошибочен результат.ПечататьЧекЭлвес");
		ОписаниеРезультата = Объект.ResultCodeDescription;
		ЗаписатьСтрокуЛогаКассы("Аннулирование чека.ПечататьЧекЭлвес");
		АннулироватьЧек(Объект, Пароль);
		ЗаписатьСтрокуЛогаКассы("Отрезание чека.ПечататьЧекЭлвес");
		ОтрезатьЧек(Объект, Пароль);
		ЗаписатьСтрокуЛогаКассы("Отключение от ФР.ПечататьЧекЭлвес");
		ОтключитьсяОтФР(Объект, Пароль, НомерЛУ);

		Возврат ОписаниеРезультата;
	КонецЕсли;

	ЗаписатьСтрокуЛогаКассы("Получение статуса.ПечататьЧекЭлвес");
	Объект.Password = Пароль;
	Объект.GetECRStatus();
	ЗаписатьСтрокуЛогаКассы("Статус получен.ПечататьЧекЭлвес");
	Если Объект.ResultCode <> 0 Тогда
		ОписаниеРезультата = Объект.ResultCodeDescription;
		ЗаписатьСтрокуЛогаКассы("Отключение от ФР.ПечататьЧекЭлвес");
		ОтключитьсяОтФР(Объект, Пароль, НомерЛУ);

		Возврат ОписаниеРезультата;
	КонецЕсли;

	НомерЧека = Объект.OpenDocumentNumber+?(Объект.ECRAdvancedMode=5,1,0);
	НомерСмены = Объект.SessionNumber+1;
    ЗаписатьСтрокуЛогаКассы("Отрезка чека посл.ПечататьЧекЭлвес");
	ОтрезатьЧек(Объект, Пароль);

	ЗаписатьСтрокуЛогаКассы("Отключение от ФР.ПечататьЧекЭлвес");
	Возврат ОтключитьсяОтФР(Объект, Пароль, НомерЛУ);

КонецФункции // ПечататьЧек()

Процедура ПечатьСтроки(Объект, Текст, Ширина, Результат, ПоЦентру)

	ЗаписатьСтрокуЛогаКассы("Начало печати строки.(ПечатьСтрокиЭлвес)");	
	Результат = "";

	МассивСтрок = Новый Массив();
	Строка      = Текст;
		Пока СтрДлина(Строка) > 0 Цикл
		Если СтрДлина(Строка)<=Ширина Тогда
			Врем = Лев(Строка, Ширина);
		ИначеЕсли (Сред(Строка, Ширина,1)=" ") или (Сред(Строка, Ширина+1,1)=" ")Тогда
			Врем = Лев(Строка, Ширина);
		Иначе
			Врем=Лев(Строка,ПолучитьСлово(Лев(Строка, Ширина)));
		КонецЕсли;
		
		МассивСтрок.Добавить(Врем);
		Строка = Прав(Строка, СтрДлина(Строка) - СтрДлина(Врем));
	КонецЦикла;

    ЗаписатьСтрокуЛогаКассы("Начало печати строк.(ПечатьСтрокиЭлвес)");	
	Для Индекс = 0 По МассивСтрок.Количество() - 1 Цикл
		Строка = МассивСтрок[Индекс];
		Объект.ИспользоватьЧековуюЛенту       = 1;
		Объект.ИспользоватьОперационныйЖурнал = 1;
		Объект.СтрокаДляПечати                = МассивСтрок[Индекс];
		Повтор                                = Истина;
		ЗаписатьСтрокуЛогаКассы("Печать строки.(ПечатьСтрокиЭлвес)");	
		Объект.ПечатьСтроки();
		Если Объект.Результат <> 0 Тогда
			Результат = Объект.ОписаниеРезультата;
			Возврат;
		КонецЕсли;
	КонецЦикла;

КонецПроцедуры // ПечатьСтроки()

Функция ОперацияПечататьЧек(Объект, НомерЛУ, Пароль, Таблица, Секция,
                            ПолученоНал, ПолученоБезНал,
                            ЧекНаВозврат, НДС, НомерЧека, НомерСмены,СкладНаименование)

	ЗаписатьСтрокуЛогаКассы("Начало непосредственной печати чека.");
	Результат = "";

	Если Объект = Неопределено Тогда
		Результат = "Торговое оборудование не подключено.(ОперацияПечататьЧекЭлвес)";
		Возврат Результат;
	КонецЕсли;

	Объект.НомерЛУ = НомерЛУ;
	ЗаписатьСтрокуЛогаКассы("Объект.УстановитьАктивноеЛУ().(ОперацияПечататьЧекЭлвес)");
	Объект.УстановитьАктивноеЛУ();
	Если Объект.Результат <> 0 Тогда
		Результат = Объект.ОписаниеРезультата;
		Возврат Результат;
	КонецЕсли;

	Объект.Пароль = Пароль;
	ЗаписатьСтрокуЛогаКассы("Объект.УстановитьСвязь().(ОперацияПечататьЧекЭлвес)");
	Объект.УстановитьСвязь();
	Если Объект.Результат <> 0 Тогда
		Результат = Объект.ОписаниеРезультата;
		Возврат Результат;
	КонецЕсли;

	ЗаписатьСтрокуЛогаКассы("Объект.ПолучитьПараметрыУстройства().(ОперацияПечататьЧекЭлвес)");
	Объект.ПолучитьПараметрыУстройства();
	Если Объект.Результат <> 0 Тогда
		Результат = Объект.ОписаниеРезультата;
		Объект.РазорватьСвязь();
		Возврат Результат;
	КонецЕсли;
	Объект.Пароль = 30;
    Объект.НомерТаблицы=2;
	Объект.НомерРяда=1;			
	Объект.НомерПоля=2;
	ЗаписатьСтрокуЛогаКассы("Объект.GetFieldStruct().(ОперацияПечататьЧекЭлвес)");
	Объект.GetFieldStruct();
	ЗаписатьСтрокуЛогаКассы("Объект.ReadTable().(ОперацияПечататьЧекЭлвес)");
	Объект.ReadTable();     
	Если Объект.ValueofFieldString<> Строка(глТекущийПользователь) Тогда
	Объект.ValueofFieldString=Строка(глТекущийПользователь);
	ЗаписатьСтрокуЛогаКассы("Объект.WriteTable().(ОперацияПечататьЧекЭлвес)");
	Объект.WriteTable();
    КонецЕсли;
    
	Объект.Пароль = Пароль;
	
	Модель = Объект.УМодельУстройства;
	Если      Модель = 0 Или Модель = 1 Или Модель = 4 Или Модель = 8 Тогда
		ШиринаСтроки = 36;
	ИначеЕсли Модель = 2 Тогда
		ШиринаСтроки = 24;
	ИначеЕсли Модель = 5 Или Модель = 11 Тогда
		ШиринаСтроки = 40;
	ИначеЕсли Модель = 6 Тогда
		ШиринаСтроки = 32;
	ИначеЕсли Модель = 7 Или Модель = 14 Тогда
		ШиринаСтроки = 36;
	ИначеЕсли Модель = 9 Или Модель = 12 Тогда
		ШиринаСтроки = 48;
	Иначе
		ШиринаСтроки=36;
	КонецЕсли;

	Объект.Пароль  = Пароль;
	Объект.ТипЧека = ?(ЧекНаВозврат, 2, 0);
	ЗаписатьСтрокуЛогаКассы("Объект.ОткрытьЧек().(ОперацияПечататьЧекЭлвес)");	
	Объект.ОткрытьЧек();
	Если Объект.Результат <> 0 Тогда
		Результат = Объект.ОписаниеРезультата;
		ЗаписатьСтрокуЛогаКассы("Объект.РазорватьСвязь().(ОперацияПечататьЧекЭлвес)");	
		Объект.РазорватьСвязь();
		Возврат Результат;
	КонецЕсли;

	Если ЗначениеНеЗаполнено(НДС) Тогда
		НДС = 0;
	КонецЕсли;

	Если      НДС = 18 Тогда
		Ставка = 1;
	ИначеЕсли НДС = 10 Тогда
		Ставка = 2;
	ИначеЕсли НДС = 20 Тогда
		Ставка = 3;
	Иначе
		Ставка = 0;
	КонецЕсли;

	// печатаем склад
	ЗаписатьСтрокуЛогаКассы("Объект.ПечатьСтроки().(ОперацияПечататьЧекЭлвес)");	
  	ПечатьСтроки(
		    Объект,
		    СкладНаименование,
		    ШиринаСтроки,
		    Результат,
		    Истина);
    
	
	Для Каждого Товар Из Таблица Цикл
		Цена                    = Товар.Цена;
		Количество              = Товар.Колво;
		Скидка                  = ?(Товар.Скидка > 0,  Товар.Скидка, 0);
		Наценка                 = ?(Товар.Скидка < 0, -Товар.Скидка, 0);
		СуммаБС                 = Цена * Количество;
		СуммаСК                 = СуммаБС * Скидка  / 100;
		СуммаНац                = СуммаБС * Наценка / 100;

		ЗаписатьСтрокуЛогаКассы("Объект.ПечатьСтроки().(ОперацияПечататьЧекЭлвес)");	
		ПечатьСтроки(
		    Объект,
		    Лев("--------------------------------------------------", ШиринаСтроки),
		    ШиринаСтроки,
		    Результат,
		    Истина);
		Если Объект.Результат <> 0 Тогда
			Результат = Объект.ОписаниеРезультата;
			Объект.РазорватьСвязь();
			Возврат Результат;
		КонецЕсли;
		ЗаписатьСтрокуЛогаКассы("Объект.ПечатьСтроки().(ОперацияПечататьЧекЭлвес)");	
		ПечатьСтроки(Объект,
		             Товар.Товар,
		             ШиринаСтроки,
		             Результат,
		             Ложь);
		Если Объект.Результат <> 0 Тогда
			Результат = Объект.ОписаниеРезультата;
			ЗаписатьСтрокуЛогаКассы("Объект.РазорватьСвязь().(ОперацияПечататьЧекЭлвес)");	
			Объект.РазорватьСвязь();
			Возврат Результат;
		КонецЕсли;

		Объект.ИспользоватьЧековуюЛенту       = 1;
		Объект.ИспользоватьОперационныйЖурнал = 1;
		Объект.СтрокаДляПечати                = "";
		Объект.Цена                           = Цена;
		Объект.Количество                     = Количество;
		Объект.Отдел                          = Секция;
		Объект.Налог1                         = Ставка;
		Если ЧекНаВозврат Тогда
			Объект.ВозвратПродажи();
		Иначе
			Объект.Продажа();
		КонецЕсли;
		Если Объект.Результат <> 0 Тогда
			Результат = Объект.ОписаниеРезультата;
			ЗаписатьСтрокуЛогаКассы("Объект.АннулироватьЧек().(ОперацияПечататьЧекЭлвес)");	
			Объект.АннулироватьЧек();
			ЗаписатьСтрокуЛогаКассы("Объект.РазорватьСвязь().(ОперацияПечататьЧекЭлвес)");	
			Объект.РазорватьСвязь();
			Возврат Результат;
		КонецЕсли;

		Если Наценка > 0 Тогда
			Объект.Пароль          = Пароль;
			Объект.Сумма1          = СуммаНац;
			Объект.СтрокаДляПечати = Формат(Наценка, "ЧЦ=15; ЧДЦ=2") + "%";
			Объект.Надбавка();
			Если Объект.Результат <> 0 Тогда
				Результат = Объект.ОписаниеРезультата;
				ЗаписатьСтрокуЛогаКассы("Объект.АннулироватьЧек().(ОперацияПечататьЧекЭлвес)");	
				Объект.АннулироватьЧек();
				ЗаписатьСтрокуЛогаКассы("Объект.РазорватьСвязь().(ОперацияПечататьЧекЭлвес)");	
				Объект.РазорватьСвязь();
				Возврат Результат;
			КонецЕсли;
		КонецЕсли;
		Если Скидка > 0 Тогда
			Объект.Пароль = Пароль;
			Объект.Сумма1 = СуммаСК;
			Объект.СтрокаДляПечати = Формат(Скидка, "ЧЦ=15; ЧДЦ=2") + "%";
			Объект.Скидка();
			Если Объект.Результат <> 0 Тогда
				Результат = Объект.ОписаниеРезультата;
				ЗаписатьСтрокуЛогаКассы("Объект.АннулироватьЧек().(ОперацияПечататьЧекЭлвес)");	
				Объект.АннулироватьЧек();
				ЗаписатьСтрокуЛогаКассы("Объект.РазорватьСвязь().(ОперацияПечататьЧекЭлвес)");	
				Объект.РазорватьСвязь();
				Возврат Результат;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;

	
	
	Объект.Пароль = Пароль;
	Объект.ПодытогЧека();
	Если Объект.Результат <> 0 Тогда
		Результат = Объект.ОписаниеРезультата;
		ЗаписатьСтрокуЛогаКассы("Объект.АннулироватьЧек().(ОперацияПечататьЧекЭлвес)");	
		Объект.АннулироватьЧек();
		ЗаписатьСтрокуЛогаКассы("Объект.РазорватьСвязь().(ОперацияПечататьЧекЭлвес)");	
		Объект.РазорватьСвязь();
		Возврат Результат;
	КонецЕсли;

	Если (ПолученоНал = 0) И (ПолученоБезНал < Объект.Сумма1) Тогда
		ПолученоНал = Объект.Сумма1 - ПолученоБезНал;
	КонецЕсли;

	Объект.Сумма1 = ПолученоНал;
	Объект.Сумма2 = 0;
	Объект.Сумма3 = 0;
	Объект.Сумма4 = ПолученоБезНал;
	Объект.ЗакрытьЧек();
	Если Объект.Результат <> 0 Тогда
		Результат = Объект.ОписаниеРезультата;
		ЗаписатьСтрокуЛогаКассы("Объект.АннулироватьЧек().(ОперацияПечататьЧекЭлвес)");	
		Объект.АннулироватьЧек();
		ЗаписатьСтрокуЛогаКассы("Объект.РазорватьСвязь().(ОперацияПечататьЧекЭлвес)");	
		Объект.РазорватьСвязь();
		Возврат Результат;
	КонецЕсли;

	Объект.ПолучитьСостояниеККМ();
	Если Объект.Результат <> 0 Тогда
		Результат = Объект.ОписаниеРезультата;
		ЗаписатьСтрокуЛогаКассы("Объект.АннулироватьЧек().(ОперацияПечататьЧекЭлвес)");	
		Объект.АннулироватьЧек();
		ЗаписатьСтрокуЛогаКассы("Объект.РазорватьСвязь().(ОперацияПечататьЧекЭлвес)");		
		Объект.РазорватьСвязь();
		Возврат Результат;
	КонецЕсли;

	НомерЧека  = Объект.СквознойНомерДокумента + 1;
	НомерСмены = Объект.НомерСмены;
    ЗаписатьСтрокуЛогаКассы("Объект.РазорватьСвязь().(ОперацияПечататьЧекЭлвес)");		
	Объект.РазорватьСвязь();
	Возврат Результат;

КонецФункции // ОперацияПечататьЧек()

// Печать строку чека на ФР
//
// Параметры:
//  Объект       - объект фискальный регистратор
//  Пароль       - пароль пользователя
//  ТаблицаТоваров - таблица товаров, их цен и количества
//  Скидка       - скидка на чек
//  ПризнВозврата - признак возврата товара
//  НомерСекции  - номер секции, в которой печатается чек
//  НомерЧека    - возвращаемый номер чека
//  НомерЛУ      - номер логического устройства с который связан Объект
//
// Возвращаемое значение:
//  строка с представлением ошибки если она произошла, иначе пустая строка
//
Функция ПечататьСтрокуЧека(Объект, Пароль, СтрокаДляПечати, НомерСекции, НомерЧека, НомерСмены, НомерЛУ)

	Результат = "";

	Если Объект = Неопределено Тогда
		Результат = "Торговое оборудование не подключено.";
		Возврат Результат;
	КонецЕсли;

	Объект.НомерЛУ = НомерЛУ;
	Объект.УстановитьАктивноеЛУ();
	Если Объект.Результат <> 0 Тогда
		Результат = Объект.ОписаниеРезультата;
		Возврат Результат;
	КонецЕсли;

	Объект.Пароль = Пароль;
	Объект.УстановитьСвязь();
	Если Объект.Результат <> 0 Тогда
		Результат = Объект.ОписаниеРезультата;
		Возврат Результат;
	КонецЕсли;


	// регистрация товаров
	Объект.Password          = Пароль;
	Модель = Объект.УМодельУстройства;
	Если      Модель = 0 Или Модель = 1 Или Модель = 4 Или Модель = 8 Тогда
		ШиринаСтроки = 36;
	ИначеЕсли Модель = 2 Тогда
		ШиринаСтроки = 24;
	ИначеЕсли Модель = 5 Или Модель = 11 Тогда
		ШиринаСтроки = 40;
	ИначеЕсли Модель = 6 Тогда
		ШиринаСтроки = 32;
	ИначеЕсли Модель = 7 Или Модель = 14 Тогда
		ШиринаСтроки = 36;
	ИначеЕсли Модель = 9 Или Модель = 12 Тогда
		ШиринаСтроки = 48;
	Иначе
		ШиринаСтроки=36;
	КонецЕсли;

	ПечатьСтроки(
		    Объект,
		    Лев("--------------------------------------------------", ШиринаСтроки),
		    ШиринаСтроки,
		    Результат,
		    Истина);

    ПечатьСтроки(Объект, СтрокаДляПечати, ШиринаСтроки, Результат, Ложь);

						
	ПечатьСтроки(
		    Объект,
		    Лев("--------------------------------------------------", ШиринаСтроки),
		    ШиринаСтроки,
		    Результат,
		    Истина);					
	Объект.РазорватьСвязь();
	Возврат Результат;


КонецФункции // ПечататьСтрокуЧека()

// Закрыть чек на ФР
//
// Параметры:
//  Объект       - объект фискальный регистратор
//  Пароль       - пароль пользователя
//  ТаблицаТоваров - таблица товаров, их цен и количества
//  Скидка       - скидка на чек
//  ПризнВозврата - признак возврата товара
//  НомерСекции  - номер секции, в которой печатается чек
//  НомерЧека    - возвращаемый номер чека
//  НомерЛУ      - номер логического устройства с который связан Объект
//
// Возвращаемое значение:
//  строка с представлением ошибки если она произошла, иначе пустая строка
//
Функция ЗакрытьЧек(Объект, Пароль, Получено, ПолученоНал, ПолученоБезНал, Скидка, НомерСекции, НомерЧека, НомерСмены, НомерЛУ)

	Если Объект = Неопределено Тогда
		ОписаниеРезультата = "устройство не подключено";
		Возврат ОписаниеРезультата;
	КонецЕсли;

	ОписаниеРезультата = ПодключитьсяКФР(Объект, Пароль, НомерЛУ);
	Если НЕ ПустаяСтрока(ОписаниеРезультата) Тогда
		Возврат ОписаниеРезультата;
	КонецЕсли;

	Объект.StringForPrinting = " ";
	Объект.Summ1             = Скидка;
	ЗаписатьСтрокуЛогаКассы("Скидки (закрыть чек).(ЗакрытьЧекЭлвес)");
	Если (Скидка > 0) Тогда
		Объект.Discount();
	ИначеЕсли (Скидка < 0) Тогда
		Объект.Charge();
	КонецЕсли;

	Объект.Password          = Пароль;
	Объект.Summ1             = ПолученоНал;
	Объект.Summ2             = ПолученоБезНал;
	Объект.Summ3             = 0; 
	Объект.Summ4             = 0; 
	ЗаписатьСтрокуЛогаКассы("Объект.CloseCheck().(ЗакрытьЧекЭлвес)");
	Объект.CloseCheck();

	Если Объект.ResultCode <> 0 Тогда
		ОписаниеРезультата = Объект.ResultCodeDescription;
		Возврат ОписаниеРезультата;
	КонецЕсли;

	Объект.Password = Пароль;
	ЗаписатьСтрокуЛогаКассы("Объект.GetECRStatus().(ЗакрытьЧекЭлвес)");
	Объект.GetECRStatus();
	ЗаписатьСтрокуЛогаКассы("ОтключитьсяОтФР(Объект, Пароль, НомерЛУ) (ЗакрытьЧекЭлвес).");
	Если Объект.ResultCode <> 0 Тогда
		ОписаниеРезультата = Объект.ResultCodeDescription;
		ОтключитьсяОтФР(Объект, Пароль, НомерЛУ);

		Возврат ОписаниеРезультата;
	КонецЕсли;

	НомерЧека = Объект.OpenDocumentNumber+?(Объект.ECRAdvancedMode=5,1,0);
	НомерСмены = Объект.SessionNumber+1;

	ЗаписатьСтрокуЛогаКассы("ОтрезатьЧек(Объект, Пароль) (ЗакрытьЧекЭлвес).");
	ОтрезатьЧек(Объект, Пароль);

	Возврат ОтключитьсяОтФР(Объект, Пароль, НомерЛУ);

КонецФункции // ЗакрытьЧек()

// Печать чека для ПКО на ФР
//
// Параметры:
//  Объект       - объект фискальный регистратор
//  Пароль       - пароль пользователя
//  ТаблицаТоваров - таблица товаров, их цен и количества
//  ПризнВозврата - признак возврата товара
//  НомерСекции  - номер секции, в которой печатается чек
//  НомерЧека    - возвращаемый номер чека
//  НомерЛУ      - номер логического устройства с который связан Объект
//
// Возвращаемое значение:
//  строка с представлением ошибки если она произошла, иначе пустая строка
//
Функция ПечататьЧекДляПКО(Объект, Пароль, ТаблицаТоваров, Получено, ПризнВозврата, НомерСекции, НомерЧека, НомерЛУ)

	Если Объект = Неопределено Тогда
		ОписаниеРезультата = "устройство не подключено";
		Возврат ОписаниеРезультата;
	КонецЕсли;

	ОписаниеРезультата = ПодключитьсяКФР(Объект, Пароль, НомерЛУ);
	Если НЕ ПустаяСтрока(ОписаниеРезультата) Тогда
		Возврат ОписаниеРезультата;
	КонецЕсли;

	// регистрация товаров
	Для Каждого СтрокаИзСписка Из ТаблицаТоваров Цикл
		Объект.Password          = Пароль;
		Объект.StringForPrinting = "";
		Объект.Price             = СтрокаИзСписка.Цена;
		Объект.Quantity          = СтрокаИзСписка.Колво;
		Объект.Department        = НомерСекции;

		// В настройках ФР надо настроить ставки:
		// Налог 1 = 18% - НДС 18%
		// Налог 2 = 10% - НДС 10%
		// Налог 3 = 20% - НДС 20%

		Если СтрокаИзСписка.НДС = 18 Тогда
			Объект.Tax1 = 1;
		ИначеЕсли СтрокаИзСписка.НДС = 10 Тогда
			Объект.Tax1 = 2;
		ИначеЕсли СтрокаИзСписка.НДС = 20 Тогда
			Объект.Tax1 = 3;
		Иначе
			Объект.Tax1 = 0;
		КонецЕсли;
		Объект.Tax2 = 0;
		Объект.Tax3 = 0;
		Объект.Tax4 = 0;

		Если ПризнВозврата Тогда
			Объект.ReturnSale();
		Иначе
			Объект.Sale();
		КонецЕсли;

		// длина указана в документации, где сказано, что
		// "Максимальная допустимая длина печатаемой строки 36 символов"
		ДлинаСтроки = 36;
		СтрокаДляПечати = СтрокаИзСписка.Товар;
		Пока СтрДлина(СтрокаДляПечати)>0 Цикл
			Объект.StringForPrinting = Лев(СтрокаДляПечати,ДлинаСтроки);
			Объект.PrintString();
			СтрокаДляПечати = СокрЛП(Сред(СтрокаДляПечати,ДлинаСтроки+1));
		КонецЦикла;

		Если Объект.ResultCode <> 0 Тогда
			ОписаниеРезультата = Объект.ResultCodeDescription;
			АннулироватьЧек(Объект, Пароль);
			ОтрезатьЧек(Объект, Пароль);
			ОтключитьсяОтФР(Объект, Пароль, НомерЛУ);

			Возврат ОписаниеРезультата;
		КонецЕсли;
	КонецЦикла;

	Объект.Password          = Пароль;
	// Summ1 и Summ3 поменял местами
	Объект.Summ3             = Получено; 
	Объект.Summ2             = 0; 
	Объект.Summ1             = 0; 
	Объект.Summ4             = 0; 
	Объект.StringForPrinting = " ";
	Объект.DiscountOnCheck   = 0;
	Объект.CloseCheck();

	Если Объект.ResultCode <> 0 Тогда
		ОписаниеРезультата = Объект.ResultCodeDescription;
		АннулироватьЧек(Объект, Пароль);
		ОтрезатьЧек(Объект, Пароль);
		ОтключитьсяОтФР(Объект, Пароль, НомерЛУ);

		Возврат ОписаниеРезультата;
	КонецЕсли;

	Объект.Password = Пароль;
	Объект.GetECRStatus();
	
	Если Объект.ResultCode <> 0 Тогда
		ОписаниеРезультата = Объект.ResultCodeDescription;
		ОтключитьсяОтФР(Объект, Пароль, НомерЛУ);

		Возврат ОписаниеРезультата;
	КонецЕсли;

	НомерЧека = Объект.OpenDocumentNumber+?(Объект.ECRAdvancedMode=5,1,0);

	ОтрезатьЧек(Объект, Пароль);

	Возврат ОтключитьсяОтФР(Объект, Пароль, НомерЛУ);

КонецФункции // ПечататьЧекДляПКО()

// Подключение ФР
//
// Параметры:
//  Компонента   - внешняя компонента
//  ПрогИд       = программный идентификатор
//  Пароль       - пароль пользователя
//  Объект       - возвращаемый объект подключенного торгового оборудования
//  НомерЛУ      - номер логического устройства с который связан Объект
//
// Возвращаемое значение:
//  строка с представлением ошибки если она произошла, иначе пустая строка
//
Функция Подключить(Компонента, ПрогИд, Пароль, Объект, НомерЛУ)

	Попытка
		ЗагрузитьВнешнююКомпоненту(Компонента);
	Исключение
		ОписаниеРезультата = "не удалось загрузить внешнюю компоненту """ + Компонента + """";
		Возврат ОписаниеРезультата;
	КонецПопытки;

	Попытка
		//Объект = Новый COMОбъект("AddIn." + ПрогИд);
		  Объект = Новый ("AddIn." + ПрогИд);
	Исключение
		ОписаниеРезультата = "не удалось создать объект внешней компоненты с программым идентификатром AddIn." + ПрогИд;
		Возврат ОписаниеРезультата;
	КонецПопытки;

	Возврат "";

КонецФункции // Подключить()

// Отключение ФР
//
// Параметры:
//  Объект       - объект подключенного торгового оборудования
//  НомерЛУ      - номер логического устройства с который связан Объект
//
// Возвращаемое значение:
//  строка с представлением ошибки если она произошла, иначе пустая строка
//
Функция Отключить(Объект, Пароль, НомерЛУ)

	// если нет объекта, то ничего не нужно отключать
	Если Объект = Неопределено Тогда
		Возврат "";
	КонецЕсли;

	ОтключитьсяОтФР(Объект, Пароль, НомерЛУ);

	Возврат "";

КонецФункции // Отключить()

// Закрытие смены на ФР
// на ФР печатается Z-отчет
//
// Параметры:
//  Объект       - объект подключенного торгового оборудования
//  Пароль       - пароль администратора
//  НомерЛенты   - возвращаемый номер ленты
//  НомерЛУ      - номер логического устройства с который связан Объект
//
// Возвращаемое значение:
//  строка с представлением ошибки если она произошла, иначе пустая строка
//
Функция ЗакрытьСмену(Объект, Пароль, НомерЛенты, НомерЛУ)

	Если Объект = Неопределено Тогда
		ОписаниеРезультата = "устройство не подключено";
		Возврат ОписаниеРезультата;
	КонецЕсли;

	ОписаниеРезультата = ПодключитьсяКФР(Объект, Пароль, НомерЛУ);
	Если НЕ ПустаяСтрока(ОписаниеРезультата) Тогда
		Возврат ОписаниеРезультата;
	КонецЕсли;

	Объект.Password = Пароль;
	Объект.PrintReportWithCleaning();

	Если Объект.ResultCode <> 0 Тогда
		ОписаниеРезультата = Объект.ResultCodeDescription;
		ОтключитьсяОтФР(Объект, Пароль, НомерЛУ);
		Возврат ОписаниеРезультата;
	КонецЕсли;

	Объект.Password = Пароль;
	Объект.GetECRStatus();

	Если Объект.ResultCode <> 0 Тогда
		ОписаниеРезультата = Объект.ResultCodeDescription;
		ОтключитьсяОтФР(Объект, Пароль, НомерЛУ);
		Возврат ОписаниеРезультата;
	КонецЕсли;

	НомерЛенты = Объект.SessionNumber + ?(Объект.ECRAdvancedMode=5,1,0);
	
	ОтрезатьЧек(Объект, Пароль);
	
	Возврат ОтключитьсяОтФР(Объект, Пароль, НомерЛУ);

КонецФункции // ЗакрытьСмену()

Функция ПолучитьНомерЧекаСмены(Объект, Пароль, НомерЧека, НомерСмены, НомерЛУ)

	Если Объект = Неопределено Тогда
		ОписаниеРезультата = "устройство не подключено";
		Возврат ОписаниеРезультата;
	КонецЕсли;

	ОписаниеРезультата = ПодключитьсяКФР(Объект, Пароль, НомерЛУ);
	Если НЕ ПустаяСтрока(ОписаниеРезультата) Тогда
		Возврат ОписаниеРезультата;
	КонецЕсли;

	Объект.GetECRStatus();

	Если Объект.ResultCode <> 0 Тогда
		ОписаниеРезультата = Объект.ResultCodeDescription;
		ОтключитьсяОтФР(Объект, Пароль, НомерЛУ);

		Возврат ОписаниеРезультата;
	КонецЕсли;

	НомерЧека = Объект.OpenDocumentNumber+?(Объект.ECRAdvancedMode=5,1,0);
	НомерСмены = Объект.SessionNumber+1;

	Возврат ОтключитьсяОтФР(Объект, Пароль, НомерЛУ);

КонецФункции

Функция ПроверкаПароля (Пароль) Экспорт
	Если ПустаяСтрока(Пароль) Тогда
		Ответ = "неправильно указан пароль пользователя / администратора";
		Возврат Ответ;
	Иначе
		Попытка
			ПарольЧислом = Число(Пароль);
		Исключение
			Ответ = "неправильно указан пароль пользователя / администратора";
			Возврат Ответ;
		КонецПопытки;
	КонецЕсли;

	Возврат Неопределено;
КонецФункции

// Обработка вызова операции на ФР
//
// Параметры:
//  ИмяОперации  - имя выполняемой операции
//  Параметры    - структура с параметрами торгового оборудования
//  Ответ        - возвращаемая строка с представлением ошибки если она произошла, иначе пустая строка
//
Процедура ВыполнитьОперацию(ИмяОперации = "", Параметры, Ответ) Экспорт
	Перем Пароль, Модель, Объект, НомерЛУ;
	Перем ТаблицаТоваров, Получено, Скидка, ЧекНаВозврат, НомерСекции, НомерЧека, НомерСмены;
	Перем СтрокаТовара, Сумма, ПолученоНал, ПолученоБезНал;
	Перем НомерЛенты;
    Перем Таблица,Секция,СуммаНал,СуммаБезнал,НДС,СкладНаименование;	
				
	Параметры.Свойство("Пароль" , Пароль );
	Параметры.Свойство("Объект" , Объект );
	Параметры.Свойство("НомерЛУ", НомерЛУ);

	Если ЗначениеНеЗаполнено(НомерЛУ) Тогда
		НомерЛУ = 1;
	КонецЕсли;

	Если ИмяОперации = "Подключить" Тогда

		Ответ = ПроверкаПароля (Пароль);
		Если Ответ <> Неопределено Тогда
			Возврат;
		КонецЕсли;

		Параметры.Свойство("Модель", Модель);

		Ответ = Подключить(Модель.ВнешняяКомпонента, Модель.ПрограммныйИдентификатор, Пароль, Объект, НомерЛУ);

		Параметры.Вставить("Объект", Объект);

	ИначеЕсли ИмяОперации = "Отключить" Тогда

		//Ответ = ПроверкаПароля (Пароль);
		//Если Ответ <> Неопределено Тогда
		//	Возврат;
		//КонецЕсли;

		Ответ = Отключить(Объект, Пароль, НомерЛУ);

	ИначеЕсли ИмяОперации = "ПечататьЧек" Тогда

		Параметры.Свойство("Объект",         Объект);
		Параметры.Свойство("НомерЛУ",        НомерЛУ);
		Параметры.Свойство("Пароль",         Пароль);
		Параметры.Свойство("СписокТоваров",  Таблица);
		Параметры.Свойство("НомерСекции",    Секция);
		Параметры.Свойство("ЧекНаВозврат",   ЧекНаВозврат);
		Параметры.Свойство("ПолученоНал",    СуммаНал);
		Параметры.Свойство("ПолученоБезНал", СуммаБезнал);
		Параметры.Свойство("НДС",            НДС);
		Параметры.Свойство("СкладНаименование",СкладНаименование);
		Ответ = ОперацияПечататьЧек(Объект, НомерЛУ, Пароль,
		                            Таблица, Секция, СуммаНал,
		                            СуммаБезнал, ЧекНаВозврат,
		                            НДС, НомерЧека, НомерСмены,СкладНаименование);
		Если ПустаяСтрока(Ответ) Тогда
			Параметры.Вставить("НомерЧека",  НомерЧека);
			Параметры.Вставить("НомерСмены", НомерСмены);
		КонецЕсли;


	ИначеЕсли ИмяОперации = "ПечататьЧекДляПКО" Тогда

		Ответ = ПроверкаПароля (Пароль);
		Если Ответ <> Неопределено Тогда
			Возврат;
		КонецЕсли;

		Параметры.Свойство("СписокТоваров", ТаблицаТоваров );
		Параметры.Свойство("Получено"     , Получено       );
		Параметры.Свойство("ЧекНаВозврат" , ЧекНаВозврат   );
		Параметры.Свойство("НомерСекции"  , НомерСекции    );

		Ответ = ПечататьЧекДляПКО(Объект, Пароль, ТаблицаТоваров, Получено, ЧекНаВозврат, НомерСекции, НомерЧека, НомерЛУ);

		Параметры.Вставить("НомерЧека", НомерЧека );

	ИначеЕсли ИмяОперации = "ПечататьСтрокуЧека" Тогда

		Ответ = ПроверкаПароля (Пароль);
		Если Ответ <> Неопределено Тогда
			Возврат;
		КонецЕсли;
		Параметры.Свойство("СтрокаТовара", СтрокаТовара );
		Параметры.Свойство("НомерСекции"  , НомерСекции    );

		Ответ = ПечататьСтрокуЧека(Объект, Пароль, СтрокаТовара, НомерСекции, НомерЧека, НомерСмены, НомерЛУ);

		Параметры.Вставить("НомерЧека", НомерЧека );
		Параметры.Вставить("НомерСмены", НомерСмены );

	ИначеЕсли ИмяОперации = "ЗакрытьЧек" Тогда

		Ответ = ПроверкаПароля (Пароль);
		Если Ответ <> Неопределено Тогда
			Возврат;
		КонецЕсли;
		Параметры.Свойство("Получено"     , Получено       );
		Параметры.Свойство("ПолученоНал"     , ПолученоНал);
		Параметры.Свойство("ПолученоБезНал"     , ПолученоБезНал);
		Параметры.Свойство("Скидка"       , Скидка       );
		Параметры.Свойство("НомерСекции"  , НомерСекции    );

		Ответ = ЗакрытьЧек(Объект, Пароль, Получено, ПолученоНал, ПолученоБезНал, Скидка, НомерСекции, НомерЧека, НомерСмены, НомерЛУ);

		Параметры.Вставить("НомерЧека", НомерЧека );
		Параметры.Вставить("НомерСмены", НомерСмены );

	ИначеЕсли ИмяОперации = "АннулироватьЧек" Тогда

		Ответ = ПроверкаПароля (Пароль);
		Если Ответ <> Неопределено Тогда
			Возврат;
		КонецЕсли;

		Ответ = АннулироватьЧек(Объект, Пароль, НомерЛУ, Истина);

	ИначеЕсли ИмяОперации = "ЗакрытьСмену" Тогда

		Ответ = ПроверкаПароля (Пароль);
		Если Ответ <> Неопределено Тогда
			Возврат;
		КонецЕсли;

		Ответ = ЗакрытьСмену(Объект, Пароль, НомерЛенты, НомерЛУ);

		Параметры.Вставить("НомерЛенты", НомерЛенты );

	ИначеЕсли ИмяОперации = "Внести" Тогда

		Параметры.Свойство("Сумма", Сумма);

		Ответ = ПроверкаПароля (Пароль);
		Если Ответ <> Неопределено Тогда
			Возврат;
		КонецЕсли;

		Ответ = ВнестиСумму(Объект, Пароль, Сумма, НомерЛУ);

	ИначеЕсли ИмяОперации = "Изъять" Тогда

		Параметры.Свойство("Сумма", Сумма);
		Ответ = ПроверкаПароля (Пароль);
		Если Ответ <> Неопределено Тогда
			Возврат;
		КонецЕсли;

		Ответ = ИзъятьСумму(Объект, Пароль, Сумма, НомерЛУ);

	ИначеЕсли ИмяОперации = "ОткрытьЯщик" Тогда

		Ответ = ПроверкаПароля (Пароль);
		Если Ответ <> Неопределено Тогда
			Возврат;
		КонецЕсли;

		Ответ = ОткрытьЯщик(Объект, Пароль, НомерЛУ);

	ИначеЕсли ИмяОперации = "ХОтчет" Тогда

		Ответ = ПроверкаПароля (Пароль);
		Если Ответ <> Неопределено Тогда
			Возврат;
		КонецЕсли;

		Ответ = ХОтчет(Объект, Пароль, НомерЛУ);

	ИначеЕсли ИмяОперации = "ПолучитьНомерЧекаСмены" Тогда

		Ответ = ПроверкаПароля (Пароль);
		Если Ответ <> Неопределено Тогда
			Возврат;
		КонецЕсли;

		Ответ = ПолучитьНомерЧекаСмены(Объект, Пароль, НомерЧека, НомерСмены, НомерЛУ);

		Параметры.Вставить("НомерЧека", НомерЧека );
		Параметры.Вставить("НомерСмены", НомерСмены );

	ИначеЕсли ИмяОперации = "ПечатьСтроки" Тогда
		Ответ = ПроверкаПароля (Параметры.Пароль);
		Если Ответ <> Неопределено Тогда
			Возврат;
		КонецЕсли;
		ПечатьСтроки(Параметры.Объект, Параметры.Текст, Параметры.Ширина, Ответ, Параметры.ПоЦентру);
		
	ИначеЕсли ИмяОперации = "Отрезать" Тогда
		Ответ = ПроверкаПароля (Параметры.Пароль);
		Если Ответ <> Неопределено Тогда
			Возврат;
		КонецЕсли;
		ОтрезатьЧек(Параметры.Объект, Параметры.Пароль);
		
	Иначе
		
		Ответ = "неизвестная команда";

	КонецЕсли;

КонецПроцедуры // ВыполнитьОперацию()

// возвращает параметры для текущий обработки
//
Процедура ПолучитьПараметры(Вид, ВнешняяКомпонента, ПрограммныйИдентификатор, Модели) Экспорт

	Вид                      = Перечисления.ВидыТорговогоОборудования.ФискальныйРегистратор;
	ВнешняяКомпонента        = "DrvFR.dll";
	ПрограммныйИдентификатор = "DrvFR";

	Модели = Новый СписокЗначений;
	Модели.Добавить("ФРШ03","Штрих-ФР-Ф (v.03,04)");
	Модели.Добавить("ФРЭ02","Элвес-Мини-ФР-Ф (v.02)");

КонецПроцедуры

Функция ПечатьОтчетаСоСкидками(Объект_,НомерЛУ_,ПарольАдминистратора_, МассивДокументов) Экспорт
	
	//ФормаОбработки = глТорговоеОборудование.ПолучитьФормуОбработки(Перечисления.ОбработкиТорговогоОборудования.fr_elves);			
	ОписаниеРезультата = ПодключитьсяКФР(Объект_, ПарольАдминистратора_, НомерЛУ_);
    Ответ = "";
	Параметры = новый структура;
	Параметры.Вставить("Пароль",ПарольАдминистратора_);
	Параметры.Вставить("Объект",Объект_);
	Параметры.Вставить("Текст","******************************");
	Параметры.Вставить("ПоЦентру",Ложь);
	Параметры.Вставить("Ширина",50);
	Ответ = ПроверкаПароля (Параметры.Пароль);
	Если Ответ <> Неопределено Тогда
		Возврат Ответ;
	КонецЕсли;
	ВыполнитьОперацию("ПечатьСтроки", Параметры, Ответ);					
				
	//Параметры = новый структура;
	Параметры.Текст = "Отчет с учетом скидок";
	ВыполнитьОперацию("ПечатьСтроки", Параметры, Ответ);					

	//Параметры = новый структура;
	Параметры.Текст = " ";
	ВыполнитьОперацию("ПечатьСтроки", Параметры, Ответ);					
				
	ИтогоСуммаНаЛенту = 0;
	Для каждого Элемент из МассивДокументов Цикл
		
		Параметры.Текст = " ";
		ВыполнитьОперацию("ПечатьСтроки", Параметры, Ответ);					
		Параметры.Текст = Лев(Элемент.Секция,30);
		Параметры.Ширина = 100;
		ВыполнитьОперацию("ПечатьСтроки", Параметры, Ответ);					
		Параметры.Текст = "Итого со скидками = " + СокрП(Элемент.СуммаДокумента);
		Параметры.Ширина = 50;
		ИтогоСуммаНаЛенту = ИтогоСуммаНаЛенту + Элемент.СуммаДокумента;
	    ВыполнитьОперацию("ПечатьСтроки", Параметры, Ответ);					
	КонецЦикла;
	
	Параметры.Текст = " ";
	ВыполнитьОперацию("ПечатьСтроки", Параметры, Ответ);					
	Параметры.Текст = "Итого сумма = " + Строка(ИтогоСуммаНаЛенту);
	ВыполнитьОперацию("ПечатьСтроки", Параметры, Ответ);					
	Параметры.Текст = "******************************";
	ВыполнитьОперацию("ПечатьСтроки", Параметры, Ответ);					
				
	Для й=1 по 10 Цикл
		
		Параметры.Текст = " ";
		ВыполнитьОперацию("ПечатьСтроки", Параметры, Ответ);				
		
	КонецЦикла;
	
	Если Объект_.ResultCode <> 0 Тогда
		ОписаниеРезультата = Объект_.ResultCodeDescription;
		ОтключитьсяОтФР(Объект_, ПарольАдминистратора_, НомерЛУ_);
	КонецЕсли;
    Возврат Ответ;
КонецФункции