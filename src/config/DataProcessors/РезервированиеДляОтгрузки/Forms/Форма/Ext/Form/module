

Процедура ПроцентВыполнениеПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки)
	ОформлениеСтроки.ячейки.ПроцентКоличества.текст = Окр(данныеСтроки.КоличествоРезерв *100 / КоличествоЕсть,0);
КонецПроцедуры

Процедура КоманднаяПанель1Обновить(Кнопка)
	ОбновитьЗаказ();
КонецПроцедуры

Процедура КоманднаяПанель2Обновить(Кнопка)
	ОбновитьРезультат();
КонецПроцедуры
	

Процедура КнопкаВыполнитьНажатие(Кнопка)
	
	Если НЕ ЗначениеНеЗаполнено(СсылкаНаОбъект) тогда
		докРезерва = документы.РезервированиеТоваров.СоздатьДокумент();
		докРезерва.ОбработкаЗаполнения(СсылкаНаОбъект);
		докРезерва.Дата = текущаяДата();
		докРезерва.Ответственный = глТекущийПользователь;
		докРезерва.Записать();
		ДокРезерв = докРезерва.Ссылка;
			попытка
              докРезерва.Записать(РежимЗаписиДокумента.Проведение);
			  ЭлементыФормы.Надпись1.Заголовок = строка("Проведен документ: "+строка(докРезерв));
		    исключение
			 ЭлементыФормы.Надпись1.Заголовок = строка("Создан документ: "+строка(докРезерв));
			КонецПопытки;  
	ОбновитьЗаказ();
	КонецЕсли;	
	
КонецПроцедуры


Процедура ОсновныеДействияФормыСоздатьДокументы(Кнопка)
	Если НЕ ЗначениеНеЗаполнено(ДокРезерв) тогда
		
		докРезультата = документы.РеализацияТоваровУслуг.СоздатьДокумент();
		ЗаполнитьЗначенияСвойств(докРезультата,СсылкаНаОбъект); // реквизиты  
		докРезультата.ЗаполнитьТабличнуюЧастьПоЗаказуПокупателяУпр(докРезультата.Товары, СсылкаНаОбъект);//тчТовары
		докРезультата.Дата = текущаяДата();
		докРезультата.Записать();
		докРезультат = докРезультата.Ссылка;
	ЭлементыФормы.Надпись1.Заголовок = строка(?(докРезерв.Проведен,"Проведен","Создан")+" документ: "+строка(докРезерв)+"
											  |"+?(докРезультат.Проведен,"Проведен","Создан")+" документ: "+строка(докРезультат));
		ОбновитьЗаказ();
	иначе
		Предупреждение("Сначала сделайте Резервирование.");
	КонецЕсли;	
КонецПроцедуры

Процедура ОсновныеДействияФормыСнятьРезерв(Кнопка)
	//находим различия в документах Резерва и Результата и делаем "антирезерв"
КонецПроцедуры

Процедура ОснованиеПриИзменении(Элемент)
	Если ЗначениеНеЗаполнено(СсылкаНаОбъект) тогда
		ДокРезерв = документы.РезервированиеТоваров.ПустаяСсылка();
		докРезультата = неопределено;
	иначе
		
	КонецЕсли;	
КонецПроцедуры


//=======================================================================================
процедура ОбновитьЗаказ()
	 Запрос = Новый Запрос;
	 Запрос.Текст = "ВЫБРАТЬ
	                |	ЗаказыПокупателейОстатки.Номенклатура,
	                |	СУММА(ЗаказыПокупателейОстатки.КоличествоОстаток) КАК КоличествоЗаказано
	                |ПОМЕСТИТЬ Заказано
	                |ИЗ
	                |	РегистрНакопления.ЗаказыПокупателей.Остатки(, ЗаказПокупателя = &ЗаказПокупателя) КАК ЗаказыПокупателейОстатки
	                |
	                |СГРУППИРОВАТЬ ПО
	                |	ЗаказыПокупателейОстатки.Номенклатура
	                |;
	                |
	                |////////////////////////////////////////////////////////////////////////////////
	                |ВЫБРАТЬ РАЗЛИЧНЫЕ
	                |	ТоварыНаСкладахОстатки.Склад.ГруппаСкладов КАК ГруппаСкладов,
	                |	Заказано.Номенклатура КАК Номенклатура,
	                |	Заказано.КоличествоЗаказано КАК КоличествоЗаказано,
	                |	ТоварыНаСкладахОстатки.КоличествоОстаток КАК КоличествоОстаток,
	                |	ВЫБОР
	                |		КОГДА ТоварыНаСкладахОстатки.Номенклатура = NULL
	                |			ТОГДА 0
	                |		ИНАЧЕ 1
	                |	КОНЕЦ КАК ЕстьПозицияНаСкладе
	                |ИЗ
	                |	Заказано КАК Заказано
	                |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыНаСкладах.Остатки(
	                |				,
	                |				(НЕ Склад.Транзитный)
	                |					И (НЕ Склад.ЗапретитьИспользование)
	                |					И (НЕ Склад.ПометкаУдаления)
	                |					И Номенклатура В
	                |						(ВЫБРАТЬ РАЗЛИЧНЫЕ
	                |							Заказано.Номенклатура
	                |						ИЗ
	                |							Заказано КАК Заказано)) КАК ТоварыНаСкладахОстатки
	                |		ПО Заказано.Номенклатура = ТоварыНаСкладахОстатки.Номенклатура
	                |ИТОГИ
	                |	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Номенклатура),
	                |	МАКСИМУМ(КоличествоЗаказано),
	                |	СУММА(КоличествоОстаток),
	                |	СУММА(ЕстьПозицияНаСкладе)
	                |ПО
	                |	ОБЩИЕ,
	                |	ГруппаСкладов";
	 
	 Запрос.УстановитьПараметр("ЗаказПокупателя", СсылкаНаОбъект);
	 
	 Результат = Запрос.Выполнить();
	 ВыборкаИтого = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	 //-----------------Общие итоги----------------------------
	 ВыборкаИтого.Следующий();
	 КоличествоЗаказано = ВыборкаИтого.КоличествоЗаказано;
	 КоличествоЕсть 	= ВыборкаИтого.КоличествоОстаток;
	 ПозицийЗаказано    = ВыборкаИтого.Номенклатура;
	 ПозицийЕсть		= ВыборкаИтого.ЕстьПозицияНаСкладе;
	 Если КоличествоЕсть>=КоличествоЗаказано и ПозицийЕсть>=ПозицийЗаказано тогда
		ЭлементыФормы.Надпись1.Заголовок = "Возможность полной отгрузки - Есть!";
		ЭлементыФормы.Надпись1.ЦветТекста = webЦвета.ТемноЗеленый;
	 иначе	
		ЭлементыФормы.Надпись1.Заголовок = "НЕТ Возможности полной отгрузки!";
		ЭлементыФормы.Надпись1.ЦветТекста = webЦвета.ТемноКрасный;
	КонецЕсли;
	
	 Выборка = ВыборкаИтого.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	 	 ПроцентВыполнение.Очистить();
	//-----------------ГруппыСкладов---------------------------------- 
	 Пока Выборка.Следующий() Цикл
	  стр1 = ПроцентВыполнение.Добавить();
	  стр1.Приоритет = 0;
	  Если выборка.ГруппаСкладов=справочники.ГруппыСкладов.ПустаяСсылка() тогда
		 стр1.ГруппаСкладов  = справочники.ГруппыСкладов.найтиПоКоду(00); 
	  иначе
	  	стр1.ГруппаСкладов  = выборка.ГруппаСкладов;
	  КонецЕсли;
	  стр1.КоличествоЕсть = выборка.КоличествоОстаток;
	  стр1.КоличествоРезерв = 0;
	 КонецЦикла;
	 
КонецПроцедуры	

//=======================================================================================
процедура ОбновитьРезультат()
	 Запрос = Новый Запрос;
	 Запрос.Текст = "ВЫБРАТЬ
	                |	ЗаказыПокупателейОстатки.Номенклатура,
	                |	СУММА(ЗаказыПокупателейОстатки.КоличествоОстаток) КАК КоличествоЗаказано
	                |ПОМЕСТИТЬ Заказано
	                |ИЗ
	                |	РегистрНакопления.ЗаказыПокупателей.Остатки(, ЗаказПокупателя = &ЗаказПокупателя) КАК ЗаказыПокупателейОстатки
	                |
	                |СГРУППИРОВАТЬ ПО
	                |	ЗаказыПокупателейОстатки.Номенклатура
	                |;
	                |
	                |////////////////////////////////////////////////////////////////////////////////
	                |ВЫБРАТЬ РАЗЛИЧНЫЕ
	                |	ТоварыНаСкладахОстатки.Склад.ГруппаСкладов КАК ГруппаСкладов,
	                |	ТоварыНаСкладахОстатки.Склад КАК Склад,
	                |	Заказано.Номенклатура КАК Номенклатура,
	                |	Заказано.КоличествоЗаказано КАК КоличествоЗаказано,
	                |	ТоварыНаСкладахОстатки.КоличествоОстаток КАК КоличествоОстаток,
	                |	ВЫБОР
	                |		КОГДА ТоварыНаСкладахОстатки.Номенклатура = NULL
	                |			ТОГДА 0
	                |		ИНАЧЕ 1
	                |	КОНЕЦ КАК ЕстьПозицияНаСкладе
	                |ИЗ
	                |	Заказано КАК Заказано
	                |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыНаСкладах.Остатки(
	                |				,
	                |				(НЕ Склад.Транзитный)
	                |					И (НЕ Склад.ЗапретитьИспользование)
	                |					И (НЕ Склад.ПометкаУдаления)
	                |					И Номенклатура В
	                |						(ВЫБРАТЬ РАЗЛИЧНЫЕ
	                |							Заказано.Номенклатура
	                |						ИЗ
	                |							Заказано КАК Заказано)) КАК ТоварыНаСкладахОстатки
	                |		ПО Заказано.Номенклатура = ТоварыНаСкладахОстатки.Номенклатура
	                |ИТОГИ
	                |	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Номенклатура),
	                |	МАКСИМУМ(КоличествоЗаказано),
	                |	СУММА(КоличествоОстаток),
	                |	СУММА(ЕстьПозицияНаСкладе)
	                |ПО
	                |	ГруппаСкладов,
	                |	Склад";
	 
	 Запрос.УстановитьПараметр("ЗаказПокупателя", СсылкаНаОбъект);
	 
	 Результат = Запрос.Выполнить();
	 ДеревоРезервирования.Строки.Очистить();
	 
	 ДеревоРезервирования = Результат.Выгрузить(ОбходРезультатаЗапроса.ПоГруппировкам); // 1 уровень тоже самое что и 
	 
	 
		 
КонецПроцедуры	



 