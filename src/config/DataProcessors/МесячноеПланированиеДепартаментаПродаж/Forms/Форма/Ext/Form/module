Перем к,СписокИсключаемыхКонтрагентов;
Процедура КнопкаВыполнитьНажатие(Кнопка)
	Если НачалоПериода <> Дата(1,1,1) Тогда	
		Если ЭлементыФормы.Панель.ТекущаяСтраница = ЭлементыФормы.Панель.Страницы.ПланПоНаправленияПродаж тогда
			//очиститм старое
			НачатьТранзакцию();
			НаборЗаписей = РегистрыСведений.МесячныйПланДепортаментаПродаж.СоздатьНаборЗаписей();
			НаборЗаписей.Отбор.месяцПланирования.Установить(НачалоПериода);
			Если ЗначениеЗаполнено(НаправлениеПродаж) тогда
				НаборЗаписей.Отбор.НаправлениеПродаж.Установить(НаправлениеПродаж);
			КонецЕсли;
			НаборЗаписей.Отбор.Менеджер.Установить(Справочники.Пользователи.ПустаяСсылка());
			НаборЗаписей.Записать();
			
			ЗаписатьВРегистр(ЭлементыФормы.ДеревоПланирования.Значение,ложь, НачалоПериода);
			ЗафиксироватьТранзакцию();
		иначеЕсли ЭлементыФормы.Панель.ТекущаяСтраница = ЭлементыФормы.Панель.Страницы.ПланированиеНО тогда
			НачатьТранзакцию();
			//общие планы
			
			НаборЗаписей = РегистрыСведений.МесячныйПланДепортаментаПродаж.СоздатьНаборЗаписей();
			НаборЗаписей.Отбор.месяцПланирования.Установить(НачалоПериода);
			НаборЗаписей.Отбор.НаправлениеПродаж.Установить(НаправлениеПродаж);
			НаборЗаписей.Отбор.Менеджер.Установить(Справочники.Пользователи.ПустаяСсылка());
			НаборЗаписей.Записать();
			
			ЗаписатьВРегистр(ЭлементыФормы.ПланированиеНООТРДП.Значение,ложь, НачалоПериода, НаправлениеПродаж);

			
			//индивидуальные планы для менеджеров
			//очиститм старое
			Запрос = новый запрос;
			Запрос.Текст="ВЫБРАТЬ
			             |	МесячныйПланДепортаментаПродаж.МесяцПланирования,
			             |	МесячныйПланДепортаментаПродаж.НаправлениеПродаж,
			             |	МесячныйПланДепортаментаПродаж.Менеджер,
			             |	МесячныйПланДепортаментаПродаж.ТоварнаяГруппа,
			             |	МесячныйПланДепортаментаПродаж.НоменклатурнаяГруппаПоказатели
			             |ИЗ
			             |	РегистрСведений.МесячныйПланДепортаментаПродаж КАК МесячныйПланДепортаментаПродаж
			             |ГДЕ
			             |	МесячныйПланДепортаментаПродаж.МесяцПланирования = &МесяцПланирования
			             |	И МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеПродаж
			             |	И НЕ МесячныйПланДепортаментаПродаж.Менеджер = ЗНАЧЕНИЕ(Справочник.Пользователи.пустаяссылка)";
						 Запрос.УстановитьПараметр("МесяцПланирования",НачалоПериода);
						 Запрос.УстановитьПараметр("НаправлениеПродаж",НаправлениеПродаж);
						 
						 Рез = запрос.Выполнить().Выбрать();
						 
						 пока рез.Следующий() цикл
						   НаборЗаписей = РегистрыСведений.МесячныйПланДепортаментаПродаж.СоздатьНаборЗаписей();
						   НаборЗаписей.Отбор.месяцПланирования.Установить(рез.МесяцПланирования);	 
						   НаборЗаписей.Отбор.НаправлениеПродаж.Установить(рез.НаправлениеПродаж);	 
						   НаборЗаписей.Отбор.Менеджер.Установить(рез.Менеджер);
						   НаборЗаписей.Отбор.ТоварнаяГруппа.Установить(рез.ТоварнаяГруппа);
						   НаборЗаписей.Отбор.НоменклатурнаяГруппаПоказатели.Установить(рез.НоменклатурнаяГруппаПоказатели);
						   НаборЗаписей.Записать();
						 КонецЦикла;
			ЗаписатьВРегистр(ЭлементыФормы.ПланированиеНОПоМенеджерам.Значение,ложь, НачалоПериода, НаправлениеПродаж);
			ЗафиксироватьТранзакцию();
		иначеЕсли ЭлементыФормы.Панель.ТекущаяСтраница = ЭлементыФормы.Панель.Страницы.ПланоированиеНОНесколькоНаправлений тогда	
			НачатьТранзакцию();
			//общие планы
			СписокНаправлений = новый СписокЗначений;
			ДобавитьВСписокНаправлений(ЭлементыФормы.ПланированиеНООТРДПНесколькоПодразделений.Значение,СписокНаправлений);
						
			Для каждого Направление из СписокНаправлений Цикл
				НаборЗаписей = РегистрыСведений.МесячныйПланДепортаментаПродаж.СоздатьНаборЗаписей();
				НаборЗаписей.Отбор.месяцПланирования.Установить(НачалоПериода);
				НаборЗаписей.Отбор.НаправлениеПродаж.Установить(Направление.Значение);
				НаборЗаписей.Отбор.Менеджер.Установить(Справочники.Пользователи.ПустаяСсылка());
				НаборЗаписей.Записать();
				

			КонецЦикла;
			
			
			ЗаписатьВРегистр(ЭлементыФормы.ПланированиеНООТРДПНесколькоПодразделений.Значение,ложь, НачалоПериода);

			//
			////индивидуальные планы для менеджеров
			////очиститм старое
			//Запрос = новый запрос;
			//Запрос.Текст="ВЫБРАТЬ
			//			 |	МесячныйПланДепортаментаПродаж.МесяцПланирования,
			//			 |	МесячныйПланДепортаментаПродаж.НаправлениеПродаж,
			//			 |	МесячныйПланДепортаментаПродаж.Менеджер,
			//			 |	МесячныйПланДепортаментаПродаж.ТоварнаяГруппа,
			//			 |	МесячныйПланДепортаментаПродаж.НоменклатурнаяГруппаПоказатели
			//			 |ИЗ
			//			 |	РегистрСведений.МесячныйПланДепортаментаПродаж КАК МесячныйПланДепортаментаПродаж
			//			 |ГДЕ
			//			 |	МесячныйПланДепортаментаПродаж.МесяцПланирования = &МесяцПланирования
			//			 |	И МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеПродаж
			//			 |	И НЕ МесячныйПланДепортаментаПродаж.Менеджер = ЗНАЧЕНИЕ(Справочник.Пользователи.пустаяссылка)";
			//			 Запрос.УстановитьПараметр("МесяцПланирования",НачалоПериода);
			//			 Запрос.УстановитьПараметр("НаправлениеПродаж",НаправлениеПродаж);
			//			 
			//			 Рез = запрос.Выполнить().Выбрать();
			//			 
			//			 пока рез.Следующий() цикл
			//			   НаборЗаписей = РегистрыСведений.МесячныйПланДепортаментаПродаж.СоздатьНаборЗаписей();
			//			   НаборЗаписей.Отбор.месяцПланирования.Установить(рез.МесяцПланирования);	 
			//			   НаборЗаписей.Отбор.НаправлениеПродаж.Установить(рез.НаправлениеПродаж);	 
			//			   НаборЗаписей.Отбор.Менеджер.Установить(рез.Менеджер);
			//			   НаборЗаписей.Отбор.ТоварнаяГруппа.Установить(рез.ТоварнаяГруппа);
			//			   НаборЗаписей.Отбор.НоменклатурнаяГруппаПоказатели.Установить(рез.НоменклатурнаяГруппаПоказатели);
			//			   НаборЗаписей.Записать();
			//			 КонецЦикла;
			//ЗаписатьВРегистр(ЭлементыФормы.ПланированиеНОПоМенеджерамНсколькоПодразделений.Значение,ложь, НачалоПериода, НаправлениеПродаж);
			ЗафиксироватьТранзакцию();

		ИначеЕсли ЭлементыФормы.Панель.ТекущаяСтраница = ЭлементыФормы.Панель.Страницы.ПланПоНаправлениюСKPI тогда
			НачатьТранзакцию();
			ЗаписатьВРегистрСKPI(ЭлементыФормы.ДеревоПланированияДоп.Значение, НачалоПериода);
	        ЗафиксироватьТранзакцию();
		КонецЕсли;
	иначе
		Сообщить("Укажите период планирования!");
	конецЕсли;	
 КонецПроцедуры
 
 Процедура ДобавитьВСписокНаправлений(Дерево,Список)
	 Для каждого стр из Дерево.Строки цикл
		 Если стр.Строки.Количество()=0 тогда
			 Если  ЗначениеЗаполнено(стр.НаправлениеПродаж) тогда
				 Если Список.НайтиПоЗначению(стр.НаправлениеПродаж)=неопределено тогда
					 Список.Добавить(стр.НаправлениеПродаж);
					// Сообщить(стр.НаправлениеПродаж);
				 КонецЕсли;
			 КонецЕсли;
		 иначе
			 ДобавитьВСписокНаправлений(стр,Список);
		 КонецЕсли;
	 КонецЦикла;
 КонецПроцедуры
 
 Процедура ЗаписатьВРегистрСKPI(Строка, МесяцПланирования)
	 Для каждого стр из Строка.Строки Цикл
			 Если стр.Строки.Количество()=0 тогда
				//1 Москва
				ЗаписатьПоНаправлению("Москва", Справочники.НаправленияПродаж.Москва, МесяцПланирования,стр);
				// 2. Подмосковье
				ЗаписатьПоНаправлению("Подмосковье", Справочники.НаправленияПродаж.Подмосковье, МесяцПланирования,стр);
				// 3. ЦФО
				ЗаписатьПоНаправлению("ЦФО", Справочники.НаправленияПродаж.ЦентрРоссии, МесяцПланирования,стр);
				// 4. Север
				ЗаписатьПоНаправлению("Север", Справочники.НаправленияПродаж.СеверЮг, МесяцПланирования,стр);
				// 5. Юг
				ЗаписатьПоНаправлению("Юг", Справочники.НаправленияПродаж.НайтиПоКоду("18"), МесяцПланирования,стр);
				// 6. ИнтернетМагазины
				ЗаписатьПоНаправлению("ИнтернетМагазины", Справочники.НаправленияПродаж.ИнтернетМагазины, МесяцПланирования,стр);
				// 7. Поволжье
				ЗаписатьПоНаправлению("Поволжье", Справочники.НаправленияПродаж.НижнийНовгород, МесяцПланирования,стр);
				// 10. КорпКлиенты
				ЗаписатьПоНаправлению("КорпКлиенты", Справочники.НаправленияПродаж.Конечники, МесяцПланирования,стр);
				// 11. Тендеры
				ЗаписатьПоНаправлению("Тендеры", Справочники.НаправленияПродаж.Тендеры, МесяцПланирования,стр);
				// 12. Филиал РНД
				ЗаписатьПоНаправлению("ФилиалРнД", Справочники.НаправленияПродаж.ФилиалРнД, МесяцПланирования,стр);
				// 13. Филиал Спб
				ЗаписатьПоНаправлению("ФилиалСпб", Справочники.НаправленияПродаж.ФилиалСПб, МесяцПланирования,стр);
				// 14. Филиал Спб
				ЗаписатьПоНаправлению("ФилиалЕкат", Справочники.НаправленияПродаж.ФилиалЕкб, МесяцПланирования,стр);
			 иначе
				ЗаписатьВРегистрСKPI(стр, МесяцПланирования);	  	 
			 Конецесли;	  
	 КонецЦикла;
 КонецПроцедуры
 
 Процедура ЗаписатьПоНаправлению(Наименование, Направление,МесяцПланирования,стр)
	 Если стр["КоличествоПредварительный"+Наименование] <>0 или
					 стр["СуммаПредварительный"+Наименование] <>0 или
					 стр["КоличествоИтог"+Наименование] <>0 или
					 стр["СуммаИтог"+Наименование] <>0 или
					 стр["Вес"+Наименование] <>0 или
					 стр["KPI"+Наименование] <>0 тогда
					 
					 Запись = РегистрыСведений.МесячныйПланДепортаментаПродаж.СоздатьМенеджерЗаписи();
						Запись.МесяцПланирования = МесяцПланирования;
						Запись.НаправлениеПродаж = Направление;
						ЗаполнитьЗначенияСвойств(Запись,стр);
						Запись.КоличествоИтоговыйПлан = стр["КоличествоИтог"+Наименование];
						Запись.СуммаИтоговыйПлан = стр["СуммаИтог"+Наименование];
						Запись.КоличествоПлан = стр["КоличествоПредварительный"+Наименование];
						Запись.СуммаПлан = стр["СуммаПредварительный"+Наименование]; 
						Запись.Вес = стр["Вес"+Наименование];
						Запись.KPI =  стр["KPI"+Наименование];
						
						Запись.Записать();
				 КонецЕсли;
КонецПроцедуры

 процедура ЗаписатьВРегистр(строка,Утвердить, МесяцПланирования, НаправлениеПродаж = неопределено)
	 Для каждого стр из Строка.Строки Цикл
		  Если стр.Строки.Количество()=0 тогда
			 //Если Стр.ТоварнаяГруппа.ЭтоГруппа =Ложь Тогда
				 Запись = РегистрыСведений.МесячныйПланДепортаментаПродаж.СоздатьМенеджерЗаписи();
				 Запись.МесяцПланирования = МесяцПланирования;
				 ЗаполнитьЗначенияСвойств(Запись,стр);
				 Если НаправлениеПродаж<>неопределено тогда
					Запись.НаправлениеПродаж = НаправлениеПродаж; 
				 КонецЕсли;
				 //Если Утвердить= Истина Тогда
				 //	Запись.Утвержден = Истина;
				 //конецЕсли;
				 Запись.Записать(Истина);
			 //конецЕсли;
		 иначе
		   ЗаписатьВРегистр(стр,утвердить, МесяцПланирования,НаправлениеПродаж);	  	 
		 Конецесли;	  
		//ЗаписатьВРегистр(стр,утвердить, МесяцПланирования);	  
	конецЦикла;	 
конецПроцедуры	 
 
 
процедура ЗаписатьВРегистрДиски(строка)
	Для каждого стр из Строка.Строки Цикл
		//создадим пустую запись с периодом и направлением продаж, что бы понимать что план утвержден
		
		Если стр.ТоварнаяГруппа <> Null и стр.направлениеПродаж <> Null и стр.номенклатурнаяГруппа <> null Тогда
			//Отбор = Новый Структура();
			//Отбор.Вставить("ПериодПланирования",стр.НоменклатурнаяГруппа);
			//Отбор.Вставить("ТоварнаяГруппа",стр.ТоварнаяГруппа);
			//Отбор.Вставить("направлениеПродаж",Справочники.НаправленияПродаж.Диски);
			//Отбор.Вставить("НоменклатурнаяГруппа",стр.ТоварнаяГруппа.Состав[0].НоменклатурнаяГруппа);
			//Отбор.Вставить("Менеджер",стр.НаправлениеПродаж);
			
			//Проверка = РегистрыСведений.МесячныйПланПродаж.Получить(Отбор);
			Запись = РегистрыСведений.МесячныйПланПродаж.СоздатьМенеджерЗаписи();
			Запись.ПериодПланирования=ДобавитьМесяц(стр.НоменклатурнаяГруппа,12);
			Запись.ТоварнаяГруппа=стр.ТоварнаяГруппа;
			Запись.направлениеПродаж=Справочники.НаправленияПродаж.Диски;
			Запись.НоменклатурнаяГруппа=стр.ТоварнаяГруппа.Состав[0].НоменклатурнаяГруппа;
			Запись.Менеджер=стр.НаправлениеПродаж;
			Запись.количествоплан = стр.Количествоплан;
			Запись.СуммаПлан = стр.Суммаплан;
			Запись.Записать();
		конецесли;	
		ЗаписатьВРегистрДиски(стр);
	конецЦикла;	
	
	
	
конецПроцедуры	

Процедура ПланированиеПриПолученииДанных(Элемент, ОформленияСтрок)
	Для каждого ОформлениеСтроки из Оформлениястрок Цикл
		Если ОформлениеСтроки.ДанныеСтроки.Утвержден = Истина Тогда
			Для каждого яч из ОформлениеСтроки.ячейки	Цикл
				Яч.ТолькоПросмотр = Истина;
				Яч.Шрифт =  Новый Шрифт(,,Истина,,);

			конецЦикла;
		конецЕсли;	
	ОформлениеСтроки.Ячейки.ФактПрошлогоГода.Видимость = ЛожЬ; 	
	ОформлениеСтроки.Ячейки.ФактПрошлогоМесяца.Видимость = ЛожЬ; 	
	ОформлениеСтроки.Ячейки.ПредварительныйЭтогоГода.Видимость = ЛожЬ;
	ОформлениеСтроки.Ячейки.ИтоговыйПлан.Видимость = ЛожЬ;
	конецЦикла;	
КонецПроцедуры



процедура РассчитатьКоличествоПлан(ТекСтрока,ПриростПродаж)
	
	Для каждого стр из  ТекСтрока.Строки Цикл
	стр.ПриростПродажПлан = приростПродаж;
	стр.КоличествоПлан = Окр(стр.количество*(1+приростПродаж/100),0);
    Если стр.СредняяЦенаПлан=0 Тогда
	стр.суммаПлан = Стр.Сумма*(1+приростПродаж/100);
    иначе
	стр.СуммаПлан = Стр.КоличествоПлан*стр.СредняяЦенаПлан;
    конецЕсли;  
	если  Стр.Количествоплан =0 Тогда
	стр.СредняяЦенаПлан = 0;	
	иначе	
    стр.СредняяЦенаПлан = Стр.Суммаплан/Стр.Количествоплан;
	конецЕсли;
	Если стр.ПроцентНаценкиПлан<>0 Тогда
	стр.СуммаНаценкиПлан=стр.СуммаПлан*стр.ПроцентНаценкиПлан/(100+стр.ПроцентНаценкиПлан);	
	стр.ПриростНаценки = стр.СуммаНаценкиПлан-Стр.СуммаНаценки;
    конецЕсли;
    РассчитатьКоличествоПлан(стр,ПриростПродаж);
	пересчетИтогов(стр);

	конеццикла;	
	
конецПроцедуры	

Процедура ДеревоПланированияПриростСреднейЦеныПриИзменении(Элемент)
	стр = ЭлементыФормы.ДеревоПланирования.текущиеДанные;
	ПриростСреднейЦены = стр.ПриростСреднейЦены;
	стр.СредняяЦенаПлан = стр.СредняяЦена*(1+ПриростСреднейЦены/100);
	стр.СуммаПлан = Стр.КоличествоПлан*стр.СредняяЦенаПлан;
	Если стр.ПроцентНаценкиПлан<>0 Тогда
		стр.СуммаНаценкиПлан=стр.СуммаПлан*стр.ПроцентНаценкиПлан/(100+стр.ПроцентНаценкиПлан);	
		стр.ПриростНаценки = стр.СуммаНаценкиПлан-Стр.СуммаНаценки;
	конецЕсли;
	
	РассчитатьСреднююЦенуПлан(стр,ПриростСреднейЦены);
	
	пересчетИтогов(стр);
КонецПроцедуры

процедура РассчитатьСреднююЦенуПлан(ТекСтрока,ПриростСреднейЦены)
	
	Для каждого стр из  ТекСтрока.Строки Цикл
		стр.ПриростСреднейЦены = ПриростСреднейЦены;	
		стр.СредняяЦенаПлан = стр.СредняяЦена*(1+ПриростСреднейЦены/100);
		стр.СуммаПлан = Стр.КоличествоПлан*стр.СредняяЦенаПлан;
		Если стр.ПроцентНаценкиПлан<>0 Тогда
			стр.СуммаНаценкиПлан=стр.СуммаПлан*стр.ПроцентНаценкиПлан/(100+стр.ПроцентНаценкиПлан);	
			стр.ПриростНаценки = стр.СуммаНаценкиПлан-Стр.СуммаНаценки;
		конецЕсли;
		
		РассчитатьСреднююЦенуПлан(стр,ПриростСреднейЦены);
	конеццикла;	
	
конецПроцедуры	

Процедура КоманднаяПанель1ЗаполнитьИзПлана(Кнопка)
	ЗаполнялиДиски = Ложь;
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	МесячныйПланДепортаментаПродаж.МесяцПланирования,
		|	МесячныйПланДепортаментаПродаж.НаправлениеПродаж,
		|	МесячныйПланДепортаментаПродаж.ТоварнаяГруппа,
		|	МесячныйПланДепортаментаПродаж.НоменклатурнаяГруппаПоказатели КАК НоменклатурнаяГруппа,
		|	МесячныйПланДепортаментаПродаж.КоличествоИтоговыйПлан,
		|	МесячныйПланДепортаментаПродаж.СуммаИтоговыйПлан,
		|	МесячныйПланДепортаментаПродаж.КоличествоПлан,
		|	МесячныйПланДепортаментаПродаж.СуммаПлан,
		|	МесячныйПланДепортаментаПродаж.Утвержден
		|ПОМЕСТИТЬ втПлан
		|ИЗ
		|	РегистрСведений.МесячныйПланДепортаментаПродаж КАК МесячныйПланДепортаментаПродаж
		|ГДЕ
		|	МесячныйПланДепортаментаПродаж.МесяцПланирования = &МесяцПланирования
		|	И МесячныйПланДепортаментаПродаж.Менеджер = ЗНАЧЕНИЕ(Справочник.Пользователи.ПустаяСсылка)
		|	И МесячныйПланДепортаментаПродаж.ТоварнаяГруппа <> ЗНАЧЕНИЕ(Справочник.ТоварныеГруппыДляпланирования.ПустаяСсылка)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ПродажиОбороты.ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж КАК НаправлениеПродаж,
		|	ПродажиОбороты.Номенклатура.НоменклатурнаяГруппа КАК НоменклатурнаяГруппа,
		|	СУММА(ПродажиОбороты.КоличествоОборот) КАК КоличествоОборот,
		|	СУММА(ПродажиОбороты.СтоимостьОборот) КАК СтоимостьОборот
		|ПОМЕСТИТЬ втПродажиПрошлогоМесяца
		|ИЗ
		|	РегистрНакопления.Продажи.Обороты(
		|			&НачПериодаПрошлогоМесяца,
		|			&КонПериодаПрошлогоМесяца,
		|			,
		|			ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж В
		|					(ВЫБРАТЬ
		|						втПлан.НаправлениеПродаж
		|					ИЗ
		|						втПлан)
		|				И Номенклатура.НоменклатурнаяГруппа В
		|					(ВЫБРАТЬ
		|						втПлан.НоменклатурнаяГруппа
		|					ИЗ
		|						втПлан)
		|				И НЕ ДоговорКонтрагента.Владелец В (&СписокИсключаемыхКонтрагентов)) КАК ПродажиОбороты
		|
		|СГРУППИРОВАТЬ ПО
		|	ПродажиОбороты.Номенклатура.НоменклатурнаяГруппа,
		|	ПродажиОбороты.ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ПродажиОбороты.ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж КАК НаправлениеПродаж,
		|	ПродажиОбороты.Номенклатура.НоменклатурнаяГруппа КАК НоменклатурнаяГруппа,
		|	СУММА(ПродажиОбороты.КоличествоОборот) КАК КоличествоОборот,
		|	СУММА(ПродажиОбороты.СтоимостьОборот) КАК СтоимостьОборот
		|ПОМЕСТИТЬ втПродажиПрошлогоГода
		|ИЗ
		|	РегистрНакопления.Продажи.Обороты(
		|			&НачПрошлогоПериода,
		|			&КонПрошлогоПериода,
		|			,
		|			ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж В
		|					(ВЫБРАТЬ
		|						втПлан.НаправлениеПродаж
		|					ИЗ
		|						втПлан)
		|				И Номенклатура.НоменклатурнаяГруппа В
		|					(ВЫБРАТЬ
		|						втПлан.НоменклатурнаяГруппа
		|					ИЗ
		|						втПлан)
		|				И НЕ ДоговорКонтрагента.Владелец В (&СписокИсключаемыхКонтрагентов)) КАК ПродажиОбороты
		|
		|СГРУППИРОВАТЬ ПО
		|	ПродажиОбороты.Номенклатура.НоменклатурнаяГруппа,
		|	ПродажиОбороты.ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	втПлан.МесяцПланирования,
		|	втПлан.ТоварнаяГруппа КАК ТоварнаяГруппа,
		|	втПлан.НаправлениеПродаж КАК НаправлениеПродаж,
		|	СУММА(втПлан.КоличествоИтоговыйПлан) КАК КоличествоИтоговыйПлан,
		|	СУММА(втПлан.СуммаИтоговыйПлан) КАК СуммаИтоговыйПлан,
		|	СУММА(втПлан.КоличествоПлан) КАК КоличествоПредварительныйПлан,
		|	СУММА(втПлан.СуммаПлан) КАК СуммаПредварительныйПлан,
		|	втПлан.Утвержден КАК Утвержден,
		|	СУММА(ЕСТЬNULL(втПродажиПрошлогоМесяца.КоличествоОборот, 0)) КАК КоличествоПрошлыйМесяц,
		|	СУММА(ЕСТЬNULL(втПродажиПрошлогоМесяца.СтоимостьОборот, 0)) КАК СуммаПрошлыйМесяц,
		|	втПлан.НоменклатурнаяГруппа КАК НоменклатурнаяГруппаПоказатели,
		|	СУММА(ЕСТЬNULL(втПродажиПрошлогоГода.КоличествоОборот, 0)) КАК КоличествоПрошлыйГод,
		|	СУММА(ЕСТЬNULL(втПродажиПрошлогоГода.СтоимостьОборот, 0)) КАК СуммаПрошлыйГод
		|ИЗ
		|	втПлан КАК втПлан
		|		ЛЕВОЕ СОЕДИНЕНИЕ втПродажиПрошлогоМесяца КАК втПродажиПрошлогоМесяца
		|		ПО втПлан.НаправлениеПродаж = втПродажиПрошлогоМесяца.НаправлениеПродаж
		|			И втПлан.НоменклатурнаяГруппа = втПродажиПрошлогоМесяца.НоменклатурнаяГруппа
		|		ЛЕВОЕ СОЕДИНЕНИЕ втПродажиПрошлогоГода КАК втПродажиПрошлогоГода
		|		ПО втПлан.НаправлениеПродаж = втПродажиПрошлогоГода.НаправлениеПродаж
		|			И втПлан.НоменклатурнаяГруппа = втПродажиПрошлогоГода.НоменклатурнаяГруппа
		|ГДЕ
		|	втПлан.МесяцПланирования = &МесяцПланирования
		|	И втПлан.ТоварнаяГруппа <> ЗНАЧЕНИЕ(Справочник.ТоварныеГруппыДляпланирования.ПустаяСсылка)
		|
		|СГРУППИРОВАТЬ ПО
		|	втПлан.МесяцПланирования,
		|	втПлан.ТоварнаяГруппа,
		|	втПлан.НаправлениеПродаж,
		|	втПлан.Утвержден,
		|	втПлан.НоменклатурнаяГруппа
		|
		|УПОРЯДОЧИТЬ ПО
		|	втПлан.НаправлениеПродаж.Наименование
		|ИТОГИ
		|	СУММА(КоличествоИтоговыйПлан),
		|	СУММА(СуммаИтоговыйПлан),
		|	СУММА(КоличествоПредварительныйПлан),
		|	СУММА(СуммаПредварительныйПлан),
		|	МИНИМУМ(Утвержден),
		|	СУММА(КоличествоПрошлыйМесяц),
		|	СУММА(СуммаПрошлыйМесяц),
		|	СУММА(КоличествоПрошлыйГод),
		|	СУММА(СуммаПрошлыйГод)
		|ПО
		|	ОБЩИЕ,
		|	НаправлениеПродаж,
		|	ТоварнаяГруппа ИЕРАРХИЯ";

	Запрос.УстановитьПараметр("МесяцПланирования", НачалоПериода);
	Запрос.УстановитьПараметр("НачПериодаПрошлогоМесяца", ДобавитьМесяц(НачалоПериода,-1));
	Запрос.УстановитьПараметр("КонПериодаПрошлогоМесяца", ДобавитьМесяц(КонецМесяца(НачалоПериода),-1));
	Запрос.УстановитьПараметр("НачПрошлогоПериода", ДобавитьМесяц(НачалоПериода,-12));
	Запрос.УстановитьПараметр("КонПрошлогоПериода", ДобавитьМесяц(КонецМесяца(НачалоПериода),-12));
	Запрос.УстановитьПараметр("СписокИсключаемыхКонтрагентов", СписокИсключаемыхКонтрагентов);

	
	Если не РольДоступна("ПолныеПрава") или ЗначениеЗаполнено(НаправлениеПродаж) или 
		(Кнопка.Имя<>"ПосмотретьВсе" и не РольДоступна("ПравоЗавершенияРаботыПользователей") и глТекущийПользователь <> Справочники.Пользователи.НайтиПоКоду("Серков"))  Тогда
		СписокНаправлениеПродаж = Новый СписокЗначений;
		Если ЗначениеЗаполнено(НаправлениеПродаж) Тогда
			СписокНаправлениеПродаж.Добавить(НаправлениеПродаж);
		иначе
			ЗапросНП = Новый Запрос;
			ЗапросНП.Текст = 
			"ВЫБРАТЬ
			|	НаправленияПродаж.Ссылка
			|ИЗ
			|	Справочник.НаправленияПродаж КАК НаправленияПродаж
			|ГДЕ
			|	НаправленияПродаж.ОтветственныйЗаПланирование = &ОтветственныйЗаПланирование";
			
			ЗапросНП.УстановитьПараметр("ОтветственныйЗаПланирование", глТекущийПользователь);
			
			РезультатНП = ЗапросНП.Выполнить().Выгрузить();
			
			СписокНаправлениеПродаж = РезультатНП.ВыгрузитьКолонку("Ссылка");
		конецЕсли;
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "//по направлению","");
		Запрос.УстановитьПараметр("НаправлениеПродаж",СписокНаправлениеПродаж);
	конецЕсли;	
	
	
	Результат = Запрос.Выполнить();
	
	Элементыформы.ДеревоПланирования.Значение = Результат.Выгрузить(ОбходРезультатаЗапроса.ПоГруппировкамСИерархией);
	
	

КонецПроцедуры

Процедура ДеревоПланированияПроцентНаценкиПланПриИзменении(Элемент)
	стр = ЭлементыФормы.ДеревоПланирования.текущиеДанные;
	ПроцентНаценкиПлан = стр.ПроцентНаценкиПлан;
	стр.СуммаНаценкиПлан=стр.СуммаПлан*стр.ПроцентНаценкиПлан/(100+стр.ПроцентНаценкиПлан);	
	стр.ПриростНаценки = стр.СуммаНаценкиПлан-Стр.СуммаНаценки;
	
	РассчитатьПроцентНаценкиПлан(стр,ПроцентНаценкиПлан);
    	пересчетИтогов(стр);

КонецПроцедуры

процедура РассчитатьПроцентНаценкиПлан(ТекСтрока,ПроцентНаценкиПлан)
	
	Для каждого стр из  ТекСтрока.Строки Цикл
	стр.ПроцентНаценкиПлан = ПроцентНаценкиПлан;
	стр.СуммаНаценкиПлан=стр.СуммаПлан*стр.ПроцентНаценкиПлан/(100+стр.ПроцентНаценкиПлан);	
	стр.ПриростНаценки = стр.СуммаНаценкиПлан-Стр.СуммаНаценки;
	
	РассчитатьПроцентНаценкиПлан(стр,ПроцентНаценкиПлан);
	конеццикла;	
	
конецПроцедуры	

процедура 	пересчетИтогов(стр);
	РодительскаяСтрока = Стр.Родитель;
	Если РодительскаяСтрока <> Неопределено Тогда
		приростПродажплан =0;
		Количествоплан =0;
		СуммаПлан =0;
		ПриростСреднейЦены=0;
		СредняяЦенаПлан =0;
		ПроцентНаценкиПлан =0;
		СуммаНаценкиПлан =0;
		ПриростНаценки =0;
		КоличествоСтрок =0;
		СебестоимостьПлан =0;
		Себестоимость = 0;
		Для каждого ст из РодительскаяСтрока.Строки  Цикл
			приростПродажплан =приростПродажплан+ст.приростПродажплан;
			Количествоплан =Количествоплан+ст.Количествоплан;
			СуммаПлан =СуммаПлан+ст.СуммаПлан;
			ПриростСреднейЦены=ПриростСреднейЦены+ст.ПриростСреднейЦены;
			СредняяЦенаПлан =СредняяЦенаПлан+ст.СредняяЦенаПлан;
			ПроцентНаценкиПлан =ПроцентНаценкиПлан+ст.ПроцентНаценкиПлан;
			СуммаНаценкиПлан =СуммаНаценкиПлан+ст.СуммаНаценкиПлан;
			ПриростНаценки =ПриростНаценки+ст.ПриростНаценки;
			СебестоимостьПлан = СебестоимостьПлан +ст.СуммаПлан/(100+ст.процентНаценкиПлан)*100;
			себестоимость = себестоимость+ст.себестоимость;
			КоличествоСтрок =КоличествоСтрок+1;
		конецЦикла; 
		если РодительскаяСтрока.Количество=0 Тогда
			РодительскаяСтрока.приростПродажплан =0;
		иначеесли  не ЗначениеЗаполнено(РодительскаяСтрока.ТоварнаяГруппа) и не ЗначениеЗаполнено(РодительскаяСтрока.ТоварнаяГруппа) тогда
			РодительскаяСтрока.приростПродажплан =Окр((СуммаПлан-РодительскаяСтрока.Сумма)/РодительскаяСтрока.Сумма*100,2);
		иначе
			РодительскаяСтрока.приростПродажплан =Окр((КоличествоПлан-РодительскаяСтрока.Количество)/РодительскаяСтрока.Количество*100,2);
		конецЕсли;
		РодительскаяСтрока.Количествоплан =Количествоплан;
		РодительскаяСтрока.СуммаПлан =СуммаПлан;
		РодительскаяСтрока.ПриростСреднейЦены=ПриростСреднейЦены/КоличествоСтрок;
		РодительскаяСтрока.СуммаНаценкиПлан =СуммаНаценкиПлан;
		РодительскаяСтрока.ПриростНаценки =ПриростНаценки;
		
		
		Если количествоПлан=0 Тогда
			РодительскаяСтрока.СредняяЦенаПлан = 0;	
		иначе	
			РодительскаяСтрока.СредняяЦенаПлан =СуммаПлан/КоличествоПлан;
		конецЕсли;
		Если СебестоимостьПлан=0 Тогда
			РодительскаяСтрока.ПроцентНаценкиПлан = 0;	
		иначе	
			РодительскаяСтрока.ПроцентНаценкиПлан =СуммаНаценкиПлан/СебестоимостьПлан*100;
		конецЕсли;
		пересчетИтогов(РодительскаяСтрока);	 
	конецЕсли;	 
конецПроцедуры


Процедура КоманднаяПанель1Утвердить(Кнопка)
	ЗаписатьВРегистр(ЭлементыФормы.ДеревоПланирования.Значение,Истина, НачалоПериода);
КонецПроцедуры

Процедура НачалоПериодаПриИзменении(Элемент)
			НачалоПериода = НачалоМесяца(началоПериода);
			конецПериода = КонецМесяца(началоПериода);
КонецПроцедуры

Процедура НаправлениеПродажНачалоВыбора(Элемент, СтандартнаяОбработка)
	Если не рольДоступна("полныеПрава") Тогда
	СтандартнаяОбработка = Ложь;
	ФормаВыбора = Справочники.НаправленияПродаж.ПолучитьФормуВыбора(,Элемент,);
	ФормаВыбора.Отбор.ОтветственныйЗаПланирование.Значение      = глТекущийпользователь;
	ФормаВыбора.Отбор.ОтветственныйЗаПланирование.Использование = Истина;
	ФормаВыбора.Открыть();
	конецесли;	
	// Вставить содержимое обработчика.
КонецПроцедуры

Процедура НаправлениеПродажПриИзменении(Элемент)
			//Если заполнено направление продаж проверим, можно ли его редактировать
		//Если значениеЗаполнено(НаправлениеПродаж) и Тогда
		//	Отбор = Новый Структура();
		//	Отбор.Вставить("МесяцПланирования",НачалоПериода);
		//	Отбор.Вставить("ТоварнаяГруппа",Справочники.ТоварныеГруппыДляПланирования.ПустаяСсылка());
		//	Отбор.Вставить("НоменклатурнаяГруппаПоказатели",Справочники.НоменклатурныеГруппы.ПустаяСсылка());
		//	Отбор.Вставить("направлениеПродаж",НаправлениеПродаж);
		//	Проверка = РегистрыСведений.МесячныйПланДепортаментаПродаж.Получить(Отбор);
		//	Если Проверка.утвержден тогда
		//		//ЭлементыФормы.КоманднаяПанель1.Кнопки.Заполнить.доступность = Ложь;
		//		ЭлементыФормы.ОсновныеДействияФормы.Кнопки.ОсновныеДействияФормыВыполнить.доступность = Ложь;
		//	иначе
		//		//ЭлементыФормы.КоманднаяПанель1.Кнопки.Заполнить.доступность = истина;
		//		ЭлементыФормы.ОсновныеДействияФормы.Кнопки.ОсновныеДействияФормыВыполнить.доступность = Истина;
		//	конецЕсли;
		//конецЕсли;

КонецПроцедуры

Процедура ДеревоПланированияСредняяЦенаПланПриИзменении(Элемент)
		стр = ЭлементыФормы.ДеревоПланирования.текущиеДанные;
        Стр.суммаПлан = Стр.КоличествоПлан*Стр.СредняяЦенаПлан;
		стр.СуммаНаценкиПлан = стр.СуммаПлан/(100+стр.ПроцентНаценкиПлан)* стр.ПроцентНаценкиПлан;
		стр.ПриростНаценки = стр.СуммаНаценкиПлан-стр.СуммаНаценки;
		РассчитатьСреднююЦенуПланВСтроке(стр,стр.СредняяЦенаПлан);
		пересчетИтогов(стр);	
	КонецПроцедуры
	
процедура РассчитатьСреднююЦенуПланВСтроке(ТекСтрока,СредняяЦенаПлан)
	
	Для каждого стр из  ТекСтрока.Строки Цикл
		стр.СредняяЦенаПлан = СредняяЦенаПлан;
		Стр.суммаПлан = Стр.КоличествоПлан*Стр.СредняяЦенаПлан;
		стр.СуммаНаценкиПлан = стр.СуммаПлан/(100+стр.ПроцентНаценкиПлан)* стр.ПроцентНаценкиПлан;
		стр.ПриростНаценки = стр.СуммаНаценкиПлан-стр.СуммаНаценки;
		РассчитатьСреднююЦенуПланВСтроке(стр,СредняяЦенаПлан);
		пересчетИтогов(стр);
	конеццикла;	
	
конецПроцедуры	
	

Процедура КоманднаяПанель1ПосмотретьВсе(Кнопка)
		Если  РольДоступна("ПравоЗавершенияРаботыПользователей") или глТекущийПользователь = Справочники.Пользователи.НайтиПоКоду("Серков") Тогда
    	иначеЕсли РольДоступна("ПолныеПрава")тогда 
		ЭлементыФормы.ДеревоПланирования.ТолькоПросмотр = Истина;
	    конецЕсли;	
        КоманднаяПанель1ЗаполнитьИзПлана(Кнопка);


КонецПроцедуры

Процедура ДеревоСводПроцентНаценкиПланПриИзменении(Элемент)
	//устанавливаем значение во всех строках с такойже товарной и номенклатурной группой
	ТекущаяСтрока = ЭлементыФормы.ДеревоСвод.текущиеДанные;
    ПроцентНаценкиПлан = ТекущаяСтрока.ПроцентНаценкиПлан;

	Для каждого стр из ЭлементыФормы.ДеревоПланирования.Значение.строки цикл
		Если стр.товарнаяГруппа= ТекущаяСтрока.ТоварнаяГруппа и стр.НоменклатурнаяГруппа =ТекущаяСтрока.НоменклатурнаяГруппа тогда
			стр.процентНаценкиПлан = ПроцентНаценкиПлан;	
			стр.СуммаНаценкиПлан=стр.СуммаПлан*стр.ПроцентНаценкиПлан/(100+стр.ПроцентНаценкиПлан);	
			стр.ПриростНаценки = стр.СуммаНаценкиПлан-Стр.СуммаНаценки;
			
			РассчитатьПроцентНаценкиПлан(стр,ПроцентНаценкиПлан);
			пересчетИтогов(стр);
		иначе	
			проверитьВложенныеСтрокиПроцентНаценкиПлан(стр,текущаяСтрока);
		конецЕсли;	 
	конецЦикла;
	Для каждого стр из ТекущаяСтрока.Строки Цикл
		Стр.ПроцентНаценкиПлан = ПроцентНаценкиПлан;
		установитьПНСвод(стр,ПроцентНаценкиПлан);
	
	 конеццикла;
КонецПроцедуры
процедура установитьПНСвод(строка,ПроцентНаценкиПлан)
	Для каждого стр из строка.Строки Цикл
		Стр.ПроцентНаценкиПлан = ПроцентНаценкиПлан;
		установитьПНСвод(стр,ПроцентНаценкиПлан);
	 конеццикла;
конецПроцедуры	


процедура проверитьВложенныеСтрокиПроцентНаценкиПлан(строка,текущаяСтрока)
	 	Для каждого стр из строка.строки цикл
		Если стр.товарнаяГруппа= ТекущаяСтрока.ТоварнаяГруппа и стр.НоменклатурнаяГруппа =ТекущаяСтрока.НоменклатурнаяГруппа тогда
				ПроцентНаценкиПлан = ТекущаяСтрока.ПроцентНаценкиПлан;
            стр.процентНаценкиПлан = ПроцентНаценкиПлан;
			стр.СуммаНаценкиПлан=стр.СуммаПлан*стр.ПроцентНаценкиПлан/(100+стр.ПроцентНаценкиПлан);	
			стр.ПриростНаценки = стр.СуммаНаценкиПлан-Стр.СуммаНаценки;
			
			РассчитатьПроцентНаценкиПлан(стр,ПроцентНаценкиПлан);
			пересчетИтогов(стр);
		иначе	
			проверитьВложенныеСтрокиПроцентНаценкиПлан(стр,текущаяСтрока);
		конецЕсли;	 
	конецЦикла;

	
	
	
конецПроцедуры	

Процедура ДеревоСводПриростСреднейЦеныПриИзменении(Элемент)
	//устанавливаем значение во всех строках с такойже товарной и номенклатурной группой
	ТекущаяСтрока = ЭлементыФормы.ДеревоСвод.текущиеДанные;
	ПриростСреднейЦены = ТекущаяСтрока.ПриростСреднейЦены;
	
	Для каждого стр из ЭлементыФормы.ДеревоПланирования.Значение.строки цикл
		Если стр.товарнаяГруппа= ТекущаяСтрока.ТоварнаяГруппа и стр.НоменклатурнаяГруппа =ТекущаяСтрока.НоменклатурнаяГруппа тогда
			стр.ПриростСреднейЦены = ПриростСреднейЦены;
			стр.СредняяЦенаПлан = стр.СредняяЦена*(1+ПриростСреднейЦены/100);
			стр.СуммаПлан = Стр.КоличествоПлан*стр.СредняяЦенаПлан;
			Если стр.ПроцентНаценкиПлан<>0 Тогда
				стр.СуммаНаценкиПлан=стр.СуммаПлан*стр.ПроцентНаценкиПлан/(100+стр.ПроцентНаценкиПлан);	
				стр.ПриростНаценки = стр.СуммаНаценкиПлан-Стр.СуммаНаценки;
			конецЕсли;
			
			РассчитатьСреднююЦенуПлан(стр,ПриростСреднейЦены);
			
			пересчетИтогов(стр);
		иначе	
			проверитьВложенныеСтрокиПриростСреднейЦены(стр,текущаяСтрока);
		конецЕсли;	 
	конецЦикла;
	Для каждого стр из ТекущаяСтрока.Строки Цикл
		Стр.ПриростСреднейЦены = ПриростСреднейЦены;
		установитьПСЦСвод(стр,ПриростСреднейЦены);
		
	конеццикла;
КонецПроцедуры
процедура установитьПСЦСвод(строка,ПриростСреднейЦены)
	Для каждого стр из строка.Строки Цикл
		Стр.ПриростСреднейЦены = ПриростСреднейЦены;
		установитьПСЦСвод(стр,ПриростСреднейЦены);
	 конеццикла;
конецПроцедуры	

процедура проверитьВложенныеСтрокиПриростСреднейЦены(строка,текущаяСтрока)
	
	Для каждого стр из строка.строки цикл
		Если стр.товарнаяГруппа= ТекущаяСтрока.ТоварнаяГруппа и стр.НоменклатурнаяГруппа =ТекущаяСтрока.НоменклатурнаяГруппа тогда
			ПриростСреднейЦены = ТекущаяСтрока.ПриростСреднейЦены;
			стр.ПриростСреднейЦены = ПриростСреднейЦены;
			стр.СредняяЦенаПлан = стр.СредняяЦена*(1+ПриростСреднейЦены/100);
			стр.СуммаПлан = Стр.КоличествоПлан*стр.СредняяЦенаПлан;
			Если стр.ПроцентНаценкиПлан<>0 Тогда
				стр.СуммаНаценкиПлан=стр.СуммаПлан*стр.ПроцентНаценкиПлан/(100+стр.ПроцентНаценкиПлан);	
				стр.ПриростНаценки = стр.СуммаНаценкиПлан-Стр.СуммаНаценки;
			конецЕсли;
			
			РассчитатьСреднююЦенуПлан(стр,ПриростСреднейЦены);
			
			пересчетИтогов(стр);
		иначе	
			проверитьВложенныеСтрокиПриростСреднейЦены(стр,текущаяСтрока);
		конецЕсли;	 
	конецЦикла
	
конецПроцедуры	


Процедура ДеревоСводСредняяЦенаПланПриИзменении(Элемент)
	ТекущаяСтрока = ЭлементыФормы.ДеревоСвод.текущиеДанные;
	СредняяЦенаПлан = ТекущаяСтрока.СредняяЦенаПлан;
	
	Для каждого стр из ЭлементыФормы.ДеревоПланирования.Значение.строки цикл
		Если стр.товарнаяГруппа= ТекущаяСтрока.ТоварнаяГруппа и стр.НоменклатурнаяГруппа =ТекущаяСтрока.НоменклатурнаяГруппа тогда
			стр.СредняяЦенаПлан = СредняяЦенаПлан;
			ЗаполнитьВложенныеСтрокиСредняяЦенаПлан(стр,текущаяСтрока);
			пересчетИтогов(стр);
		иначе	
			проверитьВложенныеСтрокиСредняяЦенаПлан(стр,текущаяСтрока);
		конецЕсли;	 
	конецЦикла;
	Для каждого стр из ТекущаяСтрока.Строки Цикл
		Стр.СредняяЦенаПлан = СредняяЦенаПлан;
		установитьСредняяЦенаПланСвод(стр,СредняяЦенаПлан);		
	конеццикла;

КонецПроцедуры

процедура проверитьВложенныеСтрокиСредняяЦенаПлан(строка,текущаяСтрока)
	
	Для каждого стр из строка.строки цикл
		Если стр.товарнаяГруппа= ТекущаяСтрока.ТоварнаяГруппа и стр.НоменклатурнаяГруппа =ТекущаяСтрока.НоменклатурнаяГруппа тогда
			СредняяЦенаПлан = ТекущаяСтрока.СредняяЦенаПлан;
			стр.СредняяЦенаПлан = СредняяЦенаПлан;
			ЗаполнитьВложенныеСтрокиСредняяЦенаПлан(стр,текущаяСтрока);
			пересчетИтогов(стр);
		иначе	
			проверитьВложенныеСтрокиСредняяЦенаПлан(стр,текущаяСтрока);
		конецЕсли;	 
	конецЦикла
	
конецПроцедуры
процедура ЗаполнитьВложенныеСтрокиСредняяЦенаПлан(строка,текущаяСтрока)
	
	Для каждого стр из строка.строки цикл
			СредняяЦенаПлан = ТекущаяСтрока.СредняяЦенаПлан;
			стр.СредняяЦенаПлан = СредняяЦенаПлан;
			ЗаполнитьВложенныеСтрокиСредняяЦенаПлан(стр,текущаяСтрока);
			пересчетИтогов(стр);
	конецЦикла;
	
конецПроцедуры	



процедура установитьСредняяЦенаПланСвод(строка,СредняяЦенаПлан)
	Для каждого стр из строка.Строки Цикл
		Стр.СредняяЦенаПлан = СредняяЦенаПлан;
		установитьСредняяЦенаПланСвод(стр,СредняяЦенаПлан);
	 конеццикла;
конецПроцедуры	

Процедура ДеревоПланированияКоличествоПланПриИзменении(Элемент)
		стр = ЭлементыФормы.ДеревоПланирования.текущиеДанные;
        Стр.суммаПлан = Стр.КоличествоПлан*Стр.СредняяЦенаПлан;
		стр.СуммаНаценкиПлан = стр.СуммаПлан/(100+стр.ПроцентНаценкиПлан)* стр.ПроцентНаценкиПлан;
		стр.ПриростНаценки = стр.СуммаНаценкиПлан-стр.СуммаНаценки;
		РассчитатьколичествоПланВСтроке(стр,стр.КоличествоПлан);

		пересчетИтогов(стр);	
КонецПроцедуры
	
процедура РассчитатьколичествоПланВСтроке(ТекСтрока,КоличествоПлан)
	
	Для каждого стр из  ТекСтрока.Строки Цикл
		стр.КоличествоПлан = КоличествоПлан;
		Стр.суммаПлан = Стр.КоличествоПлан*Стр.СредняяЦенаПлан;
		стр.СуммаНаценкиПлан = стр.СуммаПлан/(100+стр.ПроцентНаценкиПлан)* стр.ПроцентНаценкиПлан;
		стр.ПриростНаценки = стр.СуммаНаценкиПлан-стр.СуммаНаценки;
		РассчитатьКоличествоПланВСтроке(стр,КоличествоПлан);
		пересчетИтогов(стр);
	конеццикла;	
	
конецПроцедуры	

Процедура КоманднаяПанель1ЗаполнитьАксыИАКБ(Кнопка)
	ЗаполнялиДиски =Ложь;
	Запрос = Новый Запрос;
	Запрос.Текст = 
		
				"ВЫБРАТЬ
				|	ПродажиОбороты.Номенклатура.НоменклатурнаяГруппа КАК НоменклатурнаяГруппа,
				|	СУММА(ЕСТЬNULL(ПродажиОбороты.КоличествоОборот, 0)) КАК Количество,
				|	СУММА(ЕСТЬNULL(ПродажиОбороты.СтоимостьОборот, 0)) КАК Стоимость,
				|	СУММА(ЕСТЬNULL(ПродажиОбороты.СтоимостьОборот, 0) - ЕСТЬNULL(ПродажиСебестоимостьОбороты.СтоимостьОборот, 0)) КАК Наценка,
				|	СУММА(ЕСТЬNULL(ПродажиСебестоимостьОбороты.СтоимостьОборот, 0)) КАК Себестоимость,
				|	ПродажиОбороты.ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж
				|ПОМЕСТИТЬ ПродажиПрошлогоГода
				|ИЗ
				|	РегистрНакопления.Продажи.Обороты(&НачПериода, &КонПериода, Регистратор, ) КАК ПродажиОбороты
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ПродажиСебестоимость.Обороты(&НачПериода, &КонПериода, Регистратор, ) КАК ПродажиСебестоимостьОбороты
				|		ПО ПродажиОбороты.Номенклатура = ПродажиСебестоимостьОбороты.Номенклатура
				|			И ПродажиОбороты.Регистратор = ПродажиСебестоимостьОбороты.Регистратор
				|			И ПродажиОбороты.Подразделение = ПродажиСебестоимостьОбороты.Подразделение
				|			И ПродажиОбороты.ЗаказПокупателя = ПродажиСебестоимостьОбороты.ЗаказПокупателя
				|
				|СГРУППИРОВАТЬ ПО
				|	ПродажиОбороты.Номенклатура.НоменклатурнаяГруппа,
				|	ПродажиОбороты.ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж
				|
				|ИНДЕКСИРОВАТЬ ПО
				|	НоменклатурнаяГруппа
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ТоварныеГруппыДляПланированияСостав.Ссылка КАК ТоварнаяГруппа,
				|	ТоварныеГруппыДляПланированияСостав.НоменклатурнаяГруппа,
				|	НаправленияПродаж.Ссылка КАК НаправлениеПродаж
				|ПОМЕСТИТЬ Основа
				|ИЗ
				|	Справочник.НаправленияПродаж КАК НаправленияПродаж,
				|	Справочник.ТоварныеГруппыДляПланирования.Состав КАК ТоварныеГруппыДляПланированияСостав
				|ГДЕ
				|	НаправленияПродаж.ЭтоГруппа = ЛОЖЬ
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ПродажиПрошлогоГода.НоменклатурнаяГруппа,
				|	СУММА(ЕСТЬNULL(ПродажиПрошлогоГода.Стоимость, 0)) КАК Стоимость,
				|	СУММА(ЕСТЬNULL(ПродажиПрошлогоГода.Количество, 0)) КАК Количество
				|ПОМЕСТИТЬ ОбщаяСредняяЦена
				|ИЗ
				|	ПродажиПрошлогоГода КАК ПродажиПрошлогоГода
				|ГДЕ
				|	ПродажиПрошлогоГода.ДоговорКонтрагентаОтветственноеЛицоНаправлениеПродаж = &ДепартаментПродаж
				|
				|СГРУППИРОВАТЬ ПО
				|	ПродажиПрошлогоГода.НоменклатурнаяГруппа
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	Основа.ТоварнаяГруппа КАК ТоварнаяГруппа,
				|	СУММА(ЕСТЬNULL(ПродажиПрошлогоГода.Количество, 0)) КАК Количество,
				|	СУММА(ЕСТЬNULL(ПродажиПрошлогоГода.Стоимость, 0)) КАК Сумма,
				|	СУММА(ЕСТЬNULL(ВЫБОР
				|				КОГДА ЕСТЬNULL(ПродажиПрошлогоГода.Количество, 0) = 0
				|					ТОГДА ВЫБОР
				|							КОГДА ЕСТЬNULL(ОбщаяСредняяЦена.Количество, 0) = 0
				|								ТОГДА 0
				|							ИНАЧЕ ВЫРАЗИТЬ(ОбщаяСредняяЦена.Стоимость / ОбщаяСредняяЦена.Количество КАК ЧИСЛО(15, 2))
				|						КОНЕЦ
				|				ИНАЧЕ ВЫРАЗИТЬ(ПродажиПрошлогоГода.Стоимость / ПродажиПрошлогоГода.Количество КАК ЧИСЛО(15, 2))
				|			КОНЕЦ, 0)) КАК СредняяЦена,
				|	СУММА(ЕСТЬNULL(ПродажиПрошлогоГода.Наценка, 0)) КАК СуммаНаценки,
				|	СРЕДНЕЕ(ЕСТЬNULL(ВЫБОР
				|				КОГДА ПродажиПрошлогоГода.Себестоимость = 0
				|					ТОГДА 0
				|				ИНАЧЕ ПродажиПрошлогоГода.Наценка / ПродажиПрошлогоГода.Себестоимость * 100
				|			КОНЕЦ, 0)) КАК ПроцентНаценки,
				|	СУММА(ЕСТЬNULL(ПродажиПрошлогоГода.Себестоимость, 0)) КАК Себестоимость,
				|	ЛОЖЬ КАК Утвержден,
				|	0 КАК ПриростПродажПлан,
				|	0 КАК КоличествоПлан,
				|	0 КАК СуммаПлан,
				|	0 КАК ПриростСреднейЦены,
				|	0 КАК СредняяЦенаПлан,
				|	СУММА(ЕСТЬNULL(ВЫБОР
				|				КОГДА ПродажиПрошлогоГода.Себестоимость = 0
				|					ТОГДА 0
				|				ИНАЧЕ ПродажиПрошлогоГода.Наценка / ПродажиПрошлогоГода.Себестоимость * 100
				|			КОНЕЦ, 0)) КАК ПроцентНаценкиПлан,
				|	0 КАК СуммаНаценкиПлан,
				|	0 КАК ПриростНаценки,
				|	ЕСТЬNULL(ПродажиПрошлогоГода.ДоговорКонтрагентаОтветственноеЛицоНаправлениеПродаж, Основа.НаправлениеПродаж) КАК НаправлениеПродаж,
				|	Основа.НоменклатурнаяГруппа КАК НоменклатурнаяГруппа,
				|	ЕСТЬNULL(ПродажиПрошлогоГода.ДоговорКонтрагентаОтветственноеЛицоНаправлениеПродаж.Наименование, Основа.НаправлениеПродаж.Наименование) КАК ДляСортировки
				|ИЗ
				|	Основа КАК Основа
				|		ЛЕВОЕ СОЕДИНЕНИЕ ПродажиПрошлогоГода КАК ПродажиПрошлогоГода
				|		ПО Основа.НаправлениеПродаж = ПродажиПрошлогоГода.ДоговорКонтрагентаОтветственноеЛицоНаправлениеПродаж
				|			И Основа.НоменклатурнаяГруппа = ПродажиПрошлогоГода.НоменклатурнаяГруппа
				|		ЛЕВОЕ СОЕДИНЕНИЕ ОбщаяСредняяЦена КАК ОбщаяСредняяЦена
				|		ПО Основа.НоменклатурнаяГруппа = ОбщаяСредняяЦена.НоменклатурнаяГруппа
				|ГДЕ
				|	Основа.НаправлениеПродаж = &НаправлениеПродаж
				|
				|СГРУППИРОВАТЬ ПО
				|	Основа.ТоварнаяГруппа,
				|	Основа.НоменклатурнаяГруппа,
				|	ЕСТЬNULL(ПродажиПрошлогоГода.ДоговорКонтрагентаОтветственноеЛицоНаправлениеПродаж, Основа.НаправлениеПродаж),
				|	ЕСТЬNULL(ПродажиПрошлогоГода.ДоговорКонтрагентаОтветственноеЛицоНаправлениеПродаж.Наименование, Основа.НаправлениеПродаж.Наименование)
				|
				|УПОРЯДОЧИТЬ ПО
				|	ДляСортировки,
				|	Основа.ТоварнаяГруппа.Наименование
				|ИТОГИ
				|	СУММА(Количество),
				|	СУММА(Сумма),
				|	ВЫБОР
				|		КОГДА СУММА(Количество) = 0
				|			ТОГДА СРЕДНЕЕ(СредняяЦена)
				|		ИНАЧЕ СУММА(Сумма) / СУММА(Количество)
				|	КОНЕЦ КАК СредняяЦена,
				|	СУММА(СуммаНаценки),
				|	ВЫБОР
				|		КОГДА СУММА(Себестоимость) = 0
				|			ТОГДА 0
				|		ИНАЧЕ СУММА(СуммаНаценки) / СУММА(Себестоимость) * 100
				|	КОНЕЦ КАК ПроцентНаценки,
				|	СУММА(Себестоимость),
				|	МИНИМУМ(Утвержден),
				|	СУММА(ПриростПродажПлан),
				|	СУММА(КоличествоПлан),
				|	СУММА(СуммаПлан),
				|	СУММА(ПриростСреднейЦены),
				|	СУММА(СредняяЦенаПлан),
				|	ВЫБОР
				|		КОГДА СУММА(Себестоимость) = 0
				|			ТОГДА 0
				|		ИНАЧЕ СУММА(СуммаНаценки) / СУММА(Себестоимость) * 100
				|	КОНЕЦ КАК ПроцентНаценкиПлан,
				|	СУММА(СуммаНаценкиПлан),
				|	СУММА(ПриростНаценки)
				|ПО
				|	ОБЩИЕ,
				|	НаправлениеПродаж,
				|	ТоварнаяГруппа ИЕРАРХИЯ";

	Запрос.УстановитьПараметр("КонПериода",КонецДня(ДобавитьМесяц(КонецПериода,-12)));
	Запрос.УстановитьПараметр("МесяцПланирования",НачалоПериода);
	Запрос.УстановитьПараметр("НачПериода", ДобавитьМесяц(НачалоПериода,-12));
	Запрос.УстановитьПараметр("НаправлениеПродаж",Справочники.НаправленияПродаж.НайтиПоКоду("15"));
	
	
	
	Результат = Запрос.Выполнить();
	Элементыформы.ДеревоПланирования.Значение = Результат.Выгрузить(ОбходРезультатаЗапроса.ПоГруппировкамСИерархией);
	

КонецПроцедуры

Процедура КоманднаяПанель2кнЗаполнитьПланНО(Кнопка)
	Запрос = новый Запрос;
	Запрос.Текст="ВЫБРАТЬ
	             |	МесячныйПланДепортаментаПродаж.МесяцПланирования,
	             |	МесячныйПланДепортаментаПродаж.НаправлениеПродаж,
	             |	ВЫБОР
	             |		КОГДА МесячныйПланДепортаментаПродаж.ТоварнаяГруппа = ЗНАЧЕНИЕ(Справочник.ТоварныегруппыДляПланирования.ПустаяСсылка)
	             |			ТОГДА ""9. Произвольные показатели""
	             |		ИНАЧЕ МесячныйПланДепортаментаПродаж.ТоварнаяГруппа
	             |	КОНЕЦ КАК ТоварнаяГруппа,
	             |	МесячныйПланДепортаментаПродаж.НоменклатурнаяГруппаПоказатели КАК НоменклатурнаяГруппа,
	             |	МесячныйПланДепортаментаПродаж.КоличествоИтоговыйПлан,
	             |	МесячныйПланДепортаментаПродаж.СуммаИтоговыйПлан,
	             |	МесячныйПланДепортаментаПродаж.КоличествоПлан,
	             |	МесячныйПланДепортаментаПродаж.СуммаПлан,
	             |	МесячныйПланДепортаментаПродаж.Утвержден,
	             |	МесячныйПланДепортаментаПродаж.Вес,
	             |	МесячныйПланДепортаментаПродаж.KPI
	             |ПОМЕСТИТЬ втПлан
	             |ИЗ
	             |	РегистрСведений.МесячныйПланДепортаментаПродаж КАК МесячныйПланДепортаментаПродаж
	             |ГДЕ
	             |	МесячныйПланДепортаментаПродаж.МесяцПланирования = &МесяцПланирования
	             |	И МесячныйПланДепортаментаПродаж.Менеджер = ЗНАЧЕНИЕ(Справочник.Пользователи.Пустаяссылка)
	             |	И МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеПродаж
	             |;
	             |
	             |////////////////////////////////////////////////////////////////////////////////
	             |ВЫБРАТЬ
	             |	ПродажиОбороты.ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж КАК НаправлениеПродаж,
	             |	ПродажиОбороты.Номенклатура.НоменклатурнаяГруппа КАК НоменклатурнаяГруппа,
	             |	СУММА(ПродажиОбороты.КоличествоОборот) КАК КоличествоОборот,
	             |	СУММА(ПродажиОбороты.СтоимостьОборот) КАК СтоимостьОборот
	             |ПОМЕСТИТЬ втПродажиПрошлогоМесяца
	             |ИЗ
	             |	РегистрНакопления.Продажи.Обороты(
	             |			&НачПериодаПрошлогоМесяца,
	             |			&КонПериодаПрошлогоМесяца,
	             |			,
	             |			ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж В
	             |					(ВЫБРАТЬ
	             |						втПлан.НаправлениеПродаж
	             |					ИЗ
	             |						втПлан)
	             |				И Номенклатура.НоменклатурнаяГруппа В
	             |					(ВЫБРАТЬ
	             |						втПлан.НоменклатурнаяГруппа
	             |					ИЗ
	             |						втПлан)
	             |				И ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж = &НаправлениеПродаж
	             |				И НЕ ДоговорКонтрагента.Владелец В (&СписокИсключаемыхКонтрагентов)) КАК ПродажиОбороты
	             |
	             |СГРУППИРОВАТЬ ПО
	             |	ПродажиОбороты.Номенклатура.НоменклатурнаяГруппа,
	             |	ПродажиОбороты.ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж
	             |;
	             |
	             |////////////////////////////////////////////////////////////////////////////////
	             |ВЫБРАТЬ
	             |	ПродажиОбороты.ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж КАК НаправлениеПродаж,
	             |	ПродажиОбороты.Номенклатура.НоменклатурнаяГруппа КАК НоменклатурнаяГруппа,
	             |	СУММА(ПродажиОбороты.КоличествоОборот) КАК КоличествоОборот,
	             |	СУММА(ПродажиОбороты.СтоимостьОборот) КАК СтоимостьОборот
	             |ПОМЕСТИТЬ втПродажиПрошлогоГода
	             |ИЗ
	             |	РегистрНакопления.Продажи.Обороты(
	             |			&НачПрошлогоПериода,
	             |			&КонПрошлогоПериода,
	             |			,
	             |			ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж В
	             |					(ВЫБРАТЬ
	             |						втПлан.НаправлениеПродаж
	             |					ИЗ
	             |						втПлан)
	             |				И Номенклатура.НоменклатурнаяГруппа В
	             |					(ВЫБРАТЬ
	             |						втПлан.НоменклатурнаяГруппа
	             |					ИЗ
	             |						втПлан)
	             |				И ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж = &НаправлениеПродаж
	             |				И НЕ ДоговорКонтрагента.Владелец В (&СписокИсключаемыхКонтрагентов)) КАК ПродажиОбороты
	             |
	             |СГРУППИРОВАТЬ ПО
	             |	ПродажиОбороты.Номенклатура.НоменклатурнаяГруппа,
	             |	ПродажиОбороты.ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж
	             |;
	             |
	             |////////////////////////////////////////////////////////////////////////////////
	             |ВЫБРАТЬ
	             |	втПлан.ТоварнаяГруппа КАК ТоварнаяГруппа,
	             |	втПлан.НоменклатурнаяГруппа КАК НоменклатурнаяГруппаПоказатели,
	             |	СУММА(втПлан.КоличествоИтоговыйПлан) КАК КоличествоИтоговыйПлан,
	             |	СУММА(втПлан.СуммаИтоговыйПлан) КАК СуммаИтоговыйПлан,
	             |	СУММА(втПлан.КоличествоПлан) КАК КоличествоПлан,
	             |	СУММА(втПлан.СуммаПлан) КАК СуммаПлан,
	             |	СУММА(ЕСТЬNULL(втПродажиПрошлогоМесяца.КоличествоОборот, 0)) КАК КоличествоПрошлыйМесяц,
	             |	СУММА(ЕСТЬNULL(втПродажиПрошлогоМесяца.СтоимостьОборот, 0)) КАК СуммаПрошлыйМесяц,
	             |	СУММА(ЕСТЬNULL(втПродажиПрошлогоГода.КоличествоОборот, 0)) КАК КоличествоПрошлыйГод,
	             |	СУММА(ЕСТЬNULL(втПродажиПрошлогоГода.СтоимостьОборот, 0)) КАК СуммаПрошлыйГод,
	             |	СУММА(втПлан.Вес) КАК Вес,
	             |	СУММА(втПлан.KPI) КАК KPI
	             |ИЗ
	             |	втПлан КАК втПлан
	             |		ЛЕВОЕ СОЕДИНЕНИЕ втПродажиПрошлогоМесяца КАК втПродажиПрошлогоМесяца
	             |		ПО втПлан.НаправлениеПродаж = втПродажиПрошлогоМесяца.НаправлениеПродаж
	             |			И втПлан.НоменклатурнаяГруппа = втПродажиПрошлогоМесяца.НоменклатурнаяГруппа
	             |		ЛЕВОЕ СОЕДИНЕНИЕ втПродажиПрошлогоГода КАК втПродажиПрошлогоГода
	             |		ПО втПлан.НаправлениеПродаж = втПродажиПрошлогоГода.НаправлениеПродаж
	             |			И втПлан.НоменклатурнаяГруппа = втПродажиПрошлогоГода.НоменклатурнаяГруппа
	             |
	             |СГРУППИРОВАТЬ ПО
	             |	втПлан.ТоварнаяГруппа,
	             |	втПлан.НоменклатурнаяГруппа
	             |
	             |УПОРЯДОЧИТЬ ПО
	             |	ТоварнаяГруппа,
	             |	НоменклатурнаяГруппаПоказатели
	             |ИТОГИ
	             |	СУММА(КоличествоИтоговыйПлан),
	             |	СУММА(СуммаИтоговыйПлан),
	             |	СУММА(КоличествоПлан),
	             |	СУММА(СуммаПлан),
	             |	СУММА(КоличествоПрошлыйМесяц),
	             |	СУММА(СуммаПрошлыйМесяц),
	             |	СУММА(КоличествоПрошлыйГод),
	             |	СУММА(СуммаПрошлыйГод),
	             |	СУММА(Вес),
	             |	СУММА(KPI)
	             |ПО
	             |	ОБЩИЕ,
	             |	ТоварнаяГруппа ИЕРАРХИЯ
	             |АВТОУПОРЯДОЧИВАНИЕ";
				 
				 Запрос.УстановитьПараметр("МесяцПланирования", НачалоПериода);
				 Запрос.УстановитьПараметр("НачПериодаПрошлогоМесяца", ДобавитьМесяц(НачалоПериода,-1));
				 Запрос.УстановитьПараметр("КонПериодаПрошлогоМесяца", ДобавитьМесяц(КонецМесяца(НачалоПериода),-1));
				 Запрос.УстановитьПараметр("НачПрошлогоПериода", ДобавитьМесяц(НачалоПериода,-12));
				 Запрос.УстановитьПараметр("КонПрошлогоПериода", ДобавитьМесяц(КонецМесяца(НачалоПериода),-12));
				 Запрос.УстановитьПараметр("НаправлениеПродаж",НаправлениеПродаж);
	             Запрос.УстановитьПараметр("СписокИсключаемыхКонтрагентов", СписокИсключаемыхКонтрагентов);
	
	Результат = Запрос.Выполнить();
	
	Элементыформы.ПланированиеНООТРДП.Значение = Результат.Выгрузить(ОбходРезультатаЗапроса.ПоГруппировкамСИерархией);
	
	//по менеджерам
	Запрос = новый Запрос;
	Запрос.Текст="ВЫБРАТЬ
	             |	МесячныйПланДепортаментаПродаж.МесяцПланирования,
	             |	МесячныйПланДепортаментаПродаж.НаправлениеПродаж,
	             |	ВЫБОР
	             |		КОГДА МесячныйПланДепортаментаПродаж.ТоварнаяГруппа = ЗНАЧЕНИЕ(Справочник.ТоварныегруппыДляПланирования.ПустаяСсылка)
	             |			ТОГДА ""9. Произвольные показатели""
	             |		ИНАЧЕ МесячныйПланДепортаментаПродаж.ТоварнаяГруппа
	             |	КОНЕЦ КАК ТоварнаяГруппа,
	             |	МесячныйПланДепортаментаПродаж.НоменклатурнаяГруппаПоказатели КАК НоменклатурнаяГруппа,
	             |	МесячныйПланДепортаментаПродаж.КоличествоИтоговыйПлан,
	             |	МесячныйПланДепортаментаПродаж.СуммаИтоговыйПлан,
	             |	МесячныйПланДепортаментаПродаж.КоличествоПлан,
	             |	МесячныйПланДепортаментаПродаж.СуммаПлан,
	             |	МесячныйПланДепортаментаПродаж.Утвержден,
	             |	МесячныйПланДепортаментаПродаж.Вес,
	             |	МесячныйПланДепортаментаПродаж.Менеджер,
	             |	МесячныйПланДепортаментаПродаж.KPI
	             |ПОМЕСТИТЬ втПлан
	             |ИЗ
	             |	РегистрСведений.МесячныйПланДепортаментаПродаж КАК МесячныйПланДепортаментаПродаж
	             |ГДЕ
	             |	МесячныйПланДепортаментаПродаж.МесяцПланирования = &МесяцПланирования
	             |	И НЕ МесячныйПланДепортаментаПродаж.Менеджер = ЗНАЧЕНИЕ(Справочник.Пользователи.Пустаяссылка)
	             |	И МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеПродаж
	             |;
	             |
	             |////////////////////////////////////////////////////////////////////////////////
	             |ВЫБРАТЬ
	             |	ПродажиОбороты.ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж КАК НаправлениеПродаж,
	             |	ПродажиОбороты.Номенклатура.НоменклатурнаяГруппа КАК НоменклатурнаяГруппа,
	             |	СУММА(ПродажиОбороты.КоличествоОборот) КАК КоличествоОборот,
	             |	СУММА(ПродажиОбороты.СтоимостьОборот) КАК СтоимостьОборот,
	             |	ПродажиОбороты.ДоговорКонтрагента.ОтветственноеЛицо
	             |ПОМЕСТИТЬ втПродажиПрошлогоМесяца
	             |ИЗ
	             |	РегистрНакопления.Продажи.Обороты(
	             |			&НачПериодаПрошлогоМесяца,
	             |			&КонПериодаПрошлогоМесяца,
	             |			,
	             |			ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж В
	             |					(ВЫБРАТЬ
	             |						втПлан.НаправлениеПродаж
	             |					ИЗ
	             |						втПлан)
	             |				И Номенклатура.НоменклатурнаяГруппа В
	             |					(ВЫБРАТЬ
	             |						втПлан.НоменклатурнаяГруппа
	             |					ИЗ
	             |						втПлан)
	             |				И ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж = &НаправлениеПродаж
	             |				И НЕ ДоговорКонтрагента.Владелец В (&СписокИсключаемыхКонтрагентов)) КАК ПродажиОбороты
	             |
	             |СГРУППИРОВАТЬ ПО
	             |	ПродажиОбороты.Номенклатура.НоменклатурнаяГруппа,
	             |	ПродажиОбороты.ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж,
	             |	ПродажиОбороты.ДоговорКонтрагента.ОтветственноеЛицо
	             |;
	             |
	             |////////////////////////////////////////////////////////////////////////////////
	             |ВЫБРАТЬ
	             |	ПродажиОбороты.ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж КАК НаправлениеПродаж,
	             |	ПродажиОбороты.Номенклатура.НоменклатурнаяГруппа КАК НоменклатурнаяГруппа,
	             |	СУММА(ПродажиОбороты.КоличествоОборот) КАК КоличествоОборот,
	             |	СУММА(ПродажиОбороты.СтоимостьОборот) КАК СтоимостьОборот,
	             |	ПродажиОбороты.ДоговорКонтрагента.ОтветственноеЛицо
	             |ПОМЕСТИТЬ втПродажиПрошлогоГода
	             |ИЗ
	             |	РегистрНакопления.Продажи.Обороты(
	             |			&НачПрошлогоПериода,
	             |			&КонПрошлогоПериода,
	             |			,
	             |			ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж В
	             |					(ВЫБРАТЬ
	             |						втПлан.НаправлениеПродаж
	             |					ИЗ
	             |						втПлан)
	             |				И Номенклатура.НоменклатурнаяГруппа В
	             |					(ВЫБРАТЬ
	             |						втПлан.НоменклатурнаяГруппа
	             |					ИЗ
	             |						втПлан)
	             |				И ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж = &НаправлениеПродаж
	             |				И НЕ ДоговорКонтрагента.Владелец В (&СписокИсключаемыхКонтрагентов)) КАК ПродажиОбороты
	             |
	             |СГРУППИРОВАТЬ ПО
	             |	ПродажиОбороты.Номенклатура.НоменклатурнаяГруппа,
	             |	ПродажиОбороты.ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж,
	             |	ПродажиОбороты.ДоговорКонтрагента.ОтветственноеЛицо
	             |;
	             |
	             |////////////////////////////////////////////////////////////////////////////////
	             |ВЫБРАТЬ
	             |	втПлан.ТоварнаяГруппа КАК ТоварнаяГруппа,
	             |	втПлан.НоменклатурнаяГруппа КАК НоменклатурнаяГруппаПоказатели,
	             |	СУММА(втПлан.КоличествоИтоговыйПлан) КАК КоличествоИтоговыйПлан,
	             |	СУММА(втПлан.СуммаИтоговыйПлан) КАК СуммаИтоговыйПлан,
	             |	СУММА(втПлан.КоличествоПлан) КАК КоличествоПлан,
	             |	СУММА(втПлан.СуммаПлан) КАК СуммаПлан,
	             |	СУММА(ЕСТЬNULL(втПродажиПрошлогоМесяца.КоличествоОборот, 0)) КАК КоличествоПрошлыйМесяц,
	             |	СУММА(ЕСТЬNULL(втПродажиПрошлогоМесяца.СтоимостьОборот, 0)) КАК СуммаПрошлыйМесяц,
	             |	СУММА(ЕСТЬNULL(втПродажиПрошлогоГода.КоличествоОборот, 0)) КАК КоличествоПрошлыйГод,
	             |	СУММА(ЕСТЬNULL(втПродажиПрошлогоГода.СтоимостьОборот, 0)) КАК СуммаПрошлыйГод,
	             |	СУММА(втПлан.Вес) КАК Вес,
	             |	втПлан.Менеджер КАК Менеджер,
	             |	СУММА(втПлан.KPI) КАК KPI
	             |ИЗ
	             |	втПлан КАК втПлан
	             |		ЛЕВОЕ СОЕДИНЕНИЕ втПродажиПрошлогоМесяца КАК втПродажиПрошлогоМесяца
	             |		ПО втПлан.НаправлениеПродаж = втПродажиПрошлогоМесяца.НаправлениеПродаж
	             |			И втПлан.НоменклатурнаяГруппа = втПродажиПрошлогоМесяца.НоменклатурнаяГруппа
	             |			И втПлан.Менеджер = втПродажиПрошлогоМесяца.ДоговорКонтрагентаОтветственноеЛицо
	             |		ЛЕВОЕ СОЕДИНЕНИЕ втПродажиПрошлогоГода КАК втПродажиПрошлогоГода
	             |		ПО втПлан.НаправлениеПродаж = втПродажиПрошлогоГода.НаправлениеПродаж
	             |			И втПлан.НоменклатурнаяГруппа = втПродажиПрошлогоГода.НоменклатурнаяГруппа
	             |			И втПлан.Менеджер = втПродажиПрошлогоГода.ДоговорКонтрагентаОтветственноеЛицо
	             |
	             |СГРУППИРОВАТЬ ПО
	             |	втПлан.ТоварнаяГруппа,
	             |	втПлан.НоменклатурнаяГруппа,
	             |	втПлан.Менеджер
	             |
	             |УПОРЯДОЧИТЬ ПО
	             |	Менеджер,
	             |	ТоварнаяГруппа,
	             |	НоменклатурнаяГруппаПоказатели
	             |ИТОГИ
	             |	СУММА(КоличествоИтоговыйПлан),
	             |	СУММА(СуммаИтоговыйПлан),
	             |	СУММА(КоличествоПлан),
	             |	СУММА(СуммаПлан),
	             |	СУММА(КоличествоПрошлыйМесяц),
	             |	СУММА(СуммаПрошлыйМесяц),
	             |	СУММА(КоличествоПрошлыйГод),
	             |	СУММА(СуммаПрошлыйГод),
	             |	СУММА(Вес),
	             |	СУММА(KPI)
	             |ПО
	             |	ОБЩИЕ,
	             |	Менеджер,
	             |	ТоварнаяГруппа ИЕРАРХИЯ
	             |АВТОУПОРЯДОЧИВАНИЕ";
				 
				 Запрос.УстановитьПараметр("МесяцПланирования", НачалоПериода);
				 Запрос.УстановитьПараметр("НачПериодаПрошлогоМесяца", ДобавитьМесяц(НачалоПериода,-1));
				 Запрос.УстановитьПараметр("КонПериодаПрошлогоМесяца", ДобавитьМесяц(КонецМесяца(НачалоПериода),-1));
				 Запрос.УстановитьПараметр("НачПрошлогоПериода", ДобавитьМесяц(НачалоПериода,-12));
				 Запрос.УстановитьПараметр("КонПрошлогоПериода", ДобавитьМесяц(КонецМесяца(НачалоПериода),-12));
				 Запрос.УстановитьПараметр("НаправлениеПродаж",НаправлениеПродаж);
	             Запрос.УстановитьПараметр("СписокИсключаемыхКонтрагентов", СписокИсключаемыхКонтрагентов);
	
	Результат = Запрос.Выполнить();
	
	Элементыформы.ПланированиеНОПоМенеджерам.Значение = Результат.Выгрузить(ОбходРезультатаЗапроса.ПоГруппировкамСИерархией);


КонецПроцедуры

Процедура ПланированиеНООТРДППриПолученииДанных(Элемент, ОформленияСтрок)
		Для каждого ОформлениеСтроки из Оформлениястрок Цикл
		//Если ОформлениеСтроки.ДанныеСтроки.Утвержден = Истина Тогда
		//	Для каждого яч из ОформлениеСтроки.ячейки	Цикл
		//		Яч.ТолькоПросмотр = Истина;
		//		Яч.Шрифт =  Новый Шрифт(,,Истина,,);
		//		
		//	конецЦикла;
		//конецЕсли;	
	ОформлениеСтроки.Ячейки.ФактПрошлогоГода.Видимость = ЛожЬ; 	
	ОформлениеСтроки.Ячейки.ФактПрошлогоМесяца.Видимость = ЛожЬ; 	
	ОформлениеСтроки.Ячейки.ПредварительныйПлан.Видимость = ЛожЬ;
	ОформлениеСтроки.Ячейки.ИтоговыйПлан.Видимость = ЛожЬ;
	конецЦикла;	
КонецПроцедуры

Процедура кнЗаполнитьПланСKPIНажатие(Элемент)
	Запрос = новый Запрос;
	Запрос.Текст="ВЫБРАТЬ
	             |	МесячныйПланДепортаментаПродаж.ТоварнаяГруппа КАК ТоварнаяГруппа,
	             |	МесячныйПланДепортаментаПродаж.НоменклатурнаяГруппаПоказатели КАК НоменклатурнаяГруппаПоказатели,
	             |	СУММА(МесячныйПланДепортаментаПродаж.КоличествоИтоговыйПлан) КАК КоличествоИтогОбщий,
	             |	СУММА(МесячныйПланДепортаментаПродаж.СуммаИтоговыйПлан) КАК СуммаИтогОбщий,
	             |	СУММА(МесячныйПланДепортаментаПродаж.КоличествоПлан) КАК КоличествоПредварительныйОбщий,
	             |	СУММА(МесячныйПланДепортаментаПродаж.СуммаПлан) КАК СуммаПредварительныйОбщий,
	             |	СУММА(МесячныйПланДепортаментаПродаж.Вес) КАК ВесОбщий,
	             |	СУММА(МесячныйПланДепортаментаПродаж.KPI) КАК KPIОбщий,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеМосква
	             |				ТОГДА МесячныйПланДепортаментаПродаж.КоличествоИтоговыйПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК КоличествоИтогМосква,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеМосква
	             |				ТОГДА МесячныйПланДепортаментаПродаж.СуммаИтоговыйПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК СуммаИтогМосква,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеМосква
	             |				ТОГДА МесячныйПланДепортаментаПродаж.КоличествоПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК КоличествоПредварительныйМосква,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеМосква
	             |				ТОГДА МесячныйПланДепортаментаПродаж.СуммаПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК СуммаПредварительныйМосква,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеМосква
	             |				ТОГДА МесячныйПланДепортаментаПродаж.Вес
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК ВесМосква,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеМосква
	             |				ТОГДА МесячныйПланДепортаментаПродаж.KPI
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК KPIМосква,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеПодмосковье
	             |				ТОГДА МесячныйПланДепортаментаПродаж.КоличествоИтоговыйПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК КоличествоИтогПодмосковье,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеПодмосковье
	             |				ТОГДА МесячныйПланДепортаментаПродаж.СуммаИтоговыйПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК СуммаИтогПодмосковье,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеПодмосковье
	             |				ТОГДА МесячныйПланДепортаментаПродаж.КоличествоПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК КоличествоПредварительныйПодмосковье,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеПодмосковье
	             |				ТОГДА МесячныйПланДепортаментаПродаж.СуммаПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК СуммаПредварительныйПодмосковье,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеПодмосковье
	             |				ТОГДА МесячныйПланДепортаментаПродаж.Вес
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК ВесПодмосковье,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеПодмосковье
	             |				ТОГДА МесячныйПланДепортаментаПродаж.KPI
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК KPIПодмосковье,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеЦФО
	             |				ТОГДА МесячныйПланДепортаментаПродаж.КоличествоИтоговыйПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК КоличествоИтогЦФО,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеЦФО
	             |				ТОГДА МесячныйПланДепортаментаПродаж.СуммаИтоговыйПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК СуммаИтогЦФО,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеЦФО
	             |				ТОГДА МесячныйПланДепортаментаПродаж.КоличествоПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК КоличествоПредварительныйЦФО,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеЦФО
	             |				ТОГДА МесячныйПланДепортаментаПродаж.СуммаПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК СуммаПредварительныйЦФО,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеЦФО
	             |				ТОГДА МесячныйПланДепортаментаПродаж.Вес
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК ВесЦФО,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеЦФО
	             |				ТОГДА МесячныйПланДепортаментаПродаж.KPI
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК KPIЦФО,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеСевер
	             |				ТОГДА МесячныйПланДепортаментаПродаж.КоличествоИтоговыйПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК КоличествоИтогСевер,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеСевер
	             |				ТОГДА МесячныйПланДепортаментаПродаж.СуммаИтоговыйПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК СуммаИтогСевер,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеСевер
	             |				ТОГДА МесячныйПланДепортаментаПродаж.КоличествоПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК КоличествоПредварительныйСевер,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеСевер
	             |				ТОГДА МесячныйПланДепортаментаПродаж.СуммаПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК СуммаПредварительныйСевер,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеСевер
	             |				ТОГДА МесячныйПланДепортаментаПродаж.Вес
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК ВесСевер,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеСевер
	             |				ТОГДА МесячныйПланДепортаментаПродаж.KPI
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК KPIСевер,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеЮг
	             |				ТОГДА МесячныйПланДепортаментаПродаж.КоличествоИтоговыйПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК КоличествоИтогЮг,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеЮг
	             |				ТОГДА МесячныйПланДепортаментаПродаж.СуммаИтоговыйПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК СуммаИтогЮг,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеЮг
	             |				ТОГДА МесячныйПланДепортаментаПродаж.КоличествоПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК КоличествоПредварительныйЮг,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеЮг
	             |				ТОГДА МесячныйПланДепортаментаПродаж.СуммаПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК СуммаПредварительныйЮг,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеЮг
	             |				ТОГДА МесячныйПланДепортаментаПродаж.Вес
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК ВесЮг,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеЮг
	             |				ТОГДА МесячныйПланДепортаментаПродаж.KPI
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК KPIЮг,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеИнтернетМагазины
	             |				ТОГДА МесячныйПланДепортаментаПродаж.КоличествоИтоговыйПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК КоличествоИтогИнтернетМагазины,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеИнтернетМагазины
	             |				ТОГДА МесячныйПланДепортаментаПродаж.СуммаИтоговыйПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК СуммаИтогИнтернетМагазины,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеИнтернетМагазины
	             |				ТОГДА МесячныйПланДепортаментаПродаж.КоличествоПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК КоличествоПредварительныйИнтернетМагазины,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеИнтернетМагазины
	             |				ТОГДА МесячныйПланДепортаментаПродаж.СуммаПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК СуммаПредварительныйИнтернетМагазины,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеИнтернетМагазины
	             |				ТОГДА МесячныйПланДепортаментаПродаж.Вес
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК ВесИнтернетМагазины,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеИнтернетМагазины
	             |				ТОГДА МесячныйПланДепортаментаПродаж.KPI
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК KPIИнтернетМагазины,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеПоволжье
	             |				ТОГДА МесячныйПланДепортаментаПродаж.КоличествоИтоговыйПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК КоличествоИтогПоволжье,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеПоволжье
	             |				ТОГДА МесячныйПланДепортаментаПродаж.СуммаИтоговыйПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК СуммаИтогПоволжье,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеПоволжье
	             |				ТОГДА МесячныйПланДепортаментаПродаж.КоличествоПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК КоличествоПредварительныйПоволжье,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеПоволжье
	             |				ТОГДА МесячныйПланДепортаментаПродаж.СуммаПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК СуммаПредварительныйПоволжье,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеПоволжье
	             |				ТОГДА МесячныйПланДепортаментаПродаж.Вес
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК ВесПоволжье,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеПоволжье
	             |				ТОГДА МесячныйПланДепортаментаПродаж.KPI
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК KPIПоволжье,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеКорпКлиенты
	             |				ТОГДА МесячныйПланДепортаментаПродаж.КоличествоИтоговыйПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК КоличествоИтогКорпКлиенты,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеКорпКлиенты
	             |				ТОГДА МесячныйПланДепортаментаПродаж.СуммаИтоговыйПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК СуммаИтогКорпКлиенты,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеКорпКлиенты
	             |				ТОГДА МесячныйПланДепортаментаПродаж.КоличествоПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК КоличествоПредварительныйКорпКлиенты,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеКорпКлиенты
	             |				ТОГДА МесячныйПланДепортаментаПродаж.СуммаПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК СуммаПредварительныйКорпКлиенты,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеКорпКлиенты
	             |				ТОГДА МесячныйПланДепортаментаПродаж.Вес
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК ВесКорпКлиенты,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеКорпКлиенты
	             |				ТОГДА МесячныйПланДепортаментаПродаж.KPI
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК KPIКорпКлиенты,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеТендеры
	             |				ТОГДА МесячныйПланДепортаментаПродаж.КоличествоИтоговыйПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК КоличествоИтогТендеры,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеТендеры
	             |				ТОГДА МесячныйПланДепортаментаПродаж.СуммаИтоговыйПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК СуммаИтогТендеры,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеТендеры
	             |				ТОГДА МесячныйПланДепортаментаПродаж.КоличествоПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК КоличествоПредварительныйТендеры,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеТендеры
	             |				ТОГДА МесячныйПланДепортаментаПродаж.СуммаПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК СуммаПредварительныйТендеры,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеТендеры
	             |				ТОГДА МесячныйПланДепортаментаПродаж.Вес
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК ВесТендеры,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеТендеры
	             |				ТОГДА МесячныйПланДепортаментаПродаж.KPI
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК KPIТендеры,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеФилиалРнД
	             |				ТОГДА МесячныйПланДепортаментаПродаж.КоличествоИтоговыйПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК КоличествоИтогФилиалРнД,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеФилиалРнД
	             |				ТОГДА МесячныйПланДепортаментаПродаж.СуммаИтоговыйПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК СуммаИтогФилиалРнД,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеФилиалРнД
	             |				ТОГДА МесячныйПланДепортаментаПродаж.КоличествоПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК КоличествоПредварительныйФилиалРнД,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеФилиалРнД
	             |				ТОГДА МесячныйПланДепортаментаПродаж.СуммаПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК СуммаПредварительныйФилиалРнД,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеФилиалРнД
	             |				ТОГДА МесячныйПланДепортаментаПродаж.Вес
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК ВесФилиалРнД,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеФилиалРнД
	             |				ТОГДА МесячныйПланДепортаментаПродаж.KPI
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК KPIФилиалРнД,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеФилиалСпб
	             |				ТОГДА МесячныйПланДепортаментаПродаж.КоличествоИтоговыйПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК КоличествоИтогФилиалСпб,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеФилиалСпб
	             |				ТОГДА МесячныйПланДепортаментаПродаж.СуммаИтоговыйПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК СуммаИтогФилиалСпб,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеФилиалСпб
	             |				ТОГДА МесячныйПланДепортаментаПродаж.КоличествоПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК КоличествоПредварительныйФилиалСпб,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеФилиалСпб
	             |				ТОГДА МесячныйПланДепортаментаПродаж.СуммаПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК СуммаПредварительныйФилиалСпб,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеФилиалСпб
	             |				ТОГДА МесячныйПланДепортаментаПродаж.Вес
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК ВесФилиалСпб,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеФилиалСпб
	             |				ТОГДА МесячныйПланДепортаментаПродаж.KPI
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК KPIФилиалСпб,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеФилиалЕкб
	             |				ТОГДА МесячныйПланДепортаментаПродаж.КоличествоИтоговыйПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК КоличествоИтогФилиалЕкат,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеФилиалЕкб
	             |				ТОГДА МесячныйПланДепортаментаПродаж.СуммаИтоговыйПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК СуммаИтогФилиалЕкат,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеФилиалЕкб
	             |				ТОГДА МесячныйПланДепортаментаПродаж.КоличествоПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК КоличествоПредварительныйФилиалЕкат,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеФилиалЕкб
	             |				ТОГДА МесячныйПланДепортаментаПродаж.СуммаПлан
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК СуммаПредварительныйФилиалЕкат,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеФилиалЕкб
	             |				ТОГДА МесячныйПланДепортаментаПродаж.Вес
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК ВесФилиалЕкат,
	             |	СУММА(ВЫБОР
	             |			КОГДА МесячныйПланДепортаментаПродаж.НаправлениеПродаж = &НаправлениеФилиалЕкб
	             |				ТОГДА МесячныйПланДепортаментаПродаж.KPI
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК KPIФилиалЕкат
	             |ИЗ
	             |	РегистрСведений.МесячныйПланДепортаментаПродаж КАК МесячныйПланДепортаментаПродаж
	             |ГДЕ
	             |	МесячныйПланДепортаментаПродаж.МесяцПланирования = &МесяцПланирования
	             |	И МесячныйПланДепортаментаПродаж.Менеджер = ЗНАЧЕНИЕ(Справочник.Пользователи.ПустаяСсылка)
	             |
	             |СГРУППИРОВАТЬ ПО
	             |	МесячныйПланДепортаментаПродаж.ТоварнаяГруппа,
	             |	МесячныйПланДепортаментаПродаж.НоменклатурнаяГруппаПоказатели
	             |
	             |УПОРЯДОЧИТЬ ПО
	             |	ТоварнаяГруппа,
	             |	НоменклатурнаяГруппаПоказатели
	             |ИТОГИ
	             |	СУММА(КоличествоИтогОбщий),
	             |	СУММА(СуммаИтогОбщий),
	             |	СУММА(КоличествоПредварительныйОбщий),
	             |	СУММА(СуммаПредварительныйОбщий),
	             |	СУММА(ВесОбщий),
	             |	СУММА(KPIОбщий),
	             |	СУММА(КоличествоИтогМосква),
	             |	СУММА(СуммаИтогМосква),
	             |	СУММА(КоличествоПредварительныйМосква),
	             |	СУММА(СуммаПредварительныйМосква),
	             |	СУММА(ВесМосква),
	             |	СУММА(KPIМосква),
	             |	СУММА(КоличествоИтогПодмосковье),
	             |	СУММА(СуммаИтогПодмосковье),
	             |	СУММА(КоличествоПредварительныйПодмосковье),
	             |	СУММА(СуммаПредварительныйПодмосковье),
	             |	СУММА(ВесПодмосковье),
	             |	СУММА(KPIПодмосковье),
	             |	СУММА(КоличествоИтогЦФО),
	             |	СУММА(СуммаИтогЦФО),
	             |	СУММА(КоличествоПредварительныйЦФО),
	             |	СУММА(СуммаПредварительныйЦФО),
	             |	СУММА(ВесЦФО),
	             |	СУММА(KPIЦФО),
	             |	СУММА(КоличествоИтогСевер),
	             |	СУММА(СуммаИтогСевер),
	             |	СУММА(КоличествоПредварительныйСевер),
	             |	СУММА(СуммаПредварительныйСевер),
	             |	СУММА(ВесСевер),
	             |	СУММА(KPIСевер),
	             |	СУММА(КоличествоИтогЮг),
	             |	СУММА(СуммаИтогЮг),
	             |	СУММА(КоличествоПредварительныйЮг),
	             |	СУММА(СуммаПредварительныйЮг),
	             |	СУММА(ВесЮг),
	             |	СУММА(KPIЮг),
	             |	СУММА(КоличествоИтогИнтернетМагазины),
	             |	СУММА(СуммаИтогИнтернетМагазины),
	             |	СУММА(КоличествоПредварительныйИнтернетМагазины),
	             |	СУММА(СуммаПредварительныйИнтернетМагазины),
	             |	СУММА(ВесИнтернетМагазины),
	             |	СУММА(KPIИнтернетМагазины),
	             |	СУММА(КоличествоИтогПоволжье),
	             |	СУММА(СуммаИтогПоволжье),
	             |	СУММА(КоличествоПредварительныйПоволжье),
	             |	СУММА(СуммаПредварительныйПоволжье),
	             |	СУММА(ВесПоволжье),
	             |	СУММА(KPIПоволжье),
	             |	СУММА(КоличествоИтогКорпКлиенты),
	             |	СУММА(СуммаИтогКорпКлиенты),
	             |	СУММА(КоличествоПредварительныйКорпКлиенты),
	             |	СУММА(СуммаПредварительныйКорпКлиенты),
	             |	СУММА(ВесКорпКлиенты),
	             |	СУММА(KPIКорпКлиенты),
	             |	СУММА(КоличествоИтогТендеры),
	             |	СУММА(СуммаИтогТендеры),
	             |	СУММА(КоличествоПредварительныйТендеры),
	             |	СУММА(СуммаПредварительныйТендеры),
	             |	СУММА(ВесТендеры),
	             |	СУММА(KPIТендеры),
	             |	СУММА(КоличествоИтогФилиалРнД),
	             |	СУММА(СуммаИтогФилиалРнД),
	             |	СУММА(КоличествоПредварительныйФилиалРнД),
	             |	СУММА(СуммаПредварительныйФилиалРнД),
	             |	СУММА(ВесФилиалРнД),
	             |	СУММА(KPIФилиалРнД),
	             |	СУММА(КоличествоИтогФилиалСпб),
	             |	СУММА(СуммаИтогФилиалСпб),
	             |	СУММА(КоличествоПредварительныйФилиалСпб),
	             |	СУММА(СуммаПредварительныйФилиалСпб),
	             |	СУММА(ВесФилиалСпб),
	             |	СУММА(KPIФилиалСпб),
	             |	СУММА(КоличествоИтогФилиалЕкат),
	             |	СУММА(СуммаИтогФилиалЕкат),
	             |	СУММА(КоличествоПредварительныйФилиалЕкат),
	             |	СУММА(СуммаПредварительныйФилиалЕкат),
	             |	СУММА(ВесФилиалЕкат),
	             |	СУММА(KPIФилиалЕкат)
	             |ПО
	             |	ОБЩИЕ,
	             |	ТоварнаяГруппа ИЕРАРХИЯ";
				 Запрос.УстановитьПараметр("МесяцПланирования",НачалоПериода);
				 Запрос.УстановитьПараметр("НаправлениеМосква",Справочники.НаправленияПродаж.Москва);
				 Запрос.УстановитьПараметр("НаправлениеПодмосковье",Справочники.НаправленияПродаж.Подмосковье);
				 Запрос.УстановитьПараметр("НаправлениеЦФО",Справочники.НаправленияПродаж.ЦентрРоссии);
                 Запрос.УстановитьПараметр("НаправлениеСевер",Справочники.НаправленияПродаж.СеверЮг);
				 Запрос.УстановитьПараметр("НаправлениеЮг",Справочники.НаправленияПродаж.НайтиПоКоду("18"));
				 Запрос.УстановитьПараметр("НаправлениеИнтернетМагазины",Справочники.НаправленияПродаж.ИнтернетМагазины);
                 Запрос.УстановитьПараметр("НаправлениеПоволжье",Справочники.НаправленияПродаж.НижнийНовгород);
                 Запрос.УстановитьПараметр("НаправлениеКорпКлиенты",Справочники.НаправленияПродаж.Конечники);
				 Запрос.УстановитьПараметр("НаправлениеТендеры",Справочники.НаправленияПродаж.Тендеры);
				 Запрос.УстановитьПараметр("НаправлениеФилиалРнД",Справочники.НаправленияПродаж.ФилиалРнД);
				 Запрос.УстановитьПараметр("НаправлениеФилиалСпб",Справочники.НаправленияПродаж.ФилиалСПб);
                 Запрос.УстановитьПараметр("НаправлениеФилиалЕкб",Справочники.НаправленияПродаж.ФилиалЕкб);


				 Результат = Запрос.Выполнить();
	
	Элементыформы.ДеревоПланированияДоп.Значение = Результат.Выгрузить(ОбходРезультатаЗапроса.ПоГруппировкамСИерархией);

КонецПроцедуры

Процедура ДеревоПланированияДопПриПолученииДанных(Элемент, ОформленияСтрок)
	Для каждого ОформлениеСтроки из Оформлениястрок Цикл
		
		ОформлениеСтроки.Ячейки.Общий.Видимость = ЛожЬ; 	
		ОформлениеСтроки.Ячейки.ПредварительныйПланОбщий.Видимость = ЛожЬ; 	
		ОформлениеСтроки.Ячейки.ИтоговыйОбщий.Видимость = ЛожЬ;
		
		ОформлениеСтроки.Ячейки.Москва.Видимость = ЛожЬ; 
		ОформлениеСтроки.Ячейки.ПредварительныйПланМосква.Видимость = ЛожЬ; 
		ОформлениеСтроки.Ячейки.ИтоговыйМосква.Видимость = ЛожЬ;
		
		ОформлениеСтроки.Ячейки.Подмосковье.Видимость = ЛожЬ; 
		ОформлениеСтроки.Ячейки.ПредварительныйПодмосковье.Видимость = ЛожЬ; 
		ОформлениеСтроки.Ячейки.ИтоговыйПодмосковье.Видимость = ЛожЬ;

		ОформлениеСтроки.Ячейки.ЦФО.Видимость = ЛожЬ; 
		ОформлениеСтроки.Ячейки.ПредварительныйЦФО.Видимость = ЛожЬ; 
		ОформлениеСтроки.Ячейки.ИтоговыйЦФО.Видимость = ЛожЬ;
		
		ОформлениеСтроки.Ячейки.Север.Видимость = ЛожЬ; 
		ОформлениеСтроки.Ячейки.ПредварительныйСевер.Видимость = ЛожЬ; 
		ОформлениеСтроки.Ячейки.ИтоговыйСевер.Видимость = ЛожЬ;
 
		ОформлениеСтроки.Ячейки.Юг.Видимость = ЛожЬ; 
		ОформлениеСтроки.Ячейки.ПредварительныйЮг.Видимость = ЛожЬ; 
		ОформлениеСтроки.Ячейки.ИтоговыйЮг.Видимость = ЛожЬ;
		
		ОформлениеСтроки.Ячейки.ИнтернетМагазины.Видимость = ЛожЬ; 
		ОформлениеСтроки.Ячейки.ПредварительныйИнтернетМагазины.Видимость = ЛожЬ; 
		ОформлениеСтроки.Ячейки.ИтоговыйИнтернетМагазины.Видимость = ЛожЬ;
		
		ОформлениеСтроки.Ячейки.Поволжье.Видимость = ЛожЬ; 
		ОформлениеСтроки.Ячейки.ПредварительныйПоволжье.Видимость = ЛожЬ; 
		ОформлениеСтроки.Ячейки.ИтоговыйПоволжье.Видимость = ЛожЬ;
		
        ОформлениеСтроки.Ячейки.КорпКлиенты.Видимость = ЛожЬ; 
		ОформлениеСтроки.Ячейки.ПредварительныйКорпКлиенты.Видимость = ЛожЬ; 
		ОформлениеСтроки.Ячейки.ИтоговыйКорпКлиенты.Видимость = ЛожЬ;

		ОформлениеСтроки.Ячейки.Тендеры.Видимость = ЛожЬ; 
		ОформлениеСтроки.Ячейки.ПредварительныйТендеры.Видимость = ЛожЬ; 
		ОформлениеСтроки.Ячейки.ИтоговыйТендеры.Видимость = ЛожЬ;
		
		ОформлениеСтроки.Ячейки.ФилиалРнД.Видимость = ЛожЬ; 
		ОформлениеСтроки.Ячейки.ПредварительныйФилиалРнД.Видимость = ЛожЬ; 
		ОформлениеСтроки.Ячейки.ИтоговыйФилиалРнД.Видимость = ЛожЬ;
		
        ОформлениеСтроки.Ячейки.ФилиалСпб.Видимость = ЛожЬ; 
		ОформлениеСтроки.Ячейки.ПредварительныйФилиалСпб.Видимость = ЛожЬ; 
		ОформлениеСтроки.Ячейки.ИтоговыйФилиалСпб.Видимость = ЛожЬ;

		ОформлениеСтроки.Ячейки.ФилиалЕкат.Видимость = ЛожЬ; 
		ОформлениеСтроки.Ячейки.ПредварительныйФилиалЕкат.Видимость = ЛожЬ; 
		ОформлениеСтроки.Ячейки.ИтоговыйФилиалЕкат.Видимость = ЛожЬ;
		

	конецЦикла;	
КонецПроцедуры

Процедура КоманднаяПанель5Заполнить(Кнопка)
	Запрос = новый Запрос;
	Запрос.Текст="ВЫБРАТЬ
	             |	МесячныйПланДепортаментаПродаж.МесяцПланирования,
	             |	МесячныйПланДепортаментаПродаж.НаправлениеПродаж,
	             |	ВЫБОР
	             |		КОГДА МесячныйПланДепортаментаПродаж.ТоварнаяГруппа = ЗНАЧЕНИЕ(Справочник.ТоварныегруппыДляПланирования.ПустаяСсылка)
	             |			ТОГДА ""9. Произвольные показатели""
	             |		ИНАЧЕ МесячныйПланДепортаментаПродаж.ТоварнаяГруппа
	             |	КОНЕЦ КАК ТоварнаяГруппа,
	             |	МесячныйПланДепортаментаПродаж.НоменклатурнаяГруппаПоказатели КАК НоменклатурнаяГруппа,
	             |	МесячныйПланДепортаментаПродаж.КоличествоИтоговыйПлан,
	             |	МесячныйПланДепортаментаПродаж.СуммаИтоговыйПлан,
	             |	МесячныйПланДепортаментаПродаж.КоличествоПлан,
	             |	МесячныйПланДепортаментаПродаж.СуммаПлан,
	             |	МесячныйПланДепортаментаПродаж.Утвержден,
	             |	МесячныйПланДепортаментаПродаж.Вес,
	             |	МесячныйПланДепортаментаПродаж.KPI
	             |ПОМЕСТИТЬ втПлан
	             |ИЗ
	             |	РегистрСведений.МесячныйПланДепортаментаПродаж КАК МесячныйПланДепортаментаПродаж
	             |ГДЕ
	             |	МесячныйПланДепортаментаПродаж.МесяцПланирования = &МесяцПланирования
	             |	И МесячныйПланДепортаментаПродаж.Менеджер = ЗНАЧЕНИЕ(Справочник.Пользователи.Пустаяссылка)
	             |;
	             |
	             |////////////////////////////////////////////////////////////////////////////////
	             |ВЫБРАТЬ
	             |	ПродажиОбороты.ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж КАК НаправлениеПродаж,
	             |	ПродажиОбороты.Номенклатура.НоменклатурнаяГруппа КАК НоменклатурнаяГруппа,
	             |	СУММА(ПродажиОбороты.КоличествоОборот) КАК КоличествоОборот,
	             |	СУММА(ПродажиОбороты.СтоимостьОборот) КАК СтоимостьОборот
	             |ПОМЕСТИТЬ втПродажиПрошлогоМесяца
	             |ИЗ
	             |	РегистрНакопления.Продажи.Обороты(
	             |			&НачПериодаПрошлогоМесяца,
	             |			&КонПериодаПрошлогоМесяца,
	             |			,
	             |			ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж В
	             |					(ВЫБРАТЬ
	             |						втПлан.НаправлениеПродаж
	             |					ИЗ
	             |						втПлан)
	             |				И Номенклатура.НоменклатурнаяГруппа В
	             |					(ВЫБРАТЬ
	             |						втПлан.НоменклатурнаяГруппа
	             |					ИЗ
	             |						втПлан)
	             |				И НЕ ДоговорКонтрагента.Владелец В (&СписокИсключаемыхКонтрагентов)) КАК ПродажиОбороты
	             |
	             |СГРУППИРОВАТЬ ПО
	             |	ПродажиОбороты.Номенклатура.НоменклатурнаяГруппа,
	             |	ПродажиОбороты.ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж
	             |;
	             |
	             |////////////////////////////////////////////////////////////////////////////////
	             |ВЫБРАТЬ
	             |	ПродажиОбороты.ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж КАК НаправлениеПродаж,
	             |	ПродажиОбороты.Номенклатура.НоменклатурнаяГруппа КАК НоменклатурнаяГруппа,
	             |	СУММА(ПродажиОбороты.КоличествоОборот) КАК КоличествоОборот,
	             |	СУММА(ПродажиОбороты.СтоимостьОборот) КАК СтоимостьОборот
	             |ПОМЕСТИТЬ втПродажиПрошлогоГода
	             |ИЗ
	             |	РегистрНакопления.Продажи.Обороты(
	             |			&НачПрошлогоПериода,
	             |			&КонПрошлогоПериода,
	             |			,
	             |			ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж В
	             |					(ВЫБРАТЬ
	             |						втПлан.НаправлениеПродаж
	             |					ИЗ
	             |						втПлан)
	             |				И Номенклатура.НоменклатурнаяГруппа В
	             |					(ВЫБРАТЬ
	             |						втПлан.НоменклатурнаяГруппа
	             |					ИЗ
	             |						втПлан)
	             |				И НЕ ДоговорКонтрагента.Владелец В (&СписокИсключаемыхКонтрагентов)) КАК ПродажиОбороты
	             |
	             |СГРУППИРОВАТЬ ПО
	             |	ПродажиОбороты.Номенклатура.НоменклатурнаяГруппа,
	             |	ПродажиОбороты.ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж
	             |;
	             |
	             |////////////////////////////////////////////////////////////////////////////////
	             |ВЫБРАТЬ
	             |	втПлан.ТоварнаяГруппа КАК ТоварнаяГруппа,
	             |	втПлан.НоменклатурнаяГруппа КАК НоменклатурнаяГруппаПоказатели,
	             |	СУММА(втПлан.КоличествоИтоговыйПлан) КАК КоличествоИтоговыйПлан,
	             |	СУММА(втПлан.СуммаИтоговыйПлан) КАК СуммаИтоговыйПлан,
	             |	СУММА(втПлан.КоличествоПлан) КАК КоличествоПлан,
	             |	СУММА(втПлан.СуммаПлан) КАК СуммаПлан,
	             |	СУММА(ЕСТЬNULL(втПродажиПрошлогоМесяца.КоличествоОборот, 0)) КАК КоличествоПрошлыйМесяц,
	             |	СУММА(ЕСТЬNULL(втПродажиПрошлогоМесяца.СтоимостьОборот, 0)) КАК СуммаПрошлыйМесяц,
	             |	СУММА(ЕСТЬNULL(втПродажиПрошлогоГода.КоличествоОборот, 0)) КАК КоличествоПрошлыйГод,
	             |	СУММА(ЕСТЬNULL(втПродажиПрошлогоГода.СтоимостьОборот, 0)) КАК СуммаПрошлыйГод,
	             |	СУММА(втПлан.Вес) КАК Вес,
	             |	СУММА(втПлан.KPI) КАК KPI,
	             |	втПлан.НаправлениеПродаж КАК НаправлениеПродаж
	             |ИЗ
	             |	втПлан КАК втПлан
	             |		ЛЕВОЕ СОЕДИНЕНИЕ втПродажиПрошлогоМесяца КАК втПродажиПрошлогоМесяца
	             |		ПО втПлан.НаправлениеПродаж = втПродажиПрошлогоМесяца.НаправлениеПродаж
	             |			И втПлан.НоменклатурнаяГруппа = втПродажиПрошлогоМесяца.НоменклатурнаяГруппа
	             |		ЛЕВОЕ СОЕДИНЕНИЕ втПродажиПрошлогоГода КАК втПродажиПрошлогоГода
	             |		ПО втПлан.НаправлениеПродаж = втПродажиПрошлогоГода.НаправлениеПродаж
	             |			И втПлан.НоменклатурнаяГруппа = втПродажиПрошлогоГода.НоменклатурнаяГруппа
	             |
	             |СГРУППИРОВАТЬ ПО
	             |	втПлан.ТоварнаяГруппа,
	             |	втПлан.НоменклатурнаяГруппа,
	             |	втПлан.НаправлениеПродаж
	             |
	             |УПОРЯДОЧИТЬ ПО
	             |	НаправлениеПродаж,
	             |	ТоварнаяГруппа,
	             |	НоменклатурнаяГруппаПоказатели
	             |ИТОГИ
	             |	СУММА(КоличествоИтоговыйПлан),
	             |	СУММА(СуммаИтоговыйПлан),
	             |	СУММА(КоличествоПлан),
	             |	СУММА(СуммаПлан),
	             |	СУММА(КоличествоПрошлыйМесяц),
	             |	СУММА(СуммаПрошлыйМесяц),
	             |	СУММА(КоличествоПрошлыйГод),
	             |	СУММА(СуммаПрошлыйГод),
	             |	СУММА(Вес),
	             |	СУММА(KPI)
	             |ПО
	             |	ОБЩИЕ,
	             |	НаправлениеПродаж,
	             |	ТоварнаяГруппа ИЕРАРХИЯ
	             |АВТОУПОРЯДОЧИВАНИЕ";
				 
				 Запрос.УстановитьПараметр("МесяцПланирования", НачалоПериода);
				 Запрос.УстановитьПараметр("НачПериодаПрошлогоМесяца", ДобавитьМесяц(НачалоПериода,-1));
				 Запрос.УстановитьПараметр("КонПериодаПрошлогоМесяца", ДобавитьМесяц(КонецМесяца(НачалоПериода),-1));
				 Запрос.УстановитьПараметр("НачПрошлогоПериода", ДобавитьМесяц(НачалоПериода,-12));
				 Запрос.УстановитьПараметр("КонПрошлогоПериода", ДобавитьМесяц(КонецМесяца(НачалоПериода),-12));
				 Запрос.УстановитьПараметр("СписокИсключаемыхКонтрагентов", СписокИсключаемыхКонтрагентов);
				 //Запрос.УстановитьПараметр("НаправлениеПродаж",НаправлениеПродаж);
	
	
	Результат = Запрос.Выполнить();
	
	Элементыформы.ПланированиеНООТРДПНесколькоПодразделений.Значение = Результат.Выгрузить(ОбходРезультатаЗапроса.ПоГруппировкамСИерархией);
	
	//по менеджерам
	Запрос = новый Запрос;
	Запрос.Текст="ВЫБРАТЬ
	             |	МесячныйПланДепортаментаПродаж.МесяцПланирования,
	             |	МесячныйПланДепортаментаПродаж.НаправлениеПродаж,
	             |	ВЫБОР
	             |		КОГДА МесячныйПланДепортаментаПродаж.ТоварнаяГруппа = ЗНАЧЕНИЕ(Справочник.ТоварныегруппыДляПланирования.ПустаяСсылка)
	             |			ТОГДА ""9. Произвольные показатели""
	             |		ИНАЧЕ МесячныйПланДепортаментаПродаж.ТоварнаяГруппа
	             |	КОНЕЦ КАК ТоварнаяГруппа,
	             |	МесячныйПланДепортаментаПродаж.НоменклатурнаяГруппаПоказатели КАК НоменклатурнаяГруппа,
	             |	МесячныйПланДепортаментаПродаж.КоличествоИтоговыйПлан,
	             |	МесячныйПланДепортаментаПродаж.СуммаИтоговыйПлан,
	             |	МесячныйПланДепортаментаПродаж.КоличествоПлан,
	             |	МесячныйПланДепортаментаПродаж.СуммаПлан,
	             |	МесячныйПланДепортаментаПродаж.Утвержден,
	             |	МесячныйПланДепортаментаПродаж.Вес,
	             |	МесячныйПланДепортаментаПродаж.Менеджер,
	             |	МесячныйПланДепортаментаПродаж.KPI
	             |ПОМЕСТИТЬ втПлан
	             |ИЗ
	             |	РегистрСведений.МесячныйПланДепортаментаПродаж КАК МесячныйПланДепортаментаПродаж
	             |ГДЕ
	             |	МесячныйПланДепортаментаПродаж.МесяцПланирования = &МесяцПланирования
	             |	И НЕ МесячныйПланДепортаментаПродаж.Менеджер = ЗНАЧЕНИЕ(Справочник.Пользователи.Пустаяссылка)
	             |;
	             |
	             |////////////////////////////////////////////////////////////////////////////////
	             |ВЫБРАТЬ
	             |	ПродажиОбороты.ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж КАК НаправлениеПродаж,
	             |	ПродажиОбороты.Номенклатура.НоменклатурнаяГруппа КАК НоменклатурнаяГруппа,
	             |	СУММА(ПродажиОбороты.КоличествоОборот) КАК КоличествоОборот,
	             |	СУММА(ПродажиОбороты.СтоимостьОборот) КАК СтоимостьОборот,
	             |	ПродажиОбороты.ДоговорКонтрагента.ОтветственноеЛицо
	             |ПОМЕСТИТЬ втПродажиПрошлогоМесяца
	             |ИЗ
	             |	РегистрНакопления.Продажи.Обороты(
	             |			&НачПериодаПрошлогоМесяца,
	             |			&КонПериодаПрошлогоМесяца,
	             |			,
	             |			ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж В
	             |					(ВЫБРАТЬ
	             |						втПлан.НаправлениеПродаж
	             |					ИЗ
	             |						втПлан)
	             |				И Номенклатура.НоменклатурнаяГруппа В
	             |					(ВЫБРАТЬ
	             |						втПлан.НоменклатурнаяГруппа
	             |					ИЗ
	             |						втПлан)
	             |				И НЕ ДоговорКонтрагента.Владелец В (&СписокИсключаемыхКонтрагентов)) КАК ПродажиОбороты
	             |
	             |СГРУППИРОВАТЬ ПО
	             |	ПродажиОбороты.Номенклатура.НоменклатурнаяГруппа,
	             |	ПродажиОбороты.ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж,
	             |	ПродажиОбороты.ДоговорКонтрагента.ОтветственноеЛицо
	             |;
	             |
	             |////////////////////////////////////////////////////////////////////////////////
	             |ВЫБРАТЬ
	             |	ПродажиОбороты.ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж КАК НаправлениеПродаж,
	             |	ПродажиОбороты.Номенклатура.НоменклатурнаяГруппа КАК НоменклатурнаяГруппа,
	             |	СУММА(ПродажиОбороты.КоличествоОборот) КАК КоличествоОборот,
	             |	СУММА(ПродажиОбороты.СтоимостьОборот) КАК СтоимостьОборот,
	             |	ПродажиОбороты.ДоговорКонтрагента.ОтветственноеЛицо
	             |ПОМЕСТИТЬ втПродажиПрошлогоГода
	             |ИЗ
	             |	РегистрНакопления.Продажи.Обороты(
	             |			&НачПрошлогоПериода,
	             |			&КонПрошлогоПериода,
	             |			,
	             |			ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж В
	             |					(ВЫБРАТЬ
	             |						втПлан.НаправлениеПродаж
	             |					ИЗ
	             |						втПлан)
	             |				И Номенклатура.НоменклатурнаяГруппа В
	             |					(ВЫБРАТЬ
	             |						втПлан.НоменклатурнаяГруппа
	             |					ИЗ
	             |						втПлан)
	             |				И НЕ ДоговорКонтрагента.Владелец В (&СписокИсключаемыхКонтрагентов)) КАК ПродажиОбороты
	             |
	             |СГРУППИРОВАТЬ ПО
	             |	ПродажиОбороты.Номенклатура.НоменклатурнаяГруппа,
	             |	ПродажиОбороты.ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж,
	             |	ПродажиОбороты.ДоговорКонтрагента.ОтветственноеЛицо
	             |;
	             |
	             |////////////////////////////////////////////////////////////////////////////////
	             |ВЫБРАТЬ
	             |	втПлан.ТоварнаяГруппа КАК ТоварнаяГруппа,
	             |	втПлан.НоменклатурнаяГруппа КАК НоменклатурнаяГруппаПоказатели,
	             |	СУММА(втПлан.КоличествоИтоговыйПлан) КАК КоличествоИтоговыйПлан,
	             |	СУММА(втПлан.СуммаИтоговыйПлан) КАК СуммаИтоговыйПлан,
	             |	СУММА(втПлан.КоличествоПлан) КАК КоличествоПлан,
	             |	СУММА(втПлан.СуммаПлан) КАК СуммаПлан,
	             |	СУММА(ЕСТЬNULL(втПродажиПрошлогоМесяца.КоличествоОборот, 0)) КАК КоличествоПрошлыйМесяц,
	             |	СУММА(ЕСТЬNULL(втПродажиПрошлогоМесяца.СтоимостьОборот, 0)) КАК СуммаПрошлыйМесяц,
	             |	СУММА(ЕСТЬNULL(втПродажиПрошлогоГода.КоличествоОборот, 0)) КАК КоличествоПрошлыйГод,
	             |	СУММА(ЕСТЬNULL(втПродажиПрошлогоГода.СтоимостьОборот, 0)) КАК СуммаПрошлыйГод,
	             |	СУММА(втПлан.Вес) КАК Вес,
	             |	втПлан.Менеджер КАК Менеджер,
	             |	СУММА(втПлан.KPI) КАК KPI,
	             |	втПлан.НаправлениеПродаж КАК НаправлениеПродаж
	             |ИЗ
	             |	втПлан КАК втПлан
	             |		ЛЕВОЕ СОЕДИНЕНИЕ втПродажиПрошлогоМесяца КАК втПродажиПрошлогоМесяца
	             |		ПО втПлан.НаправлениеПродаж = втПродажиПрошлогоМесяца.НаправлениеПродаж
	             |			И втПлан.НоменклатурнаяГруппа = втПродажиПрошлогоМесяца.НоменклатурнаяГруппа
	             |			И втПлан.Менеджер = втПродажиПрошлогоМесяца.ДоговорКонтрагентаОтветственноеЛицо
	             |		ЛЕВОЕ СОЕДИНЕНИЕ втПродажиПрошлогоГода КАК втПродажиПрошлогоГода
	             |		ПО втПлан.НаправлениеПродаж = втПродажиПрошлогоГода.НаправлениеПродаж
	             |			И втПлан.НоменклатурнаяГруппа = втПродажиПрошлогоГода.НоменклатурнаяГруппа
	             |			И втПлан.Менеджер = втПродажиПрошлогоГода.ДоговорКонтрагентаОтветственноеЛицо
	             |
	             |СГРУППИРОВАТЬ ПО
	             |	втПлан.ТоварнаяГруппа,
	             |	втПлан.НоменклатурнаяГруппа,
	             |	втПлан.Менеджер,
	             |	втПлан.НаправлениеПродаж
	             |
	             |УПОРЯДОЧИТЬ ПО
	             |	НаправлениеПродаж,
	             |	Менеджер,
	             |	ТоварнаяГруппа,
	             |	НоменклатурнаяГруппаПоказатели
	             |ИТОГИ
	             |	СУММА(КоличествоИтоговыйПлан),
	             |	СУММА(СуммаИтоговыйПлан),
	             |	СУММА(КоличествоПлан),
	             |	СУММА(СуммаПлан),
	             |	СУММА(КоличествоПрошлыйМесяц),
	             |	СУММА(СуммаПрошлыйМесяц),
	             |	СУММА(КоличествоПрошлыйГод),
	             |	СУММА(СуммаПрошлыйГод),
	             |	СУММА(Вес),
	             |	СУММА(KPI)
	             |ПО
	             |	ОБЩИЕ,
	             |	НаправлениеПродаж,
	             |	Менеджер,
	             |	ТоварнаяГруппа ИЕРАРХИЯ
	             |АВТОУПОРЯДОЧИВАНИЕ";
				 
				 Запрос.УстановитьПараметр("МесяцПланирования", НачалоПериода);
				 Запрос.УстановитьПараметр("НачПериодаПрошлогоМесяца", ДобавитьМесяц(НачалоПериода,-1));
				 Запрос.УстановитьПараметр("КонПериодаПрошлогоМесяца", ДобавитьМесяц(КонецМесяца(НачалоПериода),-1));
				 Запрос.УстановитьПараметр("НачПрошлогоПериода", ДобавитьМесяц(НачалоПериода,-12));
				 Запрос.УстановитьПараметр("КонПрошлогоПериода", ДобавитьМесяц(КонецМесяца(НачалоПериода),-12));
				 Запрос.УстановитьПараметр("НаправлениеПродаж",НаправлениеПродаж);
	             Запрос.УстановитьПараметр("СписокИсключаемыхКонтрагентов", СписокИсключаемыхКонтрагентов);
	
	Результат = Запрос.Выполнить();
	
	Элементыформы.ПланированиеНОПоМенеджерамНсколькоПодразделений.Значение = Результат.Выгрузить(ОбходРезультатаЗапроса.ПоГруппировкамСИерархией);
	// Вставить содержимое обработчика.
КонецПроцедуры

Процедура ПланированиеНООТРДПНесколькоПодразделенийПриАктивизацииЯчейки(Элемент)
	Если Элемент.ТекущиеДанные<>неопределено тогда
		ЭлементыФормы.тТекущееНаправление.Значение = Элемент.ТекущиеДанные.НаправлениеПродаж;
		ТекущееНаправлениеПродаж = Элемент.ТекущиеДанные.НаправлениеПродаж;
	КонецЕсли;
	к=1;
КонецПроцедуры

Процедура ПланированиеНОПоМенеджерамНсколькоПодразделенийПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель)
	//Если значениеЗаполнено(ТекущееНаправлениеПродаж) тогда
	//	Элемент.ТекущиеДанные.НаправлениеПродаж = ТекущееНаправлениеПродаж;
	//	к=1;
	//КонецЕсли;
КонецПроцедуры

Процедура ПланированиеНОПоМенеджерамНсколькоПодразделенийПередНачаломИзменения(Элемент, Отказ)
	к=1;
КонецПроцедуры


СписокИсключаемыхКонтрагентов = новый СписокЗначений;
СписокИсключаемыхКонтрагентов.Добавить(Справочники.Контрагенты.НайтиПоКоду("П001549"));  //ШинТрейд (Питер)
к=0;