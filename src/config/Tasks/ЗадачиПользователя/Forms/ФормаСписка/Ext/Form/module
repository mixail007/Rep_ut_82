////////////////////////////////////////////////////////////////////////////////
//СЕРВИСНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ


// Процедура управляет отображением списка задач:
// устанавлмивает отбор только активных задач или сбрасывает этот отбор.
//
Процедура УстановитьОтборАктивных(ТолькоАктивные)

	Если ТолькоАктивные Тогда

		ЭтаФорма.Отбор.Выполнена.Установить(Ложь);
  		ЭтаФорма.Отбор.ПометкаУдаления.Установить(Ложь); // удаленные - как выполненные!

	Иначе //выключается отбор!
		ЭтаФорма.Отбор.Выполнена.Использование = Ложь;
  		ЭтаФорма.Отбор.ПометкаУдаления.Использование = Ложь;
	КонецЕсли;

КонецПроцедуры // УстановитьОтборАктивных()


////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ

// Процедура обработчик события "ПриПолученииДанных".
//
Процедура ЗадачаСписокПриПолученииДанных(Элемент, ОформленияСтрок)
	
	СтрокаПоздравления = "Поздравить с Днём рождения";

Для Каждого ОформлениеСтроки Из ОформленияСтрок Цикл

	Если НЕ ОформлениеСтроки.ДанныеСтроки.Выполнена Тогда
			
		Если ОформлениеСтроки.ДанныеСтроки.Ссылка.СрокИсполнения<ТекущаяДата()
			и ОформлениеСтроки.ДанныеСтроки.Ссылка.СрокИсполнения<>'00010101' Тогда
			ОформлениеСтроки.ЦветТекста = WebЦвета.Красный; //задача Просрочена !
		КонецЕсли;	
	
	Иначе	//задача выполнена
			
		ОформлениеСтроки.ЦветТекста = ЦветаСтиля.ТекстВторостепеннойНадписи;//цвет выполненной задачи
		
		Если ОформлениеСтроки.ДанныеСтроки.Ссылка.ДатаИсполнения>ОформлениеСтроки.ДанныеСтроки.Ссылка.СрокИсполнения
			и ОформлениеСтроки.ДанныеСтроки.Ссылка.ДатаИсполнения<>'00010101' Тогда
			ОформлениеСтроки.ЦветТекста = WebЦвета.ТемноКрасный; //выполнена, но была просрочена задача!
		КонецЕсли;
		
	КонецЕсли;
	
//---------------------картинки-----------------------------------------------------------		
	ОформлениеСтроки.Ячейки.Картинка.ОтображатьФлажок   = Ложь;
	ОформлениеСтроки.Ячейки.Картинка.ОтображатьКартинку = Истина;
	
	Если ОформлениеСтроки.ДанныеСтроки.Ссылка.ПометкаУдаления тогда //22.10.2015
		ОформлениеСтроки.ЦветТекста = WebЦвета.СветлоСерый;
	КонецЕсли;
	
	Если ОформлениеСтроки.ДанныеСтроки.Ссылка.Выполнена Тогда
		ОформлениеСтроки.ЦветФона = WebЦвета.СветлоСерый;           //22.10.2015
		
		Если ОформлениеСтроки.ДанныеСтроки.Ссылка.ПамятнаяДата Тогда 
			ОформлениеСтроки.Ячейки.Картинка.ИндексКартинки = 7;
		Иначе
			ОформлениеСтроки.Ячейки.Картинка.ИндексКартинки = 6;
		КонецЕсли;
	
	Иначе // не выполнена
	
		Если ОформлениеСтроки.ДанныеСтроки.Ссылка.ПамятнаяДата Тогда
			ОформлениеСтроки.Ячейки.Картинка.ИндексКартинки = 1;
		Иначе
			ОформлениеСтроки.Ячейки.Картинка.ИндексКартинки = 0;
		КонецЕсли;
		
		Если ОформлениеСтроки.ДанныеСтроки.Ссылка.Оповещение Тогда
 			Если ОформлениеСтроки.ДанныеСтроки.Ссылка.СрокОповещения < ТекущаяДата() Тогда
			
				Если ОформлениеСтроки.ДанныеСтроки.Ссылка.ПамятнаяДата Тогда
					ОформлениеСтроки.Ячейки.Картинка.ИндексКартинки = 3;
				Иначе
					ОформлениеСтроки.Ячейки.Картинка.ИндексКартинки = 2;
				КонецЕсли;
			
			Иначе
			
				Если ОформлениеСтроки.ДанныеСтроки.Ссылка.ПамятнаяДата Тогда
					ОформлениеСтроки.Ячейки.Картинка.ИндексКартинки = 5;
				Иначе
					ОформлениеСтроки.Ячейки.Картинка.ИндексКартинки = 4;
				КонецЕсли;
			
			КонецЕсли;
	 	КонецЕсли;

	КонецЕсли;
		
КонецЦикла;

КонецПроцедуры // ЗадачаСписокПриПолученииДанных()


// Процедура обработчик действия элемента панели "ОтборАктивных".
//
Процедура ДействияФормыОтборАктивных(Кнопка)

	УстановитьОтборАктивных(Не Кнопка.Пометка);
	Кнопка.Пометка = Не Кнопка.Пометка;

КонецПроцедуры // ДействияФормыОтборАктивных()

//+++
// Процедура обработчик действия элемента панели "КартаМаршрута".
//
//Процедура ДействияФормыКартаМаршрута(Кнопка)

//	ТекущиеДанные = ЭлементыФормы.ЗадачаСписок.ТекущиеДанные;
//	Если Не ТекущиеДанные = Неопределено Тогда

//		Если ЗначениеЗаполнено(ТекущиеДанные.Ссылка.БизнесПроцесс) Тогда

//			РаботаСБизнесПроцессами.ОткрытьКартумаршрута(ТекущиеДанные.Ссылка.БизнесПроцесс);

//		КонецЕсли;

//	КонецЕсли;

//КонецПроцедуры // ДействияФормыКартаМаршрута()

Процедура ПриОткрытии()
	
	Если РольДоступна("яштФинДиректор") тогда    //27.10.2015 - для Малышев И.И. - видны все задачи сразу!
		Отбор.Исполнитель.Использование = ЛОЖЬ;
		ЭлементыФормы.ДействияФормы.Кнопки.ОтборПоставленных.Пометка = ложь;
	Иначе
		Отбор.Исполнитель.ВидСравнения = ВидСравнения.Равно;
		Отбор.Исполнитель.Значение = глТекущийПользователь;
		Отбор.Исполнитель.Использование = истина;
		ЭлементыФормы.ДействияФормы.Кнопки.ОтборПоставленных.Пометка = истина;
	КонецЕсли;
	
	//+++ только свои задачи - всегда! +++
	Если не ( РольДоступна("ПолныеПрава") или РольДоступна("МенеджерПоЗакупкам") 
		    или РольДоступна("яштФинДиректор")  ) тогда    //27.10.2015 - для Малышев И.И. - видны все задачи
		ЭлементыФормы.ЗадачаСписок.НастройкаОтбора["Исполнитель"].Доступность = Ложь;
		ЭлементыФормы.ДействияФормы.Кнопки.ОтборПоставленных.Доступность = ЛОЖЬ;
	КонецЕсли;

	УстановитьОтборАктивных(истина); // только активные!
	
КонецПроцедуры

Процедура ДействияФормыОтборПоставленных(Кнопка)
	
	Если ЭлементыФормы.ДействияФормы.Кнопки.ОтборПоставленных.Пометка тогда
		
		//только другим!
		ЭтаФорма.Отбор.Исполнитель.ВидСравнения  = ВидСравнения.НЕРавно;
		ЭтаФорма.Отбор.Исполнитель.Значение      = ПараметрыСеанса.ТекущийПользователь;
		ЭтаФорма.Отбор.Исполнитель.Использование = Истина;
        		
		Отбор.Инициатор.ВидСравнения = ВидСравнения.Равно;
		Отбор.Инициатор.Значение = глТекущийПользователь;
		Отбор.Инициатор.Использование = истина;
		ЭлементыФормы.ДействияФормы.Кнопки.ОтборПоставленных.Пометка = ЛОЖЬ;
		
	Иначе
		Отбор.Инициатор.Использование = ложь;
		
		Отбор.Исполнитель.ВидСравнения = ВидСравнения.Равно;
		Отбор.Исполнитель.Значение = глТекущийПользователь;
		Отбор.Исполнитель.Использование = истина;
		ЭлементыФормы.ДействияФормы.Кнопки.ОтборПоставленных.Пометка = истина;
	КонецЕсли;	
	
КонецПроцедуры

Процедура ДействияФормыДействие13(Кнопка)
	задачи.ЗадачиПользователя.ПолучитьФорму("РабочаяФормаСпискаЗадачПользователя").Открыть();
КонецПроцедуры

Процедура ЗадачаСписокПередУдалением(Элемент, Отказ)
	текСтрока = ЭлементыФормы.ЗадачаСписок.ТекущиеДанные;
	Если текСтрока<>неопределено 
	   и Найти(текСтрока.Наименование, "ПДЗ по контрагентам") > 0 тогда
		Отказ = Истина;	
	КонецЕсли;
КонецПроцедуры
