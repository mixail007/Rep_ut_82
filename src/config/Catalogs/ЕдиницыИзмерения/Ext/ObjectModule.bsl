// Функция проверяет, существуют ли ссылки на единицу измерения в движениях регистров накопления.
// Если есть - нельзя менять коэффицент
//
// Параметры:
//  Нет.
//
// Возвращаемое значение:
//  Истина - если есть движения, Ложь - если нет.
//
Функция СуществуютСсылки() Экспорт

	Запрос = Новый Запрос();

	Запрос.УстановитьПараметр("ТекущийВладелец", Владелец);

	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	РегистрНакопления.ЗаказыПокупателей.Номенклатура
	|ГДЕ
	|	Номенклатура = &ТекущийВладелец
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	РегистрНакопления.ЗаказыПоставщикам.Номенклатура
	|ГДЕ
	|	Номенклатура = &ТекущийВладелец
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	РегистрНакопления.ПартииТоваровНаСкладах.Номенклатура
	|ГДЕ
	|	Номенклатура = &ТекущийВладелец
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	РегистрНакопления.ПартииТоваровПереданные.Номенклатура
	|ГДЕ
	|	Номенклатура = &ТекущийВладелец
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	 РегистрНакопления.ПланыЗакупок.Номенклатура
	|ГДЕ
	|	Номенклатура = &ТекущийВладелец
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	РегистрНакопления.ПланыПродаж.Номенклатура
	|ГДЕ
	|	Номенклатура = &ТекущийВладелец
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	РегистрНакопления.Продажи.Номенклатура
	|ГДЕ
	|	Номенклатура = &ТекущийВладелец
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	РегистрНакопления.ПродажиСебестоимость.Номенклатура
	|ГДЕ
	|	Номенклатура = &ТекущийВладелец
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	РегистрНакопления.ТоварыВРезервеНаСкладах.Номенклатура
	|ГДЕ
	|	Номенклатура = &ТекущийВладелец
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	РегистрНакопления.ТоварыКПередачеСоСкладов.Номенклатура
	|ГДЕ
	|	Номенклатура = &ТекущийВладелец
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	РегистрНакопления.ТоварыКПолучениюНаСклады.Номенклатура
	|ГДЕ
	|	Номенклатура = &ТекущийВладелец
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	РегистрНакопления.ТоварыПолученные.Номенклатура
	|ГДЕ
	|	Номенклатура = &ТекущийВладелец
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	РегистрНакопления.ТоварыВНеавтоматизированныхТорговыхТочках.Номенклатура
	|ГДЕ
	|	Номенклатура = &ТекущийВладелец";

	Возврат НЕ Запрос.Выполнить().Пустой();

КонецФункции //  СуществуютСсылки()

// Обработчик события ПередЗаписью .
//
Процедура ПередЗаписью(Отказ)

	Если НЕ ОбменДанными.Загрузка 
	   И ТипЗнч(Владелец) = Тип("СправочникСсылка.Номенклатура") Тогда
		Если Владелец.ЕдиницаХраненияОстатков = Ссылка Тогда

			Запрос = Новый Запрос;
			Запрос.УстановитьПараметр("ТекущийЭлемент", ЭтотОбъект.Ссылка);

			Запрос.Текст =
			"ВЫБРАТЬ
			|	ЕдиницыИзмерения.Ссылка КАК Элемент,
			|	ЕдиницыИзмерения.Коэффициент КАК Коэффициент
			|ИЗ
			|	Справочник.ЕдиницыИзмерения КАК ЕдиницыИзмерения
			|
			|ГДЕ
			|	ЕдиницыИзмерения.Ссылка = &ТекущийЭлемент";

			Выборка = Запрос.Выполнить().Выбрать();

			Если Выборка.Следующий() Тогда
				Если Выборка.Коэффициент <> Коэффициент Тогда
					Если СуществуютСсылки() Тогда
						СообщитьОбОшибке("Единица """ + Наименование + """ является единицей хранения остатков для """ + Владелец.Наименование + """ и уже участвует в товародвижении. Изменить коэффициент уже нельзя!", Отказ);
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;

		КонецЕсли;
	КонецЕсли;

	Если Не ОбменДанными.Загрузка 
	   И Не Отказ 
	   И Коэффициент = 0 Тогда
		СообщитьОбОшибке("Для "+СокрЛП(Владелец)+" у единицы измерения "+СокрЛП(Ссылка)+" не задан коэффициент! Он будет установлен равным 1.");
		Коэффициент = 1;
	КонецЕсли;
	
	// пока запрещено создавать единицы с коэффициентом отличным от "1"
	Если Не ОбменДанными.Загрузка 
	   И Не Отказ 
	   И Коэффициент <> 1 Тогда
		СообщитьОбОшибке("Для "+СокрЛП(Владелец)+" у единицы измерения "+СокрЛП(Ссылка)+" коэффициент не равен единице!", Отказ);
	КонецЕсли;
	
	// Если вес не заполнен, тогда попробуем найти его
	Если Не ОбменДанными.Загрузка 
		И Не Отказ 
		И Вес = 0 и не ЭтотОбъект.Владелец.ПринадлежитЭлементу(Справочники.Номенклатура.ЛокальнаяНоменклатура) Тогда
		
		Запрос=Новый Запрос;
		Запрос.Текст="ВЫБРАТЬ
		|	НормыЗагрузки.Ссылка,
		|	НормыЗагрузки.Вес
		|ИЗ
		|	Справочник.НормыЗагрузки КАК НормыЗагрузки
		|ГДЕ
		|	НормыЗагрузки.Типоразмер = &Типоразмер";
		
		Запрос.УстановитьПараметр("Типоразмер",Владелец.Типоразмер.Ссылка);			 
		Выборка=Запрос.Выполнить().Выбрать();
		Если Выборка.Следующий() Тогда
			Если ЗначениеЗаполнено(Выборка.Вес) Тогда
				Вес=Выборка.Вес;
			КонецЕсли;
		КонецЕсли;
		
	КонецЕсли;
	
	// Если объем не заполнен, тогда попробуем найти его
	Если Не ОбменДанными.Загрузка 
		И Не Отказ 
		И объем = 0 Тогда
		
		об = ВычислитьОбъемНоменклатуры(Владелец, 3);
		если объем>0 тогда
			Объем = об;
		КонецЕсли;	
		
	КонецЕсли;
	
	// ОС и НМА
	
	Если Не ОбменДанными.Загрузка И ТипЗнч(Владелец) = Тип("СправочникСсылка.Номенклатура") Тогда
		
		ПроверитьРегистрацию(Владелец, ЭтотОбъект);	
		
	КонецЕсли;
	
	// ОС и НМА	
	
	Если НЕ Отказ Тогда
	
		обЗаписатьПротоколИзменений(ЭтотОбъект);
	
	КонецЕсли; 

КонецПроцедуры // ПередЗаписью()

