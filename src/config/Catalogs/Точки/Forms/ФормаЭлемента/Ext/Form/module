
Процедура СогласованПриИзменении(Элемент)
	
	//Если Согласован и не ЗначениеЗаполнено(ВидАдреса) тогда
	//	Сообщить("Что бы согласовать адрес обязательно заполните поле ""Вид адреса""!!!");
	//	Согласован = Ложь;
	//Иначе
	Если Согласован Тогда
		Если сокрЛП(Координаты)="" тогда
			Адрес2 = ОбработатьАдрес(Адрес,3,7);
			Координаты = ОбменСУТИнтернетМагазин.получитьКоординаты(Адрес2); //новая функция google.com (ПЛАТНАЯ! не более 1000 адресов в сутки!)
		КонецЕсли;
						
		Если Координаты<>"" тогда //перезаполняем реквизиты по адресу!
			поляАдреса = ОбменСУТИнтернетМагазин.ПолучитьАдресПоКоординатам(Координаты, Истина);
			Регион = поляАдреса.Поле2;
			Город  = поляАдреса.Поле4;
			Улица  = поляАдреса.Поле6;
			Дом	   = поляАдреса.Поле7;
		иначе
			Предупреждение("Не удалось найти координаты автоматически!",10);
			URL = "https://maps.yandex.ru?text="+Адрес2;
			ЗапуститьПриложение(URL);	
		КонецЕсли;		
	
	КонецЕсли;	
	
КонецПроцедуры

Процедура КоординатыОткрытие(Элемент, СтандартнаяОбработка)
	Если Координаты<>"" тогда
		СтандартнаяОбработка = ложь;
	//	API 2.0, Static API, maps.yandex.ru
	// можно задавать параметры для онлайн карты непосредственно в адресной строке браузера, например:
	//http://maps.yandex.ru/?ll=37.584731,55.690693&spn=2.124481,0.671008&z=10&l=map&pt=37.584731,55.690693,pmrdm1
	
	запятая = найти(Координаты,",");
	Координаты2 = прав(Координаты, стрДлина(Координаты) - запятая)+","+ лев(Координаты, запятая-1);
	URL="https://www.google.ru/maps/place/"+Адрес+"/@"+Координаты2+",14z";   //14 - еще видны дома
	
	//URL= "https://maps.yandex.ru/?ll="+Координаты
	//	+"&spn=2.124481,0.671008&z=14&l=map&pt="+Координаты+",pmrdm1";
	ЗапуститьПриложение(URL);	
	КонецЕсли;
КонецПроцедуры

Процедура Флажок1ПриИзменении(Элемент)
	ФлагиВЧисло();
КонецПроцедуры

//+++ 19.04.2016 +++
процедура ФлагиВЧисло()
НаправлениеПродаж = ?(Флажок1,1,0)
				+?(Флажок2,2,0)
				+?(Флажок4,4,0)
				+?(Флажок8,8,0);
КонецПроцедуры				

//1.Wholesale
//2.Retail
//4.On-line shop
//8.End customer
процедура ЧислоВФлаги()
 Флажок8 = (Цел(НаправлениеПродаж/8)>=1);
 НаправлениеПродаж1 = НаправлениеПродаж - 8*Цел(НаправлениеПродаж/8);
 	
 Флажок4 = (Цел(НаправлениеПродаж1/4)>=1);
 НаправлениеПродаж1 = НаправлениеПродаж1 - 4*Цел(НаправлениеПродаж1/4);
 
 Флажок2 = (Цел(НаправлениеПродаж1/2)>=1);
 НаправлениеПродаж1 = НаправлениеПродаж1 - 2*Цел(НаправлениеПродаж1/2);
 
 Флажок1 = (НаправлениеПродаж1=1);
КонецПроцедуры

Процедура НаправлениеПродажПриИзменении(Элемент)
	ЧислоВФлаги()
КонецПроцедуры

Процедура НаправлениеПродажРегулирование(Элемент, Направление, СтандартнаяОбработка)
	СтандартнаяОбработка = ложь;
	Элемент.Значение =  Элемент.Значение  + Направление;
	Если Элемент.Значение>15 тогда Элемент.Значение=15
	иначеЕсли Элемент.Значение<0 тогда Элемент.Значение=0;
	КонецЕсли;
	
	ЧислоВФлаги()
КонецПроцедуры

Процедура ПриОткрытии()
	
	ЧислоВФлаги();
	
	Если КодПодразделения<=0 Тогда
		ЭлементыФормы.КодПодразделения.доступность    = ложь;
		ЭлементыФормы.ДнейДоПодразделения.доступность = ложь;
		ЭлементыФормы.НадписьКодПодразделения.доступность    = ложь;
		ЭлементыФормы.НадписьДнейДоПодразделения.доступность = ложь;
	Иначе
		ЭлементыФормы.КодПодразделения.СписокВыбора.Добавить(106, "106. Ростов-на-Дону");
		ЭлементыФормы.КодПодразделения.СписокВыбора.Добавить(112, "112. Санкт-Петербург");
		ЭлементыФормы.КодПодразделения.СписокВыбора.Добавить(138, "138. Екатеринбург");
		ЭлементыФормы.КодПодразделения.СписокВыбора.Добавить(133, "133. Москва");
	КонецЕсли;
	
КонецПроцедуры

Процедура ОсновныеДействияФормыВыгрузить(Кнопка)
	ИмяФайла = КаталогВременныхФайлов()+"point"+формат(Номер,"ЧГ=0")+".txt";
	выгрузитьТочкуВФАЙЛjson(ИмяФайла);
	// тест:  выгрузитьФайлНаТерминал(ИмяФайла, "LAPENKOV_VI", 9090 );
	выгрузитьФайлНаТерминал(ИмяФайла);
КонецПроцедуры


Процедура выгрузитьТочкуВФАЙЛjson(ИмяФайла="")
	
	Текст1 = "{PartnerPointId:"+формат(Номер,"ЧГ=0")
	           +", ContactFIO:'"+сокрЛП( стрЗаменить(КонтактноеЛицо,"'","""") )
			      +"',Address:'"+сокрЛП( стрЗаменить(Адрес,"'","""") )
			   +"',SaleDirection:"+строка(НаправлениеПродаж)
			   +",PhoneNumber:'"+сокрЛП( стрЗаменить(ИнформацияДляВодителя,"'","""") )
			   +"',WebSite:'"+сокрЛП(WebSite)
			   +"'}";
 	попытка
		ОбъектXML = Новый ТекстовыйДокумент;
		ОбъектXML.УстановитьТекст( текст1);
		ОбъектXML.Записать(ИмяФайла, "UTF-8");
		Сообщить("Данные точки № "+формат(Номер,"ЧГ=0")+" сохранены в файл: "+ИмяФайла, СтатусСообщения.Информация);
	исключение
		Сообщить("Ошибка при записи данных точки № "+формат(Номер,"ЧГ=0")+" в файл: "+ИмяФайла+"
		|"+ОписаниеОшибки(), СтатусСообщения.Внимание);
	КонецПопытки;
	
КонецПроцедуры	
	

//"http://LAPENKOV_VI:9090/api/pointsapi/updatepoint"
процедура выгрузитьФайлНаТерминал(ИмяФайла="",
	СтрокаПодключения = "terminal.yst.ru", порт = 80, ресурс = "api/pointsapi/updatepoint")
	
	Соединение = Новый HTTPСоединение(СтрокаПодключения+":"+формат(порт,"ЧГ=0"),,"admin","cegthvfhbj" );   //"http://localhost"  50876
	Если Соединение = Неопределено Тогда
		сообщить("ОШИБКА при соединении с сервером "+СтрокаПодключения+":"+формат(порт,"ЧГ=0"), СтатусСообщения.Внимание);
		Возврат;
	КонецЕсли;

	Заголовки = Новый Соответствие();
 	АдресРесурса = СтрокаПодключения+":"+формат(порт,"ЧГ=0")+ресурс;
 
   ИмяФайлаРезультата = ПолучитьИмяВременногоФайла();
   Заголовки.Вставить("HASH", "D5790E89580D8B75927F804E738CFCE");  
   Заголовки.Вставить("Content-Type","application/json"); //Content-Type
   
 HTTPОтвет = Соединение.ОтправитьДляОбработки( ИмяФайла, Ресурс, 
														ИмяФайлаРезультата, Заголовки) ;

 ТекстовыйФайлОтвет = Новый ТекстовыйДокумент;
 ТекстовыйФайлОтвет.Прочитать(ИмяФайлаРезультата, КодировкаТекста.UTF8);
 СтрокаJSONРезультат = ТекстовыйФайлОтвет.ПолучитьТекст();
 ТекстовыйФайлОтвет = неопределено; // отключается от файла
 
 сообщить("Статус ответа: "+строка(HTTPОтвет.КодСостояния)+" Ответ сервера: '"+СтрокаJSONРезультат+"'" );
	
КонецПроцедуры

Процедура ТемаПриИзменении(Элемент)
	Дата = ТекущаяДата();
КонецПроцедуры

Процедура WebSiteОткрытие(Элемент, СтандартнаяОбработка)
	Если WebSite<>"" тогда
	СтандартнаяОбработка = ложь;
		Если Найти(WebSite,"http://")=0 тогда
			WebSite = "http://"+WebSite;
		КонецЕсли;
		ЗапуститьПриложение( WebSite );
	КонецЕсли;	
КонецПроцедуры

Процедура ПолеВвода1НачалоВыбора(Элемент, СтандартнаяОбработка)
	СтандартнаяОбработка = Ложь;
	
	ФормаВыбора = РегистрыСведений.КонтактнаяИнформация.ПолучитьФормуСписка("ФормаСпискаДоп", ЭтаФорма);
	ФормаВыбора.РежимВыбора = Истина;
	
	ФормаВыбора.РегистрСведенийСписок.Отбор.Объект.Значение = Владелец;
	ФормаВыбора.РегистрСведенийСписок.Отбор.Объект.Использование = Истина;
	
	СтруктураОтбораАдресов = Новый СписокЗначений;
	СтруктураОтбораАдресов.Добавить(Перечисления.ТипыКонтактнойИнформации.Адрес);
	ФормаВыбора.РегистрСведенийСписок.Отбор.Тип.ВидСравнения = ВидСравнения.ВСписке;
	ФормаВыбора.РегистрСведенийСписок.Отбор.Тип.Значение = СтруктураОтбораАдресов;
	ФормаВыбора.РегистрСведенийСписок.Отбор.Тип.Использование = Истина;
	ФормаВыбора.ЭлементыФормы.РегистрСведенийСписок.Колонки.Тип.Видимость = Ложь;
	
	Ответ = ФормаВыбора.ОткрытьМодально();
	
	Если Ответ <> Неопределено Тогда		
		
		Координаты = Ответ.Координаты;
		Согласован = (Координаты<>"");
		
		ВидАдреса = Ответ.ВидАдреса;
		ЗаполнитьПоляПоВиду(); //03.07.2017
		
	КонецЕсли;
	
КонецПроцедуры

//03.07.2017
Процедура ЗаполнитьПоляПоВиду()
	 Запрос1 = Новый Запрос;
	 Запрос1.Текст = "ВЫБРАТЬ
	                 |	КонтактнаяИнформация.Представление КАК Адрес,
	                 |	КонтактнаяИнформация.Поле2 КАК Регион,
	                 |	КонтактнаяИнформация.Поле4 КАК Город,
	                 |	КонтактнаяИнформация.Поле5 КАК Село,
	                 |	КонтактнаяИнформация.Поле6 КАК Улица,
	                 |	КонтактнаяИнформация.Поле7 КАК Дом,
	                 |	КонтактнаяИнформация.Комментарий
	                 |ИЗ
	                 |	РегистрСведений.КонтактнаяИнформация КАК КонтактнаяИнформация
	                 |ГДЕ
	                 |	КонтактнаяИнформация.Объект = &Объект
	                 |	И КонтактнаяИнформация.Тип = &Тип
	                 |	И КонтактнаяИнформация.Вид = &Вид";
	 
	 Запрос1.УстановитьПараметр("Объект", Владелец);
	 Запрос1.УстановитьПараметр("Тип", перечисления.ТипыКонтактнойИнформации.Адрес);
	 Запрос1.УстановитьПараметр("Вид", ВидАдреса);
	 
	 Результат1 = Запрос1.Выполнить();
	 Если не Результат1.Пустой() тогда
		 Выборка = Результат1.Выбрать();
		 Выборка.Следующий();
		 ЗаполнитьЗначенияСвойств( ЭтотОбъект, Выборка);
		 
		 Адрес = Выборка.Адрес + " ~ " + Выборка.Комментарий;  
		 
		 Если выборка.Город="" тогда 
			 Город = выборка.Село;
		 КонецЕсли;	
		 
		 Если выборка.Регион="МО" тогда
			 выборка.Регион="Московская обл";
		 КонецЕсли;
		 
		 Если Найти(выборка.Регион, "Москва")>0 тогда
			 Город = "Москва г";
		 ИначеЕсли Найти(выборка.Регион, "Санкт-Петербург")>0 тогда
			 Город = "Санкт-Петербург г";
		 ИначеЕсли Найти(выборка.Регион, "Севастополь")>0 тогда
			 Город = "Севастополь г";
		 КонецЕсли;	 
	 КонецЕсли;
		 
КонецПроцедуры

Процедура ПолеВвода1ПриИзменении(Элемент)
	Если ВидАдреса = Справочники.ВидыКонтактнойИнформации.ПустаяСсылка() Тогда
		Согласован = Ложь;
	КонецЕсли;
КонецПроцедуры

Процедура Кнопка1Нажатие(Элемент)
	
	Форма = ПолучитьФормуВнешнейОбработки(601);  // Определение Адреса по Карте Google
	Форма.ТекАдрес = Адрес;
	
	Форма.ОткрытьМОДАЛЬНО();
	
	Адрес = Форма.ТекАдрес;
	Если Форма.ТаблицаАдресов.Количество()>0 тогда
	Координаты = формат(Форма.ТаблицаАдресов[0].Долгота,"ЧРД=.")+","+формат(Форма.ТаблицаАдресов[0].Широта,"ЧРД=.");
	Согласован = истина;
	КонецЕсли;

КонецПроцедуры

//==========ОБЩАЯ ПРОЦЕДУРА ДЛЯ ЛЮБОЙ ВНЕШНЕЙ ОБРАБОТКИ или ОТЧЕТА!===========================
функция ПолучитьФормуВнешнейОбработки(номерВнОбр=44, имяФормы="", ЭтоОбработка=Истина)
	
	//ИмяФайла = КаталогВременныхФайлов()+"ВнешнийОтчет.epf";
	ИмяФайла = ПолучитьИмяВременногоФайла();
	
	файл = новый файл(ИмяФайла);
//	Если НЕ Файл.Существует() тогда
		обр = справочники.ВнешниеОбработки.НайтиПоКоду(номерВнОбр); // разбор на ГТД
		ДвоичныеДанные = обр.ХранилищеВнешнейОбработки.Получить();
		ДвоичныеДанные.Записать(ИмяФайла);
//		сообщить(строка(ТекущаяДата())+"Записан файл обработки: "+ИмяФайла);
//	КонецЕсли;
	
	
    Если ЭтоОбработка Тогда
		Обработка = ВнешниеОбработки.Создать(ИмяФайла);
	Иначе
		Обработка = ВнешниеОтчеты.Создать(ИмяФайла);
	КонецЕсли;
			
	Если имяФормы="" тогда //19.08.2016 по умолчанию для любой обработки или отчета - названия НЕ надо!
		Форма = Обработка.ПолучитьФорму();
	иначе
		Форма = Обработка.ПолучитьФорму(имяФормы);
	КонецЕсли;
	
возврат Форма;
	
КонецФункции

Процедура УтвержденаПриИзменении(Элемент)
	
	Если  Утверждено тогда
		//Проверка обязательных полей
		масОбязательныхПолей = новый Массив;
		масОбязательныхПолей.Добавить("НазваниеТочки");
		масОбязательныхПолей.Добавить("Адрес");
		масОбязательныхПолей.Добавить("ИнформацияДляВодителя");
		масОбязательныхПолей.Добавить("КонтактноеЛицо");
		масОбязательныхПолей.Добавить("Координаты");
		масОбязательныхПолей.Добавить("Регион");
		масОбязательныхПолей.Добавить("Город");
		
		для i=0 по масОбязательныхПолей.Количество()-1 цикл
			Если СокрЛП( ЭтотОбъект[масОбязательныхПолей[i]] )="" тогда
			Предупреждение("Поле '"+масОбязательныхПолей[i]+"' - не заполнено!", 10);
			Утверждено=ложь;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;

	Если Утверждено тогда
		Менеджер  = глТекущийПользователь;
		Компьютер = ИмяКомпьютера();
	Иначе
		Менеджер  = справочники.Пользователи.ПустаяСсылка();
		Компьютер = "";
	КонецЕсли;

КонецПроцедуры

//автоутверждение при наличие всех обязательных полей
Процедура ПередЗаписью(Отказ)
	Утверждено = истина;
	УтвержденаПриИзменении(неопределено);
КонецПроцедуры
