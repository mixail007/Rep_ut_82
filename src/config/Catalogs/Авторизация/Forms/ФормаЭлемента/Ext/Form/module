
Процедура ПарольНачалоВыбора(Элемент, СтандартнаяОбработка)
	СтандартнаяОбработка = ложь;
	Пароль = СлучайныйНабор();
КонецПроцедуры

Процедура ПередЗаписью(Отказ) экспорт
	
	Если этотобъект.ПометкаУдаления тогда 
		Возврат;  //никаких проверок не надо!
	КонецЕсли;

 	//----------Выгрузка в Store и Terminal (если есть логин или пароль И они не были установлены ранее)-----------------------------------  
	Если (этотобъект.Логин<>"") и (этотобъект.Пароль="") тогда //10.01.2019		
		
	    сКод = формат(Код,"ЧГ=0");
		Если ЭтотОбъект.Владелец.Пустая() тогда 
			Предупреждение("Не заполнен Контрагент!", 30);
			Отказ = Истина;
			возврат;
		ИначеЕсли Найти(Логин,"Client")=0 или Найти(Логин,сКод)=0 тогда 
			Логин = "Client"+сКод;
			Сообщить("Логин автоматически изменен на "+Логин, СтатусСообщения.Информация);
		КонецЕсли;	
		
		ДатаСоздания = ?(ДатаСоздания='00010101',ТекущаяДата(),ДатаСоздания);
		
	//1. создание XML файла		
		ИмяФайла = КаталогВременныхФайлов()+"user1.xml";
		выгрузитьПользователяВФайл( ИмяФайла );
		  
	//----------------------с 28.01.2016 запущена Выгрузка в Terminal--------------------------
	  СтрокаПодключения="terminal.yst.ru"; //БЕЗ порта!
	  
	  рез2 = ВыгрузитьНаСервер(ИмяФайла, СтрокаПодключения, Истина);  //удалить файл после выгрузки
	  Отказ = ОбработатьРезультатВыгрузки(рез2, СтрокаПодключения);
	  
	  Если не Отказ тогда //получаем пароль из ответа
		Пароль0 = Пароль;
		с1="""password"":"""; 
		л1=стрДлина(с1); 
		п1=найти(рез2, с1); // рез2 = что-то тат "password":"... 
		рез3 = Прав(рез2, стрДлина(рез2)-п1-л1+1); // начинается с пароля!  +++ 13.03.2019
		
		с3 = """"; // до первой кавычки """" или "}" !
		п3= найти(рез3, с3);  //1+10  17-11
  
		Если п3>1 тогда
	   	   Пароль = лев(рез3, п3-1 ); // "password":"123zxc"
		   Сообщить("Получен пароль для входа: "+Пароль+" для клиента: "+строка(ЭтотОбъект.Владелец), СтатусСообщения.Информация);
		   
	    Иначе//+++ 06.03.2019 - пароль пустой!
		   Пароль = "";
		   Отказ = Истина;
		   Сообщить("Ошибка при создании учетной записи! Пароль не получен! Обратитесь в IT-отдел!", СтатусСообщения.Важное);
		   
	    КонецЕсли;
	  КонецЕсли;
	  
	КонецЕсли;

КонецПроцедуры


//==================вспомогательные функции===================
функция КлиентРаспродажа()
	СвойствоРаспродажи = ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоКоду("90183"); //Цены распродажи
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
	            |	ЗначенияСвойствОбъектов.Объект КАК Контрагент
	            |ИЗ
	            |	РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
	            |ГДЕ
	            |	ЗначенияСвойствОбъектов.Свойство = &Свойство
	            |	И ЗначенияСвойствОбъектов.Значение = ИСТИНА
	            |	И ЗначенияСвойствОбъектов.Объект = &Объект";

	Запрос.УстановитьПараметр("Объект", ЭтотОбъект.Владелец); //+++ не ссылка!
	Запрос.УстановитьПараметр("Свойство", СвойствоРаспродажи);

	Результат = Запрос.Выполнить();
	рез = НЕ Результат.Пустой();//так правильнее
	Возврат рез; 
КонецФункции	 

функция ПолучитьКонтЛицо(Контр)
	рез = "";
	Запрос = новый Запрос;
	Запрос.УстановитьПараметр("ОбъектВладелец", Контр);
	Запрос.Текст = "ВЫБРАТЬ
	               |	КонтактныеЛица.Наименование
	               |ИЗ
	               |	Справочник.КонтактныеЛица КАК КонтактныеЛица
	               |ГДЕ
	               |	КонтактныеЛица.ОбъектВладелец = &ОбъектВладелец
	               |	И НЕ КонтактныеЛица.ПометкаУдаления
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	КонтактныеЛица.ВидКонтактногоЛица";
	РезультатЗапроса = Запрос.Выполнить();
	выборка = РезультатЗапроса.выбрать();
	Если выборка.Следующий() Тогда
		рез = сокрЛП( выборка.Наименование );
	КонецЕсли;
возврат рез;	
КонецФункции


процедура выгрузитьПользователяВФайл(имяФайла)
	
	Контр = ЭтотОбъект.Владелец; //10.01.2019
	
	инфоКонтр = СведенияОЮрФизЛице( Контр, ТекущаяДата() );
	КонтактЛицо = ПолучитьКонтЛицо( Контр );
	Культура  = ?(Контр.Экспорт И Контр.основнойДоговорКонтрагента.ВалютаВзаиморасчетов.Код<>"643", "en-US", "");
							
	текст1 = "<Partner xmlns:i=""http://www.w3.org/2001/XMLSchema-instance"">
    |<PartnerId>"+СокрЛП(Контр.Код)+"</PartnerId>
	|<Name>"+СокрЛП(Контр.Наименование)+"</Name> 
    |<FullName>"+СокрЛП(Контр.НаименованиеПолное)+"</FullName> 
	
	|<ContactFIO>"+КонтактЛицо+"</ContactFIO> 
	|<Address>"+инфоКонтр.ЮридическийАдрес+"</Address> 
    |<PhoneNumber>"+инфоКонтр.Телефоны+"</PhoneNumber> 
	
    |<INN>"+СокрЛП(Контр.ИНН)+"</INN> 
    |<KPP>"+СокрЛП(Контр.КПП)+"</KPP>
	
	//+++ 09.09.2015 GUID после кпп
	|<Guid>"+СокрЛП(Контр.УникальныйИдентификатор())+"</Guid>"
	//01.02.2016
	+?(Культура<>"" или КлиентРаспродажа(),"
	|<SALE>1</SALE>", "")
	+?(Культура="","", "
	|<Culture>"+Культура+"</Culture>")+"
	|</Partner>";
	
	//текст1 = стрЗаменить(текст1, """", "&quot;");  //  " заменяется на  &quot;
	//текст1 = стрЗаменить(текст1, "'", "&apos;");  //   ' заменяется на  &apos;
		
	ОбъектXML = Новый ТекстовыйДокумент;
	ОбъектXML.УстановитьТекст( текст1);
	ОбъектXML.Записать(ИмяФайла, "UTF-8");
	
КонецПроцедуры	

Функция ВыгрузитьНаСервер(ИмяФайла="", СтрокаПодключения="terminal.yst.ru", УдалятьВременныеФайлы=ЛОЖЬ)
	
//---------------соединение с сервером---------------------------
Попытка
	login="admin"; password="cegthvfhbj";
	Соединение = Новый HTTPСоединение(СтрокаПодключения, ,login, password, , ЛОЖЬ);    //+++ 15.08.2017  https, SSL!  с 16.03.2018 ВЫКЛЮЧЕН

	Если Соединение = Неопределено Тогда
		Возврат "- Соединение с сервером: "+СтрокаПодключения+" - не установлено!";
	КонецЕсли;

//----------------------------------------------------------------
ресурс= "api/partnerapi/create";	
user  = ЭтотОбъект;
Ресурс1 = Ресурс+"?username="+СокрЛП(user.Логин)+"&password="+user.Пароль;
ИмяФайлаРезультата = КаталогВременныхФайлов()+"json1.xml";

Заголовки = Новый Соответствие();
//Если найти(Ресурс,"create")>0 тогда
   Заголовки.Вставить("HASH", "D5790E89580D8B75927F804E738CFCE");  
   Заголовки.Вставить("Content-Type", "text/xml");  
//КонецЕсли;

		HTTPОтвет = Соединение.ОтправитьДляОбработки( ИмяФайла, Ресурс1, 
														ИмяФайлаРезультата, Заголовки) ;

 Соединение = Неопределено; // разорвать соединение

 ТекстовыйФайлОтвет = Новый ТекстовыйДокумент;
 ТекстовыйФайлОтвет.Прочитать(ИмяФайлаРезультата, КодировкаТекста.UTF8);
 СтрокаJSONРезультат = ТекстовыйФайлОтвет.ПолучитьТекст();
 ТекстовыйФайлОтвет = неопределено; // отключается от файла
 
РезТекст = "Статус ответа: "+строка(HTTPОтвет.КодСостояния)+" Ответ сервера: '"+СтрокаJSONРезультат+"'";

Если HTTPОтвет.КодСостояния = 200 тогда
	рез = Истина;
Иначе
	рез = ЛОЖЬ;
КонецЕсли;

//--------------------Удаляем временные файлы-------------------------
Если УдалятьВременныеФайлы тогда
	файл = новый ФАЙЛ(ИмяФайла);
	если файл.Существует() тогда
		путь = файл.Путь;
		УдалитьФайлы(путь, файл.Имя);
		РезТекст = РезТекст + "удален файл данных XML "+ИмяФайла;
	КонецЕсли;
	файл = новый ФАЙЛ(ИмяФайлаРезультата);
	если файл.Существует() тогда
		путь = файл.Путь;
		УдалитьФайлы(путь, файл.Имя);
		РезТекст = РезТекст + "удален файл ответа XML "+ИмяФайлаРезультата;
	КонецЕсли;
КонецЕсли;


исключение
	рез = ложь;
	РезТекст = "Ошибка : "+ОписаниеОшибки();
КонецПопытки;

рез1 =  ?(рез,"+","- ")+РезТекст; //флаг ошибка в 1-ом символе!
возврат рез1;

КонецФункции

функция ОбработатьРезультатВыгрузки(рез1, СтрокаПодключения)
	
Отказ1 = Истина; // запрет на всё!
с1="password";	
с2="exist";
	Если лев(рез1,1)="-" тогда  //+++ 06.03.2019
	    сообщить("ОШИБКА "+рез1, СтатусСообщения.Важное);
		Отказ1 = Истина;
		
	ИначеЕсли Найти(рез1,с1)>0 тогда // только если есть пароль
	    сообщить("Получен ответ от "+СтрокаПодключения+"  -> "+Логин+" "+рез1, СтатусСообщения.Информация);
 		Отказ1 = ЛОЖЬ;
		
	ИначеЕсли Найти(рез1,с2)>0 тогда
	  	сообщить("Пользователь с таким именем: "+Логин+" уже существует в "+СтрокаПодключения, СтатусСообщения.Внимание);
		сообщить(рез1);
		Отказ1 = НЕ РольДоступна("ПравоЗавершенияРаботыПользователей"); // перезапись существующего - доступна только для IT-отдела!
				
    КонецЕсли;	  

возврат Отказ1;

КонецФункции

Процедура ПриОткрытии()
	
	Если РольДоступна("ПравоЗавершенияРаботыПользователей") тогда // IT-отделe можно всё!
		Возврат;
	КонецЕсли;	

	//ничего нельзя менять! Создание новых записей доступно только из карточки клиента!	
	ЭтаФорма.ТолькоПросмотр = Истина;
	
	//+++ 06.03.2019 - нельзя редактировать пароль никогда! он получается из terminal-а
	Этаформа.ЭлементыФормы.Пароль.ТолькоПросмотр = Истина; 

	//+++ 06.03.2019 пароль может видеть ТОЛЬКО осн.менеджер или менеджер по осн.договору
	Если НЕ (ПараметрыСеанса.ТекущийПользователь = Владелец.ОсновнойМенеджерКонтрагента
			или ПараметрыСеанса.ТекущийПользователь = Владелец.ОсновнойДоговорКонтрагента.ОтветственноеЛицо)
		тогда // вообще не видно!
		Этаформа.ЭлементыФормы.Пароль.Видимость = Ложь;
		Этаформа.ЭлементыФормы.НадписьПароль.Видимость = Ложь;
	КонецЕсли;

КонецПроцедуры


