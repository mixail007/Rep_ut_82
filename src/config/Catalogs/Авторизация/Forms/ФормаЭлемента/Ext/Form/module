
Процедура ПарольНачалоВыбора(Элемент, СтандартнаяОбработка)
	СтандартнаяОбработка = ложь;
	Пароль = СлучайныйНабор();
КонецПроцедуры

Процедура ПередЗаписью(Отказ) экспорт
	
	Если этотобъект.ПометкаУдаления тогда 
		Возврат;  //никаких проверок не надо!
	КонецЕсли;

 	//----------Выгрузка в Store и Terminal (если есть логин или пароль И они не были установлены ранее)-----------------------------------  
	Если (этотобъект.Логин<>"") и (этотобъект.Пароль="") тогда //10.01.2019		
		
	    сКод = формат(Код,"ЧГ=0");
		Если ЭтотОбъект.Владелец.Пустая() тогда 
			Предупреждение("Не заполнен Контрагент!", 30);
			Отказ = Истина;
			возврат;
		ИначеЕсли Найти(Логин,"Client")=0 или Найти(Логин,сКод)=0 тогда 
			Логин = "Client"+сКод;
			Предупреждение("Логин автоматически изменен на "+Логин, 30);
		КонецЕсли;	
		
		ДатаСоздания = ?(ДатаСоздания='00010101',ТекущаяДата(),ДатаСоздания);
		
	//1. создание XML файла		
		ИмяФайла = КаталогВременныхФайлов()+"user1.xml";
		выгрузитьПользователяВФайл( ИмяФайла );
		  
	//----------------------с 28.01.2016 запущена Выгрузка в Terminal--------------------------
	  СтрокаПодключения="terminal.yst.ru"; //БЕЗ порта!
	  рез2 = ВыгрузитьНаСервер(ИмяФайла, СтрокаПодключения, Истина);  //удалить файл после выгрузки
	  Отказ = ОбработатьРезультатВыгрузки(рез2, СтрокаПодключения);
	  
	  Если не Отказ и Найти(рез2,"exist")=0 тогда //нет такого клиента... и не отказ
	   с1="{""password"":""";л1=стрДлина(с1); с2 = """}";
	   п1=найти(рез2, с1); п2= найти(рез2, с2);  //1+10  17-11
	   Пароль = сред(рез2, п1+л1, п2-(п1+л1) ); //{password:123zxc}
	  КонецЕсли;
	  
	КонецЕсли;

КонецПроцедуры


//==================вспомогательные функции===================
функция КлиентРаспродажа()
	СвойствоРаспродажи = ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоКоду("90183"); //Цены распродажи
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
	            |	ЗначенияСвойствОбъектов.Объект КАК Контрагент
	            |ИЗ
	            |	РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
	            |ГДЕ
	            |	ЗначенияСвойствОбъектов.Свойство = &Свойство
	            |	И ЗначенияСвойствОбъектов.Значение = ИСТИНА
	            |	И ЗначенияСвойствОбъектов.Объект = &Объект";

	Запрос.УстановитьПараметр("Объект", ЭтотОбъект.Владелец); //+++ не ссылка!
	Запрос.УстановитьПараметр("Свойство", СвойствоРаспродажи);

	Результат = Запрос.Выполнить();
	рез = НЕ Результат.Пустой();//так правильнее
	Возврат рез; 
КонецФункции	 

функция ПолучитьКонтЛицо(Контр)
	рез = "";
	Запрос = новый Запрос;
	Запрос.УстановитьПараметр("ОбъектВладелец", Контр);
	Запрос.Текст = "ВЫБРАТЬ
	               |	КонтактныеЛица.Наименование
	               |ИЗ
	               |	Справочник.КонтактныеЛица КАК КонтактныеЛица
	               |ГДЕ
	               |	КонтактныеЛица.ОбъектВладелец = &ОбъектВладелец
	               |	И НЕ КонтактныеЛица.ПометкаУдаления
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	КонтактныеЛица.ВидКонтактногоЛица";
	РезультатЗапроса = Запрос.Выполнить();
	выборка = РезультатЗапроса.выбрать();
	Если выборка.Следующий() Тогда
		рез = сокрЛП( выборка.Наименование );
	КонецЕсли;
возврат рез;	
КонецФункции


процедура выгрузитьПользователяВФайл(имяФайла)
	
	Контр = ЭтотОбъект.Владелец; //10.01.2019
	
	инфоКонтр = СведенияОЮрФизЛице( Контр, ТекущаяДата() );
	КонтактЛицо = ПолучитьКонтЛицо( Контр );
	Культура  = ?(Контр.Экспорт И Контр.основнойДоговорКонтрагента.ВалютаВзаиморасчетов.Код<>"643", "en-US", "");
							
	текст1 = "<Partner xmlns:i=""http://www.w3.org/2001/XMLSchema-instance"">
    |<PartnerId>"+СокрЛП(Контр.Код)+"</PartnerId>
	|<Name>"+СокрЛП(Контр.Наименование)+"</Name> 
    |<FullName>"+СокрЛП(Контр.НаименованиеПолное)+"</FullName> 
	
	|<ContactFIO>"+КонтактЛицо+"</ContactFIO> 
	|<Address>"+инфоКонтр.ЮридическийАдрес+"</Address> 
    |<PhoneNumber>"+инфоКонтр.Телефоны+"</PhoneNumber> 
	
    |<INN>"+СокрЛП(Контр.ИНН)+"</INN> 
    |<KPP>"+СокрЛП(Контр.КПП)+"</KPP>
	
	//+++ 09.09.2015 GUID после кпп
	|<Guid>"+СокрЛП(Контр.УникальныйИдентификатор())+"</Guid>"
	//01.02.2016
	+?(Культура<>"" или КлиентРаспродажа(),"
	|<SALE>1</SALE>", "")
	+?(Культура="","", "
	|<Culture>"+Культура+"</Culture>")+"
	|</Partner>";
	
	//текст1 = стрЗаменить(текст1, """", "&quot;");  //  " заменяется на  &quot;
	//текст1 = стрЗаменить(текст1, "'", "&apos;");  //   ' заменяется на  &apos;
		
	ОбъектXML = Новый ТекстовыйДокумент;
	ОбъектXML.УстановитьТекст( текст1);
	ОбъектXML.Записать(ИмяФайла, "UTF-8");
	
КонецПроцедуры	

Функция ВыгрузитьНаСервер(ИмяФайла="", СтрокаПодключения="terminal.yst.ru", УдалятьВременныеФайлы=ЛОЖЬ)
	
//---------------соединение с сервером---------------------------
Попытка
	login="admin"; password="cegthvfhbj";
	Соединение = Новый HTTPСоединение(СтрокаПодключения, ,login, password, , ЛОЖЬ);    //+++ 15.08.2017  https, SSL!  с 16.03.2018 ВЫКЛЮЧЕН

	Если Соединение = Неопределено Тогда
		Возврат "- Соединение с сервером: "+СтрокаПодключения+" - не установлено!";
	КонецЕсли;

//----------------------------------------------------------------
ресурс= "api/partnerapi/create";	
user  = ЭтотОбъект;
Ресурс1 = Ресурс+"?username="+СокрЛП(user.Логин)+"&password="+user.Пароль;
ИмяФайлаРезультата = КаталогВременныхФайлов()+"json1.xml";

Заголовки = Новый Соответствие();
//Если найти(Ресурс,"create")>0 тогда
   Заголовки.Вставить("HASH", "D5790E89580D8B75927F804E738CFCE");  
   Заголовки.Вставить("Content-Type", "text/xml");  
//КонецЕсли;

		HTTPОтвет = Соединение.ОтправитьДляОбработки( ИмяФайла, Ресурс1, 
														ИмяФайлаРезультата, Заголовки) ;

 Соединение = Неопределено; // разорвать соединение

 ТекстовыйФайлОтвет = Новый ТекстовыйДокумент;
 ТекстовыйФайлОтвет.Прочитать(ИмяФайлаРезультата, КодировкаТекста.UTF8);
 СтрокаJSONРезультат = ТекстовыйФайлОтвет.ПолучитьТекст();
 ТекстовыйФайлОтвет = неопределено; // отключается от файла
 
РезТекст = "Статус ответа: "+строка(HTTPОтвет.КодСостояния)+" Ответ сервера: '"+СтрокаJSONРезультат+"'";

Если HTTPОтвет.КодСостояния = 200 тогда
	рез = Истина;
Иначе
	рез = ЛОЖЬ;
КонецЕсли;

//--------------------Удаляем временные файлы-------------------------
Если УдалятьВременныеФайлы тогда
	файл = новый ФАЙЛ(ИмяФайла);
	если файл.Существует() тогда
		путь = файл.Путь;
		УдалитьФайлы(путь, файл.Имя);
		РезТекст = РезТекст + "удален файл данных XML "+ИмяФайла;
	КонецЕсли;
	файл = новый ФАЙЛ(ИмяФайлаРезультата);
	если файл.Существует() тогда
		путь = файл.Путь;
		УдалитьФайлы(путь, файл.Имя);
		РезТекст = РезТекст + "удален файл ответа XML "+ИмяФайлаРезультата;
	КонецЕсли;
КонецЕсли;


исключение
	рез = ложь;
	РезТекст = "Ошибка : "+ОписаниеОшибки();
КонецПопытки;

рез1 =  ?(рез,"+","- ")+РезТекст;
возврат рез1;

КонецФункции

функция ОбработатьРезультатВыгрузки(рез1, СтрокаПодключения)
	
Отказ1 = ложь;

  #Если Клиент тогда
  Если Найти(рез1,"password")>0 тогда
	  сообщить("Успешно создан новый пользователь: "+Логин+" в "+СтрокаПодключения, СтатусСообщения.Информация);
  иначе
	  если Найти(рез1,"exists")>0 тогда
	  	сообщить("Пользователь с таким именем: "+Логин+" уже существует в "+СтрокаПодключения, СтатусСообщения.Внимание);
	  //иначе	  
	  //	сообщить("Не удалось создать пользователя в "+СтрокаПодключения+рез1, СтатусСообщения.Внимание);
	  КонецЕсли;	
	  Сообщить(рез1);
	  Отказ1 = НЕ РольДоступна("ПравоЗавершенияРаботыПользователей");
  КонецЕсли;	  
  #КонецЕсли	  

возврат Отказ1;

КонецФункции

Процедура ПриОткрытии()
	Если не РольДоступна("Право завершения работы пользователей") тогда
	ЭтаФорма.ТолькоПросмотр = Истина;	
	Этаформа.ЭлементыФормы.Пароль.Видимость = Ложь;
	Этаформа.ЭлементыФормы.НадписьПароль.Видимость = Ложь;
	конецЕсли;	
КонецПроцедуры


