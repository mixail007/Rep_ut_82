
Перем мКнопкаПереключенияРежимов;

// Процедура изменяет режим отображения списков выбора.
//
Процедура УстановитьРежимОтображенияСписка()

	Если мКнопкаПереключенияРежимов.Пометка Тогда
		ЭлементыФормы.ПанельТабличныхПолей.ТекущаяСтраница = ЭлементыФормы.ПанельТабличныхПолей.Страницы.СписокВыбораПоПользователю;
		ЭлементыФормы.ДействияФормы.ИсточникДействий = ЭлементыФормы.СправочникСписокПоПользователю;
	Иначе
		ЭлементыФормы.ПанельТабличныхПолей.ТекущаяСтраница = ЭлементыФормы.ПанельТабличныхПолей.Страницы.СписокВыбора;
		ЭлементыФормы.ДействияФормы.ИсточникДействий = ЭлементыФормы.СправочникСписок;
	КонецЕсли;
	ЭлементыФормы.ДействияФормы.ЦветФона = ЦветаСтиля.ЦветФонаКнопки;

КонецПроцедуры

///////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ

// Процедура - обработчик события формы "ПриОткрытии".
//
Процедура ПриОткрытии()

	//+++ 06.04.2018 - для любого пользователя - если это вкл. - полный список!
	Если ПолучитьЗначениеПоУмолчанию(ПараметрыСеанса.ТекущийПользователь, "РазрешитьПолныйСписокКонтрагентов") 
		или Константы.ИспользоватьОграниченияСписковВыбора.Получить()=Ложь Тогда
    	ВОЗВРАТ;  //никаких отборов НЕ НАДО!
	КонецЕсли;
	
	//+++ 26.12.2012
	//Если НЕ (РольДоступна("яштФинДиректор") или РольДоступна("ПолныеПрава"))  или
	
//+++ 01.08.2013
//	Если  ПолучитьЗначениеПоУмолчанию(глТекущийПользователь,"УчетТолькоПоПодразделениюПользователя") тогда
 		//ЭлементыФормы.ДействияФормы.Видимость = ложь;
		//ЭлементыФормы.ДействияФормы.Доступность = ложь;
// 	КонецЕсли;

//+++( 19.05.2014 - для СПб и РнД
флФилиал = ПолучитьЗначениеПоУмолчанию(ПараметрыСеанса.ТекущийПользователь, "УчетТолькоПоПодразделениюПользователя");
флФилиал = ?(флФилиал=неопределено, ложь, флФилиал);

Если РольДоступна("Кассир") и (флФилиал или РольДоступна("ДополнительныеПраваВЭД")) тогда  // для бухгалтеров филиалов - надо видеть всех клиентов по своей группе... 
		
		группа = ПолучитьЗначениеПоУмолчанию(ПараметрыСеанса.ТекущийПользователь, "ГруппаПользователейДляРаспределенияЗаказов");
		СписокПользователей = новый СписокЗначений;
		
		Если группа<>неопределено и группа<>справочники.ГруппыПользователей.ПустаяСсылка() тогда
			для каждого стр1 из группа.ПользователиГруппы цикл
				СписокПользователей.Добавить(стр1.Пользователь);
			КонецЦикла;
		Иначе //только по себе!
			СписокПользователей.Добавить(ПараметрыСеанса.ТекущийПользователь);
		КонецЕсли;
		
		СписокКонтрагентовМенеджера = ПолучитьСписокКонтрагентовМенеджера(СписокПользователей);
		Если СправочникСписок.Отбор.Найти("Ссылка") = Неопределено Тогда 
			СправочникСписок.Отбор.Добавить("Ссылка");
		КонецЕсли;
		
		СправочникСписок.Отбор.ссылка.ВидСравнения = ВидСравнения.ВСписке;
		СправочникСписок.Отбор.ссылка.Значение     = СписокКонтрагентовМенеджера;
    	СправочникСписок.Отбор.ссылка.Использование = Истина;
		
		ЭлементыФормы.СправочникСписок.НастройкаОтбора["Ссылка"].доступность = ложь; // не более этого списка!
		
		СправочникиОтборПомеченныхНаУдаление(Отбор, ЭлементыФормы.СправочникСписок);//не показывать удаленные
		//+++)
	
ИначеЕсли Константы.ИспользоватьОграниченияСписковВыбора.Получить() Тогда
		
		УстановитьОтборВСправочникКонтрагенты(Отбор, ЭлементыФормы.СправочникСписок);
		
	Иначе
		
		Если ПолучитьЗначениеПоУмолчанию(глТекущийПользователь,"ОткрыватьФормуВыбораСправочникаКонтрагентыСОтборомПоТекущемуПользователю") Тогда
			мКнопкаПереключенияРежимов.Пометка = Истина;
		КонецЕсли;
		
		СправочникСписокПоПользователю.Отбор.ОсновнойМенеджерПокупателя.Использование = Истина;
		СправочникСписокПоПользователю.Отбор.ОсновнойМенеджерПокупателя.ВидСравнения  = ВидСравнения.Равно;
		СправочникСписокПоПользователю.Отбор.ОсновнойМенеджерПокупателя.Значение      = глТекущийПользователь;
		ЭлементыФормы.СправочникСписокПоПользователю.НастройкаОтбора.ОсновнойМенеджерПокупателя.Доступность = Ложь;
		
		УстановитьРежимОтображенияСписка();
		
		Если ЭлементыФормы.СправочникСписок.ТекущиеДанные <> Неопределено
			И НЕ ЗначениеНеЗаполнено(ЭлементыФормы.СправочникСписок.ТекущиеДанные.Ссылка)
			И НЕ ЭлементыФормы.СправочникСписок.ТекущиеДанные.ЭтоГруппа Тогда
			ЭлементыФормы.сСправочникСписокПоПользователю.ТекущаяСтрока = ЭлементыФормы.СправочникСписок.ТекущиеДанные.Ссылка;
		КонецЕсли; 
		
	КонецЕсли;

КонецПроцедуры

// Процедура - обработчик события формы "ПередОткрытием".
//
Процедура ПередОткрытием(Отказ, СтандартнаяОбработка)
	
	мКнопкаПереключенияРежимов = ЭлементыФормы.ДействияФормы.Кнопки.Подменю.Кнопки.ОтборПоМенеджеру;
	
КонецПроцедуры

///////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ КОМАНДНЫХ ПАНЕЛЕЙ ФОРМЫ

// Процедура - обработчик события "Нажатие" элемента формы "ДействияФормы.ОтборПоМенеджеру".
//
Процедура ДействияФормыОтборПоМенеджеру(Кнопка)
	
	Кнопка.Пометка = НЕ Кнопка.Пометка;
	
	УстановитьРежимОтображенияСписка();
	
КонецПроцедуры

// Процедура - обработчик события "Нажатие" элемента формы "ДействияФормы.Выбрать".
//
Процедура ДействияФормыВыбрать(Кнопка)
	
	Если мКнопкаПереключенияРежимов.Пометка Тогда
		Если ЭлементыФормы.СправочникСписокПоПользователю.ТекущиеДанные = Неопределено Тогда
			Возврат;
		КонецЕсли;
		КонтрагентВыбора = ЭлементыФормы.СправочникСписокПоПользователю.ТекущиеДанные.Ссылка;
	Иначе
		Если ЭлементыФормы.СправочникСписок.ТекущиеДанные = Неопределено Тогда
			Возврат;
		КонецЕсли;
		Если ТипЗнч(ВладелецФормы) = Тип("ПолеВвода")
		  И ((ВладелецФормы.ВыборГруппИЭлементов = ИспользованиеГруппИЭлементов.Группы И НЕ ЭлементыФормы.СправочникСписок.ТекущиеДанные.ЭтоГруппа)
		  ИЛИ (ВладелецФормы.ВыборГруппИЭлементов = ИспользованиеГруппИЭлементов.Элементы И ЭлементыФормы.СправочникСписок.ТекущиеДанные.ЭтоГруппа)) Тогда
			Возврат;
		КонецЕсли; 
		КонтрагентВыбора = ЭлементыФормы.СправочникСписок.ТекущиеДанные.Ссылка;
	КонецЕсли;
	
	ОповеститьОВыборе(КонтрагентВыбора);
	
КонецПроцедуры

///////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ ЭЛЕМЕНТОВ ФОРМЫ

// Процедура - обработчик события "ПриАктивизацииСтроки" элемента формы "СправочникСписок".
//
Процедура СправочникСписокПриАктивизацииСтроки(Элемент)
	
	ЭлементыФормы.СправочникДерево.ТекущаяСтрока = ЭлементыФормы.СправочникСписок.ТекущийРодитель;
	
КонецПроцедуры

// Процедура - обработчик события "Выбор" элемента формы "СправочникСписокПоПользователю".
//
Процедура СправочникСписокПоПользователюВыбор(Элемент, ВыбраннаяСтрока, Колонка, СтандартнаяОбработка)
	
	Если Элемент.ТекущиеДанные <> Неопределено Тогда
		СтандартнаяОбработка = Ложь;
		ОповеститьОВыборе(Элемент.ТекущиеДанные.Ссылка);
	КонецЕсли;
	
КонецПроцедуры

Процедура СкрытаяКоманднаяПанельПереключитьИерархическийПросмотр(Кнопка)
	
	ЭлементыФормы.СправочникСписок.ИерархическийПросмотр = Не ЭлементыФормы.СправочникСписок.ИерархическийПросмотр;
	
КонецПроцедуры


