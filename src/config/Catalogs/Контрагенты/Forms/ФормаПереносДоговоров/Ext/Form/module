
Процедура КнопкаВыполнитьНажатие(Кнопка)

	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	БумажныеДоговоры.Номер КАК Номер,
		|	БумажныеДоговоры.Период КАК Дата,
		|	БумажныеДоговоры.ДатаОкончанияДействия,
		|	БумажныеДоговоры.Состояние КАК СостояниеДоговора,
		|	БумажныеДоговоры.ЕстьДоговорПоручительства КАК ЕстьДогорПоручительства,
		|	БумажныеДоговоры.ЕстьКопииПравоустанавливающихДокументов,
		|	БумажныеДоговоры.ДопустимоеЧислоДнейЗадолженности,
		|	ВЫБОР
		|		КОГДА БумажныеДоговоры.ДопустимоеЧислоДнейЗадолженности > 0
		|			ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК КонтролироватьЧислоДнейЗадолженности,
		|	БумажныеДоговоры.Пролонгируется,
		|	БумажныеДоговоры.ВидДоговора КАК ВидДоговора1,
		|	БумажныеДоговоры.ЗапретОтгрузкиВОтсрочку
		|ИЗ
		|	РегистрСведений.БумажныеДоговоры КАК БумажныеДоговоры
		|ГДЕ
		|	БумажныеДоговоры.Контрагент = &Контрагент
		|	И (БумажныеДоговоры.ДатаОкончанияДействия = &ПустаяДата
		|			ИЛИ БумажныеДоговоры.ДатаОкончанияДействия > &ТекущаяДата)
		|	И (БумажныеДоговоры.ВидДоговора = &ВидДоговора
		|			ИЛИ БумажныеДоговоры.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ПустаяСсылка))";
	  ВидДоговора1 = неопределено;	
	ЕстьВыключение = ложь;
Для каждого стр1 из СписокДоговоров Цикл
	Если стр1.изменять Тогда
		Если ВидДоговора1 = неопределено тогда
			ВидДоговора1 = стр1.ВидДоговора;
		ИначеЕсли ВидДоговора1 <> стр1.ВидДоговора тогда
			Сообщить("Нельзя выбирать договоры с разным Видом договора! Договор "+строка(стр1.ВидДоговора)+" - "+строка(стр1.Договор)+" ("+строка(стр1.Ответственный)+") - не является договором "+строка(ВидДоговора1), СтатусСообщения.Внимание);
			//стр1.изменять = ложь;
			ЕстьВыключение = истина;
		КонецЕсли;
	КонецЕсли;
КонецЦикла;	
Если ЕстьВыключение тогда // пока не выберут 1 вид - дальше нельзя!
	Предупреждение("    Выбраны договоры с разным Видом договора!
				   |Нельзя устанавить один договор на разные Виды!",30);
	возврат;
КонецЕсли;	
Запрос.УстановитьПараметр("ВидДоговора", ВидДоговора1 );
//+++)

	Запрос.УстановитьПараметр("Контрагент", ЭтаФорма.ВладелецФормы.ссылка);
	Запрос.УстановитьПараметр("ПустаяДата", Дата(1,1,1));
	Запрос.УстановитьПараметр("ТекущаяДата", ТекущаяДата());
	Результат = Запрос.Выполнить();
    Если не Результат.Пустой() Тогда
		Выборка = Результат.Выгрузить();
      ТекДанные = Выборка.ВыбратьСтроку("Выберите действующий договор",);
 	иначе
	 Предупреждение("Нет действующих договоров!");
	конецесли; 
	
Если ТекДанные <> Неопределено Тогда
	ВидДоговораБум = ТекДанные.ВидДоговора1;
	
	Для каждого стр из СписокДоговоров Цикл
		Если стр.изменять Тогда
			
			//15.02.2018 +++ контроль по ВидуДоговора!
 			Если НЕ ЗначениеЗаполнено(ВидДоговораБум) тогда // первый попавшийся...
				ВидДоговораБум = стр.ВидДоговора;
			КонецЕсли;
			Если стр.договор.ВидДоговора <> ВидДоговораБум тогда 
				Сообщить("Вид договора  "+строка(стр.договор)+" ("+строка(стр.Ответственный)+") - не совпадает с видом бумажного договора! Изменение отменено!", СтатусСообщения.Внимание);
	//			стр.изменять = ЛОЖЬ; //выключается
				продолжить;
			КонецЕсли;
			
			//+++ 08.04.2019 - разрешена только предоплата!
			Если ТекДанные.ЗапретОтгрузкиВОтсрочку //Предоплата
				И НЕ (	стр.договор.ТипДоговора = справочники.ТипыДоговоров.НайтиПоКоду("00001") 
					или стр.договор.ТипДоговора = справочники.ТипыДоговоров.ПредоплатаПоСчетам
					или стр.договор.ТипДоговора = справочники.ТипыДоговоров.ФакторингПредоплата ) тогда
				Сообщить("ДЛЯ типа договора: "+строка(стр.договор.ТипДоговора)+" № "+строка(стр.договор.Код)+" "+строка(стр.договор.Наименование)
				+" ("+строка(стр.договор.ОтветственноеЛицо)+") - ЗАПРЕЩЕНО использование выбранного бумажного договора с [v] Запрет Отгрузки В Отсрочку! Изменение отменено!", СтатусСообщения.Внимание);
				продолжить;
			КонецЕсли;	
			
		ДогОб = стр.договор.получитьОбъект();
		ДогОб.обменДанными = Истина;
		
		ЗаполнитьЗначенияСвойств(ДогОб, ТекДанные);//15.02.2018
	попытка
		ДогОб.Записать();
		Стр.номер = ТекДанные.Номер;
		стр.дата  = ТекДанные.Дата;
		стр.ДатаОкончания = ТекДанные.ДатаОкончанияДействия;
	Исключение
		Сообщить("ОШИБКА "+строка(стр.договор)+" ("+строка(стр.Ответственный)+") : "+ОписаниеОшибки(), СтатусСообщения.Внимание);
	//	стр.изменять = ЛОЖЬ; //выключается
	КонецПопытки;
	
		конецЕсли;
	конецЦикла;
конецЕсли;	
КонецПроцедуры

Процедура ПриОткрытии()
 	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ДоговорыКонтрагентов.Ссылка КАК Договор,
		|	ДоговорыКонтрагентов.ОтветственноеЛицо КАК Ответственный,
		|	Ложь КАК Изменять,
		|	ДоговорыКонтрагентов.Номер,
		|	ДоговорыКонтрагентов.Дата,
		|	ДоговорыКонтрагентов.ДатаОкончанияДействия как ДатаОкончания,
		//15.02.2018
		|	ДоговорыКонтрагентов.ВидДоговора
		|ИЗ
		|	Справочник.ДоговорыКонтрагентов КАК ДоговорыКонтрагентов
		|ГДЕ
		|	ДоговорыКонтрагентов.Владелец = &Владелец
		|	И ДоговорыКонтрагентов.ПометкаУдаления = ЛОЖЬ";

	Запрос.УстановитьПараметр("Владелец", ЭтаФорма.ВладелецФормы.ссылка);

	СписокДоговоров = Запрос.Выполнить().Выгрузить();

КонецПроцедуры

Процедура СписокДоговоровПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки)
	Если ДанныеСтроки.Изменять тогда
		ОформлениеСтроки.Шрифт = Новый Шрифт(ОформлениеСтроки.Шрифт ,,,Истина);
	КонецЕсли;
КонецПроцедуры


Процедура КоманднаяПанель1ОтметитьВсё(Кнопка)
	отметитьСтрокиТабл(1);
КонецПроцедуры

Процедура КоманднаяПанель1СнятьВсё(Кнопка)
	отметитьСтрокиТабл(0);
КонецПроцедуры

Процедура КоманднаяПанель1ПереключитьВсё(Кнопка)
	отметитьСтрокиТабл(2);
КонецПроцедуры

процедура отметитьСтрокиТабл(вар)
	
	Если вар=1 тогда // контроль 1 вида договора при включении!
		ВидДоговора1 = неопределено;	 
		Для каждого стр1 из СписокДоговоров Цикл
			Если стр1.изменять Тогда
				Если ВидДоговора1 = неопределено тогда
					ВидДоговора1 = стр1.ВидДоговора;
			 	КонецЕсли;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
 	Если вар=1 и ВидДоговора1 = неопределено тогда	 
		ВидДоговора1 = ?(ЭтаФорма.ВладелецФормы.ссылка.Покупатель, перечисления.ВидыДоговоровКонтрагентов.СПокупателем, 
						перечисления.ВидыДоговоровКонтрагентов.СПоставщиком);
	КонецЕсли;
	
	для каждого стр1 из СписокДоговоров цикл
		Если вар=1 тогда
			Если (ВидДоговора1 = неопределено)
				или (ВидДоговора1 <> неопределено И стр1.ВидДоговора = ВидДоговора1) тогда
			стр1.Изменять = Истина;
			КонецЕсли;
		Иначе 
			стр1.Изменять = ?(вар=0, ЛОЖЬ,  НЕ стр1.Изменять);
		КонецЕсли;
	КонецЦикла;

КонецПроцедуры	
