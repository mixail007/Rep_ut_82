Перем ТекЭлемент;

Процедура ДействияФормыПодборИзНоменклатуры(Кнопка)
	
	Форма = Обработки.ПечатьПрейскуранта.ПолучитьФорму("ФормаПодбора");
	ПолученныйСписок = Форма.ОткрытьМодально();
	СписокПробный = новый СписокЗначений;
	
	ТекРодитель = неопределено;
	Если ((Элементыформы.СправочникСписок.ТекущаяСтрока = неопределено) и (ТекущийЭлемент.ТекущийРодитель <> Справочники.Прейскурант.ПустаяСсылка())) Тогда 
		Если (ТекущийЭлемент.ТекущиеДанные = неопределено) Тогда 
			ТекРодитель = ТекущийЭлемент.ТекущийРодитель;
		Иначе 
			ТекущийЭл = ТекущийЭлемент.ТекущиеДанные.Ссылка;	
		КонецЕсли
		
	ИначеЕсли (Элементыформы.СправочникСписок.ТекущаяСтрока = неопределено) Тогда
		ТекущийЭл = Справочники.Прейскурант.ПустаяСсылка();
	ИначеЕсли (Элементыформы.СправочникСписок.ТекущаяСтрока <> неопределено) Тогда
		ТекущийЭл = ТекущийЭлемент.ТекущиеДанные.Ссылка;	
	КонецЕсли;
		
	Если (ТипЗнч(ПолученныйСписок) = ТипЗнч(СписокПробный)) Тогда 
	
		Для й=0 по ПолученныйСписок.Количество()-1 Цикл
			
			НоменклатураСпис = ПолученныйСписок.Получить(й);
			НоменклатураДляОбработки = НоменклатураСпис.Значение;
			
			Если (НоменклатураДляОбработки.ЭтоГруппа = Истина) Тогда 
				
				Ответ = Вопрос("Номенклатура " + НоменклатураДляОбработки.Наименование + " является группой. Добавить вместе с ней все вложенные элементы ?",РежимДиалогаВопрос.ДаНет);
				Если (Ответ = КодВозвратаДиалога.Да) Тогда
					
					НоваяГруппа 				= Справочники.Прейскурант.СоздатьГруппу();
					НоваяГруппа.Родитель 		= ТекущийЭл.Родитель;
					НоваяГруппа.Номенклатура 	= НоменклатураДляОбработки.Ссылка;
					НоваяГруппа.Наименование 	= НоменклатураДляОбработки.Наименование;
					НоваяГруппа.Записать();
					
					ВыборкаПоНоменклатуре = Справочники.Номенклатура.ВыбратьИерархически(НоменклатураДляобработки);
					
					Пока ВыборкаПоНоменклатуре.Следующий() Цикл
						
						Если (ВыборкаПоНоменклатуре.ЭтоГруппа = Истина) или (ВыборкаПоНоменклатуре.Родитель <> НоменклатураДляОбработки) Тогда
							Продолжить;
						КонецЕсли;
						
						НовыйЭл 					= Справочники.Прейскурант.СоздатьЭлемент();
						НовыйЭл.Родитель 			= НоваяГруппа.Ссылка;
						НовыйЭл.Номенклатура 		= ВыборкаПоНоменклатуре.Ссылка;
						НовыйЭл.Наименование 		= ВыборкаПоНоменклатуре.Наименование;
						НовыйЭл.Размер				= ВыборкаПоНоменклатуре.Размер;
						НовыйЭл.Записать();
						
					КонецЦикла;
					
				Иначе 
					
					НоваяГруппа 				= Справочники.Прейскурант.СоздатьГруппу();
					НоваяГруппа.Родитель 		= ТекущийЭл.Родитель.Ссылка;
					НоваяГруппа.Номенклатура 	= НоменклатураДляОбработки.Ссылка;
					НоваяГруппа.Наименование 	= НоменклатураДляОбработки.Наименование;
					НоваяГруппа.Записать();
					
				КонецЕсли;
			Иначе 
				
				НовыйЭл 					= Справочники.Прейскурант.СоздатьЭлемент();
				НовыйЭл.Родитель 			= ?(ТекРодитель = неопределено,ТекущийЭл.Родитель.Ссылка, ТекРодитель);
				НовыйЭл.Номенклатура 		= НоменклатураДляОбработки.Ссылка;
				НовыйЭл.Наименование 		= НоменклатураДляОбработки.Наименование;
				НовыйЭл.Размер 				= НоменклатураДляОбработки.Размер;
				НовыйЭл.Записать();
			
			КонецЕсли;

		КонецЦикла;
		
	КонецЕсли;
		
КонецПроцедуры

Процедура ДействияФормыПечатьПрейскуранта(Кнопка)
	
		// Вставить содержимое обработчика.
		// Найдем макет
		запрос = новый запрос;
		запрос.УстановитьПараметр("Прейскурант",Справочники.Прейскурант.Пустаяссылка());
		запрос.Текст = "
		|выбрать ссылка, Принадлежность.СсылкаОбъекта как объект
		|из справочник.Внешниеобработки
		|где Принадлежность.СсылкаОбъекта=&Прейскурант";
		
		выборка = запрос.Выполнить().Выбрать();
		Если не(выборка.Следующий()) тогда 
				Сообщить("Ошибка получения внешней формы документа. Возможно, она не установлена.", СтатусСообщения.Важное);
				Возврат;
		конецесли;
		ИмяМакета = выборка.ссылка;	
		
		ИмяФайла = КаталогВременныхФайлов()+"PrnForm.tmp";
		ОбъектВнешнейФормы = ИмяМакета.ПолучитьОбъект();
		Если ОбъектВнешнейФормы = Неопределено Тогда
			Сообщить("Ошибка получения внешней формы документа. Возможно форма была удалена", СтатусСообщения.Важное);
			Возврат;
		КонецЕсли;
			
		ДвоичныеДанные = ОбъектВнешнейФормы.ХранилищеВнешнейОбработки.Получить();
		ДвоичныеДанные.Записать(ИмяФайла);
		Обработка = ВнешниеОбработки.Создать(ИмяФайла);
		//Обработка.СсылкаНаОбъект = НовыйДок.Ссылка;
		//Обработка.СсылкаНаСправочник = ВремМаркаИНомер;
		//ТабДокумент = Обработка.Печать();
		Форма = Обработка.ПолучитьФорму("Форма");
		Форма.Открыть();
		
		//Если (ТабДокумент<>неопределено) тогда 
		//	ТабДокумент.Автомасштаб = истина;
		//КонецЕсли;                                    

КонецПроцедуры

Процедура ДействияФормыУстановкиСтраницы(Кнопка)
	
	
	
КонецПроцедуры

Процедура ДействияФормыУстановитьЗначенияВСоттветствииСНоменклатурой(Кнопка)
	
	Запрос = новый Запрос;
	Запрос.Текст = "
	|Выбрать ссылка из Справочник.Прейскурант где Ссылка.родитель = &Родитель";
	Если (ТекЭлемент.ЭтоГруппа = Ложь) и (ТекЭлемент.Номенклатура<>Справочники.Номенклатура.ПустаяСсылка()) Тогда
		Объект = ТекЭлемент.ПолучитьОбъект();
		Объект.Наименование 	= ТекЭлемент.Номенклатура.Наименование;
		Объект.Размер 			= ТекЭлемент.Номенклатура.Размер;
		Объект.Записать();
	Иначе 
		Запрос.УстановитьПараметр("Родитель",ТекЭлемент);	
		Выб = Запрос.Выполнить().Выбрать();
		Пока Выб.Следующий() Цикл
			Ссылка 				= Выб.Ссылка;
			Объект 				= Ссылка.ПолучитьОбъект();
			Объект.Наименование = Объект.Номенклатура.Наименование;
			Объект.Размер 		= Объект.Номенклатура.Размер;
			Объект.Записать();
		КонецЦикла;
	КонецЕсли;
		
КонецПроцедуры

Процедура СправочникСписокПриАктивизацииСтроки(Элемент)
	
	Попытка 
		ТекЭлемент = Элемент.ТекущиеДанные.Ссылка;
	Исключение
		ТекЭлемент = Справочники.Прейскурант.ПустаяСсылка();	
	КонецПопытки;
	
КонецПроцедуры

Процедура СправочникСписокПутьККартинкеНачалоВыбора(Элемент, СтандартнаяОбработка)
	
	ДиалогВыбора = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);

	ДиалогВыбора.Заголовок ="Выбор картинки";
	ДиалогВыбора.Фильтр = "Файлы jpg,bmp|*.jpg;*.bmp"; 
	
	Если ДиалогВыбора.Выбрать() Тогда
		Элемент.Значение = ДиалогВыбора.ВыбранныеФайлы.Получить(0);
	КонецЕсли;
		
КонецПроцедуры

Процедура ПриОткрытии()
	
	//УстановитьЭлементыИсторииКнопка(Ссылка, ЭтаФорма);
	
КонецПроцедуры

Процедура ВыводИстории(Элемент)
	
	ВывестиИсторию(ЭлементыФормы.СправочникСписок.ТекущаяСтрока.Ссылка, ЭтаФорма);
	
КонецПроцедуры
	
	


                