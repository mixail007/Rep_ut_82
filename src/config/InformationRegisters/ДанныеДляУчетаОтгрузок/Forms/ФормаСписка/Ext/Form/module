перем мЖирныйШрифт;

Процедура ДействияФормыПересчитать(Кнопка)
	// Вставить содержимое обработчика.
КонецПроцедуры


Процедура РегистрСведенийСписокНомерРеализацииНачалоВыбора(Элемент, СтандартнаяОбработка)
		СтандартнаяОбработка = ЛОжь;
	попытка
		строка1 = ЭлементыФормы.РегистрСведенийСписок.ТекущиеДанные;
		форма1 = Документы.РеализацияТоваровУслуг.ПолучитьФормуВыбора();
		//ищем по заказу если нет тов.накладной
		Если строка1.НомерЗаявки<>"" и строка1.НомерРеализации="" тогда
			докЗП = Документы.ЗаказПокупателя.НайтиПоНомеру(строка1.НомерЗаявки, ?(ЗначениеЗаполнено(строка1.период), строка1.период, ТекущаяДата()) );
		 	док   = Документы.РеализацияТоваровУслуг.НайтиПоРеквизиту("Сделка", докЗП); //первая попавшаяся реализация...
			Если док <> Документы.РеализацияТоваровУслуг.ПустаяСсылка() тогда
				форма1.Отбор.Сделка.видСравнения = видСравнения.Равно;
				форма1.Отбор.Сделка.значение  =  докЗП;
				форма1.Отбор.Сделка.использование = истина;
			КонецЕсли;
		иначе
			док =  Документы.РеализацияТоваровУслуг.НайтиПоНомеру(строка1.НомерРеализации, ?(ЗначениеЗаполнено(строка1.период), строка1.период, ТекущаяДата())  );
		КонецЕсли;
		
		Если док <> Документы.РеализацияТоваровУслуг.ПустаяСсылка() тогда
			форма1.Отбор.Дата.значениеС  =  НачалоМесяца(док.Дата);
			форма1.Отбор.Дата.значениеПо =  КонецМесяца(док.Дата);
			форма1.ЭлементыФормы.ДокументСписок.ТекущаяСтрока = док;
		иначе
			форма1.Отбор.Дата.значениеС  =  НачалоМесяца(ТекущаяДата());
			форма1.Отбор.Дата.значениеПо =  КонецМесяца(ТекущаяДата());
		КонецЕсли;
		док = форма1.ОткрытьМодально();
		
		Если док<>Неопределено и док<>Документы.РеализацияТоваровУслуг.ПустаяСсылка() тогда
		строка1.НомерРеализации = док.Номер;
		строка1.Период = док.Дата;
		строка1.ВремяОтгрузки = док.Дата;
		строка1.Контрагент = док.Контрагент;
		строка1.ОтветственноеЛицо = док.Ответственный;
		строка1.СуммаОтгрузки = док.СуммаДокумента;
		
		строка1.Доверенность    = док.НомерДоверенности+?(док.ДатаДоверенности=Дата(1,1,1),""," от "+Формат(док.ДатаДоверенности,"ДЛФ=D"))+?(ЗначениеЗаполнено(док.Водитель)," Водитель: "+док.Водитель, "");
		//строка1.НомерАвтомобиля = док.МаркаАвтомобиля;
		строка1.НомерАвтомобиля = док.ГосНомерАвтомобиля;
		строка1.КоличествоПозиций = док.Товары.Итог("Количество");
		строка1.НомерЗаявки = ?(ЗначениеЗаполнено(док.Сделка) и ТипЗнч(док.Сделка)=Тип("ДокументСсылка.ЗаказПокупателя"),док.Сделка.Номер, строка1.НомерЗаявки);
		
		строка1.Город = ПолучитьАдресИзКонтактнойИнформации(док.Контрагент, "Фактический");//КонтактнаяИнформация

		КонецЕсли;
	исключение
	КонецПопытки;	

КонецПроцедуры


Процедура РегистрСведенийСписокНомерЗаявкиНачалоВыбора(Элемент, СтандартнаяОбработка)
		СтандартнаяОбработка = ЛОжь;
	попытка
		строка1 = ЭлементыФормы.РегистрСведенийСписок.ТекущиеДанные;
		форма1  = Документы.ЗаказПокупателя.ПолучитьФормуВыбора();
		док = Документы.ЗаказПокупателя.НайтиПоНомеру(строка1.НомерЗаявки, ?(ЗначениеЗаполнено(строка1.период), строка1.период, ТекущаяДата()) );
		Если док <> Документы.ЗаказПокупателя.ПустаяСсылка() тогда
			форма1.Отбор.Дата.значениеС  =  НачалоМесяца(док.Дата);
			форма1.Отбор.Дата.значениеПо =  КонецМесяца(док.Дата);
			форма1.ЭлементыФормы.ДокументСписок.ТекущаяСтрока = док;
		иначе
			форма1.Отбор.Дата.значениеС  =  НачалоМесяца(ТекущаяДата());
			форма1.Отбор.Дата.значениеПо =  КонецМесяца(ТекущаяДата());
		КонецЕсли;
		док = форма1.ОткрытьМодально();
		
		Если док<>Неопределено и док<>Документы.ЗаказПокупателя.ПустаяСсылка() тогда
			
			Если строка1.НомерРеализации = ""  
				или строка1.Контрагент<>док.Контрагент 
				или строка1.Период <> ?(док.ДатаОтгрузки=дата(1,1,1), док.Дата, док.ДатаОтгрузки) тогда
					Если строка1.НомерРеализации <> "" тогда
						Если Вопрос("Данные уже заполнены по Реализации № "+строка1.НомерРеализации+". 
						   |Вы действительно хотите ЗАМЕНИТЬ эти данные 
						   |на данные из ""Заявки покупателя"" №"+док.Номер+"?", РежимДиалогаВопрос.ДаНет, 0, КодВозвратаДиалога.Нет, "ВНИМАНИЕ!")=КодВозвратаДиалога.Нет тогда
						возврат; // ничего не меняем
						КонецЕсли;
					КонецЕсли;
 				строка1.НомерЗаявки = док.Номер;
				строка1.НомерРеализации = "";	
				строка1.Период = ?(док.ДатаОтгрузки=дата(1,1,1), док.Дата, док.ДатаОтгрузки);
				строка1.Контрагент  = док.Контрагент;
				строка1.СуммаОтгрузки = док.СуммаДокумента; // только по 0 сумме
				строка1.ОтветственноеЛицо = док.Ответственный;
				строка1.ДатаОтгрузки  = ?(док.ДатаОтгрузки=дата(1,1,1), док.Дата, док.ДатаОтгрузки); // только по 0 сумме
				
				строка1.Город = ПолучитьАдресИзКонтактнойИнформации(док.Контрагент, "Фактический");//КонтактнаяИнформация
				
		КонецЕсли;
		
		КонецЕсли;
		
	исключение
	КонецПопытки;	

		
КонецПроцедуры


Процедура ДействияФормыОтчет(Кнопка)
	Отчет1 = Отчеты.ДанныеПоДокументамОтгрузки.Создать().ПолучитьФорму("ОтчетДанныеПоДокументамОтгрузки");
	Отчет1.Открыть();
	Отчет1.ЭлементыФормы.НачДата.Значение = Этаформа.Отбор.Период.значениеС;
	Отчет1.ЭлементыФормы.КонДата.Значение = Этаформа.Отбор.Период.значениеПо;
КонецПроцедуры

Процедура ПриОткрытии()
	//автоматически, если нет настроек с начала пред.месяца по конец текущего
	Этаформа.Отбор.Период.значениеС  = ДобавитьМесяц( НачалоМесяца(ТекущаяДата()), -1);
	Этаформа.Отбор.Период.значениеПо = КонецМесяца(ТекущаяДата());
	
	//+++(  11.04.2012
	Если НЕ ПолучитьЗначениеПоУмолчанию(глТекущийПользователь, "ОтображатьВсеЗаказы") Тогда
		
		//состояние("Идет поиск доступных договоров контрагентов...");
		Если ЗначениеЗаполнено(ПолучитьЗначениеПоУмолчанию(глТекущийПользователь, "ГруппаПользователейДляРаспределенияЗаказов"))
			И НЕ ПолучитьЗначениеПоУмолчанию(глТекущийПользователь, "ОтображатьТолькоСобственныеЗаказы") Тогда //+++ 2012 для списка заказов
			
			СписокПользователей = Новый СписокЗначений;
			
			Для каждого СтрокаСпр Из ПолучитьЗначениеПоУмолчанию(глТекущийПользователь, "ГруппаПользователейДляРаспределенияЗаказов").ПользователиГруппы Цикл
				
				СписокПользователей.Добавить(СтрокаСпр.Пользователь);	
				
			КонецЦикла; 
			
			Этаформа.Отбор.ОтветственноеЛицо.ВидСравнения  = ВидСравнения.ВСписке;
			Этаформа.Отбор.ОтветственноеЛицо.значение      = СписокПользователей;
			Этаформа.Отбор.ОтветственноеЛицо.Использование = Истина;
			
		Иначе
			//отбор по Себе!
			Этаформа.Отбор.ОтветственноеЛицо.ВидСравнения  = ВидСравнения.Равно;
			Этаформа.Отбор.ОтветственноеЛицо.значение      = глТекущийПользователь;
			Этаформа.Отбор.ОтветственноеЛицо.Использование = Истина;
				
		КонецЕсли; 
		состояние("");
		
	КонецЕсли; //+++)

КонецПроцедуры


Процедура РегистрСведенийСписокПриПолученииДанных(Элемент, ОформленияСтрок)
		Для каждого ОформлениеСтроки из ОформленияСтрок цикл
		ДанныеСтроки = ОформлениеСтроки.ДанныеСтроки;
	//оформление строк вцелом
		ДН = Дата(1,1,1);
	//Здесь может быть 2 условия  или / и
	ВсеДокументыОтправлены = (	(ДанныеСтроки.ДатаОтправкиСчетФактуры>ДН) 	  и ЗначениеЗаполнено(ДанныеСтроки.ОтправкаСчетФактура)
							) ИЛИ (ДанныеСтроки.ОтправкаСчетФактура = перечисления.ВидОтправкиДокументов.машина );
		
	ВсеДокументыПолучены = (ДанныеСтроки.ДатаВозвратаТоварнойНакладной>ДН) 
						 и (ДанныеСтроки.ДатаВозвратаСпецификации>ДН)
						 и (ДанныеСтроки.ДатаВозвратаТТН>ДН);
		
	//-------------------автоизменение статусов---------------------------------------	
	//Если ВсеДокументыПолучены и НЕ (ДанныеСтроки.Статус=Перечисления.СтатусыДокументовОтгрузки.Изменен) 
	//	и НЕ (СтрокаОбъект.Статус = перечисления.СтатусыДокументовОтгрузки.Закрыт) тогда  //+++ 25.05.2012 не надо перезаписывать!
	//		СтрокаОбъект = регистрыСведений.ДанныеДляУчетаОтгрузок.СоздатьМенеджерЗаписи();
	//		СтрокаОбъект.Период = ДанныеСтроки.Период;
	//		СтрокаОбъект.Контрагент = ДанныеСтроки.Контрагент;
	//		СтрокаОбъект.НомерРеализации = ДанныеСтроки.НомерРеализации;
	//		СтрокаОбъект.Прочитать(); //естественно сущетвует, так как ДанныеСтроки берутся из регистра
	//		СтрокаОбъект.Статус = перечисления.СтатусыДокументовОтгрузки.Закрыт; // ВСЕ документы отправлены и получены
	//		СтрокаОбъект.Записать();
	//КонецЕсли;
	
	Если ВсеДокументыОтправлены тогда
 			ОформлениеСтроки.Шрифт = мЖирныйШрифт; 
	КонецЕсли; 
		
	//--------Цвет фона в зависимости от статуса--------------------------------------------------	
	Если ДанныеСтроки.Статус=Перечисления.СтатусыДокументовОтгрузки.Закрыт тогда //статус Закрыт
		ОформлениеСтроки.ЦветФона = WebЦвета.СветлоСерый;
	иначеЕсли ДанныеСтроки.Статус=Перечисления.СтатусыДокументовОтгрузки.Изменен тогда //статус Изменен!!!
		ОформлениеСтроки.ЦветФона = WebЦвета.Желтый;
	КонецЕсли;	

КонецЦикла; // по строкам
КонецПроцедуры

Процедура РегистрСведенийСписокПередУдалением(Элемент, Отказ)
	Если НЕ РольДоступна("ПравоЗавершенияРаботыПользователей") тогда //+++ 03.09.2012
		Предупреждение("У Вас недостаточно прав для удаления записей!
					   |Непосредственное удаление записей - запрещено!");
		Отказ = истина;
	КонецЕсли;
КонецПроцедуры

    мЖирныйШрифт = Новый Шрифт(,, Истина);