перем мас;

Процедура ПриОткрытии()
	 ПериодГод = ?(ПериодГод='00010101', НачалоГода(ТекущаяДата()), ПериодГод);
	 ОбновитьТабл();
КонецПроцедуры

процедура ОбновитьТабл()
	 Запрос = Новый Запрос;
	 Запрос.Текст = "ВЫБРАТЬ
	                |	ПравилаЦенообразованияВход.Вход,
	                |	ПравилаЦенообразованияВход.Бонус,
	                |	ПравилаЦенообразованияВход.b2b,
	                |	ЕстьNull(ПравилаЦенообразованияВход.СрокОплатыПоставщику, &ПустаяДата) как СрокОплатыПоставщику,
	                |	МЕСЯЦ(ПравилаЦенообразованияВход.Период) КАК Номер
	                |ИЗ
	                |	РегистрСведений.ПравилаЦенообразованияВход КАК ПравилаЦенообразованияВход
	                |ГДЕ
	                |	ПравилаЦенообразованияВход.ID = &ID
	                |	И ПравилаЦенообразованияВход.Период >= НачалоПериода(&Период,ГОД)
	                |	И ПравилаЦенообразованияВход.Период <= КонецПериода(&Период,ГОД)
	                |
	                |УПОРЯДОЧИТЬ ПО
	                |	Номер
	                |АВТОУПОРЯДОЧИВАНИЕ";
	 Запрос.УстановитьПараметр("ПустаяДата", '00010101');
	 Запрос.УстановитьПараметр("ID", ID);
	 Запрос.УстановитьПараметр("Период",ПериодГод );
	 
	 Результат = Запрос.Выполнить();
	 Выборка = Результат.Выбрать();
	 ТабличноеПоле1.Очистить();
	 
	табл0 = ПолучитьСрез();	 
	
	 для i=0 по 3 цикл
		стр1 = ТабличноеПоле1.Добавить();
		стр1.Поле = мас[i];
					
		ном1=0; знач1=табл0[0][мас[i]]; // !
		для k=1 по 12 цикл //прошлогодние значения!
	 		стр1["Поле"+формат(k,"ЧЦ=2; ЧВН=")] = знач1;
		КонецЦикла;

		пока выборка.Следующий() цикл
			если ном1=0 тогда
				ном1 = выборка.номер; знач1 = выборка[мас[i]];
			иначе
				ном2 = выборка.номер;
				для k=ном1 по ном2-1 цикл
			 	стр1["Поле"+формат(k,"ЧЦ=2; ЧВН=")] = знач1;
				КонецЦикла;
				ном1 = выборка.номер; 
				//если выборка[мас[i]]<>0 тогда  //НЕ срез последних!
					знач1 = выборка[мас[i]];  
				//КонецЕсли;	
			КонецЕсли;	
		КонецЦикла;	
		
		Если ном1=0 тогда  
			ном1=1;
		КонецЕсли;
		
		для k=ном1 по 12 цикл
	 	стр1["Поле"+формат(k,"ЧЦ=2; ЧВН=")] = знач1;
		КонецЦикла;
		
		выборка.Сбросить();
	 КонецЦикла;	 
	
КонецПроцедуры

функция ПолучитьСрез()
	 Запрос = Новый Запрос;
	 Запрос.Текст = "ВЫБРАТЬ
	                |	ЕСТЬNULL(Правила.Вход, 0) КАК Вход,
	                |	ЕСТЬNULL(Правила.Бонус, 0) КАК Бонус,
	                |	ЕСТЬNULL(Правила.b2b, 0) КАК b2b,
	                |	ЕСТЬNULL(Правила.СрокОплатыПоставщику, 0) КАК СрокОплатыПоставщику,
	                |	вв.Код КАК Код
	                |ИЗ
	                |	Справочник.Валюты КАК вв
	                |		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	                |			ПравилаЦенообразованияВход.Вход КАК Вход,
	                |			ПравилаЦенообразованияВход.Бонус КАК Бонус,
	                |			ПравилаЦенообразованияВход.b2b КАК b2b,
	                |			ПравилаЦенообразованияВход.СрокОплатыПоставщику КАК СрокОплатыПоставщику,
	                |			""643"" КАК КодРуб
	                |		ИЗ
	                |			РегистрСведений.ПравилаЦенообразованияВход.СрезПоследних(&Период, ID = &ID) КАК ПравилаЦенообразованияВход) КАК Правила
	                |		ПО вв.Код = Правила.КодРуб
	                |ГДЕ
	                |	вв.Код = ""643""";
					
	 Запрос.УстановитьПараметр("ID", ID);
	 Запрос.УстановитьПараметр("Период", НачалоГода(ПериодГод)-1 );
	 
	 Результат = Запрос.Выполнить();
	 табл0 = Результат.Выгрузить();
 возврат	табл0; 
 КонецФункции
 
Процедура ТабличноеПоле1Поле01ПриИзменении(Элемент)
	текСтр = элементыФормы.ТабличноеПоле1.ТекущиеДанные;
	текКолонка = элементыФормы.ТабличноеПоле1.ТекущаяКолонка.Имя;
	регСв = РегистрыСведений.ПравилаЦенообразованияВход.СоздатьМенеджерЗаписи();
	
	регСв.Период = Дата(Год(ПериодГод), число( прав(текКолонка,2) ), 1);
	регСв.ID  = ID;  
	для i=0 по 3 цикл
		 знач1 = ТабличноеПоле1[i][текКолонка];
		 регСв[мас[i]] = ?(знач1=неопределено, ?(Флажок1,'00010101',0), знач1);   //+++ 
	КонецЦикла;

	регСв.Записать();
		
	ОбновитьТабл();
КонецПроцедуры

Процедура ПериодГодПриИзменении(Элемент)
	ОбновитьТабл();
КонецПроцедуры

	 //значения регистра в строках...  как диаграмма Ганга
	 мас = новый массив;   
	 мас.Добавить("Вход");
	 мас.Добавить("Бонус");
	 мас.Добавить("b2b");
	 мас.Добавить("СрокОплатыПоставщику");
