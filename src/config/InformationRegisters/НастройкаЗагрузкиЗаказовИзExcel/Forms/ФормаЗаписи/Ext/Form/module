перем КодВида, Отправители0;

функция ПолучитьОтправителей()
	рез= "";
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	КонтактнаяИнформация.Представление
	|ИЗ
	|	РегистрСведений.КонтактнаяИнформация КАК КонтактнаяИнформация
	|ГДЕ
	|	КонтактнаяИнформация.Объект = &Объект1
	|	И КонтактнаяИнформация.Тип = &Тип
	|	И КонтактнаяИнформация.Вид = &Вид";

	Запрос.УстановитьПараметр("Тип", перечисления.ТипыКонтактнойИнформации.АдресЭлектроннойПочты);
	Запрос.УстановитьПараметр("Вид", справочники.ВидыКонтактнойИнформации.НайтиПоКоду(КодВида) );
	Запрос.УстановитьПараметр("Объект1", Контрагент);
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();

	Если Выборка.Следующий() тогда
		рез = выборка.Представление;
	КонецЕсли;
	
	возврат рез;
КонецФункции

Процедура ПриОткрытии()
	
	КоличествоОтказ = ?(КоличествоОтказ=0,10,КоличествоОтказ);
	ПричинаОтказа	= ?(ПричинаОтказа=0,  11,ПричинаОтказа);
	
	Отправители = ПолучитьОтправителей();
	Отправители0 = Отправители;
	
	Если EmailОтвет="" тогда
		EmailОтвет="<Не отправлять>";
		
		ЭлементыФормы.EmailОтвет.СписокВыбора.Добавить("<Не отправлять>");
		ЭлементыФормы.EmailОтвет.СписокВыбора.Добавить("<Отправитель>");
		
	КонецЕсли;	
	
	//контрагента можно менять, если это Копирование!	
КонецПроцедуры


//==============================================
Процедура ПередЗаписью(Отказ)
		
	Если НЕ ( Контрагент.ОсновнойМенеджерКонтрагента = глТекущийПользователь
			или Контрагент.ОсновнойДоговорКонтрагента.ОтветственноеЛицо = глТекущийПользователь
			или РольДоступна("ПолныеПрава") ) тогда
		Предупреждение("У Вас недостаточно прав для изменения настройки!
		|Обратитесь к Осн.Менеджеру контрагента: "+строка(Контрагент.ОсновнойМенеджерКонтрагента), 30);
		Отказ = Истина;
		возврат;
	КонецЕсли;
	
	Если (Контрагент.Пустая()
		или Артикул=0 или Количество=0 или Цена=0 или ПерваяСтрока=0 
		  ) тогда
	    Предупреждение("Не заполнены обязательные поля!", 30);
		Отказ = Истина;
	ИначеЕсли Артикул=Количество или Артикул=Цена  или Количество=Цена тогда
		Предупреждение("Номера столбцов Артикул, Количество, Цена - должны быть разные!",30);
		Отказ = Истина;
	КонецЕсли;
	
	Если EmailОтвет="<Не отправлять>" тогда
		EmailОтвет="";
	КонецЕсли;
	
КонецПроцедуры

Процедура ПослеЗаписи()
	
Если Отправители <> Отправители0 тогда	
	Отправители  = СокрЛП(Отправители);
	регСв = РегистрыСведений.КонтактнаяИнформация.СоздатьМенеджерЗаписи();
	регСв.Тип = перечисления.ТипыКонтактнойИнформации.АдресЭлектроннойПочты;
	регСв.Вид = справочники.ВидыКонтактнойИнформации.НайтиПоКоду(КодВида);
	регСв.Объект = Контрагент;
	Если Отправители="" тогда
		регСв.Удалить();
Сообщить("Удален список отправителей: '"+Отправители0+"'");	 
	Иначе	
	регСв.Представление = Отправители;
	регСв.Записать();
Сообщить("Изменился список отправителей: '"+Отправители0+"' >> '"+Отправители+"'");	 
	КонецЕсли;
КонецЕсли;

КонецПроцедуры

Процедура КонтрагентПриИзменении(Элемент)
	Отправители = ПолучитьОтправителей();
	Отправители0 = Отправители;
КонецПроцедуры


КодВида = "39245";