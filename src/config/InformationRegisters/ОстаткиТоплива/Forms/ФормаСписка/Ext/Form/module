
 Процедура ОбновлениеОтображения()
	ПолеВвода1 = ?(ПолеВвода1='00010101', ТекущаяДата(), ПолеВвода1);
	стр1 = яштРезервыПоТоварам.ПолучитьОстатокТоплива(КонецДня(ПолеВвода1));
	ТекОстаток  = стр1[0].Количество;
	ТекСтоимость = стр1[0].Стоимость;
	ЭлементыФормы.Надпись2.Заголовок = "л. ("+формат(?(ТекОстаток=0,0,ТекСтоимость/ТекОстаток),"ЧДЦ=2")+")";
КонецПроцедуры


Процедура ПолеВвода1ПриИзменении(Элемент)
	ОбновлениеОтображения();
КонецПроцедуры


Процедура ДействияФормыПересчет(Кнопка)
	
	Танкер = 1;
	
	массивНашихКонтр = новый массив;
	массивНашихКонтр.Добавить( справочники.Контрагенты.НайтиПоКоду("93833") );//Воробьев А. В. ИП+
//	массивНашихКонтр.Добавить( справочники.Контрагенты.НайтиПоКоду("93037") );//Воробьев Александр Владимирович
	
    массивНашихКонтр.Добавить( справочники.Контрагенты.НайтиПоКоду("00216") );//Землянский+
	массивНашихКонтр.Добавить( справочники.Контрагенты.НайтиПоКоду("91515"));//Малышев
	
	массивНашихКонтр.Добавить( справочники.Контрагенты.НайтиПоКоду("36092") );//Яршинторг ТК
                                                                       
	Дата0 = началоДня(ТекущаяДата()) - 7*86400;
	Если НЕ ВвестиДату(Дата0, "Введите нач.Дату") тогда
	Возврат;
	КонецЕсли;

табл = ПолучитьВсеЗаписиРегСвОстаткиТоплива(Дата0);	
регСв = РегистрыСведений.ОстаткиТоплива.СрезПоследних(Дата0, новый Структура("Танкер",Танкер) );
	Если регСв.Количество()>0 тогда 
		НомерЧека0  = регСв[0].НомерЧека;
	КонецЕсли;	
			
N = табл.Количество(); k=0;
для i=0 по N-1 цикл
 строкаРС = РегистрыСведений.ОстаткиТоплива.СоздатьМенеджерЗаписи();
	ЗаполнитьЗначенияСвойств(строкаРС, табл[i]);
	 стр1 = яштРезервыПоТоварам.ПолучитьОстатокТоплива(строкаРС.Период, Танкер); //N запросов к базе :(
	 Цена = стр1[0].Стоимость/Стр1[0].Количество;
	 СтоимостьНов = Окр(строкаРС.Количество * Цена, 2);
     строкаРС.НомерЧека = НомерЧека0 + i + 1 - k;
	 
	 Если строкаРС.Стоимость>0 и строкаРС.Стоимость<>СтоимостьНов тогда
		 Сообщить(строка(строкаРС.НомерЧека)+") "+строка(строкаРС.Период)+" - Изменена Стоимость: "
		 +строка(строкаРС.Стоимость) +" >> "+строка(СтоимостьНов)
		 +" (цена: "+формат(Цена,"ЧДЦ=4")+")", СтатусСообщения.Информация);
	КонецЕсли;
	
	 Если массивНашихКонтр.Найти(строкаРС.Контрагент)=неопределено тогда
		 
		Если строкаРС.Контрагент = справочники.Контрагенты.НайтиПоКоду("93037") тогда //Воробьев Александр Владимирович
 			строкаРС.Контрагент =справочники.Контрагенты.НайтиПоКоду("93833") ;//Воробьев А. В. ИП+
			Сообщить(строка(строкаРС.Период)+" - Контрагент изменен на : "+строка(строкаРС.Контрагент), СтатусСообщения.Информация);
		ИначеЕсли строкаРС.Контрагент = справочники.Контрагенты.НайтиПоКоду("П000202") тогда //Землянский А. А.
	 		строкаРС.Контрагент =справочники.Контрагенты.НайтиПоКоду("00216") ;//Землянский+
			Сообщить(строка(строкаРС.Период)+" - Контрагент изменен на : "+строка(строкаРС.Контрагент), СтатусСообщения.Информация);
	    Иначе
			Сообщить(строка(строкаРС.Период)+" - Чек Поставщика: "+строка(строкаРС.Контрагент)+" - пропущен!", СтатусСообщения.Внимание);
			k=k+1;
			продолжить;
		КонецЕсли;
		
	 КонецЕсли;	
	 
	 //+++ количество + надо сделать -   (чек>0 всегда!)
	 Если строкаРС.Количество>0 тогда
		 строкаРС.Количество = - строкаРС.Количество;
		СтоимостьНов  = - СтоимостьНов;
	 КонецЕсли;	 
	 
	 Если строкаРС.Стоимость=0 тогда
		 Сообщить(строка(строкаРС.НомерЧека)+") "+строка(строкаРС.Период)+" - Установлена Стоимость: "+строка(СтоимостьНов)
		 +" ( "+строка(строкаРС.Количество)+"л. х "+формат(Цена,"ЧДЦ=4")+"р. )");
	 КонецЕсли;		 
   	 строкаРС.Стоимость = СтоимостьНов;

	 попытка
		 строкаРС.Записать(Истина);
	 исключение
		 сообщить(строка(строкаРС.НомерЧека)+") "+строка(строкаРС.Период)+" - ошибка записи: "+ОписаниеОшибки() , СтатусСообщения.Внимание);
	 КонецПопытки;
 КонецЦикла;	 
 Предупреждение("Обработка завершена.", 30);
КонецПроцедуры


функция ПолучитьВсеЗаписиРегСвОстаткиТоплива(Дата0)
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	ОстаткиТоплива.Период,
	|	ОстаткиТоплива.Танкер,
	|	ОстаткиТоплива.Количество,
	|	ОстаткиТоплива.Стоимость,
	|	ОстаткиТоплива.НомерЧека,
	|	ОстаткиТоплива.Контрагент,
	|	ОстаткиТоплива.Автомобиль,
	|	ОстаткиТоплива.ТипТоплива,
	|	ОстаткиТоплива.Комментарий,
	|	ОстаткиТоплива.НомерСмены
	|ИЗ
	|	РегистрСведений.ОстаткиТоплива КАК ОстаткиТоплива
	|ГДЕ
	|	ОстаткиТоплива.Период >= &Дата0";
	
	Запрос.УстановитьПараметр("Дата0", Дата0);
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выгрузить();
	
	возврат Выборка;
КонецФункции	