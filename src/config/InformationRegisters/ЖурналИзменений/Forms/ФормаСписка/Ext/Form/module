
Процедура ПриОткрытии()
	
	Если РольДоступна("ПолныеПрава") и
		РольДоступна("ПравоЗавершенияРаботыПользователей") тогда
		Предупреждение("Изменение записей - не рекомендуется!", 10);
		ЭтаФорма.ТолькоПросмотр = ЛОЖЬ;
	иначе	// Истина - для всех, ЛОЖЬ - для полных прав и только для Администраторов базы
		ЭтаФорма.ТолькоПросмотр = Истина;
	КонецЕсли;
КонецПроцедуры


Процедура РегистрСведенийСписокПередУдалением(Элемент, Отказ)
	//Если НЕ РольДоступна("ПолныеПрава") тогда //+++ 03.09.2012   //Смирнов 01.09.17
		Предупреждение("Непосредственное удаление записей регистра - запрещено!");
		Отказ = истина;
	//КонецЕсли;	
КонецПроцедуры


Процедура ДействияФормыОчистить(Кнопка)
	Если НЕ РольДоступна("ПравоЗавершенияРаботыПользователей") тогда
		Предупреждение("У вас недостаточно прав для удаления данных!",30);
		возврат;
	КонецЕсли;
	
Режим = РежимДиалогаВопрос.ДаНет;
Ответ = Вопрос("Удаление данных - нежелательная процедура. Продолжить?", Режим, 0);
Если Ответ = КодВозвратаДиалога.Нет Тогда
    Возврат;
КонецЕсли;

ДатаОбр = ДобавитьМесяц(КонецМесяца(ТекущаяДата()),-2);
Подсказка = "Введите дату и время по которую нужно удалить данные";
ЧастьДаты = ЧастиДаты.ДатаВремя;
Если ВвестиДату(ДатаОбр, Подсказка, ЧастьДаты) Тогда
	
	ИмяРегистра = "ЖурналИзменений";
	МетаданныеИсточника = Метаданные.РегистрыСведений[ИмяРегистра];
	измеренияРегСв = новый массив;
	Для каждого Реквизит Из МетаданныеИсточника.Измерения Цикл
		измеренияРегСв.Добавить(Реквизит.Имя);
	КонецЦикла;
	
	Запрос = Новый Запрос;
	 Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
	                |	ЖурналИзменений.Период КАК Период
					|//Измерения
					|
					|ИЗ
	                |	РегистрСведений."+ИмяРегистра+" КАК ЖурналИзменений
	                |ГДЕ
	                |	ЖурналИзменений.Период < &Период
					|
					|УПОРЯДОЧИТЬ ПО
					|Период";
					
	Запрос.УстановитьПараметр("Период", ДатаОбр);
	 
	ЗапросИзмерения = "";
	 для i=0 по измеренияРегСв.Количество()-1 цикл					
		ЗапросИзмерения = ЗапросИзмерения +",
		|ЖурналИзменений."+измеренияРегСв[i];
	КонецЦикла;
    Запрос.Текст = стрЗаменить(Запрос.Текст, "//Измерения",ЗапросИзмерения);
	 #Если Клиент тогда
	 Состояние("Идет поиск всех записей регистра: "+ИмяРегистра+" по "+строка(ДатаОбр));
	 #КонецЕсли
	 Результат = Запрос.Выполнить();
	 Выборка = Результат.Выбрать();
	 
	 
	 менЗап = РегистрыСведений[ИмяРегистра].СоздатьМенеджерЗаписи();
	 N=Выборка.Количество();  
	 проц = мин(1000, окр(N/100,0));
	 проц = ?(проц=0,1,проц); //меньше 100 - тогда 1
	ЕстьОшибки = ложь;
	
//========================Цикл====================================================		
i=0;
Пока Выборка.Следующий() Цикл
	#Если Клиент тогда
	ОбработкаПрерыванияПользователя();
	#КонецЕсли
	
	 	менЗап.Период = Выборка.период;
		для каждого измерение из измеренияРегСв цикл
		   менЗап[измерение] = выборка[измерение];
		КонецЦикла;	
			
	 	попытка
			менЗап.Удалить();	
			i=i+1;
		Исключение
			#Если Клиент тогда
	 		сообщить("Не удалось удалить запись "+строка(Выборка.период)+" : "+ОписаниеОшибки(), СтатусСообщения.Внимание);
			#КонецЕсли
			ЕстьОшибки = истина;
		КонецПопытки;	
		
		#Если Клиент тогда
	 	Если i%проц=0 тогда
			Состояние("Удалено "+строка(i)+" записей. Текущая дата удаления : "+строка(Выборка.период));
		КонецЕсли;	
		#КонецЕсли
КонецЦикла;

КонецЕсли;

   	#Если Клиент тогда
	 Предупреждение("Удалено "+строка(i)+" записей.");
	#КонецЕсли 

КонецПроцедуры

