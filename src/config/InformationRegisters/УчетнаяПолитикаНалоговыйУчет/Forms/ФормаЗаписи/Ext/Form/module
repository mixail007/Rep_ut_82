
Процедура ПриОткрытии()

	//// Для новой записи заполним значение по умолчанию.
	//Если НЕ Выбран() Тогда
	//	Организация = ПолучитьЗначениеПоУмолчанию(глТекущийПользователь, "ОсновнаяОрганизация");
	//	СтруктураПоследнихЗначений = РегистрыСведений.УчетнаяПолитикаНалоговыйУчет.ПолучитьПоследнее(Период, Новый Структура("Организация", Организация));
	//	МоментОпределенияНалоговойБазыНДС = СтруктураПоследнихЗначений.МоментОпределенияНалоговойБазыНДС;

	//	Если ЗначениеНеЗаполнено(МоментОпределенияНалоговойБазыНДС) Тогда
	//		МоментОпределенияНалоговойБазыНДС = Перечисления.МоментыОпределенияНалоговойБазыНДС.ПоОтгрузке;
	//	КонецЕсли;

	//КонецЕсли;
	
	
	// Для новой записи заполним значение по умолчанию.
	Если НЕ Выбран() и ПараметрОбъектКопирования = Неопределено Тогда
		
		Если НЕ ЗначениеЗаполнено(Организация) Тогда // если заполнена - значит это был переход по кнопке перейти из справочника Организации.
			Организация = ПолучитьЗначениеПоУмолчанию(глТекущийПользователь, "ОсновнаяОрганизация")
		КонецЕсли;
		
		УчетнаяПолитикаНУ = РегистрыСведений.УчетнаяПолитикаНалоговыйУчет.СрезПоследних(Период, Новый Структура("Организация", Организация)); 
		
		Если УчетнаяПолитикаНУ.Количество() = 0 Тогда
			
			МоментОпределенияНалоговойБазыНДС = Перечисления.МоментыОпределенияНалоговойБазыНДС.ПоОтгрузке;
			СложныйУчетНДС = Ложь;
			
			НДСРежимУчетаРаспределенныхОплат = Перечисления.НДСРежимУчетаРаспределенныхОплат.Приоритет_НДСНеМожетБытьПринятКВычету;
			НДСИспользованиеОплатПокупателя_Приоритет0 = Ложь;
			НДСНалоговыйПериод = Перечисления.Периодичность.Месяц;
			ПорядокРегистрацииСчетовФактурНаАванс = Перечисления.ПорядокРегистрацииСчетовФактурНаАванс.НаВсеАвансы;
			
		Иначе
			ТекущаяУчетнаяПолитикаНУ = УчетнаяПолитикаНУ.Получить(0);
			
			ОрганизацияЯвляетсяПлательщикомЕНВД = ТекущаяУчетнаяПолитикаНУ.ОрганизацияЯвляетсяПлательщикомЕНВД;
			РозничнаяТорговляОблагаетсяЕНВД = ТекущаяУчетнаяПолитикаНУ.РозничнаяТорговляОблагаетсяЕНВД;
			
			МоментОпределенияНалоговойБазыНДС = ТекущаяУчетнаяПолитикаНУ.МоментОпределенияНалоговойБазыНДС;
			СложныйУчетНДС = ТекущаяУчетнаяПолитикаНУ.СложныйУчетНДС;
			НДСРежимУчетаРаспределенныхОплат = ТекущаяУчетнаяПолитикаНУ.НДСРежимУчетаРаспределенныхОплат;
			НДСИспользованиеОплатПокупателя_Приоритет0 = ТекущаяУчетнаяПолитикаНУ.НДСИспользованиеОплатПокупателя_Приоритет0;
			НДСНалоговыйПериод = ТекущаяУчетнаяПолитикаНУ.НДСНалоговыйПериод;
			ПорядокРегистрацииСчетовФактурНаАванс = ТекущаяУчетнаяПолитикаНУ.ПорядокРегистрацииСчетовФактурНаАванс;
			
		КонецЕсли;
	ИначеЕсли НЕ Выбран() и не ПараметрОбъектКопирования = Неопределено Тогда
		Период = НачалоМесяца(РабочаяДата);
	КонецЕсли;

	УправлениеМоментомОпределенияНалоговойБазыПоНДС();
    УправлениеВидимостьюДоступностью();
	ПроверитьКассыККМ();


КонецПроцедуры

Процедура УправлениеВидимостьюДоступностью()
	
	ЭлементыФормы.РозничнаяТорговляОблагаетсяЕНВД.Доступность = ОрганизацияЯвляетсяПлательщикомЕНВД;
	
	Положения2006Года = (Период >='20060101');
	ЭлементыФормы.МоментОпределенияНалоговойБазыНДС.Доступность = Не Положения2006Года;
	
	
	Упрощенная = СистемаНалогообложения = Перечисления.СистемыНалогообложения.Упрощенная;
	
	ЭлементыФормы.ОбъектНалогообложения.Видимость = Упрощенная;
	ЭлементыФормы.Доходы.Видимость = Упрощенная;
	ЭлементыФормы.ДоходыМинусРасходы.Видимость = Упрощенная;
	
КонецПроцедуры


Процедура ПроверитьКассыККМ()

	ЭлементыФормы.СписокКассККМ.Видимость = Ложь;

	// Проверка всех связанных с данной организацией касс ККМ на наличие включенного параметра "Формировать нефискальные чеки"
	Если Не РозничнаяТорговляОблагаетсяЕНВД Тогда
		Запрос = Новый Запрос("
		|ВЫБРАТЬ
		|	УчетнаяПолитикаНалоговыйУчетСрезПоследних.Период
		|ИЗ
		|	РегистрСведений.УчетнаяПолитикаНалоговыйУчет.СрезПоследних(&Дата, Организация = &Ссылка) КАК УчетнаяПолитикаНалоговыйУчетСрезПоследних
		|");
		Запрос.УстановитьПараметр("Ссылка", Организация);
		Запрос.УстановитьПараметр("Дата"  , ТекущаяДата());

		Выборка = Запрос.Выполнить().Выбрать();
		Выборка.Следующий();

		Если Выборка.Период = НачалоМесяца(Период) Тогда
			СуществуютНефискальныеКассы = Ложь;

			Запрос = Новый Запрос("
			|ВЫБРАТЬ
			|	КассыККМ.ФормироватьНефискальныеЧеки
			|ИЗ
			|	Справочник.КассыККМ КАК КассыККМ
			|ГДЕ
			|	КассыККМ.Владелец = &Ссылка
			|");
			Запрос.УстановитьПараметр("Ссылка", Организация);

			Выборка = Запрос.Выполнить().Выбрать();
			Пока Выборка.Следующий() Цикл
				Если Выборка.ФормироватьНефискальныеЧеки Тогда
					СуществуютНефискальныеКассы = Истина;
					Прервать;
				КонецЕсли;
			КонецЦикла;

			Если СуществуютНефискальныеКассы Тогда
				Сообщить("Внимание! Для организаций, у которых розничная торговля не облагается ЕНВД, " +
				"использование режима формирования нефискальных чеков ККМ недопустимо.
				|Перейдите к списку касс ККМ и выполните отбор по признакам:
				| - ""Владелец"" = """ + Организация + """
				| - ""Формировать нефискальные чеки"" = Истина.
				|Для всех отобранных касс снимите флажок ""Формировать нефискальные чеки"" .", СтатусСообщения.ОченьВажное);

				ЭлементыФормы.СписокКассККМ.Видимость = Истина;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;

КонецПроцедуры

Процедура УправлениеМоментомОпределенияНалоговойБазыПоНДС()
	
	Положения2006Года = (Период >='20060101');
	Если Положения2006Года и МоментОпределенияНалоговойБазыНДС = Перечисления.МоментыОпределенияНалоговойБазыНДС.ПоОплате Тогда
	     МоментОпределенияНалоговойБазыНДС = Перечисления.МоментыОпределенияНалоговойБазыНДС.ПоОтгрузке;
	КонецЕсли; 

КонецПроцедуры


Процедура ОрганизацияЯвляетсяПлательщикомЕНВДПриИзменении(Элемент)
	РозничнаяТорговляОблагаетсяЕНВД = ОрганизацияЯвляетсяПлательщикомЕНВД;
КонецПроцедуры


Процедура ОбщаяПриИзменении(Элемент)
	УправлениеВидимостьюДоступностью();
КонецПроцедуры

