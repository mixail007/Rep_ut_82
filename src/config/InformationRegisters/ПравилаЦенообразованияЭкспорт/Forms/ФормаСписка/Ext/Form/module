 перем таблДиски, ТипЦенUSD, КодЛитые, КодШтамп, масПремиум;
 

Процедура ПриОткрытии()
	 
	Если ЗначениеЗаполнено(РегистрСведенийСписок.Отбор.Контрагент.значение) тогда
		ЭтаФорма.Заголовок = "Правила ценообразования (Экспорт): "+Строка(РегистрСведенийСписок.Отбор.Контрагент.значение);
	КонецЕсли;	
	
КонецПроцедуры


функция МаксПриоритет()
	
	рез = 1;
	
Если ЗначениеЗаполнено(РегистрСведенийСписок.Отбор.Контрагент.значение) тогда
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
	|	ПравилаЦенообразованияЭкспорт.Приоритет КАК Приоритет
	|ИЗ
	|	РегистрСведений.ПравилаЦенообразованияЭкспорт КАК ПравилаЦенообразованияЭкспорт
	|ГДЕ
	|	ПравилаЦенообразованияЭкспорт.Контрагент = &Контрагент
	|
	|УПОРЯДОЧИТЬ ПО
	|	Приоритет УБЫВ
	|АВТОУПОРЯДОЧИВАНИЕ";
	
	Запрос.УстановитьПараметр("Контрагент", РегистрСведенийСписок.Отбор.Контрагент.значение );
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	Если Выборка.Следующий() тогда	
	рез = Выборка.Приоритет;
	КонецЕсли;
КонецЕсли;

	возврат рез;
	
КонецФункции	

Процедура РегистрСведенийСписокПриНачалеРедактирования(Элемент, НоваяСтрока, Копирование)
	
	Если НоваяСтрока тогда
		стр1 = ЭлементыФормы.РегистрСведенийСписок.ТекущиеДанные;
	
	    стр1.Приоритет = МаксПриоритет() + 1;
		
	//Если НЕ Копирование тогда
		Если ЗначениеЗаполнено(РегистрСведенийСписок.Отбор.Контрагент.значение) тогда
		стр1.Контрагент = РегистрСведенийСписок.Отбор.Контрагент.значение;
		КонецЕсли;
		Если стр1.ТипЦен = справочники.ТипыЦенНоменклатуры.ПустаяСсылка() тогда
			стр1.ТипЦен    = ТипЦенUSD;
		КонецЕсли;
		Если стр1.ВидТовара =  перечисления.ВидыТоваров.ПустаяСсылка() тогда
		стр1.ВидТовара = перечисления.ВидыТоваров.Диски;
		КонецЕсли;
		Если стр1.ВидТовара = перечисления.ВидыТоваров.Диски 
			и стр1.НоменклатурнаяГруппа = справочники.НоменклатурныеГруппы.ПустаяСсылка() тогда
			стр1.НоменклатурнаяГруппа = справочники.НоменклатурныеГруппы.НайтиПоНаименованию("Литые");
		КонецЕсли;
	//КонецЕсли;
	КонецЕсли;

КонецПроцедуры

Процедура РегистрСведенийСписокПередНачаломДобавления(Элемент, Отказ, Копирование)
	Если НЕ ЗначениеЗаполнено(РегистрСведенийСписок.Отбор.Контрагент.значение) тогда
		Предупреждение("НЕ ВЫБРАН Контрагент! Добавление правила невозможно!
					|Нажмите кнопку ""Отбор и Сортировка"" и выберите контрагента...", 10);
		Отказ = истина;
	КонецЕсли;	
КонецПроцедуры

Процедура РегистрСведенийСписокДиаметрНачалоВыбора(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка = ложь;
	
	формаД = РегистрыСведений.ПравилаЦенообразованияЭкспорт.ПолучитьФорму("ФормаДиаметра");
	формаД.Диаметр = Элемент.Значение;
	рез = формаД.ОткрытьМодально();
	Если рез<>неопределено тогда
		Элемент.Значение = рез; 
	КонецЕсли;	

КонецПроцедуры


Процедура ДействияФормыЦены(Кнопка)
	
	ТипЦенUSD = справочники.ТипыЦенНоменклатуры.НайтиПоКоду("00028"); //Базовая $
	
	Если НЕ ЗначениеЗаполнено(РегистрСведенийСписок.Отбор.Контрагент.значение) тогда
		Предупреждение("Выберите контрагента!", 10);
		возврат;
	КонецЕсли;

	//+++ 26.07.2016 Миша Никитин просил... 
	Если Вопрос("Вы действительно хотите изменить скидки?", РежимДиалогаВопрос.ДаНет, 30) <> КодВозвратаДиалога.Да Тогда
    	Возврат;
	КонецЕсли;
 	
	таблДиски = новый ТаблицаЗначений;
	таблДиски.Колонки.Добавить("Производитель");
	таблДиски.Колонки.Добавить("НоменклатурнаяГруппа");
	таблДиски.Колонки.Добавить("Диаметр");
	таблДиски.Колонки.Добавить("СкидкаНаценка");
	таблДиски.Колонки.Добавить("ID");

	Контр = РегистрСведенийСписок.Отбор.Контрагент.значение;
	Вариант = Кнопка.Имя;  //ИМЯ КНОПКИ
	
	Кнопка.Пометка = Истина;  //АВС - 
	
	//РегистрСведенийСписок
	Группа =  ?( Найти(Кнопка.Имя,"Штамп")>0, 4,
				?( Найти(Кнопка.Имя,"Premium")>0, 5,
					0)); // все, 3 группы или только 4-я или только 5-я

	Если прав(Вариант,1)="0" тогда // ВСЕ ЗАПИСИ удаляем!
		Сдвиг = 1; // номер первого правила
		наборЗаписей = РегистрыСведений.ПравилаЦенообразованияЭкспорт.СоздатьНаборЗаписей();
		наборЗаписей.Отбор.Контрагент.ВидСравнения = ВидСравнения.Равно;
		наборЗаписей.Отбор.Контрагент.Значение = Контр;
		наборЗаписей.Отбор.Контрагент.Использование = Истина;
		наборЗаписей.Записать(); 
	Иначе    //читаем
		наборЗаписей = РегистрыСведений.ПравилаЦенообразованияЭкспорт.СоздатьНаборЗаписей();
		наборЗаписей.Отбор.Контрагент.ВидСравнения = ВидСравнения.Равно;
		наборЗаписей.Отбор.Контрагент.Значение = Контр;
		наборЗаписей.Отбор.Контрагент.Использование = Истина;
		наборЗаписей.Прочитать();
		
		Если Группа=0 тогда // только литые
		Сдвиг = 1; // номер первого правила до 111
		ИначеЕсли Группа=4 тогда // только Штамп
		Сдвиг = 401;
     	ИначеЕсли Группа=5 тогда // только Premium
		Сдвиг = 501;
  		КонецЕсли;
	
			i=0;
		пока i<наборЗаписей.Количество() цикл
			стр1 = наборЗаписей[i];
			
			если Группа=0 тогда
				флУсл = (стр1.НоменклатурнаяГруппа.Код = КодЛитые);
			иначеЕсли Группа=4 тогда 
		   		флУсл = (стр1.НоменклатурнаяГруппа.Код = КодШтамп);
			ИначеЕсли Группа=5 тогда // только Premium
				флУсл = НЕ ( масПремиум.найти( стр1.Производитель )=неопределено);
			КонецЕсли;
			
			если флУсл тогда
				наборЗаписей.Удалить(стр1);
			иначе
			    i=i+1;
			КонецЕсли;
		КонецЦикла;
		наборЗаписей.Записать(); 
		
	КонецЕсли;

//------------ основная функция ---------------	
	ЗаполнитьСкидки(таблДиски, Вариант, Группа); //Единая функция получения скидок из Макета
		
	для i=0 по таблДиски.Количество()-1 цикл
		
		зап1 = РегистрыСведений.ПравилаЦенообразованияЭкспорт.СоздатьМенеджерЗаписи();
		
		ЗаполнитьЗначенияСвойств(зап1, таблДиски[i]);
		
		зап1.Приоритет = i+Сдвиг;
		зап1.Контрагент = Контр;
		зап1.ВидТовара  = перечисления.ВидыТоваров.Диски;
		зап1.ТипЦен = ТипЦенUSD; 
		зап1.Записать();
	КонецЦикла;	

КонецПроцедуры

 //Единая функция получения скидок из Макета
 Процедура ЗаполнитьСкидки(таблДиски, Вариант="0", Группа=0)
	 
вариант1 = прав(Вариант,1);	   // A,B,C = 1,2,3
АВС = ?(вариант1="A", 1,
		?(вариант1="B", 2,
			?(вариант1="C", 3, -1) // 0 - без диаметров, скидка = 0
		) );	
флБезДиаметров=(АВС<0); // просто диски - без диаметров

//ДАННЫЕ ИЗ МАКЕТА
// Производители:    берутся из столбца: 4*Группа - 2	     с 1-ой строки до пустой
// Скидки берутся :  берутся из столбца: 4*Группа - 3 + АВС	 с 11-ой строки  если АВС>0 (по диаметрам)
если Группа = 0 тогда //все группы
	начГруппа = 1; конГруппа=3;
иначе	 // только 1 группа производителей
	начГруппа = Группа; конГруппа=Группа;
КонецЕсли;

Макет = РегистрыСведений.ПравилаЦенообразованияЭкспорт.получитьМакет("Макет");

Для номГр = начГруппа по конГруппа цикл
	столбец = 4*номГр - 2; // со 2-го  + 4
	
	если не флБезДиаметров тогда // 3 группы с диаметрами, последняя 4-я БЕЗ 
		флБезДиаметров = (Макет.Область(9, столбец).Текст = "Без диаметров");
	КонецЕсли;
	
	номСтрПроизводитель = 1;
	Производитель = Макет.Область(номСтрПроизводитель, столбец  ).Текст;
	НомГруппа     = Макет.Область(номСтрПроизводитель, столбец+1).Текст;
	Пока Производитель<>"" или НомГруппа<>"" цикл
		Если флБезДиаметров тогда   // без диаметров
			
			стр1 = таблДиски.Добавить();
			стр1.Производитель = ?(Производитель="", справочники.Производители.ПустаяСсылка(),
			                              справочники.Производители.НайтиПоНаименованию(Производитель) ); 
			стр1.НоменклатурнаяГруппа = ?(НомГруппа="", справочники.НоменклатурныеГруппы.ПустаяСсылка(),
										справочники.НоменклатурныеГруппы.НайтиПоНаименованию(НомГруппа) );
			стр1.Диаметр			= "";
			стр1.СкидкаНаценка		= 0;
			
			стр1.ID = вариант1;
			 
		Иначе // по АВС - по диаметрам - цикл с 11
			
			номСтрДиаметр = 11;
			столбецСкидки = 4*номГр - 3 + АВС;
			
			Диаметр 	    = Макет.Область(номСтрДиаметр, 1).Текст;
			СкидкаНаценка 	= Макет.Область(номСтрДиаметр, столбецСкидки).Текст;
			Пока Диаметр<>"" цикл // по всем строкам диаметров
				
				стр1 = таблДиски.Добавить();
				стр1.Производитель    	   = ?(Производитель="", справочники.Производители.ПустаяСсылка(),
			                                справочники.Производители.НайтиПоНаименованию(Производитель) ); 
				стр1.НоменклатурнаяГруппа  = ?(НомГруппа="", справочники.НоменклатурныеГруппы.ПустаяСсылка(),
										    справочники.НоменклатурныеГруппы.НайтиПоНаименованию(НомГруппа) );
				стр1.Диаметр   		       = СокрЛП(Диаметр); //строка
				стр1.СкидкаНаценка	       = -число(СкидкаНаценка);
				стр1.ID = вариант1;
	
  			номСтрДиаметр = номСтрДиаметр + 1;
			Диаметр 	     = Макет.Область(номСтрДиаметр, 1).Текст;
			СкидкаНаценка	 = Макет.Область(номСтрДиаметр, столбецСкидки).Текст;
            КонецЦикла;// по диаметрам
			
		КонецЕсли;	
	номСтрПроизводитель = номСтрПроизводитель+1;		
	Производитель = Макет.Область(номСтрПроизводитель, столбец  ).Текст;
	НомГруппа     = Макет.Область(номСтрПроизводитель, столбец+1).Текст;
	КонецЦикла;	//по строкам производителей
КонецЦикла;	//номГр	
	
КонецПроцедуры

Процедура ДействияФормыШаблон(Кнопка)
	Макет = РегистрыСведений.ПравилаЦенообразованияЭкспорт.получитьМакет("Макет");
	Макет.Показать();
КонецПроцедуры

Процедура ДействияФормыУстановитьОтнСкидку(Кнопка)
	скидка = 15;
	если ВвестиЧисло(скидка, "Введите % наценки") тогда
		наборЗаписей = РегистрыСведений.ПравилаЦенообразованияЭкспорт.СоздатьНаборЗаписей();
		наборЗаписей.Отбор.Контрагент.ВидСравнения = ВидСравнения.Равно;
		наборЗаписей.Отбор.Контрагент.Значение = РегистрСведенийСписок.Отбор.Контрагент.значение;
		наборЗаписей.Отбор.Контрагент.Использование = Истина;
        наборЗаписей.Прочитать();
		
		тип = ?( найти(Кнопка.Имя,"Литые")>0, 1, 
					?( найти(Кнопка.Имя,"Штамп")>0, 2, 
						?( найти(Кнопка.Имя,"Premium")>0, 3, 
								0)));
					
		Для i=0 по наборЗаписей.Количество()-1 цикл
									
		кодГр=наборЗаписей[i].НоменклатурнаяГруппа.Код;	
		
		если тип=0
				или (тип=1 и кодГр = КодЛитые и масПремиум.найти( наборЗаписей[i].Производитель )= неопределено ) 
				ИЛИ (тип=2 и кодГр = КодШтамп)
				ИЛИ (тип=3 и масПремиум.найти( наборЗаписей[i].Производитель )<>неопределено ) тогда
			наборЗаписей[i].СкидкаПредоплаты = скидка;
			КонецЕсли;
		КонецЦикла;
		
		наборЗаписей.Записать();
		
	КонецЕсли;	
		
КонецПроцедуры

Процедура ДействияФормыДинамическийШаблон(Кнопка)
	форма = РегистрыСведений.ПравилаЦенообразованияЭкспорт.ПолучитьФорму("ФормаДинамичШаблона");
	форма.Контр = РегистрСведенийСписок.Отбор.Контрагент.значение;
	форма.Открыть();
	
	ЭтаФорма.Обновить();
КонецПроцедуры


процедура ПолучитьНадписьABC()
	
Макет = РегистрыСведений.ПравилаЦенообразованияЭкспорт.получитьМакет("Макет");
	Контр = РегистрСведенийСписок.Отбор.Контрагент.значение;
	наборЗаписей = РегистрыСведений.ПравилаЦенообразованияЭкспорт.СоздатьНаборЗаписей();
	наборЗаписей.Отбор.Контрагент.ВидСравнения = ВидСравнения.Равно;
	наборЗаписей.Отбор.Контрагент.Значение = Контр;
	наборЗаписей.Отбор.Контрагент.Использование = Истина;
	наборЗаписей.Прочитать();

	общийРез = "";
для каждого стрЗап из наборЗаписей цикл
	
	 Для номГр = 1 по 5 цикл
		столбец = 4*номГр - 2; // со 2-го  + 4
		
		номСтрПроизводитель = 1;
		Производитель = Макет.Область(номСтрПроизводитель, столбец  ).Текст;
		НомГруппа     = Макет.Область(номСтрПроизводитель, столбец+1).Текст;
		нашли = ложь;
		Пока Производитель<>"" цикл
			Если Врег(строка(стрЗап.Производитель)) = Производитель тогда
				нашли = Истина;
				прервать;
			КонецЕсли;	
			номСтрПроизводитель = номСтрПроизводитель + 1;
			Производитель = Макет.Область(номСтрПроизводитель, столбец  ).Текст;
		КонецЦикла;
		Если нашли тогда 
			прервать; 
		КонецЕсли;
	КонецЦикла;
	
	Если не нашли тогда
		рез = "D";
    Иначе //--------скидки---------
		номСтр = 11;
		Диаметр   = Макет.Область(номСтр, 1  ).Текст;
		скидкаA = Макет.Область(номСтр, столбец).Текст;    
		скидкаB = Макет.Область(номСтр, столбец+1).Текст;
		скидкаC = Макет.Область(номСтр, столбец+2).Текст;
		 рез = "";
		 Пока Диаметр<>"" и (скидкаA<>скидкаB ИЛИ скидкаB<>скидкаC ИЛИ скидкаA<>скидкаC) Цикл
			Если стрЗап.Диаметр = Диаметр тогда
					если стрЗап.ID = "A" тогда
					    delta  = стрЗап.СкидкаНаценка + число(скидкаA);
						рез = "A" + ?(delta=0,"", ?(delta>0,"+","")+строка(delta)+"$");
					иначеесли стрЗап.ID = "B"  тогда
					    delta  = стрЗап.СкидкаНаценка + число(скидкаB);
						рез = "B" + ?(delta=0,"", ?(delta>0,"+","")+строка(delta)+"$");
					иначеесли стрЗап.ID = "C" тогда //англ
						delta  = стрЗап.СкидкаНаценка + число(скидкаC);
						рез = "C" + ?(delta=0,"", ?(delta>0,"+","")+строка(delta)+"$");
					Иначе
						рез = "D";
					КонецЕсли;
				прервать;
			КонецЕсли;
		номСтр = номСтр + 1;
		Диаметр   = Макет.Область(номСтр, 1  ).Текст;
		скидкаA = Макет.Область(номСтр, столбец).Текст;
		скидкаB = Макет.Область(номСтр, столбец+1).Текст;
		скидкаC = Макет.Область(номСтр, столбец+2).Текст;
		КонецЦикла;	
	КонецЕсли;
	
	если рез = "" тогда
		резСтр = "";
	иначе	
		Если номГр = 5 тогда  
			резСтр = "Premium-"+рез+?(стрЗап.СкидкаПредоплаты=0,"", "("+строка(стрЗап.СкидкаПредоплаты)+"%)");
		Иначе 
			резСтр = строка(стрЗап.НоменклатурнаяГруппа)+"-"+рез+?(стрЗап.СкидкаПредоплаты=0,"","("+строка(стрЗап.СкидкаПредоплаты)+"%)");
		КонецЕсли;	
	КонецЕсли;  
	
	если общийРез="" тогда
		общийРез = резСтр;
	иначеЕсли найти(общийРез,резСтр)=0 тогда
		общийРез = общийРез + "; "+резСтр;
	КонецЕсли;	
	
КонецЦикла;	

если общийРез="" тогда
	общийРез = "<тип цен ABC и % - неопределен>";
КонецЕсли;

ЭлементыФормы.Надпись1.Заголовок = общийРез;

КонецПроцедуры

Процедура РегистрСведенийСписокПриПолученииДанных(Элемент, ОформленияСтрок)
	ПолучитьНадписьABC();
	для каждого стр1 из ОформленияСтрок цикл
		знач1= стр1.Ячейки.ID.Значение;
		если знач1<>неопределено тогда
			Если Найти(знач1,"A")>0 тогда
				стр1.ЦветФона = webЦвета.СветлоРозовый;
			ИначеЕсли Найти(знач1,"B")>0 тогда
				стр1.ЦветФона = webЦвета.СветлоЖелтый;
			ИначеЕсли Найти(знач1,"C")>0 тогда
				стр1.ЦветФона = webЦвета.БледноЗеленый;
				
			ИначеЕсли Найти(знач1,"D")>0 тогда
				стр1.ЦветФона = webЦвета.Голубой;
			КонецЕсли;
		КонецЕсли;	
	КонецЦикла;	
КонецПроцедуры

Процедура РегистрСведенийСписокСкидкаНаценкаПриИзменении(Элемент)
	текСтр = ЭлементыФормы.РегистрСведенийСписок.ТекущиеДанные;
	текСтр.ID = "D";
КонецПроцедуры


//12.04.2017
Процедура ДействияФормыНаценкаА(Кнопка)
	скидка = 0.5;
	если ВвестиЧисло(скидка, "Введите $ наценку") тогда
		наборЗаписей = РегистрыСведений.ПравилаЦенообразованияЭкспорт.СоздатьНаборЗаписей();
		наборЗаписей.Отбор.Контрагент.ВидСравнения = ВидСравнения.Равно;
		наборЗаписей.Отбор.Контрагент.Значение = РегистрСведенийСписок.Отбор.Контрагент.значение;
		наборЗаписей.Отбор.Контрагент.Использование = Истина;
        наборЗаписей.Прочитать();
		
		тип = ?( найти(Кнопка.Имя,"Литые")>0, 1, 
					?( найти(Кнопка.Имя,"Штамп")>0, 2, 
						?( найти(Кнопка.Имя,"Premium")>0, 3, 
								0))); //на всё
					
		Для i=0 по наборЗаписей.Количество()-1 цикл
									
		кодГр=наборЗаписей[i].НоменклатурнаяГруппа.Код;	
		
			если тип=0
				или (тип=1 и кодГр = КодЛитые и масПремиум.найти( наборЗаписей[i].Производитель )= неопределено ) 
				ИЛИ (тип=2 и кодГр = КодШтамп)
				ИЛИ (тип=3 и масПремиум.найти( наборЗаписей[i].Производитель )<>неопределено ) тогда
			наборЗаписей[i].СкидкаНаценка = наборЗаписей[i].СкидкаНаценка + скидка;
			КонецЕсли;
		КонецЦикла;
		
		наборЗаписей.Записать();
		
	КонецЕсли;	
КонецПроцедуры


КодШтамп = "00049";
КодЛитые = "00026";

масПремиум = новый массив;  
масПремиум.Добавить( справочники.Производители.НайтиПоКоду(3654) ); //HARP
масПремиум.Добавить( справочники.Производители.НайтиПоКоду(3656) ); //BUFFALO
масПремиум.Добавить( справочники.Производители.НайтиПоКоду(3657) ); //VISSOL
