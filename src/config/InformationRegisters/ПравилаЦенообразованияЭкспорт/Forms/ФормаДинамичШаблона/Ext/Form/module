
Процедура КоманднаяПанель1Заполнить(Кнопка)
	// по макету
	ТабличноеПоле1.Очистить();
	
	Макет = РегистрыСведений.ПравилаЦенообразованияЭкспорт.получитьМакет("МакетЦен");

Для номГр = 1 по 5 цикл
	столбец = 4*номГр - 2; // со 2-го  + 4
	
	номСтрПроизводитель = 1;
	Производитель = Макет.Область(номСтрПроизводитель, столбец  ).Текст;
	НомГруппа     = Макет.Область(номСтрПроизводитель, столбец+1).Текст;
	
	Производители = новый СписокЗначений;
	НоменклатурнаяГруппа = справочники.НоменклатурныеГруппы.ПустаяСсылка();
//------------список производителей------------------	
	Пока Производитель<>"" цикл
	Производители.Добавить( справочники.Производители.НайтиПоНаименованию(Производитель) );
	НоменклатурнаяГруппа = справочники.НоменклатурныеГруппы.НайтиПоНаименованию(НомГруппа);
	
	номСтрПроизводитель = номСтрПроизводитель+1;
	Производитель = Макет.Область(номСтрПроизводитель, столбец  ).Текст;
	НомГруппа     = Макет.Область(номСтрПроизводитель, столбец+1).Текст;
	КонецЦикла;	

	номСтрДиаметр = 11;
	диаметр = Макет.Область(номСтрДиаметр, 1  ).Текст;
	Цена     = Макет.Область(номСтрДиаметр, столбец ).Текст;

	Пока Цена<>"0" и Цена<>"" цикл
	стр1 = ТабличноеПоле1.Добавить();
	для i=0 по Производители.Количество()-1 цикл
		стр1.Производители.Добавить(Производители[i].Значение);
	КонецЦикла;
	стр1.НоменклатурнаяГруппа = НоменклатурнаяГруппа;
	стр1.Диаметр     = диаметр;
	стр1.ЦенаСредняя = число(Цена);
	
	номСтрДиаметр = номСтрДиаметр +1;
	диаметр = Макет.Область(номСтрДиаметр,1 ).Текст;
	Цена     = Макет.Область(номСтрДиаметр, столбец ).Текст;
	КонецЦикла;
КонецЦикла;
	
КонецПроцедуры

Процедура ТабличноеПоле1Цена1ПриИзменении(Элемент)
	текСтр = ЭлементыФормы.ТабличноеПоле1.ТекущиеДанные;
	текСтр.Скидка = текСтр.Цена - текСтр.ЦенаСредняя;
КонецПроцедуры

Процедура ТабличноеПоле1СкидкаПриИзменении(Элемент)
	текСтр = ЭлементыФормы.ТабличноеПоле1.ТекущиеДанные;
	текСтр.Цена = текСтр.ЦенаСредняя + текСтр.Скидка;
КонецПроцедуры

Процедура ОсновныеДействияФормыЗаписать(Кнопка)
	Если ТабличноеПоле1.Количество()=0 тогда
		Предупреждение("Заполните таблицу цен и скидок", 10);
		возврат;
	КонецЕсли;
	
	наборЗаписей = РегистрыСведений.ПравилаЦенообразованияЭкспорт.СоздатьНаборЗаписей();
	наборЗаписей.Отбор.Контрагент.ВидСравнения = ВидСравнения.Равно;
	наборЗаписей.Отбор.Контрагент.Значение = ЭтаФорма.Контр;
	наборЗаписей.Отбор.Контрагент.Использование = Истина;
	наборЗаписей.Записать(); 
	Сдвиг = 1;
  	ТипЦенUSD = справочники.ТипыЦенНоменклатуры.НайтиПоКоду("00028"); //Базовая $
	для i=0 по ТабличноеПоле1.Количество()-1 цикл
		для j=0 по ТабличноеПоле1[i].Производители.Количество()-1 цикл
		зап1 = РегистрыСведений.ПравилаЦенообразованияЭкспорт.СоздатьМенеджерЗаписи();
		Сдвиг = Сдвиг + j; // сдвигаем на 1 на следующую группу
		зап1.Приоритет = i + Сдвиг;
		зап1.Контрагент = Контр;
		
		зап1.ВидТовара  = перечисления.ВидыТоваров.Диски;
		зап1.ТипЦен = ТипЦенUSD; 
		
		зап1.Производитель = ТабличноеПоле1[i].Производители[j].значение;
		если ВРЕГ(строка(зап1.Производитель))="VISSOL" тогда
			зап1.НоменклатурнаяГруппа = справочники.НоменклатурныеГруппы.НайтиПоКоду("00022"); //"Кованные"	
		иначе
			зап1.НоменклатурнаяГруппа = ТабличноеПоле1[i].НоменклатурнаяГруппа;
		КонецЕсли;	
		зап1.Диаметр  			  = ТабличноеПоле1[i].Диаметр;
		зап1.СкидкаНаценка    	  = ТабличноеПоле1[i].Скидка;
		зап1.ID = "D";
		зап1.Записать();
		КонецЦикла;
	    Сдвиг = Сдвиг+1;
	КонецЦикла;	

	ЭтаФорма.Закрыть();
	
КонецПроцедуры

Процедура ПриОткрытии()
	ЭтаФорма.Заголовок = "Цена для клиента "+строка(ЭтаФорма.Контр);
	КоманднаяПанель1Заполнить(неопределено);
	ПолучитьСкидки();
КонецПроцедуры

процедура ПолучитьСкидки()
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	ПравилаЦенообразованияЭкспорт.Производитель КАК Производитель,
	               |	ПравилаЦенообразованияЭкспорт.НоменклатурнаяГруппа КАК НоменклатурнаяГруппа,
	               |	ПравилаЦенообразованияЭкспорт.Диаметр КАК Диаметр,
	               |	ПравилаЦенообразованияЭкспорт.СкидкаНаценка КАК Скидка
	               |ИЗ
	               |	РегистрСведений.ПравилаЦенообразованияЭкспорт КАК ПравилаЦенообразованияЭкспорт
	               |ГДЕ
	               |	ПравилаЦенообразованияЭкспорт.Контрагент = &Контрагент
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	Диаметр,
	               |	НоменклатурнаяГруппа,
	               |	Производитель,
				   |	Скидка
	               |АВТОУПОРЯДОЧИВАНИЕ";
	
	Запрос.УстановитьПараметр("Контрагент", ЭтаФорма.Контр);
	
	Результат = Запрос.Выполнить();
	ВыборкаД = Результат.Выбрать();
	
	Пока ВыборкаД.Следующий() Цикл
		ЗаполнитьСторкуПоПолям(ВыборкаД);
	КонецЦикла;
	
КонецПроцедуры	

процедура ЗаполнитьСторкуПоПолям(ВыборкаС)
	нашли = ложь;
	для каждого стр22 из ТабличноеПоле1 цикл
		если стр22.НоменклатурнаяГруппа = ВыборкаС.НоменклатурнаяГруппа
			и стр22.Диаметр = ВыборкаС.Диаметр тогда
			нашли = ложь;
			j=0;    N=стр22.Производители.Количество();
			пока j<N цикл
				если стр22.Производители[j].Значение = ВыборкаС.Производитель тогда
					если стр22.Скидка<>0 и стр22.Скидка <> ВыборкаС.Скидка тогда
						сообщить(ВыборкаС.Диаметр+"'' Скидка "+строка(ВыборкаС.Скидка)+" по производителю "+строка(ВыборкаС.Производитель)+" не равна скидке "+строка(стр22.Скидка)+" по другим производителям группы!");
						стр22.Производители.Удалить(j); 	
						
						стр111 = ТабличноеПоле1.Добавить();
						ЗаполнитьЗначенияСвойств(стр111, ВыборкаС); 
						стр111.ЦенаСредняя = стр22.ЦенаСредняя;
						стр111.Цена = стр111.ЦенаСредняя + стр111.Скидка;
						стр111.Производители.дОБАВИТЬ(ВыборкаС.Производитель);

						нашли = истина;
						прервать;
 					иначе	
						стр22.Скидка = ВыборкаС.Скидка;
						стр22.Цена = стр22.ЦенаСредняя + стр22.Скидка;
						нашли = истина;
						прервать;
					КонецЕсли;
				КонецЕсли;	
			j=j+1;	
			КонецЦикла;	
			Если нашли тогда прервать;	
			КонецЕсли;	
		КонецЕсли;	
	КонецЦикла;		
	
	Если не нашли и ВыборкаС.скидка<>0 тогда //нет производителя
		сообщить(ВыборкаС.Диаметр+"'' Скидка "+строка(ВыборкаС.Скидка)+" по производителю "+строка(ВыборкаС.Производитель)+" отсутствует в шаблоне групп!");
		стр111 = ТабличноеПоле1.Добавить();
		ЗаполнитьЗначенияСвойств(стр111, ВыборкаС); 
		стр111.Производители.дОБАВИТЬ(ВыборкаС.Производитель);
	КонецЕсли;

КонецПроцедуры

Процедура КоманднаяПанель1Действие1(Кнопка)
	Макет = РегистрыСведений.ПравилаЦенообразованияЭкспорт.получитьМакет("МакетЦен");
	Макет.Показать();
КонецПроцедуры
