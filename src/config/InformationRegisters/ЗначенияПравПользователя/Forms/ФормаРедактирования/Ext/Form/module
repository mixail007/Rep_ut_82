
Процедура ЗаполнитьДерево()
	ДеревоПрав.Строки.Очистить();
	Запрос = Новый Запрос("	
	|Выбрать Родитель, Ссылка, ЭтоГруппа, ЗначениеПрав.Значение Из ПланВидовХарактеристик.ПраваПользователей КАК Права
	|ЛЕВОЕ СОЕДИНЕНИЕ
	|РегистрСведений.ЗначенияПравПользователя КАК ЗначениеПрав
	|ПО ЗначениеПрав.Право=Права.Ссылка
	|И  ЗначениеПрав.НаборПрав=&НаборПрав
	|УПОРЯДОЧИТЬ По Права.ЭтоГруппа ИЕРАРХИЯ, Права.Наименование
	|");
	Запрос.УстановитьПараметр("НаборПрав",НаборПрав);
	Запрос.Выполнить();
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		Если  Не Выборка.Родитель.Пустая() Тогда
			СтрокаГруппы = ДеревоПрав.Строки.Найти(Выборка.Родитель, "Право", Истина);
			Если СтрокаГруппы=Неопределено Тогда
				СтрокаГруппы = ДеревоПрав.Строки.Добавить();
				СтрокаГруппы.Право = Выборка.Родитель;
				СтрокаГруппы.ЭтоГруппа = Выборка.ЭтоГруппа;
			КонецЕсли;
		Иначе
			СтрокаГруппы = ДеревоПрав;
		КонецЕсли;		
		СтрокаПрава = СтрокаГруппы.Строки.Добавить();
		СтрокаПрава.Право = Выборка.Ссылка;
		СтрокаПрава.Значение = Выборка.Ссылка.ТипЗначения.ПривестиЗначение(Выборка.Значение);		
		СтрокаПрава.ЭтоГруппа = Выборка.ЭтоГруппа;
	КонецЦикла;
КонецПроцедуры

Процедура ПередОткрытием(Отказ, СтандартнаяОбработка)
	НаборПрав = Перечисления.НаборПравПользователей.Получить(0);
КонецПроцедуры

Процедура ДеревоПравПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки)
	Если ДанныеСтроки.ЭтоГруппа Тогда
		ОформлениеСтроки.Ячейки.Значение.ТолькоПросмотр = Истина;
		ОформлениеСтроки.Ячейки.Право.ИндексКартинки=0;
	Иначе
		ОформлениеСтроки.Ячейки.Право.ИндексКартинки=1;
	КонецЕсли;
	Если ДанныеСтроки.Право.ТипЗначения.СодержитТип(Тип("Булево"))
		 И ДанныеСтроки.Право.ТипЗначения.Типы().Количество()=1 Тогда
		ОформлениеСтроки.Ячейки.Значение.ОтображатьТекст = Ложь;
		ОформлениеСтроки.Ячейки.Значение.ОтображатьФлажок = Истина;
		ОформлениеСтроки.Ячейки.Значение.ТолькоПросмотр = Истина;
		ОформлениеСтроки.Ячейки.Значение.Флажок = ДанныеСтроки.Право.ТипЗначения.ПривестиЗначение(ДанныеСтроки.Значение);
	КонецЕсли;
КонецПроцедуры

Процедура ДеревоПравПриИзмененииФлажка(Элемент, Колонка)
	СтрокаДерева = ДеревоПрав.Строки.Найти(Элемент.ТекущиеДанные.Право, "Право", Истина);
	СтрокаДерева.Значение = Не СтрокаДерева.Право.ТипЗначения.ПривестиЗначение(СтрокаДерева.Значение);
	ЭтаФорма.Модифицированность = Истина;
КонецПроцедуры

Процедура ОбновитьНастройки()
	Набор = РегистрыСведений.ЗначенияПравПользователя.СоздатьНаборЗаписей();
	Набор.Отбор.НаборПрав.Использование = Истина;
	Набор.Отбор.НаборПрав.Значение = НаборПрав;
	ЗаполнитьНаборЗаписей(ДеревоПрав.Строки, Набор);
	Набор.Записать();
	ЭтаФорма.Модифицированность = Ложь;
КонецПроцедуры

Процедура ЗаполнитьНаборЗаписей(СтрокиДерева, НаборЗаписей)
	Для Каждого СтрокаДерева Из СтрокиДерева Цикл
		Если Не СтрокаДерева.ЭтоГруппа Тогда
			Запись = НаборЗаписей.Добавить();
			Запись.НаборПрав = НаборПрав;
			Запись.Право = СтрокаДерева.Право;
			Запись.Значение = СтрокаДерева.Право.ТипЗначения.ПривестиЗначение(СтрокаДерева.Значение);
		Иначе
			ЗаполнитьНаборЗаписей(СтрокаДерева.Строки, НаборЗаписей);
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры

Процедура ОсновныеДействияФормыЗаписать(Кнопка)
	ОбновитьНастройки();
КонецПроцедуры

Процедура ПриОткрытии()
	ЗаполнитьДерево();
КонецПроцедуры

Процедура ОсновныеДействияФормыДействие(Кнопка)
	ОбновитьНастройки();
КонецПроцедуры

Процедура ДеревоЗначениеПриИзменении(Элемент)
	ЭтаФорма.Модифицированность = Истина;
КонецПроцедуры

Процедура ПередЗакрытием(Отказ, СтандартнаяОбработка)
	Если ЭтаФорма.Модифицированность Тогда
		Ответ = Вопрос("Данные были изменены. Сохранить изменения?", РежимДиалогаВопрос.ДаНетОтмена);
		Если Ответ = КодВозвратаДиалога.Да Тогда
			ОбновитьНастройки();
		ИначеЕсли Ответ = КодВозвратаДиалога.Отмена Тогда
			Отказ = Истина;
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры

Процедура НаборПравПриИзменении(Элемент)
	ЗаполнитьДерево();
КонецПроцедуры

Процедура НаборПравНачалоВыбора(Элемент, СтандартнаяОбработка)
	Если ЭтаФорма.Модифицированность Тогда
		Ответ = Вопрос("Данные были изменены. Сохранить изменения?", РежимДиалогаВопрос.ДаНет);
		Если Ответ = КодВозвратаДиалога.Да Тогда
			ОбновитьНастройки();
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры

Процедура КоманднаяПанельПрименить(Кнопка)
	ОбновитьНастройки();
КонецПроцедуры


ДеревоПрав.Колонки.Добавить("ЭтоГруппа");