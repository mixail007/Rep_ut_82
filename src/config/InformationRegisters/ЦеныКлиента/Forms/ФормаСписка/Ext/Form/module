
Процедура ДействияФормыОчистить(Кнопка)
	Если НЕ РольДоступна("ПолныеПрава") тогда
		Предупреждение("У вас недостаточно прав для удаления данных!",30);
		возврат;
	КонецЕсли;
	
Режим = РежимДиалогаВопрос.ДаНет;
Ответ = Вопрос("Удаление данных - нежелательная процедура.
			 |Вы действитель хотите УДАЛИТЬ данные?", Режим, 0);
Если Ответ = КодВозвратаДиалога.Нет Тогда
    Возврат;
КонецЕсли;

ДатаОбр = ДобавитьМесяц(КонецМесяца(ТекущаяДата()),-2);
Подсказка = "Введите дату и время ПО которую нужно удалить данные";
ЧастьДаты = ЧастиДаты.ДатаВремя;
Если ВвестиДату(ДатаОбр, Подсказка, ЧастьДаты) Тогда
	
	ИмяРегистра = "ЦеныКлиента";
	МетаданныеИсточника = Метаданные.РегистрыСведений[ИмяРегистра];
	измеренияРегСв = новый массив;
	Для каждого Реквизит Из МетаданныеИсточника.Измерения Цикл
		измеренияРегСв.Добавить(Реквизит.Имя);
	КонецЦикла;
	
	Запрос = Новый Запрос;
	 Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
	                |	ЖурналИзменений.Период КАК Период
					|//Измерения
					|
					|ИЗ
	                |	РегистрСведений."+ИмяРегистра+" КАК ЖурналИзменений
	                |ГДЕ
	                |	ЖурналИзменений.Период < &Период
					|
					|УПОРЯДОЧИТЬ ПО
					|Период";
					
	Запрос.УстановитьПараметр("Период", ДатаОбр);
	 
	ЗапросИзмерения = "";
	 для i=0 по измеренияРегСв.Количество()-1 цикл					
		ЗапросИзмерения = ЗапросИзмерения +",
		|ЖурналИзменений."+измеренияРегСв[i];
	КонецЦикла;
    Запрос.Текст = стрЗаменить(Запрос.Текст, "//Измерения",ЗапросИзмерения);
	 #Если Клиент тогда
	 Состояние("Идет поиск всех записей регистра: "+ИмяРегистра+" по "+строка(ДатаОбр));
	 #КонецЕсли
	 Результат = Запрос.Выполнить();
	 Выборка = Результат.Выбрать();
	 
	 
	 менЗап = РегистрыСведений[ИмяРегистра].СоздатьМенеджерЗаписи();
	 N=Выборка.Количество();  
	 проц = мин(1000, окр(N/100,0));
	 проц = ?(проц=0,1,проц); //меньше 100 - тогда 1
	ЕстьОшибки = ложь;
	
//========================Цикл====================================================		
i=0;   Время0=ТекущаяДата();
Пока Выборка.Следующий() Цикл
	#Если Клиент тогда
	ОбработкаПрерыванияПользователя();
	#КонецЕсли
	
	 	менЗап.Период = Выборка.период;
		для каждого измерение из измеренияРегСв цикл
		   менЗап[измерение] = выборка[измерение];
		КонецЦикла;	
			
	 	попытка
			менЗап.Удалить();	
			i=i+1;
		Исключение
			#Если Клиент тогда
	 		сообщить("Не удалось удалить запись "+строка(Выборка.период)+" : "+ОписаниеОшибки(), СтатусСообщения.Внимание);
			#КонецЕсли
			ЕстьОшибки = истина;
		КонецПопытки;	
		
		#Если Клиент тогда
			время1 = ТекущаяДата()-Время0; 
			Если i%проц=0 и время1>0 тогда
				скорость = i/время1;
				время2 = Цел( (N-i)*время1/i );       
				время1с = ?(цел(время1/60)>0, строка(цел(время1/60))+"мин. ","")+строка(время1 - цел(время1/60)*60)+" сек.";
				время2с = ?(цел(время2/60)>0, строка(цел(время2/60))+"мин. ","")+строка(время2 - цел(время2/60)*60)+" сек.";
			Состояние("Удалено "+строка(i)+" из "+строка(N)+" записей ("+формат(i*100/N,"ЧДЦ=1")+"%). Текущая дата удаления : "+строка(Выборка.период)+"  Скорость: "+формат(скорость,"ЧДЦ=1")+" зап./сек Время выполнения: "+время1с+" Осталось: "+время2с);
		КонецЕсли;	
		#КонецЕсли
КонецЦикла;

КонецЕсли;

   	#Если Клиент тогда
	 Предупреждение(Строка(ТекущаяДата())+" - Удалено "+строка(i)+" записей.");
	#КонецЕсли 

КонецПроцедуры
