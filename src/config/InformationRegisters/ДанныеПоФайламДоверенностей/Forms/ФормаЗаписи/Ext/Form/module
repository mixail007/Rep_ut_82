перем путь0, назвФ, назвП;
//06.06.2016 регистрация изменений реквизитов
перем НаборПроверяемыхреквизитов;


Процедура ВыбПериодНажатие(Элемент)
	НастройкаПериода = Новый НастройкаПериода;
	НастройкаПериода.РедактироватьКакИнтервал = Истина;
	НастройкаПериода.РедактироватьКакПериод = Истина;
	НастройкаПериода.ВариантНастройки = ВариантНастройкиПериода.Период;
	НастройкаПериода.УстановитьПериод(ДатаС, ?(ДатаПо='0001-01-01', ДатаПо, КонецДня(ДатаПо)));
	Если НастройкаПериода.Редактировать() Тогда
		ДатаС = НастройкаПериода.ПолучитьДатуНачала();
		ДатаПо = НастройкаПериода.ПолучитьДатуОкончания();
	КонецЕсли;
КонецПроцедуры

Процедура ПолучитьКаталогФайл(Каталог="", ИмяФайла="")
	
	стрФ = путь0 + СокрЛП(Контрагент.Наименование)+"\";
		
	 Каталог = стрФ;
	 ДоверенноеЛицоСтр = стрЗаменить(ДоверенноеЛицо,".","");
	 ИмяФайла = ДоверенноеЛицоСтр+" "+формат(ДатаПо,"""ДЛФ=D")+".pdf";
	 
КонецПроцедуры	 

Процедура ПриОткрытии()
	
	//+++ 05.05.2016
	Если НЕ ( ПолучитьЗначениеПоУмолчанию(глТекущийПользователь,"РазрешитьРаботуСБумажнымиДоговорами")
	          или сокрЛП(глТекущийПользователь.Код) = "Лаврентьева" или сокрЛП(глТекущийПользователь.Код) = "Разводова Э. И." или сокрЛП(глТекущийПользователь.Код) = "Глухова Т.")  тогда
			  ЭтаФорма.ТолькоПросмотр = истина;
	КонецЕсли;		  
		  
	    
	Если РегистрСведенийМенеджерЗаписи.Контрагент.Пустая() тогда
		если не ПараметрыСеанса.ПустойКонтрагент.Пустая() тогда
			//передаётся при создании записи из карточки Клиента!
			РегистрСведенийМенеджерЗаписи.Контрагент = ПараметрыСеанса.ПустойКонтрагент; 
			ЭлементыФормы.Контрагент.Доступность = ложь;
		КонецЕсли;
	РегистрСведенийМенеджерЗаписи.ДатаС = НачалоДня( ТекущаяДата() );
	РегистрСведенийМенеджерЗаписи.Номер = "б/н";
	КонецЕсли;	

ЭлементыФормы.ВидПути.СписокВыбора.Добавить(назвП);
ЭлементыФормы.ВидПути.СписокВыбора.Добавить(назвФ);
если ПутьККартинке<>"" тогда
	если лев(прав(ПутьККартинке,4),1)="." тогда
	ВидПути = назвФ;
	иначе	
	ВидПути = назвП;
	КонецЕсли;
иначе	
	ВидПути = назвП; //по умолчанию >> 26.04.2016 путь к папке
КонецЕсли;

//---06.06.2016 регистрация изменений реквизитов	
НаборПроверяемыхРеквизитов = Новый Структура; 	
ДЛя каждого элемент из ЭлементыФормы Цикл 
		Если ТипЗнч(элемент) = Тип("ПолеВвода") Тогда 
			НаборПроверяемыхРеквизитов.Вставить(элемент.Имя,Элемент.Значение);
		КонецЕсли;	
КонецЦикла; 
КонецПроцедуры

Процедура ПутьККартинкеНачалоВыбора(Элемент, СтандартнаяОбработка)
	СтандартнаяОбработка = ложь;
	
	если ВидПути= назвП тогда
		диалог = новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.ВыборКаталога);
		если ПутьККартинке<>"" тогда
			диалог.Каталог =ПутьККартинке;
		иначе
			диалог.Каталог =путь0;
		КонецЕсли;	
	иначе // назвФ	
		если ПутьККартинке="" тогда
			диалог = новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
			ПолучитьКаталогФайл(диалог.Каталог, диалог.ПолноеИмяФайла);
			файл = новый файл(диалог.ПолноеИмяФайла);
			если не файл.Существует() тогда
				диалог.Каталог = путь0;
			    диалог.ПолноеИмяФайла = "";
			КонецЕсли;	
		иначе
			диалог.Каталог =ПутьККартинке;
		    диалог.ПолноеИмяФайла = ПутьККартинке;
        КонецЕсли;
	КонецЕсли;
	
	Если диалог.Выбрать() тогда
		если ВидПути=назвП тогда
        ПутьККартинке = диалог.Каталог;
		иначе
		ПутьККартинке = диалог.ПолноеИмяФайла;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура ПутьККартинкеОткрытие(Элемент, СтандартнаяОбработка)
	СтандартнаяОбработка = ложь;
	ЗапуститьПриложение(ПутьККартинке);
КонецПроцедуры

Процедура ПередЗаписью(Отказ)
	
		//+++ 05.05.2016
		Если НЕ ( ПолучитьЗначениеПоУмолчанию(глТекущийПользователь,"РазрешитьРаботуСБумажнымиДоговорами")
              или ПолучитьЗначениеПоУмолчанию(глТекущийПользователь, "РазрешитьРедактироватьДанныеПоФайламДоверенностей")
		      или РольДоступна("ПравоЗавершенияРаботыПользователей") ) тогда
			  Предупреждение("У Вас недостаточно прав для записи данных по файлам доверенностей!", 10);
			  Отказ = истина;
		КонецЕсли;	
		
КонецПроцедуры

//---06.06.2016 регистрация изменений реквизитов
Процедура ПриЗаписи()	                                                             	
	Для каждого Элемент Из НаборПроверяемыхРеквизитов Цикл
        ЭУ = ЭлементыФормы.Найти(Элемент.Ключ);
        Если ЭУ  <> Неопределено Тогда 
            Если ЭУ.Значение <>Элемент.Значение Тогда 
            ВнестиЗаписьОбИзменении(Элемент,Эу.Значение,Контрагент,Номер);                
            КонецЕсли; 
        КонецЕсли;
    КонецЦикла;                                                                 	
КонецПроцедуры     

Процедура ВнестиЗаписьОбИзменении(РеквизитБыло,РеквизитСтало,Контрагент,Номер)		
	ЗаписьОбИзменении = РегистрыСведений.ЖурналИзменений.СоздатьМенеджерЗаписи();
	ЗаписьОбИзменении.Пользователь = ПараметрыСеанса.ТекущийПользователь;
	ЗаписьОбИзменении.Объект = РегистрСведенийМенеджерЗаписи.Контрагент;
	ЗаписьОбИзменении.Компьютер = ИмяКомпьютера();
	ЗаписьОбИзменении.Событие = "Изменение Доверенности " + Контрагент + "  N " + Номер + ".  Изменен реквизит: " + РеквизитБыло.Ключ;
	ЗаписьОбИзменении.Комментарий = "Было: " + РеквизитБыло.Значение +". Стало: " + РеквизитСтало;
	ЗаписьОбИзменении.Период = ТекущаяДата();
	ЗаписьОбИзменении.Записать();	                                          		
КонецПроцедуры
//---конец 06.06.2016 регистрация изменений реквизитов

	путь0 =  "\\omega\Договоры\ТК ЯРШИНТОРГ\доверенности\";
    назвФ = "файлу";
 	назвП = "папке";