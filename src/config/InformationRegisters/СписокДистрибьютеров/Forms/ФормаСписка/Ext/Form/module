
Процедура ДействияФормыАнализ(Кнопка)
	Макет = РегистрыСведений.СписокДистрибьютеров.ПолучитьМакет("МакетПланФакт");
	
	СтруктураОтборов = Новый Структура; 
    СтруктураПараметровОтбора = Новый Структура; 

    Для Каждого ЭлементОтбора из РегистрСведенийСписок.Отбор Цикл 
        Если ЭлементОтбора.Использование Тогда 
            СтруктураПараметровОтбора.Очистить(); 
            СтруктураПараметровОтбора.Вставить("Имя", ЭлементОтбора.Имя); 
            СтруктураПараметровОтбора.Вставить("ВидСравнения", ЭлементОтбора.ВидСравнения); 
            СтруктураПараметровОтбора.Вставить("Значение", ЭлементОтбора.Значение); 
            СтруктураПараметровОтбора.Вставить("ЗначениеПо", ЭлементОтбора.ЗначениеПо); 
            СтруктураПараметровОтбора.Вставить("ЗначениеС", ЭлементОтбора.ЗначениеС); 
            СтруктураПараметровОтбора.Вставить("Представление", ЭлементОтбора.Представление); 
            СтруктураПараметровОтбора.Вставить("ПутьКДанным", ЭлементОтбора.ПутьКДанным); 
            СтруктураПараметровОтбора.Вставить("ТипЗначения", ЭлементОтбора.ТипЗначения); 
            
            СтруктураОтборов.Вставить(ЭлементОтбора.Имя, СтруктураПараметровОтбора); 
        КонецЕсли; 
    КонецЦикла;
	
	
	СписокСтрок=РегистрыСведений.СписокДистрибьютеров.Выбрать(СтруктураОтборов);
	ТабДок=Новый ТабличныйДокумент;
	ОбластьСтрока=Макет.ПолучитьОбласть("Строка");
	
	ТабДок.Вывести(Макет.ПолучитьОбласть("Шапка"));
	
	Пока СписокСтрок.Следующий() Цикл
		Факт=ПолучитьФактПродажи(СписокСтрок);
		ОбластьСтрока.Параметры.КоличествоФакт = Факт;
		ОбластьСтрока.Параметры.Процент = ?(СписокСтрок.Количество>0, формат(Факт*100/СписокСтрок.Количество,"ЧДЦ=1")+"%", "---");
		ОбластьСтрока.Параметры.Заполнить(СписокСтрок);
		ТабДок.Вывести(ОбластьСтрока);
	КонецЦикла;
	ТабДок.Показать();
КонецПроцедуры

Функция ПолучитьФактПродажи(Строчка)
	Факт=0;
	Запрос=Новый Запрос;
	Запрос.Текст="ВЫБРАТЬ
	             |	ПродажиОбороты.КоличествоОборот КАК ПродажиФакт
	             |ИЗ
	             |	РегистрНакопления.Продажи.Обороты( &НачПериода, &КонПериода , ,
	             |			ДоговорКонтрагента.Владелец = &Контрагент
	             |				И Номенклатура.Производитель = &Производитель
				 |				И (Номенклатура.Родитель = &Папка или &Папка = Значение(Справочник.Номенклатура.ПустаяСсылка) )
			 	 |				И Номенклатура в ИЕРАРХИИ (&Папка)
				 |) КАК ПродажиОбороты";
				 Запрос.УстановитьПараметр("НачПериода",Строчка.НачДата);
				 Запрос.УстановитьПараметр("КонПериода",Строчка.КонДата);
				 Запрос.УстановитьПараметр("Контрагент",Строчка.Контрагент);
				 Запрос.УстановитьПараметр("Производитель",Строчка.Производитель);
				 Запрос.УстановитьПараметр("Папка",Строчка.Папка);
				 Рез=Запрос.Выполнить().Выбрать();
				 Пока Рез.Следующий() Цикл
					Факт=Рез.ПродажиФакт ;
				КонецЦикла;	
	Возврат Факт;
КонецФункции;