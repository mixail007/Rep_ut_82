
Функция ИдентификаторСвойстваИдентификаторДокументаВДиадок(DocumentType) Экспорт
	
	Если DocumentType = "NonformalizedProforma" Тогда
		Возврат "ИдентификаторДокументаВДиадокСч";
	ИначеЕсли DocumentType = "Invoice" И ФормироватьСфНаОснованииРТУ() Тогда
		Возврат "ИдентификаторДокументаВДиадокСФ";
	Иначе
		Возврат "ИдентификаторДокументаВДиадок";
	КонецЕсли;
	
КонецФункции

Функция ИдентификаторСвойстваИдентификаторЯщикДокументаВДиадок(DocumentType) Экспорт
	
	Если DocumentType = "NonformalizedProforma" Тогда
		Возврат "ИдентификаторЯщикДокументаВДиадокСч"
	ИначеЕсли DocumentType = "Invoice" И ФормироватьСфНаОснованииРТУ() Тогда
		Возврат "ИдентификаторЯщикДокументаВДиадокСФ"
	Иначе	
		Возврат "ИдентификаторЯщикДокументаВДиадок"
	КонецЕсли;	
	
КонецФункции 

Функция ПолучитьНомерНаПечатьДиадок(ДокументСсылка) Экспорт
	Возврат Вычислить("ОбщегоНазначения.ПолучитьНомерНаПечать(ДокументСсылка)");
КонецФункции

Функция ПолучитьПредставлениеСтавкиНДС(СтавкаНДС, дляСФ=Истина)  Экспорт 
	Если СтавкаНДС = перечисления.СтавкиНДС.НДС0 Тогда 
		Возврат "0"
	ИначеЕсли СтавкаНДС = перечисления.СтавкиНДС.НДС10 Тогда 
		Возврат "10"
	ИначеЕсли СтавкаНДС = перечисления.СтавкиНДС.НДС18 Тогда 
		Возврат "18"
	ИначеЕсли СтавкаНДС = перечисления.СтавкиНДС.НДС20 Тогда 
		Возврат "20"
	ИначеЕсли СтавкаНДС = перечисления.СтавкиНДС.НДС10_110 Тогда 
		Возврат ?(ДляСФ, "10/110","##");
	ИначеЕсли СтавкаНДС = перечисления.СтавкиНДС.НДС18_118 Тогда 
		Возврат ?(ДляСФ, "18/118", "##");
	ИначеЕсли СтавкаНДС = перечисления.СтавкиНДС.БезНДС Тогда 
		Возврат ?(ДляСФ, "без НДС", "");
	ИначеЕсли ЗначениеЗаполнено(СтавкаНДС)=Ложь Тогда 
		Возврат "";
	Иначе 
		Возврат "##"
	КонецЕсли;	
	
КонецФункции 

Функция ЭтоСчетФактуранаАванс(СчетФактура) Экспорт
	
	Если ТипЗнч(СчетФактура) = Тип("ДокументСсылка.СчетФактураВыданный")
		И СуществуетОбъектМетаданных("Перечисление.ВидСчетаФактурыВыставленного")
		И СуществуетОбъектМетаданных("Документ.СчетФактураВыданный.Реквизит.ВидСчетаФактуры") Тогда
		
		ВидСчетаФактуры = СчетФактура.ВидСчетаФактуры;
		
		Возврат
		
		ВидСчетаФактуры = Перечисления.ВидСчетаФактурыВыставленного.НаАванс
		ИЛИ (СуществуетОбъектМетаданных("Перечисление.ВидСчетаФактурыВыставленного.ЗначениеПеречисления.НаАвансКомитента")
			  И ВидСчетаФактуры = Перечисления.ВидСчетаФактурыВыставленного.НаАвансКомитента);
		
			 
	КонецЕсли;
				
	Возврат Ложь;
	
КонецФункции

Функция ПолучитьНаименованиеКолонкиКодаТовара() Экспорт
	
	КолонкаКодаТовара = "Код";
	
	Попытка
		Если Константы.ДополнительнаяКолонкаПечатныхФормДокументов.Получить() = Перечисления.ДополнительнаяКолонкаПечатныхФормДокументов.Артикул Тогда
			КолонкаКодаТовара = "Артикул";
		КонецЕсли;
	Исключение
	КонецПопытки;
	
	Возврат КолонкаКодаТовара;
	
КонецФункции

Функция ДиадокПолучитьПараметрыУчетнойПолитики(ДокСсылка) 
	Возврат Вычислить("ОбщегоНазначения.ПолучитьПараметрыУчетнойПолитики(ДокССылка.Дата, Неопределено, ДокССылка.Организация)");
КонецФункции

Функция ПолучитьДатуНомерДокументовОплаты(СчетФактура) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	СчетФактураВыданныйДатаНомерДокументовОплаты.ДатаПлатежноРасчетногоДокумента,
	|	СчетФактураВыданныйДатаНомерДокументовОплаты.НомерПлатежноРасчетногоДокумента
	|ИЗ
	|	Документ.СчетФактураВыданный.ДатаНомерДокументовОплаты КАК СчетФактураВыданныйДатаНомерДокументовОплаты
	|ГДЕ
	|	СчетФактураВыданныйДатаНомерДокументовОплаты.Ссылка = &Ссылка
	|	И СчетФактураВыданныйДатаНомерДокументовОплаты.НомерПлатежноРасчетногоДокумента <> """"
	|	И СчетФактураВыданныйДатаНомерДокументовОплаты.ДатаПлатежноРасчетногоДокумента <> ДАТАВРЕМЯ(1, 1, 1)";
	Запрос.УстановитьПараметр("Ссылка", СчетФактура);
	
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции

Функция  ПолучитьНомераДляСФ(СсылкаНаОбъект)   Экспорт 
	
	ДанныеДляПечати = Новый Структура;
	Если СсылкаНаОбъект.метаданные().реквизиты.найти("Исправление")<>Неопределено и СсылкаНаОбъект.исправление Тогда
		ДанныеДляПечати.вставить("НомерДокумента", СсылкаНаОбъект.НомерИсходногоДокумента);
		ДанныеДляПечати.Вставить("ДатаДокумента", СсылкаНаОбъект.ДатаИсходногоДокумента);
		ДанныеДляПечати.Вставить("ЭтоИСФ", Истина);
		ДанныеДляПечати.Вставить("НомерИсправления", строка(СсылкаНаОбъект.НомерИсправления));
		ДанныеДляПечати.Вставить("ДатаИсправления",  СсылкаНаОбъект.Дата);
	Иначе 
		ДанныеДляПечати.вставить("НомерДокумента", ПолучитьНомерНаПечатьДиадок(СсылкаНаОбъект));
		ДанныеДляПечати.Вставить("ДатаДокумента",  СсылкаНаОбъект.Дата);
		ДанныеДляПечати.Вставить("ЭтоИСФ", Ложь);
	КонецЕсли;	
	Возврат ДанныеДляПечати;
	
КонецФункции	

Функция ПолучитьНомераДляКСФ(ДокСсылка) Экспорт 
	
	ДанныеДляПечати = Новый Структура;
	Если (ДокСсылка.Метаданные().Реквизиты.Найти("Исправление")<>Неопределено) и (ДокСсылка.Исправление) Тогда 
		//это ксф с исправлением
		ДанныеДляПечати.вставить("НомерКСФ", ДокСсылка.НомерИсправляемогоКорректировочногоДокумента);
		ДанныеДляПечати.вставить("ДатаКСФ",  ДокСсылка.ДатаИсправляемогоКорректировочногоДокумента);
		ДанныеДляПечати.вставить("ЭтоИКСФ", Истина);
		
		ДанныеДляПечати.вставить("НомерИКСФ", формат(ДокСсылка.НомерИсправления, "ЧДЦ=0; ЧГ=0"));
		ДанныеДляПечати.вставить("ДатаИКСФ",  ДокСсылка.Дата);
	Иначе 
		//это ксф без исправлений
		ДанныеДляПечати.вставить("НомерКСФ", Модуль_Интеграция.ПолучитьНомерНаПечатьДиадок(ДокСсылка));
		ДанныеДляПечати.вставить("ДатаКСФ",  ДокСсылка.Дата);
		ДанныеДляПечати.вставить("ЭтоИКСФ", Ложь);
	КонецЕсли;
	
	Если ТипЗнч(ДокСсылка) = Тип("ДокументСсылка.КорректировкаРеализации") Тогда
		ИсправляемыйДокументРеализации = Модуль_Интеграция.ПолучитьИсправляемыйДокументРеализации(ДокСсылка);
		ДатаИсходногоДокумента 	= ИсправляемыйДокументРеализации.Дата;
		НомерИсходногоДокумента = Модуль_Интеграция.ПолучитьНомерНаПечатьДиадок(ИсправляемыйДокументРеализации);
		УчитыватьИсправлениеИсходногоДокумента 	= Ложь;
		НомерИсправленияИсходногоДокумента 		=  "";
		ДатаИсправленияИсходногоДокумента 		= Дата(1,1,1);
	Иначе
		Если ДокСсылка.Метаданные().Реквизиты.Найти("УчитыватьИсправлениеИсходногоДокумента")<>Неопределено Тогда  
			ДатаИсходногоДокумента =  ДокСсылка.ДатаИсходногоДокумента;
			НомерИсходногоДокумента = ДокСсылка.НомерИсходногоДокумента;
			УчитыватьИсправлениеИсходногоДокумента = ДокСсылка.УчитыватьИсправлениеИсходногоДокумента;
			НомерИсправленияИсходногоДокумента =  ДокСсылка.НомерИсправленияИсходногоДокумента;
			ДатаИсправленияИсходногоДокумента = ДокСсылка.ДатаИсправленияИсходногоДокумента;
		Иначе 
			//начиная с бух 2.0.48 часть реквизитов хранится в другом месте 
			ДатаИсходногоДокумента =  ДокСсылка.ДокументыОснования[0].ДатаИсходногоДокумента;
			НомерИсходногоДокумента = ДокСсылка.ДокументыОснования[0].НомерИсходногоДокумента;
			УчитыватьИсправлениеИсходногоДокумента = ДокСсылка.ДокументыОснования[0].УчитыватьИсправлениеИсходногоДокумента;
			НомерИсправленияИсходногоДокумента =  ДокСсылка.ДокументыОснования[0].НомерИсправленияИсходногоДокумента;
			ДатаИсправленияИсходногоДокумента = ДокСсылка.ДокументыОснования[0].ДатаИсправленияИсходногоДокумента;
		КонецЕсли;
	КонецЕсли;
	
	ДанныеДляПечати.вставить("ДатаИсходногоДокумента",				  	ДатаИсходногоДокумента);
	ДанныеДляПечати.вставить("НомерИсходногоДокумента", 				НомерИсходногоДокумента);
	ДанныеДляПечати.вставить("УчитыватьИсправлениеИсходногоДокумента",  УчитыватьИсправлениеИсходногоДокумента);
	ДанныеДляПечати.вставить("НомерИсправленияИсходногоДокумента",  	НомерИсправленияИсходногоДокумента);
	ДанныеДляПечати.вставить("ДатаИсправленияИсходногоДокумента",  		ДатаИсправленияИсходногоДокумента);
	
	Возврат ДанныеДляПечати;
КонецФункции

Функция ПолучитьКПППокупателя(СсылкаНаОбъект) Экспорт 
	
	Если НЕ СсылкаНаОбъект.Метаданные().Реквизиты.Найти("КППКонтрагента") = Неопределено Тогда
		Если ЗначениеЗаполнено(СсылкаНаОбъект.КППКонтрагента) Тогда
			Возврат СсылкаНаОбъект.КППКонтрагента
		КонецЕсли
	КонецЕсли;	
	
	Возврат ""
КонецФункции	

Функция ТребуетсяПерезаполнитьСуммыПоУЕвРублях(ДокументРеализации, СчетФактура = Неопределено, ФормированиеСФ = Ложь) Экспорт 
	
	УчетнаяПолитика = ДиадокПолучитьПараметрыУчетнойПолитики(ДокументРеализации);
	
	Возврат НЕ(УчетнаяПолитика = Неопределено) 
			И (ДокументРеализации.ВалютаДокумента <> Константы.ВалютаРегламентированногоУчета.Получить())
				//торг-12 формируем в рублях всегда, сф - по уе 
			И (ДокументРеализации.ДоговорКонтрагента.РасчетыВУсловныхЕдиницах ИЛИ НЕ ФормированиеСФ)
				//счета-фактуры на аванс заполняются в рублях, их пересчитывать не надо 
			И НЕ(ЭтоСчетФактуранаАванс(СчетФактура));
			
КонецФункции	

Функция ПолучитьВалютуДокумента(ВалютаДокумента, СчетФактура) Экспорт 
	
	Валюта = ВалютаДокумента; 
	РасчетыВУЕ = Ложь;
	ВалютаРегламентированногоУчета=	Константы.ВалютаРегламентированногоУчета.Получить();
	УчетнаяПолитика=				ДиадокПолучитьПараметрыУчетнойПолитики(СчетФактура);
	Если НЕ УчетнаяПолитика = Неопределено 
		И СчетФактура.ДоговорКонтрагента.РасчетыВУсловныхЕдиницах = Истина И
		ВалютаДокумента <> ВалютаРегламентированногоУчета Тогда
		РасчетыВУЕ = Истина;
	КонецЕсли;
	
	Если РасчетыВУЕ = Истина ИЛИ ЭтоСчетФактуранаАванс(СчетФактура) Тогда
		Валюта = ВалютаРегламентированногоУчета;
	КонецЕсли;		
	
	Возврат Валюта; 
	
КонецФункции 

Функция ПолучитьПредставлениеХарактеристикиИСерии(Выборка) Экспорт
	
	Результат = "";
	
	Если ЗначениеЗаполнено(Выборка.Характеристика) Тогда
		Результат = "("+стрЗаменить(выборка.Характеристика, "<>", "");
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Выборка.Серия) Тогда
		Результат = ?(стрДлина(результат) = 0, " (", Результат+"; ")+стрЗаменить(выборка.серия, "<>", "");
	КонецЕсли;
	
	Возврат ?(Результат = "", "", Результат+")");
	
КонецФункции

Функция ПолучитьНомерГТД(НомерГТД) Экспорт
	
	Возврат ?(ЗначениеЗаполнено(НомерГТД), ?(ТипЗнч(НомерГТД)=Тип("Строка"), СокрЛП(НомерГТД), СокрЛП(НомерГТД.Код)), "");
	
КонецФункции

Функция ДиадокПолучитьОсновнойДоговорКонтрагента(Контрагент, Организация, СписокВидовДоговоров) Экспорт
	
	Запрос = Новый Запрос( 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	Контрагенты.ОсновнойДоговорКонтрагента КАК Ссылка
	|ИЗ
	|	Справочник.Контрагенты КАК Контрагенты
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДоговорыКонтрагентов
	|		ПО Контрагенты.ОсновнойДоговорКонтрагента = ДоговорыКонтрагентов.Ссылка
	|			И (ДоговорыКонтрагентов.Организация = &Организация)
	|			И (НЕ ДоговорыКонтрагентов.ПометкаУдаления)
	|			И (ДоговорыКонтрагентов.ВидДоговора В (&СписокДоговоров))
	|ГДЕ
	|	Контрагенты.Ссылка = &Контрагент");
	
	Запрос.УстановитьПараметр("Контрагент"	   ,Контрагент);
	Запрос.УстановитьПараметр("Организация"	   ,Организация);
	Запрос.УстановитьПараметр("СписокДоговоров",СписокВидовДоговоров);
	
	РезультатЗапроса= Запрос.Выполнить();
	
	Если НЕ РезультатЗапроса.Пустой() Тогда
		Выборка= РезультатЗапроса.Выбрать();
		Выборка.Следующий();
		Возврат Выборка.Ссылка
	КонецЕсли;
		
КонецФункции

Функция Документ_Организация(Документ) Экспорт

	Возврат Документ.Организация;

КонецФункции

Функция Организация_КПП(Организация) Экспорт
	
	Возврат Организация.КПП;
	
КонецФункции

Функция ПолучитьДатуНомерВходящейНакладной(ДокСсылка) Экспорт 
	
	Результат= Новый Структура("ДатаВходящегоДокумента, НомерВходящегоДокумента");
	
	МетаданныеДокумента= ДокСсылка.Метаданные();
	
	Если  МетаданныеДокумента.Реквизиты.Найти("ДатаВходящегоДокумента")  <> Неопределено 
		И МетаданныеДокумента.Реквизиты.Найти("НомерВходящегоДокумента") <> Неопределено Тогда 
		Результат.ДатаВходящегоДокумента=  ДокСсылка.ДатаВходящегоДокумента;
		Результат.НомерВходящегоДокумента= ДокСсылка.НомерВходящегоДокумента;
	КонецЕсли;	
	
	Возврат Результат;
	
КонецФункции

Функция ПолучитьДатуНомерВходящегоСчетаФактуры(ДокСсылка) Экспорт 
	
	Возврат ПолучитьДатуНомерВходящейНакладной(ДокСсылка);
	
КонецФункции

Процедура УстановитьДатуНомерВходящейНакладной(ДокСсылка, ДатаВходящегоДокумента, НомерВходящегоДокумента, СписокОтличающихсяРеквизитов) Экспорт 
	
	МетаданныеДокумента= ДокСсылка.Метаданные();
	
	Если  МетаданныеДокумента.Реквизиты.Найти("ДатаВходящегоДокумента")  <> Неопределено
		И МетаданныеДокумента.Реквизиты.Найти("НомерВходящегоДокумента") <> Неопределено
		И (ДокСсылка.ДатаВходящегоДокумента <> ДатаВходящегоДокумента
			ИЛИ ДокСсылка.НомерВходящегоДокумента <> НомерВходящегоДокумента) Тогда
		
		Объект= ДокСсылка.ПолучитьОбъект();
		Объект.ДатаВходящегоДокумента=  ДатаВходящегоДокумента;
		Объект.НомерВходящегоДокумента= НомерВходящегоДокумента;
		
		Попытка
			Объект.Записать();
			Сообщить("Изменены следующие реквизиты: "+СписокОтличающихсяРеквизитов+" 
			|у документа: " + докСсылка);
		Исключение
			Сообщить("Не удалось изменить следующие реквизиты: "+СписокОтличающихсяРеквизитов+"
			|у документа: " + докСсылка);
		КонецПопытки;
		
	КонецЕсли;
	
КонецПроцедуры

Процедура УстановитьДатуНомерВходящегоСчетаФактуры(ДокСсылка, ДатаВходящегоДокумента, НомерВходящегоДокумента, СписокОтличающихсяРеквизитов) Экспорт 
	
	УстановитьДатуНомерВходящейНакладной(ДокСсылка, ДатаВходящегоДокумента, НомерВходящегоДокумента, СписокОтличающихсяРеквизитов);
	
КонецПроцедуры

Функция ДокументБезНДС(СсылкаНаОбъект) Экспорт
	
	МетаданныеДокумента= СсылкаНаОбъект.Метаданные();
	
	Возврат
	
		( МетаданныеДокумента.ТабличныеЧасти.Найти("Товары") 					   <> Неопределено
		 И МетаданныеДокумента.ТабличныеЧасти.Товары.Реквизиты.Найти("СтавкаНДС")  <> Неопределено
		 И СсылкаНаОбъект.Товары.Найти(Перечисления.СтавкиНДС.БезНДС, "СтавкаНДС") <> Неопределено)
	ИЛИ 
		(  МетаданныеДокумента.ТабличныеЧасти.Найти("Услуги") 					   <> Неопределено
		 И МетаданныеДокумента.ТабличныеЧасти.Услуги.Реквизиты.Найти("СтавкаНДС")  <> Неопределено
		 И СсылкаНаОбъект.Услуги.Найти(Перечисления.СтавкиНДС.БезНДС, "СтавкаНДС") <> Неопределено)
	
КонецФункции

Функция ПустаяСсылкаНаНомерГТД() Экспорт
	
	Возврат Справочники.НомераГТД.ПустаяСсылка();
	
КонецФункции

/////////////////////////////////////////////////////////////
// Связи объектов
/////////////////////////////////////////////////////////////

Функция ПолучитьСтавкуНДСДиадок(TaxRate) Экспорт
	
	Если Лев(TaxRate, 2) = "18" Тогда
		
		Возврат Перечисления.СтавкиНДС.НДС18;
		
	ИначеЕсли НЕ ЗначениеЗаполнено(TaxRate) ИЛИ НРег(TaxRate) = "без ндс" Тогда
		
		Возврат Перечисления.СтавкиНДС.БезНДС;
		
	ИначеЕсли Лев(TaxRate, 2) = "10" Тогда
		
		Возврат Перечисления.СтавкиНДС.НДС10;
		
	ИначеЕсли Лев(TaxRate, 1) = "0" Тогда
		
		Возврат Перечисления.СтавкиНДС.НДС0;
		
	КонецЕсли;
	
КонецФункции

//////////////////////////////////////////////////////
//функции генерации структуры для ФУФ счета-фактуры
///////////////////////////////////////////////////////

Функция СчетФактураПолученныйДокументаОснования(ДокументОснование) Экспорт
	
	Запрос= Новый Запрос(
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	Т.Ссылка
	|ИЗ
	|	Документ.СчетФактураПолученный.ДокументыОснования КАК ТЧ
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураПолученный КАК Т
	|		ПО ТЧ.Ссылка = Т.Ссылка
	|			И (НЕ Т.ПометкаУдаления)
	|ГДЕ
	|	ТЧ.ДокументОснование = &ДокументОснование");
	
	Запрос.УстановитьПараметр("ДокументОснование", ДокументОснование);
	
	РезультатЗапроса= Запрос.Выполнить();
	Запрос= Неопределено;
	
	Если НЕ РезультатЗапроса.Пустой() Тогда
		
		Выборка= РезультатЗапроса.Выбрать();
		РезультатЗапроса= Неопределено;
		
		Выборка.Следующий();
		
		Возврат Выборка.Ссылка;
		
	КонецЕсли;
	
КонецФункции

//{ Общие запросы типовых КФ Семейства УТ
	
	Функция ТекстЗапросаТара() Экспорт
		
		Возврат "ВЫБРАТЬ
		|	РеализацияТоваровУслугТовары.НомерСтроки КАК НомерСтроки,
		|	ВЫБОР
		|		КОГДА ПОДСТРОКА(РеализацияТоваровУслугТовары.Номенклатура.НаименованиеПолное, 1, 10) = """"
		|			Тогда РеализацияТоваровУслугТовары.Номенклатура.Наименование
		|		ИНАЧЕ РеализацияТоваровУслугТовары.Номенклатура.НаименованиеПолное
		|	КОНЕЦ КАК Номенклатура,
		|	РеализацияТоваровУслугТовары.Номенклатура.Ссылка КАК НоменклатураСсыла,
		|	РеализацияТоваровУслугТовары.Номенклатура.Код КАК КодНоменклатуры,
		|	"""" КАК Характеристика,
		|	"""" КАК серия,
		|	РеализацияТоваровУслугТовары.Количество КАК Количество,
		|	РеализацияТоваровУслугТовары.Цена КАК Цена,
		|	РеализацияТоваровУслугТовары.Сумма КАК Сумма,
		|	ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.БезНДС) КАК СтавкаНДС,
		|	0 КАК СуммаНДС,
		|	"""" КАК НомерГТД,
		|	"""" КАК СтранаПроисхождения,
		|	РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС КАК СуммаВключаетНДС,
		|	РеализацияТоваровУслугТовары.Ссылка.УчитыватьНДС КАК УчитыватьНДС,
		|	РеализацияТоваровУслугТовары.Номенклатура.БазоваяЕдиницаИзмерения КАК ЕдиницаИзмерения,
		|	РеализацияТоваровУслугТовары.Номенклатура.БазоваяЕдиницаИзмерения.Код КАК КодЕдиницыИзмерения,
		|	"""" КАК ВидУпаковки,
		|	"""" КАК КоличествоВОдномМесте,
		|	"""" КАК КоличествоМест,
		|	0 КАК Масса,
		|	Ложь КАК ЭтоУслуга,
		|	""Property"" как ПризнакТРУ,
		|	2 КАК порядок
		|ИЗ
		|	Документ.РеализацияТоваровУслуг.ВозвратнаяТара КАК РеализацияТоваровУслугТовары
		|ГДЕ
		|	РеализацияТоваровУслугТовары.Ссылка = &Ссылка";
		
	КонецФункции	
	
	//{ ПОЛУЧЕНИЕ ДАННЫХ
		
		//{ ТЧПолучитьТекстЗапроса...
			
			Функция ТЧПолучитьТекстЗапросаРеализацияТоваровУслуг(ФормированиеСФ) Экспорт
				Возврат		"ВЫБРАТЬ
				|	подзапрос.НомерСтроки КАК НомерСтроки,
				|	подзапрос.Номенклатура,
				|	подзапрос.НоменклатураСсылка,
				|	подзапрос.КодНоменклатуры,
				|	подзапрос.Характеристика,
				|	подзапрос.Серия,
				|	подзапрос.Количество,
				|	подзапрос.Цена,
				|	подзапрос.Сумма,
				|	подзапрос.СтавкаНДС,
				|	подзапрос.СуммаНДС,
				|	подзапрос.НомерГТД,
				|	подзапрос.СтранаПроисхождения,
				|	подзапрос.СуммаВключаетНДС,
				|	подзапрос.УчитыватьНДС,
				|	подзапрос.ЕдиницаИзмерения,
				|	подзапрос.КодЕдиницыИзмерения,
				|	подзапрос.ВидУпаковки,
				|	подзапрос.КоличествоВОдномМесте,
				|	подзапрос.КоличествоМест,
				|	подзапрос.Масса,
				|	подзапрос.ЭтоУслуга,
				|	подзапрос.ПризнакТРУ,
				|	подзапрос.порядок КАК порядок
				|ИЗ
				|	(ВЫБРАТЬ
				|		РеализацияТоваровУслугТовары.НомерСтроки КАК НомерСтроки,
				|		ВЫБОР
				|			КОГДА ПОДСТРОКА(РеализацияТоваровУслугТовары.Номенклатура.НаименованиеПолное, 1, 10) = """"
				|				Тогда РеализацияТоваровУслугТовары.Номенклатура.Наименование
				|			ИНАЧЕ РеализацияТоваровУслугТовары.Номенклатура.НаименованиеПолное
				|		КОНЕЦ КАК Номенклатура,
				|		РеализацияТоваровУслугТовары.Номенклатура.Ссылка КАК НоменклатураСсылка,
				|		РеализацияТоваровУслугТовары.Номенклатура.Код  КАК КодНоменклатуры,
				|		РеализацияТоваровУслугТовары.ХарактеристикаНоменклатуры  КАК Характеристика,
				|		РеализацияТоваровУслугТовары.СерияНоменклатуры КАК серия,
				|		РеализацияТоваровУслугТовары.Количество КАК Количество,
				|		РеализацияТоваровУслугТовары.Цена КАК Цена,
				|		РеализацияТоваровУслугТовары.Сумма КАК Сумма,
				|		РеализацияТоваровУслугТовары.СтавкаНДС КАК СтавкаНДС,
				|		РеализацияТоваровУслугТовары.СуммаНДС КАК СуммаНДС,
				|		РеализацияТоваровУслугТовары.СерияНоменклатуры.НомерГТД КАК НомерГТД,
				|		РеализацияТоваровУслугТовары.СерияНоменклатуры.СтранаПроисхождения КАК СтранаПроисхождения,
				|		РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС КАК СуммаВключаетНДС,
				|		РеализацияТоваровУслугТовары.Ссылка.УчитыватьНДС КАК УчитыватьНДС,
				|		РеализацияТоваровУслугТовары.ЕдиницаИзмерения.ЕдиницаПоКлассификатору КАК ЕдиницаИзмерения,
				|		РеализацияТоваровУслугТовары.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Код КАК КодЕдиницыИзмерения,
				|		РеализацияТоваровУслугТовары.ЕдиницаИзмеренияМест КАК ВидУпаковки,
				|		ВЫБОР
				|			КОГДА РеализацияТоваровУслугТовары.Коэффициент = 0
				|				Тогда 0
				|			ИНАЧЕ РеализацияТоваровУслугТовары.ЕдиницаИзмеренияМест.Коэффициент / РеализацияТоваровУслугТовары.Коэффициент
				|		КОНЕЦ КАК КоличествоВОдномМесте,
				|		РеализацияТоваровУслугТовары.КоличествоМест КАК КоличествоМест,
				|		ВЫБОР
				|			КОГДА РеализацияТоваровУслугТовары.КоличествоМест > 0
				|				Тогда РеализацияТоваровУслугТовары.КоличествоМест * РеализацияТоваровУслугТовары.ЕдиницаИзмеренияМест.Вес
				|			ИНАЧЕ РеализацияТоваровУслугТовары.Количество * РеализацияТоваровУслугТовары.ЕдиницаИзмерения.Вес
				|		КОНЕЦ КАК Масса,
				|		Ложь КАК ЭтоУслуга,
				|		""Property"" КАК ПризнакТРУ,
				|		1 КАК порядок
				|	ИЗ
				|		Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
				|	ГДЕ
				|		РеализацияТоваровУслугТовары.Ссылка = &Ссылка
				|
				|		  "+?(ФормированиеСФ, "", " ОБЪЕДИНИТЬ ВСЕ
				|  "+ТекстЗапросаТара()) +"
				|
				|	ОБЪЕДИНИТЬ ВСЕ
				|	
				|	ВЫБРАТЬ
				|		РеализацияТоваровУслугУслуги.НомерСтроки,
				|		ВЫБОР
				|			КОГДА ПОДСТРОКА(РеализацияТоваровУслугУслуги.Содержание, 1, 10) = """"
				|				Тогда РеализацияТоваровУслугУслуги.Номенклатура.Наименование
				|			ИНАЧЕ РеализацияТоваровУслугУслуги.Содержание
				|		КОНЕЦ,
				|		РеализацияТоваровУслугУслуги.Номенклатура.Ссылка,
				|		РеализацияТоваровУслугУслуги.Номенклатура.Код ,
				|		""""  КАК Характеристика,
				|		"""" КАК серия,
				|		РеализацияТоваровУслугУслуги.Количество,
				|		РеализацияТоваровУслугУслуги.Цена,
				|		РеализацияТоваровУслугУслуги.Сумма,
				|		РеализацияТоваровУслугУслуги.СтавкаНДС,
				|		РеализацияТоваровУслугУслуги.СуммаНДС,
				|		"""",
				|		"""",
				|		РеализацияТоваровУслугУслуги.Ссылка.СуммаВключаетНДС,
				|		РеализацияТоваровУслугУслуги.Ссылка.УчитыватьНДС,
				|		РеализацияТоваровУслугУслуги.Номенклатура.БазоваяЕдиницаИзмерения,
				|		РеализацияТоваровУслугУслуги.Номенклатура.БазоваяЕдиницаИзмерения.Код,
				|		"""",
				|		"""",
				|		"""",
				|		0,
				|		Истина,
				|		""Service"",
				|		3
				|	ИЗ
				|		Документ.РеализацияТоваровУслуг.Услуги КАК РеализацияТоваровУслугУслуги
				|	ГДЕ
				|		РеализацияТоваровУслугУслуги.Ссылка = &Ссылка) КАК подзапрос
				|
				|УПОРЯДОЧИТЬ ПО
				|	порядок,
				|	НомерСтроки";
				
			КонецФункции
			
			Функция ТЧПолучитьТекстЗапросаСчетФактураВыданный() Экспорт
				Возврат 	"ВЫБРАТЬ
				|	СчетФактураВыданныйАвансы.НомерСтроки КАК НомерСтроки,
				|	ВЫБОР
				|		КОГДА ПОДСТРОКА(СчетФактураВыданныйАвансы.Содержание, 1, 10) <> """" Тогда СчетФактураВыданныйАвансы.Содержание
				|		КОГДА СчетФактураВыданныйАвансы.Номенклатура <> Значение(Справочник.Номенклатура.ПустаяСсылка) и 
				|           ПОДСТРОКА(СчетФактураВыданныйАвансы.Номенклатура.НаименованиеПолное, 1, 10) <> """"
				|			Тогда СчетФактураВыданныйАвансы.Номенклатура.НаименованиеПолное
				|		КОГДА СчетФактураВыданныйАвансы.Номенклатура <> Значение(Справочник.Номенклатура.ПустаяСсылка)  
				|			Тогда СчетФактураВыданныйАвансы.Номенклатура.Наименование
				|  Иначе ""Предварительная оплата""
				|	КОНЕЦ КАК Номенклатура,
				|  СчетФактураВыданныйАвансы.Номенклатура.Ссылка КАК НоменклатураСсылка,
				|  СчетФактураВыданныйАвансы.Номенклатура.Код КАК КодНоменклатуры,
				|	0 как Количество,
				|	0 как Цена,
				|	СчетФактураВыданныйАвансы.Сумма,
				|	СчетФактураВыданныйАвансы.СтавкаНДС,
				|	СчетФактураВыданныйАвансы.СуммаНДС,
				|	"""" КАК НомерГТД,
				|	"""" КАК СтранаПроисхождения,
				|	"""" КАК Характеристика,
				|	"""" КАК Серия,
				|	0 КАК Масса,
				|	Истина КАК СуммаВключаетНДС,
				|	Истина КАК УчитыватьНДС,
				|	"""" КАК ЕдиницаИзмерения,
				|	"""" КАК КодЕдиницыИзмерения,
				|	"""" КАК ВидУпаковки,
				|	0 КАК КоличествоВОдномМесте,
				|	0  как КоличествоМест,
				|	Истина КАК ЭтоУслуга,
				|	""Service"" КАК ПризнакТРУ
				|ИЗ
				|	Документ.СчетФактураВыданный.Авансы КАК СчетФактураВыданныйАвансы
				|ГДЕ
				|	СчетФактураВыданныйАвансы.Ссылка = &СчетФактура
				|
				|УПОРЯДОЧИТЬ ПО
				|	НомерСтроки";
				
				
			КонецФункции 
			
			Функция ТЧПолучитьТекстЗапросаСчетНаоплатуПокупателю() Экспорт 
				Возврат  "ВЫБРАТЬ
				|	подзапрос.НомерСтроки КАК НомерСтроки,
				|	подзапрос.Номенклатура,
				|	подзапрос.НоменклатураСсылка,
				|	подзапрос.КодНоменклатуры,
				|	подзапрос.Характеристика,
				|	подзапрос.Серия,
				|	подзапрос.Количество,
				|	подзапрос.Цена,
				|	подзапрос.Сумма,
				|	подзапрос.СтавкаНДС,
				|	подзапрос.СуммаНДС,
				|	подзапрос.НомерГТД,
				|	подзапрос.СтранаПроисхождения,
				|	подзапрос.СуммаВключаетНДС,
				|	подзапрос.УчитыватьНДС,
				|	подзапрос.ЕдиницаИзмерения,
				|	подзапрос.КодЕдиницыИзмерения,
				|	подзапрос.ВидУпаковки,
				|	подзапрос.КоличествоВОдномМесте,
				|	подзапрос.КоличествоМест,
				|	подзапрос.Масса,
				|	подзапрос.ЭтоУслуга,
				|	подзапрос.ПризнакТРУ,
				|	подзапрос.порядок КАК порядок
				|ИЗ
				|	(ВЫБРАТЬ
				|		СчетНаоплатуТовары.НомерСтроки КАК НомерСтроки,
				|		ВЫБОР
				|			КОГДА ПОДСТРОКА(СчетНаоплатуТовары.Номенклатура.НаименованиеПолное, 1, 10) = """"
				|				Тогда СчетНаоплатуТовары.Номенклатура.Наименование
				|			ИНАЧЕ СчетНаоплатуТовары.Номенклатура.НаименованиеПолное
				|		КОНЕЦ КАК Номенклатура,
				|		СчетНаоплатуТовары.Номенклатура.Ссылка КАК НоменклатураСсылка,
				|		СчетНаоплатуТовары.Номенклатура.Код  КАК КодНоменклатуры,
				|		СчетНаоплатуТовары.ХарактеристикаНоменклатуры  КАК Характеристика,
				|		"""" КАК серия,
				|		СчетНаоплатуТовары.Количество КАК Количество,
				|		СчетНаоплатуТовары.Цена КАК Цена,
				|		СчетНаоплатуТовары.Сумма КАК Сумма,
				|		СчетНаоплатуТовары.СтавкаНДС КАК СтавкаНДС,
				|		СчетНаоплатуТовары.СуммаНДС КАК СуммаНДС,
				|		"""" КАК НомерГТД,
				|		"""" КАК СтранаПроисхождения,
				|		СчетНаоплатуТовары.Ссылка.СуммаВключаетНДС КАК СуммаВключаетНДС,
				|		СчетНаоплатуТовары.Ссылка.УчитыватьНДС КАК УчитыватьНДС,
				|		СчетНаоплатуТовары.ЕдиницаИзмерения.ЕдиницаПоКлассификатору КАК ЕдиницаИзмерения,
				|		СчетНаоплатуТовары.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Код КАК КодЕдиницыИзмерения,
				|		СчетНаоплатуТовары.ЕдиницаИзмеренияМест КАК ВидУпаковки,
				|		ВЫБОР
				|			КОГДА СчетНаоплатуТовары.Коэффициент = 0
				|				Тогда 0
				|			ИНАЧЕ СчетНаоплатуТовары.ЕдиницаИзмеренияМест.Коэффициент / СчетНаоплатуТовары.Коэффициент
				|		КОНЕЦ КАК КоличествоВОдномМесте,
				|		СчетНаоплатуТовары.КоличествоМест КАК КоличествоМест,
				|		ВЫБОР
				|			КОГДА СчетНаоплатуТовары.КоличествоМест > 0
				|				Тогда СчетНаоплатуТовары.КоличествоМест * СчетНаоплатуТовары.ЕдиницаИзмеренияМест.Вес
				|			ИНАЧЕ СчетНаоплатуТовары.Количество * СчетНаоплатуТовары.ЕдиницаИзмерения.Вес
				|		КОНЕЦ КАК Масса,
				|		Ложь КАК ЭтоУслуга,
				|		""Property"" КАК ПризнакТРУ,
				|		1 КАК порядок
				|	ИЗ
				|		Документ.СчетНаОплатуПокупателю.Товары КАК СчетНаоплатуТовары
				|	ГДЕ
				|		СчетНаоплатуТовары.Ссылка = &Ссылка
				|	
				|	ОБЪЕДИНИТЬ ВСЕ
				|	
				|	ВЫБРАТЬ
				|		СчетНаОплатуУслуги.НомерСтроки,
				|		ВЫБОР
				|			КОГДА ПОДСТРОКА(СчетНаОплатуУслуги.Содержание, 1, 10) = """"
				|				Тогда СчетНаОплатуУслуги.Номенклатура.Наименование
				|			ИНАЧЕ СчетНаОплатуУслуги.Содержание
				|		КОНЕЦ,
				|		СчетНаОплатуУслуги.Номенклатура.Ссылка ,
				|		СчетНаОплатуУслуги.Номенклатура.Код ,
				|		""""  КАК Характеристика,
				|		"""" КАК серия,
				|		СчетНаОплатуУслуги.Количество,
				|		СчетНаОплатуУслуги.Цена,
				|		СчетНаОплатуУслуги.Сумма,
				|		СчетНаОплатуУслуги.СтавкаНДС,
				|		СчетНаОплатуУслуги.СуммаНДС,
				|		"""",
				|		"""",
				|		СчетНаОплатуУслуги.Ссылка.СуммаВключаетНДС,
				|		СчетНаОплатуУслуги.Ссылка.УчитыватьНДС,
				|		СчетНаОплатуУслуги.Номенклатура.БазоваяЕдиницаИзмерения,
				|		СчетНаОплатуУслуги.Номенклатура.БазоваяЕдиницаИзмерения.Код,
				|		"""",
				|		"""",
				|		"""",
				|		"""",
				|		Истина,
				|		""Service"",
				|		2
				|	ИЗ
				|		Документ.СчетНаОплатуПокупателю.Услуги КАК СчетНаОплатуУслуги
				|	ГДЕ
				|		СчетНаОплатуУслуги.Ссылка = &Ссылка) КАК подзапрос
				|
				|УПОРЯДОЧИТЬ ПО
				|	порядок,
				|	НомерСтроки";
				
			КонецФункции		
			
			Функция ТЧПолучитьТекстЗапросаКорректировкаРеализации() Экспорт
				Возврат 	"ВЫБРАТЬ
				|	подзапрос.НомерСтроки КАК НомерСтроки,
				|	подзапрос.Номенклатура,
				|	подзапрос.НоменклатураСсылка КАК НоменклатураСсылка,
				|	подзапрос.КодНоменклатуры КАК КодНоменклатуры,
				|	подзапрос.Характеристика КАК Характеристика,
				|	подзапрос.серия КАК серия,
				|	подзапрос.Количество,
				|	подзапрос.Цена,
				|	подзапрос.Сумма,
				|	подзапрос.СтавкаНДС,
				|	подзапрос.СуммаНДС,
				|	подзапрос.НомерГТД,
				|	подзапрос.СтранаПроисхождения,
				|	подзапрос.СуммаВключаетНДС,
				|	подзапрос.УчитыватьНДС,
				|	подзапрос.ЕдиницаИзмерения,
				|	подзапрос.КодЕдиницыИзмерения КАК КодЕдиницыИзмерения,
				|	подзапрос.ВидУпаковки КАК ВидУпаковки,
				|	подзапрос.КоличествоВОдномМесте КАК КоличествоВОдномМесте,
				|	подзапрос.КоличествоМест КАК КоличествоМест,
				|	подзапрос.Масса КАК Масса,
				|	подзапрос.ЭтоУслуга,
				|	подзапрос.ПризнакТРУ,
				|	подзапрос.порядок КАК порядок
				|ИЗ
				|	(ВЫБРАТЬ
				|		КорректировкаРеализацииТовары.НомерСтроки КАК НомерСтроки,
				|		ВЫБОР
				|			КОГДА ПОДСТРОКА(КорректировкаРеализацииТовары.Номенклатура.НаименованиеПолное, 1, 10) = """"
				|				Тогда КорректировкаРеализацииТовары.Номенклатура.Наименование
				|			ИНАЧЕ КорректировкаРеализацииТовары.Номенклатура.НаименованиеПолное
				|		КОНЕЦ КАК Номенклатура,
				|		КорректировкаРеализацииТовары.Номенклатура.Ссылка КАК НоменклатураСсылка,
				|		КорректировкаРеализацииТовары.Номенклатура.Код КАК КодНоменклатуры,
				|		КорректировкаРеализацииТовары.ХарактеристикаНоменклатуры  КАК Характеристика,
				|		КорректировкаРеализацииТовары.СерияНоменклатуры КАК серия,
				|		КорректировкаРеализацииТовары.Количество КАК Количество,
				|		КорректировкаРеализацииТовары.Цена КАК Цена,
				|		КорректировкаРеализацииТовары.Сумма КАК Сумма,
				|		КорректировкаРеализацииТовары.СтавкаНДС КАК СтавкаНДС,
				|		КорректировкаРеализацииТовары.СуммаНДС КАК СуммаНДС,
				|		КорректировкаРеализацииТовары.СерияНоменклатуры.НомерГТД КАК НомерГТД,
				|		КорректировкаРеализацииТовары.СерияНоменклатуры.СтранаПроисхождения КАК СтранаПроисхождения,
				|		КорректировкаРеализацииТовары.Ссылка.СуммаВключаетНДС КАК СуммаВключаетНДС,
				|		КорректировкаРеализацииТовары.Ссылка.УчитыватьНДС КАК УчитыватьНДС,
				|		КорректировкаРеализацииТовары.ЕдиницаИзмерения.ЕдиницаПоКлассификатору КАК ЕдиницаИзмерения,
				|		КорректировкаРеализацииТовары.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Код КАК КодЕдиницыИзмерения,
				|		КорректировкаРеализацииТовары.ЕдиницаИзмеренияМест КАК ВидУпаковки,
				|		ВЫБОР
				|			КОГДА КорректировкаРеализацииТовары.Коэффициент = 0
				|				Тогда 0
				|			ИНАЧЕ КорректировкаРеализацииТовары.ЕдиницаИзмеренияМест.Коэффициент / КорректировкаРеализацииТовары.Коэффициент
				|		КОНЕЦ КАК КоличествоВОдномМесте,
				|		КорректировкаРеализацииТовары.КоличествоМест КАК КоличествоМест,
				|		ВЫБОР
				|			КОГДА КорректировкаРеализацииТовары.КоличествоМест > 0
				|				Тогда КорректировкаРеализацииТовары.КоличествоМест * КорректировкаРеализацииТовары.ЕдиницаИзмеренияМест.Вес
				|			ИНАЧЕ КорректировкаРеализацииТовары.Количество * КорректировкаРеализацииТовары.ЕдиницаИзмерения.Вес
				|		КОНЕЦ КАК Масса,
				|		Ложь КАК ЭтоУслуга,
				|		""Property"" КАК ПризнакТРУ,
				|		1 КАК порядок
				|	ИЗ
				|		Документ.КорректировкаРеализации.Товары КАК КорректировкаРеализацииТовары
				|	ГДЕ
				|		КорректировкаРеализацииТовары.Ссылка = &Ссылка
				|	
				|	ОБЪЕДИНИТЬ ВСЕ
				|	
				|	ВЫБРАТЬ
				|		КорректировкаРеализацииУслуги.НомерСтроки,
				|		ВЫБОР
				|			КОГДА ПОДСТРОКА(КорректировкаРеализацииУслуги.Содержание, 1, 10) = """"
				|				Тогда КорректировкаРеализацииУслуги.Номенклатура.Наименование
				|			ИНАЧЕ КорректировкаРеализацииУслуги.Содержание
				|		КОНЕЦ,
				|		КорректировкаРеализацииУслуги.Номенклатура.Ссылка КАК НоменклатураСсылка,
				|		КорректировкаРеализацииУслуги.Номенклатура.Код  КАК КодНоменклатуры,
				| """", """", //характеристика и серия
				|		КорректировкаРеализацииУслуги.Количество,
				|		КорректировкаРеализацииУслуги.Цена,
				|		КорректировкаРеализацииУслуги.Сумма,
				|		КорректировкаРеализацииУслуги.СтавкаНДС,
				|		КорректировкаРеализацииУслуги.СуммаНДС,
				|		"""",
				|		"""",
				|		КорректировкаРеализацииУслуги.Ссылка.СуммаВключаетНДС,
				|		КорректировкаРеализацииУслуги.Ссылка.УчитыватьНДС,
				|		КорректировкаРеализацииУслуги.Номенклатура.БазоваяЕдиницаИзмерения,
				|		КорректировкаРеализацииУслуги.Номенклатура.БазоваяЕдиницаИзмерения.Код КАК КодЕдиницыИзмерения,
				| """", """", """", 0, 
				|		Истина,
				|		""Service"",
				|		2
				|	ИЗ
				|		Документ.КорректировкаРеализации.Услуги КАК КорректировкаРеализацииУслуги
				|	ГДЕ
				|		КорректировкаРеализацииУслуги.Ссылка = &Ссылка) КАК подзапрос
				|
				|УПОРЯДОЧИТЬ ПО
				|	порядок,
				|	НомерСтроки";
				
			КонецФункции 
			
			Функция ТЧПолучитьТекстЗапросаИКСФ() Экспорт
				Возврат  "ВЫБРАТЬ
				|	подзапрос.НомерСтроки КАК НомерСтроки,
				|	подзапрос.Номенклатура,
				|	подзапрос.НоменклатураСсылка,
				|	подзапрос.Количество,
				|	подзапрос.Цена,
				|	подзапрос.Сумма,
				|	подзапрос.СтавкаНДС,
				|	подзапрос.СуммаНДС,
				|	подзапрос.НомерГТД,
				|	подзапрос.СтранаПроисхождения,
				|	подзапрос.СуммаВключаетНДС,
				|	подзапрос.УчитыватьНДС,
				|	подзапрос.ЕдиницаИзмерения,
				|	подзапрос.КодЕдиницыИзмерения,
				|	подзапрос.ЭтоУслуга,
				|	подзапрос.ПризнакТРУ,
				|	подзапрос.порядок КАК порядок,
				|	подзапрос.КоличествоДоИзменения,
				|	подзапрос.ЦенаДоИзменения,
				|	подзапрос.СуммаДоИзменения,
				|	подзапрос.СтавкаНДСДоИзменения,
				|	подзапрос.СуммаНДСДоИзменения,
				|	подзапрос.НомерГТДДоИзменения,
				|	подзапрос.СтранаПроисхожденияДоИзменения,
				|	подзапрос.ЕдиницаИзмеренияДоИзменения,
				|	подзапрос.КодЕдиницыИзмеренияДоИзменения
				|ИЗ
				|	(ВЫБРАТЬ
				|		КорректировкаРеализацииТовары.НомерСтроки КАК НомерСтроки,
				|		ВЫБОР
				|			КОГДА ПОДСТРОКА(КорректировкаРеализацииТовары.Номенклатура.НаименованиеПолное, 1, 10) = """"
				|				Тогда КорректировкаРеализацииТовары.Номенклатура.Наименование
				|			ИНАЧЕ КорректировкаРеализацииТовары.Номенклатура.НаименованиеПолное
				|		КОНЕЦ КАК Номенклатура,
				|		КорректировкаРеализацииТовары.Номенклатура.Ссылка КАК НоменклатураСсылка,
				|		КорректировкаРеализацииТовары.Количество КАК Количество,
				|		КорректировкаРеализацииТовары.Цена КАК Цена,
				|		КорректировкаРеализацииТовары.Сумма КАК Сумма,
				|		КорректировкаРеализацииТовары.СтавкаНДС КАК СтавкаНДС,
				|		КорректировкаРеализацииТовары.СуммаНДС КАК СуммаНДС,
				|		КорректировкаРеализацииТовары.СерияНоменклатуры.НомерГТД КАК НомерГТД,
				|		КорректировкаРеализацииТовары.СерияНоменклатуры.СтранаПроисхождения КАК СтранаПроисхождения,
				|		КорректировкаРеализацииТовары.Ссылка.СуммаВключаетНДС КАК СуммаВключаетНДС,
				|		КорректировкаРеализацииТовары.Ссылка.УчитыватьНДС КАК УчитыватьНДС,
				|		КорректировкаРеализацииТовары.ЕдиницаИзмерения.ЕдиницаПоКлассификатору КАК ЕдиницаИзмерения,
				|		КорректировкаРеализацииТовары.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Код КАК КодЕдиницыИзмерения,
				|		КорректировкаРеализацииТовары.ЕдиницаИзмерения.ЕдиницаПоКлассификатору КАК ЕдиницаИзмеренияДоИзменения,
				|		КорректировкаРеализацииТовары.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Код КАК КодЕдиницыИзмеренияДоИзменения,
				|		Ложь КАК ЭтоУслуга,
				|		""Property"" КАК ПризнакТРУ,
				|		1 КАК порядок,
				|		КорректировкаРеализацииТовары.КоличествоДоКорректировки КАК КоличествоДоИзменения,
				|		КорректировкаРеализацииТовары.ЦенаДоКорректировки КАК ЦенаДоИзменения,
				|		КорректировкаРеализацииТовары.СуммаДоКорректировки КАК СуммаДоИзменения,
				|		КорректировкаРеализацииТовары.СтавкаНДСДоИзменения КАК СтавкаНДСДоИзменения,
				|		КорректировкаРеализацииТовары.СуммаНДСДоКорректировки КАК СуммаНДСДоИзменения,
				|		NULL КАК СтранаПроисхожденияДоИзменения,
				|		NULL КАК НомерГТДДоИзменения
				|	ИЗ
				|		Документ.КорректировкаРеализации.Товары КАК КорректировкаРеализацииТовары
				|	ГДЕ
				|		КорректировкаРеализацииТовары.Ссылка = &Ссылка
				|	
				|	ОБЪЕДИНИТЬ ВСЕ
				|	
				|	ВЫБРАТЬ
				|		КорректировкаРеализацииУслуги.НомерСтроки,
				|		ВЫБОР
				|			КОГДА ПОДСТРОКА(КорректировкаРеализацииУслуги.Содержание, 1, 10) = """"
				|				Тогда КорректировкаРеализацииУслуги.Номенклатура.Наименование
				|			ИНАЧЕ КорректировкаРеализацииУслуги.Содержание
				|		КОНЕЦ,
				|		КорректировкаРеализацииУслуги.Номенклатура.Ссылка,
				|		КорректировкаРеализацииУслуги.Количество,
				|		КорректировкаРеализацииУслуги.Цена,
				|		КорректировкаРеализацииУслуги.Сумма,
				|		КорректировкаРеализацииУслуги.СтавкаНДС,
				|		КорректировкаРеализацииУслуги.СуммаНДС,
				|		"""",
				|		"""",
				|		КорректировкаРеализацииУслуги.Ссылка.СуммаВключаетНДС,
				|		КорректировкаРеализацииУслуги.Ссылка.УчитыватьНДС,
				|		КорректировкаРеализацииУслуги.Номенклатура.БазоваяЕдиницаИзмерения,
				|		КорректировкаРеализацииУслуги.Номенклатура.БазоваяЕдиницаИзмерения.Код,
				|		КорректировкаРеализацииУслуги.Номенклатура.БазоваяЕдиницаИзмерения,
				|		КорректировкаРеализацииУслуги.Номенклатура.БазоваяЕдиницаИзмерения.Код,
				|		Истина,
				|		""Service"",
				|		2,
				|		КорректировкаРеализацииУслуги.КоличествоДоКорректировки,
				|		КорректировкаРеализацииУслуги.ЦенаДоКорректировки,
				|		КорректировкаРеализацииУслуги.СуммаДоКорректировки,
				|		КорректировкаРеализацииУслуги.СтавкаНДСДоИзменения,
				|		КорректировкаРеализацииУслуги.СуммаНДСДоКорректировки,
				|		NULL,
				|		NULL
				|	ИЗ
				|		Документ.КорректировкаРеализации.Услуги КАК КорректировкаРеализацииУслуги
				|	ГДЕ
				|		КорректировкаРеализацииУслуги.Ссылка = &Ссылка) КАК подзапрос
				|
				|УПОРЯДОЧИТЬ ПО
				|	порядок,
				|	НомерСтроки";
				
			КонецФункции		
			
			Функция ТЧПолучитьТекстЗапросаКСФ() Экспорт
				Возврат  "ВЫБРАТЬ
				|	подзапрос.НомерСтроки КАК НомерСтроки,
				|	подзапрос.Номенклатура,
				|	подзапрос.НоменклатураСсылка,
				|	подзапрос.Количество,
				|	подзапрос.Цена,
				|	подзапрос.Сумма,
				|	подзапрос.СтавкаНДС,
				|	подзапрос.СуммаНДС,
				|	подзапрос.НомерГТД,
				|	подзапрос.СтранаПроисхождения,
				|	подзапрос.СуммаВключаетНДС,
				|	подзапрос.УчитыватьНДС,
				|	подзапрос.ЕдиницаИзмерения,
				|	подзапрос.КодЕдиницыИзмерения,
				|	подзапрос.ЭтоУслуга,
				|	подзапрос.ПризнакТРУ,
				|	подзапрос.порядок КАК порядок,
				|	подзапрос.КоличествоДоИзменения,
				|	подзапрос.ЦенаДоИзменения,
				|	подзапрос.СуммаДоИзменения,
				|	подзапрос.СтавкаНДСДоИзменения,
				|	подзапрос.СуммаНДСДоИзменения,
				|	подзапрос.НомерГТДДоИзменения,
				|	подзапрос.СтранаПроисхожденияДоИзменения,
				|	подзапрос.ЕдиницаИзмеренияДоИзменения,
				|	подзапрос.КодЕдиницыИзмеренияДоИзменения,
				|	подзапрос.Характеристика,
				|	подзапрос.Серия
				|ИЗ
				|	(ВЫБРАТЬ
				|		КорректировкаРеализацииТовары.НомерСтроки КАК НомерСтроки,
				|		ВЫБОР
				|			КОГДА ПОДСТРОКА(КорректировкаРеализацииТовары.Номенклатура.НаименованиеПолное, 1, 10) = """"
				|				Тогда КорректировкаРеализацииТовары.Номенклатура.Наименование
				|			ИНАЧЕ КорректировкаРеализацииТовары.Номенклатура.НаименованиеПолное
				|		КОНЕЦ КАК Номенклатура,
				|		КорректировкаРеализацииТовары.Номенклатура.Ссылка КАК НоменклатураСсылка,
				|		КорректировкаРеализацииТовары.Количество КАК Количество,
				|		КорректировкаРеализацииТовары.Цена КАК Цена,
				|		КорректировкаРеализацииТовары.Сумма КАК Сумма,
				|		КорректировкаРеализацииТовары.СтавкаНДС КАК СтавкаНДС,
				|		КорректировкаРеализацииТовары.СуммаНДС КАК СуммаНДС,
				|		КорректировкаРеализацииТовары.СерияНоменклатуры.НомерГТД КАК НомерГТД,
				|		КорректировкаРеализацииТовары.СерияНоменклатуры.СтранаПроисхождения КАК СтранаПроисхождения,
				|		КорректировкаРеализацииТовары.Ссылка.СуммаВключаетНДС КАК СуммаВключаетНДС,
				|		КорректировкаРеализацииТовары.Ссылка.УчитыватьНДС КАК УчитыватьНДС,
				|		КорректировкаРеализацииТовары.ЕдиницаИзмерения.ЕдиницаПоКлассификатору КАК ЕдиницаИзмерения,
				|		КорректировкаРеализацииТовары.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Код КАК КодЕдиницыИзмерения,
				|		КорректировкаРеализацииТовары.ЕдиницаИзмерения.ЕдиницаПоКлассификатору КАК ЕдиницаИзмеренияДоИзменения,
				|		КорректировкаРеализацииТовары.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Код КАК КодЕдиницыИзмеренияДоИзменения,
				|		Ложь КАК ЭтоУслуга,
				|		""Property"" КАК ПризнакТРУ,
				|		1 КАК порядок,
				|		КорректировкаРеализацииТовары.КоличествоДоИзменения КАК КоличествоДоИзменения,
				|		КорректировкаРеализацииТовары.ЦенаДоИзменения КАК ЦенаДоИзменения,
				|		КорректировкаРеализацииТовары.СуммаДоИзменения КАК СуммаДоИзменения,
				|		КорректировкаРеализацииТовары.СтавкаНДСДоИзменения КАК СтавкаНДСДоИзменения,
				|		КорректировкаРеализацииТовары.СуммаНДСДоИзменения КАК СуммаНДСДоИзменения,
				|		NULL КАК СтранаПроисхожденияДоИзменения,
				|		NULL КАК НомерГТДДоИзменения,
				|		КорректировкаРеализацииТовары.ХарактеристикаНоменклатуры КАК Характеристика,
				|		КорректировкаРеализацииТовары.СерияНоменклатуры КАК Серия
				|	ИЗ
				|		Документ.КорректировкаРеализации.Товары КАК КорректировкаРеализацииТовары
				|	ГДЕ
				|		КорректировкаРеализацииТовары.Ссылка = &Ссылка
				|	
				|	ОБЪЕДИНИТЬ ВСЕ
				|	
				|	ВЫБРАТЬ
				|		КорректировкаРеализацииУслуги.НомерСтроки,
				|		ВЫБОР
				|			КОГДА ПОДСТРОКА(КорректировкаРеализацииУслуги.Содержание, 1, 10) = """"
				|				Тогда КорректировкаРеализацииУслуги.Номенклатура.Наименование
				|			ИНАЧЕ КорректировкаРеализацииУслуги.Содержание
				|		КОНЕЦ,
				|		КорректировкаРеализацииУслуги.Номенклатура.Ссылка,
				|		КорректировкаРеализацииУслуги.Количество,
				|		КорректировкаРеализацииУслуги.Цена,
				|		КорректировкаРеализацииУслуги.Сумма,
				|		КорректировкаРеализацииУслуги.СтавкаНДС,
				|		КорректировкаРеализацииУслуги.СуммаНДС,
				|		"""",
				|		"""",
				|		КорректировкаРеализацииУслуги.Ссылка.СуммаВключаетНДС,
				|		КорректировкаРеализацииУслуги.Ссылка.УчитыватьНДС,
				|		КорректировкаРеализацииУслуги.Номенклатура.БазоваяЕдиницаИзмерения,
				|		КорректировкаРеализацииУслуги.Номенклатура.БазоваяЕдиницаИзмерения.Код,
				|		КорректировкаРеализацииУслуги.Номенклатура.БазоваяЕдиницаИзмерения,
				|		КорректировкаРеализацииУслуги.Номенклатура.БазоваяЕдиницаИзмерения.Код,
				|		Истина,
				|		""Service"",
				|		2,
				|		КорректировкаРеализацииУслуги.КоличествоДоИзменения,
				|		КорректировкаРеализацииУслуги.ЦенаДоИзменения,
				|		КорректировкаРеализацииУслуги.СуммаДоИзменения,
				|		КорректировкаРеализацииУслуги.СтавкаНДСДоИзменения,
				|		КорректировкаРеализацииУслуги.СуммаНДСДоИзменения,
				|		NULL,
				|		NULL,
				|		"""" КАК Характеристика,
				|		"""" КАК Серия
				|	ИЗ
				|		Документ.КорректировкаРеализации.Услуги КАК КорректировкаРеализацииУслуги
				|	ГДЕ
				|		КорректировкаРеализацииУслуги.Ссылка = &Ссылка) КАК подзапрос
				|
				|УПОРЯДОЧИТЬ ПО
				|	порядок,
				|	НомерСтроки";
				
			КонецФункции
			
			Функция ТЧПолучитьТекстЗапросаАктОбОказанииПроизводственныхУслуг() Экспорт
				Возврат 	"ВЫБРАТЬ
				|	АктОбОказанииПроизводственныхУслугУслуги.НомерСтроки КАК НомерСтроки,
				|	ВЫБОР
				|		КОГДА ПОДСТРОКА(АктОбОказанииПроизводственныхУслугУслуги.Содержание, 1, 10) = """"
				|			Тогда АктОбОказанииПроизводственныхУслугУслуги.Номенклатура.Наименование
				|		ИНАЧЕ АктОбОказанииПроизводственныхУслугУслуги.Содержание
				|	КОНЕЦ КАК Номенклатура,
				|	АктОбОказанииПроизводственныхУслугУслуги.Номенклатура.Ссылка как НоменклатураСсылка,
				|	АктОбОказанииПроизводственныхУслугУслуги.Номенклатура.Код КодНоменклатуры,
				|	АктОбОказанииПроизводственныхУслугУслуги.Количество,
				|	АктОбОказанииПроизводственныхУслугУслуги.Цена,
				|	АктОбОказанииПроизводственныхУслугУслуги.Сумма,
				|	АктОбОказанииПроизводственныхУслугУслуги.СтавкаНДС,
				|	АктОбОказанииПроизводственныхУслугУслуги.СуммаНДС,
				|	АктОбОказанииПроизводственныхУслугУслуги.Ссылка.СуммаВключаетНДС,
				|	АктОбОказанииПроизводственныхУслугУслуги.Ссылка.УчитыватьНДС,
				|	"""" КАК НомерГТД,
				|	"""" КАК СтранаПроисхождения,
				|	АктОбОказанииПроизводственныхУслугУслуги.Номенклатура.БазоваяЕдиницаИзмерения КАК ЕдиницаИзмерения,
				|	АктОбОказанииПроизводственныхУслугУслуги.Номенклатура.БазоваяЕдиницаИзмерения.Код КАК КодЕдиницыИзмерения,
				|	"""" КАК ВидУпаковки,
				|	"""" КАК КоличествоВОдномМесте,
				|	"""" КАК КоличествоМест,
				|	0 КАК Масса,
				|	"""" КАК Характеристика,
				|	"""" КАК Серия,
				|	Истина КАК ЭтоУслуга,
				|	""Job"" КАК ПризнакТРУ
				|ИЗ
				|	Документ.АктОбОказанииПроизводственныхУслуг.Услуги КАК АктОбОказанииПроизводственныхУслугУслуги
				|ГДЕ
				|	АктОбОказанииПроизводственныхУслугУслуги.Ссылка = &Ссылка
				|
				|УПОРЯДОЧИТЬ ПО
				|	НомерСтроки"
				
				
			КонецФункции 
			
			Функция ТЧПолучитьТекстЗапросаОтчетКомиссионераОПродажах() Экспорт
				Возврат	"ВЫБРАТЬ
				|	ВложенныйЗапрос.НомерСтроки,
				|	ВложенныйЗапрос.Номенклатура,
				|	ВложенныйЗапрос.НоменклатураСсылка,
				|	ВложенныйЗапрос.КодНоменклатуры,
				|	ВложенныйЗапрос.Количество,
				|	ВложенныйЗапрос.Цена,
				|	ВложенныйЗапрос.Сумма,
				|	ВложенныйЗапрос.СтавкаНДС,
				|	ВложенныйЗапрос.НомерГТД,
				|	ВложенныйЗапрос.СтранаПроисхождения,
				|	ВложенныйЗапрос.СуммаВключаетНДС,
				|	ВложенныйЗапрос.УчитыватьНДС,
				|	ВложенныйЗапрос.ЕдиницаИзмерения,
				|	ВложенныйЗапрос.КодЕдиницыИзмерения,
				|	ВложенныйЗапрос.ВидУпаковки,
				|	ВложенныйЗапрос.КоличествоВОдномМесте,
				|	ВложенныйЗапрос.КоличествоМест,
				|	ВложенныйЗапрос.Масса,
				|	ВложенныйЗапрос.Характеристика,
				|	ВложенныйЗапрос.Серия,
				|	ВложенныйЗапрос.ЭтоУслуга,
				|	""Property"" КАК ПризнакТРУ,
				|	ВложенныйЗапрос.Порядок,
				|	ВложенныйЗапрос.СуммаНДС
				|ИЗ
				|	Документ.ОтчетКомиссионераОПродажах.Покупатели КАК ОтчетКомиссионераОПродажахПокупатели
				|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
				|			ОтчетКомиссионераОПродажахТовары.НомерСтроки,
				|			ВЫБОР
				|				КОГДА ПОДСТРОКА(ОтчетКомиссионераОПродажахТовары.Номенклатура.НаименованиеПолное, 1, 10) = """"
				|					Тогда ОтчетКомиссионераОПродажахТовары.Номенклатура.Наименование
				|				ИНАЧЕ ОтчетКомиссионераОПродажахТовары.Номенклатура.НаименованиеПолное
				|			КОНЕЦ КАК Номенклатура,
				|			ОтчетКомиссионераОПродажахТовары.Номенклатура.Ссылка как  НоменклатураСсылка,
				|			ОтчетКомиссионераОПродажахТовары.Номенклатура.Код как  КодНоменклатуры,
				|			ОтчетКомиссионераОПродажахТовары.Количество,
				|			ОтчетКомиссионераОПродажахТовары.Цена,
				|			ОтчетКомиссионераОПродажахТовары.Сумма,
				|			ОтчетКомиссионераОПродажахТовары.СтавкаНДС,
				|			ОтчетКомиссионераОПродажахТовары.СерияНоменклатуры.НомерГТД КАК НомерГТД,
				|			ОтчетКомиссионераОПродажахТовары.СерияНоменклатуры.СтранаПроисхождения КАК СтранаПроисхождения,
				|			ОтчетКомиссионераОПродажахТовары.Ссылка.СуммаВключаетНДС,
				|			ОтчетКомиссионераОПродажахТовары.Ссылка.УчитыватьНДС,
				|			ОтчетКомиссионераОПродажахТовары.ЕдиницаИзмерения.ЕдиницаПоКлассификатору как ЕдиницаИзмерения,
				|			ОтчетКомиссионераОПродажахТовары.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Код КАК КодЕдиницыИзмерения,
				|			"""" КАК ВидУпаковки,
				|			"""" КАК КоличествоВОдномМесте,
				|			"""" КАК КоличествоМест,
				|			0 КАК Масса,
				|			"""" КАК Характеристика,
				|			"""" КАК Серия,
				|			Ложь КАК ЭтоУслуга,
				|			1 КАК Порядок,
				|			ОтчетКомиссионераОПродажахТовары.СуммаНДС,
				|			ОтчетКомиссионераОПродажахТовары.КлючСтроки КАК КлючСтроки
				|		ИЗ
				|			Документ.ОтчетКомиссионераОПродажах.Товары КАК ОтчетКомиссионераОПродажахТовары
				|		ГДЕ
				|			ОтчетКомиссионераОПродажахТовары.Ссылка = &Ссылка) КАК ВложенныйЗапрос
				|		ПО ОтчетКомиссионераОПродажахПокупатели.КлючСтроки = ВложенныйЗапрос.КлючСтроки
				|ГДЕ
				|	ОтчетКомиссионераОПродажахПокупатели.СчетФактура = &СчетФактура";			
				
			КонецФункции 
			
			Функция ТЧПолучитьТекстЗапросаОтчетКомитентуОПродажах() Экспорт
				Возврат  "ВЫБРАТЬ
				|	подзапрос.Сумма,
				|	подзапрос.СуммаНДС,
				|	подзапрос.Количество,
				|	подзапрос.Цена,
				|	подзапрос.НомерГТД,
				|	подзапрос.СтранаПроисхождения,
				|	подзапрос.СуммаВключаетНДС,
				|	подзапрос.ЕдиницаИзмерения,
				|	"""" КАК КодЕдиницыИзмерения,
				|	"""" КАК ВидУпаковки,
				|	"""" КАК КоличествоВОдномМесте,
				|	"""" КАК КоличествоМест,
				|	0 КАК Масса,
				|	"""" КАК Характеристика,
				|	"""" КАК Серия,
				|	подзапрос.ЭтоУслуга,
				|	""Service"" КАК ПризнакТРУ,
				|	ВЫБОР
				|		КОГДА подзапрос.Номенклатура = ЗНАЧЕНИЕ(Справочник.номенклатура.ПустаяСсылка)
				|			Тогда ""Комиссионное вознаграждение""
				|		КОГДА ПОДСТРОКА(подзапрос.Номенклатура.НаименованиеПолное, 1, 10) = """"
				|			Тогда подзапрос.Номенклатура.Наименование
				|		ИНАЧЕ подзапрос.Номенклатура.НаименованиеПолное
				|	КОНЕЦ КАК Номенклатура,
				|	подзапрос.Номенклатура.Ссылка как  НоменклатураСсылка,
				|	подзапрос.Номенклатура.Код как  КодНоменклатуры,
				|	подзапрос.Ссылка.СтавкаНДСВознаграждения КАК СтавкаНДС
				|ИЗ
				|	(ВЫБРАТЬ
				|		СУММА(ОтчетКомитентуОПродажахТовары.СуммаВознаграждения) КАК Сумма,
				|		СУММА(ОтчетКомитентуОПродажахТовары.СуммаНДСВознаграждения) КАК СуммаНДС,
				|		ОтчетКомитентуОПродажахТовары.Ссылка.УслугаПоВознаграждению КАК Номенклатура,
				|		ОтчетКомитентуОПродажахТовары.Ссылка КАК Ссылка,
				|		0 КАК Количество,
				|		0 КАК Цена,
				|		"""" КАК НомерГТД,
				|		"""" КАК СтранаПроисхождения,
				|		Истина КАК СуммаВключаетНДС,
				|		"""" КАК ЕдиницаИзмерения,
				|		Истина КАК ЭтоУслуга
				|	ИЗ
				|		Документ.ОтчетКомитентуОПродажах.Товары КАК ОтчетКомитентуОПродажахТовары
				|	ГДЕ
				|		ОтчетКомитентуОПродажахТовары.Ссылка = &Ссылка
				|	
				|	СГРУППИРОВАТЬ ПО
				|		ОтчетКомитентуОПродажахТовары.Ссылка,
				|		ОтчетКомитентуОПродажахТовары.Ссылка.УслугаПоВознаграждению) КАК подзапрос"; 		
				
			КонецФункции	
			
			Функция ТЧПолучитьТекстЗапросаВозвратТоваровПоставщику() Экспорт
				Возврат "ВЫБРАТЬ
				|	ВозвратТоваровПоставщикуТовары.НомерСтроки КАК НомерСтроки,
				|	ВЫБОР
				|		КОГДА ПОДСТРОКА(ВозвратТоваровПоставщикуТовары.Номенклатура.НаименованиеПолное, 1, 10) = """"
				|			Тогда ВозвратТоваровПоставщикуТовары.Номенклатура.Наименование
				|		ИНАЧЕ ВозвратТоваровПоставщикуТовары.Номенклатура.НаименованиеПолное
				|	КОНЕЦ КАК Номенклатура,
				|	ВозвратТоваровПоставщикуТовары.Номенклатура.Ссылка КАК НоменклатураСсылка,
				|	ВозвратТоваровПоставщикуТовары.Номенклатура.Код КАК КодНоменклатуры,
				|	ВозвратТоваровПоставщикуТовары.ХарактеристикаНоменклатуры КАК Характеристика,
				|	ВозвратТоваровПоставщикуТовары.СерияНоменклатуры КАК Серия,
				|	ВозвратТоваровПоставщикуТовары.Количество,
				|	ВозвратТоваровПоставщикуТовары.Цена,
				|	ВозвратТоваровПоставщикуТовары.Сумма,
				|	ВозвратТоваровПоставщикуТовары.СтавкаНДС,
				|	ВозвратТоваровПоставщикуТовары.СерияНоменклатуры.НомерГТД КАК НомерГТД,
				|	ВозвратТоваровПоставщикуТовары.СерияНоменклатуры.СтранаПроисхождения КАК СтранаПроисхождения,
				|	ВозвратТоваровПоставщикуТовары.СуммаНДС КАК суммаНДС,
				|	ВозвратТоваровПоставщикуТовары.ЕдиницаИзмерения.ЕдиницаПоКлассификатору КАК ЕдиницаИзмерения,
				|	ВозвратТоваровПоставщикуТовары.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Код КАК КодЕдиницыИзмерения,
				|	ВозвратТоваровПоставщикуТовары.ЕдиницаИзмеренияМест КАК ВидУпаковки,
				|	ВЫБОР
				|		КОГДА ВозвратТоваровПоставщикуТовары.Коэффициент = 0
				|			Тогда 0
				|		ИНАЧЕ ВозвратТоваровПоставщикуТовары.ЕдиницаИзмеренияМест.Коэффициент / ВозвратТоваровПоставщикуТовары.Коэффициент
				|	КОНЕЦ КАК КоличествоВОдномМесте,
				|	ВозвратТоваровПоставщикуТовары.КоличествоМест КАК КоличествоМест,
				|	ВЫБОР
				|		КОГДА ВозвратТоваровПоставщикуТовары.КоличествоМест > 0
				|			Тогда ВозвратТоваровПоставщикуТовары.КоличествоМест * ВозвратТоваровПоставщикуТовары.ЕдиницаИзмеренияМест.Вес
				|		ИНАЧЕ ВозвратТоваровПоставщикуТовары.Количество * ВозвратТоваровПоставщикуТовары.ЕдиницаИзмерения.Вес
				|	КОНЕЦ КАК Масса,
				|	ВозвратТоваровПоставщикуТовары.Ссылка.СуммаВключаетНДС КАК СуммаВключаетНДС,
				|	ВозвратТоваровПоставщикуТовары.Ссылка.УчитыватьНДС КАК УчитыватьНДС,
				|	Ложь КАК ЭтоУслуга,
				|	""Property"" КАК ПризнакТРУ
				|ИЗ
				|	Документ.ВозвратТоваровПоставщику.Товары КАК ВозвратТоваровПоставщикуТовары
				|ГДЕ
				|	ВозвратТоваровПоставщикуТовары.Ссылка = &Ссылка
				|
				|УПОРЯДОЧИТЬ ПО
				|	НомерСтроки";
				
			КонецФункции 
			
			Функция ТЧПолучитьТекстЗапросаОтражениеРеализацииТоваровИУслугНДС() Экспорт
				Возврат  "ВЫБРАТЬ
				|	ОтражениеРеализацииТоваровИУслугНДС.НомерСтроки КАК НомерСтроки,
				|	ВЫБОР
				|  когда ОтражениеРеализацииТоваровИУслугНДС.Номенклатура ссылка справочник.ОбъектыСтроительства
				|  Тогда ОтражениеРеализацииТоваровИУслугНДС.Номенклатура.наименование
				|		КОГДА ПОДСТРОКА(ОтражениеРеализацииТоваровИУслугНДС.Номенклатура.НаименованиеПолное, 1, 10) = """"
				|			Тогда ОтражениеРеализацииТоваровИУслугНДС.Номенклатура.Наименование
				|		ИНАЧЕ ОтражениеРеализацииТоваровИУслугНДС.Номенклатура.НаименованиеПолное
				|	КОНЕЦ КАК Номенклатура,
				|	ОтражениеРеализацииТоваровИУслугНДС.Номенклатура.Ссылка КАК НоменклатураСсылка,
				|	ОтражениеРеализацииТоваровИУслугНДС.Номенклатура.Код  КАК КодНоменклатуры,
				|	ОтражениеРеализацииТоваровИУслугНДС.ХарактеристикаНоменклатуры КАК Характеристика,
				|	ОтражениеРеализацииТоваровИУслугНДС.СерияНоменклатуры КАК Серия,
				|	ОтражениеРеализацииТоваровИУслугНДС.Количество,
				|	ОтражениеРеализацииТоваровИУслугНДС.Цена,
				|	ОтражениеРеализацииТоваровИУслугНДС.Сумма,
				|	ОтражениеРеализацииТоваровИУслугНДС.СтавкаНДС,
				|	ОтражениеРеализацииТоваровИУслугНДС.СерияНоменклатуры.НомерГТД КАК НомерГТД,
				|	ОтражениеРеализацииТоваровИУслугНДС.СерияНоменклатуры.СтранаПроисхождения КАК СтранаПроисхождения,
				|	ОтражениеРеализацииТоваровИУслугНДС.СуммаНДС КАК суммаНДС,
				|	ОтражениеРеализацииТоваровИУслугНДС.ЕдиницаИзмерения.ЕдиницаПоКлассификатору КАК ЕдиницаИзмерения,
				|	ОтражениеРеализацииТоваровИУслугНДС.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Код КАК КодЕдиницыИзмерения,
				|	"""" КАК ВидУпаковки,
				|	"""" КАК КоличествоВОдномМесте,
				|	"""" КАК КоличествоМест,
				|	0 КАК Масса,
				|	ОтражениеРеализацииТоваровИУслугНДС.Ссылка.СуммаВключаетНДС КАК СуммаВключаетНДС,
				|	Истина КАК УчитыватьНДС,
				|	выбор когда ОтражениеРеализацииТоваровИУслугНДС.Номенклатура.видНоменклатуры.ТипНоменклатуры=значение(Перечисление.ТипыНоменклатуры.Услуга) Тогда Истина иначе Ложь конец КАК ЭтоУслуга,
				|	выбор когда ОтражениеРеализацииТоваровИУслугНДС.Номенклатура.видНоменклатуры.ТипНоменклатуры=значение(Перечисление.ТипыНоменклатуры.Услуга) Тогда ""Service"" иначе ""Property"" конец КАК ПризнакТРУ
				|ИЗ
				|	Документ.ОтражениеРеализацииТоваровИУслугНДС.ТоварыИУслуги КАК ОтражениеРеализацииТоваровИУслугНДС
				|ГДЕ
				|	ОтражениеРеализацииТоваровИУслугНДС.Ссылка = &Ссылка
				|
				|УПОРЯДОЧИТЬ ПО
				|	НомерСтроки";
				
				
			КонецФункции
			
			Функция ТЧПолучитьТекстЗапросаРеализацияУслугПопереработке() Экспорт
				Возврат  "ВЫБРАТЬ
				|	подзапрос.НомерСтроки КАК НомерСтроки,
				|	подзапрос.Номенклатура,
				|	подзапрос.КодНоменклатуры,
				|	подзапрос.НоменклатураСсылка,
				|	подзапрос.Характеристика,
				|	подзапрос.Серия,
				|	подзапрос.Количество,
				|	подзапрос.Цена,
				|	подзапрос.Сумма,
				|	подзапрос.СтавкаНДС,
				|	подзапрос.СуммаНДС,
				|	подзапрос.НомерГТД,
				|	подзапрос.СтранаПроисхождения,
				|	подзапрос.СуммаВключаетНДС,
				|	подзапрос.УчитыватьНДС,
				|	подзапрос.ЕдиницаИзмерения,
				|	подзапрос.КодЕдиницыИзмерения,
				|	подзапрос.ВидУпаковки,
				|	подзапрос.КоличествоВОдномМесте,
				|	подзапрос.КоличествоМест,
				|	подзапрос.Масса,
				|	подзапрос.ЭтоУслуга,
				|	подзапрос.ПризнакТРУ,
				|	подзапрос.Порядок КАК Порядок
				|ИЗ
				|	(ВЫБРАТЬ
				|		РеализацияУслугПоПереработкеУслуги.НомерСтроки КАК НомерСтроки,
				|		ВЫБОР
				|			КОГДА ПОДСТРОКА(РеализацияУслугПоПереработкеУслуги.Содержание, 1, 10) = """"
				|				Тогда РеализацияУслугПоПереработкеУслуги.Номенклатура.Наименование
				|			ИНАЧЕ РеализацияУслугПоПереработкеУслуги.Содержание
				|		КОНЕЦ КАК Номенклатура,
				|		РеализацияУслугПоПереработкеУслуги.Номенклатура.Ссылка КАК НоменклатураСсылка,
				|		РеализацияУслугПоПереработкеУслуги.Номенклатура.код КАК КодНоменклатуры,
				|      """" как Характеристика,
				|      """" как Серия,
				|		РеализацияУслугПоПереработкеУслуги.Количество КАК Количество,
				|		РеализацияУслугПоПереработкеУслуги.Цена КАК Цена,
				|		РеализацияУслугПоПереработкеУслуги.Сумма КАК Сумма,
				|		РеализацияУслугПоПереработкеУслуги.СтавкаНДС КАК СтавкаНДС,
				|		РеализацияУслугПоПереработкеУслуги.СуммаНДС КАК СуммаНДС,
				|		"""" КАК НомерГТД,
				|		"""" КАК СтранаПроисхождения,
				|		РеализацияУслугПоПереработкеУслуги.Ссылка.СуммаВключаетНДС КАК СуммаВключаетНДС,
				|		РеализацияУслугПоПереработкеУслуги.Ссылка.УчитыватьНДС КАК УчитыватьНДС,
				|		РеализацияУслугПоПереработкеУслуги.Номенклатура.БазоваяЕдиницаИзмерения КАК ЕдиницаИзмерения,
				|		РеализацияУслугПоПереработкеУслуги.Номенклатура.БазоваяЕдиницаИзмерения.код КАК КодЕдиницыИзмерения,
				|		"""" как ВидУпаковки, 
				|		"""" как КоличествоВОдномМесте, 
				|		"""" как КоличествоМест, 
				|		0 как Масса, 
				|		Истина КАК ЭтоУслуга,
				|		""Job"" КАК ПризнакТРУ,
				|		2 КАК Порядок
				|	ИЗ
				|		Документ.РеализацияУслугПоПереработке.Услуги КАК РеализацияУслугПоПереработкеУслуги
				|	ГДЕ
				|		РеализацияУслугПоПереработкеУслуги.Ссылка = &Ссылка
				|	
				|	ОБЪЕДИНИТЬ ВСЕ
				|	
				|	ВЫБРАТЬ
				|		РеализацияУслугПоПереработкеПродукция.НомерСтроки,
				|		ВЫБОР
				|			КОГДА ПОДСТРОКА(РеализацияУслугПоПереработкеПродукция.Номенклатура.НаименованиеПолное, 1, 10) = """"
				|				Тогда РеализацияУслугПоПереработкеПродукция.Номенклатура.Наименование
				|			ИНАЧЕ РеализацияУслугПоПереработкеПродукция.Номенклатура.НаименованиеПолное
				|		КОНЕЦ,
				|		РеализацияУслугПоПереработкеПродукция.Номенклатура.Ссылка КАК НоменклатураСсылка,
				|		РеализацияУслугПоПереработкеПродукция.Номенклатура.Код КАК КодНоменклатуры,
				|		РеализацияУслугПоПереработкеПродукция.ХарактеристикаНоменклатуры КАК Характеристика,
				|		РеализацияУслугПоПереработкеПродукция.СерияНоменклатуры КАК Серия,
				|		РеализацияУслугПоПереработкеПродукция.Количество,
				|		РеализацияУслугПоПереработкеПродукция.Цена,
				|		РеализацияУслугПоПереработкеПродукция.Сумма,
				|		РеализацияУслугПоПереработкеПродукция.СтавкаНДС,
				|		РеализацияУслугПоПереработкеПродукция.СуммаНДС,
				|		РеализацияУслугПоПереработкеПродукция.СерияНоменклатуры.НомерГТД,
				|		РеализацияУслугПоПереработкеПродукция.СерияНоменклатуры.СтранаПроисхождения,
				|		РеализацияУслугПоПереработкеПродукция.Ссылка.СуммаВключаетНДС,
				|		РеализацияУслугПоПереработкеПродукция.Ссылка.УчитыватьНДС,
				|		РеализацияУслугПоПереработкеПродукция.ЕдиницаИзмерения.ЕдиницаПоКлассификатору,		  
				|	РеализацияУслугПоПереработкеПродукция.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Код КАК КодЕдиницыИзмерения,
				|	РеализацияУслугПоПереработкеПродукция.ЕдиницаИзмеренияМест КАК ВидУпаковки,
				|	ВЫБОР
				|		КОГДА РеализацияУслугПоПереработкеПродукция.Коэффициент = 0
				|			Тогда 0
				|		ИНАЧЕ РеализацияУслугПоПереработкеПродукция.ЕдиницаИзмеренияМест.Коэффициент / РеализацияУслугПоПереработкеПродукция.Коэффициент
				|	КОНЕЦ КАК КоличествоВОдномМесте,
				|	РеализацияУслугПоПереработкеПродукция.КоличествоМест КАК КоличествоМест,
				|	ВЫБОР
				|		КОГДА РеализацияУслугПоПереработкеПродукция.КоличествоМест > 0
				|			Тогда РеализацияУслугПоПереработкеПродукция.КоличествоМест * РеализацияУслугПоПереработкеПродукция.ЕдиницаИзмеренияМест.Вес
				|		ИНАЧЕ РеализацияУслугПоПереработкеПродукция.Количество * РеализацияУслугПоПереработкеПродукция.ЕдиницаИзмерения.Вес
				|	КОНЕЦ КАК Масса,
				
				|		Истина,
				|		""Property"",
				|		1
				|	ИЗ
				|		Документ.РеализацияУслугПоПереработке.Продукция КАК РеализацияУслугПоПереработкеПродукция
				|	ГДЕ
				|		РеализацияУслугПоПереработкеПродукция.Ссылка = &Ссылка) КАК подзапрос
				|
				|УПОРЯДОЧИТЬ ПО
				|	Порядок,
				|	НомерСтроки";
				
			КонецФункции 
			
			Функция ТЧПолучитьТекстЗапросаПередачаОС() Экспорт
				Возврат  "ВЫБРАТЬ
				|	ПередачаОС.НомерСтроки КАК НомерСтроки,
				|	ПередачаОС.ОсновноеСредство.Наименование КАК Номенклатура,
				|	ПередачаОС.ОсновноеСредство.Код КАК КодНоменклатуры,
				| """" как Характеристика,
				| """" как Серия,
				|	1 КАК Количество,
				|	0 КАК цена,
				|	ПередачаОС.Сумма,
				|	ПередачаОС.СтавкаНДС,
				|	ПередачаОС.СуммаНДС,
				|	"""" КАК НомерГТД,
				|	"""" КАК СтранаПроисхождения,
				|	ПередачаОС.Ссылка.СуммаВключаетНДС КАК СуммаВключаетНДС,
				|	ПередачаОС.Ссылка.УчитыватьНДС КАК УчитыватьНДС,
				|	"""" КАК ЕдиницаИзмерения,
				|	"""" КАК КодЕдиницыИзмерения,
				|	"""" КАК ВидУпаковки,
				|	0 КАК Масса,
				|	0 КАК КоличествоВОдномМесте,
				|	0 КАК КоличествоМест,
				|	Ложь КАК ЭтоУслуга,
				|	""Property"" КАК ПризнакТРУ
				|ИЗ
				|	Документ.ПередачаОС.ОС КАК ПередачаОС
				|ГДЕ
				|	ПередачаОС.Ссылка = &Ссылка
				|
				|УПОРЯДОЧИТЬ ПО
				|	НомерСтроки";	
				
			КонецФункции	
			
			Функция ТЧПолучитьТекстЗапросаЗаказПокупателя() Экспорт
				Возврат "ВЫБРАТЬ
				|	подзапрос.НомерСтроки КАК НомерСтроки,
				|	подзапрос.Номенклатура,
				|	подзапрос.НоменклатураСсылка,
				|	подзапрос.КодНоменклатуры,
				|	подзапрос.Характеристика,
				|	подзапрос.Серия,
				|	подзапрос.Количество,
				|	подзапрос.Цена,
				|	подзапрос.Сумма,
				|	подзапрос.СтавкаНДС,
				|	подзапрос.СуммаНДС,
				|	подзапрос.НомерГТД,
				|	подзапрос.СтранаПроисхождения,
				|	подзапрос.СуммаВключаетНДС,
				|	подзапрос.УчитыватьНДС,
				|	подзапрос.ЕдиницаИзмерения,
				|	подзапрос.КодЕдиницыИзмерения,
				|	подзапрос.ВидУпаковки,
				|	подзапрос.КоличествоВОдномМесте,
				|	подзапрос.КоличествоМест,
				|	подзапрос.Масса,
				|	подзапрос.ЭтоУслуга,
				|	подзапрос.ПризнакТРУ,
				|	подзапрос.порядок КАК порядок
				|ИЗ
				|	(ВЫБРАТЬ
				|		ЗаказПокупателяТовары.НомерСтроки КАК НомерСтроки,
				|		ВЫБОР
				|			КОГДА ПОДСТРОКА(ЗаказПокупателяТовары.Номенклатура.НаименованиеПолное, 1, 10) = """"
				|				Тогда ЗаказПокупателяТовары.Номенклатура.Наименование
				|			ИНАЧЕ ЗаказПокупателяТовары.Номенклатура.НаименованиеПолное
				|		КОНЕЦ КАК Номенклатура,
				|		ЗаказПокупателяТовары.Номенклатура.Ссылка КАК НоменклатураСсылка,
				|		ЗаказПокупателяТовары.Номенклатура.Код  КАК КодНоменклатуры,
				|		ЗаказПокупателяТовары.ХарактеристикаНоменклатуры  КАК Характеристика,
				|		"""" КАК серия,
				|		ЗаказПокупателяТовары.Количество КАК Количество,
				|		ЗаказПокупателяТовары.Цена КАК Цена,
				|		ЗаказПокупателяТовары.Сумма КАК Сумма,
				|		ЗаказПокупателяТовары.СтавкаНДС КАК СтавкаНДС,
				|		ЗаказПокупателяТовары.СуммаНДС КАК СуммаНДС,
				|		"""" КАК НомерГТД,
				|		"""" КАК СтранаПроисхождения,
				|		ЗаказПокупателяТовары.Ссылка.СуммаВключаетНДС КАК СуммаВключаетНДС,
				|		ЗаказПокупателяТовары.Ссылка.УчитыватьНДС КАК УчитыватьНДС,
				|		ЗаказПокупателяТовары.ЕдиницаИзмерения.ЕдиницаПоКлассификатору КАК ЕдиницаИзмерения,
				|		ЗаказПокупателяТовары.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Код КАК КодЕдиницыИзмерения,
				|		ЗаказПокупателяТовары.ЕдиницаИзмеренияМест КАК ВидУпаковки,
				|		ВЫБОР
				|			КОГДА ЗаказПокупателяТовары.Коэффициент = 0
				|				Тогда 0
				|			ИНАЧЕ ЗаказПокупателяТовары.ЕдиницаИзмеренияМест.Коэффициент / ЗаказПокупателяТовары.Коэффициент
				|		КОНЕЦ КАК КоличествоВОдномМесте,
				|		ЗаказПокупателяТовары.КоличествоМест КАК КоличествоМест,
				|		ВЫБОР
				|			КОГДА ЗаказПокупателяТовары.КоличествоМест > 0
				|				Тогда ЗаказПокупателяТовары.КоличествоМест * ЗаказПокупателяТовары.ЕдиницаИзмеренияМест.Вес
				|			ИНАЧЕ ЗаказПокупателяТовары.Количество * ЗаказПокупателяТовары.ЕдиницаИзмерения.Вес
				|		КОНЕЦ КАК Масса,
				|		Ложь КАК ЭтоУслуга,
				|		""Property"" КАК ПризнакТРУ,
				|		1 КАК порядок
				|	ИЗ
				|		Документ.ЗаказПокупателя.Товары КАК ЗаказПокупателяТовары
				|	ГДЕ
				|		ЗаказПокупателяТовары.Ссылка = &Ссылка
				|	
				|	ОБЪЕДИНИТЬ ВСЕ
				|	
				|	ВЫБРАТЬ
				|		ЗаказПокупателяУслуги.НомерСтроки,
				|		ВЫБОР
				|			КОГДА ПОДСТРОКА(ЗаказПокупателяУслуги.Содержание, 1, 10) = """"
				|				Тогда ЗаказПокупателяУслуги.Номенклатура.Наименование
				|			ИНАЧЕ ЗаказПокупателяУслуги.Содержание
				|		КОНЕЦ,
				|		ЗаказПокупателяУслуги.Номенклатура.Ссылка, 
				|		ЗаказПокупателяУслуги.Номенклатура.Код , 
				|		""""  КАК Характеристика,
				|		"""" КАК серия,
				|		ЗаказПокупателяУслуги.Количество,
				|		ЗаказПокупателяУслуги.Цена,
				|		ЗаказПокупателяУслуги.Сумма,
				|		ЗаказПокупателяУслуги.СтавкаНДС,
				|		ЗаказПокупателяУслуги.СуммаНДС,
				|		"""",
				|		"""",
				|		ЗаказПокупателяУслуги.Ссылка.СуммаВключаетНДС,
				|		ЗаказПокупателяУслуги.Ссылка.УчитыватьНДС,
				|		ЗаказПокупателяУслуги.Номенклатура.БазоваяЕдиницаИзмерения,
				|		ЗаказПокупателяУслуги.Номенклатура.БазоваяЕдиницаИзмерения.Код,
				|		"""",
				|		"""",
				|		"""",
				|		0,
				|		Истина,
				|		""Service"",
				|		2
				|	ИЗ
				|		Документ.ЗаказПокупателя.Услуги КАК ЗаказПокупателяУслуги
				|	ГДЕ
				|		ЗаказПокупателяУслуги.Ссылка = &Ссылка) КАК подзапрос
				|
				|УПОРЯДОЧИТЬ ПО
				|	порядок,
				|	НомерСтроки";
				
				
			КонецФункции				
			
		//} ТЧПолучитьТекстЗапроса...
		
		//{ ПолучитьДанныеШапки...
			
			Функция ШапкаПолучитьТекстЗапросаСФ()  Экспорт 
				Возврат 			"ВЫБРАТЬ
				|	СчетФактураВыданный.Организация,
				|	"""" как Грузоотправитель,
				|	СчетФактураВыданный.Контрагент,
				|	"""" КАК Грузополучатель,
				|	"""" как АдресДоставки,
				|	СчетФактураВыданный.ВалютаДокумента,
				|	Истина как СуммаВключаетНДС,
				|	Истина КАК УчитыватьНДС
				|ИЗ
				|	Документ.СчетФактураВыданный КАК СчетФактураВыданный
				|ГДЕ
				|	СчетФактураВыданный.Ссылка = &СчетФактура"; 
			КонецФункции	
			
			Функция ШапкаПолучитьТекстЗапросаОсновной() Экспорт 
				ТекстЗапроса = 			"ВЫБРАТЬ
				|	РеализацияТоваровУслуг.Организация КАК Организация,
				|	ВЫБОР
				|		КОГДА РеализацияТоваровУслуг.Грузоотправитель = ЗНАЧЕНИЕ(справочник.контрагенты.ПустаяСсылка)
				|			Тогда ""он же""
				|		ИНАЧЕ РеализацияТоваровУслуг.Грузоотправитель
				|	КОНЕЦ КАК Грузоотправитель,
				|	РеализацияТоваровУслуг.Контрагент,
				|	ВЫБОР
				|		КОГДА РеализацияТоваровУслуг.Грузополучатель = ЗНАЧЕНИЕ(справочник.контрагенты.пустаяСсылка)
				|			Тогда РеализацияТоваровУслуг.Контрагент
				|		ИНАЧЕ РеализацияТоваровУслуг.Грузополучатель
				|	КОНЕЦ КАК Грузополучатель,
				|	РеализацияТоваровУслуг.АдресДоставки КАК АдресДоставки,
				|	РеализацияТоваровУслуг.ВалютаДокумента КАК ВалютаДокумента,
				|	РеализацияТоваровУслуг.СуммаВключаетНДС КАК СуммаВключаетНДС,
				|	РеализацияТоваровУслуг.УчитыватьНДС КАК УчитыватьНДС
				|ИЗ
				|	Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
				|ГДЕ
				|	РеализацияТоваровУслуг.Ссылка = &ДокументСсылка
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	ОтражениеРеализацииТоваровИУслугНДС.Организация,
				|	ВЫБОР
				|		КОГДА ОтражениеРеализацииТоваровИУслугНДС.Грузоотправитель = ЗНАЧЕНИЕ(справочник.контрагенты.ПустаяСсылка)
				|			Тогда ""он же""
				|		ИНАЧЕ ОтражениеРеализацииТоваровИУслугНДС.Грузоотправитель
				|	КОНЕЦ,
				|	ОтражениеРеализацииТоваровИУслугНДС.Контрагент,
				|	ВЫБОР
				|		КОГДА ОтражениеРеализацииТоваровИУслугНДС.Грузополучатель = ЗНАЧЕНИЕ(справочник.контрагенты.пустаяСсылка)
				|			Тогда ОтражениеРеализацииТоваровИУслугНДС.Контрагент
				|		ИНАЧЕ ОтражениеРеализацииТоваровИУслугНДС.Грузополучатель
				|	КОНЕЦ,
				|	NULL,
				|	ОтражениеРеализацииТоваровИУслугНДС.ВалютаДокумента,
				|	ОтражениеРеализацииТоваровИУслугНДС.СуммаВключаетНДС,
				|	Истина
				|ИЗ
				|	Документ.ОтражениеРеализацииТоваровИУслугНДС КАК ОтражениеРеализацииТоваровИУслугНДС
				|ГДЕ
				|	ОтражениеРеализацииТоваровИУслугНДС.Ссылка = &ДокументСсылка
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	ВозвратТоваровПоставщику.Организация,
				|	ВЫБОР
				|		КОГДА ВозвратТоваровПоставщику.Грузоотправитель = ЗНАЧЕНИЕ(справочник.контрагенты.ПустаяСсылка)
				|			Тогда ""он же""
				|		ИНАЧЕ ВозвратТоваровПоставщику.Грузоотправитель
				|	КОНЕЦ,
				|	ВозвратТоваровПоставщику.Контрагент,
				|	ВЫБОР
				|		КОГДА ВозвратТоваровПоставщику.Грузополучатель = ЗНАЧЕНИЕ(справочник.контрагенты.пустаяСсылка)
				|			Тогда ВозвратТоваровПоставщику.Контрагент
				|		ИНАЧЕ ВозвратТоваровПоставщику.Грузополучатель
				|	КОНЕЦ,
				|	NULL,
				|	ВозвратТоваровПоставщику.ВалютаДокумента,
				|	ВозвратТоваровПоставщику.СуммаВключаетНДС,
				|	ВозвратТоваровПоставщику.УчитыватьНДС
				|ИЗ
				|	Документ.ВозвратТоваровПоставщику КАК ВозвратТоваровПоставщику
				|ГДЕ
				|	ВозвратТоваровПоставщику.Ссылка = &ДокументСсылка
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	АктОбОказанииПроизводственныхУслуг.Организация,
				|	"""",
				|	АктОбОказанииПроизводственныхУслуг.Контрагент,
				|	"""",
				|	"""",
				|	АктОбОказанииПроизводственныхУслуг.ВалютаДокумента,
				|	АктОбОказанииПроизводственныхУслуг.СуммаВключаетНДС,
				|	АктОбОказанииПроизводственныхУслуг.УчитыватьНДС
				|ИЗ
				|	Документ.АктОбОказанииПроизводственныхУслуг КАК АктОбОказанииПроизводственныхУслуг
				|ГДЕ
				|	АктОбОказанииПроизводственныхУслуг.Ссылка = &ДокументСсылка
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	ОтчетКомиссионераОПродажах.Организация,
				|	ВЫБОР
				|		КОГДА ОтчетКомиссионераОПродажах.Грузоотправитель = ЗНАЧЕНИЕ(справочник.контрагенты.ПустаяСсылка)
				|			Тогда ""он же""
				|		ИНАЧЕ ОтчетКомиссионераОПродажах.Грузоотправитель
				|	КОНЕЦ,
				|	ВложенныйЗапрос.Ссылка.Контрагент,
				|	ВЫБОР
				|		КОГДА ОтчетКомиссионераОПродажах.Грузополучатель = ЗНАЧЕНИЕ(справочник.контрагенты.пустаяСсылка)
				|			Тогда ВЫБОР
				|					КОГДА ВложенныйЗапрос.Ссылка.Контрагент = ЗНАЧЕНИЕ(справочник.контрагенты.пустаяСсылка)
				|						Тогда ОтчетКомиссионераОПродажах.Контрагент
				|					ИНАЧЕ ВложенныйЗапрос.Ссылка.Контрагент
				|				КОНЕЦ
				|		ИНАЧЕ ОтчетКомиссионераОПродажах.Грузополучатель
				|	КОНЕЦ,
				|	"""",
				|	ОтчетКомиссионераОПродажах.ВалютаДокумента,
				|	ОтчетКомиссионераОПродажах.СуммаВключаетНДС,
				|	ОтчетКомиссионераОПродажах.УчитыватьНДС
				|ИЗ
				|	Документ.ОтчетКомиссионераОПродажах КАК ОтчетКомиссионераОПродажах,
				|	(ВЫБРАТЬ
				|		СчетФактураВыданныйДокументыОснования.Ссылка КАК Ссылка,
				|		СчетФактураВыданныйДокументыОснования.ДокументОснование КАК ДокументОснование
				|	ИЗ
				|		Документ.СчетФактураВыданный.ДокументыОснования КАК СчетФактураВыданныйДокументыОснования
				|	ГДЕ
				|		СчетФактураВыданныйДокументыОснования.Ссылка = &СчетФактура) КАК ВложенныйЗапрос
				|ГДЕ
				|	ОтчетКомиссионераОПродажах.Ссылка = &ДокументСсылка
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	ОтчетКомитентуОПродажах.Организация,
				|	"""",
				|	ОтчетКомитентуОПродажах.Контрагент,
				|	"""",
				|	"""",
				|	ОтчетКомитентуОПродажах.ВалютаДокумента,
				|	Истина,
				|	Истина
				|ИЗ
				|	Документ.ОтчетКомитентуОПродажах КАК ОтчетКомитентуОПродажах
				|ГДЕ
				|	ОтчетКомитентуОПродажах.Ссылка = &ДокументСсылка
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	РеализацияУслугПоПереработке.Организация,
				|	"""",
				|	РеализацияУслугПоПереработке.Контрагент,
				|	"""",
				|	"""",
				|	РеализацияУслугПоПереработке.ВалютаДокумента,
				|	РеализацияУслугПоПереработке.СуммаВключаетНДС,
				|	РеализацияУслугПоПереработке.УчитыватьНДС
				|ИЗ
				|	Документ.РеализацияУслугПоПереработке КАК РеализацияУслугПоПереработке
				|ГДЕ
				|	РеализацияУслугПоПереработке.Ссылка = &ДокументСсылка
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	ПередачаОС.Организация,
				|	ВЫБОР
				|		КОГДА ПередачаОС.Грузоотправитель = ЗНАЧЕНИЕ(справочник.контрагенты.ПустаяСсылка)
				|			Тогда ""он же""
				|		ИНАЧЕ ПередачаОС.Грузоотправитель
				|	КОНЕЦ,
				|	ПередачаОС.Контрагент,
				|	ВЫБОР
				|		КОГДА ПередачаОС.Грузополучатель = ЗНАЧЕНИЕ(справочник.контрагенты.пустаяСсылка)
				|			Тогда ПередачаОС.Контрагент
				|		ИНАЧЕ ПередачаОС.Грузополучатель
				|	КОНЕЦ,
				|	"""",
				|	ПередачаОС.ВалютаДокумента,
				|	ПередачаОС.СуммаВключаетНДС,
				|	ПередачаОС.УчитыватьНДС
				|ИЗ
				|	Документ.ПередачаОС КАК ПередачаОС
				|ГДЕ
				|	ПередачаОС.Ссылка = &ДокументСсылка";
				
				Если метаданные.Документы.Найти("КорректировкаРеализации") <> Неопределено Тогда 
					ТекстЗапроса = ТекстЗапроса  +"
					|Объединить все  
					|"+"ВЫБРАТЬ
					|	КорректировкаРеализации.Организация КАК Организация,
					|	ВЫБОР
					|		КОГДА КорректировкаРеализации.Грузоотправитель = ЗНАЧЕНИЕ(справочник.контрагенты.ПустаяСсылка)
					|			Тогда ""он же""
					|		ИНАЧЕ КорректировкаРеализации.Грузоотправитель
					|	КОНЕЦ КАК Грузоотправитель,
					|	КорректировкаРеализации.Контрагент,
					|	ВЫБОР
					|		КОГДА КорректировкаРеализации.Грузополучатель = ЗНАЧЕНИЕ(справочник.контрагенты.пустаяСсылка)
					|			Тогда КорректировкаРеализации.Контрагент
					|		ИНАЧЕ КорректировкаРеализации.Грузополучатель
					|	КОНЕЦ КАК Грузополучатель,
					|	КорректировкаРеализации.АдресДоставки КАК АдресДоставки,
					|	КорректировкаРеализации.ВалютаДокумента КАК ВалютаДокумента,
					|	КорректировкаРеализации.СуммаВключаетНДС КАК СуммаВключаетНДС,
					|	КорректировкаРеализации.УчитыватьНДС КАК УчитыватьНДС
					|ИЗ
					|	Документ.КорректировкаРеализации КАК КорректировкаРеализации
					|ГДЕ
					|	КорректировкаРеализации.Ссылка = &ДокументСсылка";
				КонецЕсли;		
				
				Если Метаданные.Документы.Найти("СчетНаОплатуПокупателю") <> Неопределено Тогда
					ТекстЗапроса = ТекстЗапроса  + "
					|
					|ОБЪЕДИНИТЬ ВСЕ
					|
					|ВЫБРАТЬ
					|	СчетНаОплату.Организация,
					|	"""",
					|	СчетНаОплату.Контрагент,
					|	"""",
					|	"""",
					|	СчетНаОплату.ВалютаДокумента,
					|	СчетНаОплату.СуммаВключаетНДС,
					|	СчетНаОплату.УчитыватьНДС
					|ИЗ
					|	Документ.СчетНаОплатуПокупателю КАК СчетНаОплату
					|ГДЕ
					|	СчетНаОплату.Ссылка = &ДокументСсылка";
				КонецЕсли;
				
				Если Метаданные.Документы.Найти("ЗаказПокупателя") <> Неопределено Тогда
					ТекстЗапроса = ТекстЗапроса + "
					|
					|ОБЪЕДИНИТЬ ВСЕ
					|
					|ВЫБРАТЬ
					|	ЗаказПокупателя.Организация,
					|	"""",
					|	ЗаказПокупателя.Контрагент,
					|	"""",
					|	"""",
					|	ЗаказПокупателя.ВалютаДокумента,
					|	ЗаказПокупателя.СуммаВключаетНДС,
					|	ЗаказПокупателя.УчитыватьНДС
					|ИЗ
					|	Документ.ЗаказПокупателя КАК ЗаказПокупателя
					|ГДЕ
					|	ЗаказПокупателя.Ссылка = &ДокументСсылка";
				КонецЕсли;
				
				Возврат ТекстЗапроса;
			КонецФункции
			
		//} ПолучитьДанныеШапки...
		
		
		Функция АдресЭлектроннойПочты(Объект, ВидАдреса) Экспорт
			
			Перем Результат;
			
			Запрос = Новый Запрос("ВЫБРАТЬ ПЕРВЫЕ 1 Представление ИЗ РегистрСведений.КонтактнаяИнформация ГДЕ Объект = &Объект И Вид = &ВидАдреса И Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.АдресЭлектроннойПочты) ");
			
			Запрос.УстановитьПараметр("Объект"	 , Объект);
			Запрос.УстановитьПараметр("ВидАдреса", ВидАдреса);
			
			РезультатЗапроса= Запрос.Выполнить();
			
			Если НЕ РезультатЗапроса.Пустой() Тогда
				
				Выборка= РезультатЗапроса.Выбрать();
				Выборка.Следующий();
				
				Результат = Выборка.Представление;
				
			КонецЕсли;
			
			Возврат Результат;
			
		КонецФункции
		
		Процедура ЗаполнитьСтруктуруАдреса(AddressInfo, ЮрФизЛицо, ИспользоватьЮрАдрес = Ложь, АдресСтрокой = "") Экспорт
			
			Если ЗначениеЗаполнено(АдресСтрокой) Тогда
				
				ЗаполнитьAddressInfo(AddressInfo, ЮрФизЛицо,,АдресСтрокой);
				
			Иначе
				
				Объект = ЮрФизЛицо;
				
				Если ТипЗнч(ЮрФизЛицо) = Тип("СправочникСсылка.Организации") Тогда
					
					Если ЮрФизЛицо.ЮрФизЛицо = Перечисления.ЮрФизЛицо.ЮрЛицо Тогда
						ПринадлежностьАдреса = "Организации";
					Иначе
						ПринадлежностьАдреса = "ФизЛица";
						Объект = ЮрФизЛицо.ИндивидуальныйПредприниматель;
					КонецЕсли;
					
				Иначе
					ПринадлежностьАдреса = "Контрагента";
				КонецЕсли;
				
				ВидАдреса = Справочники.ВидыКонтактнойИнформации[?(ИспользоватьЮрАдрес, "ЮрАдрес", "ФактАдрес") + ПринадлежностьАдреса];
				
				ЗаполнитьAddressInfo(AddressInfo, Объект, ВидАдреса);
				
			КонецЕсли;
			
		КонецПроцедуры
		
		Процедура ЗаполнитьAddressInfo(AddressInfo, Объект, ВидАдреса = Неопределено, АдресСтрокой = "") Экспорт
			
			Запрос = Новый Запрос;
			Запрос.УстановитьПараметр("Объект", Объект);
			
			Если ЗначениеЗаполнено(АдресСтрокой) Тогда
				УсловиеВидИлиПредставление = " И Т.Представление ПОДОБНО &АдресСтрокой";
				Запрос.УстановитьПараметр("АдресСтрокой", АдресСтрокой);
			Иначе
				УсловиеВидИлиПредставление = " И Т.Вид = &ВидАдреса";
				Запрос.УстановитьПараметр("ВидАдреса", ВидАдреса);
			КонецЕсли;
			
			Запрос.Текст =
			"ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
			|	Т.Представление,
			|	Т.Поле1 КАК ИндексИлиСтрана,
			|	Т.Поле2 КАК Регион,
			|	Т.Поле3 КАК Territory,
			|	Т.Поле4 КАК City,
			|	Т.Поле5 КАК Locality,
			|	Т.Поле6 КАК Street,
			|	Т.Поле7 КАК Building,
			|	Т.Поле8 КАК Block,
			|	Т.Поле9 КАК Apartment,
			|	ВЫБОР
			|		КОГДА Т.Поле2 = """"
			|				И Т.Поле3 = """"
			|				И Т.Поле4 = """"
			|				И Т.Поле5 = """"
			|				И Т.Поле6 = """"
			|				И Т.Поле7 = """"
			|				И Т.Поле8 = """"
			|				И Т.Поле9 = """"
			|			ТОГДА ИСТИНА
			|		ИНАЧЕ ЛОЖЬ
			|	КОНЕЦ КАК IsForeign
			|ИЗ
			|	РегистрСведений.КонтактнаяИнформация КАК Т
			|ГДЕ
			|	Т.Объект = &Объект
			|	И Т.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.Адрес)" + УсловиеВидИлиПредставление;
			
			РезультатЗапроса = Запрос.Выполнить();
			
			Если НЕ РезультатЗапроса.Пустой() Тогда
				
				Выборка = РезультатЗапроса.Выбрать();
				Выборка.Следующий();
				
				Если Выборка.IsForeign Тогда
					
					AddressInfo.IsForeign 	= Истина;
					AddressInfo.CountryCode = ?(Значениезаполнено(Выборка.ИндексИлиСтрана), КодСтраны(Выборка.ИндексИлиСтрана), "643");
					AddressInfo.AddressText = Выборка.Представление;
					
					НаименованиеСтраны = НаименованиеСтраны(AddressInfo.CountryCode);
					AddressInfo.AddressText = СтрЗаменить(AddressInfo.AddressText, 		НаименованиеСтраны , "");
					AddressInfo.AddressText = СтрЗаменить(AddressInfo.AddressText, ВРег(НаименованиеСтраны), "");
					AddressInfo.AddressText = СтрЗаменить(AddressInfo.AddressText, НРег(НаименованиеСтраны), "");
					AddressInfo.AddressText = СтрЗаменить(AddressInfo.AddressText, ТРег(НаименованиеСтраны), "");
			
				Иначе
					
					ЗаполнитьЗначенияСвойств(AddressInfo, Выборка);
					
					AddressInfo.ZipCode = Выборка.ИндексИлиСтрана;
					
					Если ЗначениеЗаполнено(Выборка.Регион) Тогда 
						
						AddressInfo.RegionCode = КодРегиона(Выборка.Регион);
						Если НЕ ЗначениеЗаполнено(AddressInfo.RegionCode) Тогда 
							AddressInfo.RegionCode=  "##"; // маркер того, что  регион задан не по классификатору
						КонецЕсли;	
						
					КонецЕсли;	
					
				КонецЕсли;
				
			ИначеЕсли ЗначениеЗаполнено(АдресСтрокой) Тогда
				
				Попытка
					
					АдресСтруктурой = Вычислить("УправлениеКонтактнойИнформацией.ПолучитьСтруктуруАдресаИзСтроки(АдресСтрокой)");
					
					Если ТипЗнч(АдресСтруктурой) = Тип("Структура") Тогда
						
						Если АдресСтруктурой.Свойство("ЗаПределамиРФ") Тогда
							
							AddressInfo.IsForeign = Истина;
							AddressInfo.CountryCode = КодСтраны(АдресСтруктурой.Страна);
								
							Если ЗначениеЗаполнено(AddressInfo.CountryCode) Тогда
								AddressInfo.AddressText = АдресСтруктурой.Представление;
							КонецЕсли;
				
						Иначе
							
							AddressInfo.IsForeign 	= Ложь;
							AddressInfo.ZipCode 	= АдресСтруктурой.Индекс;
							
							Если ЗначениеЗаполнено(АдресСтруктурой.Регион) Тогда 
								
								AddressInfo.RegionCode = КодРегиона(АдресСтруктурой.Регион);
								Если НЕ ЗначениеЗаполнено(AddressInfo.RegionCode) Тогда 
									AddressInfo.RegionCode = "##"; // маркер того, что  регион задан не по классификатору
								КонецЕсли;	
								
							КонецЕсли;
							
							AddressInfo.Territory	= АдресСтруктурой.Район;
							AddressInfo.City		= АдресСтруктурой.Город;
							AddressInfo.Locality	= АдресСтруктурой.НаселенныйПункт;
							AddressInfo.Street		= АдресСтруктурой.Улица;
							AddressInfo.Building	= АдресСтруктурой.Дом;
							AddressInfo.Block		= АдресСтруктурой.Корпус;
							AddressInfo.Apartment	= АдресСтруктурой.Квартира;
							
						КонецЕсли;
						
					КонецЕсли;
					
				Исключение
					
					AddressInfo.IsForeign = Истина;
					
					НаименованиеСтраны = Лев(АдресСтрокой, Найти(АдресСтрокой, ",") - 1);
					
					Если ЗначениеЗаполнено(НаименованиеСтраны) Тогда
						
						AddressInfo.CountryCode = КодСтраны(НаименованиеСтраны);
						
						Если ЗначениеЗаполнено(AddressInfo.CountryCode) Тогда
							AddressInfo.AddressText = СтрЗаменить(АдресСтрокой, НаименованиеСтраны, "");
						КонецЕсли;
						
					КонецЕсли;
					
				КонецПопытки;
				
			КонецЕсли;
			
			Если AddressInfo.IsForeign = Истина И НЕ ЗначениеЗаполнено(AddressInfo.CountryCode) Тогда
				AddressInfo.CountryCode = "643";
				AddressInfo.AddressText = АдресСтрокой;
			КонецЕсли;
			
			Пока Лев(AddressInfo.AddressText, 1) = " " ИЛИ Лев(AddressInfo.AddressText, 1)="," Цикл
				AddressInfo.AddressText = Сред(AddressInfo.AddressText, 2);
			КонецЦикла;
			
		КонецПроцедуры
		
	//} ПОЛУЧЕНИЕ ДАННЫХ
	
	//{ ФОРМИРОВАНИЕ СПИСКА ВЫГРУЗКИ
		
		//{ Подготовка временных таблиц для списка отправки документов...
			
			Процедура ПодготовитьВТ_СЧФ_Основная(Запрос, МассивВременныхТаблиц) Экспорт
				
				Запрос.Текст=
				"ВЫБРАТЬ РАЗРЕШЕННЫЕ
				|	Т.Ссылка КАК Документ,
				|	Т.Организация КАК Продавец,
				|	Т.Контрагент КАК Покупатель,
				|	Т.СуммаДокумента КАК СуммаДокументаЗначение,
				|	Т.СуммаНДС КАК СуммаНДСЗначение,
				|	Т.ВалютаДокумента КАК Валюта,
				|	Т.Проведен,
				|	Т.Дата,
				|	Т.Номер,
				|	ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") КАК ID,
				|	Т.ВидСчетаФактуры,
				|	ОтборОрганизации.ФормироватьУПД КАК ОрганизацияФормироватьУПД,
				|	Т.Исправление,
				|	ЕСТЬNULL(ТЧ_ДокументыОснования.ДокументОснование, НЕОПРЕДЕЛЕНО) КАК ДокументОснование
				|ПОМЕСТИТЬ ВТ_Основная
				|ИЗ
				|	ОтборОрганизации КАК ОтборОрганизации
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный КАК Т
				|		ПО (Т.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания)
				|			И (Т.Организация = ОтборОрганизации.Организация)
				|			И (Т.Проведен)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ИдентификаторДокументаВДиадок
				|		ПО (Т.Ссылка = ИдентификаторДокументаВДиадок.Объект)
				|			И (ИдентификаторДокументаВДиадок.Свойство = &ИдентификаторДокументаВДиадок)
				|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный.ДокументыОснования КАК ТЧ_ДокументыОснования
				|		ПО (Т.Ссылка = ТЧ_ДокументыОснования.Ссылка)
				|ГДЕ
				|	НЕ ОтборОрганизации.ОтпрНеПроведенные
				|	И (ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") = """"
				|			ИЛИ ИдентификаторДокументаВДиадок.Значение ПОДОБНО ""усл:%"")
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	Т.Ссылка,
				|	Т.Организация,
				|	Т.Контрагент,
				|	Т.СуммаДокумента,
				|	Т.СуммаНДС,
				|	Т.ВалютаДокумента,
				|	Т.Проведен,
				|	Т.Дата,
				|	Т.Номер,
				|	ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """"),
				|	Т.ВидСчетаФактуры,
				|	ОтборОрганизации.ФормироватьУПД,
				|	Т.Исправление,
				|	ЕСТЬNULL(ТЧ_ДокументыОснования.ДокументОснование, НЕОПРЕДЕЛЕНО)
				|ИЗ
				|	ОтборОрганизации КАК ОтборОрганизации
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный КАК Т
				|		ПО (Т.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания)
				|			И (Т.Организация = ОтборОрганизации.Организация)
				|			И (НЕ Т.ПометкаУдаления)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ИдентификаторДокументаВДиадок
				|		ПО (Т.Ссылка = ИдентификаторДокументаВДиадок.Объект)
				|			И (ИдентификаторДокументаВДиадок.Свойство = &ИдентификаторДокументаВДиадок)
				|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный.ДокументыОснования КАК ТЧ_ДокументыОснования
				|		ПО (Т.Ссылка = ТЧ_ДокументыОснования.Ссылка)
				|ГДЕ
				|	ОтборОрганизации.ОтпрНеПроведенные
				|	И (ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") = """"
				|			ИЛИ ИдентификаторДокументаВДиадок.Значение ПОДОБНО ""усл:%"")
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	ТИПЗНАЧЕНИЯ(ВТ_Основная.ДокументОснование) КАК ДокументОснованиеТип
				|ИЗ
				|	ВТ_Основная КАК ВТ_Основная
				|ГДЕ
				|	ВТ_Основная.ДокументОснование ЕСТЬ НЕ NULL 
				|	И НЕ ВТ_Основная.ДокументОснование ССЫЛКА Документ.ОтчетКомиссионераОПродажах";
				
				ТекстЗапросаГрузополучатели= "";
				РезультатЗапроса= Запрос.Выполнить();
				Если НЕ РезультатЗапроса.Пустой() Тогда
					
					Выборка= РезультатЗапроса.Выбрать();
					РезультатЗапроса= Неопределено;
					
					Пока Выборка.Следующий() Цикл
						
						МетаданныеДокумента= Метаданные.НайтиПоТипу(Выборка.ДокументОснованиеТип);
						
						Если МетаданныеДокумента <> Неопределено И МетаданныеДокумента.Реквизиты.Найти("Грузополучатель") <> Неопределено Тогда
							
							ТекстЗапросаГрузополучатели= ТекстЗапросаГрузополучатели + "
							|	
							|	ОБЪЕДИНИТЬ
							|	
							|ВЫБРАТЬ
							|	ВТ_Основная.Документ,
							|	ДанныеДокументаОснования.Грузополучатель
							|ИЗ
							|	ВТ_Основная КАК ВТ_Основная
							|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ "+МетаданныеДокумента.ПолноеИмя()+" КАК ДанныеДокументаОснования
							|		ПО ВТ_Основная.ДокументОснование = ДанныеДокументаОснования.Ссылка
							|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборГрузополучатели КАК ОтборГрузополучатели
							|		ПО (ВТ_Основная.Покупатель = ОтборГрузополучатели.Контрагент)
							|			И ДанныеДокументаОснования.Грузополучатель = ОтборГрузополучатели.Грузополучатель";
							
						КонецЕсли;
						
						МетаданныеДокумента= Неопределено;
						
					КонецЦикла;
				КонецЕсли;
				
				Запрос.Текст= 
				"ВЫБРАТЬ
				|	ВложенныйЗапрос.Документ,
				|	МАКСИМУМ(ВложенныйЗапрос.Грузополучатель) КАК Грузополучатель
				|ПОМЕСТИТЬ ВТ_Грузополучатели
				|ИЗ
				|	(ВЫБРАТЬ
				|		NULL КАК Документ,
				|		NULL КАК Грузополучатель
				|	ГДЕ
				|		ЛОЖЬ "+ТекстЗапросаГрузополучатели+") КАК ВложенныйЗапрос
				|
				|СГРУППИРОВАТЬ ПО
				|	ВложенныйЗапрос.Документ
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|";
				
				Если Метаданные.Документы.Найти("КорректировкаРеализации") = Неопределено Тогда
					
					Запрос.Текст= Запрос.Текст +
					"ВЫБРАТЬ
					|	NULL КАК Документ,
					|	NULL КАК Контрагент
					|ПОМЕСТИТЬ ВТ_КонтрагентыКорректировокОтчетовКомиссионеров
					|ГДЕ
					|	ЛОЖЬ
					|;
					|
					|////////////////////////////////////////////////////////////////////////////////
					|";
					
				Иначе
					
					Запрос.Текст= Запрос.Текст +
					"ВЫБРАТЬ
					|	ВТ_Основная.Документ,
					|	ОтчетКомиссионераОПродажах.Контрагент
					|ПОМЕСТИТЬ ВТ_КонтрагентыКорректировокОтчетовКомиссионеров
					|ИЗ
					|	ВТ_Основная КАК ВТ_Основная
					|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КорректировкаРеализации КАК КорректировкаРеализации
					|		ПО ВТ_Основная.ДокументОснование = КорректировкаРеализации.Ссылка
					|			И (КорректировкаРеализации.ДокументРеализации ССЫЛКА Документ.СчетФактураВыданный)
					|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный КАК СчетФактураВыданный
					|		ПО (КорректировкаРеализации.ДокументРеализации = СчетФактураВыданный.Ссылка)
					|			И (СчетФактураВыданный.ДокументОснование ССЫЛКА Документ.ОтчетКомиссионераОПродажах)
					|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ОтчетКомиссионераОПродажах КАК ОтчетКомиссионераОПродажах
					|		ПО (СчетФактураВыданный.ДокументОснование = ОтчетКомиссионераОПродажах.Ссылка)
					|;
					|
					|////////////////////////////////////////////////////////////////////////////////
					|";
					
				КонецЕсли;
				
				
				Запрос.Текст= Запрос.Текст +
				"ВЫБРАТЬ
				|	ВТ_Основная.Документ,
				|	ВТ_Основная.Продавец,
				|	ВТ_Основная.Покупатель,
				|	НЕОПРЕДЕЛЕНО КАК Грузополучатель,
				|	ВТ_Основная.СуммаДокументаЗначение,
				|	ВТ_Основная.СуммаНДСЗначение,
				|	ВТ_Основная.Валюта,
				|	ВТ_Основная.Проведен,
				|	ВТ_Основная.Дата,
				|	ВТ_Основная.Номер,
				|	ВТ_Основная.ID,
				|	ВТ_Основная.ВидСчетаФактуры,
				|	ВТ_Основная.Исправление,
				|	ВТ_Основная.ДокументОснование,
				|	ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") КАК ДокументОснованиеID,
				|	ОтборКонтрагенты.CounteragentID,
				|	ЕСТЬNULL(ОтборКонтрагенты.ФормироватьУПД, ВТ_Основная.ОрганизацияФормироватьУПД) КАК ФормироватьУПД
				|ПОМЕСТИТЬ СЧФ_Основная
				|ИЗ
				|	ВТ_Основная КАК ВТ_Основная
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборКонтрагенты КАК ОтборКонтрагенты
				|		ПО ВТ_Основная.Покупатель = ОтборКонтрагенты.Контрагент
				|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Грузополучатели КАК ВТ_Грузополучатели
				|		ПО ВТ_Основная.Документ = ВТ_Грузополучатели.Документ
				|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_КонтрагентыКорректировокОтчетовКомиссионеров КАК ВТ_КонтрагентыКорректировокОтчетовКомиссионеров
				|		ПО ВТ_Основная.Документ = ВТ_КонтрагентыКорректировокОтчетовКомиссионеров.Документ
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ИдентификаторДокументаВДиадок
				|		ПО ВТ_Основная.ДокументОснование = ИдентификаторДокументаВДиадок.Объект
				|			И (ИдентификаторДокументаВДиадок.Свойство = &ИдентификаторДокументаВДиадок)
				|ГДЕ
				|	НЕ ВТ_Основная.ДокументОснование ССЫЛКА Документ.ОтчетКомиссионераОПродажах
				|	И ВТ_Грузополучатели.Документ ЕСТЬ NULL 
				|	И ВТ_КонтрагентыКорректировокОтчетовКомиссионеров.Документ ЕСТЬ NULL 
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	ВТ_Основная.Документ,
				|	ВТ_Основная.Продавец,
				|	ОтчетКомиссионераОПродажах.Контрагент,
				|	НЕОПРЕДЕЛЕНО,
				|	ВТ_Основная.СуммаДокументаЗначение,
				|	ВТ_Основная.СуммаНДСЗначение,
				|	ВТ_Основная.Валюта,
				|	ВТ_Основная.Проведен,
				|	ВТ_Основная.Дата,
				|	ВТ_Основная.Номер,
				|	ВТ_Основная.ID,
				|	ВТ_Основная.ВидСчетаФактуры,
				|	ВТ_Основная.Исправление,
				|	НЕОПРЕДЕЛЕНО,
				|	"""",
				|	ОтборКонтрагенты.CounteragentID,
				|	ЕСТЬNULL(ОтборКонтрагенты.ФормироватьУПД, ВТ_Основная.ОрганизацияФормироватьУПД)
				|ИЗ
				|	ВТ_Основная КАК ВТ_Основная
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ОтчетКомиссионераОПродажах КАК ОтчетКомиссионераОПродажах
				|		ПО ВТ_Основная.ДокументОснование = ОтчетКомиссионераОПродажах.Ссылка
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборКонтрагенты КАК ОтборКонтрагенты
				|		ПО (ОтчетКомиссионераОПродажах.Контрагент = ОтборКонтрагенты.Контрагент)
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	ВТ_Основная.Документ,
				|	ВТ_Основная.Продавец,
				|	ВТ_КонтрагентыКорректировокОтчетовКомиссионеров.Контрагент,
				|	НЕОПРЕДЕЛЕНО,
				|	ВТ_Основная.СуммаДокументаЗначение,
				|	ВТ_Основная.СуммаНДСЗначение,
				|	ВТ_Основная.Валюта,
				|	ВТ_Основная.Проведен,
				|	ВТ_Основная.Дата,
				|	ВТ_Основная.Номер,
				|	ВТ_Основная.ID,
				|	ВТ_Основная.ВидСчетаФактуры,
				|	ВТ_Основная.Исправление,
				|	НЕОПРЕДЕЛЕНО,
				|	"""",
				|	ОтборКонтрагенты.CounteragentID,
				|	ЕСТЬNULL(ОтборКонтрагенты.ФормироватьУПД, ВТ_Основная.ОрганизацияФормироватьУПД)
				|ИЗ
				|	ВТ_Основная КАК ВТ_Основная
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_КонтрагентыКорректировокОтчетовКомиссионеров КАК ВТ_КонтрагентыКорректировокОтчетовКомиссионеров
				|		ПО ВТ_Основная.Документ = ВТ_КонтрагентыКорректировокОтчетовКомиссионеров.Документ
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборКонтрагенты КАК ОтборКонтрагенты
				|		ПО (ВТ_КонтрагентыКорректировокОтчетовКомиссионеров.Контрагент = ОтборКонтрагенты.Контрагент)
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	ВТ_Основная.Документ,
				|	ВТ_Основная.Продавец,
				|	ВТ_Основная.Покупатель,
				|	ВТ_Грузополучатели.Грузополучатель,
				|	ВТ_Основная.СуммаДокументаЗначение,
				|	ВТ_Основная.СуммаНДСЗначение,
				|	ВТ_Основная.Валюта,
				|	ВТ_Основная.Проведен,
				|	ВТ_Основная.Дата,
				|	ВТ_Основная.Номер,
				|	ВТ_Основная.ID,
				|	ВТ_Основная.ВидСчетаФактуры,
				|	ВТ_Основная.Исправление,
				|	ВТ_Основная.ДокументОснование,
				|	ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """"),
				|	ОтборГрузополучатели.CounteragentID,
				|	ЕСТЬNULL(ОтборГрузополучатели.ФормироватьУПД, ВТ_Основная.ОрганизацияФормироватьУПД)
				|ИЗ
				|	ВТ_Грузополучатели КАК ВТ_Грузополучатели
				|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Основная КАК ВТ_Основная
				|		ПО ВТ_Грузополучатели.Документ = ВТ_Основная.Документ
				|		ЛЕВОЕ СОЕДИНЕНИЕ ОтборГрузополучатели КАК ОтборГрузополучатели
				|		ПО (ВТ_Основная.Покупатель = ОтборГрузополучатели.Контрагент)
				|			И ВТ_Грузополучатели.Грузополучатель = ОтборГрузополучатели.Грузополучатель
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ИдентификаторДокументаВДиадок
				|		ПО (ВТ_Основная.ДокументОснование = ИдентификаторДокументаВДиадок.Объект)
				|			И (ИдентификаторДокументаВДиадок.Свойство = &ИдентификаторДокументаВДиадок)
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ ВТ_Основная
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ ВТ_КонтрагентыКорректировокОтчетовКомиссионеров
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ ВТ_Грузополучатели";
				
				Запрос.Выполнить();
				
			КонецПроцедуры
			
			Процедура ПодготовитьВТ_УПД_СЧФДОП(Запрос, МассивВременныхТаблиц, ТипыДокументов) Экспорт
				
				Запрос.Текст=
				"ВЫБРАТЬ
				|	СЧФ_Основная.Документ
				|ПОМЕСТИТЬ ВТ_ПодходящиеСЧФ
				|ИЗ
				|	СЧФ_Основная КАК СЧФ_Основная
				|ГДЕ
				|	СЧФ_Основная.ФормироватьУПД = &СЧФДОП
				|	И НЕ СЧФ_Основная.Исправление
				|	И СЧФ_Основная.ВидСчетаФактуры = ЗНАЧЕНИЕ(Перечисление.ВидСчетаФактурыВыставленного.НаРеализацию)
				|	И СЧФ_Основная.ДокументОснование <> НЕОПРЕДЕЛЕНО
				|
				|СГРУППИРОВАТЬ ПО
				|	СЧФ_Основная.Документ
				|
				|ИМЕЮЩИЕ
				|	МИНИМУМ(ВЫБОР
				|			КОГДА СЧФ_Основная.ID = СЧФ_Основная.ДокументОснованиеID
				|				ТОГДА ИСТИНА
				|			ИНАЧЕ ЛОЖЬ
				|		КОНЕЦ) = ИСТИНА
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	СЧФ_Основная.Документ,
				|	СЧФ_Основная.Продавец,
				|	СЧФ_Основная.Покупатель,
				|	СЧФ_Основная.Грузополучатель,
				|	СЧФ_Основная.СуммаДокументаЗначение,
				|	СЧФ_Основная.СуммаНДСЗначение,
				|	СЧФ_Основная.Валюта,
				|	СЧФ_Основная.Проведен,
				|	СЧФ_Основная.Дата,
				|	СЧФ_Основная.Номер,
				|	СЧФ_Основная.ID,
				|	СЧФ_Основная.CounteragentID,
				|	&СЧФДОП КАК ФункцияУПД,
				|	"""" КАК СостояниеОтправкиДополнительныхВПФ,
				|	ЛОЖЬ КАК ЭтоСчет				
				|ПОМЕСТИТЬ УПД_СЧФДОП
				|ИЗ
				|	ВТ_ПодходящиеСЧФ КАК ВТ_ПодходящиеСЧФ
				|		ЛЕВОЕ СОЕДИНЕНИЕ СЧФ_Основная КАК СЧФ_Основная
				|		ПО ВТ_ПодходящиеСЧФ.Документ = СЧФ_Основная.Документ
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	СЧФ_Основная.ДокументОснование
				|ПОМЕСТИТЬ УПД_СЧФДОП_ДокументыОснования
				|ИЗ
				|	ВТ_ПодходящиеСЧФ КАК ВТ_ПодходящиеСЧФ
				|		ЛЕВОЕ СОЕДИНЕНИЕ СЧФ_Основная КАК СЧФ_Основная
				|		ПО ВТ_ПодходящиеСЧФ.Документ = СЧФ_Основная.Документ
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ ВТ_ПодходящиеСЧФ";
				
				Запрос.Выполнить();
				
				Если ТипыДокументов = 0 ИЛИ ТипыДокументов = 5 Тогда
					МассивВременныхТаблиц.Добавить("УПД_СЧФДОП");
				КонецЕсли;
				
			КонецПроцедуры
			
			Процедура ПодготовитьВТ_УКД_КСЧФДИС(Запрос, МассивВременныхТаблиц, ТипыДокументов) Экспорт
				
				Запрос.Текст =
				"ВЫБРАТЬ
				|	СЧФ_Основная.Документ
				|ПОМЕСТИТЬ ВТ_ПодходящиеСЧФ
				|ИЗ
				|	СЧФ_Основная КАК СЧФ_Основная
				|ГДЕ
				|	СЧФ_Основная.ФормироватьУПД = &СЧФДОП
				|	И НЕ СЧФ_Основная.Исправление
				|	И СЧФ_Основная.ВидСчетаФактуры = ЗНАЧЕНИЕ(Перечисление.ВидСчетаФактурыВыставленного.Корректировочный)
				|	И СЧФ_Основная.ДокументОснование <> НЕОПРЕДЕЛЕНО
				|
				|СГРУППИРОВАТЬ ПО
				|	СЧФ_Основная.Документ
				|
				|ИМЕЮЩИЕ
				|	МИНИМУМ(ВЫБОР
				|			КОГДА СЧФ_Основная.ID = СЧФ_Основная.ДокументОснованиеID
				|				ТОГДА ИСТИНА
				|			ИНАЧЕ ЛОЖЬ
				|		КОНЕЦ) = ИСТИНА
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	СЧФ_Основная.Документ,
				|	СЧФ_Основная.Продавец,
				|	СЧФ_Основная.Покупатель,
				|	СЧФ_Основная.Грузополучатель,
				|	СЧФ_Основная.СуммаДокументаЗначение,
				|	СЧФ_Основная.СуммаНДСЗначение,
				|	СЧФ_Основная.Валюта,
				|	СЧФ_Основная.Проведен,
				|	СЧФ_Основная.Дата,
				|	СЧФ_Основная.Номер,
				|	СЧФ_Основная.ID,
				|	СЧФ_Основная.CounteragentID,
				|	&КСЧФДИС КАК ФункцияУПД,
				|	"""" КАК СостояниеОтправкиДополнительныхВПФ,
				|	ЛОЖЬ КАК ЭтоСчет				
				|ПОМЕСТИТЬ УКД_КСЧФДИС
				|ИЗ
				|	ВТ_ПодходящиеСЧФ КАК ВТ_ПодходящиеСЧФ
				|		ЛЕВОЕ СОЕДИНЕНИЕ СЧФ_Основная КАК СЧФ_Основная
				|		ПО ВТ_ПодходящиеСЧФ.Документ = СЧФ_Основная.Документ
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	СЧФ_Основная.ДокументОснование
				|ПОМЕСТИТЬ УКД_КСЧФДИС_ДокументыОснования
				|ИЗ
				|	ВТ_ПодходящиеСЧФ КАК ВТ_ПодходящиеСЧФ
				|		ЛЕВОЕ СОЕДИНЕНИЕ СЧФ_Основная КАК СЧФ_Основная
				|		ПО ВТ_ПодходящиеСЧФ.Документ = СЧФ_Основная.Документ
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ ВТ_ПодходящиеСЧФ";
				
				Запрос.Выполнить();
				
				Если ТипыДокументов = 0 ИЛИ ТипыДокументов = 6 Тогда
					МассивВременныхТаблиц.Добавить("УКД_КСЧФДИС");
				КонецЕсли;
				
			КонецПроцедуры
			
			Процедура ПодготовитьВТ_СчетаФактуры(Запрос, МассивВременныхТаблиц, ТипыДокументов) Экспорт
				
				Запрос.Текст=
				"ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	СЧФ_Основная.Документ,
				|	СЧФ_Основная.Продавец,
				|	СЧФ_Основная.Покупатель,
				|	СЧФ_Основная.Грузополучатель,
				|	СЧФ_Основная.СуммаДокументаЗначение,
				|	СЧФ_Основная.СуммаНДСЗначение,
				|	СЧФ_Основная.Валюта,
				|	СЧФ_Основная.Проведен,
				|	СЧФ_Основная.Дата,
				|	СЧФ_Основная.Номер,
				|	СЧФ_Основная.ID,
				|	СЧФ_Основная.CounteragentID,
				|	ВЫБОР
				|		КОГДА СЧФ_Основная.ВидСчетаФактуры = ЗНАЧЕНИЕ(Перечисление.ВидСчетаФактурыВыставленного.Корректировочный)
				|			ТОГДА 
				|				ВЫБОР
				|					КОГДА СЧФ_Основная.ФормироватьУПД В (&СФ, &СФТОРГ12АКТ)
				|						ТОГДА &КСФ
				|					КОГДА НЕ СЧФ_Основная.Исправление И СЧФ_Основная.ФормироватьУПД В (&СЧФДОП, &СЧФ, &СЧФ_ДОП)
				|						ТОГДА &КСЧФ
				|					ИНАЧЕ """"
				|				КОНЕЦ 
				|		КОГДА СЧФ_Основная.ВидСчетаФактуры В (ЗНАЧЕНИЕ(Перечисление.ВидСчетаФактурыВыставленного.НаРеализацию), ЗНАЧЕНИЕ(Перечисление.ВидСчетаФактурыВыставленного.НаАванс), ЗНАЧЕНИЕ(Перечисление.ВидСчетаФактурыВыставленного.НаАвансКомитента))
				|			ТОГДА 
				|				ВЫБОР
				|					КОГДА СЧФ_Основная.ФормироватьУПД В (&СФ, &СФТОРГ12АКТ)
				|						ТОГДА &СФ
				|					КОГДА НЕ СЧФ_Основная.Исправление И СЧФ_Основная.ФормироватьУПД В (&СЧФДОП, &СЧФ, &СЧФ_ДОП)
				|						ТОГДА &СЧФ
				|					ИНАЧЕ """"
				|				КОНЕЦ 
				|		ИНАЧЕ """"
				|	КОНЕЦ КАК ФункцияУПД,
				|	"""" КАК СостояниеОтправкиДополнительныхВПФ,
				|	ЛОЖЬ КАК ЭтоСчет
				|ПОМЕСТИТЬ СчетаФактуры_СчетФактураВыданный
				|ИЗ
				|	СЧФ_Основная КАК СЧФ_Основная
				|		ЛЕВОЕ СОЕДИНЕНИЕ УПД_СЧФДОП КАК УПД_СЧФДОП
				|		ПО СЧФ_Основная.Документ = УПД_СЧФДОП.Документ
				|		ЛЕВОЕ СОЕДИНЕНИЕ УКД_КСЧФДИС КАК УКД_КСЧФДИС
				|		ПО СЧФ_Основная.Документ = УКД_КСЧФДИС.Документ
				|ГДЕ
				|	УПД_СЧФДОП.Документ ЕСТЬ NULL
				|	И УКД_КСЧФДИС.Документ ЕСТЬ NULL
				|	И ВЫБОР
				|		КОГДА СЧФ_Основная.ВидСчетаФактуры = ЗНАЧЕНИЕ(Перечисление.ВидСчетаФактурыВыставленного.Корректировочный)
				|			И НЕ СЧФ_Основная.Исправление И СЧФ_Основная.ФормироватьУПД = &ДОП
				|				ТОГДА ЛОЖЬ
				|		ИНАЧЕ ИСТИНА
				|	КОНЕЦ
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ СЧФ_Основная";
				
				Запрос.Выполнить();
				
				МассивВременныхТаблиц.Добавить("СчетаФактуры_СчетФактураВыданный");
				
			КонецПроцедуры
			
			Процедура ПодготовитьВТ_АктыСверки(Запрос, МассивВременныхТаблиц) Экспорт
				
				Запрос.Текст=
				"ВЫБРАТЬ РАЗРЕШЕННЫЕ
				|	Т.Ссылка КАК Документ,
				|	Т.Организация КАК Продавец,
				|	Т.Контрагент КАК Покупатель,
				|	Т.ВалютаДокумента КАК Валюта,
				|	ИСТИНА КАК Проведен,
				|	Т.Дата,
				|	Т.Номер,
				|	ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") КАК ID,
				|	ОтборКонтрагенты.CounteragentID,
				|	0 КАК СуммаДокументаЗначение,
				|	0 КАК СуммаНДСЗначение,
				|	НЕОПРЕДЕЛЕНО КАК Грузополучатель,
				|	"""" КАК СостояниеОтправкиДополнительныхВПФ,
				|	"""" КАК ФункцияУПД,
				|	ЛОЖЬ КАК ЭтоСчет
				|ПОМЕСТИТЬ АктыСверки_АктСверкиВзаиморасчетов
				|ИЗ
				|	ОтборОрганизации КАК ОтборОрганизации
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.АктСверкиВзаиморасчетов КАК Т
				|		ПО (Т.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания)
				|			И (Т.Организация = ОтборОрганизации.Организация)
				|			И (НЕ Т.ПометкаУдаления)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборКонтрагенты КАК ОтборКонтрагенты
				|		ПО (Т.Контрагент = ОтборКонтрагенты.Контрагент)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ИдентификаторДокументаВДиадок
				|		ПО (Т.Ссылка = ИдентификаторДокументаВДиадок.Объект)
				|			И (ИдентификаторДокументаВДиадок.Свойство = &ИдентификаторДокументаВДиадок)
				|ГДЕ
				|	ОтборОрганизации.СпособОтправкиСверки = ""АктСверкиВзаиморасчетов""
				|	И (ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") = """"
				|			ИЛИ ИдентификаторДокументаВДиадок.Значение ПОДОБНО ""усл:%"")";
				
				Запрос.Выполнить();
				
				МассивВременныхТаблиц.Добавить("АктыСверки_АктСверкиВзаиморасчетов");
				
			КонецПроцедуры
			
			
			Процедура ПодготовитьВТ_Накладные_РеализацияТоваровУслуг(Запрос, МассивВременныхТаблиц) Экспорт
				
				Запрос.Текст=
				"ВЫБРАТЬ РАЗРЕШЕННЫЕ
				|	Т.Ссылка КАК Документ,
				|	Т.Организация КАК Продавец,
				|	Т.Контрагент КАК Покупатель,
				|	НЕОПРЕДЕЛЕНО КАК Грузополучатель,
				|	Т.СуммаДокумента КАК СуммаДокументаЗначение,
				|	Т.ВалютаДокумента КАК Валюта,
				|	Т.Проведен,
				|	Т.Дата,
				|	Т.Номер,
				|	ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") КАК ID,
				|	ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """") КАК СостояниеОтправкиДополнительныхВПФ,
				|	ОтборКонтрагенты.CounteragentID,
				|	ЕСТЬNULL(ОтборКонтрагенты.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД) КАК ФормироватьУПД,
				|	ВЫБОР
				|		КОГДА ЕСТЬNULL(ОтборКонтрагенты.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД) В (&СЧФДОП, &ДОП, &СЧФ_ДОП)
				|			ТОГДА &ДОП
				|		КОГДА ЕСТЬNULL(ОтборКонтрагенты.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД) В (&ТОРГ12АКТ, &СФТОРГ12АКТ)
				|			ТОГДА &ТОРГ12АКТ
				|		ИНАЧЕ """"
				|	КОНЕЦ КАК ФункцияУПД,
				|	ОтборОрганизации.ОтпрНеПроведенные
				|ПОМЕСТИТЬ ВТ_Основная
				|ИЗ
				|	ОтборОрганизации КАК ОтборОрганизации
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК Т
				|		ПО (Т.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания)
				|			И (Т.Организация = ОтборОрганизации.Организация)
				|			И (Т.Проведен)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборКонтрагенты КАК ОтборКонтрагенты
				|		ПО (Т.Контрагент = ОтборКонтрагенты.Контрагент)
				|		ЛЕВОЕ СОЕДИНЕНИЕ ОтборГрузополучатели КАК ОтборГрузополучатели
				|		ПО (Т.Контрагент = ОтборГрузополучатели.Контрагент)
				|			И (Т.Грузополучатель = ОтборГрузополучатели.Грузополучатель)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ИдентификаторДокументаВДиадок
				|		ПО (Т.Ссылка = ИдентификаторДокументаВДиадок.Объект)
				|			И (ИдентификаторДокументаВДиадок.Свойство = &ИдентификаторДокументаВДиадок)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК СтатусОтправляемыхВПФ
				|		ПО (Т.Ссылка = СтатусОтправляемыхВПФ.Объект)
				|			И (СтатусОтправляемыхВПФ.Свойство = &СвойствоДиадокСтатусОтправляемыхВПФ)
				|		ЛЕВОЕ СОЕДИНЕНИЕ УПД_СЧФДОП_ДокументыОснования КАК УПД_СЧФДОП_ДокументыОснования
				|		ПО (Т.Ссылка = УПД_СЧФДОП_ДокументыОснования.ДокументОснование)
				|ГДЕ
				|	НЕ ОтборОрганизации.ОтпрНеПроведенные
				|	И УПД_СЧФДОП_ДокументыОснования.ДокументОснование ЕСТЬ NULL
				|	И ОтборГрузополучатели.Контрагент ЕСТЬ NULL
				|	И (ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") = """"
				|			ИЛИ ИдентификаторДокументаВДиадок.Значение ПОДОБНО ""усл:%""
				|			ИЛИ ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """") ПОДОБНО ""%[НУ]%"")
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	Т.Ссылка,
				|	Т.Организация,
				|	Т.Контрагент,
				|	НЕОПРЕДЕЛЕНО,
				|	Т.СуммаДокумента,
				|	Т.ВалютаДокумента,
				|	Т.Проведен,
				|	Т.Дата,
				|	Т.Номер,
				|	ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """"),
				|	ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """"),
				|	ОтборКонтрагенты.CounteragentID,
				|	ЕСТЬNULL(ОтборКонтрагенты.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД),
				|	ВЫБОР
				|		КОГДА ЕСТЬNULL(ОтборКонтрагенты.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД) В (&СЧФДОП, &ДОП, &СЧФ_ДОП)
				|			ТОГДА &ДОП
				|		КОГДА ЕСТЬNULL(ОтборКонтрагенты.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД) В (&ТОРГ12АКТ, &СФТОРГ12АКТ)
				|			ТОГДА &ТОРГ12АКТ
				|		ИНАЧЕ """"
				|	КОНЕЦ,
				|	ОтборОрганизации.ОтпрНеПроведенные
				|ИЗ
				|	ОтборОрганизации КАК ОтборОрганизации
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК Т
				|		ПО (Т.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания)
				|			И (Т.Организация = ОтборОрганизации.Организация)
				|			И (НЕ Т.ПометкаУдаления)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборКонтрагенты КАК ОтборКонтрагенты
				|		ПО (Т.Контрагент = ОтборКонтрагенты.Контрагент)
				|		ЛЕВОЕ СОЕДИНЕНИЕ ОтборГрузополучатели КАК ОтборГрузополучатели
				|		ПО (Т.Контрагент = ОтборГрузополучатели.Контрагент)
				|			И (Т.Грузополучатель = ОтборГрузополучатели.Грузополучатель)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ИдентификаторДокументаВДиадок
				|		ПО (Т.Ссылка = ИдентификаторДокументаВДиадок.Объект)
				|			И (ИдентификаторДокументаВДиадок.Свойство = &ИдентификаторДокументаВДиадок)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК СтатусОтправляемыхВПФ
				|		ПО (Т.Ссылка = СтатусОтправляемыхВПФ.Объект)
				|			И (СтатусОтправляемыхВПФ.Свойство = &СвойствоДиадокСтатусОтправляемыхВПФ)
				|		ЛЕВОЕ СОЕДИНЕНИЕ УПД_СЧФДОП_ДокументыОснования КАК УПД_СЧФДОП_ДокументыОснования
				|		ПО (Т.Ссылка = УПД_СЧФДОП_ДокументыОснования.ДокументОснование)
				|ГДЕ
				|	ОтборОрганизации.ОтпрНеПроведенные
				|	И УПД_СЧФДОП_ДокументыОснования.ДокументОснование ЕСТЬ NULL
				|	И ОтборГрузополучатели.Контрагент ЕСТЬ NULL
				|	И (ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") = """"
				|			ИЛИ ИдентификаторДокументаВДиадок.Значение ПОДОБНО ""усл:%""
				|			ИЛИ ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """") ПОДОБНО ""%[НУ]%"")
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	Т.Ссылка,
				|	Т.Организация,
				|	Т.Контрагент,
				|	Т.Грузополучатель,
				|	Т.СуммаДокумента,
				|	Т.ВалютаДокумента,
				|	Т.Проведен,
				|	Т.Дата,
				|	Т.Номер,
				|	ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """"),
				|	ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """"),
				|	ОтборГрузополучатели.CounteragentID,
				|	ЕСТЬNULL(ОтборГрузополучатели.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД),
				|	ВЫБОР
				|		КОГДА ЕСТЬNULL(ОтборГрузополучатели.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД) В (&СЧФДОП, &ДОП, &СЧФ_ДОП)
				|			ТОГДА &ДОП
				|		КОГДА ЕСТЬNULL(ОтборГрузополучатели.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД) В (&ТОРГ12АКТ, &СФТОРГ12АКТ)
				|			ТОГДА &ТОРГ12АКТ
				|		ИНАЧЕ """"
				|	КОНЕЦ,
				|	ОтборОрганизации.ОтпрНеПроведенные
				|ИЗ
				|	ОтборОрганизации КАК ОтборОрганизации
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК Т
				|		ПО (Т.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания)
				|			И (Т.Организация = ОтборОрганизации.Организация)
				|			И (Т.Проведен)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборГрузополучатели КАК ОтборГрузополучатели
				|		ПО (Т.Контрагент = ОтборГрузополучатели.Контрагент)
				|			И (Т.Грузополучатель = ОтборГрузополучатели.Грузополучатель)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ИдентификаторДокументаВДиадок
				|		ПО (Т.Ссылка = ИдентификаторДокументаВДиадок.Объект)
				|			И (ИдентификаторДокументаВДиадок.Свойство = &ИдентификаторДокументаВДиадок)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК СтатусОтправляемыхВПФ
				|		ПО (Т.Ссылка = СтатусОтправляемыхВПФ.Объект)
				|			И (СтатусОтправляемыхВПФ.Свойство = &СвойствоДиадокСтатусОтправляемыхВПФ)
				|		ЛЕВОЕ СОЕДИНЕНИЕ УПД_СЧФДОП_ДокументыОснования КАК УПД_СЧФДОП_ДокументыОснования
				|		ПО (Т.Ссылка = УПД_СЧФДОП_ДокументыОснования.ДокументОснование)
				|ГДЕ
				|	НЕ ОтборОрганизации.ОтпрНеПроведенные
				|	И УПД_СЧФДОП_ДокументыОснования.ДокументОснование ЕСТЬ NULL
				|	И (ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") = """"
				|			ИЛИ ИдентификаторДокументаВДиадок.Значение ПОДОБНО ""усл:%""
				|			ИЛИ ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """") ПОДОБНО ""%[НУ]%"")
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	Т.Ссылка,
				|	Т.Организация,
				|	Т.Контрагент,
				|	Т.Грузополучатель,
				|	Т.СуммаДокумента,
				|	Т.ВалютаДокумента,
				|	Т.Проведен,
				|	Т.Дата,
				|	Т.Номер,
				|	ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """"),
				|	ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """"),
				|	ОтборГрузополучатели.CounteragentID,
				|	ЕСТЬNULL(ОтборГрузополучатели.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД),
				|	ВЫБОР
				|		КОГДА ЕСТЬNULL(ОтборГрузополучатели.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД) В (&СЧФДОП, &ДОП, &СЧФ_ДОП)
				|			ТОГДА &ДОП
				|		КОГДА ЕСТЬNULL(ОтборГрузополучатели.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД) В (&ТОРГ12АКТ, &СФТОРГ12АКТ)
				|			ТОГДА &ТОРГ12АКТ
				|		ИНАЧЕ """"
				|	КОНЕЦ,
				|	ОтборОрганизации.ОтпрНеПроведенные
				|ИЗ
				|	ОтборОрганизации КАК ОтборОрганизации
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК Т
				|		ПО (Т.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания)
				|			И (Т.Организация = ОтборОрганизации.Организация)
				|			И (НЕ Т.ПометкаУдаления)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборГрузополучатели КАК ОтборГрузополучатели
				|		ПО (Т.Контрагент = ОтборГрузополучатели.Контрагент)
				|			И (Т.Грузополучатель = ОтборГрузополучатели.Грузополучатель)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ИдентификаторДокументаВДиадок
				|		ПО (Т.Ссылка = ИдентификаторДокументаВДиадок.Объект)
				|			И (ИдентификаторДокументаВДиадок.Свойство = &ИдентификаторДокументаВДиадок)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК СтатусОтправляемыхВПФ
				|		ПО (Т.Ссылка = СтатусОтправляемыхВПФ.Объект)
				|			И (СтатусОтправляемыхВПФ.Свойство = &СвойствоДиадокСтатусОтправляемыхВПФ)
				|		ЛЕВОЕ СОЕДИНЕНИЕ УПД_СЧФДОП_ДокументыОснования КАК УПД_СЧФДОП_ДокументыОснования
				|		ПО (Т.Ссылка = УПД_СЧФДОП_ДокументыОснования.ДокументОснование)
				|ГДЕ
				|	ОтборОрганизации.ОтпрНеПроведенные
				|	И УПД_СЧФДОП_ДокументыОснования.ДокументОснование ЕСТЬ NULL
				|	И (ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") = """"
				|			ИЛИ ИдентификаторДокументаВДиадок.Значение ПОДОБНО ""усл:%""
				|			ИЛИ ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """") ПОДОБНО ""%[НУ]%"")
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ВложенныйЗапрос.Документ,
				|	СУММА(ВложенныйЗапрос.СуммаНДС) КАК СуммаНДС
				|ПОМЕСТИТЬ ВТ_СуммаНДСЗначение
				|ИЗ
				|	(ВЫБРАТЬ
				|		ВТ_Основная.Документ КАК Документ,
				|		Товары.СуммаНДС КАК СуммаНДС
				|	ИЗ
				|		ВТ_Основная КАК ВТ_Основная
				|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Товары КАК Товары
				|			ПО ВТ_Основная.Документ = Товары.Ссылка
				|	
				|	ОБЪЕДИНИТЬ ВСЕ
				|	
				|	ВЫБРАТЬ
				|		ВТ_Основная.Документ,
				|		Услуги.СуммаНДС
				|	ИЗ
				|		ВТ_Основная КАК ВТ_Основная
				|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Услуги КАК Услуги
				|			ПО ВТ_Основная.Документ = Услуги.Ссылка) КАК ВложенныйЗапрос
				|
				|СГРУППИРОВАТЬ ПО
				|	ВложенныйЗапрос.Документ
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	ВТ_Основная.Документ
				|ПОМЕСТИТЬ ВТ_ЕстьСЧФ
				|ИЗ
				|	ВТ_Основная КАК ВТ_Основная
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный.ДокументыОснования КАК СЧФ_ДокументыОснования
				|		ПО ВТ_Основная.Документ = СЧФ_ДокументыОснования.ДокументОснование
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный КАК СЧФ
				|		ПО (СЧФ_ДокументыОснования.Ссылка = СЧФ.Ссылка)
				|			И (СЧФ.Проведен)
				|ГДЕ
				|	НЕ ВТ_Основная.ОтпрНеПроведенные
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	ВТ_Основная.Документ
				|ИЗ
				|	ВТ_Основная КАК ВТ_Основная
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный.ДокументыОснования КАК СЧФ_ДокументыОснования
				|		ПО ВТ_Основная.Документ = СЧФ_ДокументыОснования.ДокументОснование
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный КАК СЧФ
				|		ПО (СЧФ_ДокументыОснования.Ссылка = СЧФ.Ссылка)
				|			И (НЕ СЧФ.ПометкаУдаления)
				|ГДЕ
				|	ВТ_Основная.ОтпрНеПроведенные
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ВТ_Основная.Документ,
				|	ВТ_Основная.Продавец,
				|	ВТ_Основная.Покупатель,
				|	ВТ_Основная.Грузополучатель,
				|	ВТ_Основная.СуммаДокументаЗначение,
				|	ЕСТЬNULL(ВТ_СуммаНДСЗначение.СуммаНДС, 0) КАК СуммаНДСЗначение,
				|	ВТ_Основная.Валюта,
				|	ВТ_Основная.Проведен,
				|	ВТ_Основная.Дата,
				|	ВТ_Основная.Номер,
				|	ВТ_Основная.ID,
				|	ВТ_Основная.СостояниеОтправкиДополнительныхВПФ,
				|	ВТ_Основная.ФункцияУПД,
				|	ВТ_Основная.CounteragentID,
				|	ЛОЖЬ КАК ЭтоСчет
				|ПОМЕСТИТЬ Накладные_РеализацияТоваровУслуг
				|ИЗ
				|	ВТ_Основная КАК ВТ_Основная
				|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ЕстьСЧФ КАК ВТ_ЕстьСЧФ
				|		ПО ВТ_Основная.Документ = ВТ_ЕстьСЧФ.Документ
				|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СуммаНДСЗначение КАК ВТ_СуммаНДСЗначение
				|		ПО ВТ_Основная.Документ = ВТ_СуммаНДСЗначение.Документ
				|ГДЕ
				|	(ВТ_ЕстьСЧФ.Документ ЕСТЬ НЕ NULL 
				|			ИЛИ ВТ_Основная.ФормироватьУПД <> &СЧФДОП
				|			ИЛИ ВТ_Основная.ФормироватьУПД = &СЧФДОП
				|				И ЕСТЬNULL(ВТ_СуммаНДСЗначение.СуммаНДС, 0) = 0)
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ ВТ_Основная
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ ВТ_ЕстьСЧФ
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ ВТ_СуммаНДСЗначение";
				
				Запрос.Выполнить();
				
				МассивВременныхТаблиц.Добавить("Накладные_РеализацияТоваровУслуг");
				
			КонецПроцедуры
			
			Процедура ПодготовитьВТ_Накладные_КорректировкаРеализации(Запрос, МассивВременныхТаблиц) Экспорт
				
				Запрос.Текст=
				"ВЫБРАТЬ РАЗРЕШЕННЫЕ
				|	Т.Ссылка КАК Документ,
				|	Т.Организация КАК Продавец,
				|	Т.Контрагент КАК Покупатель,
				|	НЕОПРЕДЕЛЕНО КАК Грузополучатель,
				|	Т.СуммаДокумента КАК СуммаДокументаЗначение,
				|	Т.ВалютаДокумента КАК Валюта,
				|	Т.Проведен,
				|	Т.Дата,
				|	Т.Номер,
				|	ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") КАК ID,
				|	ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """") КАК СостояниеОтправкиДополнительныхВПФ,
				|	ОтборКонтрагенты.CounteragentID,
				|	ЕСТЬNULL(ОтборКонтрагенты.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД) КАК ФормироватьУПД,
				|	ВЫБОР
				|		КОГДА ЕСТЬNULL(ОтборКонтрагенты.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД) В (&СЧФДОП, &ДОП, &СЧФ_ДОП)
				|			И Т.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийИсправленияПоступленияРеализации.СогласованноеИзменение)
				|				ТОГДА &ДИС
				|		ИНАЧЕ """"
				|	КОНЕЦ КАК ФункцияУПД,
				|	ОтборОрганизации.ОтпрНеПроведенные
				|ПОМЕСТИТЬ ВТ_Основная
				|ИЗ
				|	ОтборОрганизации КАК ОтборОрганизации
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КорректировкаРеализации КАК Т
				|		ПО (Т.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания)
				|			И (Т.Организация = ОтборОрганизации.Организация)
				|			И (Т.Проведен)
				|			И (НЕ Т.ДокументРеализации ССЫЛКА Документ.СчетФактураВыданный)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборКонтрагенты КАК ОтборКонтрагенты
				|		ПО (Т.Контрагент = ОтборКонтрагенты.Контрагент)
				|		ЛЕВОЕ СОЕДИНЕНИЕ ОтборГрузополучатели КАК ОтборГрузополучатели
				|		ПО (Т.Контрагент = ОтборГрузополучатели.Контрагент)
				|			И (Т.Грузополучатель = ОтборГрузополучатели.Грузополучатель)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ИдентификаторДокументаВДиадок
				|		ПО (Т.Ссылка = ИдентификаторДокументаВДиадок.Объект)
				|			И (ИдентификаторДокументаВДиадок.Свойство = &ИдентификаторДокументаВДиадок)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК СтатусОтправляемыхВПФ
				|		ПО (Т.Ссылка = СтатусОтправляемыхВПФ.Объект)
				|			И (СтатусОтправляемыхВПФ.Свойство = &СвойствоДиадокСтатусОтправляемыхВПФ)
				|		ЛЕВОЕ СОЕДИНЕНИЕ УКД_КСЧФДИС_ДокументыОснования КАК УКД_КСЧФДИС_ДокументыОснования
				|		ПО (Т.Ссылка = УКД_КСЧФДИС_ДокументыОснования.ДокументОснование)
				|ГДЕ
				|	НЕ ОтборОрганизации.ОтпрНеПроведенные
				|	И УКД_КСЧФДИС_ДокументыОснования.ДокументОснование ЕСТЬ NULL
				|	И ВЫБОР
				|		КОГДА НЕ ЕСТЬNULL(ОтборКонтрагенты.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД) В (&СЧФДОП, &ДОП, &СЧФ_ДОП)
				|			ТОГДА Т.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийИсправленияПоступленияРеализации.ИсправлениеОшибки)
				|		ИНАЧЕ ИСТИНА
				|	КОНЕЦ
				|	И ОтборГрузополучатели.Контрагент ЕСТЬ NULL 
				|	И (ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") = """"
				|			ИЛИ ИдентификаторДокументаВДиадок.Значение ПОДОБНО ""усл:%""
				|			ИЛИ ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """") ПОДОБНО ""%[НУ]%"")
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	Т.Ссылка,
				|	Т.Организация,
				|	Т.Контрагент,
				|	НЕОПРЕДЕЛЕНО,
				|	Т.СуммаДокумента,
				|	Т.ВалютаДокумента,
				|	Т.Проведен,
				|	Т.Дата,
				|	Т.Номер,
				|	ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """"),
				|	ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """"),
				|	ОтборКонтрагенты.CounteragentID,
				|	ЕСТЬNULL(ОтборКонтрагенты.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД),
				|	ВЫБОР
				|		КОГДА ЕСТЬNULL(ОтборКонтрагенты.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД) В (&СЧФДОП, &ДОП, &СЧФ_ДОП)
				|			И Т.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийИсправленияПоступленияРеализации.СогласованноеИзменение)
				|				ТОГДА &ДИС
				|		ИНАЧЕ """"
				|	КОНЕЦ,
				|	ОтборОрганизации.ОтпрНеПроведенные
				|ИЗ
				|	ОтборОрганизации КАК ОтборОрганизации
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КорректировкаРеализации КАК Т
				|		ПО (Т.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания)
				|			И (Т.Организация = ОтборОрганизации.Организация)
				|			И (НЕ Т.ПометкаУдаления)
				|			И (НЕ Т.ДокументРеализации ССЫЛКА Документ.СчетФактураВыданный)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборКонтрагенты КАК ОтборКонтрагенты
				|		ПО (Т.Контрагент = ОтборКонтрагенты.Контрагент)
				|		ЛЕВОЕ СОЕДИНЕНИЕ ОтборГрузополучатели КАК ОтборГрузополучатели
				|		ПО (Т.Контрагент = ОтборГрузополучатели.Контрагент)
				|			И (Т.Грузополучатель = ОтборГрузополучатели.Грузополучатель)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ИдентификаторДокументаВДиадок
				|		ПО (Т.Ссылка = ИдентификаторДокументаВДиадок.Объект)
				|			И (ИдентификаторДокументаВДиадок.Свойство = &ИдентификаторДокументаВДиадок)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК СтатусОтправляемыхВПФ
				|		ПО (Т.Ссылка = СтатусОтправляемыхВПФ.Объект)
				|			И (СтатусОтправляемыхВПФ.Свойство = &СвойствоДиадокСтатусОтправляемыхВПФ)
				|		ЛЕВОЕ СОЕДИНЕНИЕ УКД_КСЧФДИС_ДокументыОснования КАК УКД_КСЧФДИС_ДокументыОснования
				|		ПО (Т.Ссылка = УКД_КСЧФДИС_ДокументыОснования.ДокументОснование)
				|ГДЕ
				|	ОтборОрганизации.ОтпрНеПроведенные
				|	И УКД_КСЧФДИС_ДокументыОснования.ДокументОснование ЕСТЬ NULL
				|	И ВЫБОР
				|		КОГДА НЕ ЕСТЬNULL(ОтборКонтрагенты.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД) В (&СЧФДОП, &ДОП, &СЧФ_ДОП)
				|			ТОГДА Т.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийИсправленияПоступленияРеализации.ИсправлениеОшибки)
				|		ИНАЧЕ ИСТИНА
				|	КОНЕЦ
				|	И ОтборГрузополучатели.Контрагент ЕСТЬ NULL 
				|	И (ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") = """"
				|			ИЛИ ИдентификаторДокументаВДиадок.Значение ПОДОБНО ""усл:%""
				|			ИЛИ ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """") ПОДОБНО ""%[НУ]%"")
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	Т.Ссылка,
				|	Т.Организация,
				|	Т.Контрагент,
				|	Т.Грузополучатель,
				|	Т.СуммаДокумента,
				|	Т.ВалютаДокумента,
				|	Т.Проведен,
				|	Т.Дата,
				|	Т.Номер,
				|	ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """"),
				|	ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """"),
				|	ОтборГрузополучатели.CounteragentID,
				|	ЕСТЬNULL(ОтборГрузополучатели.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД),
				|	ВЫБОР
				|		КОГДА ЕСТЬNULL(ОтборГрузополучатели.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД) В (&СЧФДОП, &ДОП, &СЧФ_ДОП)
				|			И Т.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийИсправленияПоступленияРеализации.СогласованноеИзменение)
				|				ТОГДА &ДИС
				|		ИНАЧЕ """"
				|	КОНЕЦ,
				|	ОтборОрганизации.ОтпрНеПроведенные
				|ИЗ
				|	ОтборОрганизации КАК ОтборОрганизации
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КорректировкаРеализации КАК Т
				|		ПО (Т.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания)
				|			И (Т.Организация = ОтборОрганизации.Организация)
				|			И (Т.Проведен)
				|			И (НЕ Т.ДокументРеализации ССЫЛКА Документ.СчетФактураВыданный)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборГрузополучатели КАК ОтборГрузополучатели
				|		ПО (Т.Контрагент = ОтборГрузополучатели.Контрагент)
				|			И (Т.Грузополучатель = ОтборГрузополучатели.Грузополучатель)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ИдентификаторДокументаВДиадок
				|		ПО (Т.Ссылка = ИдентификаторДокументаВДиадок.Объект)
				|			И (ИдентификаторДокументаВДиадок.Свойство = &ИдентификаторДокументаВДиадок)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК СтатусОтправляемыхВПФ
				|		ПО (Т.Ссылка = СтатусОтправляемыхВПФ.Объект)
				|			И (СтатусОтправляемыхВПФ.Свойство = &СвойствоДиадокСтатусОтправляемыхВПФ)
				|		ЛЕВОЕ СОЕДИНЕНИЕ УКД_КСЧФДИС_ДокументыОснования КАК УКД_КСЧФДИС_ДокументыОснования
				|		ПО (Т.Ссылка = УКД_КСЧФДИС_ДокументыОснования.ДокументОснование)
				|ГДЕ
				|	НЕ ОтборОрганизации.ОтпрНеПроведенные
				|	И УКД_КСЧФДИС_ДокументыОснования.ДокументОснование ЕСТЬ NULL 
				|	И ВЫБОР
				|		КОГДА НЕ ЕСТЬNULL(ОтборГрузополучатели.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД) В (&СЧФДОП, &ДОП, &СЧФ_ДОП)
				|			ТОГДА Т.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийИсправленияПоступленияРеализации.ИсправлениеОшибки)
				|		ИНАЧЕ ИСТИНА
				|	КОНЕЦ
				|	И (ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") = """"
				|			ИЛИ ИдентификаторДокументаВДиадок.Значение ПОДОБНО ""усл:%""
				|			ИЛИ ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """") ПОДОБНО ""%[НУ]%"")
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	Т.Ссылка,
				|	Т.Организация,
				|	Т.Контрагент,
				|	Т.Грузополучатель,
				|	Т.СуммаДокумента,
				|	Т.ВалютаДокумента,
				|	Т.Проведен,
				|	Т.Дата,
				|	Т.Номер,
				|	ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """"),
				|	ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """"),
				|	ОтборГрузополучатели.CounteragentID,
				|	ЕСТЬNULL(ОтборГрузополучатели.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД),
				|	ВЫБОР
				|		КОГДА ЕСТЬNULL(ОтборГрузополучатели.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД) В (&СЧФДОП, &ДОП, &СЧФ_ДОП)
				|			И Т.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийИсправленияПоступленияРеализации.СогласованноеИзменение)
				|				ТОГДА &ДИС
				|		ИНАЧЕ """"
				|	КОНЕЦ,
				|	ОтборОрганизации.ОтпрНеПроведенные
				|ИЗ
				|	ОтборОрганизации КАК ОтборОрганизации
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КорректировкаРеализации КАК Т
				|		ПО (Т.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания)
				|			И (Т.Организация = ОтборОрганизации.Организация)
				|			И (НЕ Т.ПометкаУдаления)
				|			И (НЕ Т.ДокументРеализации ССЫЛКА Документ.СчетФактураВыданный)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборГрузополучатели КАК ОтборГрузополучатели
				|		ПО (Т.Контрагент = ОтборГрузополучатели.Контрагент)
				|			И (Т.Грузополучатель = ОтборГрузополучатели.Грузополучатель)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ИдентификаторДокументаВДиадок
				|		ПО (Т.Ссылка = ИдентификаторДокументаВДиадок.Объект)
				|			И (ИдентификаторДокументаВДиадок.Свойство = &ИдентификаторДокументаВДиадок)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК СтатусОтправляемыхВПФ
				|		ПО (Т.Ссылка = СтатусОтправляемыхВПФ.Объект)
				|			И (СтатусОтправляемыхВПФ.Свойство = &СвойствоДиадокСтатусОтправляемыхВПФ)
				|		ЛЕВОЕ СОЕДИНЕНИЕ УКД_КСЧФДИС_ДокументыОснования КАК УКД_КСЧФДИС_ДокументыОснования
				|		ПО (Т.Ссылка = УКД_КСЧФДИС_ДокументыОснования.ДокументОснование)
				|ГДЕ
				|	ОтборОрганизации.ОтпрНеПроведенные
				|	И УКД_КСЧФДИС_ДокументыОснования.ДокументОснование ЕСТЬ NULL
				|	И ВЫБОР
				|		КОГДА НЕ ЕСТЬNULL(ОтборГрузополучатели.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД) В (&СЧФДОП, &ДОП, &СЧФ_ДОП)
				|			ТОГДА Т.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийИсправленияПоступленияРеализации.ИсправлениеОшибки)
				|		ИНАЧЕ ИСТИНА
				|	КОНЕЦ
				|	И (ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") = """"
				|			ИЛИ ИдентификаторДокументаВДиадок.Значение ПОДОБНО ""усл:%""
				|			ИЛИ ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """") ПОДОБНО ""%[НУ]%"")
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ВложенныйЗапрос.Документ,
				|	СУММА(ВложенныйЗапрос.СуммаНДС) КАК СуммаНДС
				|ПОМЕСТИТЬ ВТ_СуммаНДСЗначение
				|ИЗ
				|	(ВЫБРАТЬ
				|		ВТ_Основная.Документ КАК Документ,
				|		Т.СуммаНДС КАК СуммаНДС
				|	ИЗ
				|		ВТ_Основная КАК ВТ_Основная
				|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КорректировкаРеализации.Товары КАК Т
				|			ПО ВТ_Основная.Документ = Т.Ссылка
				|	
				|	ОБЪЕДИНИТЬ ВСЕ
				|	
				|	ВЫБРАТЬ
				|		ВТ_Основная.Документ,
				|		Т.СуммаНДС
				|	ИЗ
				|		ВТ_Основная КАК ВТ_Основная
				|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КорректировкаРеализации.Услуги КАК Т
				|			ПО ВТ_Основная.Документ = Т.Ссылка) КАК ВложенныйЗапрос
				|
				|СГРУППИРОВАТЬ ПО
				|	ВложенныйЗапрос.Документ
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	ВТ_Основная.Документ
				|ПОМЕСТИТЬ ВТ_ЕстьСЧФ
				|ИЗ
				|	ВТ_Основная КАК ВТ_Основная
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный.ДокументыОснования КАК СЧФ_ДокументыОснования
				|		ПО ВТ_Основная.Документ = СЧФ_ДокументыОснования.ДокументОснование
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный КАК СЧФ
				|		ПО (СЧФ_ДокументыОснования.Ссылка = СЧФ.Ссылка)
				|			И (СЧФ.Проведен)
				|ГДЕ
				|	НЕ ВТ_Основная.ОтпрНеПроведенные
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	ВТ_Основная.Документ
				|ИЗ
				|	ВТ_Основная КАК ВТ_Основная
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный.ДокументыОснования КАК СЧФ_ДокументыОснования
				|		ПО ВТ_Основная.Документ = СЧФ_ДокументыОснования.ДокументОснование
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный КАК СЧФ
				|		ПО (СЧФ_ДокументыОснования.Ссылка = СЧФ.Ссылка)
				|			И (НЕ СЧФ.ПометкаУдаления)
				|ГДЕ
				|	ВТ_Основная.ОтпрНеПроведенные
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ВТ_Основная.Документ,
				|	ВТ_Основная.Продавец,
				|	ВТ_Основная.Покупатель,
				|	ВТ_Основная.Грузополучатель,
				|	ВТ_Основная.СуммаДокументаЗначение,
				|	ЕСТЬNULL(ВТ_СуммаНДСЗначение.СуммаНДС, 0) КАК СуммаНДСЗначение,
				|	ВТ_Основная.Валюта,
				|	ВТ_Основная.Проведен,
				|	ВТ_Основная.Дата,
				|	ВТ_Основная.Номер,
				|	ВТ_Основная.ID,
				|	ВТ_Основная.СостояниеОтправкиДополнительныхВПФ,
				|	ВТ_Основная.CounteragentID,
				|	ВТ_Основная.ФункцияУПД,
				|	ЛОЖЬ КАК ЭтоСчет
				|ПОМЕСТИТЬ Накладные_КорректировкаРеализации
				|ИЗ
				|	ВТ_Основная КАК ВТ_Основная
				|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ЕстьСЧФ КАК ВТ_ЕстьСЧФ
				|		ПО ВТ_Основная.Документ = ВТ_ЕстьСЧФ.Документ
				|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СуммаНДСЗначение КАК ВТ_СуммаНДСЗначение
				|		ПО ВТ_Основная.Документ = ВТ_СуммаНДСЗначение.Документ
				|ГДЕ
				|	(ВТ_ЕстьСЧФ.Документ ЕСТЬ НЕ NULL 
				|			ИЛИ ВТ_Основная.ФормироватьУПД <> &СЧФДОП
				|			ИЛИ ВТ_Основная.ФормироватьУПД = &СЧФДОП
				|				И ЕСТЬNULL(ВТ_СуммаНДСЗначение.СуммаНДС, 0) = 0)
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ ВТ_Основная
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ ВТ_ЕстьСЧФ
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ ВТ_СуммаНДСЗначение";
				
				Запрос.Выполнить();
				
				МассивВременныхТаблиц.Добавить("Накладные_КорректировкаРеализации");
				
			КонецПроцедуры
			
			Процедура ПодготовитьВТ_Накладные_ВозвратТоваровПоставщику(Запрос, МассивВременныхТаблиц) Экспорт
				
				Запрос.Текст=
				"ВЫБРАТЬ РАЗРЕШЕННЫЕ
				|	Т.Ссылка КАК Документ,
				|	Т.Организация КАК Продавец,
				|	Т.Контрагент КАК Покупатель,
				|	Т.СуммаДокумента КАК СуммаДокументаЗначение,
				|	Т.ВалютаДокумента КАК Валюта,
				|	Т.Проведен,
				|	Т.Дата,
				|	Т.Номер,
				|	ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") КАК ID,
				|	ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """") КАК СостояниеОтправкиДополнительныхВПФ,
				|	ЕСТЬNULL(ОтборКонтрагенты.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД) КАК ФормироватьУПД,
				|	ВЫБОР
				|		КОГДА ЕСТЬNULL(ОтборКонтрагенты.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД) В (&СЧФДОП, &ДОП, &СЧФ_ДОП)
				|			ТОГДА &ДОП
				|		КОГДА ЕСТЬNULL(ОтборКонтрагенты.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД) В (&ТОРГ12АКТ, &СФТОРГ12АКТ)
				|			ТОГДА &ТОРГ12АКТ
				|		ИНАЧЕ """"
				|	КОНЕЦ КАК ФункцияУПД,
				|	ОтборКонтрагенты.CounteragentID,
				|	ОтборОрганизации.ОтпрНеПроведенные КАК ОтпрНеПроведенные
				|ПОМЕСТИТЬ ВТ_Основная_Шаг1
				|ИЗ
				|	ОтборОрганизации КАК ОтборОрганизации
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВозвратТоваровПоставщику КАК Т
				|		ПО (Т.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания)
				|			И (Т.Организация = ОтборОрганизации.Организация)
				|			И (Т.Проведен)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборКонтрагенты КАК ОтборКонтрагенты
				|		ПО Т.Контрагент = ОтборКонтрагенты.Контрагент
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ИдентификаторДокументаВДиадок
				|		ПО (Т.Ссылка = ИдентификаторДокументаВДиадок.Объект)
				|			И (ИдентификаторДокументаВДиадок.Свойство = &ИдентификаторДокументаВДиадок)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК СтатусОтправляемыхВПФ
				|		ПО (Т.Ссылка = СтатусОтправляемыхВПФ.Объект)
				|			И (СтатусОтправляемыхВПФ.Свойство = &СвойствоДиадокСтатусОтправляемыхВПФ)
				|		ЛЕВОЕ СОЕДИНЕНИЕ УПД_СЧФДОП_ДокументыОснования КАК УПД_СЧФДОП_ДокументыОснования
				|		ПО (Т.Ссылка = УПД_СЧФДОП_ДокументыОснования.ДокументОснование)
				|ГДЕ
				|	НЕ ОтборОрганизации.ОтпрНеПроведенные
				|	И УПД_СЧФДОП_ДокументыОснования.ДокументОснование ЕСТЬ NULL 
				|	И (ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") = """"
				|			ИЛИ ИдентификаторДокументаВДиадок.Значение ПОДОБНО ""усл:%""
				|			ИЛИ ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """") ПОДОБНО ""%[НУ]%"")
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	Т.Ссылка,
				|	Т.Организация,
				|	Т.Контрагент,
				|	Т.СуммаДокумента,
				|	Т.ВалютаДокумента,
				|	Т.Проведен,
				|	Т.Дата,
				|	Т.Номер,
				|	ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """"),
				|	ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """"),
				|	ЕСТЬNULL(ОтборКонтрагенты.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД),
				|	ВЫБОР
				|		КОГДА ЕСТЬNULL(ОтборКонтрагенты.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД) В (&СЧФДОП, &ДОП, &СЧФ_ДОП)
				|			ТОГДА &ДОП
				|		КОГДА ЕСТЬNULL(ОтборКонтрагенты.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД) В (&ТОРГ12АКТ, &СФТОРГ12АКТ)
				|			ТОГДА &ТОРГ12АКТ
				|		ИНАЧЕ """"
				|	КОНЕЦ,
				|	ОтборКонтрагенты.CounteragentID,
				|	ОтборОрганизации.ОтпрНеПроведенные
				|ИЗ
				|	ОтборОрганизации КАК ОтборОрганизации
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВозвратТоваровПоставщику КАК Т
				|		ПО (Т.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания)
				|			И (Т.Организация = ОтборОрганизации.Организация)
				|			И (НЕ Т.ПометкаУдаления)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборКонтрагенты КАК ОтборКонтрагенты
				|		ПО Т.Контрагент = ОтборКонтрагенты.Контрагент
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ИдентификаторДокументаВДиадок
				|		ПО (Т.Ссылка = ИдентификаторДокументаВДиадок.Объект)
				|			И (ИдентификаторДокументаВДиадок.Свойство = &ИдентификаторДокументаВДиадок)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК СтатусОтправляемыхВПФ
				|		ПО (Т.Ссылка = СтатусОтправляемыхВПФ.Объект)
				|			И (СтатусОтправляемыхВПФ.Свойство = &СвойствоДиадокСтатусОтправляемыхВПФ)
				|		ЛЕВОЕ СОЕДИНЕНИЕ УПД_СЧФДОП_ДокументыОснования КАК УПД_СЧФДОП_ДокументыОснования
				|		ПО (Т.Ссылка = УПД_СЧФДОП_ДокументыОснования.ДокументОснование)
				|ГДЕ
				|	ОтборОрганизации.ОтпрНеПроведенные
				|	И УПД_СЧФДОП_ДокументыОснования.ДокументОснование ЕСТЬ NULL 
				|	И (ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") = """"
				|			ИЛИ ИдентификаторДокументаВДиадок.Значение ПОДОБНО ""усл:%""
				|			ИЛИ ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """") ПОДОБНО ""%[НУ]%"")
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	ВТ_Основная_Шаг1.Документ
				|ПОМЕСТИТЬ ВТ_ЕстьСЧФ
				|ИЗ
				|	ВТ_Основная_Шаг1 КАК ВТ_Основная_Шаг1
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный.ДокументыОснования КАК СЧФ_ДокументыОснования
				|		ПО ВТ_Основная_Шаг1.Документ = СЧФ_ДокументыОснования.ДокументОснование
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный КАК СЧФ
				|		ПО (СЧФ_ДокументыОснования.Ссылка = СЧФ.Ссылка)
				|			И (СЧФ.Проведен)
				|ГДЕ
				|	НЕ ВТ_Основная_Шаг1.ОтпрНеПроведенные
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	ВТ_Основная_Шаг1.Документ
				|ИЗ
				|	ВТ_Основная_Шаг1 КАК ВТ_Основная_Шаг1
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный.ДокументыОснования КАК СЧФ_ДокументыОснования
				|		ПО ВТ_Основная_Шаг1.Документ = СЧФ_ДокументыОснования.ДокументОснование
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный КАК СЧФ
				|		ПО (СЧФ_ДокументыОснования.Ссылка = СЧФ.Ссылка)
				|			И (НЕ СЧФ.ПометкаУдаления)
				|ГДЕ
				|	ВТ_Основная_Шаг1.ОтпрНеПроведенные
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ВТ_Основная_Шаг1.Документ,
				|	ВТ_Основная_Шаг1.Продавец,
				|	ВТ_Основная_Шаг1.Покупатель,
				|	ВТ_Основная_Шаг1.СуммаДокументаЗначение,
				|	ВТ_Основная_Шаг1.Валюта,
				|	ВТ_Основная_Шаг1.Проведен,
				|	ВТ_Основная_Шаг1.Дата,
				|	ВТ_Основная_Шаг1.Номер,
				|	ВТ_Основная_Шаг1.ID,
				|	ВТ_Основная_Шаг1.СостояниеОтправкиДополнительныхВПФ,
				|	ВТ_Основная_Шаг1.ФункцияУПД,
				|	ВТ_Основная_Шаг1.CounteragentID
				|ПОМЕСТИТЬ ВТ_Основная
				|ИЗ
				|	ВТ_Основная_Шаг1 КАК ВТ_Основная_Шаг1
				|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ЕстьСЧФ КАК ВТ_ЕстьСЧФ
				|		ПО ВТ_Основная_Шаг1.Документ = ВТ_ЕстьСЧФ.Документ
				|ГДЕ
				|	ВТ_ЕстьСЧФ.Документ ЕСТЬ НЕ NULL 
				|			ИЛИ ВТ_Основная_Шаг1.ФормироватьУПД <> &СЧФДОП
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ ВТ_Основная_Шаг1
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ ВТ_ЕстьСЧФ
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ РАЗРЕШЕННЫЕ
				|	ВТ_Основная.Документ,
				|	СУММА(Товары.СуммаНДС) КАК СуммаНДС
				|ПОМЕСТИТЬ ВТ_СуммаНДСЗначение
				|ИЗ
				|	ВТ_Основная КАК ВТ_Основная
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВозвратТоваровПоставщику.Товары КАК Товары
				|		ПО ВТ_Основная.Документ = Товары.Ссылка
				|
				|СГРУППИРОВАТЬ ПО
				|	ВТ_Основная.Документ
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ВТ_Основная.Документ,
				|	ВТ_Основная.Продавец,
				|	ВТ_Основная.Покупатель,
				|	ВТ_Основная.СуммаДокументаЗначение,
				|	ЕСТЬNULL(ВТ_СуммаНДСЗначение.СуммаНДС, 0) КАК СуммаНДСЗначение,
				|	ВТ_Основная.Валюта,
				|	ВТ_Основная.Проведен,
				|	ВТ_Основная.Дата,
				|	ВТ_Основная.Номер,
				|	ВТ_Основная.ID,
				|	ВТ_Основная.СостояниеОтправкиДополнительныхВПФ,
				|	ВТ_Основная.ФункцияУПД,
				|	ВТ_Основная.CounteragentID,
				|	НЕОПРЕДЕЛЕНО КАК Грузополучатель,
				|	ЛОЖЬ КАК ЭтоСчет
				|ПОМЕСТИТЬ Накладные_ВозвратТоваровПоставщику
				|ИЗ
				|	ВТ_Основная КАК ВТ_Основная
				|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СуммаНДСЗначение КАК ВТ_СуммаНДСЗначение
				|		ПО ВТ_Основная.Документ = ВТ_СуммаНДСЗначение.Документ
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ ВТ_Основная
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ ВТ_СуммаНДСЗначение";
				
				Запрос.Выполнить();
				
				МассивВременныхТаблиц.Добавить("Накладные_ВозвратТоваровПоставщику");
				
			КонецПроцедуры
			
			Процедура ПодготовитьВТ_Накладные_РеализацияОтгруженныхТоваров(Запрос, МассивВременныхТаблиц) Экспорт
				
				Запрос.Текст=
				"ВЫБРАТЬ РАЗРЕШЕННЫЕ
				|	Т.Ссылка КАК Документ,
				|	Т.Организация КАК Продавец,
				|	Т.Контрагент КАК Покупатель,
				|	НЕОПРЕДЕЛЕНО КАК Грузополучатель,
				|	Т.СуммаДокумента КАК СуммаДокументаЗначение,
				|	Т.ВалютаДокумента КАК Валюта,
				|	Т.Проведен,
				|	Т.Дата,
				|	Т.Номер,
				|	ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") КАК ID,
				|	ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """") КАК СостояниеОтправкиДополнительныхВПФ,
				|	ОтборКонтрагенты.CounteragentID,
				|	Т.ДокументОтгрузки
				|ПОМЕСТИТЬ ВТ_Основная
				|ИЗ
				|	ОтборОрганизации КАК ОтборОрганизации
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияОтгруженныхТоваров КАК Т
				|		ПО (Т.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания)
				|			И (Т.Организация = ОтборОрганизации.Организация)
				|			И (Т.Проведен)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборКонтрагенты КАК ОтборКонтрагенты
				|		ПО (Т.Контрагент = ОтборКонтрагенты.Контрагент)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК ДанныеДокументаОтгрузки
				|		ПО (Т.ДокументОтгрузки = ДанныеДокументаОтгрузки.Ссылка)
				|		ЛЕВОЕ СОЕДИНЕНИЕ ОтборГрузополучатели КАК ОтборГрузополучатели
				|		ПО (Т.Контрагент = ОтборГрузополучатели.Контрагент)
				|			И (ДанныеДокументаОтгрузки.Грузополучатель = ОтборГрузополучатели.Грузополучатель)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ИдентификаторДокументаВДиадок
				|		ПО (Т.Ссылка = ИдентификаторДокументаВДиадок.Объект)
				|			И (ИдентификаторДокументаВДиадок.Свойство = &ИдентификаторДокументаВДиадок)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК СтатусОтправляемыхВПФ
				|		ПО (Т.Ссылка = СтатусОтправляемыхВПФ.Объект)
				|			И (СтатусОтправляемыхВПФ.Свойство = &СвойствоДиадокСтатусОтправляемыхВПФ)
				|ГДЕ
				|	НЕ ОтборОрганизации.ОтпрНеПроведенные
				|	И ОтборГрузополучатели.Контрагент ЕСТЬ NULL 
				|	И (ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") = """"
				|			ИЛИ ИдентификаторДокументаВДиадок.Значение ПОДОБНО ""усл:%""
				|			ИЛИ ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """") ПОДОБНО ""%[НУ]%"")
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	Т.Ссылка,
				|	Т.Организация,
				|	Т.Контрагент,
				|	НЕОПРЕДЕЛЕНО,
				|	Т.СуммаДокумента,
				|	Т.ВалютаДокумента,
				|	Т.Проведен,
				|	Т.Дата,
				|	Т.Номер,
				|	ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """"),
				|	ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """"),
				|	ОтборКонтрагенты.CounteragentID,
				|	Т.ДокументОтгрузки
				|ИЗ
				|	ОтборОрганизации КАК ОтборОрганизации
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияОтгруженныхТоваров КАК Т
				|		ПО (Т.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания)
				|			И (Т.Организация = ОтборОрганизации.Организация)
				|			И (НЕ Т.ПометкаУдаления)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборКонтрагенты КАК ОтборКонтрагенты
				|		ПО (Т.Контрагент = ОтборКонтрагенты.Контрагент)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК ДанныеДокументаОтгрузки
				|		ПО (Т.ДокументОтгрузки = ДанныеДокументаОтгрузки.Ссылка)
				|		ЛЕВОЕ СОЕДИНЕНИЕ ОтборГрузополучатели КАК ОтборГрузополучатели
				|		ПО (Т.Контрагент = ОтборГрузополучатели.Контрагент)
				|			И (ДанныеДокументаОтгрузки.Грузополучатель = ОтборГрузополучатели.Грузополучатель)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ИдентификаторДокументаВДиадок
				|		ПО (Т.Ссылка = ИдентификаторДокументаВДиадок.Объект)
				|			И (ИдентификаторДокументаВДиадок.Свойство = &ИдентификаторДокументаВДиадок)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК СтатусОтправляемыхВПФ
				|		ПО (Т.Ссылка = СтатусОтправляемыхВПФ.Объект)
				|			И (СтатусОтправляемыхВПФ.Свойство = &СвойствоДиадокСтатусОтправляемыхВПФ)
				|ГДЕ
				|	ОтборОрганизации.ОтпрНеПроведенные
				|	И ОтборГрузополучатели.Контрагент ЕСТЬ NULL 
				|	И (ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") = """"
				|			ИЛИ ИдентификаторДокументаВДиадок.Значение ПОДОБНО ""усл:%""
				|			ИЛИ ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """") ПОДОБНО ""%[НУ]%"")
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	Т.Ссылка,
				|	Т.Организация,
				|	Т.Контрагент,
				|	ДанныеДокументаОтгрузки.Грузополучатель,
				|	Т.СуммаДокумента,
				|	Т.ВалютаДокумента,
				|	Т.Проведен,
				|	Т.Дата,
				|	Т.Номер,
				|	ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """"),
				|	ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """"),
				|	ОтборГрузополучатели.CounteragentID,
				|	Т.ДокументОтгрузки
				|ИЗ
				|	ОтборОрганизации КАК ОтборОрганизации
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияОтгруженныхТоваров КАК Т
				|		ПО (Т.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания)
				|			И (Т.Организация = ОтборОрганизации.Организация)
				|			И (Т.Проведен)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК ДанныеДокументаОтгрузки
				|		ПО (Т.ДокументОтгрузки = ДанныеДокументаОтгрузки.Ссылка)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборГрузополучатели КАК ОтборГрузополучатели
				|		ПО (Т.Контрагент = ОтборГрузополучатели.Контрагент)
				|			И (ДанныеДокументаОтгрузки.Грузополучатель = ОтборГрузополучатели.Грузополучатель)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ИдентификаторДокументаВДиадок
				|		ПО (Т.Ссылка = ИдентификаторДокументаВДиадок.Объект)
				|			И (ИдентификаторДокументаВДиадок.Свойство = &ИдентификаторДокументаВДиадок)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК СтатусОтправляемыхВПФ
				|		ПО (Т.Ссылка = СтатусОтправляемыхВПФ.Объект)
				|			И (СтатусОтправляемыхВПФ.Свойство = &СвойствоДиадокСтатусОтправляемыхВПФ)
				|ГДЕ
				|	НЕ ОтборОрганизации.ОтпрНеПроведенные
				|	И (ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") = """"
				|			ИЛИ ИдентификаторДокументаВДиадок.Значение ПОДОБНО ""усл:%""
				|			ИЛИ ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """") ПОДОБНО ""%[НУ]%"")
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	Т.Ссылка,
				|	Т.Организация,
				|	Т.Контрагент,
				|	ДанныеДокументаОтгрузки.Грузополучатель,
				|	Т.СуммаДокумента,
				|	Т.ВалютаДокумента,
				|	Т.Проведен,
				|	Т.Дата,
				|	Т.Номер,
				|	ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """"),
				|	ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """"),
				|	ОтборГрузополучатели.CounteragentID,
				|	Т.ДокументОтгрузки
				|ИЗ
				|	ОтборОрганизации КАК ОтборОрганизации
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияОтгруженныхТоваров КАК Т
				|		ПО (Т.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания)
				|			И (Т.Организация = ОтборОрганизации.Организация)
				|			И (НЕ Т.ПометкаУдаления)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК ДанныеДокументаОтгрузки
				|		ПО (Т.ДокументОтгрузки = ДанныеДокументаОтгрузки.Ссылка)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборГрузополучатели КАК ОтборГрузополучатели
				|		ПО (Т.Контрагент = ОтборГрузополучатели.Контрагент)
				|			И (ДанныеДокументаОтгрузки.Грузополучатель = ОтборГрузополучатели.Грузополучатель)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ИдентификаторДокументаВДиадок
				|		ПО (Т.Ссылка = ИдентификаторДокументаВДиадок.Объект)
				|			И (ИдентификаторДокументаВДиадок.Свойство = &ИдентификаторДокументаВДиадок)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК СтатусОтправляемыхВПФ
				|		ПО (Т.Ссылка = СтатусОтправляемыхВПФ.Объект)
				|			И (СтатусОтправляемыхВПФ.Свойство = &СвойствоДиадокСтатусОтправляемыхВПФ)
				|ГДЕ
				|	ОтборОрганизации.ОтпрНеПроведенные
				|	И (ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") = """"
				|			ИЛИ ИдентификаторДокументаВДиадок.Значение ПОДОБНО ""усл:%""
				|			ИЛИ ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """") ПОДОБНО ""%[НУ]%"")
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ РАЗРЕШЕННЫЕ
				|	ВложенныйЗапрос.Документ,
				|	СУММА(ВложенныйЗапрос.СуммаНДС) КАК СуммаНДС
				|ПОМЕСТИТЬ ВТ_СуммаНДСЗначение
				|ИЗ
				|	(ВЫБРАТЬ
				|		ВТ_Основная.Документ КАК Документ,
				|		Товары.СуммаНДС КАК СуммаНДС
				|	ИЗ
				|		ВТ_Основная КАК ВТ_Основная
				|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Товары КАК Товары
				|			ПО ВТ_Основная.ДокументОтгрузки = Товары.Ссылка
				|	
				|	ОБЪЕДИНИТЬ ВСЕ
				|	
				|	ВЫБРАТЬ
				|		ВТ_Основная.Документ,
				|		Услуги.СуммаНДС
				|	ИЗ
				|		ВТ_Основная КАК ВТ_Основная
				|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Услуги КАК Услуги
				|			ПО ВТ_Основная.ДокументОтгрузки = Услуги.Ссылка) КАК ВложенныйЗапрос
				|
				|СГРУППИРОВАТЬ ПО
				|	ВложенныйЗапрос.Документ
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ВТ_Основная.Документ,
				|	ВТ_Основная.Продавец,
				|	ВТ_Основная.Покупатель,
				|	ВТ_Основная.Грузополучатель,
				|	ВТ_Основная.СуммаДокументаЗначение,
				|	ЕСТЬNULL(ВТ_СуммаНДСЗначение.СуммаНДС, 0) КАК СуммаНДСЗначение,
				|	ВТ_Основная.Валюта,
				|	ВТ_Основная.Проведен,
				|	ВТ_Основная.Дата,
				|	ВТ_Основная.Номер,
				|	ВТ_Основная.ID,
				|	ВТ_Основная.СостояниеОтправкиДополнительныхВПФ,
				|	ВТ_Основная.CounteragentID,
				|	"""" КАК ФункцияУПД,
				|	ЛОЖЬ КАК ЭтоСчет
				|ПОМЕСТИТЬ Накладные_РеализацияОтгруженныхТоваров
				|ИЗ
				|	ВТ_Основная КАК ВТ_Основная
				|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СуммаНДСЗначение КАК ВТ_СуммаНДСЗначение
				|		ПО ВТ_Основная.Документ = ВТ_СуммаНДСЗначение.Документ
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ ВТ_Основная
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ ВТ_СуммаНДСЗначение";
				
				Запрос.Выполнить();
				
				МассивВременныхТаблиц.Добавить("Накладные_РеализацияОтгруженныхТоваров");
				
			КонецПроцедуры
			
			Процедура ПодготовитьВТ_Накладные_АктОбОказанииПроизводственныхУслуг(Запрос, МассивВременныхТаблиц) Экспорт
				
				Запрос.Текст=
				"ВЫБРАТЬ РАЗРЕШЕННЫЕ
				|	Т.Ссылка КАК Документ,
				|	Т.Организация КАК Продавец,
				|	Т.Контрагент КАК Покупатель,
				|	Т.СуммаДокумента КАК СуммаДокументаЗначение,
				|	Т.ВалютаДокумента КАК Валюта,
				|	Т.Проведен,
				|	Т.Дата,
				|	Т.Номер,
				|	ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") КАК ID,
				|	ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """") КАК СостояниеОтправкиДополнительныхВПФ,
				|	ОтборКонтрагенты.CounteragentID,
				|	ЕСТЬNULL(ОтборКонтрагенты.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД) КАК ФормироватьУПД,
				|	ВЫБОР
				|		КОГДА ЕСТЬNULL(ОтборКонтрагенты.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД) В (&СЧФДОП, &ДОП, &СЧФ_ДОП)
				|			ТОГДА &ДОП
				|		КОГДА ЕСТЬNULL(ОтборКонтрагенты.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД) В (&ТОРГ12АКТ, &СФТОРГ12АКТ)
				|			ТОГДА &ТОРГ12АКТ
				|		ИНАЧЕ """"
				|	КОНЕЦ КАК ФункцияУПД,
				|	ОтборОрганизации.ОтпрНеПроведенные
				|ПОМЕСТИТЬ ВТ_Основная
				|ИЗ
				|	ОтборОрганизации КАК ОтборОрганизации
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.АктОбОказанииПроизводственныхУслуг КАК Т
				|		ПО (Т.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания)
				|			И (Т.Организация = ОтборОрганизации.Организация)
				|			И (Т.Проведен)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборКонтрагенты КАК ОтборКонтрагенты
				|		ПО (Т.Контрагент = ОтборКонтрагенты.Контрагент)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ИдентификаторДокументаВДиадок
				|		ПО (Т.Ссылка = ИдентификаторДокументаВДиадок.Объект)
				|			И (ИдентификаторДокументаВДиадок.Свойство = &ИдентификаторДокументаВДиадок)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК СтатусОтправляемыхВПФ
				|		ПО (Т.Ссылка = СтатусОтправляемыхВПФ.Объект)
				|			И (СтатусОтправляемыхВПФ.Свойство = &СвойствоДиадокСтатусОтправляемыхВПФ)
				|		ЛЕВОЕ СОЕДИНЕНИЕ УПД_СЧФДОП_ДокументыОснования КАК УПД_СЧФДОП_ДокументыОснования
				|		ПО (Т.Ссылка = УПД_СЧФДОП_ДокументыОснования.ДокументОснование)
				|ГДЕ
				|	НЕ ОтборОрганизации.ОтпрНеПроведенные
				|	И УПД_СЧФДОП_ДокументыОснования.ДокументОснование ЕСТЬ NULL 
				|	И (ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") = """"
				|			ИЛИ ИдентификаторДокументаВДиадок.Значение ПОДОБНО ""усл:%""
				|			ИЛИ ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """") ПОДОБНО ""%[НУ]%"")
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	Т.Ссылка,
				|	Т.Организация,
				|	Т.Контрагент,
				|	Т.СуммаДокумента,
				|	Т.ВалютаДокумента,
				|	Т.Проведен,
				|	Т.Дата,
				|	Т.Номер,
				|	ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """"),
				|	ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """"),
				|	ОтборКонтрагенты.CounteragentID,
				|	ЕСТЬNULL(ОтборКонтрагенты.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД),
				|	ВЫБОР
				|		КОГДА ЕСТЬNULL(ОтборКонтрагенты.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД) В (&СЧФДОП, &ДОП, &СЧФ_ДОП)
				|			ТОГДА &ДОП
				|		КОГДА ЕСТЬNULL(ОтборКонтрагенты.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД) В (&ТОРГ12АКТ, &СФТОРГ12АКТ)
				|			ТОГДА &ТОРГ12АКТ
				|		ИНАЧЕ """"
				|	КОНЕЦ,
				|	ОтборОрганизации.ОтпрНеПроведенные
				|ИЗ
				|	ОтборОрганизации КАК ОтборОрганизации
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.АктОбОказанииПроизводственныхУслуг КАК Т
				|		ПО (Т.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания)
				|			И (Т.Организация = ОтборОрганизации.Организация)
				|			И (НЕ Т.ПометкаУдаления)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборКонтрагенты КАК ОтборКонтрагенты
				|		ПО (Т.Контрагент = ОтборКонтрагенты.Контрагент)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ИдентификаторДокументаВДиадок
				|		ПО (Т.Ссылка = ИдентификаторДокументаВДиадок.Объект)
				|			И (ИдентификаторДокументаВДиадок.Свойство = &ИдентификаторДокументаВДиадок)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК СтатусОтправляемыхВПФ
				|		ПО (Т.Ссылка = СтатусОтправляемыхВПФ.Объект)
				|			И (СтатусОтправляемыхВПФ.Свойство = &СвойствоДиадокСтатусОтправляемыхВПФ)
				|		ЛЕВОЕ СОЕДИНЕНИЕ УПД_СЧФДОП_ДокументыОснования КАК УПД_СЧФДОП_ДокументыОснования
				|		ПО (Т.Ссылка = УПД_СЧФДОП_ДокументыОснования.ДокументОснование)
				|ГДЕ
				|	ОтборОрганизации.ОтпрНеПроведенные
				|	И УПД_СЧФДОП_ДокументыОснования.ДокументОснование ЕСТЬ NULL 
				|	И (ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") = """"
				|			ИЛИ ИдентификаторДокументаВДиадок.Значение ПОДОБНО ""усл:%""
				|			ИЛИ ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """") ПОДОБНО ""%[НУ]%"")
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ РАЗРЕШЕННЫЕ
				|	ВТ_Основная.Документ,
				|	СУММА(Услуги.СуммаНДС) КАК СуммаНДС
				|ПОМЕСТИТЬ ВТ_СуммаНДСЗначение
				|ИЗ
				|	ВТ_Основная КАК ВТ_Основная
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.АктОбОказанииПроизводственныхУслуг.Услуги КАК Услуги
				|		ПО ВТ_Основная.Документ = Услуги.Ссылка
				|
				|СГРУППИРОВАТЬ ПО
				|	ВТ_Основная.Документ
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	ВТ_Основная.Документ
				|ПОМЕСТИТЬ ВТ_ЕстьСЧФ
				|ИЗ
				|	ВТ_Основная КАК ВТ_Основная
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный.ДокументыОснования КАК СЧФ_ДокументыОснования
				|		ПО ВТ_Основная.Документ = СЧФ_ДокументыОснования.ДокументОснование
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный КАК СЧФ
				|		ПО (СЧФ_ДокументыОснования.Ссылка = СЧФ.Ссылка)
				|			И (СЧФ.Проведен)
				|ГДЕ
				|	НЕ ВТ_Основная.ОтпрНеПроведенные
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	ВТ_Основная.Документ
				|ИЗ
				|	ВТ_Основная КАК ВТ_Основная
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный.ДокументыОснования КАК СЧФ_ДокументыОснования
				|		ПО ВТ_Основная.Документ = СЧФ_ДокументыОснования.ДокументОснование
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный КАК СЧФ
				|		ПО (СЧФ_ДокументыОснования.Ссылка = СЧФ.Ссылка)
				|			И (НЕ СЧФ.ПометкаУдаления)
				|ГДЕ
				|	ВТ_Основная.ОтпрНеПроведенные
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ВТ_Основная.Документ,
				|	ВТ_Основная.Продавец,
				|	ВТ_Основная.Покупатель,
				|	ВТ_Основная.СуммаДокументаЗначение,
				|	ЕСТЬNULL(ВТ_СуммаНДСЗначение.СуммаНДС, 0) КАК СуммаНДСЗначение,
				|	ВТ_Основная.Валюта,
				|	ВТ_Основная.Проведен,
				|	ВТ_Основная.Дата,
				|	ВТ_Основная.Номер,
				|	ВТ_Основная.ID,
				|	ВТ_Основная.СостояниеОтправкиДополнительныхВПФ,
				|	ВТ_Основная.ФункцияУПД,
				|	ВТ_Основная.CounteragentID,
				|	НЕОПРЕДЕЛЕНО КАК Грузополучатель,
				|	ЛОЖЬ КАК ЭтоСчет
				|ПОМЕСТИТЬ Накладные_АктОбОказанииПроизводственныхУслуг
				|ИЗ
				|	ВТ_Основная КАК ВТ_Основная
				|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ЕстьСЧФ КАК ВТ_ЕстьСЧФ
				|		ПО ВТ_Основная.Документ = ВТ_ЕстьСЧФ.Документ
				|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СуммаНДСЗначение КАК ВТ_СуммаНДСЗначение
				|		ПО ВТ_Основная.Документ = ВТ_СуммаНДСЗначение.Документ
				|ГДЕ
				|	(ВТ_ЕстьСЧФ.Документ ЕСТЬ НЕ NULL 
				|			ИЛИ ВТ_Основная.ФормироватьУПД <> &СЧФДОП)
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ ВТ_Основная
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ ВТ_ЕстьСЧФ
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ ВТ_СуммаНДСЗначение";
				
				Запрос.Выполнить();
				
				МассивВременныхТаблиц.Добавить("Накладные_АктОбОказанииПроизводственныхУслуг");
				
			КонецПроцедуры
			
			Процедура ПодготовитьВТ_Накладные_РеализацияУслугПоПереработке(Запрос, МассивВременныхТаблиц) Экспорт
				
				Запрос.Текст=
				"ВЫБРАТЬ РАЗРЕШЕННЫЕ
				|	Т.Ссылка КАК Документ,
				|	Т.Организация КАК Продавец,
				|	Т.Контрагент КАК Покупатель,
				|	Т.СуммаДокумента КАК СуммаДокументаЗначение,
				|	Т.ВалютаДокумента КАК Валюта,
				|	Т.Проведен,
				|	Т.Дата,
				|	Т.Номер,
				|	ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") КАК ID,
				|	ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """") КАК СостояниеОтправкиДополнительныхВПФ,
				|	ОтборКонтрагенты.CounteragentID,
				|	ЕСТЬNULL(ОтборКонтрагенты.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД) КАК ФормироватьУПД,
				|	ВЫБОР
				|		КОГДА ЕСТЬNULL(ОтборКонтрагенты.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД) В (&СЧФДОП, &ДОП, &СЧФ_ДОП)
				|			ТОГДА &ДОП
				|		КОГДА ЕСТЬNULL(ОтборКонтрагенты.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД) В (&ТОРГ12АКТ, &СФТОРГ12АКТ)
				|			ТОГДА &ТОРГ12АКТ
				|		ИНАЧЕ """"
				|	КОНЕЦ КАК ФункцияУПД,
				|	ОтборОрганизации.ОтпрНеПроведенные
				|ПОМЕСТИТЬ ВТ_Основная
				|ИЗ
				|	ОтборОрганизации КАК ОтборОрганизации
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияУслугПоПереработке КАК Т
				|		ПО (Т.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания)
				|			И (Т.Организация = ОтборОрганизации.Организация)
				|			И (Т.Проведен)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборКонтрагенты КАК ОтборКонтрагенты
				|		ПО (Т.Контрагент = ОтборКонтрагенты.Контрагент)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ИдентификаторДокументаВДиадок
				|		ПО (Т.Ссылка = ИдентификаторДокументаВДиадок.Объект)
				|			И (ИдентификаторДокументаВДиадок.Свойство = &ИдентификаторДокументаВДиадок)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК СтатусОтправляемыхВПФ
				|		ПО (Т.Ссылка = СтатусОтправляемыхВПФ.Объект)
				|			И (СтатусОтправляемыхВПФ.Свойство = &СвойствоДиадокСтатусОтправляемыхВПФ)
				|		ЛЕВОЕ СОЕДИНЕНИЕ УПД_СЧФДОП_ДокументыОснования КАК УПД_СЧФДОП_ДокументыОснования
				|		ПО (Т.Ссылка = УПД_СЧФДОП_ДокументыОснования.ДокументОснование)
				|ГДЕ
				|	НЕ ОтборОрганизации.ОтпрНеПроведенные
				|	И УПД_СЧФДОП_ДокументыОснования.ДокументОснование ЕСТЬ NULL 
				|	И (ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") = """"
				|			ИЛИ ИдентификаторДокументаВДиадок.Значение ПОДОБНО ""усл:%""
				|			ИЛИ ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """") ПОДОБНО ""%[НУ]%"")
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	Т.Ссылка,
				|	Т.Организация,
				|	Т.Контрагент,
				|	Т.СуммаДокумента,
				|	Т.ВалютаДокумента,
				|	Т.Проведен,
				|	Т.Дата,
				|	Т.Номер,
				|	ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """"),
				|	ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """"),
				|	ОтборКонтрагенты.CounteragentID,
				|	ЕСТЬNULL(ОтборКонтрагенты.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД),
				|	ВЫБОР
				|		КОГДА ЕСТЬNULL(ОтборКонтрагенты.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД) В (&СЧФДОП, &ДОП, &СЧФ_ДОП)
				|			ТОГДА &ДОП
				|		КОГДА ЕСТЬNULL(ОтборКонтрагенты.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД) В (&ТОРГ12АКТ, &СФТОРГ12АКТ)
				|			ТОГДА &ТОРГ12АКТ
				|		ИНАЧЕ """"
				|	КОНЕЦ,
				|	ОтборОрганизации.ОтпрНеПроведенные
				|ИЗ
				|	ОтборОрганизации КАК ОтборОрганизации
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияУслугПоПереработке КАК Т
				|		ПО (Т.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания)
				|			И (Т.Организация = ОтборОрганизации.Организация)
				|			И (НЕ Т.ПометкаУдаления)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборКонтрагенты КАК ОтборКонтрагенты
				|		ПО (Т.Контрагент = ОтборКонтрагенты.Контрагент)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ИдентификаторДокументаВДиадок
				|		ПО (Т.Ссылка = ИдентификаторДокументаВДиадок.Объект)
				|			И (ИдентификаторДокументаВДиадок.Свойство = &ИдентификаторДокументаВДиадок)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК СтатусОтправляемыхВПФ
				|		ПО (Т.Ссылка = СтатусОтправляемыхВПФ.Объект)
				|			И (СтатусОтправляемыхВПФ.Свойство = &СвойствоДиадокСтатусОтправляемыхВПФ)
				|		ЛЕВОЕ СОЕДИНЕНИЕ УПД_СЧФДОП_ДокументыОснования КАК УПД_СЧФДОП_ДокументыОснования
				|		ПО (Т.Ссылка = УПД_СЧФДОП_ДокументыОснования.ДокументОснование)
				|ГДЕ
				|	ОтборОрганизации.ОтпрНеПроведенные
				|	И УПД_СЧФДОП_ДокументыОснования.ДокументОснование ЕСТЬ NULL 
				|	И (ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") = """"
				|			ИЛИ ИдентификаторДокументаВДиадок.Значение ПОДОБНО ""усл:%""
				|			ИЛИ ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """") ПОДОБНО ""%[НУ]%"")
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ РАЗРЕШЕННЫЕ
				|	ВТ_Основная.Документ,
				|	СУММА(Услуги.СуммаНДС) КАК СуммаНДС
				|ПОМЕСТИТЬ ВТ_СуммаНДСЗначение
				|ИЗ
				|	ВТ_Основная КАК ВТ_Основная
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияУслугПоПереработке.Услуги КАК Услуги
				|		ПО ВТ_Основная.Документ = Услуги.Ссылка
				|
				|СГРУППИРОВАТЬ ПО
				|	ВТ_Основная.Документ
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	ВТ_Основная.Документ
				|ПОМЕСТИТЬ ВТ_ЕстьСЧФ
				|ИЗ
				|	ВТ_Основная КАК ВТ_Основная
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный.ДокументыОснования КАК СЧФ_ДокументыОснования
				|		ПО ВТ_Основная.Документ = СЧФ_ДокументыОснования.ДокументОснование
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный КАК СЧФ
				|		ПО (СЧФ_ДокументыОснования.Ссылка = СЧФ.Ссылка)
				|			И (СЧФ.Проведен)
				|ГДЕ
				|	НЕ ВТ_Основная.ОтпрНеПроведенные
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	ВТ_Основная.Документ
				|ИЗ
				|	ВТ_Основная КАК ВТ_Основная
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный.ДокументыОснования КАК СЧФ_ДокументыОснования
				|		ПО ВТ_Основная.Документ = СЧФ_ДокументыОснования.ДокументОснование
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный КАК СЧФ
				|		ПО (СЧФ_ДокументыОснования.Ссылка = СЧФ.Ссылка)
				|			И (НЕ СЧФ.ПометкаУдаления)
				|ГДЕ
				|	ВТ_Основная.ОтпрНеПроведенные
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ВТ_Основная.Документ,
				|	ВТ_Основная.Продавец,
				|	ВТ_Основная.Покупатель,
				|	ВТ_Основная.СуммаДокументаЗначение,
				|	ЕСТЬNULL(ВТ_СуммаНДСЗначение.СуммаНДС, 0) КАК СуммаНДСЗначение,
				|	ВТ_Основная.Валюта,
				|	ВТ_Основная.Проведен,
				|	ВТ_Основная.Дата,
				|	ВТ_Основная.Номер,
				|	ВТ_Основная.ID,
				|	ВТ_Основная.СостояниеОтправкиДополнительныхВПФ,
				|	ВТ_Основная.ФункцияУПД,
				|	ВТ_Основная.CounteragentID,
				|	НЕОПРЕДЕЛЕНО КАК Грузополучатель,
				|	ЛОЖЬ КАК ЭтоСчет
				|ПОМЕСТИТЬ Накладные_РеализацияУслугПоПереработке
				|ИЗ
				|	ВТ_Основная КАК ВТ_Основная
				|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ЕстьСЧФ КАК ВТ_ЕстьСЧФ
				|		ПО ВТ_Основная.Документ = ВТ_ЕстьСЧФ.Документ
				|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СуммаНДСЗначение КАК ВТ_СуммаНДСЗначение
				|		ПО ВТ_Основная.Документ = ВТ_СуммаНДСЗначение.Документ
				|ГДЕ
				|	(ВТ_ЕстьСЧФ.Документ ЕСТЬ НЕ NULL 
				|			ИЛИ ВТ_Основная.ФормироватьУПД <> &СЧФДОП)
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ ВТ_Основная
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ ВТ_ЕстьСЧФ
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ ВТ_СуммаНДСЗначение";
				
				Запрос.Выполнить();
				
				МассивВременныхТаблиц.Добавить("Накладные_РеализацияУслугПоПереработке");
				
			КонецПроцедуры
			
			Процедура ПодготовитьВТ_Накладные_ОтчетКомитентуОПродажах(Запрос, МассивВременныхТаблиц) Экспорт
				
				Запрос.Текст=
				"ВЫБРАТЬ РАЗРЕШЕННЫЕ
				|	Т.Ссылка КАК Документ,
				|	Т.Организация КАК Продавец,
				|	Т.Контрагент КАК Покупатель,
				|	Т.СуммаВознаграждения КАК СуммаДокументаЗначение,
				|	Т.ВалютаДокумента КАК Валюта,
				|	Т.Проведен,
				|	Т.Дата,
				|	Т.Номер,
				|	ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") КАК ID,
				|	ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """") КАК СостояниеОтправкиДополнительныхВПФ,
				|	ОтборКонтрагенты.CounteragentID,
				|	ЕСТЬNULL(ОтборКонтрагенты.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД) КАК ФормироватьУПД,
				|	ВЫБОР
				|		КОГДА ЕСТЬNULL(ОтборКонтрагенты.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД) В (&СЧФДОП, &ДОП, &СЧФ_ДОП)
				|			ТОГДА &ДОП
				|		КОГДА ЕСТЬNULL(ОтборКонтрагенты.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД) В (&ТОРГ12АКТ, &СФТОРГ12АКТ)
				|			ТОГДА &ТОРГ12АКТ
				|		ИНАЧЕ """"
				|	КОНЕЦ КАК ФункцияУПД,
				|	ОтборОрганизации.ОтпрНеПроведенные
				|ПОМЕСТИТЬ ВТ_Основная
				|ИЗ
				|	ОтборОрганизации КАК ОтборОрганизации
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ОтчетКомитентуОПродажах КАК Т
				|		ПО (Т.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания)
				|			И (Т.Организация = ОтборОрганизации.Организация)
				|			И (Т.Проведен)
				|			И (Т.СуммаВознаграждения <> 0)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборКонтрагенты КАК ОтборКонтрагенты
				|		ПО (Т.Контрагент = ОтборКонтрагенты.Контрагент)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ИдентификаторДокументаВДиадок
				|		ПО (Т.Ссылка = ИдентификаторДокументаВДиадок.Объект)
				|			И (ИдентификаторДокументаВДиадок.Свойство = &ИдентификаторДокументаВДиадок)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК СтатусОтправляемыхВПФ
				|		ПО (Т.Ссылка = СтатусОтправляемыхВПФ.Объект)
				|			И (СтатусОтправляемыхВПФ.Свойство = &СвойствоДиадокСтатусОтправляемыхВПФ)
				|		ЛЕВОЕ СОЕДИНЕНИЕ УПД_СЧФДОП_ДокументыОснования КАК УПД_СЧФДОП_ДокументыОснования
				|		ПО (Т.Ссылка = УПД_СЧФДОП_ДокументыОснования.ДокументОснование)
				|ГДЕ
				|	НЕ ОтборОрганизации.ОтпрНеПроведенные
				|	И УПД_СЧФДОП_ДокументыОснования.ДокументОснование ЕСТЬ NULL 
				|	И (ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") = """"
				|			ИЛИ ИдентификаторДокументаВДиадок.Значение ПОДОБНО ""усл:%""
				|			ИЛИ ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """") ПОДОБНО ""%[НУ]%"")
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	Т.Ссылка,
				|	Т.Организация,
				|	Т.Контрагент,
				|	Т.СуммаВознаграждения,
				|	Т.ВалютаДокумента,
				|	Т.Проведен,
				|	Т.Дата,
				|	Т.Номер,
				|	ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """"),
				|	ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """"),
				|	ОтборКонтрагенты.CounteragentID,
				|	ЕСТЬNULL(ОтборКонтрагенты.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД),
				|	ВЫБОР
				|		КОГДА ЕСТЬNULL(ОтборКонтрагенты.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД) В (&СЧФДОП, &ДОП, &СЧФ_ДОП)
				|			ТОГДА &ДОП
				|		КОГДА ЕСТЬNULL(ОтборКонтрагенты.ФормироватьУПД, ОтборОрганизации.ФормироватьУПД) В (&ТОРГ12АКТ, &СФТОРГ12АКТ)
				|			ТОГДА &ТОРГ12АКТ
				|		ИНАЧЕ """"
				|	КОНЕЦ,
				|	ОтборОрганизации.ОтпрНеПроведенные
				|ИЗ
				|	ОтборОрганизации КАК ОтборОрганизации
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ОтчетКомитентуОПродажах КАК Т
				|		ПО (Т.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания)
				|			И (Т.Организация = ОтборОрганизации.Организация)
				|			И (НЕ Т.ПометкаУдаления)
				|			И (Т.СуммаВознаграждения <> 0)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборКонтрагенты КАК ОтборКонтрагенты
				|		ПО (Т.Контрагент = ОтборКонтрагенты.Контрагент)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ИдентификаторДокументаВДиадок
				|		ПО (Т.Ссылка = ИдентификаторДокументаВДиадок.Объект)
				|			И (ИдентификаторДокументаВДиадок.Свойство = &ИдентификаторДокументаВДиадок)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК СтатусОтправляемыхВПФ
				|		ПО (Т.Ссылка = СтатусОтправляемыхВПФ.Объект)
				|			И (СтатусОтправляемыхВПФ.Свойство = &СвойствоДиадокСтатусОтправляемыхВПФ)
				|		ЛЕВОЕ СОЕДИНЕНИЕ УПД_СЧФДОП_ДокументыОснования КАК УПД_СЧФДОП_ДокументыОснования
				|		ПО (Т.Ссылка = УПД_СЧФДОП_ДокументыОснования.ДокументОснование)
				|ГДЕ
				|	ОтборОрганизации.ОтпрНеПроведенные
				|	И УПД_СЧФДОП_ДокументыОснования.ДокументОснование ЕСТЬ NULL 
				|	И (ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") = """"
				|			ИЛИ ИдентификаторДокументаВДиадок.Значение ПОДОБНО ""усл:%""
				|			ИЛИ ЕСТЬNULL(СтатусОтправляемыхВПФ.Значение, """") ПОДОБНО ""%[НУ]%"")
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ВТ_Основная.Документ,
				|	СУММА(Товары.СуммаНДСВознаграждения) КАК СуммаНДС
				|ПОМЕСТИТЬ ВТ_СуммаНДСЗначение
				|ИЗ
				|	ВТ_Основная КАК ВТ_Основная
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ОтчетКомитентуОПродажах.Товары КАК Товары
				|		ПО ВТ_Основная.Документ = Товары.Ссылка
				|
				|СГРУППИРОВАТЬ ПО
				|	ВТ_Основная.Документ
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	ВТ_Основная.Документ
				|ПОМЕСТИТЬ ВТ_ЕстьСЧФ
				|ИЗ
				|	ВТ_Основная КАК ВТ_Основная
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный.ДокументыОснования КАК СЧФ_ДокументыОснования
				|		ПО ВТ_Основная.Документ = СЧФ_ДокументыОснования.ДокументОснование
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный КАК СЧФ
				|		ПО (СЧФ_ДокументыОснования.Ссылка = СЧФ.Ссылка)
				|			И (СЧФ.Проведен)
				|ГДЕ
				|	НЕ ВТ_Основная.ОтпрНеПроведенные
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	ВТ_Основная.Документ
				|ИЗ
				|	ВТ_Основная КАК ВТ_Основная
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный.ДокументыОснования КАК СЧФ_ДокументыОснования
				|		ПО ВТ_Основная.Документ = СЧФ_ДокументыОснования.ДокументОснование
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный КАК СЧФ
				|		ПО (СЧФ_ДокументыОснования.Ссылка = СЧФ.Ссылка)
				|			И (НЕ СЧФ.ПометкаУдаления)
				|ГДЕ
				|	ВТ_Основная.ОтпрНеПроведенные
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ВТ_Основная.Документ,
				|	ВТ_Основная.Продавец,
				|	ВТ_Основная.Покупатель,
				|	ВТ_Основная.СуммаДокументаЗначение,
				|	ЕСТЬNULL(ВТ_СуммаНДСЗначение.СуммаНДС, 0) КАК СуммаНДСЗначение,
				|	ВТ_Основная.Валюта,
				|	ВТ_Основная.Проведен,
				|	ВТ_Основная.Дата,
				|	ВТ_Основная.Номер,
				|	ВТ_Основная.ID,
				|	ВТ_Основная.СостояниеОтправкиДополнительныхВПФ,
				|	ВТ_Основная.ФункцияУПД,
				|	ВТ_Основная.CounteragentID,
				|	НЕОПРЕДЕЛЕНО КАК Грузополучатель,
				|	ЛОЖЬ КАК ЭтоСчет
				|ПОМЕСТИТЬ Накладные_ОтчетКомитентуОПродажах
				|ИЗ
				|	ВТ_Основная КАК ВТ_Основная
				|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ЕстьСЧФ КАК ВТ_ЕстьСЧФ
				|		ПО ВТ_Основная.Документ = ВТ_ЕстьСЧФ.Документ
				|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СуммаНДСЗначение КАК ВТ_СуммаНДСЗначение
				|		ПО ВТ_Основная.Документ = ВТ_СуммаНДСЗначение.Документ
				|ГДЕ
				|	(ВТ_ЕстьСЧФ.Документ ЕСТЬ НЕ NULL 
				|			ИЛИ ВТ_Основная.ФормироватьУПД <> &СЧФДОП)
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ ВТ_Основная
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ ВТ_ЕстьСЧФ
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ ВТ_СуммаНДСЗначение";
				
				Запрос.Выполнить();
				
				МассивВременныхТаблиц.Добавить("Накладные_ОтчетКомитентуОПродажах");
				
			КонецПроцедуры
			
			
			Процедура ПодготовитьВТ_СчетаНаОплату_СчетНаОплатуПокупателю(Запрос, МассивВременныхТаблиц) Экспорт
				
				Запрос.Текст=
				"ВЫБРАТЬ РАЗРЕШЕННЫЕ
				|	Т.Ссылка КАК Документ,
				|	Т.Организация КАК Продавец,
				|	Т.Контрагент КАК Покупатель,
				|	Т.СуммаДокумента КАК СуммаДокументаЗначение,
				|	Т.ВалютаДокумента КАК Валюта,
				|	ИСТИНА КАК Проведен,
				|	Т.Дата,
				|	Т.Номер,
				|	ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") КАК ID,
				|	ОтборКонтрагенты.CounteragentID
				|ПОМЕСТИТЬ ВТ_Основная
				|ИЗ
				|	ОтборОрганизации КАК ОтборОрганизации
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетНаОплатуПокупателю КАК Т
				|		ПО (Т.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания)
				|			И (Т.Организация = ОтборОрганизации.Организация)
				|			И (НЕ Т.ПометкаУдаления)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборКонтрагенты КАК ОтборКонтрагенты
				|		ПО (Т.Контрагент = ОтборКонтрагенты.Контрагент)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ИдентификаторДокументаВДиадок
				|		ПО (Т.Ссылка = ИдентификаторДокументаВДиадок.Объект)
				|			И (ИдентификаторДокументаВДиадок.Свойство = &ИдентификаторДокументаВДиадокСч)
				|ГДЕ
				|	ОтборОрганизации.СпособОтправкиСчета = ""СчетНаОплату""
				|	И (ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") = """"
				|			ИЛИ ИдентификаторДокументаВДиадок.Значение ПОДОБНО ""усл:%"")
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ РАЗРЕШЕННЫЕ
				|	ВложенныйЗапрос.Документ,
				|	СУММА(ВложенныйЗапрос.СуммаНДС) КАК СуммаНДС
				|ПОМЕСТИТЬ ВТ_СуммаНДСЗначение
				|ИЗ
				|	(ВЫБРАТЬ
				|		ВТ_Основная.Документ КАК Документ,
				|		Товары.СуммаНДС КАК СуммаНДС
				|	ИЗ
				|		ВТ_Основная КАК ВТ_Основная
				|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетНаОплатуПокупателю.Товары КАК Товары
				|			ПО ВТ_Основная.Документ = Товары.Ссылка
				|	
				|	ОБЪЕДИНИТЬ ВСЕ
				|	
				|	ВЫБРАТЬ
				|		ВТ_Основная.Документ,
				|		Услуги.СуммаНДС
				|	ИЗ
				|		ВТ_Основная КАК ВТ_Основная
				|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетНаОплатуПокупателю.Услуги КАК Услуги
				|			ПО ВТ_Основная.Документ = Услуги.Ссылка) КАК ВложенныйЗапрос
				|
				|СГРУППИРОВАТЬ ПО
				|	ВложенныйЗапрос.Документ
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ВТ_Основная.Документ,
				|	ВТ_Основная.Продавец,
				|	ВТ_Основная.Покупатель,
				|	ВТ_Основная.СуммаДокументаЗначение,
				|	ЕСТЬNULL(ВТ_СуммаНДСЗначение.СуммаНДС, 0) КАК СуммаНДСЗначение,
				|	ВТ_Основная.Валюта,
				|	ВТ_Основная.Проведен,
				|	ВТ_Основная.Дата,
				|	ВТ_Основная.Номер,
				|	ВТ_Основная.ID,
				|	ИСТИНА КАК ЭтоСчет,
				|	ВТ_Основная.CounteragentID,
				|	НЕОПРЕДЕЛЕНО КАК Грузополучатель,
				|	"""" КАК СостояниеОтправкиДополнительныхВПФ,
				|	"""" КАК ФункцияУПД
				|ПОМЕСТИТЬ СчетаНаОплату_СчетНаОплатуПокупателю
				|ИЗ
				|	ВТ_Основная КАК ВТ_Основная
				|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СуммаНДСЗначение КАК ВТ_СуммаНДСЗначение
				|		ПО ВТ_Основная.Документ = ВТ_СуммаНДСЗначение.Документ
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ ВТ_Основная
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ ВТ_СуммаНДСЗначение";
				
				Запрос.Выполнить();
				
				МассивВременныхТаблиц.Добавить("СчетаНаОплату_СчетНаОплатуПокупателю");
				
			КонецПроцедуры
			
			Процедура ПодготовитьВТ_СчетаНаОплату_РеализацияТоваровУслуг(Запрос, МассивВременныхТаблиц) Экспорт
				
				Запрос.Текст=
				"ВЫБРАТЬ РАЗРЕШЕННЫЕ
				|	Т.Ссылка КАК Документ,
				|	Т.Организация КАК Продавец,
				|	Т.Контрагент КАК Покупатель,
				|	НЕОПРЕДЕЛЕНО КАК Грузополучатель,
				|	Т.СуммаДокумента КАК СуммаДокументаЗначение,
				|	Т.ВалютаДокумента КАК Валюта,
				|	Т.Проведен,
				|	Т.Дата,
				|	Т.Номер,
				|	ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") КАК ID,
				|	ОтборКонтрагенты.CounteragentID
				|ПОМЕСТИТЬ ВТ_Основная
				|ИЗ
				|	ОтборОрганизации КАК ОтборОрганизации
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК Т
				|		ПО (Т.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания)
				|			И (Т.Организация = ОтборОрганизации.Организация)
				|			И (Т.Проведен)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборКонтрагенты КАК ОтборКонтрагенты
				|		ПО (Т.Контрагент = ОтборКонтрагенты.Контрагент)
				|		ЛЕВОЕ СОЕДИНЕНИЕ ОтборГрузополучатели КАК ОтборГрузополучатели
				|		ПО (Т.Контрагент = ОтборГрузополучатели.Контрагент)
				|			И (Т.Грузополучатель = ОтборГрузополучатели.Грузополучатель)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ИдентификаторДокументаВДиадок
				|		ПО (Т.Ссылка = ИдентификаторДокументаВДиадок.Объект)
				|			И (ИдентификаторДокументаВДиадок.Свойство = &ИдентификаторДокументаВДиадокСч)
				|ГДЕ
				|	ОтборОрганизации.СпособОтправкиСчета = ""РеализацияТоваров""
				|	И НЕ ОтборОрганизации.ОтпрНеПроведенные
				|	И ОтборГрузополучатели.Контрагент ЕСТЬ NULL 
				|	И (ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") = """"
				|			ИЛИ ИдентификаторДокументаВДиадок.Значение ПОДОБНО ""усл:%"")
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	Т.Ссылка,
				|	Т.Организация,
				|	Т.Контрагент,
				|	НЕОПРЕДЕЛЕНО,
				|	Т.СуммаДокумента,
				|	Т.ВалютаДокумента,
				|	Т.Проведен,
				|	Т.Дата,
				|	Т.Номер,
				|	ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """"),
				|	ОтборКонтрагенты.CounteragentID
				|ИЗ
				|	ОтборОрганизации КАК ОтборОрганизации
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК Т
				|		ПО (Т.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания)
				|			И (Т.Организация = ОтборОрганизации.Организация)
				|			И (НЕ Т.ПометкаУдаления)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборКонтрагенты КАК ОтборКонтрагенты
				|		ПО (Т.Контрагент = ОтборКонтрагенты.Контрагент)
				|		ЛЕВОЕ СОЕДИНЕНИЕ ОтборГрузополучатели КАК ОтборГрузополучатели
				|		ПО (Т.Контрагент = ОтборГрузополучатели.Контрагент)
				|			И (Т.Грузополучатель = ОтборГрузополучатели.Грузополучатель)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ИдентификаторДокументаВДиадок
				|		ПО (Т.Ссылка = ИдентификаторДокументаВДиадок.Объект)
				|			И (ИдентификаторДокументаВДиадок.Свойство = &ИдентификаторДокументаВДиадокСч)
				|ГДЕ
				|	ОтборОрганизации.СпособОтправкиСчета = ""РеализацияТоваров""
				|	И ОтборОрганизации.ОтпрНеПроведенные
				|	И ОтборГрузополучатели.Контрагент ЕСТЬ NULL 
				|	И (ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") = """"
				|			ИЛИ ИдентификаторДокументаВДиадок.Значение ПОДОБНО ""усл:%"")
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	Т.Ссылка,
				|	Т.Организация,
				|	Т.Контрагент,
				|	Т.Грузополучатель,
				|	Т.СуммаДокумента,
				|	Т.ВалютаДокумента,
				|	Т.Проведен,
				|	Т.Дата,
				|	Т.Номер,
				|	ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """"),
				|	ОтборГрузополучатели.CounteragentID
				|ИЗ
				|	ОтборОрганизации КАК ОтборОрганизации
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК Т
				|		ПО (Т.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания)
				|			И (Т.Организация = ОтборОрганизации.Организация)
				|			И (Т.Проведен)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборГрузополучатели КАК ОтборГрузополучатели
				|		ПО (Т.Контрагент = ОтборГрузополучатели.Контрагент)
				|			И (Т.Грузополучатель = ОтборГрузополучатели.Грузополучатель)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ИдентификаторДокументаВДиадок
				|		ПО (Т.Ссылка = ИдентификаторДокументаВДиадок.Объект)
				|			И (ИдентификаторДокументаВДиадок.Свойство = &ИдентификаторДокументаВДиадокСч)
				|ГДЕ
				|	ОтборОрганизации.СпособОтправкиСчета = ""РеализацияТоваров""
				|	И НЕ ОтборОрганизации.ОтпрНеПроведенные
				|	И (ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") = """"
				|			ИЛИ ИдентификаторДокументаВДиадок.Значение ПОДОБНО ""усл:%"")
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	Т.Ссылка,
				|	Т.Организация,
				|	Т.Контрагент,
				|	Т.Грузополучатель,
				|	Т.СуммаДокумента,
				|	Т.ВалютаДокумента,
				|	Т.Проведен,
				|	Т.Дата,
				|	Т.Номер,
				|	ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """"),
				|	ОтборГрузополучатели.CounteragentID
				|ИЗ
				|	ОтборОрганизации КАК ОтборОрганизации
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК Т
				|		ПО (Т.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания)
				|			И (Т.Организация = ОтборОрганизации.Организация)
				|			И (НЕ Т.ПометкаУдаления)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборГрузополучатели КАК ОтборГрузополучатели
				|		ПО (Т.Контрагент = ОтборГрузополучатели.Контрагент)
				|			И (Т.Грузополучатель = ОтборГрузополучатели.Грузополучатель)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ИдентификаторДокументаВДиадок
				|		ПО (Т.Ссылка = ИдентификаторДокументаВДиадок.Объект)
				|			И (ИдентификаторДокументаВДиадок.Свойство = &ИдентификаторДокументаВДиадокСч)
				|ГДЕ
				|	ОтборОрганизации.СпособОтправкиСчета = ""РеализацияТоваров""
				|	И ОтборОрганизации.ОтпрНеПроведенные
				|	И (ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") = """"
				|			ИЛИ ИдентификаторДокументаВДиадок.Значение ПОДОБНО ""усл:%"")
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ВложенныйЗапрос.Документ,
				|	СУММА(ВложенныйЗапрос.СуммаНДС) КАК СуммаНДС
				|ПОМЕСТИТЬ ВТ_СуммаНДСЗначение
				|ИЗ
				|	(ВЫБРАТЬ
				|		ВТ_Основная.Документ КАК Документ,
				|		Товары.СуммаНДС КАК СуммаНДС
				|	ИЗ
				|		ВТ_Основная КАК ВТ_Основная
				|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Товары КАК Товары
				|			ПО ВТ_Основная.Документ = Товары.Ссылка
				|	
				|	ОБЪЕДИНИТЬ ВСЕ
				|	
				|	ВЫБРАТЬ
				|		ВТ_Основная.Документ,
				|		Услуги.СуммаНДС
				|	ИЗ
				|		ВТ_Основная КАК ВТ_Основная
				|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Услуги КАК Услуги
				|			ПО ВТ_Основная.Документ = Услуги.Ссылка) КАК ВложенныйЗапрос
				|
				|СГРУППИРОВАТЬ ПО
				|	ВложенныйЗапрос.Документ
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ВТ_Основная.Документ,
				|	ВТ_Основная.Продавец,
				|	ВТ_Основная.Покупатель,
				|	ВТ_Основная.Грузополучатель,
				|	ВТ_Основная.СуммаДокументаЗначение,
				|	ЕСТЬNULL(ВТ_СуммаНДСЗначение.СуммаНДС, 0) КАК СуммаНДСЗначение,
				|	ВТ_Основная.Валюта,
				|	ВТ_Основная.Проведен,
				|	ВТ_Основная.Дата,
				|	ВТ_Основная.Номер,
				|	ВТ_Основная.ID,
				|	ВТ_Основная.CounteragentID,
				|	ИСТИНА КАК ЭтоСчет,
				|	"""" КАК СостояниеОтправкиДополнительныхВПФ,
				|	"""" КАК ФункцияУПД
				|ПОМЕСТИТЬ СчетаНаОплату_РеализацияТоваровУслуг
				|ИЗ
				|	ВТ_Основная КАК ВТ_Основная
				|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СуммаНДСЗначение КАК ВТ_СуммаНДСЗначение
				|		ПО ВТ_Основная.Документ = ВТ_СуммаНДСЗначение.Документ
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ ВТ_Основная
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ ВТ_СуммаНДСЗначение";
				
				Запрос.Выполнить();
				
				МассивВременныхТаблиц.Добавить("СчетаНаОплату_РеализацияТоваровУслуг");
				
			КонецПроцедуры
			
			Процедура ПодготовитьВТ_СчетаНаОплату_КорректировкаРеализации(Запрос, МассивВременныхТаблиц) Экспорт
				
				Запрос.Текст=
				"ВЫБРАТЬ РАЗРЕШЕННЫЕ
				|	Т.Ссылка КАК Документ,
				|	Т.Организация КАК Продавец,
				|	Т.Контрагент КАК Покупатель,
				|	НЕОПРЕДЕЛЕНО КАК Грузополучатель,
				|	Т.СуммаДокумента КАК СуммаДокументаЗначение,
				|	Т.ВалютаДокумента КАК Валюта,
				|	Т.Проведен,
				|	Т.Дата,
				|	Т.Номер,
				|	ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") КАК ID,
				|	ОтборКонтрагенты.CounteragentID
				|ПОМЕСТИТЬ ВТ_Основная
				|ИЗ
				|	ОтборОрганизации КАК ОтборОрганизации
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КорректировкаРеализации КАК Т
				|		ПО (Т.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания)
				|			И (Т.Организация = ОтборОрганизации.Организация)
				|			И (Т.Проведен)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборКонтрагенты КАК ОтборКонтрагенты
				|		ПО (Т.Контрагент = ОтборКонтрагенты.Контрагент)
				|		ЛЕВОЕ СОЕДИНЕНИЕ ОтборГрузополучатели КАК ОтборГрузополучатели
				|		ПО (Т.Контрагент = ОтборГрузополучатели.Контрагент)
				|			И (Т.Грузополучатель = ОтборГрузополучатели.Грузополучатель)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ИдентификаторДокументаВДиадок
				|		ПО (Т.Ссылка = ИдентификаторДокументаВДиадок.Объект)
				|			И (ИдентификаторДокументаВДиадок.Свойство = &ИдентификаторДокументаВДиадокСч)
				|ГДЕ
				|	ОтборОрганизации.СпособОтправкиСчета = ""РеализацияТоваров""
				|	И НЕ ОтборОрганизации.ОтпрНеПроведенные
				|	И ОтборГрузополучатели.Контрагент ЕСТЬ NULL 
				|	И (ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") = """"
				|			ИЛИ ИдентификаторДокументаВДиадок.Значение ПОДОБНО ""усл:%"")
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	Т.Ссылка,
				|	Т.Организация,
				|	Т.Контрагент,
				|	НЕОПРЕДЕЛЕНО,
				|	Т.СуммаДокумента,
				|	Т.ВалютаДокумента,
				|	Т.Проведен,
				|	Т.Дата,
				|	Т.Номер,
				|	ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """"),
				|	ОтборКонтрагенты.CounteragentID
				|ИЗ
				|	ОтборОрганизации КАК ОтборОрганизации
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КорректировкаРеализации КАК Т
				|		ПО (Т.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания)
				|			И (Т.Организация = ОтборОрганизации.Организация)
				|			И (НЕ Т.ПометкаУдаления)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборКонтрагенты КАК ОтборКонтрагенты
				|		ПО (Т.Контрагент = ОтборКонтрагенты.Контрагент)
				|		ЛЕВОЕ СОЕДИНЕНИЕ ОтборГрузополучатели КАК ОтборГрузополучатели
				|		ПО (Т.Контрагент = ОтборГрузополучатели.Контрагент)
				|			И (Т.Грузополучатель = ОтборГрузополучатели.Грузополучатель)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ИдентификаторДокументаВДиадок
				|		ПО (Т.Ссылка = ИдентификаторДокументаВДиадок.Объект)
				|			И (ИдентификаторДокументаВДиадок.Свойство = &ИдентификаторДокументаВДиадокСч)
				|ГДЕ
				|	ОтборОрганизации.СпособОтправкиСчета = ""РеализацияТоваров""
				|	И ОтборОрганизации.ОтпрНеПроведенные
				|	И ОтборГрузополучатели.Контрагент ЕСТЬ NULL 
				|	И (ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") = """"
				|			ИЛИ ИдентификаторДокументаВДиадок.Значение ПОДОБНО ""усл:%"")
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	Т.Ссылка,
				|	Т.Организация,
				|	Т.Контрагент,
				|	Т.Грузополучатель,
				|	Т.СуммаДокумента,
				|	Т.ВалютаДокумента,
				|	Т.Проведен,
				|	Т.Дата,
				|	Т.Номер,
				|	ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """"),
				|	ОтборГрузополучатели.CounteragentID
				|ИЗ
				|	ОтборОрганизации КАК ОтборОрганизации
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КорректировкаРеализации КАК Т
				|		ПО (Т.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания)
				|			И (Т.Организация = ОтборОрганизации.Организация)
				|			И (Т.Проведен)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборГрузополучатели КАК ОтборГрузополучатели
				|		ПО (Т.Контрагент = ОтборГрузополучатели.Контрагент)
				|			И (Т.Грузополучатель = ОтборГрузополучатели.Грузополучатель)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ИдентификаторДокументаВДиадок
				|		ПО (Т.Ссылка = ИдентификаторДокументаВДиадок.Объект)
				|			И (ИдентификаторДокументаВДиадок.Свойство = &ИдентификаторДокументаВДиадокСч)
				|ГДЕ
				|	ОтборОрганизации.СпособОтправкиСчета = ""РеализацияТоваров""
				|	И НЕ ОтборОрганизации.ОтпрНеПроведенные
				|	И (ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") = """"
				|			ИЛИ ИдентификаторДокументаВДиадок.Значение ПОДОБНО ""усл:%"")
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	Т.Ссылка,
				|	Т.Организация,
				|	Т.Контрагент,
				|	Т.Грузополучатель,
				|	Т.СуммаДокумента,
				|	Т.ВалютаДокумента,
				|	Т.Проведен,
				|	Т.Дата,
				|	Т.Номер,
				|	ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """"),
				|	ОтборГрузополучатели.CounteragentID
				|ИЗ
				|	ОтборОрганизации КАК ОтборОрганизации
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КорректировкаРеализации КАК Т
				|		ПО (Т.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания)
				|			И (Т.Организация = ОтборОрганизации.Организация)
				|			И (НЕ Т.ПометкаУдаления)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборГрузополучатели КАК ОтборГрузополучатели
				|		ПО (Т.Контрагент = ОтборГрузополучатели.Контрагент)
				|			И (Т.Грузополучатель = ОтборГрузополучатели.Грузополучатель)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ИдентификаторДокументаВДиадок
				|		ПО (Т.Ссылка = ИдентификаторДокументаВДиадок.Объект)
				|			И (ИдентификаторДокументаВДиадок.Свойство = &ИдентификаторДокументаВДиадокСч)
				|ГДЕ
				|	ОтборОрганизации.СпособОтправкиСчета = ""РеализацияТоваров""
				|	И ОтборОрганизации.ОтпрНеПроведенные
				|	И (ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") = """"
				|			ИЛИ ИдентификаторДокументаВДиадок.Значение ПОДОБНО ""усл:%"")
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ВложенныйЗапрос.Документ,
				|	СУММА(ВложенныйЗапрос.СуммаНДС) КАК СуммаНДС
				|ПОМЕСТИТЬ ВТ_СуммаНДСЗначение
				|ИЗ
				|	(ВЫБРАТЬ
				|		ВТ_Основная.Документ КАК Документ,
				|		Товары.СуммаНДС КАК СуммаНДС
				|	ИЗ
				|		ВТ_Основная КАК ВТ_Основная
				|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КорректировкаРеализации.Товары КАК Товары
				|			ПО ВТ_Основная.Документ = Товары.Ссылка
				|	
				|	ОБЪЕДИНИТЬ ВСЕ
				|	
				|	ВЫБРАТЬ
				|		ВТ_Основная.Документ,
				|		Услуги.СуммаНДС
				|	ИЗ
				|		ВТ_Основная КАК ВТ_Основная
				|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КорректировкаРеализации.Услуги КАК Услуги
				|			ПО ВТ_Основная.Документ = Услуги.Ссылка) КАК ВложенныйЗапрос
				|
				|СГРУППИРОВАТЬ ПО
				|	ВложенныйЗапрос.Документ
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ВТ_Основная.Документ,
				|	ВТ_Основная.Продавец,
				|	ВТ_Основная.Покупатель,
				|	ВТ_Основная.Грузополучатель,
				|	ВТ_Основная.СуммаДокументаЗначение,
				|	ЕСТЬNULL(ВТ_СуммаНДСЗначение.СуммаНДС, 0) КАК СуммаНДСЗначение,
				|	ВТ_Основная.Валюта,
				|	ВТ_Основная.Проведен,
				|	ВТ_Основная.Дата,
				|	ВТ_Основная.Номер,
				|	ВТ_Основная.ID,
				|	ВТ_Основная.CounteragentID,
				|	ИСТИНА КАК ЭтоСчет,
				|	"""" КАК СостояниеОтправкиДополнительныхВПФ,
				|	"""" КАК ФункцияУПД
				|ПОМЕСТИТЬ СчетаНаОплату_КорректировкаРеализации
				|ИЗ
				|	ВТ_Основная КАК ВТ_Основная
				|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СуммаНДСЗначение КАК ВТ_СуммаНДСЗначение
				|		ПО ВТ_Основная.Документ = ВТ_СуммаНДСЗначение.Документ
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ ВТ_Основная
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ ВТ_СуммаНДСЗначение";
				
				Запрос.Выполнить();
				
				МассивВременныхТаблиц.Добавить("СчетаНаОплату_КорректировкаРеализации");
				
			КонецПроцедуры
			
			Процедура ПодготовитьВТ_СчетаНаОплату_ЗаказПокупателя(Запрос, МассивВременныхТаблиц) Экспорт
				
				Запрос.Текст=
				"ВЫБРАТЬ РАЗРЕШЕННЫЕ
				|	Т.Ссылка КАК Документ,
				|	Т.Организация КАК Продавец,
				|	Т.Контрагент КАК Покупатель,
				|	НЕОПРЕДЕЛЕНО КАК Грузополучатель,
				|	Т.СуммаДокумента КАК СуммаДокументаЗначение,
				|	Т.ВалютаДокумента КАК Валюта,
				|	Т.Проведен,
				|	Т.Дата,
				|	Т.Номер,
				|	ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") КАК ID,
				|	ОтборКонтрагенты.CounteragentID
				|ПОМЕСТИТЬ ВТ_Основная
				|ИЗ
				|	ОтборОрганизации КАК ОтборОрганизации
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказПокупателя КАК Т
				|		ПО (Т.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания)
				|			И (Т.Организация = ОтборОрганизации.Организация)
				|			И (Т.Проведен)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборКонтрагенты КАК ОтборКонтрагенты
				|		ПО (Т.Контрагент = ОтборКонтрагенты.Контрагент)
				|		ЛЕВОЕ СОЕДИНЕНИЕ ОтборГрузополучатели КАК ОтборГрузополучатели
				|		ПО (Т.Контрагент = ОтборГрузополучатели.Контрагент)
				|			И (Т.Грузополучатель = ОтборГрузополучатели.Грузополучатель)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ИдентификаторДокументаВДиадок
				|		ПО (Т.Ссылка = ИдентификаторДокументаВДиадок.Объект)
				|			И (ИдентификаторДокументаВДиадок.Свойство = &ИдентификаторДокументаВДиадокСч)
				|ГДЕ
				|	ОтборОрганизации.СпособОтправкиСчета = ""Заказ""
				|	И НЕ ОтборОрганизации.ОтпрНеПроведенные
				|	И ОтборГрузополучатели.Контрагент ЕСТЬ NULL 
				|	И (ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") = """"
				|			ИЛИ ИдентификаторДокументаВДиадок.Значение ПОДОБНО ""усл:%"")
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	Т.Ссылка,
				|	Т.Организация,
				|	Т.Контрагент,
				|	НЕОПРЕДЕЛЕНО,
				|	Т.СуммаДокумента,
				|	Т.ВалютаДокумента,
				|	Т.Проведен,
				|	Т.Дата,
				|	Т.Номер,
				|	ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """"),
				|	ОтборКонтрагенты.CounteragentID
				|ИЗ
				|	ОтборОрганизации КАК ОтборОрганизации
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказПокупателя КАК Т
				|		ПО (Т.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания)
				|			И (Т.Организация = ОтборОрганизации.Организация)
				|			И (НЕ Т.ПометкаУдаления)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборКонтрагенты КАК ОтборКонтрагенты
				|		ПО (Т.Контрагент = ОтборКонтрагенты.Контрагент)
				|		ЛЕВОЕ СОЕДИНЕНИЕ ОтборГрузополучатели КАК ОтборГрузополучатели
				|		ПО (Т.Контрагент = ОтборГрузополучатели.Контрагент)
				|			И (Т.Грузополучатель = ОтборГрузополучатели.Грузополучатель)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ИдентификаторДокументаВДиадок
				|		ПО (Т.Ссылка = ИдентификаторДокументаВДиадок.Объект)
				|			И (ИдентификаторДокументаВДиадок.Свойство = &ИдентификаторДокументаВДиадокСч)
				|ГДЕ
				|	ОтборОрганизации.СпособОтправкиСчета = ""Заказ""
				|	И ОтборОрганизации.ОтпрНеПроведенные
				|	И ОтборГрузополучатели.Контрагент ЕСТЬ NULL 
				|	И (ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") = """"
				|			ИЛИ ИдентификаторДокументаВДиадок.Значение ПОДОБНО ""усл:%"")
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	Т.Ссылка,
				|	Т.Организация,
				|	Т.Контрагент,
				|	Т.Грузополучатель,
				|	Т.СуммаДокумента,
				|	Т.ВалютаДокумента,
				|	Т.Проведен,
				|	Т.Дата,
				|	Т.Номер,
				|	ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """"),
				|	ОтборГрузополучатели.CounteragentID
				|ИЗ
				|	ОтборОрганизации КАК ОтборОрганизации
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказПокупателя КАК Т
				|		ПО (Т.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания)
				|			И (Т.Организация = ОтборОрганизации.Организация)
				|			И (Т.Проведен)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборГрузополучатели КАК ОтборГрузополучатели
				|		ПО (Т.Контрагент = ОтборГрузополучатели.Контрагент)
				|			И (Т.Грузополучатель = ОтборГрузополучатели.Грузополучатель)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ИдентификаторДокументаВДиадок
				|		ПО (Т.Ссылка = ИдентификаторДокументаВДиадок.Объект)
				|			И (ИдентификаторДокументаВДиадок.Свойство = &ИдентификаторДокументаВДиадокСч)
				|ГДЕ
				|	ОтборОрганизации.СпособОтправкиСчета = ""Заказ""
				|	И НЕ ОтборОрганизации.ОтпрНеПроведенные
				|	И (ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") = """"
				|			ИЛИ ИдентификаторДокументаВДиадок.Значение ПОДОБНО ""усл:%"")
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	Т.Ссылка,
				|	Т.Организация,
				|	Т.Контрагент,
				|	Т.Грузополучатель,
				|	Т.СуммаДокумента,
				|	Т.ВалютаДокумента,
				|	Т.Проведен,
				|	Т.Дата,
				|	Т.Номер,
				|	ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """"),
				|	ОтборГрузополучатели.CounteragentID
				|ИЗ
				|	ОтборОрганизации КАК ОтборОрганизации
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказПокупателя КАК Т
				|		ПО (Т.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания)
				|			И (Т.Организация = ОтборОрганизации.Организация)
				|			И (НЕ Т.ПометкаУдаления)
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборГрузополучатели КАК ОтборГрузополучатели
				|		ПО (Т.Контрагент = ОтборГрузополучатели.Контрагент)
				|			И (Т.Грузополучатель = ОтборГрузополучатели.Грузополучатель)
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ИдентификаторДокументаВДиадок
				|		ПО (Т.Ссылка = ИдентификаторДокументаВДиадок.Объект)
				|			И (ИдентификаторДокументаВДиадок.Свойство = &ИдентификаторДокументаВДиадокСч)
				|ГДЕ
				|	ОтборОрганизации.СпособОтправкиСчета = ""Заказ""
				|	И ОтборОрганизации.ОтпрНеПроведенные
				|	И (ЕСТЬNULL(ИдентификаторДокументаВДиадок.Значение, """") = """"
				|			ИЛИ ИдентификаторДокументаВДиадок.Значение ПОДОБНО ""усл:%"")
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ВложенныйЗапрос.Документ,
				|	СУММА(ВложенныйЗапрос.СуммаНДС) КАК СуммаНДС
				|ПОМЕСТИТЬ ВТ_СуммаНДСЗначение
				|ИЗ
				|	(ВЫБРАТЬ
				|		ВТ_Основная.Документ КАК Документ,
				|		Товары.СуммаНДС КАК СуммаНДС
				|	ИЗ
				|		ВТ_Основная КАК ВТ_Основная
				|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказПокупателя.Товары КАК Товары
				|			ПО ВТ_Основная.Документ = Товары.Ссылка
				|	
				|	ОБЪЕДИНИТЬ ВСЕ
				|	
				|	ВЫБРАТЬ
				|		ВТ_Основная.Документ,
				|		Услуги.СуммаНДС
				|	ИЗ
				|		ВТ_Основная КАК ВТ_Основная
				|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказПокупателя.Услуги КАК Услуги
				|			ПО ВТ_Основная.Документ = Услуги.Ссылка) КАК ВложенныйЗапрос
				|
				|СГРУППИРОВАТЬ ПО
				|	ВложенныйЗапрос.Документ
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ВТ_Основная.Документ,
				|	ВТ_Основная.Продавец,
				|	ВТ_Основная.Покупатель,
				|	ВТ_Основная.Грузополучатель,
				|	ВТ_Основная.СуммаДокументаЗначение,
				|	ЕСТЬNULL(ВТ_СуммаНДСЗначение.СуммаНДС, 0) КАК СуммаНДСЗначение,
				|	ВТ_Основная.Валюта,
				|	ВТ_Основная.Проведен,
				|	ВТ_Основная.Дата,
				|	ВТ_Основная.Номер,
				|	ВТ_Основная.ID,
				|	ВТ_Основная.CounteragentID,
				|	ИСТИНА КАК ЭтоСчет,
				|	"""" КАК СостояниеОтправкиДополнительныхВПФ,
				|	"""" КАК ФункцияУПД
				|ПОМЕСТИТЬ СчетаНаОплату_ЗаказПокупателя
				|ИЗ
				|	ВТ_Основная КАК ВТ_Основная
				|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СуммаНДСЗначение КАК ВТ_СуммаНДСЗначение
				|		ПО ВТ_Основная.Документ = ВТ_СуммаНДСЗначение.Документ
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ ВТ_Основная
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ ВТ_СуммаНДСЗначение";
				
				Запрос.Выполнить();
				
				МассивВременныхТаблиц.Добавить("СчетаНаОплату_ЗаказПокупателя");
				
			КонецПроцедуры
			
		//} Подготовка временных таблиц для списка отправки документов...
		
	//} ФОРМИРОВАНИЕ СПИСКА ВЫГРУЗКИ
	
	//{ Управление ГТД

		Функция ЕстьВозможностьЗаполненияГТД(Видоперации, ЭДОбъект) Экспорт
			Возврат Ложь;	
		КонецФункции

		Функция ЕстьВозможностьЗаполненияСерий(Видоперации, ЭДОбъект) Экспорт
			Если Видоперации = "ПокупкаКомиссия"
				ИЛИ Видоперации = "ПоступлениеОборудования"
				ИЛИ Видоперации = "ВозвратОтПокупателя"
				ИЛИ Видоперации = "ПоступлениеАвтомобилей" Тогда
				
				Если ПолучитьФорму("Форма_Диадок_ЭД").ДляDocumentЕстьГТД(ЭДОбъект) Тогда
					Возврат Истина;
				КонецЕсли;
			КонецЕсли;
			Возврат Ложь;
		КонецФункции
		
	//} Управление ГТД
	
//} Общие запросы типовых КФ Семейства УТ

//{ СозданиеДокументов1С

Процедура ЗаполнитьОснованием_СчетФактура(ДокументОбъект, ДокументОснование) Экспорт
	
	Если ТипЗнч(ДокументОснование) = Тип("Массив") Тогда
		ДокументыОснования= ДокументОснование;
	Иначе
		
		ДокументыОснования= Новый Массив;
		
		Если ЗначениеЗаполнено(ДокументОснование) Тогда
			ДокументыОснования.Добавить(ДокументОснование);
		КонецЕсли;
	
	КонецЕсли;
	
	ДокументыОснованияВГраница= ДокументыОснования.ВГраница();
	
	Если ДокументыОснованияВГраница = -1 Тогда // Документов основания нет
		Возврат;
	КонецЕсли;
	
	ЕстьТабЧастьДокументыОснования= ДокументОбъект.Метаданные().ТабличныеЧасти.Найти("ДокументыОснования") <> Неопределено;
	
	Если ЕстьТабЧастьДокументыОснования Тогда
		
		// Заполняем табличную часть ДокументыОснования без последнего документа,
		// для того чтобы вызвать этим документом стандартную обработку заполнения шапки
		Для ИндексЦикла= 0 ПО ДокументыОснованияВГраница - 1 Цикл
			ДокументОбъект.ДокументыОснования.Добавить().ДокументОснование= ДокументыОснования[ИндексЦикла];
		КонецЦикла;
		
	КонецЕсли;
	
	Попытка
		// Заполняем шапку документа с помощью последнего документа основания
		ДокументОбъект.Заполнить(ДокументыОснования[ДокументыОснованияВГраница]);
	Исключение
		Если ЕстьТабЧастьДокументыОснования Тогда
			ДокументОбъект.ДокументыОснования.Добавить().ДокументОснование = ДокументыОснования[ДокументыОснованияВГраница];
		КонецЕсли;
	КонецПопытки;
	
КонецПроцедуры

Процедура ЗаполнитьРеквизиты_СчетФактураПолученный(ДокументОбъект, Document, ПараметрыЗаполнения) Экспорт
	
	Реквизиты= Новый Структура;
	
	Если Document.Type = "InvoiceRevision" Тогда
		
		Реквизиты.Вставить("НомерВходящегоДокумента", Document.OriginalDocumentNumber);
		Реквизиты.Вставить("ДатаВходящегоДокумента"	, Document.OriginalDocumentDate);
		
		Реквизиты.Вставить("Исправление", Истина);
		
		Реквизиты.Вставить("НомерИсправления", Document.DocumentNumber);
		Реквизиты.Вставить("ДатаИсправления" , Document.DocumentDate);
	
	ИначеЕсли Document.Type = "InvoiceCorrection" Тогда
		
		Реквизиты.Вставить("НомерВходящегоДокумента", Document.DocumentNumber);
		Реквизиты.Вставить("ДатаВходящегоДокумента"	, Document.DocumentDate);
		
		Реквизиты.Вставить("НомерИсходногоДокумента", Document.OriginalDocumentNumber);
		Реквизиты.Вставить("ДатаИсходногоДокумента"	, Document.OriginalDocumentDate);
		
		Попытка
			Реквизиты.Вставить("ВидСчетаФактуры", Перечисления.ВидСчетаФактурыПолученного.Корректировочный);
		Исключение КонецПопытки;
		
	ИначеЕсли Document.Type = "InvoiceCorrectionRevision" Тогда
		
		Реквизиты.Вставить("НомерВходящегоДокумента", Document.OriginalInvoiceCorrectionNumber);
		Реквизиты.Вставить("ДатаВходящегоДокумента"	, Document.OriginalInvoiceCorrectionDate);
		
		Реквизиты.Вставить("НомерИсходногоДокумента", Document.OriginalDocumentNumber);
		Реквизиты.Вставить("ДатаИсходногоДокумента"	, Document.OriginalDocumentDate);
		
		Попытка
			Реквизиты.Вставить("ВидСчетаФактуры", Перечисления.ВидСчетаФактурыПолученного.Корректировочный);
		Исключение КонецПопытки;
		
		Реквизиты.Вставить("Исправление", Истина);
		
		Реквизиты.Вставить("НомерИсправления", Document.DocumentNumber);
		Реквизиты.Вставить("ДатаИсправления" , Document.DocumentDate);
		
	Иначе
		
		Реквизиты.Вставить("НомерВходящегоДокумента", Document.DocumentNumber);
		Реквизиты.Вставить("ДатаВходящегоДокумента"	, Document.DocumentDate);
		
		Попытка
			Реквизиты.Вставить("ВидСчетаФактуры", Перечисления.ВидСчетаФактурыПолученного.НаПоступление);
		Исключение КонецПопытки;
		
	КонецЕсли;
	
	Реквизиты.Вставить("ВхДокНомер", Реквизиты.НомерВходящегоДокумента);
	Реквизиты.Вставить("ВхДокДата" , Реквизиты.ДатаВходящегоДокумента);
	
	Если ТипЗнч(ДокументОбъект.Ссылка) = Тип("ДокументСсылка.СчетФактураПолученный")
		И ДокументОбъект.Ссылка = Документы.СчетФактураПолученный.ПустаяСсылка() Тогда
		
		//идет запонение созданного документа
		Реквизиты.Вставить("Дата", ТекущаяДата());
	КонецЕсли;
	
	Реквизиты.Вставить("КодВидаОперации", "01");
	Реквизиты.Вставить("КодСпособаПолучения", 2);
	
	ЗаполнитьЗначенияСвойств(ДокументОбъект, Реквизиты);
	
	Реквизиты= Неопределено;
	
	Если ПараметрыЗаполнения <> Неопределено И ПараметрыЗаполнения.Свойство("Реквизиты") Тогда
		ЗаполнитьЗначенияСвойств(ДокументОбъект, ПараметрыЗаполнения.Реквизиты);
	КонецЕсли;
	
	УстановитьДоговорВСчетеФактуреДляДиадок(ДокументОбъект);
	
КонецПроцедуры

Процедура ЗаполнитьРеквизиты_СчетФактураВыданный(ДокументОбъект, Document, ПараметрыЗаполнения= Неопределено) Экспорт
	
	Реквизиты= Новый Структура;
	
	Реквизиты.Вставить("КодВидаОперации", "01");
	Реквизиты.Вставить("КодСпособаВыставления", 2);
	
	Реквизиты.Вставить("Дата", ТекущаяДата());
	
	Реквизиты.Вставить("Выставлен", Истина);
	Реквизиты.Вставить("ДатаВыставления", Document.ConfirmationDate);
	
	ЗаполнитьЗначенияСвойств(ДокументОбъект, Реквизиты);
	
	Реквизиты= Неопределено;
	
	Если ПараметрыЗаполнения <> Неопределено И ПараметрыЗаполнения.Свойство("Реквизиты") Тогда
		ЗаполнитьЗначенияСвойств(ДокументОбъект, ПараметрыЗаполнения.Реквизиты);
	КонецЕсли;
	
	УстановитьДоговорВСчетеФактуреДляДиадок(ДокументОбъект);
	
КонецПроцедуры

Функция СоздатьДокумент_СчетФактураПолученный(Document, ДокументОснование, ПараметрыЗаполнения) Экспорт
	
	НовыйДокумент= Документы.СчетФактураПолученный.СоздатьДокумент();
	
	ЗаполнитьОснованием_СчетФактура(НовыйДокумент, ДокументОснование);
	ЗаполнитьРеквизиты_СчетФактураПолученный(НовыйДокумент, Document, ПараметрыЗаполнения);
	
	ОбработкаСобытияПодключаемогоМодуля("ПослеСозданияСчетФактуры", Новый Структура("СчетФактураОбъект, РеализацииСсылка, Document", НовыйДокумент, ДокументОснование, Document));
	
	Возврат НовыйДокумент;
	
КонецФункции

Функция СоздатьДокумент_СчетФактураВыданный(Document, ДокументОснование, ПараметрыЗаполнения) Экспорт  
	
	НовыйДокумент= Документы.СчетФактураВыданный.СоздатьДокумент();
	
	ЗаполнитьОснованием_СчетФактура(НовыйДокумент, ДокументОснование);
	ЗаполнитьРеквизиты_СчетФактураВыданный(НовыйДокумент, Document, ПараметрыЗаполнения);
	
	ОбработкаСобытияПодключаемогоМодуля("ПослеСозданияСчетФактуры", Новый Структура("СчетФактураОбъект, РеализацииСсылка, Document", НовыйДокумент, ДокументОснование, Document));
	
	Возврат НовыйДокумент;
	
КонецФункции

//} СозданиеДокументов1С

//{ СвязиМеждуДокументами

	Функция НайтиПодходящийСчетФактуруИзРНК(МассивСсылокРНК) Экспорт
		
		Запрос = Новый Запрос(
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	Ссылка 
		|ИЗ
		|	Документ.СчетФактураПолученный
		|ГДЕ
		|	ДокументОснование В (&МассивСсылокРНК)");
		
		Если Метаданные.Документы.СчетФактураПолученный.ТабличныеЧасти.Найти("ДокументыОснования") = Неопределено Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст,"Документ.СчетФактураПолученный.ДокументыОснования", "Документ.СчетФактураПолученный");
		КонецЕсли;
		
		МассивСодержитРТУ= Ложь;
		Для Каждого СсылкаРНК ИЗ МассивСсылокРНК Цикл
			Если ТипЗнч(СсылкаРНК) = ОдинСАдаптер_Документы_ПолучитьТипДокументаРеализацияТоваровУслуг() Тогда
				МассивСодержитРТУ= Истина;
				Прервать;
			КонецЕсли;
		КонецЦикла;
		
		Если МассивСодержитРТУ Тогда
			Запрос.Текст= СтрЗаменить(Запрос.Текст, "СчетФактураПолученный", "СчетФактураВыданный");
		КонецЕсли;
		
		Запрос.УстановитьПараметр("МассивСсылокРНК", МассивСсылокРНК);
		
		РезультатЗапроса= Запрос.Выполнить();
		
		Если НЕ РезультатЗапроса.Пустой() Тогда
			Выборка= РезультатЗапроса.Выбрать();
			Выборка.Следующий();
			Возврат Выборка.Ссылка; 
		КонецЕсли;
		
	КонецФункции

	Функция ПолучитьМассивСсылокРНКПоСчетуФактуреВыданному(СсылкаНаОбъект) Экспорт
		
		Результат= Новый Массив;
		
		Запрос = Новый Запрос(
		"ВЫБРАТЬ
		|	ДокументОснование КАК Ссылка
		|ИЗ
		|	Документ.СчетФактураВыданный.ДокументыОснования
		|ГДЕ
		|	Ссылка = &СсылкаНаОбъект");
		
		Если Метаданные.Документы.СчетФактураВыданный.ТабличныеЧасти.Найти("ДокументыОснования") = Неопределено Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст,"Документ.СчетФактураВыданный.ДокументыОснования", "Документ.СчетФактураВыданный");
		КонецЕсли;
		
		Запрос.УстановитьПараметр("СсылкаНаОбъект", СсылкаНаОбъект);
		
		РезультатЗапроса= Запрос.Выполнить(); Запрос= Неопределено;
		
		Если НЕ РезультатЗапроса.Пустой() Тогда
			
			Выборка= РезультатЗапроса.Выбрать(); РезультатЗапроса= Неопределено;
			
			Пока Выборка.Следующий() Цикл
				Если ЗначениеЗаполнено(Выборка.Ссылка) Тогда
					Результат.Добавить(Выборка.Ссылка);
				КонецЕсли; 
			КонецЦикла;
			
		КонецЕсли; 
		
		Возврат Результат;
		
	КонецФункции

	Функция ПолучитьСсылкуСчетаФактурыВыданногоПоДокументуОснованию(СсылкаНаОбъект) Экспорт
		
		Запрос = Новый Запрос(
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	Ссылка
		|ИЗ
		|	Документ.СчетФактураВыданный.ДокументыОснования
		|ГДЕ
		|	ДокументОснование = &СсылкаНаОбъект");
		
		Если Метаданные.Документы.СчетФактураВыданный.ТабличныеЧасти.Найти("ДокументыОснования") = Неопределено Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст,"Документ.СчетФактураВыданный.ДокументыОснования", "Документ.СчетФактураВыданный");
		КонецЕсли;
		
		Запрос.УстановитьПараметр("СсылкаНаОбъект", СсылкаНаОбъект);
		
		РезультатЗапроса= Запрос.Выполнить();
		
		Если НЕ РезультатЗапроса.Пустой() Тогда
			Выборка= РезультатЗапроса.Выбрать();
			Выборка.Следующий();
			Возврат Выборка.Ссылка;
		КонецЕсли; 
		
	КонецФункции

	Функция ПолучитьМассивСсылокРТУПоСчетуНаОплату(СсылкаНаОбъект) Экспорт
		
		Результат= Новый Массив;
		
		Запрос = Новый Запрос(
		"ВЫБРАТЬ
		|	Ссылка
		|ИЗ
		|	Документ.РеализацияТоваровУслуг
		|ГДЕ
		|	НЕ ПометкаУдаления И Сделка = &СсылкаНаОбъект");
		
		Запрос.УстановитьПараметр("СсылкаНаОбъект", СсылкаНаОбъект);
		
		РезультатЗапроса= Запрос.Выполнить(); Запрос= Неопределено;
		
		Если НЕ РезультатЗапроса.Пустой() Тогда
			
			Выборка= РезультатЗапроса.Выбрать(); РезультатЗапроса= Неопределено;
			
			Пока Выборка.Следующий() Цикл
				Результат.Добавить(Выборка.Ссылка);
			КонецЦикла;
			
		КонецЕсли; 
		
		Возврат Результат;
		
	КонецФункции

	Функция ПолучитьСчетНаОплатуНаОснованииРТУ(СсылкаНаОбъект) Экспорт 
		
		Возврат СсылкаНаОбъект.Сделка;
		
	КонецФункции
	
	Функция ПолучитьИсправляемыйДокументРеализации(ДокРеализации) Экспорт
		
		Если ЗначениеЗаполнено(ДокРеализации) 
			И ТипЗнч(ДокРеализации) = Тип("ДокументСсылка.КорректировкаРеализации") Тогда
			Возврат ПолучитьИсправляемыйДокументРеализации(ДокРеализации.ДокументРеализации);
		Иначе
			Возврат ДокРеализации;
		КонецЕсли;	
		
	КонецФункции
	
//} СвязиМеждуДокументами


//{ Приглашение Контрагентов

	Функция ЕстьНовыеКонтрагентыДляПриглашения(МассивОрганизаций1С, ПериодАнализаДокументов) Экспорт
		
		Запрос= Новый Запрос(
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
		|	ИСТИНА КАК Поле1
		|ИЗ
		|	РегистрСведений.ЗначенияСвойствОбъектов КАК СтатусКонтрагентаНеПодходит
		|ГДЕ
		|	СтатусКонтрагентаНеПодходит.Объект В(&МассивОрганизаций1С)
		|	И СтатусКонтрагентаНеПодходит.Свойство = &ПриглашенияДатаСтатусНеПодходит
		|	И ТИПЗНАЧЕНИЯ(СтатусКонтрагентаНеПодходит.Значение) = ТИП(ДАТА)
		|	И СтатусКонтрагентаНеПодходит.Значение > &ПериодАнализаДокументов
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ ПЕРВЫЕ 1
		|	ИСТИНА
		|ИЗ
		|	Документ.РеализацияТоваровУслуг КАК Т
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ЯщикиКонтрагентов
		|		ПО Т.Контрагент = ЯщикиКонтрагентов.Объект
		|			И (ЯщикиКонтрагентов.Свойство = &ДДКонтр_)
		|			И (ЯщикиКонтрагентов.Значение <> """")
		|ГДЕ
		|	Т.Дата >= &ПериодАнализаДокументов
		|	И Т.Организация В(&МассивОрганизаций1С)
		|	И Т.ОтражатьВБухгалтерскомУчете
		|	И ЯщикиКонтрагентов.Объект ЕСТЬ NULL 
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ ПЕРВЫЕ 1
		|	ИСТИНА
		|ИЗ
		|	Документ.ПоступлениеТоваровУслуг КАК Т
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ЯщикиКонтрагентов
		|		ПО Т.Контрагент = ЯщикиКонтрагентов.Объект
		|			И (ЯщикиКонтрагентов.Свойство = &ДДКонтр_)
		|			И (ЯщикиКонтрагентов.Значение <> """")
		|ГДЕ
		|	Т.Дата >= &ПериодАнализаДокументов
		|	И Т.Организация В(&МассивОрганизаций1С)
		|	И Т.ОтражатьВБухгалтерскомУчете
		|	И ЯщикиКонтрагентов.Объект ЕСТЬ NULL 
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ ПЕРВЫЕ 1
		|	ИСТИНА
		|ИЗ
		|	Документ.АктОбОказанииПроизводственныхУслуг КАК Т
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ЯщикиКонтрагентов
		|		ПО Т.Контрагент = ЯщикиКонтрагентов.Объект
		|			И (ЯщикиКонтрагентов.Свойство = &ДДКонтр_)
		|			И (ЯщикиКонтрагентов.Значение <> """")
		|ГДЕ
		|	Т.Дата >= &ПериодАнализаДокументов
		|	И Т.Организация В(&МассивОрганизаций1С)
		|	И Т.ОтражатьВБухгалтерскомУчете
		|	И ЯщикиКонтрагентов.Объект ЕСТЬ NULL ");
		
		Запрос.УстановитьПараметр("МассивОрганизаций1С"			   , МассивОрганизаций1С);
		Запрос.УстановитьПараметр("ПериодАнализаДокументов"		   , ПериодАнализаДокументов);
		Запрос.УстановитьПараметр("ДДКонтр_"  					   , ОдинСАдаптер_СвойстваОбъектов_ПолучитьСсылкуНаСвойство("ДДКонтр_"));
		Запрос.УстановитьПараметр("ПриглашенияДатаСтатусНеПодходит", ОдинСАдаптер_СвойстваОбъектов_ПолучитьСсылкуНаСвойство("ДиадокПриглашенияДатаСтатусНеПодходит"));
	
		Возврат НЕ Запрос.Выполнить().Пустой();
		
	КонецФункции

	Функция ТаблицаКонтрагентовДляПриглашения(BoxID, ПериодАнализаДокументов) Экспорт
		
		Запрос= Новый Запрос(
		"ВЫБРАТЬ
		|	Организации.Ссылка КАК Организация,
		|	Организации.ИНН,
		|	ЯщикиОрганизаций.Значение КАК BoxID
		|ПОМЕСТИТЬ ВТ_Организации
		|ИЗ
		|	Справочник.Организации КАК Организации
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ЯщикиОрганизаций
		|		ПО Организации.Ссылка = ЯщикиОрганизаций.Объект
		|			И (ЯщикиОрганизаций.Свойство = &ЯщикДиадокДляОрганизации)
		|			И (ЯщикиОрганизаций.Значение В (&BoxID))
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВложенныйЗапрос.BoxID,
		|	ВложенныйЗапрос.Контрагент,
		|	СУММА(ВложенныйЗапрос.КоличествоДокументов) КАК КоличествоДокументов
		|ПОМЕСТИТЬ ВТ_СтатистикаДокументов
		|ИЗ
		|	(ВЫБРАТЬ
		|		ВТ_Организации.BoxID КАК BoxID,
		|		Т.Контрагент КАК Контрагент,
		|		1 КАК КоличествоДокументов
		|	ИЗ
		|		ВТ_Организации КАК ВТ_Организации
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК Т
		|			ПО ВТ_Организации.Организация = Т.Организация
		|				И (Т.Дата >= &ПериодАнализаДокументов)
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		ВТ_Организации.BoxID,
		|		Т.Контрагент,
		|		1
		|	ИЗ
		|		ВТ_Организации КАК ВТ_Организации
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПоступлениеТоваровУслуг КАК Т
		|			ПО ВТ_Организации.Организация = Т.Организация
		|				И (Т.Дата >= &ПериодАнализаДокументов)
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		ВТ_Организации.BoxID,
		|		Т.Контрагент,
		|		1
		|	ИЗ
		|		ВТ_Организации КАК ВТ_Организации
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.АктОбОказанииПроизводственныхУслуг КАК Т
		|			ПО ВТ_Организации.Организация = Т.Организация
		|				И (Т.Дата >= &ПериодАнализаДокументов)) КАК ВложенныйЗапрос
		|
		|СГРУППИРОВАТЬ ПО
		|	ВложенныйЗапрос.Контрагент,
		|	ВложенныйЗапрос.BoxID
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ВТ_Организации.BoxID,
		|	ВТ_Организации.ИНН
		|ПОМЕСТИТЬ ВТ_BoxID
		|ИЗ
		|	ВТ_Организации КАК ВТ_Организации
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ВТ_Организации
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Контрагенты.Ссылка КАК Контрагент1С,
		|	Контрагенты.Код КАК Контрагент1С_Код,
		|	Контрагенты.ИНН КАК Контрагент1С_ИНН,
		|	Контрагенты.КПП КАК Контрагент1С_КПП,
		|	ЕСТЬNULL(ЯщикиКонтрагентов.Значение, """") КАК КонтрагентЭДО_ID,
		|	ЕСТЬNULL(ВТ_СтатистикаДокументов.КоличествоДокументов, 0) КАК КоличествоДокументов,
		|	ВТ_BoxID.BoxID КАК ОрганизацияЭДО_ID,
		|	ВЫБОР
		|		КОГДА ЯщикиКонтрагентов.Значение ЕСТЬ NULL 
		|			ТОГДА ЛОЖЬ
		|		ИНАЧЕ ИСТИНА
		|	КОНЕЦ КАК Сопоставлен
		|ИЗ
		|	ВТ_BoxID КАК ВТ_BoxID
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК Контрагенты
		|		ПО ВТ_BoxID.ИНН <> Контрагенты.ИНН
		|			И (НЕ Контрагенты.ЭтоГруппа)
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СтатистикаДокументов КАК ВТ_СтатистикаДокументов
		|		ПО ВТ_BoxID.BoxID = ВТ_СтатистикаДокументов.BoxID
		|			И (Контрагенты.Ссылка = ВТ_СтатистикаДокументов.Контрагент)
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ЯщикиКонтрагентов
		|		ПО (Контрагенты.Ссылка = ЯщикиКонтрагентов.Объект)
		|			И (ЯщикиКонтрагентов.Свойство = &ДДКонтр_)");
		
		Запрос.УстановитьПараметр("BoxID"					, BoxID);
		Запрос.УстановитьПараметр("ПериодАнализаДокументов"	, ПериодАнализаДокументов);
		Запрос.УстановитьПараметр("ДДКонтр_"				, ОдинСАдаптер_СвойстваОбъектов_ПолучитьСсылкуНаСвойство("ДДКонтр_"));
		Запрос.УстановитьПараметр("ЯщикДиадокДляОрганизации", ОдинСАдаптер_СвойстваОбъектов_ПолучитьСсылкуНаСвойство("ЯщикДиадокДляОрганизации"));
																   
		Возврат Запрос.Выполнить().Выгрузить();
		
	КонецФункции
	
//} Приглашение Контрагентов

//{ Внешние обработки

	Функция ВнешняяОбработкаПоGUID(GUID) Экспорт
		
		Возврат СсылкаПоGUID(Справочники.ВнешниеОбработки, GUID);
		
	КонецФункции

//} Внешние обработки
