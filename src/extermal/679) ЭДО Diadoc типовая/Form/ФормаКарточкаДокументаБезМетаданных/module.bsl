Перем позТекстОшибкиВерх;
Перем позПанельЭДВерх;
Перем позФормаВысота;
Перем позПенальЭДВысота;

//{ СЛУЖЕБНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ

Процедура ОбновитьФорму()
	ОтобразитьЭлектронныйДокумент();
КонецПроцедуры

Функция ПолучитьПредставлениеFileName(имяФайла)
	
	Если ПустаяСтрока(имяФайла) Тогда
		Возврат "Пустое имя файла";
	Иначе
		Возврат имяФайла;
	КонецЕсли;
	
	//Возврат "" + Врег(Лев(имяФайла,1)) + Нрег(Сред(имяФайла,2,СтрДлина(имяФайла)));
	
	//ПозицияРасширения = 0;
	//ДлинаСтроки = СтрДлина(имяФайла);
	//Для Инд = 1 По ДлинаСтроки Цикл
	//	Если (Сред(имяФайла, ДлинаСтроки - Инд + 1, 1) = ".") Тогда
	//		Прервать;
	//	КонецЕсли;
	//КонецЦикла;
	//
	//Если Инд < ДлинаСтроки Тогда
	//	Возврат Сред(имяФайла, 1, Инд) + нрег(Сред(имяФайла, Инд + 1, ДлинаСтроки - Инд));
	//Иначе
	//	Возврат имяФайла;
	//КонецЕсли;
	
КонецФункции

Процедура ОбновитьЭДОбъект()
	ЭДОбъект = Модуль_РаботаССерверомДиадок.ОбновитьЭДоОбъектДиадока(ЭДОбъект, ЭтаФорма);
КонецПроцедуры

Процедура ОбновитьДействияПоДокументу()
	ПолучитьМодульПрог("Модуль_Логика_ПоведениеФорм").НастроитьКоманднуюПанельКарточкиДокумента(ЭДОбъект, ЭтаФорма);
КонецПроцедуры

Процедура ОбновитьСопоставленныйДокумент()
	//а его и нету
КонецПроцедуры

Процедура ОбновитьВизуализациюДокумента()
	
	ТекстПредставленияЭД = ПолучитьПредставлениеFileName(ЭДОбъект.FileName);
	ЭлементыФормы.СсылкаНаКонтент.Заголовок = ТекстПредставленияЭД;
	
	ЭтаФорма.Заголовок = ТекстПредставленияЭД;
	
	стЭД = Модуль_РаботаССерверомДиадок.ПолучитьСтруктуруПредставленияЭД(ЭДОбъект);
	ЗаполнитьЗначенияСвойств(ЭтаФорма, стЭД);
		
	Комментарий = ЭДОбъект.getComment();

КонецПроцедуры


Процедура ОтобразитьЭлектронныйДокумент()
	
	ОбновитьЭДОбъект();
	ОбновитьДействияПоДокументу();
    ОбновитьВизуализациюДокумента();

КонецПроцедуры

Процедура ОбновитьСтатусЭД()
	ЭДОбъект = Модуль_РаботаССерверомДиадок.ОбновитьЭДоОбъектДиадока(ЭДОбъект, ЭтаФорма);
	ОтобразитьЭлектронныйДокумент();
КонецПроцедуры

Процедура ПриОткрытии()
	
	КартинкаЗаголовка= ЭДО_БиблиотекаКартинок().КартинкаЗаголовка;
	
	ЭлементыФормы.КоманднаяПанель.Кнопки.Диадок.Текст = НаименованиеСистемы;
	ЭлементыФормы.КоманднаяПанель.Кнопки.Диадок.Картинка= ЭДО_БиблиотекаКартинок().КартинкаЗаголовка;
	ЭлементыФормы.КоманднаяПанель.Кнопки.Диадок.Отображение = ?(ИспользоватьИконкуСистемы, ОтображениеКнопкиКоманднойПанели.НадписьКартинка, ОтображениеКнопкиКоманднойПанели.Надпись);
	ЭлементыФормы.КоманднаяПанель.Кнопки.Диадок.кнопки.перейтиВДиадок.текст = "Перейти в "+НаименованиеСистемы;
	ОтобразитьЭлектронныйДокумент();
	
	ОбработкаСобытияПодключаемогоМодуля("ПриОткрытииФормы", Новый Структура("Форма, ИмяФормы", ЭтаФорма, "ФормаКарточкаДокументаБезМетаданных"));
	
КонецПроцедуры

//} СЛУЖЕБНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ
	
//{ ДЕЙСТВИЯ ФОРМЫ

Процедура ВыполнитьДействиеНадДокументом(ИдентификаторДействия, СписокОперацийПослеОбработки)
	 Попытка 
		 Если  ПолучитьМодульПрог("Модуль_Логика_ПоведениеФорм").ВыполнитьДействиеНадДокументом(ЭДОбъект, ИдентификаторДействия, ЭтаФорма.Заголовок)=Истина Тогда 
			Если СписокОперацийПослеОбработки.свойство("ОбновитьЭДОбъект")=Истина Тогда  
				ОбновитьЭДОбъект();
			КонецЕсли;	
			Если СписокОперацийПослеОбработки.свойство("ОбновитьДействияПоДокументу")=Истина Тогда  
				ОбновитьДействияПоДокументу();
			КонецЕсли;	
			Если СписокОперацийПослеОбработки.свойство("ОбновитьВизуализациюДокумента")=Истина Тогда  
				ОбновитьВизуализациюДокумента();
			КонецЕсли;
			Если СписокОперацийПослеОбработки.свойство("ОбновитьСопоставленныйДокумент")=Истина Тогда  
				ОбновитьСопоставленныйДокумент();
			КонецЕсли;
		КонецЕсли
	Исключение 
		ПолучитьМодульПрог("Модуль_Логика_ПоведениеФорм").СообщениеОбОшибкеДиадок(ОписаниеОшибки(), ИдентификаторДействия);
	КонецПопытки;
КонецПроцедуры	

Процедура АннулироватьДокумент()
	ВыполнитьДействиеНадДокументом("АннулироватьДокумент", Новый Структура("ОбновитьЭДОбъект, ОбновитьДействияПоДокументу", Истина, Истина));
КонецПроцедуры

Процедура ОтказатьВАннулировании()
	ВыполнитьДействиеНадДокументом("ОтказатьВАннулировании", Новый Структура("ОбновитьЭДОбъект, ОбновитьДействияПоДокументу", Истина, Истина));
КонецПроцедуры

Процедура ОтправитьЗапросНаАннулирование()
	ВыполнитьДействиеНадДокументом("ОтправитьЗапросНаАннулирование", Новый Структура("ОбновитьЭДОбъект, ОбновитьДействияПоДокументу", Истина, Истина));
КонецПроцедуры

Процедура ПодписатьДокумент()
	ВыполнитьДействиеНадДокументом("ПодписатьДокумент", Новый Структура("ОбновитьЭДОбъект, ОбновитьДействияПоДокументу, ОбновитьВизуализациюДокумента", Истина, Истина, Истина));
КонецПроцедуры

Процедура ПодписатьЗапрошенныйДокумент()		
	ВыполнитьДействиеНадДокументом("ПодписатьЗапрошенныйДокумент", Новый Структура("ОбновитьЭДОбъект, ОбновитьДействияПоДокументу, ОбновитьВизуализациюДокумента", Истина, Истина, Истина));		
КонецПроцедуры

Процедура ОтказатьВПодписи()
	ВыполнитьДействиеНадДокументом("ОтказатьВПодписи", Новый Структура("ОбновитьЭДОбъект, ОбновитьДействияПоДокументу, ОбновитьВизуализациюДокумента", Истина, Истина, Истина));
КонецПроцедуры 


Функция ПолучитьРасширениеФайлаДиадок(ИмяФайла)
	КолСим = СтрДлина(ИмяФайла);
	Для ИндЦикла = 1 По КолСим Цикл
		Инд = КолСим + 1 - ИндЦикла;
		Если Сред(ИмяФайла, Инд, 1) = "." Тогда
			Возврат ?(КолСим = Инд, 0, Сред(ИмяФайла, Инд + 1, КолСим - Инд));
		КонецЕсли;
	КонецЦикла;
КонецФункции

Процедура СсылкаНаКонтентНажатие(Элемент)
	ПолучитьМодульПрог("Модуль_Логика_ПоведениеФорм").ОткрытьФормуНеформализованногоДокумента(ЭДОбъект);
КонецПроцедуры

Процедура ИзменитьПодразделениеНажатие(Элемент)
	ВыполнитьДействиеНадДокументом("ИзменитьПодразделение", Новый Структура("ОбновитьЭДОбъект, ОбновитьДействияПоДокументу", Истина, Истина));
КонецПроцедуры

Процедура КоманднаяПанельУдалитьДокумент(Кнопка)
	
	Если ПолучитьМодульПрог("Модуль_Логика_ПоведениеФорм").ДействиеСЗалоченнымПакетомЗапрещено(ЭДОбъект,  "УдалитьДокумент") Тогда
		Возврат;
	КонецЕсли;
	
	ПолучитьФорму("ФормаУдаленияДокументов", ЭтаФорма).УдалениеДокументовКомплекта(ЭДОбъект);
	
КонецПроцедуры

Процедура КоманднаяПанельПеревыставитьДокумент(Кнопка)
	
	Если ПолучитьМодульПрог("Модуль_Логика_ПоведениеФорм").ДействиеСЗалоченнымПакетомЗапрещено(ЭДОбъект,  "ПеревыставитьДокумент") Тогда
		Возврат;
	КонецЕсли;
	
	ПолучитьФорму("ФормаПеревыставленияДокументов", ЭтаФорма).ПеревыставлениеДокументовКомплекта(ЭДОбъект);	
	
КонецПроцедуры

Процедура ПередатьНаСогласование()
	
	Если ПолучитьМодульПрог("Модуль_Логика_ПоведениеФорм").ДействиеСЗалоченнымПакетомЗапрещено(ЭДОбъект,  "ПередатьНаСогласование") Тогда
		Возврат;
	КонецЕсли;
	
	Если Модуль_РаботаССерверомДиадок.ОтправитьЭДОбъектНаСогласование(Организация, ЭДОбъект, "ApprovementRequest", "ПередачаНаОбработку") Тогда
		ОтобразитьЭлектронныйДокумент();
	КонецЕсли;
	
КонецПроцедуры

Процедура ПередатьНаПодпись()
	
	Если ПолучитьМодульПрог("Модуль_Логика_ПоведениеФорм").ДействиеСЗалоченнымПакетомЗапрещено(ЭДОбъект,  "ПередатьНаПодпись") Тогда
		Возврат;
	КонецЕсли;
	
	Если Модуль_РаботаССерверомДиадок.ОтправитьЭДОбъектНаСогласование(Организация, ЭДОбъект, "SignatureRequest", "ПередачаНаОбработку") Тогда
		ОтобразитьЭлектронныйДокумент();
	КонецЕсли;
	
КонецПроцедуры

Процедура СогласоватьДокумент()
	ВыполнитьДействиеНадДокументом("СогласоватьДокумент", Новый Структура("ОбновитьЭДОбъект, ОбновитьДействияПоДокументу", Истина, Истина));
КонецПроцедуры

Процедура ОтказатьВСогласовании()
	ВыполнитьДействиеНадДокументом("ОтказатьВСогласовании", Новый Структура("ОбновитьЭДОбъект, ОбновитьДействияПоДокументу", Истина, Истина));
КонецПроцедуры

Процедура СогласованиеПодробноНажатие(Элемент)
	ПолучитьМодульПрог("Модуль_Логика_ПоведениеФорм").СогласованиеПодробноНажатие(ЭДОбъект,Организация )
КонецПроцедуры

Процедура КоманднаяПанельОтменитьСопоставлениеДокумент(Кнопка)
	Если ПолучитьМодульПрог("Модуль_Логика_ПоведениеФорм").КоманднаяПанельОтменитьСопоставлениеДокумент(СсылкаНаОбъект, ЭДОбъект) = Истина Тогда 
		СсылкаНаОбъект = Неопределено;
		ОбновитьСопоставленныйДокумент();    
	КонецЕсли;
КонецПроцедуры

Процедура КоманднаяПанель1ПерейтиВДиадок(Кнопка)
	Модуль_РаботаССерверомДиадок.ПоказатьДокументВДиадоке(ЭДОбъект)
КонецПроцедуры

Процедура КоманднаяПанель1СтруктураПодчиненности(Кнопка)
	ПолучитьФорму("ФормаСвязейДокументов", ЭтаФорма).ПоказСтруктурыПодчиненности(ЭДОбъект);
КонецПроцедуры

Процедура КоманднаяПанельОтправитьФайл(Кнопка)
	ПолучитьФорму("ФормаВыгрузки",ЭтаФорма).ПрикрепитьФайлы(ЭДОбъект);					
КонецПроцедуры

Процедура ПодключаемаяКоманда(Кнопка)
			
	ОбработкаСобытияПодключаемогоМодуля("ПодключаемаяКоманда", Новый Структура("Форма, ИмяФормы, Кнопка", ЭтаФорма, "ФормаКарточкаДокументаБезМетаданных", Кнопка));
	
КонецПроцедуры

//} ДЕЙСТВИЯ ФОРМЫ

Процедура ОбработкаОповещения(ИмяСобытия, Параметр, Источник)
	Если ИмяСобытия = "ИзменениеСертификата" Тогда 
		ЭтаФорма.Закрыть();
	ИначеЕсли ИмяСобытия = "УдалениеДокументов" Тогда 
		Если Параметр.Количество() <> 0 Тогда
			Для Каждого Элем Из Параметр Цикл
				Если ЭДОбъект.DocumentId = Элем.DocumentId Тогда
					ЭтаФорма.Закрыть();
				КонецЕсли;
			КонецЦикла;;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

