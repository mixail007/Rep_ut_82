
Процедура ПередОткрытием(Отказ, СтандартнаяОбработка)
КонецПроцедуры

Процедура ПриЗакрытии()
КонецПроцедуры

Процедура ДействияФормыОтчетСформировать(Кнопка)
	//{{КОНСТРУКТОР_ВЫХОДНЫХ_ФОРМ_ПРОЦЕДУРА_ВЫЗОВА(Отчет)
	// Данный фрагмент построен конструктором.
	// При повторном использовании конструктора, внесенные вручную изменения будут утеряны!!!

	ТабДок = ЭлементыФормы.ПолеТабличногоДокумента;
	Отчет(ТабДок);

	//}}КОНСТРУКТОР_ВЫХОДНЫХ_ФОРМ_ПРОЦЕДУРА_ВЫЗОВА
КонецПроцедуры

Процедура Отчет(ТабДок) Экспорт
	//{{КОНСТРУКТОР_ВЫХОДНЫХ_ФОРМ(Отчет)
	// Данный фрагмент построен конструктором.
	// При повторном использовании конструктора, внесенные вручную изменения будут утеряны!!!

	Макет = ВнешняяОбработкаОбъект.ПолучитьМакет("Отчет");
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	Запрос.Ссылка,
	|	Запрос.Номенклатура,
	|	Запрос.Количество,
	|	Запрос.СтоимостьЕдиницы,
	|	Запрос.Сумма,
	|	Запрос.ДокументПартии КАК ДокументПартии,
	|	Запрос.НоменклатураПартии,
	|	Запрос.КоличествоПартии,
	|	Запрос.СтоимостьЕдиницыПартии,
	|	Запрос.СуммаПартии
	|ИЗ
	|	(ВЫБРАТЬ
	|		ОсновнойЗапрос.Ссылка КАК Ссылка,
	|		ОсновнойЗапрос.Номенклатура КАК Номенклатура,
	|		СУММА(ОсновнойЗапрос.Количество) КАК Количество,
	|		СУММА(ОсновнойЗапрос.СтоимостьЕдиницы) КАК СтоимостьЕдиницы,
	|		СУММА(ОсновнойЗапрос.Сумма) КАК Сумма,
	|		ОсновнойЗапрос.ДокументПартии КАК ДокументПартии,
	|		ОсновнойЗапрос.НоменклатураПартии КАК НоменклатураПартии,
	|		СУММА(ОсновнойЗапрос.КоличествоПартии) КАК КоличествоПартии,
	|		СУММА(ОсновнойЗапрос.СтоимостьЕдиницыПартии) КАК СтоимостьЕдиницыПартии,
	|		СУММА(ОсновнойЗапрос.СуммаПартии) КАК СуммаПартии
	|	ИЗ
	|		(ВЫБРАТЬ
	|			ПоступлениеДопРасходовТовары.Ссылка КАК Ссылка,
	|			ПоступлениеДопРасходовТовары.ДокументПартии КАК ДокументПартии,
	|			ПоступлениеДопРасходовТовары.СуммаТовара КАК Сумма,
	|			ПоступлениеДопРасходовТовары.Количество КАК Количество,
	|			ПоступлениеДопРасходовТовары.Номенклатура КАК Номенклатура,
	|			ВЫРАЗИТЬ(ПоступлениеДопРасходовТовары.СуммаТовара / ПоступлениеДопРасходовТовары.Количество КАК ЧИСЛО(15, 2)) КАК СтоимостьЕдиницы,
	|			ЕСТЬNULL(ПоступлениеТоваровУслуг.Количество, 0) КАК КоличествоПартии,
	|			ЕСТЬNULL(ПоступлениеТоваровУслуг.Цена, 0) КАК СтоимостьЕдиницыПартии,
	|			ЕСТЬNULL(ПоступлениеТоваровУслуг.Сумма, 0) КАК СуммаПартии,
	|			ЕСТЬNULL(ПоступлениеТоваровУслуг.Номенклатура, ""Отсутствует в партии"") КАК НоменклатураПартии
	|		ИЗ
	|			Документ.ПоступлениеДопРасходов.Товары КАК ПоступлениеДопРасходовТовары
	|				ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|					ПоступлениеТоваровУслуг.Ссылка КАК Ссылка,
	|					ПоступлениеТоваровУслуг.Количество КАК Количество,
	|					ПоступлениеТоваровУслуг.Цена КАК Цена,
	|					ПоступлениеТоваровУслуг.Сумма КАК Сумма,
	|					ПоступлениеТоваровУслуг.Номенклатура КАК Номенклатура
	|				ИЗ
	|					Документ.ПоступлениеТоваровУслуг.Товары КАК ПоступлениеТоваровУслуг) КАК ПоступлениеТоваровУслуг
	|				ПО ПоступлениеДопРасходовТовары.ДокументПартии = ПоступлениеТоваровУслуг.Ссылка
	|					И ПоступлениеДопРасходовТовары.Номенклатура = ПоступлениеТоваровУслуг.Номенклатура
	|		ГДЕ
	|			ПоступлениеДопРасходовТовары.ДокументПартии ССЫЛКА Документ.ПоступлениеТоваровУслуг) КАК ОсновнойЗапрос
	|	
	|	СГРУППИРОВАТЬ ПО
	|		ОсновнойЗапрос.Ссылка,
	|		ОсновнойЗапрос.Номенклатура,
	|		ОсновнойЗапрос.ДокументПартии,
	|		ОсновнойЗапрос.НоменклатураПартии) КАК Запрос
	|ГДЕ
	|	(Запрос.СтоимостьЕдиницыПартии <> Запрос.СтоимостьЕдиницы
	|			ИЛИ Запрос.КоличествоПартии <> Запрос.Количество)
	|ИТОГИ ПО
	|	ДокументПартии";

	Результат = Запрос.Выполнить();

	ОбластьЗаголовок = Макет.ПолучитьОбласть("Заголовок");
	ОбластьПодвал = Макет.ПолучитьОбласть("Подвал");
	ОбластьШапкаТаблицы = Макет.ПолучитьОбласть("ШапкаТаблицы");
	ОбластьПодвалТаблицы = Макет.ПолучитьОбласть("ПодвалТаблицы");
	ОбластьДокументПартии = Макет.ПолучитьОбласть("ДокументПартии");
	ОбластьДетальныхЗаписей = Макет.ПолучитьОбласть("Детали");

	ТабДок.Очистить();
	ТабДок.Вывести(ОбластьЗаголовок);
	ТабДок.Вывести(ОбластьШапкаТаблицы);
	ТабДок.НачатьАвтогруппировкуСтрок();

	ВыборкаДокументПартии = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);

	Пока ВыборкаДокументПартии.Следующий() Цикл
		ОбластьДокументПартии.Параметры.Заполнить(ВыборкаДокументПартии);
		ТабДок.Вывести(ОбластьДокументПартии, ВыборкаДокументПартии.Уровень());

		ВыборкаДетали = ВыборкаДокументПартии.Выбрать();

		Пока ВыборкаДетали.Следующий() Цикл
			ОбластьДетальныхЗаписей.Параметры.Заполнить(ВыборкаДетали);
			ТабДок.Вывести(ОбластьДетальныхЗаписей, ВыборкаДетали.Уровень());
		КонецЦикла;
	КонецЦикла;

	ТабДок.ЗакончитьАвтогруппировкуСтрок();
	ТабДок.Вывести(ОбластьПодвалТаблицы);
	ТабДок.Вывести(ОбластьПодвал);

	//}}КОНСТРУКТОР_ВЫХОДНЫХ_ФОРМ
КонецПроцедуры




