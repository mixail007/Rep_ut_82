
Процедура ДействияФормыОтчетСформировать(Кнопка)

	ТабДок = ЭлементыФормы.ПолеТабличногоДокумента;
	Отчет(ТабДок);


КонецПроцедуры

Процедура Отчет(ТабДок) Экспорт

	Макет = ПолучитьМакет("Отчет");
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	КомплектующиеНоменклатуры.Комплектующая.Код КАК Код,
	|	КомплектующиеНоменклатуры.Комплектующая КАК Комплектующая,
	|	РеализацияТоваровУслугТовары.Номенклатура КАК Номенклатура,
	|	РеализацияТоваровУслугТовары.Количество КАК Количество
	|ИЗ
	|	(ВЫБРАТЬ
	|		РеализацияТоваровУслугТовары.Номенклатура КАК Номенклатура,
	|		СУММА(РеализацияТоваровУслугТовары.Количество) КАК Количество
	|	ИЗ
	|		Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
	|	ГДЕ
	|		РеализацияТоваровУслугТовары.Ссылка В(&ТекущийДокумент)
	|		И РеализацияТоваровУслугТовары.Номенклатура.ВидТовара = ЗНАЧЕНИЕ(Перечисление.ВидыТоваров.Диски)
	|	
	|	СГРУППИРОВАТЬ ПО
	|		РеализацияТоваровУслугТовары.Номенклатура) КАК РеализацияТоваровУслугТовары
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КомплектующиеНоменклатуры КАК КомплектующиеНоменклатуры
	|		ПО РеализацияТоваровУслугТовары.Номенклатура = КомплектующиеНоменклатуры.Номенклатура
	|ГДЕ
	|	КомплектующиеНоменклатуры.Комплектующая В ИЕРАРХИИ(&Крышки)
	|
	|УПОРЯДОЧИТЬ ПО
	|	Комплектующая
	|ИТОГИ
	|	СУММА(Количество)
	|ПО
	|	ОБЩИЕ,
	|	Комплектующая";

	Запрос.УстановитьПараметр("Крышки", Справочники.Номенклатура.НайтиПоКоду("0080004"));
	Запрос.УстановитьПараметр("ТекущийДокумент", ТабличноеПолеРеализации.ВыгрузитьКолонку("Реализация"));

	Результат = Запрос.Выполнить();

	ОбластьЗаголовок = Макет.ПолучитьОбласть("Заголовок");
	ОбластьПодвал = Макет.ПолучитьОбласть("Подвал");
	ОбластьШапкаТаблицы = Макет.ПолучитьОбласть("ШапкаТаблицы");
	ОбластьПодвалТаблицы = Макет.ПолучитьОбласть("ПодвалТаблицы");
	ОбластьОбщийИтог = Макет.ПолучитьОбласть("ОбщиеИтоги");
	ОбластьКомплектующая = Макет.ПолучитьОбласть("Комплектующая");
	ОбластьДетальныхЗаписей = Макет.ПолучитьОбласть("Детали");

	НомераРеализаций="";
	
	
	Для сч=0 по ТабличноеПолеРеализации.Количество()-1 Цикл
		
		НомераРеализаций=НомераРеализаций+ТабличноеПолеРеализации[сч].Реализация.Номер ;
		
	КонецЦикла;
	ОбластьЗаголовок.Параметры.НомераРеализаций=НомераРеализаций;
	
	ТабДок.Очистить();
	ТабДок.Вывести(ОбластьЗаголовок);
	ТабДок.Вывести(ОбластьШапкаТаблицы);
	ТабДок.НачатьАвтогруппировкуСтрок();

	ВыборкаОбщийИтог = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);

	ВыборкаОбщийИтог.Следующий();		
	ОбластьОбщийИтог.Параметры.Заполнить(ВыборкаОбщийИтог);
	ТабДок.Вывести(ОбластьОбщийИтог, ВыборкаОбщийИтог.Уровень());

	ВыборкаКомплектующая = ВыборкаОбщийИтог.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);

	Пока ВыборкаКомплектующая.Следующий() Цикл
		ОбластьКомплектующая.Параметры.Заполнить(ВыборкаКомплектующая);
		ТабДок.Вывести(ОбластьКомплектующая, ВыборкаКомплектующая.Уровень());

		ВыборкаДетали = ВыборкаКомплектующая.Выбрать();

		Пока ВыборкаДетали.Следующий() Цикл
			ОбластьДетальныхЗаписей.Параметры.Заполнить(ВыборкаДетали);
			ОбластьДетальныхЗаписей.Параметры.Код=ВыборкаДетали.Номенклатура.Код;
			ТабДок.Вывести(ОбластьДетальныхЗаписей, ВыборкаДетали.Уровень());
			
		КонецЦикла;
	КонецЦикла;

	ТабДок.ЗакончитьАвтогруппировкуСтрок();
	ТабДок.Вывести(ОбластьПодвалТаблицы);
	ТабДок.Вывести(ОбластьПодвал);

	
КонецПроцедуры

Процедура КоманднаяПанель1Действие9(Кнопка)
ФормаВыбора=Документы.РеализацияТоваровУслуг.ПолучитьФормуВыбора(,ЭтаФОрма);	
ФормаВыбора.РежимВыбора=Истина;
ФормаВыбора.МножественныйВыбор=Истина;
ФормаВыбора.ЗакрыватьПриВыборе=Ложь;
ФормаВыбора.Открыть();
КонецПроцедуры


Процедура ОбработкаВыбора(ЗначениеВыбора, Источник)
	
	Если ТипЗнч(ЗначениеВыбора)= Тип("Массив") Тогда
		Для сч=0 по ЗначениеВыбора.Количество()-1 Цикл
			строка=ТабличноеПолеРеализации.Добавить();
			строка.Реализация= ЗначениеВыбора[сч];
		КонецЦикла;
	КонецЕсли;
КонецПроцедуры

