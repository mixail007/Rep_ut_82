// функции для совместимости кода 
&НаКлиенте
Функция сбисПолучитьФорму(ИмяФормы)
	Если ТипЗнч(ЭтаФорма) = Тип("УправляемаяФорма") Тогда
		Попытка
			ЭтотОбъект="";
		Исключение
		КонецПопытки;
		Возврат ПолучитьФорму("ВнешняяОбработка.СБИС.Форма."+ИмяФормы);
	КонецЕсли;
	Возврат ЭтотОбъект.ПолучитьФорму(ИмяФормы);
КонецФункции

&НаКлиенте
Функция ПрочитатьДокумент(Кэш,Контекст) Экспорт
// Функция формирует пакеты документов по файлу настроек
// Особенность документа в том, что по одному документу формируется несколько пакетов
	ОказаниеУслугДокумент = Контекст.Документ;
	Контекст.Вставить("ФайлДанные", Новый Структура);
	ЧтоНибудьВыгрузилось = Ложь;
	СчетФактуры = Новый Массив;
	// перебираем мФайлы из файла настроек
	Для Каждого Файл Из Контекст.ДокументДанные.мФайл Цикл
		Файл = Файл.Значение;
		Контекст.ФайлДанные = Файл;
		Стр = 0;
		Для каждого ВидДокумента из Контекст.ФайлДанные.мДокумент Цикл
			ВидДокумента = ВидДокумента.Значение;
			// перебираем табличну часть, по каждой строке формируется отдельный пакет документов
			Для СчСтр = 1 по ВидДокумента.Количество() Цикл
				Контекст.Вставить("Документ", ОказаниеУслугДокумент);
				Контекст.Вставить("СоставПакета",Новый Структура);
				Кэш.КэшЗначенийИни.ТекущийПакет.Очистить();
				Контекст.СоставПакета.Вставить("Вложение",Новый Массив);
				Контекст.ФайлДанные = ВидДокумента[СчСтр-1];
				Файл_Формат = Кэш.ОбщиеФункции.РассчитатьЗначение("Файл_Формат", ВидДокумента[СчСтр-1]);
				Файл_ВерсияФормата = СтрЗаменить(СтрЗаменить(ВидДокумента[СчСтр-1].Файл_ВерсияФормата,".","_"), " ", "");
				//Подготовим контекст
				мТаблДок = Новый Структура; //В мТаблДок скопируем структуру для табличной части из корня контекста
				Кэш.ОбщиеФункции.сбисСкопироватьСтруктуру(мТаблДок, ВидДокумента[СчСтр-1].мТаблДок.Услуги);
				МассивСтрок = Новый Массив;
				МассивСтрок.Добавить(мТаблДок);
				Контекст.ФайлДанные.Вставить("мТаблДок", Новый Структура("Услуги", МассивСтрок));
				
				Документ = ВидДокумента[СчСтр-1];
				Документ_Номер = Кэш.ОбщиеФункции.РассчитатьЗначение("Документ_Номер", ВидДокумента[СчСтр-1]);
				Документ.Документ_Номер = СокрЛП(Документ_Номер) + "/" + СчСтр; //Присвоим номер с дробной частью
				//В корень контекста скопируем структуру для шапки документа
				Кэш.ОбщиеФункции.сбисСкопироватьСтруктуру(Контекст.ФайлДанные, Документ);
				
				фрм = сбисПолучитьФорму("ФормаГлавноеОкно").сбисНайтиФормуФункции("ПолучитьДанныеИзДокумента1С","Файл_"+Файл_Формат+"_"+Файл_ВерсияФормата,"Файл_Шаблон",Кэш);
				Если фрм.ПолучитьДанныеИзДокумента1С(Кэш,Контекст) Тогда //если хотябы что-то не выгрузилось - отбой
					Если Документ.Свойство("СчетФактура") и ЗначениеЗаполнено(Документ.СчетФактура) Тогда
						ИмяДокумента = Кэш.ОбщиеФункции.ПолучитьРеквизитМетаданныхОбъекта(Документ.СчетФактура, "Имя");
						Если Кэш.ини.Свойство(ИмяДокумента) Тогда
							Контекст.Вставить("Документ", Документ.СчетФактура);
							Кэш.ини[ИмяДокумента].Вставить("Формат2016", Новый Структура("Значение,РассчитанноеЗначение", Кэш.Парам.Формат2016, Кэш.Парам.Формат2016));
							Контекст.Вставить("ДокументДанные", Кэш.ОбщиеФункции.ПолучитьДанныеДокумента1С(Кэш.ини[ИмяДокумента], Документ.СчетФактура,Кэш.КэшЗначенийИни));
							Для Каждого Файл Из Контекст.ДокументДанные.мФайл Цикл
								Файл = Файл.Значение;
								Контекст.ФайлДанные = Файл;
								Файл.Файл_Формат = Кэш.ОбщиеФункции.РассчитатьЗначение("Файл_Формат", Файл, Кэш);
								Файл_Формат = Файл.Файл_Формат;
								Файл_ВерсияФормата = СтрЗаменить(СтрЗаменить(Файл.Файл_ВерсияФормата,".","_"), " ", "");
								// в табличную часть СФ копируем табличную часть сформированного по строке документа акта
								СтруктураТаблДок = Новый Структура;
								Кэш.ОбщиеФункции.сбисСкопироватьСтруктуру(СтруктураТаблДок, Контекст.СоставПакета.Вложение[0].СтруктураДокумента.Файл.Документ.ТаблДок);
								Контекст.Вставить("ТаблДок",СтруктураТаблДок);
								фрм = сбисПолучитьФорму("ФормаГлавноеОкно").сбисНайтиФормуФункции("ПолучитьШапкуИзДокумента1С","Файл_"+Файл_Формат+"_"+Файл_ВерсияФормата,"Файл_Шаблон",Кэш);			
								Если Не фрм.ПолучитьШапкуИзДокумента1С(Кэш,Контекст) Тогда //если хотябы что-то не выгрузилось - отбой
									ВсеВыгрузилось = Ложь;
								КонецЕсли;
							КонецЦикла;
							
						КонецЕсли;
					КонецЕсли;
					ИмяДокумента = Кэш.ОбщиеФункции.ПолучитьРеквизитМетаданныхОбъекта(Контекст.Документ, "Имя");
					Контекст.СоставПакета.Вставить("ПользовательскийИдентификатор", ИмяДокумента+":"+строка(Контекст.Документ.УникальныйИдентификатор())+"_"+строка(СчСтр));
					Контекст.МассивПакетов.Добавить(Контекст.СоставПакета);
					ЧтоНибудьВыгрузилось = Истина;
				КонецЕсли;
			КонецЦикла;	
		КонецЦикла;				
	КонецЦикла;
	Возврат ЧтоНибудьВыгрузилось;
КонецФункции
&НаКлиенте
Функция ПрочитатьТабличнуюЧасть(Кэш,Контекст) Экспорт
// Функция формирует табличную часть документа	
	ИмяДокумента = Кэш.ОбщиеФункции.ПолучитьРеквизитМетаданныхОбъекта(Контекст.Документ, "Имя");
	ВсеВыгрузилось = Истина;
	Если Кэш.ини.Свойство(ИмяДокумента) Тогда
		Для Каждого Файл Из Контекст.ДокументДанные.мФайл Цикл
			Файл = Файл.Значение;
			Контекст.ФайлДанные = Файл;
			Стр = 0;
			Для каждого ВидДокумента из Контекст.ФайлДанные.мДокумент Цикл
				ВидДокумента = ВидДокумента.Значение;
				Для СчСтр = 1 по ВидДокумента.Количество() Цикл
					Если ВидДокумента[СчСтр-1].СчетФактура = Контекст.СФ Тогда
						Контекст.Вставить("СоставПакета",Новый Структура);
						Кэш.КэшЗначенийИни.ТекущийПакет.Очистить();
						Контекст.СоставПакета.Вставить("Вложение",Новый Массив);
						Контекст.ФайлДанные = ВидДокумента[СчСтр-1];
						Файл_Формат = Кэш.ОбщиеФункции.РассчитатьЗначение("Файл_Формат", ВидДокумента[СчСтр-1]);
						Файл_ВерсияФормата = СтрЗаменить(СтрЗаменить(ВидДокумента[СчСтр-1].Файл_ВерсияФормата,".","_"), " ", "");
						мТаблДок = Новый Структура; //В мТаблДок скопируем структуру для табличной части из корня контекста
						сбисПолучитьФорму("РаботаСДокументами1С").сбисСкопироватьСтруктуру(мТаблДок, ВидДокумента[СчСтр-1].мТаблДок.Услуги);
						МассивСтрок = Новый Массив;
						МассивСтрок.Добавить(мТаблДок);
						Контекст.ФайлДанные.Вставить("мТаблДок", Новый Структура("Услуги", МассивСтрок));

						фрм = сбисПолучитьФорму("ФормаГлавноеОкно").сбисНайтиФормуФункции("ПолучитьТабличнуюЧастьДокумента1С","Файл_"+Файл_Формат+"_"+Файл_ВерсияФормата,"Файл_Шаблон",Кэш);			
						фрм.ПолучитьТабличнуюЧастьДокумента1С(Кэш,Контекст)
            		КонецЕсли;
			    КонецЦикла;
			КонецЦикла;
		КонецЦикла;
	Иначе
		Сообщить("Не найдены настройки для документа: "+ИмяДокумента);
		ВсеВыгрузилось = Ложь;
	КонецЕсли;
	Возврат ВсеВыгрузилось;
КонецФункции