Процедура ЗаполнитьНачальныеНастройки() Экспорт
	
	ПостроительОтчета = ОбщийОтчет.ПостроительОтчета;
	
	СтруктураПредставлениеПолей = Новый Структура;
	МассивОтбора = Новый Массив;
	//ЗаполнитьНачальныеНастройкиПоМакету(ПолучитьМакет("ПараметрыОтчетовПродажиКомпании"), СтруктураПредставлениеПолей, МассивОтбора, ОбщийОтчет, "СписокКроссТаблица");
	ТексЗапросаБонусы =  ПолучитьБонусы(ложь).ТекстЗапросаБонусы;
	Текст = ТексЗапросаБонусы+ "
	|;"+	"ВЫБРАТЬ
			|	ИнформацияПоПроезду.Заказ,
			|	СУММА(ИнформацияПоПроезду.ДоставкаВЦене) КАК ДоставкаВЦене,
			|	ИнформацияПоПроезду.Номенклатура,
			|	ИнформацияПоПроезду.Реализация,
			|	ИнформацияПоПроезду.Задание
			|ПОМЕСТИТЬ Транспорт
			|ИЗ
			|	РегистрСведений.ИнформацияПоПроезду КАК ИнформацияПоПроезду
			|ГДЕ
			|	ИнформацияПоПроезду.Реализация <> НЕОПРЕДЕЛЕНО
			|	И ИнформацияПоПроезду.Реализация.Дата МЕЖДУ &ДатаНач И &ДатаКон
			|
			|СГРУППИРОВАТЬ ПО
			|	ИнформацияПоПроезду.Заказ,
			|	ИнформацияПоПроезду.Номенклатура,
			|	ИнформацияПоПроезду.Реализация,
			|	ИнформацияПоПроезду.Задание
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	ПродажиОбороты.Номенклатура,
			|	ПродажиОбороты.Период
			|ПОМЕСТИТЬ втПродажи
			|ИЗ
			|	РегистрНакопления.Продажи.Обороты(&ДатаНач, &ДатаКон, Регистратор, ) КАК ПродажиОбороты
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	А.ПериодРеализации,
			|	А.Номенклатура,
			|	втБонусы.Бонус
			|ПОМЕСТИТЬ втБонусыПоНоменклатуре
			|ИЗ
			|	(ВЫБРАТЬ
			|		втПродажи.Период КАК ПериодРеализации,
			|		втПродажи.Номенклатура КАК Номенклатура,
			|		МАКСИМУМ(втБонусы.Период) КАК ПериодБонуса
			|	ИЗ
			|		втПродажи КАК втПродажи
			|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ втБонусы КАК втБонусы
			|			ПО втПродажи.Номенклатура = втБонусы.Номенклатура
			|				И втПродажи.Период >= втБонусы.Период
			|	
			|	СГРУППИРОВАТЬ ПО
			|		втПродажи.Период,
			|		втПродажи.Номенклатура) КАК А
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ втБонусы КАК втБонусы
			|		ПО А.Номенклатура = втБонусы.Номенклатура
			|			И А.ПериодБонуса = втБонусы.Период
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	СУММА(ТаблицаРегистра.КоличествоОборот) КАК Количество,
		//	|	СУММА(ТаблицаРегистра.КоличествоОборот * ТаблицаРегистра.Номенклатура.ЕдиницаХраненияОстатков.Коэффициент) КАК КоличествоБазовыхЕд,
			|	СУММА(ТаблицаРегистра.СтоимостьОборот) КАК Стоимость,
			//|	СУММА(ВЫБОР
			//|			КОГДА ТаблицаРегистра.КоличествоОборот = 0
			//|				ТОГДА ТаблицаРегистра.СтоимостьОборот
			//|			ИНАЧЕ ТаблицаРегистра.СтоимостьОборот / ТаблицаРегистра.КоличествоОборот
			//|		КОНЕЦ) КАК СтоимостьЕдиницы,
			|	СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот) КАК Себестоимость,
			//|	СУММА(ВЫБОР
			//|			КОГДА ТаблицаРегистра.КоличествоОборот <> 0
			//|				ТОГДА ЕСТЬNULL(ТаблицаРегистраСебестоимость.СтоимостьОборот, 0) / ТаблицаРегистра.КоличествоОборот
			//|			ИНАЧЕ ЕСТЬNULL(ТаблицаРегистраСебестоимость.СтоимостьОборот, 0)
			//|		КОНЕЦ) КАК СебестоимостьЕдиницы,
			|	ВЫБОР
			|		КОГДА СУММА(ТаблицаРегистра.СтоимостьОборот) ЕСТЬ NULL 
			|			ТОГДА 0
			|		ИНАЧЕ СУММА(ТаблицаРегистра.СтоимостьОборот)
			|	КОНЕЦ - ВЫБОР
			|		КОГДА СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот) ЕСТЬ NULL 
			|			ТОГДА 0
			|		ИНАЧЕ СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот)
			|	КОНЕЦ КАК ВаловаяПрибыль,
			//|	ВЫРАЗИТЬ(ВЫБОР
			//|			КОГДА СУММА(ТаблицаРегистра.СтоимостьОборот) <> 0
			//|				ТОГДА 100 * (СУММА(ТаблицаРегистра.СтоимостьОборот) - СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот)) / СУММА(ТаблицаРегистра.СтоимостьОборот)
			//|			ИНАЧЕ 0
			//|		КОНЕЦ КАК ЧИСЛО(15, 2)) КАК РентабельностьПродаж,
			//+++ 04.10.2018 - вместо Рентабельности - ВаловаяПрибыльНДС
			|	СУММА(ТаблицаРегистра.СтоимостьОборот) - СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот)*&КоэфНДС как ВаловаяПрибыльНДС,

			|	ВЫРАЗИТЬ(ВЫБОР
			|			КОГДА СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот) <> 0
			|				ТОГДА 100 * (СУММА(ТаблицаРегистра.СтоимостьОборот) - СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот)) / СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот)
			|			ИНАЧЕ 0
			|		КОНЕЦ КАК ЧИСЛО(15, 2)) КАК ПроцентНаценки,
			|	ТаблицаРегистра.ДоговорКонтрагента.Владелец КАК Покупатель,
			|	ТаблицаРегистра.Номенклатура КАК Номенклатура,
			//|	ТаблицаРегистра.Номенклатура.БазоваяЕдиницаИзмерения КАК НоменклатураБазоваяЕдиницаИзмерения,
			|	ТаблицаРегистра.Номенклатура.НоменклатурнаяГруппа КАК НоменклатурнаяГруппа,
			|	СУММА(ЕСТЬNULL(Транспорт.ДоставкаВЦене, 0)) КАК ДоставкаВЦене,
			//|	ВЫБОР
			//|		КОГДА СУММА(ТаблицаРегистра.СтоимостьОборот) ЕСТЬ NULL 
			//|			ТОГДА 0
			//|		ИНАЧЕ СУММА(ТаблицаРегистра.СтоимостьОборот)
			//|	КОНЕЦ - ВЫБОР
			//|		КОГДА СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот) ЕСТЬ NULL 
			//|			ТОГДА 0
			//|		ИНАЧЕ СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот)
			//|	КОНЕЦ - ВЫБОР
			//|		КОГДА СУММА(Транспорт.ДоставкаВЦене) ЕСТЬ NULL 
			//|			ТОГДА 0
			//|		ИНАЧЕ СУММА(Транспорт.ДоставкаВЦене)
			//|	КОНЕЦ КАК ВаловаяПрибыльСУчетомДоставки,
			//|	ВЫРАЗИТЬ(ВЫБОР
			//|			КОГДА СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот*&КоэфБезНДС + ЕСТЬNULL(Транспорт.ДоставкаВЦене, 0)) <> 0
			//|				ТОГДА 100 * (СУММА(ТаблицаРегистра.СтоимостьОборот)*&КоэфБезНДС - СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот*&КоэфБезНДС + ЕСТЬNULL(Транспорт.ДоставкаВЦене, 0))) / СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот*&КоэфБезНДС + ЕСТЬNULL(Транспорт.ДоставкаВЦене, 0))
			//|			ИНАЧЕ 0
			//|		КОНЕЦ КАК ЧИСЛО(15, 2)) КАК ПроцентНаценкиСУчетомТранспорта,
			//|	МАКСИМУМ(ЕСТЬNULL(ВаловаяИТранспортПоВсемЗаказам.ПроцентДоставкиВВаловойПоВсемуЗаказу, 0)) КАК ПроцентДоставкиВВаловойПрибылиПоВсемуЗаказу,
			
			|	СУММА(ЕСТЬNULL(ТаблицаРегистраСебестоимость.СтоимостьОборот, 0) *&КоэфБезНДС * ЕСТЬNULL(втБонусыПоНоменклатуре.Бонус, 0) / 100) КАК СуммаБонуса,
			
			|	СУММА(ЕСТЬNULL(ТаблицаРегистра.СтоимостьОборот, 0)*&КоэфБезНДС - ЕСТЬNULL(ТаблицаРегистраСебестоимость.СтоимостьОборот, 0)*&КоэфБезНДС - ЕСТЬNULL(Транспорт.ДоставкаВЦене, 0) + ЕСТЬNULL(ТаблицаРегистраСебестоимость.СтоимостьОборот, 0)*&КоэфБезНДС * ЕСТЬNULL(втБонусыПоНоменклатуре.Бонус, 0) / 100) КАК ВаловаяПрибыльСУчетомДоставкиИБонуса,
			
			|	ВЫРАЗИТЬ(ВЫБОР
			|			КОГДА СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот*&КоэфБезНДС + ЕСТЬNULL(Транспорт.ДоставкаВЦене, 0) - ЕСТЬNULL(ТаблицаРегистраСебестоимость.СтоимостьОборот, 0) *&КоэфБезНДС  * ЕСТЬNULL(втБонусыПоНоменклатуре.Бонус, 0) / 100) <> 0
			|				ТОГДА 100 * (СУММА(ТаблицаРегистра.СтоимостьОборот)*&КоэфБезНДС - СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот*&КоэфБезНДС + ЕСТЬNULL(Транспорт.ДоставкаВЦене, 0) - ЕСТЬNULL(ТаблицаРегистраСебестоимость.СтоимостьОборот, 0) *&КоэфБезНДС * ЕСТЬNULL(втБонусыПоНоменклатуре.Бонус, 0) / 100) / (СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот*&КоэфБезНДС + ЕСТЬNULL(Транспорт.ДоставкаВЦене, 0)) - ЕСТЬNULL(ТаблицаРегистраСебестоимость.СтоимостьОборот, 0) *&КоэфБезНДС * ЕСТЬNULL(втБонусыПоНоменклатуре.Бонус, 0) / 100))
			|			ИНАЧЕ 0
			|		КОНЕЦ КАК ЧИСЛО(15, 2)) КАК ПроцентНаценкиСУчетомТранспортаИБонуса
		 	|{ВЫБРАТЬ
			|	ТаблицаРегистра.ДоговорКонтрагента.Владелец.* КАК Покупатель,
			|	ТаблицаРегистра.ДоговорКонтрагента.* КАК ДоговорКонтрагента,
			|	ТаблицаРегистра.ЗаказПокупателя.* КАК ЗаказПокупателя,
		 	//+++ 03.10.2018 ----------------------------------------------	
			|	Транспорт.Задание.* КАК ЗаданиеНаОтгрузку,
	   		|	ТаблицаРегистра.Номенклатура.* КАК Номенклатура,
			|	НоменклатурнаяГруппа.*,
			//|	ТаблицаРегистра.Номенклатура.БазоваяЕдиницаИзмерения.* КАК НоменклатураБазоваяЕдиницаИзмерения,
			//|	ТаблицаРегистра.ХарактеристикаНоменклатуры.* КАК ХарактеристикаНоменклатуры,
			|	ТаблицаРегистра.ДокументПродажи.* КАК ДокументПродажи,
			|	ТаблицаРегистра.Подразделение.* КАК Подразделение,
			|	ТаблицаРегистра.Период,
			|	ТаблицаРегистра.Регистратор.* КАК Регистратор,
			|	(НАЧАЛОПЕРИОДА(ТаблицаРегистра.Период, ДЕНЬ)) КАК ПериодДень,
			|	(НАЧАЛОПЕРИОДА(ТаблицаРегистра.Период, НЕДЕЛЯ)) КАК ПериодНеделя,
			|	(НАЧАЛОПЕРИОДА(ТаблицаРегистра.Период, МЕСЯЦ)) КАК ПериодМесяц,
			|	(НАЧАЛОПЕРИОДА(ТаблицаРегистра.Период, КВАРТАЛ)) КАК ПериодКвартал,
			|	(НАЧАЛОПЕРИОДА(ТаблицаРегистра.Период, ГОД)) КАК ПериодГод}
			|ИЗ
			|	РегистрНакопления.Продажи.Обороты(&ДатаНач, &ДатаКон, Регистратор, ) КАК ТаблицаРегистра
			|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ПродажиСебестоимость.Обороты(&ДатаНач, &ДатаКон, Регистратор, ) КАК ТаблицаРегистраСебестоимость
			|		ПО ТаблицаРегистра.Номенклатура = ТаблицаРегистраСебестоимость.Номенклатура
			|			И ТаблицаРегистра.ХарактеристикаНоменклатуры = ТаблицаРегистраСебестоимость.ХарактеристикаНоменклатуры
			|			И ТаблицаРегистра.ЗаказПокупателя = ТаблицаРегистраСебестоимость.ЗаказПокупателя
			|			И ТаблицаРегистра.Подразделение = ТаблицаРегистраСебестоимость.Подразделение
			|			И ТаблицаРегистра.Регистратор = ТаблицаРегистраСебестоимость.Регистратор
			|		ЛЕВОЕ СОЕДИНЕНИЕ Транспорт КАК Транспорт
			|		ПО ТаблицаРегистра.ЗаказПокупателя = Транспорт.Заказ
			|			И ТаблицаРегистра.Номенклатура = Транспорт.Номенклатура
			|			И ТаблицаРегистра.Регистратор = Транспорт.Реализация
			//|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
			//|			А.ЗаказПокупателя КАК ЗаказПокупателя
			//|			, А.ВаловаяПоВсемуЗаказу КАК ВаловаяПоВсемуЗаказу
			//|			, А.ТранспортПоВсемуЗаказу КАК ТранспортПоВсемуЗаказу
			//|			, ВЫБОР
			//|				КОГДА А.ВаловаяПоВсемуЗаказу <> 0
			//|					ТОГДА А.ТранспортПоВсемуЗаказу * 100 / А.ВаловаяПоВсемуЗаказу
			//|				ИНАЧЕ 0
			//|			КОНЕЦ КАК ПроцентДоставкиВВаловойПоВсемуЗаказу
			//|		ИЗ
			//|			(ВЫБРАТЬ
			//|				ПродажиОбороты.ЗаказПокупателя КАК ЗаказПокупателя,
			////--------------------------------------------------КоэфБезНДС----------------------------------------
			//|				СУММА(ПродажиОбороты.СтоимостьОборот - ЕСТЬNULL(ПродажиСебестоимостьОбороты.СтоимостьОборот, 0))*&КоэфБезНДС КАК ВаловаяПоВсемуЗаказу,
			//|				СУММА(ЕСТЬNULL(Транспорт.ДоставкаВЦене, 0)) КАК ТранспортПоВсемуЗаказу
			//|			ИЗ
			//|				РегистрНакопления.Продажи.Обороты(&ДатаНач, &ДатаКон, Регистратор, ) КАК ПродажиОбороты
			//|					ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ПродажиСебестоимость.Обороты(&ДатаНач, &ДатаКон, Регистратор, ) КАК ПродажиСебестоимостьОбороты
			//|					ПО ПродажиОбороты.Регистратор = ПродажиСебестоимостьОбороты.Регистратор
			//|						И ПродажиОбороты.Номенклатура = ПродажиСебестоимостьОбороты.Номенклатура
			//|						И ПродажиОбороты.ХарактеристикаНоменклатуры = ПродажиСебестоимостьОбороты.ХарактеристикаНоменклатуры
			//|						И ПродажиОбороты.ЗаказПокупателя = ПродажиСебестоимостьОбороты.ЗаказПокупателя
			//|					ЛЕВОЕ СОЕДИНЕНИЕ Транспорт КАК Транспорт
			//|					ПО ПродажиОбороты.ЗаказПокупателя = Транспорт.Заказ
			//|						И ПродажиОбороты.Номенклатура = Транспорт.Номенклатура
			//|						И ПродажиОбороты.Регистратор = Транспорт.Реализация
			//|			
			//|			СГРУППИРОВАТЬ ПО
			//|				ПродажиОбороты.ЗаказПокупателя) КАК А) КАК ВаловаяИТранспортПоВсемЗаказам
			//|		ПО ТаблицаРегистра.ЗаказПокупателя = ВаловаяИТранспортПоВсемЗаказам.ЗаказПокупателя
			|		ЛЕВОЕ СОЕДИНЕНИЕ втБонусыПоНоменклатуре КАК втБонусыПоНоменклатуре
			|		ПО ТаблицаРегистра.Период = втБонусыПоНоменклатуре.ПериодРеализации
			|			И ТаблицаРегистра.Номенклатура = втБонусыПоНоменклатуре.Номенклатура
			|{ГДЕ
			|	ТаблицаРегистра.ДоговорКонтрагента.Владелец.* КАК Покупатель,
			|	ТаблицаРегистра.ДоговорКонтрагента.* КАК ДоговорКонтрагента,
			|	ТаблицаРегистра.ЗаказПокупателя.* КАК ЗаказПокупателя,
			//+++ 03.10.2018	
	   		|	Транспорт.Задание.* как ЗаданиеНаОтгрузку,
			|	ТаблицаРегистра.Номенклатура.* КАК Номенклатура,
		//	|	ТаблицаРегистра.Номенклатура.БазоваяЕдиницаИзмерения.* КАК НоменклатураБазоваяЕдиницаИзмерения,
		//	|	ТаблицаРегистра.ХарактеристикаНоменклатуры.* КАК ХарактеристикаНоменклатуры,
			|	ТаблицаРегистра.ДокументПродажи.* КАК ДокументПродажи,
			|	ТаблицаРегистра.Подразделение.* КАК Подразделение,
			|	ТаблицаРегистра.Период,
			|	ТаблицаРегистра.Регистратор.* КАК Регистратор,
			|	(СУММА(ТаблицаРегистра.КоличествоОборот)) КАК Количество,
		//	|	(СУММА(ТаблицаРегистра.КоличествоОборот * ТаблицаРегистра.Номенклатура.ЕдиницаХраненияОстатков.Коэффициент)) КАК КоличествоБазовыхЕд,
			|	(СУММА(ТаблицаРегистра.СтоимостьОборот)) КАК Стоимость,
			//|	(СУММА(ВЫБОР
			//|				КОГДА ТаблицаРегистра.КоличествоОборот = 0
			//|					ТОГДА ТаблицаРегистра.СтоимостьОборот
			//|				ИНАЧЕ ТаблицаРегистра.СтоимостьОборот / ТаблицаРегистра.КоличествоОборот
			//|			КОНЕЦ)) КАК СтоимостьЕдиницы,
			|	(СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот)) КАК Себестоимость,
			//|	(СУММА(ВЫБОР
			//|				КОГДА ТаблицаРегистра.КоличествоОборот <> 0
			//|					ТОГДА ЕСТЬNULL(ТаблицаРегистраСебестоимость.СтоимостьОборот, 0) / ТаблицаРегистра.КоличествоОборот
			//|				ИНАЧЕ ЕСТЬNULL(ТаблицаРегистраСебестоимость.СтоимостьОборот, 0)
			//|			КОНЕЦ)) КАК СебестоимостьЕдиницы,
			|	(ВЫБОР
			|			КОГДА СУММА(ТаблицаРегистра.СтоимостьОборот) ЕСТЬ NULL 
			|				ТОГДА 0
			|			ИНАЧЕ СУММА(ТаблицаРегистра.СтоимостьОборот)
			|		КОНЕЦ - ВЫБОР
			|			КОГДА СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот) ЕСТЬ NULL 
			|				ТОГДА 0
			|			ИНАЧЕ СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот)
			|		КОНЕЦ) КАК ВаловаяПрибыль,
			//|	(ВЫБОР
			//|			КОГДА СУММА(ТаблицаРегистра.КоличествоОборот) = 0
			//|				ТОГДА ВЫБОР
			//|						КОГДА СУММА(ТаблицаРегистра.СтоимостьОборот) ЕСТЬ NULL 
			//|							ТОГДА 0
			//|						ИНАЧЕ СУММА(ТаблицаРегистра.СтоимостьОборот)
			//|					КОНЕЦ - ВЫБОР
			//|						КОГДА СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот) ЕСТЬ NULL 
			//|							ТОГДА 0
			//|						ИНАЧЕ СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот)
			//|					КОНЕЦ
			//|			ИНАЧЕ СУММА((ЕСТЬNULL(ТаблицаРегистра.СтоимостьОборот, 0) - ЕСТЬNULL(ТаблицаРегистраСебестоимость.СтоимостьОборот, 0)) / ТаблицаРегистра.КоличествоОборот)
			//|		КОНЕЦ) КАК ВаловаяПрибыльЕдиницы,
			//|	(ВЫРАЗИТЬ(ВЫБОР
			//|				КОГДА СУММА(ТаблицаРегистра.СтоимостьОборот) <> 0
			//|					ТОГДА 100 * (СУММА(ТаблицаРегистра.СтоимостьОборот) - СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот)) / СУММА(ТаблицаРегистра.СтоимостьОборот)
			//|				ИНАЧЕ 0
			//|			КОНЕЦ КАК ЧИСЛО(15, 2))) КАК РентабельностьПродаж,
			
			//+++ 04.10.2018 - вместо Рентабельности - ВаловаяПрибыльНДС
			|	( СУММА(ТаблицаРегистра.СтоимостьОборот) - СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот) )*&КоэфНДС как ВаловаяПрибыльНДС,
			
			|	(ВЫРАЗИТЬ(ВЫБОР
			|				КОГДА СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот) <> 0
			|					ТОГДА 100 * (СУММА(ТаблицаРегистра.СтоимостьОборот) - СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот)) / СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот)
			|				ИНАЧЕ 0
			|			КОНЕЦ КАК ЧИСЛО(15, 2))) КАК ПроцентНаценки,
			//04.10.2018
			//|	(ВЫРАЗИТЬ(ВЫБОР
			//|				КОГДА СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот*&КоэфБезНДС + ЕСТЬNULL(Транспорт.ДоставкаВЦене, 0)) <> 0
			//|					ТОГДА 100 * (СУММА(ТаблицаРегистра.СтоимостьОборот)*&КоэфБезНДС - СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот*&КоэфБезНДС + ЕСТЬNULL(Транспорт.ДоставкаВЦене, 0))) / СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот*&КоэфБезНДС + ЕСТЬNULL(Транспорт.ДоставкаВЦене, 0))
			//|				ИНАЧЕ 0
			//|			КОНЕЦ КАК ЧИСЛО(15, 2))) КАК ПроцентНаценкиСУчетомТранспорта,
			|	(ЕСТЬNULL(Транспорт.ДоставкаВЦене, 0)) КАК ДоставкаВЦене
			//|	,(ЕСТЬNULL(ВаловаяИТранспортПоВсемЗаказам.ПроцентДоставкиВВаловойПоВсемуЗаказу, 0)) КАК ПроцентДоставкиВВаловойПрибылиПоВсемуЗаказу
			|}
			|
						
			|СГРУППИРОВАТЬ ПО
			|	ТаблицаРегистра.ДоговорКонтрагента.ОтветственноеЛицо,
 			|	ТаблицаРегистра.ДоговорКонтрагента.Владелец,
			|	Транспорт.Задание,
			|	ТаблицаРегистра.Номенклатура,
			
			|	ТаблицаРегистра.Номенклатура.НоменклатурнаяГруппа,
			
			|	ТаблицаРегистраСебестоимость.СтоимостьОборот,
			|	втБонусыПоНоменклатуре.Бонус
			
			//+++ 09.10.2018 +++ 	
			
			|//МинПроцНаценки
			
			|		
			|{УПОРЯДОЧИТЬ ПО
			|	ТаблицаРегистра.ДоговорКонтрагента.Владелец.* КАК Покупатель,
			|	ТаблицаРегистра.ДоговорКонтрагента.* КАК ДоговорКонтрагента,
			|	ТаблицаРегистра.ЗаказПокупателя.* КАК ЗаказПокупателя,
			|	ТаблицаРегистра.Номенклатура.* КАК Номенклатура,
		//	|	ТаблицаРегистра.Номенклатура.БазоваяЕдиницаИзмерения.* КАК НоменклатураБазоваяЕдиницаИзмерения,
		//	|	ТаблицаРегистра.ХарактеристикаНоменклатуры.* КАК ХарактеристикаНоменклатуры,
			|	ТаблицаРегистра.ДокументПродажи.* КАК ДокументПродажи,
			|	ТаблицаРегистра.Подразделение.* КАК Подразделение,
			|	ТаблицаРегистра.Период,
			|	ТаблицаРегистра.Регистратор.* КАК Регистратор,
			|	(СУММА(ТаблицаРегистра.КоличествоОборот)) КАК Количество,
		//	|	(СУММА(ТаблицаРегистра.КоличествоОборот * ТаблицаРегистра.Номенклатура.ЕдиницаХраненияОстатков.Коэффициент)) КАК КоличествоБазовыхЕд,
			|	(СУММА(ТаблицаРегистра.СтоимостьОборот)) КАК Стоимость,
			//|	(СУММА(ВЫБОР
			//|				КОГДА ТаблицаРегистра.КоличествоОборот = 0
			//|					ТОГДА ТаблицаРегистра.СтоимостьОборот
			//|				ИНАЧЕ ТаблицаРегистра.СтоимостьОборот / ТаблицаРегистра.КоличествоОборот
			//|			КОНЕЦ)) КАК СтоимостьЕдиницы,
			|	(СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот)) КАК Себестоимость,
			//|	(СУММА(ВЫБОР
			//|				КОГДА ТаблицаРегистра.КоличествоОборот <> 0
			//|					ТОГДА ЕСТЬNULL(ТаблицаРегистраСебестоимость.СтоимостьОборот, 0) / ТаблицаРегистра.КоличествоОборот
			//|				ИНАЧЕ ЕСТЬNULL(ТаблицаРегистраСебестоимость.СтоимостьОборот, 0)
			//|			КОНЕЦ)) КАК СебестоимостьЕдиницы,
			|	(ВЫБОР
			|			КОГДА СУММА(ТаблицаРегистра.СтоимостьОборот) ЕСТЬ NULL 
			|				ТОГДА 0
			|			ИНАЧЕ СУММА(ТаблицаРегистра.СтоимостьОборот)
			|		КОНЕЦ - ВЫБОР
			|			КОГДА СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот) ЕСТЬ NULL 
			|				ТОГДА 0
			|			ИНАЧЕ СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот)
			|		КОНЕЦ) КАК ВаловаяПрибыль,
			//|	(ВЫБОР
			//|			КОГДА СУММА(ТаблицаРегистра.КоличествоОборот) = 0
			//|				ТОГДА ВЫБОР
			//|						КОГДА СУММА(ТаблицаРегистра.СтоимостьОборот) ЕСТЬ NULL 
			//|							ТОГДА 0
			//|						ИНАЧЕ СУММА(ТаблицаРегистра.СтоимостьОборот)
			//|					КОНЕЦ - ВЫБОР
			//|						КОГДА СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот) ЕСТЬ NULL 
			//|							ТОГДА 0
			//|						ИНАЧЕ СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот)
			//|					КОНЕЦ
			//|			ИНАЧЕ СУММА((ЕСТЬNULL(ТаблицаРегистра.СтоимостьОборот, 0) - ЕСТЬNULL(ТаблицаРегистраСебестоимость.СтоимостьОборот, 0)) / ТаблицаРегистра.КоличествоОборот)
			//|		КОНЕЦ) КАК ВаловаяПрибыльЕдиницы,
			//|	(ВЫРАЗИТЬ(ВЫБОР
			//|				КОГДА СУММА(ТаблицаРегистра.СтоимостьОборот) <> 0
			//|					ТОГДА 100 * (СУММА(ТаблицаРегистра.СтоимостьОборот) - СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот)) / СУММА(ТаблицаРегистра.СтоимостьОборот)
			//|				ИНАЧЕ 0
			//|			КОНЕЦ КАК ЧИСЛО(15, 2))) КАК РентабельностьПродаж,
		//04.10.2018	
			|	(ВЫБОР
			|			КОГДА СУММА(ТаблицаРегистра.СтоимостьОборот) ЕСТЬ NULL 
			|				ТОГДА 0
			|			ИНАЧЕ СУММА(ТаблицаРегистра.СтоимостьОборот)
			|		КОНЕЦ - ВЫБОР
			|			КОГДА СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот) ЕСТЬ NULL 
			|				ТОГДА 0
			|			ИНАЧЕ СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот)
			|		КОНЕЦ)*&КоэфНДС КАК ВаловаяПрибыльНДС,
			
			|	(ВЫРАЗИТЬ(ВЫБОР
			|				КОГДА СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот) <> 0
			|					ТОГДА 100 * (СУММА(ТаблицаРегистра.СтоимостьОборот) - СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот)) / СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот)
			|				ИНАЧЕ 0
			|			КОНЕЦ КАК ЧИСЛО(15, 2))) КАК ПроцентНаценки,
			
			//|	(ВЫРАЗИТЬ(ВЫБОР
			//|				КОГДА СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот*&КоэфБезНДС + Транспорт.ДоставкаВЦене) <> 0
			////04.10.2018 &КоэфБезНДС = 1/1.18
			//|					ТОГДА 100 * (СУММА(ТаблицаРегистра.СтоимостьОборот)*&КоэфБезНДС - СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот*&КоэфБезНДС + Транспорт.ДоставкаВЦене)) / СУММА(ТаблицаРегистраСебестоимость.СтоимостьОборот*&КоэфБезНДС + Транспорт.ДоставкаВЦене)
			//|				ИНАЧЕ 0
			//|			КОНЕЦ КАК ЧИСЛО(15, 2))) КАК ПроцентНаценкиСУчетомТранспорта,
			|	ДоставкаВЦене}
			
			
			|ИТОГИ
			|	СУММА(Количество),
			//|	СУММА(КоличествоБазовыхЕд),
			|	СУММА(Стоимость),
			//|	СУММА(СтоимостьЕдиницы),
			|	СУММА(Себестоимость),
			//|	СУММА(СебестоимостьЕдиницы),
			|	СУММА(ВаловаяПрибыль),
			//|	ВЫРАЗИТЬ(ВЫБОР
			//|			КОГДА СУММА(Стоимость) <> 0
			//|				ТОГДА 100 * (СУММА(Стоимость) - СУММА(Себестоимость)) / СУММА(Стоимость)
			//|			ИНАЧЕ 0
			//|		КОНЕЦ КАК ЧИСЛО(15, 2)) КАК РентабельностьПродаж,
			|	СУММА(ВаловаяПрибыль)*&КоэфНДС как ВаловаяПрибыльНДС,
			
			|	ВЫРАЗИТЬ(ВЫБОР
			|			КОГДА СУММА(Себестоимость) <> 0
			|				ТОГДА 100 * (СУММА(Стоимость) - СУММА(Себестоимость)) / СУММА(Себестоимость)
			|			ИНАЧЕ 0
			|		КОНЕЦ КАК ЧИСЛО(15, 2)) КАК ПроцентНаценки,
			|	СУММА(ДоставкаВЦене),
			//|	СУММА(ВаловаяПрибыль) - СУММА(ДоставкаВЦене) КАК ВаловаяПрибыльСУчетомДоставки,
			//|	ВЫРАЗИТЬ(ВЫБОР
			//|			КОГДА СУММА(Себестоимость + ДоставкаВЦене) <> 0
			//|				ТОГДА 100 * (СУММА(Стоимость) - СУММА(Себестоимость + ДоставкаВЦене)) / СУММА(Себестоимость + ДоставкаВЦене)
			//|			ИНАЧЕ 0
			//|		КОНЕЦ КАК ЧИСЛО(15, 2)) КАК ПроцентНаценкиСУчетомТранспорта,
			//|	МАКСИМУМ(ПроцентДоставкиВВаловойПрибылиПоВсемуЗаказу),
			|	СУММА(СуммаБонуса),
			//04.10.2018
			|	СУММА(ВаловаяПрибыль)*&КоэфБезНДС - СУММА(ДоставкаВЦене) + СУММА(СуммаБонуса) КАК ВаловаяПрибыльСУчетомДоставкиИБонуса,
			|	ВЫРАЗИТЬ(ВЫБОР
			|			КОГДА СУММА(Себестоимость) <> 0
			|				ТОГДА 100 * ( СУММА(ВаловаяПрибыль)*&КоэфБезНДС - СУММА(ДоставкаВЦене) + СУММА(СуммаБонуса)) / СУММА(Себестоимость)
			|			ИНАЧЕ 0
			|		КОНЕЦ КАК ЧИСЛО(15, 2)) КАК ПроцентНаценкиСУчетомТранспортаИБонуса
			
						
            |ПО   
			|	ОБЩИЕ
			//,ДоговорКонтрагента.ОтветственноеЛицо,ДоговорКонтрагента.Владелец
           
			|{ИТОГИ ПО
			|	ТаблицаРегистра.ДоговорКонтрагента.Владелец.* КАК Покупатель,
			|	ТаблицаРегистра.ДоговорКонтрагента.* КАК ДоговорКонтрагента,
			|	ТаблицаРегистра.ЗаказПокупателя.* КАК ЗаказПокупателя,
			//03.10.2018
			|	Транспорт.Задание.* как ЗаданиеНаОтгрузку,
			|	ТаблицаРегистра.Номенклатура.* КАК Номенклатура,
			|	НоменклатурнаяГруппа.*,
			//|	ТаблицаРегистра.Номенклатура.БазоваяЕдиницаИзмерения.* КАК НоменклатураБазоваяЕдиницаИзмерения,
			//|	ТаблицаРегистра.ХарактеристикаНоменклатуры.* КАК ХарактеристикаНоменклатуры,
			|	ТаблицаРегистра.ДокументПродажи.* КАК ДокументПродажи,
			|	ТаблицаРегистра.Подразделение.* КАК Подразделение,
			|	(НАЧАЛОПЕРИОДА(ТаблицаРегистра.Период, ДЕНЬ)) КАК ПериодДень,
			|	(НАЧАЛОПЕРИОДА(ТаблицаРегистра.Период, НЕДЕЛЯ)) КАК ПериодНеделя,
			|	(НАЧАЛОПЕРИОДА(ТаблицаРегистра.Период, МЕСЯЦ)) КАК ПериодМесяц,
			|	(НАЧАЛОПЕРИОДА(ТаблицаРегистра.Период, КВАРТАЛ)) КАК ПериодКвартал,
			|	(НАЧАЛОПЕРИОДА(ТаблицаРегистра.Период, ГОД)) КАК ПериодГод}
			|АВТОУПОРЯДОЧИВАНИЕ";
	//04.10.2018 от 10 000 000 000,00 -> 12 цифр надо
	текст = стрЗаменить(текст,"&КоэфНДС",    "18/118" );   //  0.15254237 28813559 32203389 83050847
	текст = стрЗаменить(текст,"*&КоэфБезНДС", "/1.18" );   //  0.84745762 71186440 67796610 16949153	
	
	СтруктураПредставлениеПолей = Новый Структура("
	|Количество,
	//|КоличествоБазовыхЕд,
	|Стоимость,
	//|СтоимостьЕдиницы,
	|Себестоимость,
	//|СебестоимостьЕдиницы,
	|ВаловаяПрибыль,
	//|РентабельностьПродаж,
	|ВаловаяПрибыльНДС,
	|ПроцентНаценки,
	//|ПроцентНаценкиСУчетомТранспорта,
	|ДоставкаВЦене,
	//|ВаловаяПрибыльСУчетомДоставки,	
	|ВаловаяПрибыльСУчетомДоставкиИБонуса,	
	|СуммаБонуса,	
	|ПроцентНаценкиСУчетомТранспортаИБонуса,	
	//|ПроцентДоставкиВВаловойПрибылиПоВсемуЗаказу,	
	|Покупатель,
	|ДоговорКонтрагента,
	|ЗаказПокупателя,
	//03.10.2018
	|ЗаданиеНаОтгрузку,
	//|НоменклатураБазоваяЕдиницаИзмерения,
	//|ХарактеристикаНоменклатуры,
	|Подразделение,
	|ПериодДень,
	|ПериодНеделя,
	|ПериодМесяц,
	|ПериодКвартал,
	|ПериодГод", 
	"Количество товара, шт.",
	//"Количество товара в базовых единицах",
	"Продажная стоимость",
	//"Продажная стоимость единицы",	
	"Себестоимость",
	//"Себестоимость единицы",
	"Валовая прибыль",
	//"Рентабельность продаж, %",
	"НДС(валовой прибыли)",
	"Процент наценки",
	//"Процент наценки с учетом транспорта",
	"Транспорт",
	//"Валовая прибыль с учетом доставки",
	"Валовая прибыль (с учетом НДС, Транспорта и Бонуса)",	
	"Бонус",	
	"Процент наценки* (с учетом НДС, Транспорта и Бонуса)",
	//"Процент доставки в валовой прибыли по всему заказу",
	"Покупатель",
	"Договор контрагента",
	"Заказ покупателя",
	//03.10.2018
	"Задание на отгрузку",
	//"Базовая единица измерения",
	//"Характеристика номенклатуры",
	"Подразделение",
	"По дням",
	"По неделям",
	"По месяцам",
	"По кварталам",
	"По годам");
	
	Если ОбщийОтчет.ИспользоватьСвойстваИКатегории Тогда
	
		ТекстПоляСвойств= "";
		ТекстПоляКатегорий = "";

		ТаблицаПолей = Новый ТаблицаЗначений;
		ТаблицаПолей.Колонки.Добавить("ПутьКДанным");  // описание поля запроса поля, для которого добавляются свойства и категории. Используется в условии соединения с регистром сведений, хранящим значения свойств или категорий
		ТаблицаПолей.Колонки.Добавить("Представление");// представление поля, для которого добавляются свойства и категории. 
		ТаблицаПолей.Колонки.Добавить("Назначение");   // назначение свойств/категорий объектов для данного поля
		ТаблицаПолей.Колонки.Добавить("ТипЗначения");  // тип значения поля, для которого добавляются свойства и категории. Используется, если не установлено назначение
		ТаблицаПолей.Колонки.Добавить("НетКатегорий"); // признак НЕиспользования категорий для объекта
		
		СтрокаТаблицы = ТаблицаПолей.Добавить();
		СтрокаТаблицы.ПутьКДанным = "Номенклатура";
		СтрокаТаблицы.Представление = "Номенклатура";
		СтрокаТаблицы.Назначение = ПланыВидовХарактеристик.НазначенияСвойствКатегорийОбъектов.Справочник_Номенклатура;
		
		СтрокаТаблицы = ТаблицаПолей.Добавить(); //+++ 11.09.2013
		СтрокаТаблицы.ПутьКДанным = "ДоговорКонтрагента.Владелец";
		СтрокаТаблицы.Представление = "Покупатель";
		СтрокаТаблицы.Назначение = ПланыВидовХарактеристик.НазначенияСвойствКатегорийОбъектов.Справочник_Контрагенты;
				
		ДобавитьВТекстСвойстваИКатегории(ТаблицаПолей, Текст, СтруктураПредставлениеПолей, 
				ОбщийОтчет.мСоответствиеНазначений, ПостроительОтчета.Параметры
				,, ТекстПоляКатегорий, ТекстПоляСвойств,,,,,,ОбщийОтчет.мСтруктураДляОтбораПоКатегориям);
				
		ДобавитьВТекстСвойстваОбщие(Текст, ТекстПоляСвойств, "//ОБЩИЕ_СВОЙСТВА");
	  // для избежания двойственности поля Номенклатура в запросе
		Текст=СтрЗаменить(Текст,"ИНАЧЕ Номенклатура","ИНАЧЕ ТаблицаРегистраСебестоимость.Номенклатура");
		Текст=СтрЗаменить(Текст,"= Номенклатура","= ТаблицаРегистра.Номенклатура");		
				
	УстановитьТипыЗначенийСвойствИКатегорийДляОтбора(ПостроительОтчета, ТекстПоляКатегорий, ТекстПоляСвойств, ОбщийОтчет.мСоответствиеНазначений, СтруктураПредставлениеПолей);
	КонецЕсли;
	
	ПостроительОтчета.Текст = Текст;
	МассивОтбора = Новый Массив;
	МассивОтбора.Добавить("Покупатель");
	МассивОтбора.Добавить("Номенклатура");
	МассивОтбора.Добавить("Подразделение");
	
	ЗаполнитьПредставленияПолей(СтруктураПредставлениеПолей, ПостроительОтчета);
	ОчиститьДополнительныеПоляПостроителя(ПостроительОтчета);
	ЗаполнитьОтбор(МассивОтбора, ПостроительОтчета);
	ОбщийОтчет.мВыбиратьИмяРегистра = Ложь;
	ОбщийОтчет.ВыводитьПоказателиВСтроку = Истина;
	ОбщийОтчет.ВыводитьИтогиПоВсемУровням = Истина;
	
	ОбщийОтчет.ЗаполнитьПоказатели("Количество", "Количество, шт.", Ложь, "ЧЦ=15; ЧДЦ=3");
	//ОбщийОтчет.ЗаполнитьПоказатели("Количество", "Количество в базовых единицах", Истина, "ЧЦ=15; ЧДЦ=3");
	
	ОбщийОтчет.ЗаполнитьПоказатели("Стоимость", "Продажная стоимость, руб.", Истина, "ЧЦ=15; ЧДЦ=2");
	//ОбщийОтчет.ЗаполнитьПоказатели("СтоимостьЕдиницы", "Продажная стоимость единцы в валюте упр. учета", Истина, "ЧЦ=15; ЧДЦ=2");
	ОбщийОтчет.ЗаполнитьПоказатели("Себестоимость", "Себестоимость, руб.", Истина, "ЧЦ=15; ЧДЦ=2");
	//ОбщийОтчет.ЗаполнитьПоказатели("ВаловаяПрибыльСУчетомДоставки", "Валовая прибыль с учетом доставки", Истина, "ЧЦ=15; ЧДЦ=2");
	ОбщийОтчет.ЗаполнитьПоказатели("ПроцентНаценки", "Процент наценки", Истина, "ЧЦ=15; ЧДЦ=2");
	
	
	ОбщийОтчет.ЗаполнитьПоказатели("ВаловаяПрибыль", "Валовая прибыль, руб.", Истина, "ЧЦ=15; ЧДЦ=2");
	//ОбщийОтчет.ЗаполнитьПоказатели("РентабельностьПродаж", "Рентабельность продаж, %", Истина, "ЧЦ=15; ЧДЦ=2");
	ОбщийОтчет.ЗаполнитьПоказатели("ВаловаяПрибыльНДС", "НДС(валовой прибыли), руб.", Истина, "ЧЦ=15; ЧДЦ=2");
	//ОбщийОтчет.ЗаполнитьПоказатели("СебестоимостьЕдиницы", "Себестоимость единицы в валюте упр. учета", Ложь, "ЧЦ=15; ЧДЦ=2");
	ОбщийОтчет.ЗаполнитьПоказатели("ДоставкаВЦене", "Транспорт, руб.", Истина, "ЧЦ=15; ЧДЦ=2");
	ОбщийОтчет.ЗаполнитьПоказатели("СуммаБонуса", "Бонус, руб.", Истина, "ЧЦ=15; ЧДЦ=2");
	
	
	ОбщийОтчет.ЗаполнитьПоказатели("ВаловаяПрибыльСУчетомДоставкиИБонуса", "Валовая прибыль (с учетом НДС, Транспорта и Бонуса)", Истина, "ЧЦ=15; ЧДЦ=2");
	//ОбщийОтчет.ЗаполнитьПоказатели("ПроцентНаценкиСУчетомТранспорта", "Процент наценки с учетом транспорта", Истина, "ЧЦ=15; ЧДЦ=2");
	ОбщийОтчет.ЗаполнитьПоказатели("ПроцентНаценкиСУчетомТранспортаИБонуса", "Процент наценки* (с учетом НДС, Транспорта и Бонуса)", Истина, "ЧЦ=15; ЧДЦ=2");
	
	//ОбщийОтчет.ЗаполнитьПоказатели("ПроцентДоставкиВВаловойПрибылиПоВсемуЗаказу", "Процент доставки в валовой прибыли с учетом НДС по всему заказу", Истина, "ЧЦ=15; ЧДЦ=2");
	
	
	ОбщийОтчет.мНазваниеОтчета = "Отчет по валовой прибыли с учетом НДС, Транспорта и Бонуса";
	ОбщийОтчет.ВыводитьИтогиПоВсемУровням = Ложь;
	ОбщийОтчет.мВыбиратьИспользованиеСвойств = Истина;
	
	ОбщийОтчет.РаскрашиватьИзмерения = истина;//+++ 09.10.2018
	
	// Установим дату начала отчета
	Если ЗначениеНеЗаполнено(ОбщийОтчет.ДатаНач) Тогда
		
		Если Не ЗначениеНеЗаполнено(ПараметрыСеанса.ТекущийПользователь) Тогда
			ОбщийОтчет.ДатаНач = ПолучитьЗначениеПоУмолчанию(ПараметрыСеанса.ТекущийПользователь,"ОсновнаяДатаНачалаОтчетов");
		КонецЕсли;
		
	КонецЕсли; 
	
КонецПроцедуры

Процедура СформироватьОтчет(ДокументРезультат, ПоказыватьЗаголовок, ВысотаЗаголовка, ТолькоЗаголовок = Ложь, ПроцентНаценкиМин=неопределено ) Экспорт

	Если ПолучитьЗначениеПоУмолчанию(ПараметрыСеанса.ТекущийПользователь, "УчетТолькоПоПодразделениюПользователя") Тогда
		
		//+++ 26.06.2013 - ограничение по подразделению
		Если НЕ ПолучитьЗначениеПоУмолчанию(ПараметрыСеанса.ТекущийПользователь, "СтаршийМенеджерПодразделения") Тогда
           СообщитьОбОшибке("У вас недостаточно прав для просмотра данного отчета!");
		   Возврат;
	    КонецЕсли;
		
	 	Если ПолучитьЗначениеПоУмолчанию(ПараметрыСеанса.ТекущийПользователь, "ИспользоватьМеханизмДележкиДляГруппы") тогда 
			СписокМенеджеров = ПолучитьСписокПользователейСвоейГруппы();
			Если ОбщийОтчет.ПостроительОтчета.Отбор.Найти("ДоговорКонтрагента") = неопределено тогда
				ОбщийОтчет.ПостроительОтчета.Отбор.Добавить("ДоговорКонтрагента");
			КонецЕсли;
			
			СписокДоговоровМенеджера = ПолучитьСписокДоговоровМенеджера(СписокМенеджеров);
			ОбщийОтчет.ПостроительОтчета.Отбор.ДоговорКонтрагента.Использование = Истина;
			ОбщийОтчет.ПостроительОтчета.Отбор.ДоговорКонтрагента.ВидСравнения = ВидСравнения.ВСписке;
			ОбщийОтчет.ПостроительОтчета.Отбор.ДоговорКонтрагента.Значение = СписокДоговоровМенеджера;
       
			//СписокКонтр = ПолучитьСписокКонтрагентовМенеджера(СписокМенеджеров);
			//ОбщийОтчет.ПостроительОтчета.Отбор.Покупатель.Использование = Истина;
			//ОбщийОтчет.ПостроительОтчета.Отбор.Покупатель.ВидСравнения = ВидСравнения.ВСписке;
			//ОбщийОтчет.ПостроительОтчета.Отбор.Покупатель.Значение = СписокКонтр;
        Иначе
			ДоступноеПодразделение = ПараметрыСеанса.ТекущийПользователь.ОсновноеПодразделение;
	    	ОбщийОтчет.ПостроительОтчета.Отбор.Подразделение.Значение = ДоступноеПодразделение;
			ОбщийОтчет.ПостроительОтчета.Отбор.Подразделение.Использование = Истина;
			ОбщийОтчет.ПостроительОтчета.Отбор.Подразделение.ВидСравнения = ВидСравнения.Равно;
		КонецЕсли;	
	КонецЕсли;
	
	//09.10.2018 --- заменяет, но только 1 раз!
	Если ПроцентНаценкиМин<>неопределено тогда
	//уберем старый процент "&КоэфБезНДС" => "1/1.18" 
               // a/b<=c -a/-b<=c   -a*(-b) < b^2 *c
			   ОбщийОтчет.ПостроительОтчета.Текст = стрЗаменить(ОбщийОтчет.ПостроительОтчета.Текст, "ИМЕЮЩИЕ 
			|( ( Сумма(ЕстьNull(ТаблицаРегистра.СтоимостьОборот,0))-Сумма(ЕстьNull(ТаблицаРегистраСебестоимость.СтоимостьОборот,0)) )/1.18
			|- Сумма(ЕСТЬNULL(Транспорт.ДоставкаВЦене, 0)) + Сумма( ЕСТЬNULL(ТаблицаРегистраСебестоимость.СтоимостьОборот, 0)/1.18*ЕСТЬNULL(втБонусыПоНоменклатуре.Бонус,0)/100 )
			|)* Сумма(ЕстьNull(ТаблицаРегистраСебестоимость.СтоимостьОборот,0)) < Сумма(ЕстьNull(ТаблицаРегистраСебестоимость.СтоимостьОборот,0)) 
			| * Сумма(ЕстьNull(ТаблицаРегистраСебестоимость.СтоимостьОборот,0)) * ", "//МинПроцНаценки");
	//установим новый		
	ОбщийОтчет.ПостроительОтчета.Текст = стрЗаменить(ОбщийОтчет.ПостроительОтчета.Текст, "//МинПроцНаценки", "ИМЕЮЩИЕ 
			|( ( Сумма(ЕстьNull(ТаблицаРегистра.СтоимостьОборот,0))-Сумма(ЕстьNull(ТаблицаРегистраСебестоимость.СтоимостьОборот,0)) )/1.18
			|- Сумма(ЕСТЬNULL(Транспорт.ДоставкаВЦене, 0)) + Сумма( ЕСТЬNULL(ТаблицаРегистраСебестоимость.СтоимостьОборот, 0)/1.18*ЕСТЬNULL(втБонусыПоНоменклатуре.Бонус,0)/100 )
			|)* Сумма(ЕстьNull(ТаблицаРегистраСебестоимость.СтоимостьОборот,0)) < Сумма(ЕстьNull(ТаблицаРегистраСебестоимость.СтоимостьОборот,0)) 
			| * Сумма(ЕстьNull(ТаблицаРегистраСебестоимость.СтоимостьОборот,0)) * "+формат(ПроцентНаценкиМин/100,"ЧДЦ=3; ЧРД=.; ЧН=0")+" //" ); //старый через //
	иначе
	ОбщийОтчет.ПостроительОтчета.Текст = стрЗаменить(ОбщийОтчет.ПостроительОтчета.Текст, "ИМЕЮЩИЕ 
			|( ( Сумма(ЕстьNull(ТаблицаРегистра.СтоимостьОборот,0))-Сумма(ЕстьNull(ТаблицаРегистраСебестоимость.СтоимостьОборот,0)) )/1.18
			|- Сумма(ЕСТЬNULL(Транспорт.ДоставкаВЦене, 0)) + Сумма( ЕСТЬNULL(ТаблицаРегистраСебестоимость.СтоимостьОборот, 0)/1.18*ЕСТЬNULL(втБонусыПоНоменклатуре.Бонус,0)/100 )
			|)* Сумма(ЕстьNull(ТаблицаРегистраСебестоимость.СтоимостьОборот,0)) < Сумма(ЕстьNull(ТаблицаРегистраСебестоимость.СтоимостьОборот,0)) 
			| * Сумма(ЕстьNull(ТаблицаРегистраСебестоимость.СтоимостьОборот,0)) * ", "//МинПроцНаценки");
	КонецЕсли;

	//ОбщийОтчет.мСтруктураСвязиПоказателейИИзмерений.Вставить("РентабельностьПродаж", Новый Структура("ТакогоИзмеренияНетВОтчете")); // Рентабельность не выводится в итогах по группировкам, только в детальных записях
	//ОбщийОтчет.мСтруктураСвязиПоказателейИИзмерений.Вставить("ПроцентНаценки", Новый Структура("ТакогоИзмеренияНетВОтчете")); // Рентабельность не выводится в итогах по группировкам, только в детальных записях
	//если ПоПроценту тогда
	//ОбщийОтчет.ПостроительОтчета.ДоступныеПоля.Очистить();
	Общийотчет.ПостроительОтчета.ИзмеренияСтроки.Очистить();
	ОбщийОтчет.ПостроительОтчета.ИзмеренияСтроки.Добавить("ДоговорКонтрагента.ОтветственноеЛицо");
	ОбщийОтчет.ПостроительОтчета.ИзмеренияСтроки.Добавить("Покупатель");
	ОбщийОтчет.ПостроительОтчета.ИзмеренияСтроки.Добавить("ЗаданиеНаОтгрузку");
	ОбщийОтчет.ПостроительОтчета.ВыбранныеПоля.Очистить();
	//конецесли;
	
	ОбщийОтчет.СформироватьОтчет(ДокументРезультат, ПоказыватьЗаголовок, ВысотаЗаголовка, ТолькоЗаголовок);

КонецПРоцедуры

// Читает свойство Построитель отчета
//
// Параметры
//	Нет
//
Функция ПолучитьПостроительОтчета() Экспорт

	Возврат ОбщийОтчет.ПолучитьПостроительОтчета();

КонецФункции // ПолучитьПостроительОтчета()

// Настраивает отчет по переданной структуре параметров
//
// Параметры:
//	Нет.
//
Процедура Настроить(Параметры) Экспорт

	ОбщийОтчет.Настроить(Параметры, ЭтотОбъект);

КонецПроцедуры

// Возвращает основную форму отчета, связанную с данным экземпляром отчета
//
// Параметры
//	Нет
//
Функция ПолучитьОсновнуюФорму() Экспорт
	
	ОснФорма = ПолучитьФорму();
	ОснФорма.ОбщийОтчет = ОбщийОтчет;
	ОснФорма.ЭтотОтчет = ЭтотОбъект;
	Возврат ОснФорма;
	
КонецФункции // ПолучитьОсновнуюФорму()

// Возвращает форму настройки 
//
// Параметры:
//	Нет.
//
// Возвращаемое значение:
//	
//
Функция ПолучитьФормуНастройки() Экспорт
	
	ОбщийОтчет.мВыбиратьИспользованиеСвойств = Истина;//+++ 11.09.2013
	
	ФормаНастройки = ОбщийОтчет.ПолучитьФорму("ФормаНастройка");
	
	Возврат ФормаНастройки;
	
КонецФункции // ПолучитьФормуНастройки()

// Процедура обработки расшифровки
//
// Параметры:
//	Нет.
//
Процедура ОбработкаРасшифровки(РасшифровкаСтроки, ПолеТД, ВысотаЗаголовка, СтандартнаяОбработка) Экспорт
	
	// Добавление расшифровки из колонки
	Если ТипЗнч(РасшифровкаСтроки) = Тип("Структура") Тогда
		
		// Расшифровка колонки находится в заголовке колонки
		РасшифровкаКолонки = ПолеТД.Область(ВысотаЗаголовка+2, ПолеТД.ТекущаяОбласть.Лево).Расшифровка;

		Расшифровка = Новый Структура;

		Для каждого Элемент Из РасшифровкаСтроки Цикл
			Расшифровка.Вставить(Элемент.Ключ, Элемент.Значение);
		КонецЦикла;

		Если ТипЗнч(РасшифровкаКолонки) = Тип("Структура") Тогда

			Для каждого Элемент Из РасшифровкаКолонки Цикл
				Расшифровка.Вставить(Элемент.Ключ, Элемент.Значение);
			КонецЦикла;

		КонецЕсли; 

		ОбщийОтчет.ОбработкаРасшифровкиСтандартногоОтчета(Расшифровка, СтандартнаяОбработка, ЭтотОбъект);

	КонецЕсли;
	
КонецПроцедуры // ОбработкаРасшифровки()

// Формирует структуру, в которую складываются настройки
//
Функция СформироватьСтруктуруДляСохраненияНастроек(ПоказыватьЗаголовок) Экспорт
	
	СтруктураНастроек = Новый Структура;
	
	ОбщийОтчет.СформироватьСтруктуруДляСохраненияНастроек(СтруктураНастроек, ПоказыватьЗаголовок);
	
	Возврат СтруктураНастроек;
	
КонецФункции

// Заполняет настройки из структуры - кроме состояния панели "Отбор"
//
Процедура ВосстановитьНастройкиИзСтруктуры(СохраненныеНастройки, ПоказыватьЗаголовок, Отчет=Неопределено) Экспорт
	
	// Если отчет, вызвавший порцедуру, не передан, то считаем, что ее вызвал этот отчет
	Если Отчет = Неопределено Тогда
		Отчет = ЭтотОбъект;
	КонецЕсли;

	ОбщийОтчет.ВосстановитьНастройкиИзСтруктуры(СохраненныеНастройки, ПоказыватьЗаголовок, Отчет);
	
КонецПроцедуры

ОбщийОтчет.ИмяРегистра = "Продажи";