Процедура ВыполнитьВыгрузку(Реализация = неопределено) экспорт
	Запрос = новый Запрос;
	Запрос.Текст="ВЫБРАТЬ РАЗЛИЧНЫЕ
	             |	РеализацияТоваровУслугИзменения.Ссылка
	             |ПОМЕСТИТЬ втРеализации
	             |ИЗ
	             |	Документ.РеализацияТоваровУслуг.Изменения КАК РеализацияТоваровУслугИзменения
	             |ГДЕ
	             |	РеализацияТоваровУслугИзменения.Узел = &Узел
	             |	И 99 = 99
	             |	И РеализацияТоваровУслугИзменения.Ссылка.Дата >= &Месяц
	             |;
	             |
	             |////////////////////////////////////////////////////////////////////////////////
	             |ВЫБРАТЬ РАЗЛИЧНЫЕ
	             |	втРеализации.Ссылка КАК Реализация,
	             |	втРеализации.Ссылка.Номер КАК РеализацияНомер
	             |ИЗ
	             |	втРеализации КАК втРеализации,
	             |	РегистрСведений.СоответствиеКонтрагентовСкладамФРан КАК СоответствиеКонтрагентовСкладамФРан
	             |ГДЕ
	             |	втРеализации.Ссылка.Проведен
	             |	И НЕ СоответствиеКонтрагентовСкладамФРан.КодСоответствияВБазеФР = """"
	             |
	             |СГРУППИРОВАТЬ ПО
	             |	втРеализации.Ссылка,
	             |	втРеализации.Ссылка.Номер";
				 
				 Запрос.УстановитьПараметр("Узел",ПланыОбмена.ПланОбменаУТ_Франчайзи.НайтиПоКоду("000000002"));
				 Запрос.УстановитьПараметр("Месяц",ДобавитьМесяц(ТекущаяДата(),-1));


				 Если Реализация <> неопределено тогда
					 Запрос.Текст = СтрЗаменить(Запрос.Текст,"99 = 99","РеализацияТоваровУслугИзменения.Ссылка = &Ссылка");
					 Запрос.УстановитьПараметр("Ссылка", Реализация);
				 КонецЕсли;
				 
				 Рез = Запрос.Выполнить().Выгрузить();
				 
				 ВыгрузитьРеализации(Рез);
				 
КонецПроцедуры


Процедура ВыгрузитьРеализации(СписокРеализаций)
	Пользователь="FormulaWS";
	Пароль="2vCCpV";
	
	//Определение = Новый WSОпределения("http://37.1.84.50:8083/v83ib_franch_ut_copy/ws/WSFranch18?wsdl",Пользователь,Пароль);
	//Определение = Новый WSОпределения("http://37.1.84.50:8083/TorgFranch/ws/WSFranch?wsdl",Пользователь,Пароль);
	
	//Прокси = новый WSПрокси(Определение, "www.franch18.yst", "WSFranch18", "WSFranch18Soap");       
	
	Прокси = WSссылки.WSFranch18.СоздатьWSПрокси("www.franch18.yst", "WSFranch18", "WSFranch18Soap");
	Прокси.Пользователь = Пользователь;
	Прокси.Пароль = Пароль;
	//
	ТипXDTOРезультатОперации = Прокси.ФабрикаXDTO.Тип("www.franch18.yst", "Result");
	
	ТипXDTOТовары = Прокси.ФабрикаXDTO.Тип("www.franch18.yst", "Goods");
	ТипXDTOТовар = Прокси.ФабрикаXDTO.Тип("www.franch18.yst", "Product");
	ТипXDTOЗаказы = Прокси.ФабрикаXDTO.Тип("www.franch18.yst", "Orders");
	ТипXDTOЗаказ = Прокси.ФабрикаXDTO.Тип("www.franch18.yst", "Order");
	

	Для каждого стрРеализация из СписокРеализаций цикл
		РезультатОперации = Прокси.ФабрикаXDTO.Создать(ТипXDTOРезультатОперации);
		Товары = Прокси.ФабрикаXDTO.Создать(ТипXDTOТовары);
		Заказы = Прокси.ФабрикаXDTO.Создать(ТипXDTOЗаказы);
		
		Для каждого стр из стрРеализация.Реализация.Товары цикл
			товар = Прокси.ФабрикаXDTO.Создать(ТипXDTOТовар);
			Товар.Code = стр.Номенклатура.Код;
			Товар.Quantity = стр.Количество;
			Товары.Products.Добавить(Товар);
		КонецЦикла;
		
		СписокЗаказов = новый СписокЗначений;
		ЗаказПокупателя = стрРеализация.Реализация.Сделка;
		
		Если ЗаказПокупателя.Заказы.Количество()>0 тогда
			Для каждого стр из ЗаказПокупателя.Заказы цикл
				СписокЗаказов.Добавить(стр.ЗаказПокупателя,стр.ЗаказПокупателя);
			КонецЦикла;
		иначе
			СписокЗаказов.Добавить(ЗаказПокупателя);
		КонецЕсли;
		
		Для каждого эл из СписокЗаказов цикл
			Заказ = Прокси.ФабрикаXDTO.Создать(ТипXDTOЗаказ);
			Заказ.GUID = "" + эл.Значение.УникальныйИдентификатор();
			Заказ.Number = эл.Значение.Номер;
			Заказы.Order.Добавить(Заказ);
		КонецЦикла;
		
		//КодТочки = получитьТочкуПоСкладу(стрПеремещение.ПеремещениеСкладПолучатель);
		КодТочки = ЗаказПокупателя.НомерТорговойТочкиКонтрагента;
		
		Результат = Прокси.CreateReceipts(Заказы,Товары,Формат(КодТочки,"ЧГ=0"),""+стрРеализация.Реализация.УникальныйИдентификатор(),стрРеализация.РеализацияНомер);
		
		Если Результат.Success тогда
			ПланыОбмена.УдалитьРегистрациюИзменений(ПланыОбмена.ПланОбменаУТ_Франчайзи.НайтиПоКоду("000000002"),стрРеализация.Реализация);
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры


Функция получитьТочкуПоСкладу(склад)
	Запрос = новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
	               |	СоответствиеКонтрагентовСкладамФРан.Точка.Номер как ТочкаНомер
	               |ИЗ
	               |	РегистрСведений.СоответствиеКонтрагентовСкладамФРан КАК СоответствиеКонтрагентовСкладамФРан
	               |ГДЕ
	               |	СоответствиеКонтрагентовСкладамФРан.Склад = &Склад";
				   Запрос.УстановитьПараметр("Склад",склад);
				   Рез = Запрос.Выполнить().Выбрать();
				   
				   Пока Рез.Следующий() Цикл
					   Возврат Рез.ТочкаНомер;
				   КонецЦикла;
				   Возврат 0;
КонецФункции