
Процедура КнопкаВыполнитьНажатие(Кнопка)
	
	Если ЗначениеНеЗаполнено(ПользовательПриемник) ИЛИ  ЗначениеНеЗаполнено(ПользовательОтправитель)  Тогда
		Сообщить("Необходимо заполнить пользователей с кого и на кого");
//Возврат;
	КонецЕсли;	
	
	 Запрос = Новый Запрос;
	 Запрос.Текст="ВЫБРАТЬ
	              |	ДоговорыКонтрагентов.Ссылка КАК Договор,
	              |	ДоговорыКонтрагентов.Владелец КАК Владелец
	              |ИЗ
	              |	Справочник.ДоговорыКонтрагентов КАК ДоговорыКонтрагентов
	              |ГДЕ
|"+?(ЗначениеЗаполнено(ПользовательОтправитель), "ДоговорыКонтрагентов.ОтветственноеЛицо = &ОтветственноеЛицо","")+"
			
    |//КОНТР ДоговорыКонтрагентов.Владелец в (&СписокКонтр)
				  
	              |УПОРЯДОЧИТЬ ПО
	              |	Владелец,
	              |	ДоговорыКонтрагентов.Код УБЫВ
	              |АВТОУПОРЯДОЧИВАНИЕ" ;
	Если СписокКонтр.Количество()>0 тогда
	Запрос.УстановитьПараметр("СписокКонтр",СписокКонтр);
	Запрос.Текст=стрЗаменить(Запрос.Текст, "//КОНТР",?(ЗначениеЗаполнено(ПользовательОтправитель)," И ","") );
	КонецЕсли;
	 Запрос.УстановитьПараметр("ОтветственноеЛицо", ПользовательОтправитель);
	 
	 Выборка=Запрос.Выполнить().Выбрать();
	 
	 Если Вопрос("Вы уверены, что хотите "+?(Флажок1, "создать новые договора по ","перенести Все ")+строка(Выборка.Количество())
		 +?(Флажок1," договорам", " договора")+?(СписокКонтр.Количество()>0,"по "+строка(СписокКонтр.Количество())+" контрагентам","") + " 
	 |с "+ строка(ПользовательОтправитель)+"
	 |на"+ строка(ПользовательПриемник)+" ?", РежимДиалогаВопрос.ДаНет, 10) = КодВозвратаДиалога.Нет тогда
	 возврат
 	 КонецЕсли;
 
	 контр = неопределено;  k=0; N=0;
	 Пока Выборка.Следующий() Цикл
		ОбработкаПрерыванияПользователя(); 
		 Если Флажок1 тогда
			 если контр = Выборка.Владелец тогда 
				 k=k+1; продолжить; // только 1 договор на 1 контрагента! 
			 иначе
				 контр = Выборка.Владелец;
				 //проверка уже существующиего договора на ПользовательПриемник для Выборка.Владелец 
				  ссылка1 = ЕщеНетДоговора(контр, ПользовательПриемник);
				если ссылка1.пустая() тогда
				  ДоговорОбъект = справочники.ДоговорыКонтрагентов.СоздатьЭлемент();
			  	  ДоговорОбъект.Номер = "";//автонумерация 
				иначе k=k+1;
				  ДоговорОбъект = ссылка1.ПолучитьОбъект();
				  сообщить("Уже существует ""Договор продажи"" "+ДоговорОбъект.Код+" для "+строка(контр)+"  с осн.менеджером "+строка(ПользовательПриемник), СтатусСообщения.Внимание); 
				  продолжить;
				КонецЕсли;
				//  ЗаполнитьЗначенияСвойств( ДоговорОбъект, Выборка.Договор );//все реквизиты такие же???
				  ДоговорОбъект.ОтветственноеЛицо = ПользовательПриемник;
				  ДоговорОбъект.Владелец    = контр;
				  
			  	  ДоговорОбъект.Наименование= "Договор продажи";  //безнал
				  ДоговорОбъект.ВидДоговора = Перечисления.ВидыДоговоровКонтрагентов.СПокупателем;
				  ДоговорОбъект.ТипДоговора = Справочники.ТипыДоговоров.НайтиПоКоду("00004"); //Отсрочка
				  ДоговорОбъект.ВедениеВзаиморасчетов = Перечисления.ВедениеВзаиморасчетовПоДоговорам.ПоЗаказам;
				  
				  ДоговорОбъект.ВалютаВзаиморасчетов  = справочники.Валюты.НайтиПоКоду("643");
				  ДоговорОбъект.Организация = справочники.Организации.НайтиПоКоду("00001");
				  //ДоговорОбъект.Номер = "";
				  //ДоговорОбъект.Дата  = '00010101';
				  //ДоговорОбъект.ДатаОкончанияДействия  = '00010101';
				  
				  ДоговорОбъект.ДатаСозданияДоговора   = ТекущаяДата();
				  
			 КонецЕсли;
		 Иначе //==================================================================================
			 ДоговорОбъект=Выборка.Договор.ПолучитьОбъект();
			 
		 //+++( 18.09.2018
			 Если УдалятьПустые тогда 
				флНетДзКз = НетДзКз(Выборка.Договор);
				Если флНетДзКз тогда
					ДоговорОбъект.ПометкаУдаления = Истина;		
				 	сообщить(строка(ДоговорОбъект.Код)+" '"+ДоговорОбъект.Наименование+"' по клиенту: "+строка(ДоговорОбъект.Владелец)+" НЕТ ДЗ/КЗ - договор УДАЛЁН!", СтатусСообщения.Информация);  // , менеджер не изменен
					//переносить все равно надо! для просмотра и редактирования заказов...
			    КонецЕсли;
			 КонецЕсли;
		//+++)
		
			 Если Флажок2 тогда
				 пп = найти(ДоговорОбъект.Наименование,"(");
				 Если пп>0 тогда
					ДоговорОбъект.Наименование = лев(ДоговорОбъект.Наименование, пп-1)
						+"("+СокрЛП(ДоговорОбъект.ОтветственноеЛицо.Код)+")"; 
				 Иначе	 
				 	ДоговорОбъект.Наименование = ДоговорОбъект.Наименование
					    +"("+СокрЛП(ДоговорОбъект.ОтветственноеЛицо.Код)+")";
				 КонецЕсли;	
			 КонецЕсли;
			 
			 ДоговорОбъект.Комментарий ="# "+формат(ТекущаяДата(),"ДЛФ=D")+" "+СокрЛП(ДоговорОбъект.ОтветственноеЛицо.Код)+">> "+ДоговорОбъект.Комментарий;
			 
			 ДоговорОбъект.ОтветственноеЛицо = ПользовательПриемник;
		
		 КонецЕсли;
		 
		 попытка
			 ДоговорОбъект.Записать();
			 
			 сообщить(строка(ДоговорОбъект.Код)+" '"+ДоговорОбъект.Наименование+"' по клиенту: "+строка(ДоговорОбъект.Владелец)+" изменен менеджер.", СтатусСообщения.Информация);
			 N=N+1;
		 
		 исключение
			 сообщить("Ошибка при записи договора "+строка(ДоговорОбъект.Код)+" "+ДоговорОбъект.Наименование+" по клиенту "+строка(ДоговорОбъект.Владелец)+" "+ОписаниеОшибки(), СтатусСообщения.Внимание);
		 КонецПопытки;	 
		 
	 КонецЦикла;	 
	 Сообщить(строка(N)+" Договоров контрагентов "+?(Флажок1,"cоздано для ","перенесены на ")+строка(ПользовательПриемник)+"
	 |Отменить действие можно через групп.обработку, отбор по новому Ответственному и комментарию: ""# "+формат(ТекущаяДата(),"ДЛФ=D")+" "+СокрЛП(ПользовательОтправитель.Код)+">>"" ");
	 
	 
	 
Если не Флажок1 тогда	 
	  Запрос.Текст="ВЫБРАТЬ
	 |	Ссылка Контрагент
	 |ИЗ  	Справочник.Контрагенты
	 |ГДЕ 
	 |"+?(ЗначениеЗаполнено(ПользовательОтправитель),"ОсновнойМенеджерКонтрагента = &ОтветственноеЛицо","")+"
     |//КОНТР  Ссылка в (&СписокКонтр)
     |" ;
	Если СписокКонтр.Количество()>0 тогда
		Запрос.УстановитьПараметр("СписокКонтр",СписокКонтр);
		Запрос.Текст=стрЗаменить(Запрос.Текст, "//КОНТР",?(ЗначениеЗаполнено(ПользовательОтправитель)," И ",""));
	КонецЕсли;
	 
	 Запрос.УстановитьПараметр("ОтветственноеЛицо", ПользовательОтправитель);
	 
	 Выборка=Запрос.Выполнить().Выбрать();
	 
	 Если Вопрос("Вы уверены, что хотите изменить основного менедежера для "+строка(Выборка.Количество())+" контрагентов
	     |на"+ строка(ПользовательПриемник)+" ?", РежимДиалогаВопрос.ДаНет, 10) = КодВозвратаДиалога.Нет тогда
	 возврат
 	 КонецЕсли;
	 
	 N=0;
	 Пока Выборка.Следующий() Цикл
		 
		 ДоговорОбъект=Выборка.Контрагент.ПолучитьОбъект();
		 
		 ДоговорОбъект.ОсновнойМенеджерКонтрагента = ПользовательПриемник;
		 
		 попытка
			 ДоговорОбъект.Записать();
		 	 Сообщить(строка(ДоговорОбъект.Код)+" "+сокрЛП(ДоговорОбъект.Наименование)+" изменен осн.менеджер");
			 N=N+1;
		 исключение
		 	 Сообщить("Ошибка при записи "+строка(ДоговорОбъект.Код)+" "+сокрЛП(ДоговорОбъект.Наименование)+" : "+ОписаниеОшибки(), СтатусСообщения.Внимание);
		 КонецПопытки;	 
	 
	 КонецЦикла;
	 
	 Сообщить(строка(N)+" контрагентов ОсновнойМенеджерКонтрагента изменен на "+строка(ПользовательПриемник));
 КонецЕсли;
 
КонецПроцедуры


функция ЕщеНетДоговора(контр, ПользовательПриемник)
Запрос = Новый Запрос;
Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
               |	ДоговорыКонтрагентов.Ссылка
               |ИЗ
               |	Справочник.ДоговорыКонтрагентов КАК ДоговорыКонтрагентов
               |ГДЕ
               |	ДоговорыКонтрагентов.Владелец = &контр
               |	И ДоговорыКонтрагентов.ОтветственноеЛицо = &ОтветственноеЛицо
               |	И ДоговорыКонтрагентов.ТипДоговора = &ТипДоговора
               |	И ДоговорыКонтрагентов.ВидДоговора = &ВидДоговора";

Запрос.УстановитьПараметр("контр", контр);
Запрос.УстановитьПараметр("ОтветственноеЛицо", ПользовательПриемник);
Запрос.УстановитьПараметр("ТипДоговора", Справочники.ТипыДоговоров.НайтиПоКоду("00004"));
Запрос.УстановитьПараметр("ВидДоговора", Перечисления.ВидыДоговоровКонтрагентов.СПокупателем);

Результат = Запрос.Выполнить();
выборка1 = результат.Выбрать();

Если выборка1.Следующий() тогда
	рез = выборка1.ссылка;
иначе
	рез = справочники.ДоговорыКонтрагентов.ПустаяСсылка();
КонецЕсли;

возврат рез;	

КонецФункции	


Процедура ПриОткрытии()
	Флажок1 = ЛОЖЬ;
	Флажок2 = ЛОЖЬ; // 22.09.2016 
	УдалятьПустые = Истина; //17.09.2018
КонецПроцедуры

Процедура Кнопка1Нажатие(Элемент)
	
	спис = новый СписокЗначений;
	разделитель = ";"; 
	ВвестиСтроку(разделитель, "Разделитель");
	i=найти(СписокКодов,разделитель); L=стрДлина(СписокКодов);
	СписокКодов2="";
	пока i>0 цикл
		код1 = лев( СписокКодов, i-1);
		СписокКодов = прав(СписокКодов, L-i);
		контр1 = справочники.Контрагенты.НайтиПоКоду(код1);
		Если контр1 = справочники.Контрагенты.ПустаяСсылка() тогда
			Сообщить("Не найден контрагент по коду "+код1, СтатусСообщения.Внимание);
			СписокКодов2=СписокКодов2+код1+разделитель;
		Иначе
			спис.Добавить( контр1 );
		КонецЕсли;	
	i=найти(СписокКодов,разделитель); L=стрДлина(СписокКодов);
	КонецЦикла;	
	СписокКонтр.ЗагрузитьЗначения( спис.ВыгрузитьЗначения() );
	СписокКодов = СписокКодов2; //не найденные коды
	Предупреждение("Найдено "+строка(спис.Количество())+" контрагентов!");

КонецПроцедуры

функция НетДзКз(ДоговорКонтрагента)
Запрос = Новый Запрос; //по сделкам!
Запрос.Текст = "ВЫБРАТЬ
               |	ВзаиморасчетыСКонтрагентамиОстатки.Сделка,
               |	ВзаиморасчетыСКонтрагентамиОстатки.СуммаВзаиморасчетовОстаток,
               |	ВзаиморасчетыСКонтрагентамиОстатки.СуммаУпрОстаток
               |ИЗ
               |	РегистрНакопления.ВзаиморасчетыСКонтрагентами.Остатки(, ДоговорКонтрагента = &ДоговорКонтрагента) КАК ВзаиморасчетыСКонтрагентамиОстатки
               |";
Запрос.УстановитьПараметр("ДоговорКонтрагента", ДоговорКонтрагента);
Результат = Запрос.Выполнить();
возврат результат.Пустой();	
КонецФункции	