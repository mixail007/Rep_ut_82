
Процедура КнопкаВыполнитьНажатие(Кнопка)
   Ex = Новый COMObject("Excel.Application");
   Если ЗначениеЗаполнено(ПутьКФайлу) Тогда
	   Ex.Workbooks.Open(ПутьКФайлу);
   Иначе
       Ex.Workbooks.Open("");
   КонецЕсли;
   Ex.Visible = 0;    
 //  ТекЛист=Ex.WorkSheets(1);
   CountList=Ex.WorkSheets.Count;
   
   
   КЧ = Новый КвалификаторыЧисла(12,2);
   КС = Новый КвалификаторыСтроки(20);
   КД = Новый КвалификаторыДаты();
   Массив = Новый Массив;
   Массив.Добавить(Тип("Дата"));
   ОписаниеТиповД = Новый ОписаниеТипов(Массив, , КД);
   Массив = Новый Массив;
   Массив.Добавить(Тип("Строка"));
   ОписаниеТиповС = Новый ОписаниеТипов(Массив, , КС);
   Массив.Очистить();
   Массив.Добавить(Тип("Число"));
   ОписаниеТиповЧ = Новый ОписаниеТипов(Массив, , ,КЧ);

   ТЗ = Новый ТаблицаЗначений;
   ТЗ.Колонки.Добавить("Дата",ОписаниеТиповД);
   Тз.Колонки.Добавить("НомерСотрудника",ОписаниеТиповС);
   Тз.Колонки.Добавить("НомерАбонента",ОписаниеТиповС);
   Тз.Колонки.Добавить("ДлительностьЗвонка",ОписаниеТиповЧ);
   Тз.Колонки.Добавить("Исход_Вход",ОписаниеТиповС);
   
   для СчЛист = 1 по CountList цикл        // бежим по листам
	   
	   ТекЛист = Ex.WorkSheets(СчЛист);
	   КолС=ТекЛист.UsedRange.SpecialCells(11).Row;
	   Состояние("Обработка " + СчЛист + " листа...", СчЛист/CountList *100 );
	   
	   Для Ячейка = 1 по КолС цикл
		   Если Найти(ТекЛист.Cells(Ячейка,1).Value,"Сетевой ресурс")>0 тогда
			   МенеджерТелефон = прав(ТекЛист.Cells(Ячейка,3).Value,11);
		   иначеЕсли ТипЗнч(ТекЛист.Cells(Ячейка,1).Value) = Тип("Строка") и ПроверитьНаличиеРусскихБукв(ТекЛист.Cells(Ячейка,7).Value) = истина и СтрДлина(ТекЛист.Cells(Ячейка,7).Value) > 5  и найти(ТекЛист.Cells(Ячейка,7).Value,"Телеф")>0 тогда
			   запись = Тз.Добавить();
			   массивДата = РазложитьСтрокуВМассивПодстрок(ТекЛист.Cells(Ячейка,1).Value,".");
			   массивВремя = РазложитьСтрокуВМассивПодстрок(ТекЛист.Cells(Ячейка,2).Value,":");
			   ЕСли массивДата.Количество()=3 тогда
				   запись.Дата = Дата(массивДата[2],массивДата[1],массивДата[0],массивВремя[0],массивВремя[1],массивВремя[2]); //)+ТекЛист.Cells(Ячейка,4).Value*86400;
			   КонецЕсли;
			   запись.НомерСотрудника = СтрЗаменить(Прав(МенеджерТелефон,10),"+7","8");
			   запись.НомерАбонента = СтрЗаменить(Прав(СтрЗаменить(ТекЛист.Cells(Ячейка,4).Value,Символы.НПП,""),10),"+7","8");
			   Если ТипЗнч(ТекЛист.Cells(Ячейка,9).Value) = Тип("Строка") Тогда
				   массивДлит = РазложитьСтрокуВМассивПодстрок(ТекЛист.Cells(Ячейка,9).Value,":");
				   ЕСли массивДлит.Количество()=2 тогда
					   Длит =число( массивДлит[0]) * 60 + число( массивДлит[1]); //)+ТекЛист.Cells(Ячейка,4).Value*86400;
				   иначе
					    Длит =число( массивДлит[0]) * 60 ; //)+ТекЛист.Cells(Ячейка,4).Value*86400;
				   КонецЕсли;
			   Иначе
				   Длит = Число(ТекЛист.Cells(Ячейка,9).Value);
			   КонецЕсли;
			  // запись.ДлительностьЗвонка = ?(найти(ТекЛист.Cells(Ячейка,8).Value,"Минута")>0,Число(Длит)*60,Число(Длит));
			   запись.ДлительностьЗвонка = Длит;
			   
			   запись.Исход_Вход = ?(Найти(ТекЛист.Cells(Ячейка,4).Value,"<--")>0,"Входящий","Исходящий");
			   
		   конецесли;
	   конеццикла;
   КонецЦикла;
   
   Состояние("Запись..");
   Для каждого стр из ТЗ Цикл
		
			запись = РегистрыСведений.ЖурналЗвонков.СоздатьМенеджерЗаписи();
			запись.Дата = стр.Дата;
			запись.НомерСотрудника = СтрЗаменить(стр.НомерСотрудника,"%","");
			запись.НомерАбонента = СтрЗаменить(стр.НомерАбонента,"%","");
			запись.ДлительностьЗвонка = стр.ДлительностьЗвонка;
			запись.ПоискСотрудник = Прав(запись.НомерСотрудника,6);
			запись.ПоискАбонент = Прав(запись.НомерАбонента,6);
			запись.Исход_Вход = стр.Исход_Вход;
			запись.Записать();
		
	КонецЦикла;
    Ex.Application.Quit();
	
	Сообщить("ВСЁ!");
КонецПроцедуры

Процедура ПутьКФайлуНачалоВыбора(Элемент, СтандартнаяОбработка)
	Режим = РежимДиалогаВыбораФайла.Открытие; 
    ДиалогОткрытияФайла = Новый ДиалогВыбораФайла(Режим); 
    ДиалогОткрытияФайла.ПолноеИмяФайла = ""; 
	Фильтр = "Документ Microsoft Excel (*.xls)|*.xls"; 
	ДиалогОткрытияФайла.Фильтр = Фильтр; 
    ДиалогОткрытияФайла.МножественныйВыбор = Ложь; 
    ДиалогОткрытияФайла.Заголовок = "Выберите файл"; 

    Если ДиалогОткрытияФайла.Выбрать() Тогда 
        ПутьКФайлу = ДиалогОткрытияФайла.ПолноеИмяФайла; 
    КонецЕсли;
КонецПроцедуры

функция ПроверитьНаличиеАнглийскихБукв(Строка) Экспорт
            ДлинаНаименования = СтрДлина(Строка);
			ц=0;
			пока Ц < ДлинаНаименования Цикл
				ц = ц+1;
				Если Найти("zxcvbnmasdfghjklqwertyuiopZXCVBNMLKJHGFDSAQWERTYUIOP",Сред(Строка,ц,1)) > 0 Тогда
					Возврат Истина;
				КонецЕсли;
			КонецЦикла;
			Возврат Ложь;	
КонецФункции

