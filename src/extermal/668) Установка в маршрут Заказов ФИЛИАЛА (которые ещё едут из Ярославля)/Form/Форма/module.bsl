
Процедура КнопкаВыполнитьНажатие(Кнопка)
	
	для каждого стр1 из табл Цикл
		ОбработкаПрерыванияПользователя();
		если НЕ стр1.выбран тогда
			продолжить;
		КонецЕсли;
		
		закОб = стр1.Заказ.ПолучитьОбъект();
		если стр1.ДатаОтгрузки<НачалоДня(ТекущаяДата()) тогда  //нельзя ставить "на вчера"
			 датаОтгр = НачалоДня(ТекущаяДата());
		 иначе	 
			датаОтгр = стр1.ДатаОтгрузки;
		КонецЕсли;
		
		РаспределитьЗаказНаМаршрут(стр1.Заказ, датаОтгр,,,,Подразделение);
        закОб.ВМаршрут = истина;
		
		Набор = РегистрыСведений.ЗаказыМаршруты.СоздатьНаборЗаписей();
        Набор.Отбор.ЗаказПокупателя.Установить(стр1.Заказ);
        Набор.Прочитать();
		Отказ = ЛОЖЬ;
		Если Набор.Количество() > 0  Тогда
			Если Набор[0].маршрут <> Справочники.НовМаршруты.ПустаяСсылка() Тогда
		        
				//+++ 06.10.2017 - ещё раз проверяем просрочку на ДатуОтгрузки!
				Если Набор[0].Дата>закОб.ДатаОтгрузки тогда
				закОб.ДатаОтгрузки = Набор[0].Дата; //НОВАЯ ДАТА Отгрузки!
	
				ПроверитьПревышениеОбщегоЛимитаДЗСУчетомЗаказа(закОб, Отказ); // на ДатуОтгрузки может измениться!
					Если Отказ тогда
						закОб.ВМаршрут = ЛОЖЬ;
						Набор.Очистить();
						Набор.Записать(); // УДАЛЯЕМ !
					Сообщить("НЕЛЬЗЯ ставить В маршрут Заказ "+строка(закОб.Номер), СтатусСообщения.Внимание);
					КонецЕсли;
				КонецЕсли;
			
				Если закОб.ВМаршрут тогда
					Если Набор.Количество() > 1 тогда //+++ 12.10.2017
						Сообщить("ВНИМАНИЕ! Заказ "+строка(закОб.Номер)+" попал в "+строка(Набор.Количество())+" маршрута!!!" , СтатусСообщения.Внимание);
						Для ii=0 по Набор.Количество()-1 цикл
					  		Сообщить(строка(ii+1)+") Заказ попал в маршрут " + Набор[ii].маршрут.Наименование + " на дату " + Строка(Набор[ii].Дата), СтатусСообщения.Информация);
						КонецЦикла;							
					Иначе	
					Сообщить("Заказ попал в маршрут " + Набор[0].маршрут.Наименование + " на дату " + Строка(Набор[0].Дата), СтатусСообщения.Информация);
					КонецЕсли;
					
					попытка
						закОб.Записать();
					исключение
						Сообщить("ОШИБКА при установки [v] В маршрут Заказа "+строка(закОб.Номер)+" : "+ОписаниеОшибки(), СтатусСообщения.Внимание);
					КонецПопытки;
				КонецЕсли;	
   			Иначе //--------------------------- нет маршрута ---------------------------
				сообщить("Внимание!!! Заказ "+строка(закОб.Номер)+" не попал ни в один маршрут!!!", СтатусСообщения.Важное);
			КонецЕсли;
		Иначе //набор пустой
			 Сообщить("Внимание!!! Заказ  "+строка(закОб.Номер)+" не попал ни в один маршрут!!!",СтатусСообщения.Важное);
		КонецЕсли;

        стр1.ВМаршруте = закОб.ВМаршрут;
        стр1.ДатаОтгрузки = закОб.ДатаОтгрузки;
		
	КонецЦикла;	
КонецПроцедуры

Процедура КоманднаяПанель1Получить(Кнопка)
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	ЛОЖЬ КАК Выбран,
	               |	""                              "" КАК Статус,
	               |	ЗаказыПокупателей.ЗаказПокупателя КАК Заказ,
	               |	ЗаказыПокупателей.ЗаказПокупателя.ВМаршрут КАК ВМаршруте,
	               |	ЗаказыПокупателей.ЗаказПокупателя.ДатаОтгрузки КАК ДатаОтгрузки,
	               |	ЗаказыПокупателей.ДоговорКонтрагента.Владелец КАК Контрагент,
	               |	ЗаказыПокупателей.ДоговорКонтрагента.ОтветственноеЛицо КАК Менеджер,
	               |	ЗаказыПокупателей.СуммаВзаиморасчетовОстаток КАК Сумма,
	               |	ЗаказыПокупателей.ЗаказПокупателя.АдресДоставки КАК АдресДоставки,
	               |	ЗаказыПокупателей.ЗаказПокупателя.Комментарий КАК Комментарий
	               |ИЗ
	               |	РегистрНакопления.ЗаказыПокупателей.Остатки(
	               |			,
	               |			ЗаказПокупателя.Подразделение = &Подразделение
	               |				И ЗаказПокупателя.Проверен = ЛОЖЬ
	               |				И ЗаказПокупателя.ВМаршрут = ЛОЖЬ
	               |				И ЗаказПокупателя.Самовывоз = ЛОЖЬ
				   |//ДатаОтгОтбор  И ЗаказПокупателя.ДатаОтгрузки >= &ДатаНач И ЗаказПокупателя.ДатаОтгрузки <= &ДатаКон
	               |				И ЗаказПокупателя.Комментарий ПОДОБНО &ПослеПеремещения) КАК ЗаказыПокупателей
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	ДатаОтгрузки";
	
	Запрос.УстановитьПараметр("Подразделение",Подразделение );
	Запрос.УстановитьПараметр("ПослеПеремещения","%Перемещение из Ярославля >>%");
	
	//16.04.2018
	Запрос.УстановитьПараметр("ДатаНач", НачПериода);
	Запрос.УстановитьПараметр("ДатаКон", КонецДня(КонПериода) );
	Запрос.Текст = стрЗаменить(Запрос.Текст ,"//ДатаОтгОтбор", "");
	
	Результат = Запрос.Выполнить();
	Табл.Очистить();
	Табл = результат.Выгрузить();
	
	//======================Статусы====================================
	списЗак = Табл.ВыгрузитьКолонку("Заказ");
	статусы = ОбменСУТИнтернетМагазин.ПолучитьСтатусыЗаказов(списЗак);
	мСтатус = ОбменСУТИнтернетМагазин.ЗаполнитьСоответствияСтатусовЗаказов();
	Для Каждого стр1 из Табл Цикл
		стрСтат = статусы.найти( стр1.Заказ, "Заказ");
		Если стрСтат=неопределено тогда 
			 кодСтатуса = 0;
		иначе	 
			кодСтатуса = стрСтат.Статус;
	 	КонецЕсли;
			
		стр1.Статус = мСтатус.найти(кодСтатуса,"Статус").СтатусРасшифровка; // 12.04.2017

	КонецЦикла;
	
КонецПроцедуры

Процедура ПриОткрытии()
	Подразделение = глТекущийПользователь.ОсновноеПодразделение;
	Филиалы = яштПоставщики.ПолучитьМассивФилиалов();
	для i=0 по Филиалы.Количество()-1 цикл
		ЭлементыФормы.Подразделение.СписокВыбора.Добавить( Филиалы[i] );
	КонецЦикла;
НачПериода = ТекущаяДата();
КонПериода = ТекущаяДата();
КонецПроцедуры

Процедура КоманднаяПанель1Вкл(Кнопка)
	ВыбранВкл(1);
КонецПроцедуры

Процедура КоманднаяПанель1Выкл(Кнопка)
	ВыбранВкл(0);
КонецПроцедуры

процедура ВыбранВкл(тип=1)
	для каждого стр1 из табл Цикл 
		стр1.выбран = ?(тип=1, Истина, ?(тип=0, ЛОЖЬ, НЕ стр1.выбран ));
	КонецЦикла;	
КонецПроцедуры	

Процедура ТаблПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки)
	Если ДанныеСтроки.ВМаршруте тогда
		ОформлениеСтроки.ЦветФона = webЦвета.Желтый;
	КонецЕсли;	   
	Если ДанныеСтроки.Выбран тогда
		ОформлениеСтроки.Шрифт = Новый Шрифт(ОформлениеСтроки.Шрифт ,,,Истина);
	КонецЕсли;	
КонецПроцедуры

Процедура ВыбПериодНажатие(Элемент)
	НастройкаПериода = Новый НастройкаПериода;
	НастройкаПериода.РедактироватьКакИнтервал = Истина;
	НастройкаПериода.РедактироватьКакПериод = Истина;
	НастройкаПериода.ВариантНастройки = ВариантНастройкиПериода.Период;
	НастройкаПериода.УстановитьПериод(НачПериода, ?(КонПериода='0001-01-01', КонПериода, КонецДня(КонПериода)));
	Если НастройкаПериода.Редактировать() Тогда
		НачПериода = НастройкаПериода.ПолучитьДатуНачала();
		КонПериода = НастройкаПериода.ПолучитьДатуОкончания();
	КонецЕсли;
КонецПроцедуры
