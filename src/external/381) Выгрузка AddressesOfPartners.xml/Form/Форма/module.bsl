
Процедура КнопкаВыполнитьНажатие(Кнопка)
	
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("адрес",Перечисления.ТипыКонтактнойИнформации.Адрес);
	
	СписокВидов = Новый СписокЗначений;
	СписокВидов.Добавить(Справочники.ВидыКонтактнойИнформации.ЮрАдресКонтрагента);
	СписокВидов.Добавить(Справочники.ВидыКонтактнойИнформации.НайтиПоКоду("00015"));
	
	Запрос.УстановитьПараметр("СписокВидовАлресов",СписокВидов);
	Запрос.Текст = "ВЫБРАТЬ
	               |	Авторизация.Владелец
	               |ПОМЕСТИТЬ СписокКонтрагентов
	               |ИЗ
	               |	Справочник.Авторизация КАК Авторизация
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	КонтактнаяИнформация.Представление,
	               |	КонтактнаяИнформация.Вид,
	               |	КонтактнаяИнформация.Объект КАК Контрагент
	               |ПОМЕСТИТЬ ВсеАдреса
	               |ИЗ
	               |	РегистрСведений.КонтактнаяИнформация КАК КонтактнаяИнформация
	               |ГДЕ
	               |	КонтактнаяИнформация.Тип = &Адрес
	               |	И КонтактнаяИнформация.Объект В
	               |			(ВЫБРАТЬ
	               |				СписокКонтрагентов.Владелец
	               |			ИЗ
	               |				СписокКонтрагентов КАК СписокКонтрагентов)
	               |	И КонтактнаяИнформация.Вид.Наименование <> ""<не используется>""
	               |	И НЕ КонтактнаяИнформация.Вид В (&СписокВидовАлресов)
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВсеАдреса.Контрагент.Код КАК Контрагент,
	               |	ВЫРАЗИТЬ(ВсеАдреса.Представление КАК СТРОКА(200)) КАК Адрес,
	               |	Точки.Номер КАК Точка,
	               |	ВсеАдреса.Вид.Код КАК КодАдреса
	               |ПОМЕСТИТЬ АдресаСТочками
	               |ИЗ
	               |	ВсеАдреса КАК ВсеАдреса
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Точки КАК Точки
	               |		ПО ВсеАдреса.Вид = Точки.ВидАдреса
	               |			И ВсеАдреса.Контрагент = Точки.Владелец
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	АдресаСТочками.Контрагент,
	               |	АдресаСТочками.Адрес,
	               |	МАКСИМУМ(АдресаСТочками.Точка) КАК Точка,
	               |	МАКСИМУМ(АдресаСТочками.КодАдреса) КАК КодАдреса
	               |ИЗ
	               |	АдресаСТочками КАК АдресаСТочками
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	АдресаСТочками.Контрагент,
	               |	АдресаСТочками.Адрес";
	рез = Запрос.Выполнить().Выгрузить();
	
	Если Путь="" тогда
		ФайлЗапроса =ПолучитьИмяВременногоФайла("xml");
	иначе
		ФайлЗапроса = путь + ?(прав(путь,1)="\","","\") + "AddressesOfPartners.xml"; 
	КонецЕсли;

    // Записываем в файл текстовое содержимое
    // тела запроса (переменная "ТелоЗапроса")	
	Запись = Новый ЗаписьXML();

    Запись.УстановитьСтроку("UTF-8");

    Запись.ЗаписатьОбъявлениеXML();
	
	Запись.ЗаписатьНачалоЭлемента("Items");
		
	Для каждого стр из рез Цикл
		
		Если сокрЛП(стр.Адрес) <> "" Тогда
			
			Запись.ЗаписатьНачалоЭлемента("Item");
			Запись.ЗаписатьАтрибут("Address",сокрЛП(стр.Адрес));
			Запись.ЗаписатьАтрибут("PointId",?(стр.Точка<>"" и стр.Точка<>Null,СтрЗаменить(строка(стр.Точка),Символы.НПП,""),""));
			Запись.ЗаписатьАтрибут("AddressId",сокрЛП(стр.КодАдреса));
			Запись.ЗаписатьАтрибут("PartnerId",сокрЛП(стр.Контрагент));
			Запись.ЗаписатьКонецЭлемента(); 
			
		КонецЕсли;
		
	КонецЦикла;
	
	Запись.ЗаписатьКонецЭлемента(); // Items

    ТелоЗапроса = Запись.Закрыть();
	
    ТекстовыйФайл = Новый ТекстовыйДокумент;
    ТекстовыйФайл.УстановитьТекст(ТелоЗапроса);           
    ТекстовыйФайл.Записать(ФайлЗапроса, КодировкаТекста.UTF8);
   сообщить(ФайлЗапроса);
КонецПроцедуры
