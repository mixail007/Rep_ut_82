

Процедура ПрочитатьТабличныйДокументИзExcel( ИмяФайла) Экспорт
	
	xlLastCell = 11;
	
	ВыбФайл = Новый Файл(ИмяФайла);
	Если НЕ ВыбФайл.Существует() Тогда
		Сообщить("Файл не существует!");
		Возврат;
	КонецЕсли;
	
	Попытка
		Excel = Новый COMОбъект("Excel.Application");
		Excel.WorkBooks.Open(ИмяФайла);
		Состояние("Обработка файла Microsoft Excel...");
		ExcelЛист = Excel.Sheets(1);
	Исключение
		Сообщить("Ошибка. Возможно неверно указан номер листа книги Excel.");
		Возврат;
		
	КонецПопытки;
	
	
	
	ActiveCell = Excel.ActiveCell.SpecialCells(xlLastCell);
	RowCount = ActiveCell.Row;
	ColumnCount = ActiveCell.Column;
	
	СтрокаМенеджер=СокрЛП(Строка(ExcelЛист.Cells(4,4).Value));
	СтрокаКонтрагент=СокрЛП(Строка(ExcelЛист.Cells(5,4).Value));;
	СтрокаНомерАвто=СокрЛП(Строка(ExcelЛист.Cells(6,4).Value));;
	
	ДокЗаказ=Документы.ЗаказПоОтветственномуХранению.СоздатьДокумент();
	Если СокрЛП(Строка(ExcelЛист.Cells(2,5).Value))="на списание" Тогда
	ДокЗаказ.ВидОперации=Перечисления.ВидыОперацийПоОтветственномуХранению.Списание;
	Иначе
	ДокЗаказ.ВидОперации=Перечисления.ВидыОперацийПоОтветственномуХранению.Поступление;
	КонецЕсли;
	ДокЗаказ.Дата=ТекущаяДата();
	ДокЗаказ.Контрагент=Справочники.Контрагенты.НайтиПоКоду("91640");
	ДокЗаказ.ДоговорКонтрагента=Справочники.ДоговорыКонтрагентов.НайтиПоКоду("F2349");
	ДокЗаказ.Комментарий=СтрокаМенеджер+" / "+ СтрокаКонтрагент+ "/"+ СтрокаНомерАвто;
	
	
	
	Для сч=1 по RowCount Цикл
		ПредполагаемыйКод=СтрЗаменить(СокрЛП(Строка(ExcelЛист.Cells(сч,2).Value)),Символ(160),"");
		
		Если не ЗначениеНеЗаполнено(ПредполагаемыйКод) Тогда
			Если не ЗначениеНеЗаполнено(Справочники.Номенклатура.НайтиПоКоду(ПредполагаемыйКод)) Тогда
				НачалоЗахваченногоНомера=сч;
                Прервать;
			КонецЕсли;	
		КОнецЕсли;	
	КонецЦикла;	
	
	
	Для Row = НачалоЗахваченногоНомера По RowCount Цикл	
		// определяем номенклатуру
			//ПредполагаемыйКод=Строка(ExcelЛист.Cells(Row,2).Value);
			ПредполагаемыйКод=СтрЗаменить(СокрЛП(Строка(ExcelЛист.Cells(Row,2).Value)),Символ(160),"");
			ПрефиксКод="";
			Если СтрДлина(ПредполагаемыйКод) <7 Тогда // лидирующие нули обрезаются, добавим их
				Для сч=СтрДлина(ПредполагаемыйКод)+1 по 7 Цикл
					ПрефиксКод=ПрефиксКод+"0";
				КонецЦикла;	
			КонецЕсли;	
				
				ПредполагаемыйКод=ПрефиксКод+ПредполагаемыйКод;
				
			    Номенклатура=Справочники.Номенклатура.НайтиПоКоду(ПредполагаемыйКод);
			Если ЗначениеНеЗаполнено(Номенклатура) Тогда
				//Сообщить("Не найдена номенклатура по коду в колонке №" + Строка(ЗахваченныйНомерКолонки)+", в строке №" +Строка(Row));
				Продолжить;
			КонецЕсли;	
			Попытка 
				ПредполагаемоеКоличествоСтрока=СокрЛП(Строка(ExcelЛист.Cells(Row,6).Value));
				
				ПредполагаемоеСуммаСтрока=СокрЛП(Строка(ExcelЛист.Cells(Row,7).Value));
				Если СокрЛП(ПредполагаемоеКоличествоСтрока)<>"" Тогда
					КоличествоЗаказать=Число(ПредполагаемоеКоличествоСтрока);
				Иначе
					КоличествоЗаказать=0;
				КонецЕсли;
				Если СокрЛП(ПредполагаемоеСуммаСтрока)<>"" И ДокЗаказ.ВидОперации=Перечисления.ВидыОперацийПоОтветственномуХранению.Поступление Тогда // получаем залоговую сумму	
					СуммаЗаказать=Число(ПредполагаемоеСуммаСтрока);
				Иначе	
					СуммаЗаказать=0;
				КонецЕсли;	
				Исключение
				Сообщить("В строке №" +Строка(Row)+"содержится неверный формат числа.");
				
				Продолжить;
			КонецПопытки;
			
		//Сообщить(КоличествоЗаказать);	
		Если КоличествоЗаказать>0 Тогда		
	       СтрТовары=ДокЗаказ.Товары.Добавить();
		   СтрТовары.Номенклатура= Номенклатура;
		   СтрТовары.Количество=КоличествоЗаказать;
		   СтрТовары.Цена=СуммаЗаказать;
		   СтрТовары.Сумма=СуммаЗаказать*КоличествоЗаказать;
		КонецЕсли; 
	КонецЦикла;	
	
	
	
	Excel.WorkBooks.Close();
	Excel = 0;
	
		
	ДокЗаказ.ПолучитьФорму().Открыть();
	
КонецПроцедуры

Процедура Кнопка1Нажатие(Элемент)
		ДиалогВыбораФайла = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	
	ДиалогВыбораФайла.Заголовок = "Прочитать табличный документ из файла";
	ДиалогВыбораФайла.Фильтр    = "Лист Excel (*.xls)|*.xls";
	Если ДиалогВыбораФайла.Выбрать() Тогда
		
//		ТабличныйДокумент = ЭлементыФормы.ТабличныйДокумент;
		ФайлНаДиске = Новый Файл(ДиалогВыбораФайла.ПолноеИмяФайла);
		Если нРег(ФайлНаДиске.Расширение) = ".xls" Тогда
			ПрочитатьТабличныйДокументИзExcel(ДиалогВыбораФайла.ПолноеИмяФайла);
		КонецЕсли;
		
	КонецЕсли;

КонецПроцедуры









