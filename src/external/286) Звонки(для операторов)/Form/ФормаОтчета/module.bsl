Перем СтруктураПоиска;

Процедура КнопкаСформироватьНажатие(Кнопка)
	Начало=ТекущаяДата();
	тз=Новый ТаблицаЗначений;
	тз.Колонки.Добавить("calldate",Новый ОписаниеТипов("Дата"));
	тз.Колонки.Добавить("День",Новый ОписаниеТипов("Дата"));
	тз.Колонки.Добавить("Абонент",Новый ОписаниеТипов("Строка",,,,Новый КвалификаторыСтроки(120)));
	тз.Колонки.Добавить("АбонентФизЛицо",Новый ОписаниеТипов("СправочникСсылка.ФизическиеЛица"));
	тз.Колонки.Добавить("Номер",Новый ОписаниеТипов("Строка",,,,Новый КвалификаторыСтроки(120)));
	тз.Колонки.Добавить("billsec",Новый ОписаниеТипов("Число",,,,Новый КвалификаторыЧисла(6,0)));
	тз.Колонки.Добавить("Входящий",Новый ОписаниеТипов("Булево"));
	тз.Колонки.Добавить("Пропущен",Новый ОписаниеТипов("Булево"));
	тз.Колонки.Добавить("Перезвонили",Новый ОписаниеТипов("Булево"));
	тз.Колонки.Добавить("Примечание",Новый ОписаниеТипов("Строка",,,,Новый КвалификаторыСтроки(0)));
	
	тзЗвонкиЗаДень=Новый ТаблицаЗначений;
	тзЗвонкиЗаДень.Колонки.Добавить("calldate",Новый ОписаниеТипов("Дата"));
	тзЗвонкиЗаДень.Колонки.Добавить("День",Новый ОписаниеТипов("Дата"));
	тзЗвонкиЗаДень.Колонки.Добавить("Абонент",Новый ОписаниеТипов("Строка",,,,Новый КвалификаторыСтроки(20)));
	тзЗвонкиЗаДень.Колонки.Добавить("Номер",Новый ОписаниеТипов("Строка",,,,Новый КвалификаторыСтроки(20)));
	тзЗвонкиЗаДень.Колонки.Добавить("billsec",Новый ОписаниеТипов("Число",,,,Новый КвалификаторыЧисла(6,0)));
	тзЗвонкиЗаДень.Колонки.Добавить("Входящий",Новый ОписаниеТипов("Булево"));
	тзЗвонкиЗаДень.Колонки.Добавить("Пропущен",Новый ОписаниеТипов("Булево"));
	тзЗвонкиЗаДень.Колонки.Добавить("Перезвонили",Новый ОписаниеТипов("Булево"));
	тзЗвонкиЗаДень.Колонки.Добавить("Контрагент",Новый ОписаниеТипов("Строка",,,,Новый КвалификаторыСтроки(100)));
	тзЗвонкиЗаДень.Колонки.Добавить("АбонентФизЛицо",Новый ОписаниеТипов("СправочникСсылка.ФизическиеЛица"));
	тзЗвонкиЗаДень.Колонки.Добавить("Примечание",Новый ОписаниеТипов("Строка",,,,Новый КвалификаторыСтроки(0)));

	Запрос = новый Запрос;
	Запрос.Текст="ВЫБРАТЬ
	             |	dbo_ЖурналЗвонков.calldate КАК calldate,
	             |	ВЫБОР
	             |		КОГДА dbo_ЖурналЗвонков.src = """"
	             |			ТОГДА ""N/A""
	             |		ИНАЧЕ dbo_ЖурналЗвонков.src
	             |	КОНЕЦ КАК src,
	             |	ВЫБОР
	             |		КОГДА dbo_ЖурналЗвонков.dst = """"
	             |			ТОГДА ""N/A""
	             |		ИНАЧЕ dbo_ЖурналЗвонков.dst
	             |	КОНЕЦ КАК dst,
	             |	dbo_ЖурналЗвонков.uniqueid,
	             |	dbo_ЖурналЗвонков.disposition,
	             |	dbo_ЖурналЗвонков.lastapp,
	             |	dbo_ЖурналЗвонков.billsec,
	             |	ВЫРАЗИТЬ(dbo_ЖурналЗвонков.uniqueid КАК СТРОКА(10)) КАК uniqueid1,
	             |	ВЫБОР
	             |		КОГДА dbo_ЖурналЗвонков.src ПОДОБНО ""___""
	             |			ТОГДА ИСТИНА
	             |		ИНАЧЕ ЛОЖЬ
	             |	КОНЕЦ КАК ИсхВнутренний,
	             |	ВЫБОР
	             |		КОГДА dbo_ЖурналЗвонков.dst ПОДОБНО ""___""
	             |			ТОГДА ИСТИНА
	             |		ИНАЧЕ ЛОЖЬ
	             |	КОНЕЦ КАК ВхВнутренний,
	             |	НАЧАЛОПЕРИОДА(dbo_ЖурналЗвонков.calldate, ДЕНЬ) КАК День,
	             |	dbo_ЖурналЗвонков.note КАК Примечание
	             |ИЗ
	             |	ВнешнийИсточникДанных.ВнешнийИсточникДанныхЗвонки.Таблица.dbo_ЖурналЗвонков КАК dbo_ЖурналЗвонков
	             |ГДЕ
	             |	dbo_ЖурналЗвонков.calldate МЕЖДУ &ДатаН И &ДатаК
	             |	И (dbo_ЖурналЗвонков.src ПОДОБНО ""___""
	             |			ИЛИ dbo_ЖурналЗвонков.dst ПОДОБНО ""___"")
	             |	И &Условие = ИСТИНА
	             |ИТОГИ ПО
	             |	uniqueid1,
	             |	src";
				 
				 УсловиеТолькоВнешние="	 И (dbo_ЖурналЗвонков.dst ПОДОБНО ""___""
				 |				И (НЕ dbo_ЖурналЗвонков.src ПОДОБНО ""___"")
				 |			ИЛИ (НЕ dbo_ЖурналЗвонков.dst ПОДОБНО ""___"")
				 |				И dbo_ЖурналЗвонков.src ПОДОБНО ""___"")";

				 Если  флТолькоВнешние тогда
					 Запрос.Текст=СтрЗаменить(Запрос.Текст,"И &Условие = ИСТИНА",УсловиеТолькоВнешние);
				 КонецЕсли; 

	Запрос.УстановитьПараметр("ДатаН",?(ЗначениеЗаполнено(НачПериода),НачПериода,Дата(2013,1,1)));
	Запрос.УстановитьПараметр("Датак",?(ЗначениеЗаполнено(КонПериода),КонецДня(КонПериода),ТекущаяДата()));
	Запрос.УстановитьПараметр("Условие",истина);
	ВыборкаUniqueid1=Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	Пока ВыборкаUniqueid1.Следующий() цикл
		Выборкаsrc=ВыборкаUniqueid1.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		Пока Выборкаsrc.Следующий() Цикл
			Детали=Выборкаsrc.Выбрать();
			Если Детали.НайтиСледующий(СтруктураПоиска) тогда//кто то ответил на звонок
				ЕстьОтвет=истина;
			Иначе
				ЕстьОтвет=Ложь;
			КонецЕсли;	 
			Детали.Сбросить();
			
			Пока Детали.Следующий() цикл
				Если (ЕстьОтвет и Детали.disposition="NO ANSWER") 
					или СтрДлина(СокрЛП(Детали.dst))=1 
					или СтрДлина(СокрЛП(Детали.dst))=2 
					или СтрДлина(СокрЛП(Детали.dst))=4 
					или СтрДлина(СокрЛП(Детали.dst))=5 
					или Найти(Детали.dst,"*")<>0 
					или СтрДлина(СокрЛП(Детали.src))=1 
					или СтрДлина(СокрЛП(Детали.src))=2 
					или СтрДлина(СокрЛП(Детали.src))=4 
					или СтрДлина(СокрЛП(Детали.src))=5 тогда
				Иначе
					нстр=тз.Добавить();
					ЗаполнитьЗначенияСвойств(нстр,Детали);
					нстр.Абонент=?(Детали.ИсхВнутренний,Детали.src,Детали.dst);
					нстр.Номер=?(Детали.ИсхВнутренний,Детали.dst,Детали.src);
					нстр.Пропущен=Истина;
					Если Детали.disposition="ANSWERED" и не Детали.lastapp="VoiceMail" тогда
						нстр.Пропущен=Ложь;
					КонецЕсли;
					
					нстр.Номер=?(СтрДлина(нстр.Номер)=6,"4852"+нстр.Номер,нстр.Номер);
					нстр.Номер=?(СтрДлина(нстр.Номер)=10,"8"+нстр.Номер,нстр.Номер);
					
					Если Детали.ИсхВнутренний и Детали.ВхВнутренний  и Детали.src<>"N/A" тогда
						нстр=тз.Добавить();
						ЗаполнитьЗначенияСвойств(нстр,Детали);
						нстр.Абонент=Детали.dst;
						нстр.Номер=Детали.src;
						нстр.Пропущен=Истина;
					КонецЕсли;
					Если нстр.Абонент=Детали.dst тогда
						нстр.Входящий=истина;
					ИначеЕсли 	 нстр.Абонент=Детали.src тогда
						нстр.Входящий=ложь;
					КонецЕсли;
					
					нстр.Пропущен=Истина;
					
					Если Детали.disposition="ANSWERED" и не Детали.lastapp="VoiceMail" тогда
						нстр.Пропущен=Ложь;
					КонецЕсли;
					нстр.Номер=?(СтрДлина(нстр.Номер)=6,"4852"+нстр.Номер,нстр.Номер);
					нстр.Номер=?(СтрДлина(нстр.Номер)=10,"8"+нстр.Номер,нстр.Номер);

				КонецЕсли;
			КонецЦикла;	 
		КонецЦикла;	 
	КонецЦикла;
	
	//тз.ВыбратьСтроку();
	
	ТекстСПоискомКонтрагентов="ВЫБРАТЬ
	                          |	Таблица.calldate,
	                          |	Таблица.День,
	                          |	Таблица.Абонент,
	                          |	Таблица.Номер,
	                          |	Таблица.billsec,
	                          |	Таблица.Входящий,
	                          |	Таблица.Пропущен,
	                          |	Таблица.Перезвонили,
	                          |	""%"" + Таблица.Номер + ""%"" КАК НомерДляПоиска,
	                          |	""%"" + Таблица.Абонент + ""%"" КАК НомерДляПоискаВнутренний,
	                          |	Таблица.Примечание
	                          |ПОМЕСТИТЬ вт
	                          |ИЗ
	                          |	&Таблица КАК Таблица
	                          |;
	                          |
	                          |////////////////////////////////////////////////////////////////////////////////
	                          |ВЫБРАТЬ
	                          |	КонтактнаяИнформация.Объект КАК Контрагент,
	                          |	КонтактнаяИнформация.Вид,
	                          |	КонтактнаяИнформация.Поле5 КАК Номера
	                          |ПОМЕСТИТЬ втКонтактнаяИнформация
	                          |ИЗ
	                          |	РегистрСведений.КонтактнаяИнформация КАК КонтактнаяИнформация
	                          |ГДЕ
	                          |	КонтактнаяИнформация.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.Телефон)
	                          |;
	                          |
	                          |////////////////////////////////////////////////////////////////////////////////
	                          |ВЫБРАТЬ
	                          |	втКонтактнаяИнформация.Контрагент,
	                          |	втКонтактнаяИнформация.Вид,
	                          |	втКонтактнаяИнформация.Номера
	                          |ПОМЕСТИТЬ втКонтактнаяВнутренние
	                          |ИЗ
	                          |	втКонтактнаяИнформация КАК втКонтактнаяИнформация
	                          |ГДЕ
	                          |	втКонтактнаяИнформация.Вид = &ВидВнутреннийТелефон
	                          |;
	                          |
	                          |////////////////////////////////////////////////////////////////////////////////
	                          |ВЫБРАТЬ РАЗЛИЧНЫЕ
	                          |	вт.Номер,
	                          |	""%"" + вт.Номер + ""%"" КАК НомерДляПоиска
	                          |ПОМЕСТИТЬ втНомераДляПоиска
	                          |ИЗ
	                          |	вт КАК вт
	                          |;
	                          |
	                          |////////////////////////////////////////////////////////////////////////////////
	                          |ВЫБРАТЬ РАЗЛИЧНЫЕ
	                          |	вт.Абонент,
	                          |	""%"" + вт.Абонент + ""%"" КАК АбонентДляПоиска
	                          |ПОМЕСТИТЬ втАбонентДляПоиска
	                          |ИЗ
	                          |	вт КАК вт
	                          |;
	                          |
	                          |////////////////////////////////////////////////////////////////////////////////
	                          |ВЫБРАТЬ
	                          |	втАбонентДляПоиска.Абонент,
	                          |	втКонтактнаяВнутренние.Контрагент
	                          |ПОМЕСТИТЬ втНомерАбонент
	                          |ИЗ
	                          |	втАбонентДляПоиска КАК втАбонентДляПоиска
	                          |		ЛЕВОЕ СОЕДИНЕНИЕ втКонтактнаяВнутренние КАК втКонтактнаяВнутренние
	                          |		ПО (втКонтактнаяВнутренние.Номера ПОДОБНО втАбонентДляПоиска.АбонентДляПоиска)
	                          |;
	                          |
	                          |////////////////////////////////////////////////////////////////////////////////
	                          |ВЫБРАТЬ
	                          |	втНомераДляПоиска.Номер,
	                          |	МИНИМУМ(втКонтактнаяИнформация.Контрагент) КАК Контрагент
	                          |ПОМЕСТИТЬ втНомерКонтрагент
	                          |ИЗ
	                          |	втНомераДляПоиска КАК втНомераДляПоиска
	                          |		ЛЕВОЕ СОЕДИНЕНИЕ втКонтактнаяИнформация КАК втКонтактнаяИнформация
	                          |		ПО (ВЫБОР
	                          |				КОГДА втКонтактнаяИнформация.Вид = &ВидВнутреннийТелефон
	                          |						И втНомераДляПоиска.Номер ПОДОБНО ""___""
	                          |						И втКонтактнаяИнформация.Номера ПОДОБНО втНомераДляПоиска.НомерДляПоиска
	                          |					ТОГДА ИСТИНА
	                          |				КОГДА (НЕ втКонтактнаяИнформация.Вид = &ВидВнутреннийТелефон)
	                          |						И втКонтактнаяИнформация.Номера ПОДОБНО втНомераДляПоиска.НомерДляПоиска
	                          |						И (НЕ втНомераДляПоиска.Номер ПОДОБНО ""___"")
	                          |					ТОГДА ИСТИНА
	                          |				ИНАЧЕ ЛОЖЬ
	                          |			КОНЕЦ)
	                          |
	                          |СГРУППИРОВАТЬ ПО
	                          |	втНомераДляПоиска.Номер
	                          |;
	                          |
	                          |////////////////////////////////////////////////////////////////////////////////
	                          |ВЫБРАТЬ
	                          |	вт.calldate КАК calldate,
	                          |	вт.День КАК День,
	                          |	вт.Абонент КАК Абонент,
	                          |	вт.Номер,
	                          |	вт.billsec,
	                          |	вт.Входящий,
	                          |	вт.Пропущен,
	                          |	вт.Перезвонили,
	                          |	втНомерКонтрагент.Контрагент,
	                          |	втНомерАбонент.Контрагент КАК АбонентФизЛицо,
	                          |	вт.Примечание
	                          |ИЗ
	                          |	вт КАК вт
	                          |		ЛЕВОЕ СОЕДИНЕНИЕ втНомерКонтрагент КАК втНомерКонтрагент
	                          |		ПО вт.Номер = втНомерКонтрагент.Номер
	                          |		ЛЕВОЕ СОЕДИНЕНИЕ втНомерАбонент КАК втНомерАбонент
	                          |		ПО вт.Абонент = втНомерАбонент.Абонент
	                          |
	                          |УПОРЯДОЧИТЬ ПО
	                          |	calldate
	                          |ИТОГИ ПО
	                          |	День,
	                          |	Абонент";
				 
				 /////
				 ТекстБезПоискаКонтрагентов="ВЫБРАТЬ
				                            |	Таблица.calldate,
				                            |	Таблица.День,
				                            |	Таблица.Абонент,
				                            |	Таблица.Номер,
				                            |	Таблица.billsec,
				                            |	Таблица.Входящий,
				                            |	Таблица.Пропущен,
				                            |	Таблица.Перезвонили,
				                            |	""%"" + Таблица.Номер + ""%"" КАК НомерДляПоиска,
				                            |	""%"" + Таблица.Абонент + ""%"" КАК НомерДляПоискаВнутренний,
				                            |	Таблица.Примечание
				                            |ПОМЕСТИТЬ вт
				                            |ИЗ
				                            |	&Таблица КАК Таблица
				                            |;
				                            |
				                            |////////////////////////////////////////////////////////////////////////////////
				                            |ВЫБРАТЬ
				                            |	КонтактнаяИнформация.Объект КАК Контрагент,
				                            |	КонтактнаяИнформация.Вид,
				                            |	КонтактнаяИнформация.Поле5 КАК Номера
				                            |ПОМЕСТИТЬ втКонтактнаяИнформация
				                            |ИЗ
				                            |	РегистрСведений.КонтактнаяИнформация КАК КонтактнаяИнформация
				                            |ГДЕ
				                            |	КонтактнаяИнформация.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.Телефон)
				                            |;
				                            |
				                            |////////////////////////////////////////////////////////////////////////////////
				                            |ВЫБРАТЬ
				                            |	втКонтактнаяИнформация.Контрагент,
				                            |	втКонтактнаяИнформация.Вид,
				                            |	втКонтактнаяИнформация.Номера
				                            |ПОМЕСТИТЬ втКонтактнаяВнутренние
				                            |ИЗ
				                            |	втКонтактнаяИнформация КАК втКонтактнаяИнформация
				                            |ГДЕ
				                            |	втКонтактнаяИнформация.Вид = &ВидВнутреннийТелефон
				                            |;
				                            |
				                            |////////////////////////////////////////////////////////////////////////////////
				                            |ВЫБРАТЬ РАЗЛИЧНЫЕ
				                            |	вт.Абонент,
				                            |	""%"" + вт.Абонент + ""%"" КАК АбонентДляПоиска
				                            |ПОМЕСТИТЬ втАбонентДляПоиска
				                            |ИЗ
				                            |	вт КАК вт
				                            |;
				                            |
				                            |////////////////////////////////////////////////////////////////////////////////
				                            |ВЫБРАТЬ
				                            |	втАбонентДляПоиска.Абонент,
				                            |	втКонтактнаяВнутренние.Контрагент
				                            |ПОМЕСТИТЬ втНомерАбонент
				                            |ИЗ
				                            |	втАбонентДляПоиска КАК втАбонентДляПоиска
				                            |		ЛЕВОЕ СОЕДИНЕНИЕ втКонтактнаяВнутренние КАК втКонтактнаяВнутренние
				                            |		ПО (втКонтактнаяВнутренние.Номера ПОДОБНО втАбонентДляПоиска.АбонентДляПоиска)
				                            |;
				                            |
				                            |////////////////////////////////////////////////////////////////////////////////
				                            |ВЫБРАТЬ
				                            |	вт.calldate КАК calldate,
				                            |	вт.День КАК День,
				                            |	вт.Абонент КАК Абонент,
				                            |	вт.Номер,
				                            |	вт.billsec,
				                            |	вт.Входящий,
				                            |	вт.Пропущен,
				                            |	вт.Перезвонили,
				                            |	втНомерАбонент1.Контрагент,
				                            |	втНомерАбонент.Контрагент КАК АбонентФизЛицо,
				                            |	вт.Примечание
				                            |ИЗ
				                            |	вт КАК вт
				                            |		ЛЕВОЕ СОЕДИНЕНИЕ втНомерАбонент КАК втНомерАбонент
				                            |		ПО вт.Абонент = втНомерАбонент.Абонент
				                            |		ЛЕВОЕ СОЕДИНЕНИЕ втНомерАбонент КАК втНомерАбонент1
				                            |		ПО вт.Номер = втНомерАбонент1.Абонент
				                            |
				                            |УПОРЯДОЧИТЬ ПО
				                            |	calldate
				                            |ИТОГИ ПО
				                            |	День,
				                            |	Абонент";

				 /////
				 Если флИскатьКонтрагентаПоНомеру тогда
					 Запрос.Текст=ТекстСПоискомКонтрагентов;
				 Иначе
					 Запрос.Текст=ТекстБезПоискаКонтрагентов;
				КонецЕсли;	 
				 Запрос.УстановитьПараметр("Таблица",тз);
				 Запрос.УстановитьПараметр("ВидВнутреннийТелефон",Справочники.ВидыКонтактнойИнформации.НайтиПоКоду("38840"));
				 ВыборкаДень=Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
				 тз.Очистить();
				 Пока ВыборкаДень.Следующий() Цикл
					 ВыборкаАбонент=ВыборкаДень.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
					 Пока ВыборкаАбонент.Следующий() Цикл
						 ВыборкаДетали=ВыборкаАбонент.Выбрать();
						 тзЗвонкиЗаДень.Очистить();
						 Пока ВыборкаДетали.Следующий() Цикл
							нстр=тзЗвонкиЗаДень.Добавить();
							ЗаполнитьЗначенияСвойств(нстр,ВыборкаДетали);
						КонецЦикла;
						//отмечаем пропущенные входящие, на которые все таки ответили
						инд=0;
						Колво=тзЗвонкиЗаДень.Количество()-1;
						Для каждого стр из тзЗвонкиЗаДень цикл
							Если стр.Входящий и Стр.Пропущен тогда
								Для к=инд по Колво цикл
									Если тзЗвонкиЗаДень[к].Номер=Стр.Номер и тзЗвонкиЗаДень[к].Пропущен=ложь тогда
										стр.Перезвонили=истина;
										прервать;
									КонецЕсли;	
								КонецЦикла;
							КонецЕсли;
							инд=инд+1;
						КонецЦикла;
						Для Каждого стр из тзЗвонкиЗаДень цикл
							нстр=тз.Добавить();
							ЗаполнитьЗначенияСвойств(нстр,стр);
							нСтр.Номер=нСтр.Номер+" <"+СокрЛП(стр.Контрагент)+">";
							//нСтр.Абонент=нСтр.Абонент+" <"+СокрЛП(стр.АбонентФизЛицо)+">";
							нСтр.АбонентФизЛицо=стр.АбонентФизЛицо;
						КонецЦикла;	
					 КонецЦикла;	 
				 КонецЦикла;
				 //тз.ВыбратьСтроку();
				 //
				 //Связь между таблицей значений и именами в СКД ВнешниеНаборыДанных = Новый Структура;
				 ВнешниеНаборыДанных = Новый Структура;
				 ВнешниеНаборыДанных.Вставить("тз", тз);
				 
				 //Макет компоновки 
				 КомпоновщикМакета = Новый КомпоновщикМакетаКомпоновкиДанных;
				 МакетКомпоновки = КомпоновщикМакета.Выполнить(ЭтотОбъект.СхемаКомпоновкиДанных, ЭтотОбъект.КомпоновщикНастроек.ПолучитьНастройки(), ДанныеРасшифровки);
				 
				 //Компоновка данных 
				 ПроцессорКомпоновки = Новый ПроцессорКомпоновкиДанных;
				 ПроцессорКомпоновки.Инициализировать(МакетКомпоновки, ВнешниеНаборыДанных, ДанныеРасшифровки);
				 
				 //Вывод результата 
				 ДокументРезультат=ЭлементыФормы.ПолеТабличногоДокумента1;
				 ДокументРезультат.Очистить();
				 ПроцессорВывода = Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВТабличныйДокумент;
				 ПроцессорВывода.УстановитьДокумент(ДокументРезультат);
				 //ПроцессорВывода.Вывести(ПроцессорКомпоновки);
				 ПроцессорВывода.НачатьВывод();
				 
				 ТаблицаЗафиксирована = Ложь;
				 Пока Истина Цикл
					 ЭлементРезультата = ПроцессорКомпоновки.Следующий();
					 Если ЭлементРезультата= Неопределено Тогда
						 Прервать;
					 Иначе
						 ПроцессорВывода.ВывестиЭлемент(ЭлементРезультата);
						 Если Не ТаблицаЗафиксирована
							 И ЭлементРезультата.ЗначенияПараметров.Количество() >  0 Тогда
							 
							 ТаблицаЗафиксирована = Истина;
							 ДокументРезультат.ФиксацияСверху = ДокументРезультат.ВысотаТаблицы - 1;
							 
						 КонецЕсли;
    КонецЕсли;
КонецЦикла;

ПроцессорВывода.ЗакончитьВывод();
//ЭлементыФормы.ПолеТабличногоДокумента1.ПоказатьУровеньГруппировокСтрок(3);
//ЭлементыФормы.ПолеТабличногоДокумента1.ПоказатьУровеньГруппировокСтрок(2);
//ЭлементыФормы.ПолеТабличногоДокумента1.ПоказатьУровеньГруппировокСтрок(1);
//ЭлементыФормы.ПолеТабличногоДокумента1.ПоказатьУровеньГруппировокСтрок(0);

				//
                //Сообщить("Время выполнения: "+(ТекущаяДата()-Начало));
КонецПроцедуры

Процедура ВыбПериодНажатие(Элемент)
	НастройкаПериода = Новый НастройкаПериода;
	НастройкаПериода.УстановитьПериод(НачПериода, ?(КонПериода='0001-01-01', КонПериода, КонецДня(КонПериода)));
	НастройкаПериода.РедактироватьКакИнтервал = Истина;
	НастройкаПериода.РедактироватьКакПериод = Истина;
	НастройкаПериода.ВариантНастройки = ВариантНастройкиПериода.Период;
	Если НастройкаПериода.Редактировать() Тогда
		НачПериода = НастройкаПериода.ПолучитьДатуНачала();
		КонПериода = НастройкаПериода.ПолучитьДатуОкончания();
	КонецЕсли;
КонецПроцедуры

Процедура ПриОткрытии()
	Параметры = ВнешниеИсточникиДанных.ВнешнийИсточникДанныхЗвонки.ПолучитьОбщиеПараметрыСоединения();
	Параметры.АутентификацияСтандартная = Истина;
	Параметры.СтрокаСоединения = "DRIVER={SQL Server};SERVER=sigma;UID=CallLogUser;PWD=asteriskcdr;DATABASE=CallLog;LANGUAGE=русский";
	Параметры.СУБД = "MSSQLServer";
	
	ВнешниеИсточникиДанных.ВнешнийИсточникДанныхЗвонки.УстановитьОбщиеПараметрыСоединения(Параметры);
	ВнешниеИсточникиДанных.ВнешнийИсточникДанныхЗвонки.УстановитьПараметрыСоединенияПользователя(ИмяПользователя(), Параметры);
	ВнешниеИсточникиДанных.ВнешнийИсточникДанныхЗвонки.УстановитьПараметрыСоединенияСеанса(Параметры);
	
	ВнешниеИсточникиДанных.ВнешнийИсточникДанныхЗвонки.УстановитьСоединение();
	
	СписокВыбора = Новый СписокЗначений;
	Для Каждого Вариант Из ОтчетОбъект.СхемаКомпоновкиДанных.ВариантыНастроек Цикл
		СписокВыбора.Добавить(Вариант, Вариант.Представление);
	КонецЦикла;
	ЭлементыФормы.Вариант.СписокВыбора = СписокВыбора;
	ЭлементыФормы.Вариант.Значение = ЭлементыФормы.Вариант.СписокВыбора.Получить(0).Значение;
	
	
	флТолькоВнешние=Истина;
	НачПериода=НачалоДня(ТекущаяДата());	
	КонПериода=КонецДня(ТекущаяДата());	
	КнопкаСформироватьНажатие(неопределено);
КонецПроцедуры

Процедура ВариантПриИзменении(Элемент)
	ИзменитьНастройки();
КонецПроцедуры
Процедура ИзменитьНастройки()
	ОтчетОбъект.КомпоновщикНастроек.ЗагрузитьНастройки(ЭлементыФормы.Вариант.Значение.Настройки);
	ЭлементыФормы.ПолеТабличногоДокумента1.Очистить();
	КнопкаСформироватьНажатие(неопределено);

КонецПроцедуры	
СтруктураПоиска= новый Структура("disposition");
СтруктураПоиска.disposition="ANSWERED";

