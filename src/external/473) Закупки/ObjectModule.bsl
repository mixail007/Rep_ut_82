Процедура ЗаполнитьНачальныеНастройки() Экспорт
	
	ПостроительОтчета = ОбщийОтчет.ПостроительОтчета;
	
	СтруктураПредставлениеПолей = Новый Структура;
	МассивОтбора = Новый Массив;
	//ЗаполнитьНачальныеНастройкиПоМакету(ПолучитьМакет("ПараметрыОтчетовПродажиКомпании"), СтруктураПредставлениеПолей, МассивОтбора, ОбщийОтчет, "СписокКроссТаблица");
	Текст = "
	|ВЫБРАТЬ //РАЗЛИЧНЫЕ
	|	СУММА(ТаблицаРегистра.КоличествоОборот) КАК Количество,
	|ВЫРАЗИТЬ (ВЫБОР КОГДА СУММА(ТаблицаРегистра.КоличествоОборот)>0 ТОГДА 
	|   СУММА(ТаблицаРегистра.СтоимостьОборот)/СУММА(ТаблицаРегистра.КоличествоОборот)
	|ИНАЧЕ 
	| 0
	|КОНЕЦ  КАК ЧИСЛО (15,2)) Как Цена,
	|	СУММА(ТаблицаРегистра.СтоимостьОборот) КАК Стоимость
	|	//ТаблицаРегистра.ДоговорКонтрагента.Владелец КАК Поставщик,
	|	//ТаблицаРегистра.Номенклатура КАК Номенклатура,
	|	//ТаблицаРегистра.Номенклатура.БазоваяЕдиницаИзмерения КАК НоменклатураБазоваяЕдиницаИзмерения
	|{ВЫБРАТЬ 
	|	ТаблицаРегистра.ДоговорКонтрагента.Владелец.* КАК Поставщик,
	|	ТаблицаРегистра.ДоговорКонтрагента.* КАК ДоговорКонтрагента,
	|	ТаблицаРегистра.ДокументЗакупки.* КАК ДокументЗакупки,
	|	ТаблицаРегистра.ЗаказПоставщику.* КАК ЗаказПоставщику,
	|	ТаблицаРегистра.Номенклатура.* КАК Номенклатура,
	|	ТаблицаРегистра.Номенклатура.БазоваяЕдиницаИзмерения.* КАК НоменклатураБазоваяЕдиницаИзмерения,
	|	ТаблицаРегистра.Подразделение.* КАК Подразделение,
	|	ТаблицаРегистра.Период ,
	|	ТаблицаРегистра.Регистратор.* КАК Регистратор
	|	//СВОЙСТВА
	|,
	|	НачалоПериода(ТаблицаРегистра.Период, День) КАК ПериодДень ,
	|	НачалоПериода(ТаблицаРегистра.Период, Неделя) КАК ПериодНеделя ,
	|	НачалоПериода(ТаблицаРегистра.Период, Месяц) КАК ПериодМесяц ,
	|	НачалоПериода(ТаблицаРегистра.Период, Квартал) КАК ПериодКвартал ,
	|	НачалоПериода(ТаблицаРегистра.Период, Год) КАК ПериодГод}
	|ИЗ
	|	РегистрНакопления.Закупки.Обороты(&ДатаНач, &ДатаКон, Регистратор) КАК ТаблицаРегистра
	|	//СОЕДИНЕНИЯ
	|СГРУППИРОВАТЬ ПО 
	|	ТаблицаРегистра.ДоговорКонтрагента.Владелец,
	|	ТаблицаРегистра.Номенклатура,
	|	ТаблицаРегистра.Номенклатура.БазоваяЕдиницаИзмерения
	|//СГРУППИРОВАТЬПО
	|{ГДЕ 
	|	ТаблицаРегистра.ДоговорКонтрагента.Владелец.* КАК Поставщик,
	|	ТаблицаРегистра.ДоговорКонтрагента.* КАК ДоговорКонтрагента,
	|	ТаблицаРегистра.ДокументЗакупки.* КАК ДокументЗакупки,
	|	ТаблицаРегистра.ЗаказПоставщику.* КАК ЗаказПоставщику,
	|	ТаблицаРегистра.Номенклатура.* КАК Номенклатура,
	|	ТаблицаРегистра.Номенклатура.БазоваяЕдиницаИзмерения.* КАК НоменклатураБазоваяЕдиницаИзмерения,
	|	ТаблицаРегистра.Подразделение.* КАК Подразделение,
	|	ТаблицаРегистра.Период ,
	|	ТаблицаРегистра.Регистратор.* КАК Регистратор
	|//СВОЙСТВА
	|//КАТЕГОРИИ
	|}
	|{УПОРЯДОЧИТЬ ПО 
	|	ТаблицаРегистра.ДоговорКонтрагента.Владелец.* КАК Поставщик,
	|	ТаблицаРегистра.ДоговорКонтрагента.* КАК ДоговорКонтрагента,
	|	ТаблицаРегистра.ДокументЗакупки.* КАК ДокументЗакупки,
	|	ТаблицаРегистра.ЗаказПоставщику.* КАК ЗаказПоставщику,
	|	ТаблицаРегистра.Номенклатура.* КАК Номенклатура,
	|	ТаблицаРегистра.Номенклатура.БазоваяЕдиницаИзмерения.* КАК НоменклатураБазоваяЕдиницаИзмерения,
	|	ТаблицаРегистра.Подразделение.* КАК Подразделение,
	|	НачалоПериода(ТаблицаРегистра.Период, День) КАК ПериодДень ,
	|	НачалоПериода(ТаблицаРегистра.Период, Неделя) КАК ПериодНеделя ,
	|	НачалоПериода(ТаблицаРегистра.Период, Месяц) КАК ПериодМесяц ,
	|	НачалоПериода(ТаблицаРегистра.Период, Квартал) КАК ПериодКвартал ,
	|	НачалоПериода(ТаблицаРегистра.Период, Год) КАК ПериодГод,
	|	ТаблицаРегистра.Регистратор.* КАК Регистратор
	|//СВОЙСТВА
	|}
	|{ИТОГИ ПО 
	|	ТаблицаРегистра.ДоговорКонтрагента.Владелец.* КАК Поставщик,
	|	ТаблицаРегистра.ДоговорКонтрагента.* КАК ДоговорКонтрагента,
	|	ТаблицаРегистра.ДокументЗакупки.* КАК ДокументЗакупки,
	|	ТаблицаРегистра.ЗаказПоставщику.* КАК ЗаказПоставщику,
	|	ТаблицаРегистра.Номенклатура.* КАК Номенклатура,
	|	ТаблицаРегистра.Номенклатура.БазоваяЕдиницаИзмерения.* КАК НоменклатураБазоваяЕдиницаИзмерения,
	|	ТаблицаРегистра.Подразделение.* КАК Подразделение,
	|	НачалоПериода(ТаблицаРегистра.Период, День) КАК ПериодДень ,
	|	НачалоПериода(ТаблицаРегистра.Период, Неделя) КАК ПериодНеделя ,
	|	НачалоПериода(ТаблицаРегистра.Период, Месяц) КАК ПериодМесяц ,
	|	НачалоПериода(ТаблицаРегистра.Период, Квартал) КАК ПериодКвартал ,
	|	НачалоПериода(ТаблицаРегистра.Период, Год) КАК ПериодГод
	|//СВОЙСТВА
	|}
	|ИТОГИ  
	|	СУММА(Количество),
	|ВЫРАЗИТЬ (ВЫБОР КОГДА СУММА(Количество)>0 ТОГДА 
	|   СУММА(Стоимость)/СУММА(Количество)
	|ИНАЧЕ 
	| 0
	|КОНЕЦ  КАК ЧИСЛО (15,2)) Цена,
	|	СУММА(Стоимость)
	|ПО ОБЩИЕ, Номенклатура 
	|АВТОУПОРЯДОЧИВАНИЕ";
	СтруктураПредставлениеПолей = Новый Структура("
	|Количество,
	|Цена,
	|Стоимость,
	|Поставщик,
	|ДоговорКонтрагента,
	|ДокументЗакупки,
	|ЗаказПоставщику,
	|НоменклатураБазоваяЕдиницаИзмерения,
	|Подразделение,
	|ПериодДень,
	|ПериодНеделя,
	|ПериодМесяц,
	|ПериодКвартал,
	|ПериодГод", 
	"Количество товара",
	"Цена поступления",
	"Стоимость",	
	"Поставщик",
	"Договор контрагента",
	"Документ закупки",
	"Заказ поставщику",
	"Базовая единица измерения",
	"Подразделение",
	"По дням",
	"По неделям",
	"По месяцам",
	"По кварталам",
	"По годам");
	
	Если ОбщийОтчет.ИспользоватьСвойстваИКатегории Тогда
	
	    ТекстПоляСвойств= "";
		ТекстПоляКатегорий = "";

		ТаблицаПолей = Новый ТаблицаЗначений;
		ТаблицаПолей.Колонки.Добавить("ПутьКДанным");  // описание поля запроса поля, для которого добавляются свойства и категории. Используется в условии соединения с регистром сведений, хранящим значения свойств или категорий
		ТаблицаПолей.Колонки.Добавить("Представление");// представление поля, для которого добавляются свойства и категории. 
		ТаблицаПолей.Колонки.Добавить("Назначение");   // назначение свойств/категорий объектов для данного поля
		ТаблицаПолей.Колонки.Добавить("ТипЗначения");  // тип значения поля, для которого добавляются свойства и категории. Используется, если не установлено назначение
		ТаблицаПолей.Колонки.Добавить("НетКатегорий"); // признак НЕиспользования категорий для объекта
		
		СтрокаТаблицы = ТаблицаПолей.Добавить();
		СтрокаТаблицы.ПутьКДанным = "Номенклатура";
		СтрокаТаблицы.Представление = "Номенклатура";
		СтрокаТаблицы.Назначение = ПланыВидовХарактеристик.НазначенияСвойствКатегорийОбъектов.Справочник_Номенклатура;
		
		ДобавитьВТекстСвойстваИКатегории(ТаблицаПолей, Текст, СтруктураПредставлениеПолей, 
				ОбщийОтчет.мСоответствиеНазначений, ПостроительОтчета.Параметры
				,, ТекстПоляКатегорий, ТекстПоляСвойств,,,,,,ОбщийОтчет.мСтруктураДляОтбораПоКатегориям);
				
		ДобавитьВТекстСвойстваОбщие(Текст, ТекстПоляСвойств, "//ОБЩИЕ_СВОЙСТВА");
      // для избежания двойственности поля Номенклатура в запросе
	    		
		УстановитьТипыЗначенийСвойствИКатегорийДляОтбора(ПостроительОтчета, ТекстПоляКатегорий, ТекстПоляСвойств, ОбщийОтчет.мСоответствиеНазначений, СтруктураПредставлениеПолей);
	КонецЕсли;
	
	ПостроительОтчета.Текст = Текст;
	МассивОтбора = Новый Массив;
	МассивОтбора.Добавить("Поставщик");
	МассивОтбора.Добавить("Номенклатура");
	МассивОтбора.Добавить("Подразделение");
	
	ЗаполнитьПредставленияПолей(СтруктураПредставлениеПолей, ПостроительОтчета);
	ОчиститьДополнительныеПоляПостроителя(ПостроительОтчета);
	ЗаполнитьОтбор(МассивОтбора, ПостроительОтчета);
	ОбщийОтчет.мВыбиратьИмяРегистра = Ложь;
	ОбщийОтчет.ВыводитьПоказателиВСтроку = Истина;
	ОбщийОтчет.ВыводитьИтогиПоВсемУровням = Истина;
	
	ОбщийОтчет.ЗаполнитьПоказатели("Количество", "Количество в единицах хранения", Истина, "ЧЦ=15; ЧДЦ=3");
	ОбщийОтчет.ЗаполнитьПоказатели("Цена", "Цена поступления", Истина, "ЧЦ=15; ЧДЦ=2");
	ОбщийОтчет.ЗаполнитьПоказатели("Стоимость", "Стоимость", Истина, "ЧЦ=15; ЧДЦ=2");
		

	ОбщийОтчет.мНазваниеОтчета = "Закупки";
	ОбщийОтчет.ВыводитьИтогиПоВсемУровням = Ложь;
	ОбщийОтчет.мВыбиратьИспользованиеСвойств = Истина;
	
	// Установим дату начала отчета
	Если ЗначениеНеЗаполнено(ОбщийОтчет.ДатаНач) Тогда
		
		Если Не ЗначениеНеЗаполнено(глТекущийПользователь) Тогда
			ОбщийОтчет.ДатаНач = ПолучитьЗначениеПоУмолчанию(глТекущийПользователь,"ОсновнаяДатаНачалаОтчетов");
		КонецЕсли;
		
	КонецЕсли; 
	
КонецПроцедуры

Процедура СформироватьОтчет(ДокументРезультат, ПоказыватьЗаголовок, ВысотаЗаголовка, ТолькоЗаголовок = Ложь) Экспорт

	//ОбщийОтчет.мСтруктураСвязиПоказателейИИзмерений.Вставить("РентабельностьПродаж", Новый Структура("ТакогоИзмеренияНетВОтчете")); // Рентабельность не выводится в итогах по группировкам, только в детальных записях
	//ОбщийОтчет.мСтруктураСвязиПоказателейИИзмерений.Вставить("ПроцентНаценки", Новый Структура("ТакогоИзмеренияНетВОтчете")); // Рентабельность не выводится в итогах по группировкам, только в детальных записях
	ОбщийОтчет.СформироватьОтчет(ДокументРезультат, ПоказыватьЗаголовок, ВысотаЗаголовка, ТолькоЗаголовок);

КонецПРоцедуры

// Читает свойство Построитель отчета
//
// Параметры
//	Нет
//
Функция ПолучитьПостроительОтчета() Экспорт

	Возврат ОбщийОтчет.ПолучитьПостроительОтчета();

КонецФункции // ПолучитьПостроительОтчета()

// Настраивает отчет по переданной структуре параметров
//
// Параметры:
//	Нет.
//
Процедура Настроить(Параметры) Экспорт

	ОбщийОтчет.Настроить(Параметры, ЭтотОбъект);

КонецПроцедуры

// Возвращает основную форму отчета, связанную с данным экземпляром отчета
//
// Параметры
//	Нет
//
Функция ПолучитьОсновнуюФорму() Экспорт
	
	ОснФорма = ПолучитьФорму();
	ОснФорма.ОбщийОтчет = ОбщийОтчет;
	ОснФорма.ЭтотОтчет = ЭтотОбъект;
	Возврат ОснФорма;
	
КонецФункции // ПолучитьОсновнуюФорму()

// Возвращает форму настройки 
//
// Параметры:
//	Нет.
//
// Возвращаемое значение:
//	
//
Функция ПолучитьФормуНастройки() Экспорт
	
	ФормаНастройки = ОбщийОтчет.ПолучитьФорму("ФормаНастройка");
	Возврат ФормаНастройки;
	
КонецФункции // ПолучитьФормуНастройки()

// Процедура обработки расшифровки
//
// Параметры:
//	Нет.
//
Процедура ОбработкаРасшифровки(РасшифровкаСтроки, ПолеТД, ВысотаЗаголовка, СтандартнаяОбработка) Экспорт
	
	// Добавление расшифровки из колонки
	Если ТипЗнч(РасшифровкаСтроки) = Тип("Структура") Тогда
		
		// Расшифровка колонки находится в заголовке колонки
		РасшифровкаКолонки = ПолеТД.Область(ВысотаЗаголовка+2, ПолеТД.ТекущаяОбласть.Лево).Расшифровка;

		Расшифровка = Новый Структура;

		Для каждого Элемент Из РасшифровкаСтроки Цикл
			Расшифровка.Вставить(Элемент.Ключ, Элемент.Значение);
		КонецЦикла;

		Если ТипЗнч(РасшифровкаКолонки) = Тип("Структура") Тогда

			Для каждого Элемент Из РасшифровкаКолонки Цикл
				Расшифровка.Вставить(Элемент.Ключ, Элемент.Значение);
			КонецЦикла;

		КонецЕсли; 

		ОбщийОтчет.ОбработкаРасшифровкиСтандартногоОтчета(Расшифровка, СтандартнаяОбработка, ЭтотОбъект);

	КонецЕсли;
	
КонецПроцедуры // ОбработкаРасшифровки()

// Формирует структуру, в которую складываются настройки
//
Функция СформироватьСтруктуруДляСохраненияНастроек(ПоказыватьЗаголовок) Экспорт
	
	СтруктураНастроек = Новый Структура;
	
	ОбщийОтчет.СформироватьСтруктуруДляСохраненияНастроек(СтруктураНастроек, ПоказыватьЗаголовок);
	
	Возврат СтруктураНастроек;
	
КонецФункции

// Заполняет настройки из структуры - кроме состояния панели "Отбор"
//
Процедура ВосстановитьНастройкиИзСтруктуры(СохраненныеНастройки, ПоказыватьЗаголовок, Отчет=Неопределено) Экспорт
	
	// Если отчет, вызвавший порцедуру, не передан, то считаем, что ее вызвал этот отчет
	Если Отчет = Неопределено Тогда
		Отчет = ЭтотОбъект;
	КонецЕсли;

	ОбщийОтчет.ВосстановитьНастройкиИзСтруктуры(СохраненныеНастройки, ПоказыватьЗаголовок, Отчет);
	
КонецПроцедуры

ОбщийОтчет.ИмяРегистра = "Закупки";