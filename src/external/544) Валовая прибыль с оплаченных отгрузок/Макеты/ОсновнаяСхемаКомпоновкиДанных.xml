<?xml version="1.0" encoding="UTF-8"?>
<SchemaFile xmlns="" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
	<dataCompositionSchema xmlns="http://v8.1c.ru/8.1/data-composition-system/schema">
		<dataSource>
			<name>ИсточникДанных1</name>
			<dataSourceType>Local</dataSourceType>
		</dataSource>
		<dataSet xsi:type="DataSetQuery">
			<name>НаборДанных1</name>
			<field xsi:type="DataSetFieldField">
				<dataPath>ВаловаяПрибыль</dataPath>
				<field>ВаловаяПрибыль</field>
			</field>
			<field xsi:type="DataSetFieldField">
				<dataPath>ДисконтнаяКарта</dataPath>
				<field>ДисконтнаяКарта</field>
			</field>
			<field xsi:type="DataSetFieldField">
				<dataPath>ДоговорКонтрагента</dataPath>
				<field>ДоговорКонтрагента</field>
			</field>
			<field xsi:type="DataSetFieldField">
				<dataPath>ДокументЗакупки</dataPath>
				<field>ДокументЗакупки</field>
			</field>
			<field xsi:type="DataSetFieldField">
				<dataPath>ДокументОприходования</dataPath>
				<field>ДокументОприходования</field>
			</field>
			<field xsi:type="DataSetFieldField">
				<dataPath>ДокументПродажи</dataPath>
				<field>ДокументПродажи</field>
			</field>
			<field xsi:type="DataSetFieldField">
				<dataPath>ЗаказПокупателя</dataPath>
				<field>ЗаказПокупателя</field>
			</field>
			<field xsi:type="DataSetFieldField">
				<dataPath>ЗаказПоставщику</dataPath>
				<field>ЗаказПоставщику</field>
			</field>
			<field xsi:type="DataSetFieldField">
				<dataPath>НаправлениеПродаж</dataPath>
				<field>НаправлениеПродаж</field>
			</field>
			<field xsi:type="DataSetFieldField">
				<dataPath>Номенклатура</dataPath>
				<field>Номенклатура</field>
			</field>
			<field xsi:type="DataSetFieldField">
				<dataPath>Оплата</dataPath>
				<field>Оплата</field>
			</field>
			<field xsi:type="DataSetFieldField">
				<dataPath>ОплаченнаяВаловаяПрибыль</dataPath>
				<field>ОплаченнаяВаловаяПрибыль</field>
				<appearance>
					<item xmlns="http://v8.1c.ru/8.1/data-composition-system/core" xmlns:dcsset="http://v8.1c.ru/8.1/data-composition-system/settings" xsi:type="dcsset:SettingsParameterValue">
						<parameter>Формат</parameter>
						<value xsi:type="xs:string">ЧДЦ=2</value>
					</item>
				</appearance>
			</field>
			<field xsi:type="DataSetFieldField">
				<dataPath>Подразделение</dataPath>
				<field>Подразделение</field>
			</field>
			<field xsi:type="DataSetFieldField">
				<dataPath>Проект</dataPath>
				<field>Проект</field>
			</field>
			<field xsi:type="DataSetFieldField">
				<dataPath>Сделка</dataPath>
				<field>Сделка</field>
				<role>
					<dimension xmlns="http://v8.1c.ru/8.1/data-composition-system/common">true</dimension>
				</role>
			</field>
			<field xsi:type="DataSetFieldField">
				<dataPath>СтатусПартии</dataPath>
				<field>СтатусПартии</field>
			</field>
			<field xsi:type="DataSetFieldField">
				<dataPath>Стоимость</dataPath>
				<field>Стоимость</field>
			</field>
			<field xsi:type="DataSetFieldField">
				<dataPath>ХарактеристикаНоменклатуры</dataPath>
				<field>ХарактеристикаНоменклатуры</field>
			</field>
			<field xsi:type="DataSetFieldField">
				<dataPath>Менеджер</dataPath>
				<field>Менеджер</field>
			</field>
			<field xsi:type="DataSetFieldField">
				<dataPath>Покупатель</dataPath>
				<field>Покупатель</field>
			</field>
			<field xsi:type="DataSetFieldField">
				<dataPath>ВаловаяПрибыльСУчетомБонуса</dataPath>
				<field>ВаловаяПрибыльСУчетомБонуса</field>
				<appearance>
					<item xmlns="http://v8.1c.ru/8.1/data-composition-system/core" xmlns:dcsset="http://v8.1c.ru/8.1/data-composition-system/settings" xsi:type="dcsset:SettingsParameterValue">
						<parameter>Формат</parameter>
						<value xsi:type="xs:string">ЧДЦ=2</value>
					</item>
				</appearance>
			</field>
			<field xsi:type="DataSetFieldField">
				<dataPath>ОплаченнаяВаловаяПрибыльСУчетомБонуса</dataPath>
				<field>ОплаченнаяВаловаяПрибыльСУчетомБонуса</field>
				<appearance>
					<item xmlns="http://v8.1c.ru/8.1/data-composition-system/core" xmlns:dcsset="http://v8.1c.ru/8.1/data-composition-system/settings" xsi:type="dcsset:SettingsParameterValue">
						<parameter>Формат</parameter>
						<value xsi:type="xs:string">ЧДЦ=2</value>
					</item>
				</appearance>
			</field>
			<field xsi:type="DataSetFieldField">
				<dataPath>ПриходДенег</dataPath>
				<field>ПриходДенег</field>
			</field>
			<field xsi:type="DataSetFieldField">
				<dataPath>Документ</dataPath>
				<field>Документ</field>
			</field>
			<dataSource>ИсточникДанных1</dataSource>
			<query>ВЫБРАТЬ
	БонусыПоставщиков.Документ КАК ДокументРеализации,
	БонусыПоставщиков.Номенклатура,
	БонусыПоставщиков.БонусОборот КАК Бонус
ПОМЕСТИТЬ втБонусыПоНоменклатуре
ИЗ
	РегистрНакопления.БонусыПоставщиков.Обороты({(&amp;Нач)}, {(&amp;Кон)}, , ) КАК БонусыПоставщиков
ГДЕ
	БонусыПоставщиков.Документ ССЫЛКА Документ.РеализацияТоваровУслуг
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	БонусыПоставщиков.Документ КАК ДокументПоступления,
	БонусыПоставщиков.Номенклатура,
	БонусыПоставщиков.БонусОборот КАК Бонус
ПОМЕСТИТЬ втБонусыПоНоменклатуре2
ИЗ
	РегистрНакопления.БонусыПоставщиков.Обороты({(&amp;ПустаяДата)}, {(&amp;Кон)}, , ) КАК БонусыПоставщиков
ГДЕ
	БонусыПоставщиков.Документ ССЫЛКА Документ.ПоступлениеТоваровУслуг
;
////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж КАК НаправлениеПродаж,
	ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.Сделка КАК Сделка,
	ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.ДоговорКонтрагента.Владелец,
	ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.ДоговорКонтрагента.ОтветственноеЛицо,
	СУММА(ВЫБОР
			КОГДА ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.Сделка = НЕОПРЕДЕЛЕНО
				ТОГДА 0
			ИНАЧЕ ЕСТЬNULL(ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.СуммаВзаиморасчетовРасход, 0) + ВЫБОР
					КОГДА ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.Регистратор ССЫЛКА Документ.Взаимозачет
						ТОГДА ВЫБОР
								КОГДА ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.СуммаВзаиморасчетовКонечныйОстаток &lt; 0
										И ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.СуммаВзаиморасчетовНачальныйОстаток &gt;= 0
									ТОГДА ВЫБОР
											КОГДА ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.СуммаВзаиморасчетовРасход &lt; -ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.СуммаВзаиморасчетовКонечныйОстаток
												ТОГДА -ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.СуммаВзаиморасчетовРасход
											ИНАЧЕ ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.СуммаВзаиморасчетовКонечныйОстаток
										КОНЕЦ
								КОГДА ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.СуммаВзаиморасчетовПриход &gt; 0
										И ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.СуммаВзаиморасчетовНачальныйОстаток &lt;= 0
									ТОГДА ВЫБОР
											КОГДА ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.СуммаВзаиморасчетовПриход &lt; -ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.СуммаВзаиморасчетовНачальныйОстаток
												ТОГДА 0
											ИНАЧЕ -(ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.СуммаВзаиморасчетовПриход + ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.СуммаВзаиморасчетовНачальныйОстаток)
										КОНЕЦ
								ИНАЧЕ 0
							КОНЕЦ
					КОГДА ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.Регистратор ССЫЛКА Документ.ВозвратТоваровОтПокупателя
						ТОГДА ВЫБОР
								КОГДА ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.СуммаВзаиморасчетовКонечныйОстаток &lt; 0
									ТОГДА ВЫБОР
											КОГДА ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.СуммаВзаиморасчетовПриход &gt; ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.СуммаВзаиморасчетовКонечныйОстаток
												ТОГДА ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.СуммаВзаиморасчетовПриход
											ИНАЧЕ ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.СуммаВзаиморасчетовКонечныйОстаток
										КОНЕЦ
								ИНАЧЕ 0
							КОНЕЦ
					ИНАЧЕ ВЫБОР
							КОГДА ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.СуммаВзаиморасчетовКонечныйОстаток &lt; 0
									И ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.СуммаВзаиморасчетовНачальныйОстаток &gt; 0
								ТОГДА ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.СуммаВзаиморасчетовКонечныйОстаток
							ИНАЧЕ 0
						КОНЕЦ
				КОНЕЦ
		КОНЕЦ) КАК Итого,
	СУММА(ВЫБОР
			КОГДА ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.Регистратор ССЫЛКА Документ.ПриходныйКассовыйОрдер
					ИЛИ ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.Регистратор ССЫЛКА Документ.ПлатежноеПоручениеВходящее
				ТОГДА ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.СуммаВзаиморасчетовРасход
			КОГДА ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.Регистратор ССЫЛКА Документ.ПлатежноеПоручениеИсходящее
					И ВЫРАЗИТЬ(ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.Сделка КАК Документ.ЗаказПоставщику).Основание ССЫЛКА Документ.ЗаявкаНаВозвратТоваров
				ТОГДА -ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.СуммаВзаиморасчетовПриход
			КОГДА ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.Регистратор ССЫЛКА Документ.Взаимозачет
					И ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.Регистратор.УчитыватьДляРасчетаПремии
				ТОГДА ВЫБОР
						КОГДА ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.СуммаВзаиморасчетовРасход &lt;&gt; 0
							ТОГДА ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.СуммаВзаиморасчетовРасход
						ИНАЧЕ -ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.СуммаВзаиморасчетовПриход
					КОНЕЦ
			ИНАЧЕ 0
		КОНЕЦ) КАК ПриходДенег
ПОМЕСТИТЬ Оплаты
ИЗ
	РегистрНакопления.ВзаиморасчетыСКонтрагентами.ОстаткиИОбороты(, , Регистратор, , ДоговорКонтрагента.ВедениеВзаиморасчетов = ЗНАЧЕНИЕ(Перечисление.ВедениеВзаиморасчетовПоДоговорам.Позаказам)) КАК ВзаиморасчетыСКонтрагентамиОстаткиИОбороты
ГДЕ
	НЕ ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.Регистратор ССЫЛКА Документ.ПоступлениеТоваровУслуг

СГРУППИРОВАТЬ ПО
	ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.Сделка,
	ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж,
	ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.ДоговорКонтрагента.Владелец,
	ВзаиморасчетыСКонтрагентамиОстаткиИОбороты.ДоговорКонтрагента.ОтветственноеЛицо

ИНДЕКСИРОВАТЬ ПО
	Сделка
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	ПродажиОбороты.ЗаказПокупателя КАК ЗаказПокупателя,
	СУММА(ПродажиОбороты.СтоимостьОборот) КАК Стоимость,
	СУММА(ЕСТЬNULL(ПродажиСебестоимостьОбороты.СтоимостьОборот, 0)) КАК Себестоимость,
//	СУММА(ЕСТЬNULL(ПродажиСебестоимостьОбороты.СтоимостьОборот, 0) - ЕСТЬNULL(ПродажиСебестоимостьОбороты.СтоимостьОборот, 0) / 1.18 * ЕСТЬNULL(втБонусыПоНоменклатуре.Бонус, 0) / 100) КАК СебестоимостьСУчетомБонуса
	СУММА( ЕСТЬNULL(ПродажиСебестоимостьОбороты.СтоимостьОборотБонус, 0) - ЕСТЬNULL(ПродажиОбороты.КоличествоОборот, 0)*ЕСТЬNULL(втБонусыПоНоменклатуре.Бонус, 0) ) КАК СебестоимостьСУчетомБонуса
ПОМЕСТИТЬ ВаловаяПрибыльПоОплатам
ИЗ
	РегистрНакопления.Продажи.Обороты(
			{(&amp;Нач)},
			{(&amp;Кон)},
			Регистратор,
			ЗаказПокупателя В
				(ВЫБРАТЬ
					Оплаты.Сделка
				ИЗ
					Оплаты КАК Оплаты
				ГДЕ
					Оплаты.Сделка &lt;&gt; НЕОПРЕДЕЛЕНО)) КАК ПродажиОбороты
	//	ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ПродажиСебестоимость.Обороты({(&amp;Нач)}, {(&amp;Кон)}, Регистратор, ) КАК ПродажиСебестоимостьОбороты
		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
			СебестоимостьОбороты.Номенклатура КАК Номенклатура,
			СебестоимостьОбороты.Регистратор КАК Регистратор,
			СебестоимостьОбороты.ЗаказПокупателя КАК ЗаказПокупателя,
			СебестоимостьОбороты.Подразделение КАК Подразделение,
			СУММА(СебестоимостьОбороты.КоличествоОборот) КАК КоличествоОборот,
			СУММА(СебестоимостьОбороты.СтоимостьОборот) КАК СтоимостьОборот,
			СУММА(ЕСТЬNULL(СебестоимостьОбороты.СтоимостьОборот, 0) - ЕСТЬNULL(втБонусыПоНоменклатуре2.Бонус, 0) * ЕСТЬNULL(СебестоимостьОбороты.КоличествоОборот, 0)) КАК СтоимостьОборотБонус
		ИЗ
			РегистрНакопления.ПродажиСебестоимость.Обороты({(&amp;Нач)}, {(&amp;Кон)}, Регистратор, ) КАК СебестоимостьОбороты
				ЛЕВОЕ СОЕДИНЕНИЕ втБонусыПоНоменклатуре2 КАК втБонусыПоНоменклатуре2
				ПО СебестоимостьОбороты.ДокументОприходования = втБонусыПоНоменклатуре2.ДокументПоступления
					И СебестоимостьОбороты.Номенклатура = втБонусыПоНоменклатуре2.Номенклатура
		
		СГРУППИРОВАТЬ ПО
			СебестоимостьОбороты.Номенклатура,
			СебестоимостьОбороты.Регистратор,
			СебестоимостьОбороты.ЗаказПокупателя,
			СебестоимостьОбороты.Подразделение) КАК ПродажиСебестоимостьОбороты
		ПО ПродажиОбороты.Номенклатура = ПродажиСебестоимостьОбороты.Номенклатура
			И ПродажиОбороты.Регистратор = ПродажиСебестоимостьОбороты.Регистратор
			И ПродажиОбороты.ЗаказПокупателя = ПродажиСебестоимостьОбороты.ЗаказПокупателя
			И ПродажиОбороты.Подразделение = ПродажиСебестоимостьОбороты.Подразделение
		ЛЕВОЕ СОЕДИНЕНИЕ втБонусыПоНоменклатуре КАК втБонусыПоНоменклатуре
		ПО ПродажиОбороты.Номенклатура = втБонусыПоНоменклатуре.Номенклатура
			//И ПродажиОбороты.Период = втБонусыПоНоменклатуре.ПериодРеализации
			И ПродажиОбороты.ДокументПродажи = втБонусыПоНоменклатуре.ДокументРеализации

СГРУППИРОВАТЬ ПО
	ПродажиОбороты.ЗаказПокупателя

ИНДЕКСИРОВАТЬ ПО
	ЗаказПокупателя
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	Оплаты.НаправлениеПродаж КАК НаправлениеПродаж,
	Оплаты.Сделка КАК Сделка,
	Оплаты.ДоговорКонтрагентаВладелец,
	Оплаты.ДоговорКонтрагентаОтветственноеЛицо,
	Оплаты.Итого КАК Оплата,
	ВаловаяПрибыль.Стоимость - ВаловаяПрибыль.Себестоимость КАК ВаловаяПрибыль,
	ВаловаяПрибыль.Стоимость,
	ВЫБОР
		КОГДА Оплаты.Итого &lt; 0
			ТОГДА ВЫБОР
					КОГДА ВаловаяПрибыль.Стоимость &lt;= -Оплаты.Итого
						ТОГДА -(ВаловаяПрибыль.Стоимость - ВаловаяПрибыль.Себестоимость)
					ИНАЧЕ (ВаловаяПрибыль.Стоимость - ВаловаяПрибыль.Себестоимость) * Оплаты.Итого / ВаловаяПрибыль.Стоимость
				КОНЕЦ
		ИНАЧЕ ВЫБОР
				КОГДА ВаловаяПрибыль.Стоимость &lt;= Оплаты.Итого
					ТОГДА ВаловаяПрибыль.Стоимость - ВаловаяПрибыль.Себестоимость
				ИНАЧЕ (ВаловаяПрибыль.Стоимость - ВаловаяПрибыль.Себестоимость) * Оплаты.Итого / ВаловаяПрибыль.Стоимость
			КОНЕЦ
	КОНЕЦ КАК ОплаченнаяВаловаяПрибыль,
	ВаловаяПрибыль.Стоимость - ВаловаяПрибыль.СебестоимостьСУчетомБонуса КАК ВаловаяПрибыльСУчетомБонуса,
	ВЫБОР
		КОГДА Оплаты.Итого &lt; 0
			ТОГДА ВЫБОР
					КОГДА ВаловаяПрибыль.Стоимость &lt;= -Оплаты.Итого
						ТОГДА -(ВаловаяПрибыль.Стоимость - ВаловаяПрибыль.СебестоимостьСУчетомБонуса)
					ИНАЧЕ (ВаловаяПрибыль.Стоимость - ВаловаяПрибыль.СебестоимостьСУчетомБонуса) * Оплаты.Итого / ВаловаяПрибыль.Стоимость
				КОНЕЦ
		ИНАЧЕ ВЫБОР
				КОГДА ВаловаяПрибыль.Стоимость &lt;= Оплаты.Итого
					ТОГДА ВаловаяПрибыль.Стоимость - ВаловаяПрибыль.СебестоимостьСУчетомБонуса
				ИНАЧЕ (ВаловаяПрибыль.Стоимость - ВаловаяПрибыль.СебестоимостьСУчетомБонуса) * Оплаты.Итого / ВаловаяПрибыль.Стоимость
			КОНЕЦ
	КОНЕЦ КАК ОплаченнаяВаловаяПрибыльСУчетомБонуса,
	Оплаты.ПриходДенег
ПОМЕСТИТЬ ВаловкаПоОплатам
ИЗ
	Оплаты КАК Оплаты
		ЛЕВОЕ СОЕДИНЕНИЕ ВаловаяПрибыльПоОплатам КАК ВаловаяПрибыль
		ПО Оплаты.Сделка = ВаловаяПрибыль.ЗаказПокупателя
ГДЕ
	(Оплаты.Итого &lt;&gt; 0
			ИЛИ Оплаты.ПриходДенег &lt;&gt; 0)

ИНДЕКСИРОВАТЬ ПО
	Сделка
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	ЗакупкиОбороты.ЗаказПоставщику КАК ЗаказПоставщику,
	ЗакупкиОбороты.Номенклатура,
	СУММА(ЗакупкиОбороты.КоличествоОборот) КАК КоличествоОборот,
	СУММА(ЗакупкиОбороты.СтоимостьОборот) КАК СтоимостьОборот,
	ВЫРАЗИТЬ(ЗаявкаНаВозвратТоваровТовары.Реализация.Сделка КАК Документ.ЗаказПокупателя) КАК Заказ,
	ЗаявкаНаВозвратТоваровТовары.Реализация
ПОМЕСТИТЬ ОбратныеПродажи
ИЗ
	РегистрНакопления.Закупки.Обороты(, , , ЗаказПоставщику.Основание ССЫЛКА Документ.ЗаявкаНаВозвратТоваров) КАК ЗакупкиОбороты
		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаявкаНаВозвратТоваров.Товары КАК ЗаявкаНаВозвратТоваровТовары
		ПО ЗакупкиОбороты.ЗаказПоставщику.Основание = ЗаявкаНаВозвратТоваровТовары.Ссылка
			И ЗакупкиОбороты.Номенклатура = ЗаявкаНаВозвратТоваровТовары.Номенклатура

СГРУППИРОВАТЬ ПО
	ЗакупкиОбороты.Номенклатура,
	ЗакупкиОбороты.ЗаказПоставщику,
	ЗаявкаНаВозвратТоваровТовары.Реализация,
	ВЫРАЗИТЬ(ЗаявкаНаВозвратТоваровТовары.Реализация.Сделка КАК Документ.ЗаказПокупателя)

ИНДЕКСИРОВАТЬ ПО
	Заказ
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	ПродажиОбороты.Номенклатура КАК Номенклатура,
	ПродажиОбороты.ЗаказПокупателя КАК ЗаказПокупателя,
	СУММА(ПродажиОбороты.КоличествоОборот) КАК КоличествоОборот,
	СУММА(ПродажиОбороты.СтоимостьОборот) КАК Стоимость,
	СУММА(ЕСТЬNULL(ПродажиСебестоимостьОбороты.СтоимостьОборот, 0)) КАК Себестоимость,
	СУММА(ЕСТЬNULL(ПродажиСебестоимостьОбороты.СтоимостьОборот, 0)) КАК СебестоимостьСУчетомБонуса
ПОМЕСТИТЬ ВаловаяПрибыльОбратныеПродажи
ИЗ
	РегистрНакопления.Продажи.Обороты(
			{(&amp;Нач)},
			{(&amp;Кон)},
			Регистратор,
			ЗаказПокупателя В
				(ВЫБРАТЬ
					ОбратныеПродажи.Заказ
				ИЗ
					ОбратныеПродажи КАК ОбратныеПродажи)) КАК ПродажиОбороты
		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ПродажиСебестоимость.Обороты({(&amp;Нач)}, {(&amp;Кон)}, Регистратор, ) КАК ПродажиСебестоимостьОбороты
		ПО ПродажиОбороты.Регистратор = ПродажиСебестоимостьОбороты.Регистратор
			И ПродажиОбороты.Номенклатура = ПродажиСебестоимостьОбороты.Номенклатура
			И ПродажиОбороты.ЗаказПокупателя = ПродажиСебестоимостьОбороты.ЗаказПокупателя
			И ПродажиОбороты.Подразделение = ПродажиСебестоимостьОбороты.Подразделение
		//ЛЕВОЕ СОЕДИНЕНИЕ втБонусыПоНоменклатуре КАК втБонусыПоНоменклатуре
		//ПО ПродажиОбороты.Период = втБонусыПоНоменклатуре.ПериодРеализации
		//	И ПродажиОбороты.Номенклатура = втБонусыПоНоменклатуре.Номенклатура

СГРУППИРОВАТЬ ПО
	ПродажиОбороты.ЗаказПокупателя,
	ПродажиОбороты.Номенклатура

ИНДЕКСИРОВАТЬ ПО
	ЗаказПокупателя,
	Номенклатура
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	ОбратныеПродажи.Заказ КАК Заказ,
	СУММА(ВЫБОР
			КОГДА ВаловаяПрибыль.КоличествоОборот = 0
				ТОГДА 0
			ИНАЧЕ -ОбратныеПродажи.КоличествоОборот / ВаловаяПрибыль.КоличествоОборот * (ВаловаяПрибыль.Стоимость - ВаловаяПрибыль.Себестоимость)
		КОНЕЦ) КАК ОплаченнаяВаловаяПрибыль,
	ОбратныеПродажи.Заказ.ДоговорКонтрагента.Владелец,
	ОбратныеПродажи.Заказ.ДоговорКонтрагента.ОтветственноеЛицо,
	ОбратныеПродажи.Заказ.ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж,
	СУММА(0) КАК Оплата,
	СУММА(-(ВаловаяПрибыль.Стоимость - ВаловаяПрибыль.Себестоимость)) КАК ВаловаяПрибыль,
	СУММА(-ВаловаяПрибыль.Стоимость) КАК Стоимость,
	-(ВаловаяПрибыль.Стоимость - ВаловаяПрибыль.СебестоимостьСУчетомБонуса) КАК ВаловаяПрибыльСУчетомБонуса,
	ВЫБОР
		КОГДА ВаловаяПрибыль.КоличествоОборот = 0
			ТОГДА 0
		ИНАЧЕ -ОбратныеПродажи.КоличествоОборот / ВаловаяПрибыль.КоличествоОборот * (ВаловаяПрибыль.Стоимость - ВаловаяПрибыль.СебестоимостьСУчетомБонуса)
	КОНЕЦ КАК ОплаченнаяВаловаяПрибыльСУчетомБонуса
ПОМЕСТИТЬ ВаловкаПоОбратнымПродажам
ИЗ
	ОбратныеПродажи КАК ОбратныеПродажи
		ЛЕВОЕ СОЕДИНЕНИЕ ВаловаяПрибыльОбратныеПродажи КАК ВаловаяПрибыль
		ПО ОбратныеПродажи.Заказ = ВаловаяПрибыль.ЗаказПокупателя
			И ОбратныеПродажи.Номенклатура = ВаловаяПрибыль.Номенклатура
ГДЕ
	ВЫБОР
			КОГДА ВаловаяПрибыль.КоличествоОборот = 0
				ТОГДА 0
			ИНАЧЕ -ОбратныеПродажи.КоличествоОборот / ВаловаяПрибыль.КоличествоОборот * (ВаловаяПрибыль.Стоимость - ВаловаяПрибыль.Себестоимость)
		КОНЕЦ &lt; 0

СГРУППИРОВАТЬ ПО
	ОбратныеПродажи.Заказ,
	ОбратныеПродажи.Заказ.ДоговорКонтрагента.Владелец,
	ОбратныеПродажи.Заказ.ДоговорКонтрагента.ОтветственноеЛицо,
	ОбратныеПродажи.Заказ.ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж,
	-(ВаловаяПрибыль.Стоимость - ВаловаяПрибыль.СебестоимостьСУчетомБонуса),
	ВЫБОР
		КОГДА ВаловаяПрибыль.КоличествоОборот = 0
			ТОГДА 0
		ИНАЧЕ -ОбратныеПродажи.КоличествоОборот / ВаловаяПрибыль.КоличествоОборот * (ВаловаяПрибыль.Стоимость - ВаловаяПрибыль.СебестоимостьСУчетомБонуса)
	КОНЕЦ

ИНДЕКСИРОВАТЬ ПО
	Заказ
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	ВаловкаПоОплатам.НаправлениеПродаж КАК НаправлениеПродаж,
	ВаловкаПоОплатам.Сделка,
	ВаловкаПоОплатам.ДоговорКонтрагентаВладелец КАК Покупатель,
	ВаловкаПоОплатам.ДоговорКонтрагентаОтветственноеЛицо КАК Менеджер,
	ВаловкаПоОплатам.Оплата КАК Оплата,
	ВаловкаПоОплатам.ВаловаяПрибыль КАК ВаловаяПрибыль,
	ВаловкаПоОплатам.Стоимость КАК Стоимость,
	ВаловкаПоОплатам.ОплаченнаяВаловаяПрибыль КАК ОплаченнаяВаловаяПрибыль,
	ВаловкаПоОплатам.ВаловаяПрибыльСУчетомБонуса,
	ВаловкаПоОплатам.ОплаченнаяВаловаяПрибыльСУчетомБонуса,
	ВаловкаПоОплатам.ПриходДенег
ИЗ
	ВаловкаПоОплатам КАК ВаловкаПоОплатам

ОБЪЕДИНИТЬ ВСЕ

ВЫБРАТЬ
	ВаловкаПоОбратнымПродажам.ЗаказДоговорКонтрагентаОтветственноеЛицоНаправлениеПродаж,
	ВаловкаПоОбратнымПродажам.Заказ,
	ВаловкаПоОбратнымПродажам.ЗаказДоговорКонтрагентаВладелец,
	ВаловкаПоОбратнымПродажам.ЗаказДоговорКонтрагентаОтветственноеЛицо,
	ВаловкаПоОбратнымПродажам.Оплата,
	ВаловкаПоОбратнымПродажам.ВаловаяПрибыль,
	ВаловкаПоОбратнымПродажам.Стоимость,
	ВаловкаПоОбратнымПродажам.ОплаченнаяВаловаяПрибыль,
	ВаловкаПоОбратнымПродажам.ВаловаяПрибыльСУчетомБонуса,
	ВаловкаПоОбратнымПродажам.ОплаченнаяВаловаяПрибыльСУчетомБонуса,
	NULL
ИЗ
	ВаловкаПоОбратнымПродажам КАК ВаловкаПоОбратнымПродажам</query>
		</dataSet>
		<totalField>
			<dataPath>ВаловаяПрибыль</dataPath>
			<expression>Сумма(ВаловаяПрибыль)</expression>
		</totalField>
		<totalField>
			<dataPath>Оплата</dataPath>
			<expression>Сумма(Оплата)</expression>
		</totalField>
		<totalField>
			<dataPath>ОплаченнаяВаловаяПрибыль</dataPath>
			<expression>Сумма(ОплаченнаяВаловаяПрибыль)</expression>
		</totalField>
		<totalField>
			<dataPath>Стоимость</dataPath>
			<expression>Сумма(Стоимость)</expression>
		</totalField>
		<totalField>
			<dataPath>ОплаченнаяВаловаяПрибыльСУчетомБонуса</dataPath>
			<expression>Сумма(ОплаченнаяВаловаяПрибыльСУчетомБонуса)</expression>
		</totalField>
		<totalField>
			<dataPath>ВаловаяПрибыльСУчетомБонуса</dataPath>
			<expression>Сумма(ВаловаяПрибыльСУчетомБонуса)</expression>
		</totalField>
		<totalField>
			<dataPath>ПриходДенег</dataPath>
			<expression>Сумма(ПриходДенег)</expression>
		</totalField>
		<parameter>
			<name>НачалоПериода</name>
			<title xmlns:d4p1="http://v8.1c.ru/8.1/data/core" xsi:type="d4p1:LocalStringType">
				<d4p1:item>
					<d4p1:lang>ru</d4p1:lang>
					<d4p1:content>Начало периода</d4p1:content>
				</d4p1:item>
			</title>
			<valueType>
				<Type xmlns="http://v8.1c.ru/8.1/data/core">xs:dateTime</Type>
				<DateQualifiers xmlns="http://v8.1c.ru/8.1/data/core">
					<DateFractions>DateTime</DateFractions>
				</DateQualifiers>
			</valueType>
			<value xsi:type="xs:dateTime">0001-01-01T00:00:00</value>
			<useRestriction>false</useRestriction>
		</parameter>
		<parameter>
			<name>КонецПериода</name>
			<title xmlns:d4p1="http://v8.1c.ru/8.1/data/core" xsi:type="d4p1:LocalStringType">
				<d4p1:item>
					<d4p1:lang>ru</d4p1:lang>
					<d4p1:content>Конец периода</d4p1:content>
				</d4p1:item>
			</title>
			<valueType>
				<Type xmlns="http://v8.1c.ru/8.1/data/core">xs:dateTime</Type>
				<DateQualifiers xmlns="http://v8.1c.ru/8.1/data/core">
					<DateFractions>DateTime</DateFractions>
				</DateQualifiers>
			</valueType>
			<value xsi:type="xs:dateTime">0001-01-01T00:00:00</value>
			<useRestriction>false</useRestriction>
			<expression>КонецПериода(&amp;КонецПериода,"День")</expression>
		</parameter>
		<parameter>
			<name>Кон</name>
			<title xmlns:d4p1="http://v8.1c.ru/8.1/data/core" xsi:type="d4p1:LocalStringType">
				<d4p1:item>
					<d4p1:lang>ru</d4p1:lang>
					<d4p1:content>Кон</d4p1:content>
				</d4p1:item>
			</title>
			<valueType>
				<Type xmlns="http://v8.1c.ru/8.1/data/core">xs:dateTime</Type>
				<DateQualifiers xmlns="http://v8.1c.ru/8.1/data/core">
					<DateFractions>DateTime</DateFractions>
				</DateQualifiers>
			</valueType>
			<value xsi:type="xs:dateTime">0001-01-01T00:00:00</value>
			<useRestriction>true</useRestriction>
			<expression>КонецПериода(&amp;КонецПериода,"День")</expression>
		</parameter>
		<parameter>
			<name>Нач</name>
			<title xmlns:d4p1="http://v8.1c.ru/8.1/data/core" xsi:type="d4p1:LocalStringType">
				<d4p1:item>
					<d4p1:lang>ru</d4p1:lang>
					<d4p1:content>Нач</d4p1:content>
				</d4p1:item>
			</title>
			<valueType>
				<Type xmlns="http://v8.1c.ru/8.1/data/core">xs:dateTime</Type>
				<DateQualifiers xmlns="http://v8.1c.ru/8.1/data/core">
					<DateFractions>DateTime</DateFractions>
				</DateQualifiers>
			</valueType>
			<value xsi:type="xs:dateTime">0001-01-01T00:00:00</value>
			<useRestriction>true</useRestriction>
			<expression>ДобавитькДате(&amp;НачалоПериода,"Год",-1)</expression>
		</parameter>
		<parameter>
			<name>ПустаяДата</name>
			<title xmlns:d4p1="http://v8.1c.ru/8.1/data/core" xsi:type="d4p1:LocalStringType">
				<d4p1:item>
					<d4p1:lang>ru</d4p1:lang>
					<d4p1:content>Пустая дата</d4p1:content>
				</d4p1:item>
			</title>
			<valueType>
				<Type xmlns="http://v8.1c.ru/8.1/data/core">xs:dateTime</Type>
				<DateQualifiers xmlns="http://v8.1c.ru/8.1/data/core">
					<DateFractions>DateTime</DateFractions>
				</DateQualifiers>
			</valueType>
			<value xsi:type="xs:dateTime">0001-01-01T00:00:00</value>
			<useRestriction>true</useRestriction>
			<expression>ДатаВремя(1,1,1)</expression>
		</parameter>
		<settingsVariant>
			<name xmlns="http://v8.1c.ru/8.1/data-composition-system/settings">Основной</name>
			<presentation xmlns="http://v8.1c.ru/8.1/data-composition-system/settings" xsi:type="xs:string">Основной</presentation>
		</settingsVariant>
	</dataCompositionSchema>
</SchemaFile>﻿<?xml version="1.0" encoding="UTF-8"?>
<Settings xmlns="http://v8.1c.ru/8.1/data-composition-system/settings" xmlns:dcscor="http://v8.1c.ru/8.1/data-composition-system/core" xmlns:style="http://v8.1c.ru/8.1/data/ui/style" xmlns:sys="http://v8.1c.ru/8.1/data/ui/fonts/system" xmlns:v8="http://v8.1c.ru/8.1/data/core" xmlns:v8ui="http://v8.1c.ru/8.1/data/ui" xmlns:web="http://v8.1c.ru/8.1/data/ui/colors/web" xmlns:win="http://v8.1c.ru/8.1/data/ui/colors/windows" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
	<selection>
		<item xsi:type="SelectedItemField">
			<field>Стоимость</field>
		</item>
		<item xsi:type="SelectedItemField">
			<field>ВаловаяПрибыль</field>
		</item>
		<item xsi:type="SelectedItemField">
			<field>ВаловаяПрибыльСУчетомБонуса</field>
		</item>
		<item xsi:type="SelectedItemField">
			<field>ПриходДенег</field>
		</item>
		<item xsi:type="SelectedItemField">
			<field>Оплата</field>
		</item>
		<item xsi:type="SelectedItemField">
			<field>ОплаченнаяВаловаяПрибыль</field>
		</item>
		<item xsi:type="SelectedItemField">
			<field>ОплаченнаяВаловаяПрибыльСУчетомБонуса</field>
		</item>
	</selection>
	<outputParameters>
		<dcscor:item xsi:type="SettingsParameterValue">
			<dcscor:parameter>ВыводитьПараметрыДанных</dcscor:parameter>
			<dcscor:value xsi:type="DataCompositionTextOutputType">Output</dcscor:value>
		</dcscor:item>
	</outputParameters>
	<item xsi:type="StructureItemGroup">
		<groupItems>
			<item xsi:type="GroupItemField">
				<field>НаправлениеПродаж</field>
				<groupType>Items</groupType>
				<periodAdditionType>None</periodAdditionType>
				<periodAdditionBegin xsi:type="xs:dateTime">0001-01-01T00:00:00</periodAdditionBegin>
				<periodAdditionEnd xsi:type="xs:dateTime">0001-01-01T00:00:00</periodAdditionEnd>
			</item>
		</groupItems>
		<order>
			<item xsi:type="OrderItemAuto"/>
		</order>
		<selection>
			<item xsi:type="SelectedItemAuto"/>
		</selection>
		<item xsi:type="StructureItemGroup">
			<groupItems>
				<item xsi:type="GroupItemField">
					<field>Менеджер</field>
					<groupType>Items</groupType>
					<periodAdditionType>None</periodAdditionType>
					<periodAdditionBegin xsi:type="xs:dateTime">0001-01-01T00:00:00</periodAdditionBegin>
					<periodAdditionEnd xsi:type="xs:dateTime">0001-01-01T00:00:00</periodAdditionEnd>
				</item>
			</groupItems>
			<order>
				<item xsi:type="OrderItemAuto"/>
			</order>
			<selection>
				<item xsi:type="SelectedItemAuto"/>
			</selection>
			<item xsi:type="StructureItemGroup">
				<groupItems>
					<item xsi:type="GroupItemField">
						<field>Покупатель</field>
						<groupType>Items</groupType>
						<periodAdditionType>None</periodAdditionType>
						<periodAdditionBegin xsi:type="xs:dateTime">0001-01-01T00:00:00</periodAdditionBegin>
						<periodAdditionEnd xsi:type="xs:dateTime">0001-01-01T00:00:00</periodAdditionEnd>
					</item>
				</groupItems>
				<order>
					<item xsi:type="OrderItemAuto"/>
				</order>
				<selection>
					<item xsi:type="SelectedItemAuto"/>
				</selection>
				<item xsi:type="StructureItemGroup">
					<order>
						<item xsi:type="OrderItemAuto"/>
						<item xsi:type="OrderItemField">
							<field>Сделка</field>
							<orderType>Asc</orderType>
						</item>
					</order>
					<selection>
						<item xsi:type="SelectedItemAuto"/>
						<item xsi:type="SelectedItemField">
							<field>Сделка</field>
						</item>
					</selection>
				</item>
			</item>
		</item>
	</item>
</Settings>﻿<?xml version="1.0" encoding="UTF-8"?>
<SchemaFile xmlns="" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
	<dataCompositionSchema xmlns="http://v8.1c.ru/8.1/data-composition-system/schema"/>
</SchemaFile>