Перем Соединение;

Функция ПолучитьСоединение(СтрокаСоединенияCOM="", v8="V82")
	
	v8connect = Новый COMОбъект(v8+".ComConnector");
	Попытка
		Соединение = v8connect.Connect(СтрокаСоединенияCOM);
		#Если Клиент Тогда
			ТипБазы = "Ref=";  длТипаБазы=3;
			Если Найти(СтрокаСоединенияCOM,"File=")>0 Тогда		
				ТипБазы = "File="; длТипаБазы=4;
			КонецЕсли;	
			имяБД = Прав(СтрокаСоединенияCOM,стрДлина(СтрокаСоединенияCOM) - найти(СтрокаСоединенияCOM,ТипБазы)-длТипаБазы);
			имяБД = Лев(имяБД, найти(имяБД,";")-1);
			Сообщить("Успешно установлено соединение с "+?(ТипБазы = "Ref=","серверной", "файловой")+" базой: "+имяБД, СтатусСообщения.Информация);
		#КонецЕсли
	Исключение
		#Если Клиент Тогда
			Сообщить("Ошибка при соединении с "+?(ТипБазы = "Ref=","серверной", "файловой")+" базой: "+имяБД+"
			|Ошибка: "+ ОписаниеОшибки(), СтатусСообщения.Внимание);
		#КонецЕсли
		Возврат Неопределено;
	КонецПопытки;
	
	Возврат Соединение;
	
КонецФункции

Функция ПолучитьПоказатели()
	
	Показатели	= новый Структура("СтоимостьБезНДС,НДСПродажи,Стоимость,Себестоимость,Наценка,НаценкаПроц,Затраты,НДСЗакупки,НДСУслуги");
	//------------Соединение---------------------------------
	ИмяПользователя    = "Администратор";
	ПарольПользователя = "cegthuthjq";
	
	СтрокаСоединенияCOM=""; 
	
	Base = "Srvr=""sigma:2041"";Ref=""v82ib_fedunov_ut""";
	UsrPwd = "Usr="""+ИмяПользователя+""";Pwd="""+ПарольПользователя+"""";
	СтрокаСоединенияCOM = Base+";"+UsrPwd;
	Если Соединение = неопределено тогда
		Соединение = ПолучитьСоединение(СтрокаСоединенияCOM); 
		Если Соединение = неопределено тогда
			возврат Показатели;
		КонецЕсли;
	КонецЕсли;
	
	Запрос = Соединение.NewObject("Запрос");
	Запрос.УстановитьПараметр("ДатаН",НачПериода);
	Запрос.УстановитьПараметр("ДатаК",КонецДня(КонПериода));
	Запрос.УстановитьПараметр("СписокКонтрагентовЯШТ",Соединение.Справочники.Контрагенты.НайтиПоКоду("000092773"));
	Запрос.УстановитьПараметр("ОрганизацияАЭ",Соединение.Справочники.Организации.НайтиПоКоду("000000001"));
	
	Запрос.Текст="ВЫБРАТЬ
	|	А.СтоимостьБезНДС,
	|	А.НДС КАК НДСПродажи,
	|	А.Стоимость,
	|	А.Себестоимость,
	|	А.Наценка,
	|	100 * ВЫБОР
	|		КОГДА А.Себестоимость <> 0
	|			ТОГДА А.Наценка / А.Себестоимость
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК НаценкаПроц
	|ИЗ
	|	(ВЫБРАТЬ
	|		СУММА(ПродажиОбороты.СтоимостьОборот - ПродажиОбороты.НДСОборот) КАК СтоимостьБезНДС,
	|		СУММА(ПродажиОбороты.НДСОборот) КАК НДС,
	|		СУММА(ПродажиОбороты.СтоимостьОборот) КАК Стоимость,
	|		СУММА(ЕСТЬNULL(ТаблицаРегистраПродажиСебестоимость.СтоимостьОборот, 0)) КАК Себестоимость,
	|		СУММА(ПродажиОбороты.СтоимостьОборот - ЕСТЬNULL(ТаблицаРегистраПродажиСебестоимость.СтоимостьОборот, 0)) КАК Наценка
	|	ИЗ
	|		РегистрНакопления.Продажи.Обороты(
	|				&ДатаН,
	|				&ДатаК,
	|				Регистратор,
	|				Организация = &ОрганизацияАЭ
	|					И НЕ Контрагент В (&СписокКонтрагентовЯШТ)) КАК ПродажиОбороты
	|			ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|				ПродажиСебестоимость.Номенклатура КАК Номенклатура,
	|				ПродажиСебестоимость.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
	|				ПродажиСебестоимость.ЗаказПокупателя КАК ЗаказПокупателя,
	|				ВЫБОР
	|					КОГДА ПродажиСебестоимость.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|						ТОГДА ПродажиСебестоимость.ДокументДвижения
	|					ИНАЧЕ ПродажиСебестоимость.Регистратор
	|				КОНЕЦ КАК Регистратор,
	|				СУММА(ПродажиСебестоимость.Стоимость) КАК СтоимостьОборот
	|			ИЗ
	|				РегистрНакопления.ПродажиСебестоимость КАК ПродажиСебестоимость
	|			ГДЕ
	|				ПродажиСебестоимость.Период МЕЖДУ &ДатаН И &ДатаК
	|			
	|			СГРУППИРОВАТЬ ПО
	|				ПродажиСебестоимость.Номенклатура,
	|				ПродажиСебестоимость.ХарактеристикаНоменклатуры,
	|				ПродажиСебестоимость.ЗаказПокупателя,
	|				ВЫБОР
	|					КОГДА ПродажиСебестоимость.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|						ТОГДА ПродажиСебестоимость.ДокументДвижения
	|					ИНАЧЕ ПродажиСебестоимость.Регистратор
	|				КОНЕЦ) КАК ТаблицаРегистраПродажиСебестоимость
	|			ПО (ТаблицаРегистраПродажиСебестоимость.Номенклатура = ПродажиОбороты.Номенклатура)
	|				И (ТаблицаРегистраПродажиСебестоимость.ХарактеристикаНоменклатуры = ПродажиОбороты.ХарактеристикаНоменклатуры)
	|				И (ТаблицаРегистраПродажиСебестоимость.ЗаказПокупателя = ПродажиОбороты.ЗаказПокупателя)
	|				И (ТаблицаРегистраПродажиСебестоимость.Регистратор = ПродажиОбороты.Регистратор)) КАК А";
	
	//----------------------------------------свободные остатки----------------------------------------	
	#Если Клиент тогда
		Состояние(" Идет получение роказателей в базе АЭ");
	#КонецЕсли
	Рез = Запрос.Выполнить().Выбрать();
	
	Пока Рез.Следующий() цикл
		ЗаполнитьЗначенияСвойств(Показатели,рез);
		Показатели.НДСЗакупки = рез.Себестоимость/118*18;
	КонецЦикла;
	
	СписокСтатейНалоги = Соединение.NewObject("СписокЗначений");
	СписокСтатейНалоги.Добавить(Соединение.Справочники.СтатьиЗатрат.НайтиПоКоду("О00000079"));
	СписокСтатейНалоги.Добавить(Соединение.Справочники.СтатьиЗатрат.НайтиПоКоду("О00000080"));
	СписокСтатейНалоги.Добавить(Соединение.Справочники.СтатьиЗатрат.НайтиПоКоду("000002009"));
	СписокСтатейНалоги.Добавить(Соединение.Справочники.СтатьиЗатрат.НайтиПоКоду("О00000081"));
	Запрос.УстановитьПараметр("СписокСтатейНалоги",СписокСтатейНалоги);

	Запрос.Текст = "ВЫБРАТЬ
	|СУММА(ЗатратыОбороты.СуммаОборот) КАК Затраты
	|ИЗ
	|РегистрНакопления.Затраты.Обороты(&ДатаН, &ДатаК, , НЕ СтатьяЗатрат В (&СписокСтатейНалоги)) КАК ЗатратыОбороты";
	Рез = Запрос.Выполнить().Выбрать();
	
	Пока Рез.Следующий() цикл
		ЗаполнитьЗначенияСвойств(Показатели,рез);
	КонецЦикла;
		
	Запрос.Текст = "ВЫБРАТЬ
	|	СУММА(ЗакупкиОбороты.НДСОборот) КАК НДСУслуги
	|ИЗ
	|	РегистрНакопления.Закупки.Обороты(
	|			&ДатаН,
	|			&ДатаК,
	|			,
	|			Организация = &ОрганизацияАЭ
	|				И Номенклатура.Услуга) КАК ЗакупкиОбороты";
	Рез = Запрос.Выполнить().Выбрать();
	
	Пока Рез.Следующий() цикл
		ЗаполнитьЗначенияСвойств(Показатели,рез);
	КонецЦикла;

	
	Возврат Показатели;
КонецФункции



Процедура КнопкаСформироватьНажатие(Кнопка)
	ОборотЯШТ			 = 0;
	ВаловыйДоходЯШТ 	 = 0;
	НаценкаПроцЯШТ 		 = 0;
	ЗатратыБезНалоговЯШТ = 0;
    EBITDA_P_ЯШТ 		 = 0;
	EBITDA_Проц_ЯШТ 	 = 0;
	
	ПоказателиАЭ = ПолучитьПоказатели();
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("НачПериод",				 НачПериода);
	Запрос.УстановитьПараметр("КонПериод",				 КонецДня(КонПериода));
	Запрос.УстановитьПараметр("РезервИМ",				 Справочники.Контрагенты.НайтиПоКоду("П004703"));
	Запрос.УстановитьПараметр("Автоэксперт",			 Справочники.Контрагенты.НайтиПоКоду("П000382"));
	Запрос.УстановитьПараметр("ОтделИП",				 Справочники.Подразделения.НайтиПоКоду("00139"));
	Запрос.УстановитьПараметр("СписокСтатейИсключаемых", Справочники.СтатьиЗатрат.НайтиПоКоду("О0023")); //Налоги (по видам налогов)
	Запрос.УстановитьПараметр("НалогЗП",				 Справочники.СтатьиЗатрат.НайтиПоКоду("А0029")); //Налоги от заработной платы
	Запрос.УстановитьПараметр("МенеджерКачалов",		 Справочники.Пользователи.НайтиПоКоду("Качалов"));

	//Оборот
	Запрос.Текст="ВЫБРАТЬ
	             |	СУММА(ПродажиОбороты.СтоимостьОборот) КАК ОборотЯШТ,
	             |	""Оборот"" КАК Показатель
	             |ИЗ
	             |	РегистрНакопления.Продажи.Обороты(
	             |			&НачПериод,
	             |			&КонПериод,
	             |			,
	             |			(ДоговорКонтрагента.Владелец.КонтрагентДляРезерваИМ = &РезервИМ
	             |				ИЛИ ДоговорКонтрагента.Владелец.ОсновнойМенеджерКонтрагента = &МенеджерКачалов)
	             |				И НЕ ДоговорКонтрагента.Владелец = &Автоэксперт) КАК ПродажиОбороты";
	Рез =Запрос.Выполнить().Выбрать();
	Пока Рез.Следующий() цикл
		ОборотЯШТ = рез.ОборотЯШТ;
	КонецЦикла;
	
	//Наценка
	Запрос.Текст="ВЫБРАТЬ
	             |	ЗапросНаценка.Продажи,
	             |	ЗапросНаценка.Себестоимость,
	             |	ЗапросНаценка.ВаловаяПрибыль,
	             |	100 * ВЫБОР
	             |		КОГДА ЗапросНаценка.Себестоимость <> 0
	             |			ТОГДА ЗапросНаценка.ВаловаяПрибыль / ЗапросНаценка.Себестоимость
	             |		ИНАЧЕ 0
	             |	КОНЕЦ КАК НаценкаПроц
	             |ИЗ
	             |	(ВЫБРАТЬ
	             |		СУММА(ПродажиОбороты.СтоимостьОборот) КАК Продажи,
	             |		СУММА(ЕСТЬNULL(ПродажиСебестоимостьОбороты.СтоимостьОборот, 0)) КАК Себестоимость,
	             |		СУММА(ПродажиОбороты.СтоимостьОборот - ЕСТЬNULL(ПродажиСебестоимостьОбороты.СтоимостьОборот, 0)) КАК ВаловаяПрибыль
	             |	ИЗ
	             |		РегистрНакопления.Продажи.Обороты(
	             |				&НачПериод,
	             |				&КонПериод,
	             |				Регистратор,
	             |				ДоговорКонтрагента.Владелец.КонтрагентДляРезерваИМ = &РезервИМ
	             |					И НЕ ДоговорКонтрагента.Владелец = &Автоэксперт) КАК ПродажиОбороты
	             |			ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ПродажиСебестоимость.Обороты(&НачПериод, &КонПериод, Регистратор, ) КАК ПродажиСебестоимостьОбороты
	             |			ПО ПродажиОбороты.Номенклатура = ПродажиСебестоимостьОбороты.Номенклатура
	             |				И ПродажиОбороты.ХарактеристикаНоменклатуры = ПродажиСебестоимостьОбороты.ХарактеристикаНоменклатуры
	             |				И ПродажиОбороты.ЗаказПокупателя = ПродажиСебестоимостьОбороты.ЗаказПокупателя
	             |				И ПродажиОбороты.Регистратор = ПродажиСебестоимостьОбороты.Регистратор
	             |				И ПродажиОбороты.Подразделение = ПродажиСебестоимостьОбороты.Подразделение) КАК ЗапросНаценка";
	Рез =Запрос.Выполнить().Выбрать();
	Пока Рез.Следующий() цикл
		ВаловыйДоходЯШТ = рез.ВаловаяПрибыль;
		НаценкаПроцЯШТ = рез.НаценкаПроц;
		СебестоимостьЯШТ= Рез.Себестоимость;
	КонецЦикла;
	
	//Затраты
	Запрос.Текст="ВЫБРАТЬ
	             |	СУММА(ЗатратыОбороты.СуммаОборот) КАК Затраты
	             |ИЗ                                                                
	             |	РегистрНакопления.Затраты.Обороты(
	             |			&НачПериод,
	             |			&КонПериод,
	             |			,
	             |			Подразделение = &ОтделИП
	             |				И НЕ СтатьяЗатрат В ИЕРАРХИИ (&СписокСтатейИсключаемых)
	             |				И НЕ СтатьяЗатрат = &НалогЗП) КАК ЗатратыОбороты";
	Рез =Запрос.Выполнить().Выбрать();
	Пока Рез.Следующий() цикл
		ЗатратыБезНалоговЯШТ = рез.Затраты;
	КонецЦикла;
	
	//ндс вход
	Запрос.Текст="ВЫБРАТЬ
	             |	СУММА(ПоступлениеТоваровУслугУслуги.СуммаНДС) КАК СуммаНДС
	             |ИЗ
	             |	Документ.ПоступлениеТоваровУслуг.Услуги КАК ПоступлениеТоваровУслугУслуги
	             |ГДЕ
	             |	ПоступлениеТоваровУслугУслуги.Ссылка.Проведен
	             |	И ПоступлениеТоваровУслугУслуги.Ссылка.Дата МЕЖДУ &НачПериод И &КонПериод
	             |	И ПоступлениеТоваровУслугУслуги.Подразделение = &ОтделИП";
  Рез = Запрос.Выполнить().Выбрать();
  НДСВходЯШТУслуги = 0;
  Пока Рез.Следующий() цикл
		НДСВходЯШТУслуги = рез.СуммаНДС;
 КонецЦикла;
				 
	
	Макет = ПолучитьМакет("Макет");
	Область = Макет.ПолучитьОбласть("Показатели");
	Область.Параметры.ОборотЯШТ=ОборотЯШТ;
	//Область.Параметры.НаценкаПроцЯШТ=НаценкаПроцЯШТ;
	Область.Параметры.ВаловыйДоходЯШТ=ВаловыйДоходЯШТ;
    Область.Параметры.ЗатратыЯШТ=ЗатратыБезНалоговЯШТ;
	
	Область.Параметры.ОборотАЭ=ПоказателиАЭ.Стоимость;
	//Область.Параметры.НаценкаПроцАЭ=ПоказателиАЭ.НаценкаПроц;

	Область.Параметры.ВаловыйДоходАЭ=ПоказателиАЭ.Наценка;
    Область.Параметры.ЗатратыАЭ=ПоказателиАЭ.Затраты;

	
	EBITDA_P_ЯШТ = ВаловыйДоходЯШТ - ЗатратыБезНалоговЯШТ ;
	EBITDA_Проц_ЯШТ = 100*?(СебестоимостьЯШТ<>0,EBITDA_P_ЯШТ/СебестоимостьЯШТ,0);

	//Область.Параметры.EBITDA_P_ЯШТ=0;//EBITDA_P_ЯШТ;
	//Область.Параметры.EBITDA_Проц_ЯШТ=0;//=EBITDA_Проц_ЯШТ;


	Область.Параметры.ОборотИтого=ОборотЯШТ+ПоказателиАЭ.Стоимость;
	//Область.Параметры.НаценкаПроцИтого=НаценкаПроцЯШТ+ПоказателиАЭ.НаценкаПроц;
	//Область.Параметры.НаценкаПроцИтого=100*(ВаловыйДоходЯШТ+ПоказателиАЭ.Наценка)/(СебестоимостьЯШТ+ПоказателиАЭ.Себестоимость);
	Область.Параметры.ВаловыйДоходИтого=ВаловыйДоходЯШТ+ПоказателиАЭ.Наценка;
	Область.Параметры.ЗатратыИтого=ЗатратыБезНалоговЯШТ+ПоказателиАЭ.Затраты;
	
	EBITDA_P_АЭ = ПоказателиАЭ.Наценка - ПоказателиАЭ.Затраты;
	EBITDA_Проц_АЭ = 100*?(ПоказателиАЭ.Себестоимость<>0,EBITDA_P_АЭ/ПоказателиАЭ.Себестоимость,0);
	Область.Параметры.EBITDA_P_АЭ=0;//EBITDA_P_АЭ;
	Область.Параметры.EBITDA_Проц_АЭ=0;//EBITDA_Проц_АЭ;
	
	Область.Параметры.EBITDA_P_Итого=EBITDA_P_ЯШТ+EBITDA_P_АЭ;
	Область.Параметры.EBITDA_Проц_Итого=100*(Область.Параметры.EBITDA_P_Итого)/(ПоказателиАЭ.Себестоимость+СебестоимостьЯШТ);//EBITDA_Проц_ЯШТ+EBITDA_Проц_АЭ;
	
	
	
	Область.Параметры.Вход_ндс_АЭ=ПоказателиАЭ.Себестоимость/118*18+ПоказателиАЭ.НДСУслуги;//-ПоказателиАЭ.НДСПродажи;
	Область.Параметры.Исх_ндс_АЭ=(ПоказателиАЭ.Стоимость)/118*18;//-ПоказателиАЭ.НДСЗакупки;
	Область.Параметры.НДС_АЭ=?(Область.Параметры.Исх_ндс_АЭ-Область.Параметры.Вход_ндс_АЭ<0,0,Область.Параметры.Исх_ндс_АЭ-Область.Параметры.Вход_ндс_АЭ);
	
	//Область.Параметры.НДС_ЯШТ=ОборотЯШТ/118*18 - СебестоимостьЯШТ/118*18;
	Область.Параметры.Вход_ндс_ЯШТ=СебестоимостьЯШТ/118*18+НДСВходЯШТУслуги;
	Область.Параметры.Исх_ндс_ЯШТ=(ОборотЯШТ)/118*18;
	Область.Параметры.НДС_ЯШТ=?(Область.Параметры.Исх_ндс_ЯШТ-Область.Параметры.Вход_ндс_ЯШТ<0,0,Область.Параметры.Исх_ндс_ЯШТ-Область.Параметры.Вход_ндс_ЯШТ);
	
	Область.Параметры.НДС_Итого=Область.Параметры.НДС_АЭ+Область.Параметры.НДС_ЯШТ;
	Область.Параметры.Вход_ндс_Итого=Область.Параметры.Вход_ндс_АЭ+Область.Параметры.Вход_ндс_ЯШТ;
	Область.Параметры.Исх_ндс_Итого=Область.Параметры.Исх_ндс_АЭ+Область.Параметры.Исх_ндс_ЯШТ;
	Область.Параметры.НДС_Итого=Область.Параметры.Исх_ндс_Итого-Область.Параметры.Вход_ндс_Итого;
	
	
	Область.Параметры.НалогНаПрибыль_ЯШТ=0;//((ВаловыйДоходЯШТ)/118*18-ЗатратыБезНалоговЯШТ)*0.2;
	Область.Параметры.НалогНаПрибыль_АЭ=0;//((ПоказателиАЭ.Наценка)/118*18-ПоказателиАЭ.Затраты)*0.2;
	//Область.Параметры.НалогНаПрибыль_Итого=Область.Параметры.НалогНаПрибыль_ЯШТ+Область.Параметры.НалогНаПрибыль_АЭ;
	Область.Параметры.НалогНаПрибыль_Итого=?((Область.Параметры.EBITDA_P_Итого-Область.Параметры.НДС_Итого)*0.2<0,0,(Область.Параметры.EBITDA_P_Итого-Область.Параметры.НДС_Итого)*0.2);
	
	//Область.Параметры.ИтогоНалогов_ЯШТ=Область.Параметры.Вход_ндс_ЯШТ-Область.Параметры.Исх_ндс_ЯШТ+Область.Параметры.НалогНаПрибыль_ЯШТ;
	//Область.Параметры.ИтогоНалогов_АЭ=Область.Параметры.Вход_ндс_АЭ-Область.Параметры.Исх_ндс_АЭ+Область.Параметры.НалогНаПрибыль_АЭ;
	//Область.Параметры.ИтогоНалогов_ИТОГО = Область.Параметры.ИтогоНалогов_ЯШТ+Область.Параметры.ИтогоНалогов_АЭ;
    Область.Параметры.ИтогоНалогов_ИТОГО = Область.Параметры.НалогНаПрибыль_Итого+Область.Параметры.НДС_Итого;
	Область.Параметры.ИтогоПрибыль_ЯШТ = 0;
	Область.Параметры.ИтогоПрибыль_АЭ =0;
	
	Область.Параметры.ИтогоПрибыль_Итого	=  Область.Параметры.EBITDA_P_Итого-Область.Параметры.НДС_Итого-Область.Параметры.НалогНаПрибыль_Итого;
	
	ТабличныйДокумент = Новый ТабличныйДокумент;
	ТабличныйДокумент.Вывести(Область);
	ТабличныйДокумент.Показать();
КонецПроцедуры

Процедура ВыбПериодНажатие(Элемент)
	НастройкаПериода = Новый НастройкаПериода;
	НастройкаПериода.РедактироватьКакИнтервал = Истина;
	НастройкаПериода.РедактироватьКакПериод = Истина;
	НастройкаПериода.ВариантНастройки = ВариантНастройкиПериода.Период;
	НастройкаПериода.УстановитьПериод(НачПериода, ?(КонПериода='0001-01-01', КонПериода, КонецДня(КонПериода)));
	Если НастройкаПериода.Редактировать() Тогда
		НачПериода = НастройкаПериода.ПолучитьДатуНачала();
		КонПериода = НастройкаПериода.ПолучитьДатуОкончания();
	КонецЕсли;
КонецПроцедуры


Соединение=неопределено;