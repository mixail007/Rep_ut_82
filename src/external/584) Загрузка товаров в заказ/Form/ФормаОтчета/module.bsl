перем ПервыйДень,ПоследнийДень;

Процедура КоманднаяПанель1Заполнить(Кнопка)
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ВЫБОР
		|		КОГДА ПланДвиженийДенежныхСредств.Статья.Родитель.Родитель = ЗНАЧЕНИЕ(справочник.СтатьиРасходов.пустаяСсылка)
		|			ТОГДА ПланДвиженийДенежныхСредств.Статья.Родитель
		|		ИНАЧЕ ПланДвиженийДенежныхСредств.Статья.Родитель.Родитель
		|	КОНЕЦ КАК СтатьяРодительРодитель,
		|	ПланДвиженийДенежныхСредств.Статья.Родитель КАК СтатьяРодитель,
		|	ПланДвиженийДенежныхСредств.Статья КАК Статья,
		|	ПланДвиженийДенежныхСредств.Контрагент КАК Контрагент,
		|	ПланДвиженийДенежныхСредств.ОтветственноеЛицо КАК ОтветственноеЛицо,
		|	СУММА(ЕСТЬNULL(ПланДвиженийДенежныхСредств.Неделя1, 0)) КАК Неделя1,
		|	СУММА(ЕСТЬNULL(ПланДвиженийДенежныхСредств.Неделя2, 0)) КАК Неделя2,
		|	СУММА(ЕСТЬNULL(ПланДвиженийДенежныхСредств.Неделя3, 0)) КАК Неделя3,
		|	СУММА(ЕСТЬNULL(ПланДвиженийДенежныхСредств.Неделя4, 0)) КАК Неделя4,
		|	СУММА(ЕСТЬNULL(ПланДвиженийДенежныхСредств.Неделя5, 0)) КАК Неделя5,
		|	СУММА(ЕСТЬNULL(ПланДвиженийДенежныхСредств.Перенос, 0)) КАК Перенос,
		|	ПланДвиженийДенежныхСредств.Согласован,
		|	ПланДвиженийДенежныхСредств.Утвержден,
		|	ПланДвиженийДенежныхСредств.Принят,
		|	ВЫБОР
		|		КОГДА ПланДвиженийДенежныхСредств.Статья.Родитель.Родитель = ЗНАЧЕНИЕ(справочник.СтатьиРасходов.пустаяСсылка)
		|			ТОГДА ПланДвиженийДенежныхСредств.Статья.Родитель.Код
		|		ИНАЧЕ ПланДвиженийДенежныхСредств.Статья.Родитель.Родитель.Код
		|	КОНЕЦ КАК Поле1,
		|	ПланДвиженийДенежныхСредств.Статья.Код КАК СтатьяКод,
		|	ЕСТЬNULL(ПланДвиженийДенежныхСредств.Неделя1, 0) + ЕСТЬNULL(ПланДвиженийДенежныхСредств.Неделя2, 0) + ЕСТЬNULL(ПланДвиженийДенежныхСредств.Неделя3, 0) + ЕСТЬNULL(ПланДвиженийДенежныхСредств.Неделя4, 0) + ЕСТЬNULL(ПланДвиженийДенежныхСредств.Неделя5, 0) КАК Итого
		|ИЗ
		|	РегистрСведений.ПланДвиженийДенежныхСредств КАК ПланДвиженийДенежныхСредств
		|ГДЕ
		|	ПланДвиженийДенежныхСредств.МесяцПланирования = &МесяцПланирования
		|	И ПланДвиженийДенежныхСредств.АктивностьЗаписи = ИСТИНА
		|
		|СГРУППИРОВАТЬ ПО
		|	ПланДвиженийДенежныхСредств.Утвержден,
		|	ПланДвиженийДенежныхСредств.Принят,
		|	ПланДвиженийДенежныхСредств.Согласован,
		|	ПланДвиженийДенежныхСредств.Контрагент,
		|	ПланДвиженийДенежныхСредств.ОтветственноеЛицо,
		|	ПланДвиженийДенежныхСредств.ПриходРасход,
		|	ПланДвиженийДенежныхСредств.Статья,
		|	ПланДвиженийДенежныхСредств.Статья.Родитель,
		|	ВЫБОР
		|		КОГДА ПланДвиженийДенежныхСредств.Статья.Родитель.Родитель = ЗНАЧЕНИЕ(справочник.СтатьиРасходов.пустаяСсылка)
		|			ТОГДА ПланДвиженийДенежныхСредств.Статья.Родитель
		|		ИНАЧЕ ПланДвиженийДенежныхСредств.Статья.Родитель.Родитель
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА ПланДвиженийДенежныхСредств.Статья.Родитель.Родитель = ЗНАЧЕНИЕ(справочник.СтатьиРасходов.пустаяСсылка)
		|			ТОГДА ПланДвиженийДенежныхСредств.Статья.Родитель.Код
		|		ИНАЧЕ ПланДвиженийДенежныхСредств.Статья.Родитель.Родитель.Код
		|	КОНЕЦ,
		|	ПланДвиженийДенежныхСредств.Статья.Код,
		|	ЕСТЬNULL(ПланДвиженийДенежныхСредств.Неделя1, 0) + ЕСТЬNULL(ПланДвиженийДенежныхСредств.Неделя2, 0) + ЕСТЬNULL(ПланДвиженийДенежныхСредств.Неделя3, 0) + ЕСТЬNULL(ПланДвиженийДенежныхСредств.Неделя4, 0) + ЕСТЬNULL(ПланДвиженийДенежныхСредств.Неделя5, 0)
		|
		|УПОРЯДОЧИТЬ ПО
		|	Поле1,
		|	СтатьяКод
		|ИТОГИ
		|	СУММА(Неделя1),
		|	СУММА(Неделя2),
		|	СУММА(Неделя3),
		|	СУММА(Неделя4),
		|	СУММА(Неделя5),
		|	СУММА(Перенос),
		|	СУММА(Итого)
		|ПО
		|	СтатьяРодительРодитель,
		|	СтатьяРодитель,
		|	Статья,
		|	ОтветственноеЛицо";

	Запрос.УстановитьПараметр("МесяцПланирования", МесяцПланирования);


	ЭлементыФормы.Планирование.Значение = Запрос.Выполнить().Выгрузить(ОбходРезультатаЗапроса.ПоГруппировкам);
	
	Для каждого приходРасход из ЭлементыФормы.Планирование.Значение.Строки Цикл
		приходРасход.статья = приходРасход.статьяРодительРодитель;
		для каждого статья из ПриходРасход.Строки Цикл
				Статья.статья = Статья.статьяРодитель;
				Для каждого строка из Статья.Строки Цикл
					Если строка.статьяРодительРодитель = справочники.СтатьиРасходов.ДОХОДЫ тогда
						Строка.Строки.Очистить();
					конецЕсли;	
                конецЦикла;
		конецЦикла;
	конецЦикла;
	
показатьОбщийБаланс();	
КонецПроцедуры

Процедура КоманднаяПанель1Принять(Кнопка)
	// Вставить содержимое обработчика.
КонецПроцедуры


Процедура ПланированиеПриПолученииДанных(Элемент, ОформленияСтрок)
	Для каждого стр из ОформленияСтрок Цикл
		Данные =стр.ДанныеСтроки;
		Если  Данные.ответственноеЛицо = Null Тогда //значит не детальные записи
			стр.ЦветФона = webцвета.БледноЗолотистый;
			если данные.статья.ЭтоГруппа Тогда
				ВыделитьЖирным = Истина;
			иначе
				ВыделитьЖирным = Ложь;
			конецЕсли;	
			Для каждого ячейка из стр.ячейки Цикл
				Ячейка.ТолькоПросмотр = Истина;
				Если выделитьЖирным Тогда
				Ячейка.Шрифт =  Новый Шрифт(,,Истина,,);
                конецЕсли;
			конецЦикла;	
		иначеЕсли не рольДоступна("яштФинДиректор")тогда
			Ячейка.ТолькоПросмотр = Истина;
		конецЕсли;	
	конецЦИкла;
	ПересчетИтогов();
КонецПроцедуры

Процедура ПересчетИтогов()
	итогоНеделя1 = 0;
	итогоНеделя2 = 0;
	итогоНеделя3 = 0;
	итогоНеделя4 = 0;
	итогоНеделя5 = 0;
	итогоПеренос = 0;
	итогоИтого = 0;
	Для каждого стр из ЭлементыФормы.Планирование.Значение.Строки Цикл	
		Если стр.статья = Справочники.СтатьиРасходов.РАСХОДЫ тогда
			к=-1;
		иначе	
			к=1;
		конецЕсли;
		итогоНеделя1 = итогоНеделя1+к*стр.неделя1;
		итогоНеделя2 = итогоНеделя2+к*стр.неделя2;
		итогоНеделя3 = итогоНеделя3+к*стр.неделя3;
		итогоНеделя4 = итогоНеделя4+к*стр.неделя4;
		итогоНеделя5 = итогоНеделя5+к*стр.неделя5;
		итогоПеренос = итогоПеренос+к*стр.Перенос;
		ИтогоИтого   = итогоИтого+к*стр.Итого;
	конецЦикла;	
	ЭлементыФормы.Планирование.Колонки.Неделя1.ТекстПодвала = ОстатокДенежныхСредств+итогоНеделя1;
	ЭлементыФормы.Планирование.Колонки.Неделя2.ТекстПодвала = ОстатокДенежныхСредств+итогоНеделя1+итогоНеделя2;
	ЭлементыФормы.Планирование.Колонки.Неделя3.ТекстПодвала = ОстатокДенежныхСредств+итогоНеделя1+итогоНеделя2+итогоНеделя3;
	ЭлементыФормы.Планирование.Колонки.Неделя4.ТекстПодвала = ОстатокДенежныхСредств+итогоНеделя1+итогоНеделя2+итогоНеделя3+итогоНеделя4;
	ЭлементыФормы.Планирование.Колонки.Неделя5.ТекстПодвала = ОстатокДенежныхСредств+итогоНеделя1+итогоНеделя2+итогоНеделя3+итогоНеделя4+итогоНеделя5;
	ЭлементыФормы.Планирование.Колонки.Перенос.ТекстПодвала = итогоПеренос;
    ЭлементыФормы.Планирование.Колонки.Итого.ТекстПодвала =  ОстатокДенежныхСредств+ИтогоИтого;

конецПроцедуры	

Процедура ПланированиеНеделя1ПриИзменении(Элемент)
	строка = ЭлементыФормы.Планирование.ТекущиеДанные;
	строка.Итого = Строка.Неделя1+строка.Неделя2+строка.Неделя3+строка.Неделя4+строка.Неделя5;
	ПересчитатьДерево();
КонецПроцедуры

Процедура ПланированиеНеделя2ПриИзменении(Элемент)
	строка = ЭлементыФормы.Планирование.ТекущиеДанные;
	строка.Итого = Строка.Неделя1+строка.Неделя2+строка.Неделя3+строка.Неделя4+строка.Неделя5;
	ПересчитатьДерево();
КонецПроцедуры

Процедура ПланированиеНеделя3ПриИзменении(Элемент)
	строка = ЭлементыФормы.Планирование.ТекущиеДанные;
	строка.Итого = Строка.Неделя1+строка.Неделя2+строка.Неделя3+строка.Неделя4+строка.Неделя5;
	ПересчитатьДерево();
КонецПроцедуры

Процедура ПланированиеНеделя4ПриИзменении(Элемент)
	строка = ЭлементыФормы.Планирование.ТекущиеДанные;
	строка.Итого = Строка.Неделя1+строка.Неделя2+строка.Неделя3+строка.Неделя4+строка.Неделя5;
	ПересчитатьДерево();
КонецПроцедуры

Процедура ПланированиеНеделя5ПриИзменении(Элемент)
	строка = ЭлементыФормы.Планирование.ТекущиеДанные;
	строка.Итого = Строка.Неделя1+строка.Неделя2+строка.Неделя3+строка.Неделя4+строка.Неделя5;
	ПересчитатьДерево();
КонецПроцедуры

Процедура ПланированиеПереносПриИзменении(Элемент)
	ПересчитатьДерево();
КонецПроцедуры

Процедура ПересчитатьДерево()
	 пересчитатьИтогиПоУровню(ЭлементыФормы.Планирование.Значение);
	 ПоказатьОбщийБаланс();
 конецПроцедуры	
 
 процедура пересчитатьИтогиПоУровню(Уровень)
	 Если уровень<>ЭлементыФормы.Планирование.Значение тогда
		 Уровень.неделя1=0;
		 Уровень.неделя2=0;
		 Уровень.неделя3=0;
		 Уровень.неделя4=0;
		 Уровень.неделя5=0;
		 Уровень.перенос=0;
	 конецЕсли; 
	 Для каждого стр из Уровень.строки цикл
		 если стр.Строки.Количество()>0 тогда 	
			 пересчитатьИтогиПоУровню(стр);
		 конецЕсли;
		 Если уровень<>ЭлементыФормы.Планирование.Значение тогда
			 Уровень.неделя1=Уровень.неделя1+стр.неделя1;
			 Уровень.неделя2=Уровень.неделя2+стр.неделя2;
			 Уровень.неделя3=Уровень.неделя3+стр.неделя3;
			 Уровень.неделя4=Уровень.неделя4+стр.неделя4;
			 Уровень.неделя5=Уровень.неделя5+стр.неделя5;
			 Уровень.Итого = Уровень.неделя1+Уровень.неделя2+Уровень.неделя3+Уровень.неделя4+Уровень.неделя5;
			 Уровень.перенос=Уровень.перенос+стр.перенос;
		 конецЕсли;
	 конецЦикла;  
 конецПроцедуры

 Процедура МесяцПланированияПриИзменении(Элемент)
	МесяцПланирования = НачалоМесяца(месяцПланирования); 
	ПервыйДень = Новый Массив(6);
	ПоследнийДень= Новый Массив(6);
	
	ПервыйДень[1] = МесяцПланирования ;
	последнийДень[1] =ПервыйДень[1]+(7- ДеньНедели(МесяцПланирования))*24*60*60;
	//////////////////////////////////////////////////
	ПервыйДень[2] = последнийДень[1]+24*60*60;
	последнийДень[2] =ПервыйДень[2]+(7- ДеньНедели(ПервыйДень[2]))*24*60*60;
	/////////////////////////////////////////////////
	ПервыйДень[3] = последнийДень[2]+24*60*60;
	последнийДень[3] =ПервыйДень[3]+(7- ДеньНедели(ПервыйДень[3]))*24*60*60;
	////////////////////////////////////////////////
	ПервыйДень[4] = последнийДень[3]+24*60*60;
	последнийДень[4] =ПервыйДень[4]+(7- ДеньНедели(ПервыйДень[4]))*24*60*60;
	///////////////////////////////////////	
	ПервыйДень[5] = последнийДень[4]+24*60*60;
	последнийДень[5] =НачалоДня(конецМесяца(МесяцПланирования));

    	Если МесяцПланирования<>Дата(1,1,1) Тогда
		ЭлементыФормы.Планирование.Колонки.Неделя1.ТекстШапки = ""+Формат(ПервыйДень[1], "ДФ=dd.MM")+" - "+Формат(последнийДень[1], "ДФ=dd.MM");
		ЭлементыФормы.Планирование.Колонки.Неделя2.ТекстШапки = ""+Формат(ПервыйДень[2], "ДФ=dd.MM")+" - "+Формат(последнийДень[2], "ДФ=dd.MM");
		ЭлементыФормы.Планирование.Колонки.Неделя3.ТекстШапки = ""+Формат(ПервыйДень[3], "ДФ=dd.MM")+" - "+Формат(последнийДень[3], "ДФ=dd.MM");
		ЭлементыФормы.Планирование.Колонки.Неделя4.ТекстШапки = ""+Формат(ПервыйДень[4], "ДФ=dd.MM")+" - "+Формат(последнийДень[4], "ДФ=dd.MM");
		
		Если НачалоДня(конецМесяца(МесяцПланирования)) > последнийДень[4] тогда
			ЭлементыФормы.Планирование.Колонки.Неделя5.ТекстШапки = ""+Формат(ПервыйДень[5], "ДФ=dd.MM")+" - "+Формат(последнийДень[5], "ДФ=dd.MM");
		иначе
			ЭлементыФормы.Планирование.Колонки.Неделя5.Видимость = Ложь;
		конецесли;
	конецЕсли;
	Если ЭлементыФормы.Панель1.ТекущаяСтраница.Имя = "Страница1" Тогда
	СформироватьНажатие(Истина);	
	иначеЕсли ЭлементыФормы.Панель1.ТекущаяСтраница.Имя = "Страница2" Тогда
	КоманднаяПанель1Заполнить(Истина);	
	конецесли;	

 КонецПроцедуры

 Процедура СформироватьНажатие(Элемент)
	 ЭлементыФормы.Результат.Очистить();
	   СхемаКомпоновкиДанных = ПолучитьМакет("ОсновнаяСхемаКомпоновкиДанных");
    Настройки = СхемаКомпоновкиДанных.НастройкиПоУмолчанию;

	ПараметрСКД = Настройки.ПараметрыДанных.Элементы[0];
    ПараметрСКД.Использование = Истина;
    ПараметрСКД.Значение  = МесяцПланирования;

	//владелец
	ПараметрСКД = Настройки.ПараметрыДанных.Элементы[1];
    ПараметрСКД.Использование = Истина;
    ПараметрСКД.Значение  = Справочники.Организации.НайтиПоКоду("00001");
	//родитель
	ПараметрСКД = Настройки.ПараметрыДанных.Элементы[2];
    ПараметрСКД.Использование = Истина;
    ПараметрСКД.Значение  = Справочники.Кассы.НайтиПоКоду("00019");

    КомпоновщикМакета = Новый КомпоновщикМакетаКомпоновкиДанных;
    МакетКомпоновки = КомпоновщикМакета.Выполнить(СхемаКомпоновкиДанных,Настройки);

    ПроцессорКомпоновкиДанных = Новый ПроцессорКомпоновкиДанных;
    ПроцессорКомпоновкиДанных.Инициализировать(МакетКомпоновки,,,Истина);

 
    ПроцессорВывода = Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВТабличныйДокумент;
    ПроцессорВывода.УстановитьДокумент(ЭлементыФормы.Результат);
    ПроцессорВывода.Вывести(ПроцессорКомпоновкиДанных);
 
	 
	 
 КонецПроцедуры

 Процедура СохранитьНажатие(Элемент)
	ЗаписатьДетальныеЗаписи(ЭлементыФормы.Планирование.Значение,Ложь);
	Выборка = Документы.ПланированиеДвиженийДС.Выбрать(НачалоМесяца(МесяцПланирования),КонецМесяца(МесяцПланирования));
	пока выборка.Следующий()цикл
	Если Выборка.ПометкаУдаления = Ложь тогда	
	докОбъект = Выборка.ПолучитьОбъект();
	докОбъект.Записать(РежимЗаписиДокумента.Проведение);
	конецЕсли;
	конецЦикла;	
 КонецПроцедуры
 
 процедура ЗаписатьДетальныеЗаписи(Уровень,Принять)
	 Для каждого стр из Уровень.строки цикл
		 если стр.Строки.Количество()>0 тогда 	
			 ЗаписатьДетальныеЗаписи(стр,Принять);
		 иначе
			 если стр.Статья.видДвижения = перечисления.ВидыДвиженийПриходРасход.Расход тогда
			 Запись = РегистрыСведений.ПланДвиженийДенежныхСредств.СоздатьМенеджерЗаписи();
			 ЗаполнитьЗначенияСвойств(Запись,стр);
			 Запись.МесяцПланирования = МесяцПланирования;
			 Запись.ПриходРасход = перечисления.ВидыДвиженийПриходРасход.Расход;
			 Запись.АктивностьЗаписи = Истина;
			 Если Принять тогда
				 Запись.Принят = Истина;
			 конецЕсли;	 
			 Запись.Записать(Истина);
			 конецесли;
		 конецЕсли;
	 конецЦикла;  
 конецПроцедуры

 Процедура ПринятьНажатие(Элемент)
	НаборЗаписей = РегистрыСведений.ПланДвиженийДенежныхСредств.СоздатьНаборЗаписей();
	НаборЗаписей.Отбор.МесяцПланирования.Значение = МесяцПланирования;
	НаборЗаписей.Отбор.месяцпланирования.использование =Истина;
	НаборЗаписей.Отбор.АктивностьЗаписи.Значение = Истина;
	НаборЗаписей.Отбор.АктивностьЗаписи.использование =Истина;

	НаборЗаписей.Прочитать();
	Для каждого Запись из НаборЗаписей Цикл
		Запись.Принят = Истина;
	конецЦикла; 
	наборЗаписей.Записать();
 КонецПроцедуры
 
 процедура ПоказатьОбщийБаланс()
//остаток денежных средств	

	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	СУММА(ДенежныеСредстваОстатки.СуммаУпрОстаток) КАК Сумма
		|ИЗ
		|	РегистрНакопления.ДенежныеСредства.Остатки(&Дата, ) КАК ДенежныеСредстваОстатки
		|ГДЕ
		|	(ДенежныеСредстваОстатки.БанковскийСчетКасса.Владелец = &Владелец
		|			ИЛИ ДенежныеСредстваОстатки.БанковскийСчетКасса.Родитель = &Родитель)";

	Запрос.УстановитьПараметр("Владелец", Справочники.Организации.НайтиПоКоду("00001"));
	Запрос.УстановитьПараметр("Родитель", Справочники.Кассы.НайтиПоКоду("00019"));
	Если ТекущаяДата()< МесяцПланирования тогда
	Запрос.УстановитьПараметр("Дата", ТекущаяДата());
	иначе
	Запрос.УстановитьПараметр("Дата",МесяцПланирования);
	конецЕсли;
	Результат = Запрос.Выполнить().Выгрузить();
    ОстатокДенежныхСредств = Результат[0].Сумма;
    ЭлементыФормы.ОстатокНаСчетах.Значение = "Остаток д.с. "+ ОстатокДенежныхСредств+" руб.";
	
	итогоНеделя1 = 0;
	итогоНеделя2 = 0;
	итогоНеделя3 = 0;
	итогоНеделя4 = 0;
	итогоНеделя5 = 0;
	итогоПеренос = 0;
	
	Для каждого стр из ЭлементыФормы.Планирование.Значение.Строки Цикл	
		Если стр.статья = Справочники.СтатьиРасходов.РАСХОДЫ тогда
			к=-1;
		иначе	
			к=1;
		конецЕсли;
		итогоНеделя1 = итогоНеделя1+к*стр.неделя1;
		итогоНеделя2 = итогоНеделя2+к*стр.неделя2;
		итогоНеделя3 = итогоНеделя3+к*стр.неделя3;
		итогоНеделя4 = итогоНеделя4+к*стр.неделя4;
		итогоНеделя5 = итогоНеделя5+к*стр.неделя5;
		итогоПеренос = итогоПеренос+к*стр.Перенос;
	конецЦикла;	
	 Итого = ОстатокДенежныхСредств+итогоНеделя1+итогоНеделя2+итогоНеделя3+итогоНеделя4+итогоНеделя5;
	ЭлементыФормы.ИтогоБаланс.Значение = "Итого баланс "+Итого+ " руб.";
конецпроцедуры	 

Процедура Панель1ПриСменеСтраницы(Элемент, ТекущаяСтраница)
	Если ЭлементыФормы.Панель1.ТекущаяСтраница.Имя = "Страница1" Тогда
	СформироватьНажатие(Истина);	
	иначеЕсли ЭлементыФормы.Панель1.ТекущаяСтраница.Имя = "Страница2" Тогда
	КоманднаяПанель1Заполнить(Истина);	
	конецесли;	
КонецПроцедуры

Процедура ОткрытьЖурналНажатие(Элемент)
	ФормаСписка = Документы.ПланированиеДвиженийДС.ПолучитьФормуСписка();
	ФормаСписка.Открыть();
КонецПроцедуры

Процедура ПриОткрытии()
	Если не рольдоступна("яштФинДиректор") Тогда
		ЭлементыФормы.Планирование.ТолькоПросмотр = Истина;
		ЭлементыФормы.Сохранить.Доступность = Ложь;
		ЭлементыФормы.Принять.Доступность = Ложь;
	конецЕсли;	
КонецПроцедуры
