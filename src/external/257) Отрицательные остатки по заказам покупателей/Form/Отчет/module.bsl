
Процедура ДействияФормыОтчетСформировать(Кнопка)
	
	ТабДок = ЭлементыФормы.ПолеТабличногоДокумента;
	Отчет(ТабДок);


КонецПроцедуры

Процедура Отчет(ТабДок) Экспорт
	
	Макет = ПолучитьМакет("Отчет");
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ЗаказыПокупателейОстатки.ЗаказПокупателя.Контрагент КАК Контрагент,
	|	ЗаказыПокупателейОстатки.ЗаказПокупателя.ДоговорКонтрагента.ОтветственноеЛицо КАК ОтветственноеЛицо,
	|	ЗаказыПокупателейОстатки.ЗаказПокупателя,
	|	ЗаказыПокупателейОстатки.Номенклатура.Код Код,
	|	ЗаказыПокупателейОстатки.Номенклатура,
	|	ЗаказыПокупателейОстатки.КоличествоОстаток
	|ИЗ
	|	РегистрНакопления.ЗаказыПокупателей.Остатки(, ЗаказПокупателя.Подразделение = &Подразделение И ЗаказПокупателя.Проверен) КАК ЗаказыПокупателейОстатки
	|ГДЕ
	|	ЗаказыПокупателейОстатки.КоличествоОстаток < 0
	|
	|УПОРЯДОЧИТЬ ПО
	|	ЗаказыПокупателейОстатки.ЗаказПокупателя.Дата";

	Запрос.УстановитьПараметр("Подразделение",Подразделение); 
	Результат = Запрос.Выполнить();

	ОбластьЗаголовок = Макет.ПолучитьОбласть("Заголовок");
	ОбластьПодвал = Макет.ПолучитьОбласть("Подвал");
	ОбластьШапкаТаблицы = Макет.ПолучитьОбласть("ШапкаТаблицы");
	ОбластьПодвалТаблицы = Макет.ПолучитьОбласть("ПодвалТаблицы");
	ОбластьДетальныхЗаписей = Макет.ПолучитьОбласть("Детали");

	ТабДок.Очистить();
	ТабДок.Вывести(ОбластьЗаголовок);
	ТабДок.Вывести(ОбластьШапкаТаблицы);
	ТабДок.НачатьАвтогруппировкуСтрок();

	ВыборкаДетали = Результат.Выбрать();

	Пока ВыборкаДетали.Следующий() Цикл
		ОбластьДетальныхЗаписей.Параметры.Заполнить(ВыборкаДетали);
		ТабДок.Вывести(ОбластьДетальныхЗаписей, ВыборкаДетали.Уровень());
	КонецЦикла;

	ТабДок.ЗакончитьАвтогруппировкуСтрок();
	ТабДок.Вывести(ОбластьПодвалТаблицы);
	ТабДок.Вывести(ОбластьПодвал);

	//}}КОНСТРУКТОР_ВЫХОДНЫХ_ФОРМ
КонецПроцедуры

Процедура ПриОткрытии()
	
	ОсновноеПодразделение = ПолучитьЗначениеПоУмолчанию(глТекущийПользователь,"ОсновноеПодразделение");
	
	Если ЗначениеНеЗаполнено(ОсновноеПодразделение) Тогда
		Подразделение = Справочники.Подразделения.НайтиПоКоду("00005"); // Головное
	Иначе
		Подразделение = ОсновноеПодразделение; // Головное
	КонецЕсли;	
КонецПроцедуры

Процедура ДействияФормыЗакрытьЗаказы(Кнопка)
	
	СписокВыделенныхЗаказов = Новый СписокЗначений;
	
	Для каждого ВыделеннаяОбласть ИЗ ЭлементыФормы.ПолеТабличногоДокумента.ВыделенныеОбласти Цикл
		ИмяОбласти=ВыделеннаяОбласть.Имя;		
		
		индДвоеточия=Найти(ИмяОбласти,":");
		
		Если индДвоеточия>0 Тогда // несколько ячеек
			индR1=Найти(ИмяОбласти,"R");
			индC1=Найти(ИмяОбласти,"C");
			
			НачальныйНомер=Число(Сред(ИмяОбласти,индR1+1,индC1-индR1-1));
			ОстСтрока=Сред(ИмяОбласти,индДвоеточия);
			
			индR2=Найти(ОстСтрока,"R");
			индC2=Найти(ОстСтрока,"C");
			КонечныйНомер=Число(Сред(ОстСтрока,индR2+1,индC2-индR2-1));
			   Для сч=НачальныйНомер по КонечныйНомер Цикл
				ЗаказСсылка=ЭлементыФормы.ПолеТабличногоДокумента.Область("R"+Формат(сч,"ЧГ=0")+"C4").Расшифровка;
				Если СписокВыделенныхЗаказов.НайтиПоЗначению(ЗаказСсылка)= Неопределено Тогда
					  СписокВыделенныхЗаказов.Добавить(ЗаказСсылка);
				КонецЕсли;	
			   КонецЦикла;	
			
		Иначе // одна ячейка

			индR1=Найти(ИмяОбласти,"R");
			индC1=Найти(ИмяОбласти,"C");
			
			сч=Сред(ИмяОбласти,индR1+1,индC1-индR1-1);
			
			ЗаказСсылка=ЭлементыФормы.ПолеТабличногоДокумента.Область("R"+сч+"C4").Расшифровка;
			СписокВыделенныхЗаказов.Добавить(ЗаказСсылка);


		КонецЕсли;	
КонецЦикла;	


Док=Документы.ЗакрытиеЗаказовПокупателей.СоздатьДокумент();	
Док.Дата = ТекущаяДата();
Док.ВидОперации =  Перечисления.ВидыОперацийЗакрытиеЗаказовПокупателей.ЗакрытиеЗаказов ;
Док.Комментарий = "Автоматическое закрытие заказов по минусам";

Для сч=0 по СписокВыделенныхЗаказов.Количество() - 1 Цикл
  строкаЗаказы=Док.Заказы.Добавить();
  строкаЗаказы.ЗаказПокупателя = СписокВыделенныхЗаказов[сч].Значение;
  				
КонецЦикла;	
 Док.ПолучитьФорму().Открыть();
//Док.Записать(РежимЗаписиДокумента.Проведение);	
КонецПроцедуры
