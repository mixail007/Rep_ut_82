перем Соединение, СоединениеД;

Процедура КнопкаВыполнитьНажатие(Кнопка)
UsrPwd = "Usr=""Робот (центр - номенклатура)"";Pwd=""09876""";
   srv = "Srvr=""server:3041"";";
	Если НеПереноситьВБухЯШТ = ЛОЖЬ Тогда	
		Base   = srv+"Ref=""v83ib_yst_bp""";
		v8connect = Новый COMОбъект("V83.ComConnector");
		СтрокаСоединенияCOM = Base+";"+UsrPwd;
		Попытка
			Соединение = v8connect.Connect(СтрокаСоединенияCOM);
			#Если Клиент Тогда
				Сообщить(строка(ТекущаяДата())+" Успешно Установлено подключение к базе 1С V8:"+base, СтатусСообщения.Информация);
			#КонецЕсли
		Исключение
			#Если Клиент Тогда
				Сообщить("НЕТ подключения к базе 1С V8:"+base+" ! ", СтатусСообщения.Внимание);
			#КонецЕсли
			Возврат;
		КонецПопытки;
	КонецЕсли;

	Если ТипДоговора = справочники.ТипыДоговоров.ШинтрейдЯрославль Тогда
		srv2 = "Srvr=""iisserver"";";
		Base = srv2 + "Ref=""v83ib_shintradeyar_bp"""; //28.12.2018
		v8connect = Новый COMОбъект("V83.ComConnector");
		СтрокаСоединенияCOM = Base+";"+UsrPwd;
		Попытка
			СоединениеД = v8connect.Connect(СтрокаСоединенияCOM);
			#Если Клиент Тогда
				Сообщить(строка(ТекущаяДата())+" Успешно Установлено подключение к базе 1С V8:"+base, СтатусСообщения.Информация);
			#КонецЕсли
		Исключение
			#Если Клиент Тогда
				Сообщить("НЕТ подключения к базе 1С V8:"+base+" ! ", СтатусСообщения.Внимание);
			#КонецЕсли
			Возврат;
		КонецПопытки;
		
	ИначеЕсли ТипДоговора = справочники.ТипыДоговоров.НайтиПоКоду("Я0004") Тогда 
		Base   =  srv+"Ref=""v83ib_formulaAvto_bp""";
		v8connect = Новый COMОбъект("V83.ComConnector");
		СтрокаСоединенияCOM = Base+";"+UsrPwd;
		Попытка
			СоединениеД = v8connect.Connect(СтрокаСоединенияCOM);
			#Если Клиент Тогда
				Сообщить(строка(ТекущаяДата())+" Успешно Установлено подключение к базе 1С V8:"+base, СтатусСообщения.Информация);
			#КонецЕсли
		Исключение
			#Если Клиент Тогда
				Сообщить("НЕТ подключения к базе 1С V8:"+base+" ! ", СтатусСообщения.Внимание);
			#КонецЕсли
			Возврат;
		КонецПопытки;
		
	ИначеЕсли  ТипДоговора = справочники.ТипыДоговоров.ФормулаАвтоПлюс Тогда 
		Base   =  srv+"Ref=""v83ib_formulaavtoplus_bp""";
		v8connect = Новый COMОбъект("V83.ComConnector");
		СтрокаСоединенияCOM = Base+";"+UsrPwd;
		Попытка
			СоединениеД = v8connect.Connect(СтрокаСоединенияCOM);
			#Если Клиент Тогда
				Сообщить(строка(ТекущаяДата())+" Успешно Установлено подключение к базе 1С V8:"+base, СтатусСообщения.Информация);
			#КонецЕсли
		Исключение
			#Если Клиент Тогда
				Сообщить("НЕТ подключения к базе 1С V8:"+base+" ! ", СтатусСообщения.Внимание);
			#КонецЕсли
			Возврат;
		КонецПопытки;
	КонецЕсли;	
	 
	Для каждого стр Из СписокДокументов Цикл
		Если не НеПереноситьВБухЯШТ Тогда	
			ПеренестиРеализациюВБухгалтериюЯШТ(стр.Реализация,Соединение);	
		КонецЕсли;
		Если типДоговора <> Справочники.ТипыДоговоров.ПустаяСсылка() Тогда
			ПеренестиРеализациюВБухгалтерию(стр.Реализация,СоединениеД);
		КонецЕсли;
	КонецЦикла;	

КонецПроцедуры

Процедура ВыбПериодНажатие(Элемент)
	НастройкаПериода = Новый НастройкаПериода;
	НастройкаПериода.РедактироватьКакИнтервал = Истина;
	НастройкаПериода.РедактироватьКакПериод = Истина;
	НастройкаПериода.ВариантНастройки = ВариантНастройкиПериода.Период;
	НастройкаПериода.УстановитьПериод(НачПериода, ?(КонПериода='0001-01-01', КонПериода, КонецДня(КонПериода)));
	Если НастройкаПериода.Редактировать() Тогда
		НачПериода = НастройкаПериода.ПолучитьДатуНачала();
		КонПериода = НастройкаПериода.ПолучитьДатуОкончания();
	КонецЕсли;
КонецПроцедуры

Процедура КоманднаяПанель1Заполнить(Кнопка)
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	РеализацияТоваровУслуг.Ссылка
		|ИЗ
		|	Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
		|ГДЕ
		|	РеализацияТоваровУслуг.Дата МЕЖДУ &ДатаН И &ДатаК
		|	И РеализацияТоваровУслуг.Проведен";
		
		Если ТипДоговора <> Справочники.ТипыДоговоров.ПустаяСсылка() Тогда
		Запрос.Текст = Запрос.Текст +	
		"	И РеализацияТоваровУслуг.ДоговорКонтрагента.ТипДоговора = &ТипДоговора";
	    Запрос.УстановитьПараметр("ТипДоговора", ТипДоговора);
        КонецЕсли;
		Запрос.Текст = Запрос.Текст +	
		"  УПОРЯДОЧИТЬ ПО
		|	РеализацияТоваровУслуг.Дата";
	Запрос.УстановитьПараметр("ДатаК", КонПериода);
	Запрос.УстановитьПараметр("ДатаН", НачПериода);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		НовСтр= СписокДокументов.Добавить();
		НовСтр.Реализация = ВыборкаДетальныеЗаписи.Ссылка;
	КонецЦикла;
КонецПроцедуры

Процедура ПеренестиРеализациюВБухгалтериюЯШТ(СсылкаР,Соединение) Экспорт
	ДокССылка = СсылкаР;
	Строка_UID   = строка(Докссылка.УникальныйИдентификатор() );
	Новый_UID    = Соединение.NewObject("УникальныйИдентификатор", Строка_UID);
	РеализацияССылка  = Соединение.Документы.РеализацияТоваровУслуг.ПолучитьСсылку(Новый_UID);
	Реализация =  РеализацияССылка.GetObject();
	Если Реализация = неопределено Тогда
	Сообщить("Документ реализации в бух. Базе не найден! "+ДокССылка.Номер);
	возврат;
	КонецЕсли;	

	УсловиеРнД = Ложь;
	УсловиеМс = Ложь;
	УсловиеФА = Ложь;
	УсловиеФАП = Ложь;
	УсловиеШТЯ = Ложь;
	
	Если (Найти(ДокССылка.ДоговорКонтрагента.Наименование,"*")> 0 и ДокССылка.Подразделение = Справочники.Подразделения.НайтиПоКоду("00106")) или ДокССылка.Контрагент =Справочники.Контрагенты.НайтиПоКоду("94138") Тогда  //Ростов
		УсловиеРнД = Истина;
		N=8; //уменьшить на N% не более 100%
		ND=25; //уменьшить диски на ND% не более 100%
		Сообщить("Для реализации № "+ДокССылка.Номер+" - цены на диски уменьшены на "+строка(ND)+"%, на все остальное на "+строка(N)+"% и округлены до рублей по правилам от 21.09.2012", СтатусСообщения.Информация);
		Коэфф = 1-N/100;
		КоэффДиски = 1-ND/100;
	ИначеЕсли Найти(ДокССылка.ДоговорКонтрагента.Наименование,"*")> 0 и ДокССылка.Подразделение = Справочники.Подразделения.НайтиПоКоду("00133") Тогда  //Москва
		УсловиеМс = Истина;
		N=8; //уменьшить на N% не более 100% // пока совпадает
		Сообщить("Для реализации № "+ДокССылка.Номер+" - цены уменьшены на "+строка(N)+"% и округлены до рублей по правилам от 07.11.2012", СтатусСообщения.Информация);
		Коэфф = 1-N/100;
	ИначеЕсли ДокССылка.Договорконтрагента.ТипДоговора = справочники.ТипыДоговоров.НайтиПоКоду("Я0004") Тогда  //ФормулаАвто
		УсловиеФА = Истина;
		N=Коф; //уменьшить на N% не более 100% 
		Сообщить("Для реализации № "+ДокССылка.Номер+" - цены уменьшены на "+строка(N)+"% и округлены до рублей по правилам от 07.11.2012", СтатусСообщения.Информация);
		Коэфф = 1-N/100;
		СуммаТр = ПолучитьСуммуТр(ДокССылка);
		КоэфТр =1-(СуммаТр+ДокСсылка.Сделка.СуммаДопРасходовЭкспорт)/ДокССылка.СуммаДокумента;
	ИначеЕсли ДокССылка.Договорконтрагента.ТипДоговора = справочники.ТипыДоговоров.ФормулаАвтоПлюс Тогда  //ФормулаАвтоПлюс
		УсловиеФАП = Истина;
		N=Коф; //уменьшить на N% не более 100% 
		Сообщить("Для реализации № "+ДокССылка.Номер+" - цены уменьшены на "+строка(N)+"% и округлены до рублей по правилам от 07.11.2012", СтатусСообщения.Информация);
		Коэфф = 1-N/100;
		СуммаТр = ПолучитьСуммуТр(ДокССылка);
		КоэфТр =1-(СуммаТр+ДокСсылка.Сделка.СуммаДопРасходовЭкспорт)/ДокССылка.СуммаДокумента;
	ИначеЕсли ДокССылка.Договорконтрагента.ТипДоговора = справочники.ТипыДоговоров.ШинтрейдЯрославль Тогда  //Шинтрейд	
		УсловиеШТЯ = Истина;
		N=Коф; //уменьшить на N% не более 100% 
		Сообщить("Для реализации № "+ДокССылка.Номер+" - цены уменьшены на "+строка(N)+"% и округлены до рублей по правилам от 07.11.2012", СтатусСообщения.Информация);
		Коэфф = 1-N/100;
		СуммаТр =ПолучитьСуммуТр(ДокССылка);
			Если ДокССылка.КурсВзаиморасчетов <> 0 Тогда
				Курс = ДокССылка.КурсВзаиморасчетов;
			иначе
				курс = 1;                    
			КонецЕсли;	
		КоэфТр =1-(СуммаТр+ДокСсылка.Сделка.СуммаДопРасходовЭкспорт)/(ДокССылка.СуммаДокумента*Курс);
	КонецЕсли;
	
		СтавкаНДС_2019 = СтавкаНДСнаДату( ДокССылка.Дата ); //28.12.2018 - 10.01.2019
		чНДС = ПолучитьСтавкуНДС( СтавкаНДС_2019 );	
		Если чНДС=20 тогда //10.01.2019		
			СтавкаНДС_ШТ = Соединение.Перечисления.СтавкиНДС.НДС20;
		ИначеЕсли чНДС=18 тогда
			СтавкаНДС_ШТ = Соединение.Перечисления.СтавкиНДС.НДС18;
		иначе //если чНДС=0 тогда
			СтавкаНДС_ШТ = Соединение.Перечисления.СтавкиНДС.БезНДС;
		КонецЕсли;
	
	Для каждого стр из ДокССылка.товары Цикл
		НоменклатураССылка  = Соединение.Справочники.Номенклатура.НайтиПокоду(стр.Номенклатура.Код);
		Если НоменклатураССылка = Неопределено Тогда
			Сообщить("Не найдена номенклатура в бух. базе!"+ Стр.Номенклатура);
			возврат;
		иначе
			НоменклатураР = номенклатураСсылка;
		конецесли;	
		//склад
		СкладССылка  =  Соединение.Справочники.Склады.НайтиПокоду(стр.Склад.Код);
		
		Если СкладССылка = Неопределено Тогда
			Сообщить("Не найден склад в бух. базе!"+ стр.Склад );
			возврат;
		иначе
			СкладР = СкладСсылка;
		конецесли;	
		Отбор = Соединение.NewObject("Структура");;
		Отбор.Вставить("Номенклатура",НоменклатураР);
		Отбор.Вставить("Склад",СкладР);
		Строки = Реализация.Товары.Найтистроки(Отбор);
				
		Для каждого НовСтр из Строки Цикл 
			Если  УсловиеРнД Тогда
				Если Стр.Номенклатура.Родитель.Код="9004163    " или
					 Стр.Номенклатура.Родитель.Код="0080062    " или
					 Стр.Номенклатура.Родитель.Код="0001753    " или
					 Стр.Номенклатура.Родитель.Код="0001755    " тогда
					НовСтр.Цена  = Окр(Стр.Цена * КоэффДиски,0); // до рублей
				Иначе
					НовСтр.Цена  = Окр(Стр.Цена * Коэфф,0); // до рублей
				КонецЕсли;
				НовСтр.Сумма = НовСтр.Цена*НовСтр.Количество;
			ИначеЕсли УсловиеМс Тогда
				НовСтр.Цена = Окр(Стр.Цена * Коэфф,0); // до рублей
				НовСтр.Сумма = НовСтр.Цена * НовСтр.Количество;
			ИначеЕсли УсловиеФА или УсловиеФАП Тогда
				НовСтр.Цена = Окр(Стр.Цена * Коэфф*КоэфТр,0); // до рублей
				НовСтр.Сумма = НовСтр.Цена * НовСтр.Количество;
			ИначеЕсли УсловиеШТЯ Тогда
				Если ДокССылка.КурсВзаиморасчетов <> 0 Тогда
					Курс = ДокССылка.КурсВзаиморасчетов;
				иначе
					Курс = 1;
				КонецЕсли;	
				НовСтр.Цена = Окр(Стр.Цена * Коэфф*КоэфТр*Курс*(1+чНДС/100),0); //+НДС сверху
				НовСтр.Сумма = НовСтр.Цена * НовСтр.Количество;
			Иначе
				НовСтр.Цена  = Стр.Цена;
				НовСтр.Сумма = НовСтр.Цена*НовСтр.Количество;
			КонецЕсли;
			//Реализация ЯШТ всегда с НДС
			НовСтр.СтавкаНДС = СтавкаНДС_ШТ;   //28.12.2018
			НовСтр.СуммаНДС  = Окр( НовСтр.Сумма * чНДС/(100+чНДС), 2);
		КонецЦикла;
	КонецЦикла;
	Реализация.Суммадокумента = Реализация.Товары.итог("Сумма");
	Сообщить(строка(ТекущаяДата())+"Заполнили реализацию. ");
    Реализация.Записать();
	Сообщить(строка(ТекущаяДата())+"Загрузка окончена. ");

конецПроцедуры	
Процедура ПеренестиРеализациюВБухгалтерию(СсылкаР,Соединение) Экспорт
ДокССылка = СсылкаР;
Строка_UID   = строка(Докссылка.УникальныйИдентификатор() );
Новый_UID    = Соединение.NewObject("УникальныйИдентификатор", Строка_UID);
//РеализацияССылка  = Соединение.Документы.РеализацияТоваровУслуг.ПолучитьСсылку(Новый_UID);
//Реализация =  РеализацияССылка.GetObject();
ПоступлениеССылка  = Соединение.Документы.ПоступлениеТоваровУслуг.ПолучитьСсылку(Новый_UID);
Поступление =  ПоступлениеССылка.GetObject();
//Если Реализация = неопределено Тогда
//Сообщить("Документ реализации в бух. Базе не найден! "+ДокССылка.Номер);
//возврат;
//КонецЕсли;	
Если Поступление = неопределено Тогда
Сообщить("Документ реализации в бух. Базе не найден! "+ДокССылка.Номер);
возврат;
КонецЕсли;	

	УсловиеРнД = Ложь;
	УсловиеМс = Ложь;
	УсловиеФА = Ложь;
	УсловиеФАП = Ложь;
	УсловиеШТЯ = Ложь;
	
	Если (Найти(ДокССылка.ДоговорКонтрагента.Наименование,"*")> 0 и ДокССылка.Подразделение = Справочники.Подразделения.НайтиПоКоду("00106")) или ДокССылка.Контрагент =Справочники.Контрагенты.НайтиПоКоду("94138") Тогда  //Ростов
		УсловиеРнД = Истина;
		N=8; //уменьшить на N% не более 100%
		ND=25; //уменьшить диски на ND% не более 100%
		Сообщить("Для реализации № "+ДокССылка.Номер+" - цены на диски уменьшены на "+строка(ND)+"%, на все остальное на "+строка(N)+"% и округлены до рублей по правилам от 21.09.2012", СтатусСообщения.Информация);
		Коэфф = 1-N/100;
		КоэффДиски = 1-ND/100;
	ИначеЕсли Найти(ДокССылка.ДоговорКонтрагента.Наименование,"*")> 0 и ДокССылка.Подразделение = Справочники.Подразделения.НайтиПоКоду("00133") Тогда  //Москва
		УсловиеМс = Истина;
		N=8; //уменьшить на N% не более 100% // пока совпадает
		Сообщить("Для реализации № "+ДокССылка.Номер+" - цены уменьшены на "+строка(N)+"% и округлены до рублей по правилам от 07.11.2012", СтатусСообщения.Информация);
		Коэфф = 1-N/100;
	ИначеЕсли ДокССылка.Договорконтрагента.ТипДоговора = справочники.ТипыДоговоров.НайтиПоКоду("Я0004") Тогда  //ФормулаАвто
		УсловиеФА = Истина;
		N=Коф; //уменьшить на N% не более 100% 
		Сообщить("Для реализации № "+ДокССылка.Номер+" - цены уменьшены на "+строка(N)+"% и округлены до рублей по правилам от 07.11.2012", СтатусСообщения.Информация);
		Коэфф = 1-N/100;
		СуммаТр = ПолучитьСуммуТр(ДокССылка);
		КоэфТр =1-(СуммаТр+ДокСсылка.Сделка.СуммаДопРасходовЭкспорт)/ДокССылка.СуммаДокумента;   //сумму доп расходов тоже стали использовать. 06,01,18
	ИначеЕсли ДокССылка.Договорконтрагента.ТипДоговора = справочники.ТипыДоговоров.ФормулаАвтоПлюс Тогда  //ФормулаАвтоПлюс
		УсловиеФАП = Истина;
		N=Коф; //уменьшить на N% не более 100% 
		Сообщить("Для реализации № "+ДокССылка.Номер+" - цены уменьшены на "+строка(N)+"% и округлены до рублей по правилам от 07.11.2012", СтатусСообщения.Информация);
		Коэфф = 1-N/100;
		СуммаТр = ПолучитьСуммуТр(ДокССылка);
		КоэфТр =1-(СуммаТр+ДокСсылка.Сделка.СуммаДопРасходовЭкспорт)/ДокССылка.СуммаДокумента;   //сумму доп расходов тоже стали использовать. 06,01,18
	ИначеЕсли ДокССылка.Договорконтрагента.ТипДоговора = справочники.ТипыДоговоров.ШинтрейдЯрославль Тогда  //Шинтрейд	
		УсловиеШТЯ = Истина;
		N=Коф; //уменьшить на N% не более 100% 
		Сообщить("Для реализации № "+ДокССылка.Номер+" - цены уменьшены на "+строка(N)+"% и округлены до рублей по правилам от 07.11.2012", СтатусСообщения.Информация);
		Коэфф = 1-N/100;
		СуммаТр = ПолучитьСуммуТр(ДокССылка);
			Если ДокССылка.КурсВзаиморасчетов <> 0 Тогда
				Курс = ДокССылка.КурсВзаиморасчетов;
			иначе
				курс = 1;
			КонецЕсли;	
		КоэфТр =1-(СуммаТр+ДокСсылка.Сделка.СуммаДопРасходовЭкспорт)/(ДокССылка.СуммаДокумента*Курс);
	КонецЕсли;
	
	СтавкаНДС_2019 = СтавкаНДСнаДату( ДокСсылка.Дата ); //28.12.2018
	чНДС = ПолучитьСтавкуНДС( СтавкаНДС_2019 );
	Если чНДС=20 тогда //10.01.2019		
		СтавкаНДС_ШТ = Соединение.Перечисления.СтавкиНДС.НДС20;
	иначеесли чНДС=18 тогда
		СтавкаНДС_ШТ = Соединение.Перечисления.СтавкиНДС.НДС18;
	иначе //если чНДС=0 тогда
		СтавкаНДС_ШТ = Соединение.Перечисления.СтавкиНДС.БезНДС;
	КонецЕсли;
	
	
	Для каждого стр из ДокССылка.товары Цикл
		 Если ДокССылка.Договорконтрагента.ТипДоговора = справочники.ТипыДоговоров.ФормулаАвтоПлюс Тогда
			кодНом = "0000"+стр.Номенклатура.Код;
		иначе	
			кодНом = стр.Номенклатура.Код; 
		 КонецЕсли;	 
		НоменклатураССылка  = Соединение.Справочники.Номенклатура.НайтиПокоду(КодНом);
		Если НоменклатураССылка = Неопределено Тогда
			Сообщить("Не найдена номенклатура в бух. базе!"+ Стр.Номенклатура +" № "+ДокССылка.Номер);
			возврат;
		иначе
			НоменклатураР = номенклатураСсылка;
		конецесли;	
		Отбор = Соединение.NewObject("Структура");
		Отбор.Вставить("Номенклатура",НоменклатураР);
		Строки = Поступление.Товары.Найтистроки(Отбор);
		Для каждого НовСтр из Строки Цикл 
			Если  УсловиеРнД Тогда
				Если Стр.Номенклатура.Родитель.Код="9004163    " или
					Стр.Номенклатура.Родитель.Код="0080062    " или
					Стр.Номенклатура.Родитель.Код="0001753    " или
					Стр.Номенклатура.Родитель.Код="0001755    " тогда
					НовСтр.Цена  = Окр(Стр.Цена * КоэффДиски,0); // до рублей
				Иначе
					НовСтр.Цена  = Окр(Стр.Цена * Коэфф,0); // до рублей
				КонецЕсли;
				НовСтр.Сумма = НовСтр.Цена * Стр.Количество;
			ИначеЕсли УсловиеМс Тогда
				НовСтр.Цена = Окр(Стр.Цена * Коэфф,0); // до рублей
				НовСтр.Сумма = НовСтр.Цена * новСтр.Количество;
			ИначеЕсли УсловиеФА или УсловиеФАП Тогда
				НовСтр.Цена = Окр(Стр.Цена * Коэфф*КоэфТр,0); // до рублей
				НовСтр.Сумма = НовСтр.Цена * новСтр.Количество;
			ИначеЕсли УсловиеШТЯ Тогда
				Если ДокССылка.КурсВзаиморасчетов <> 0 Тогда
					Курс = ДокССылка.КурсВзаиморасчетов;
				иначе
					курс = 1;
				КонецЕсли;	
				НовСтр.Цена  = Окр(Стр.Цена * Коэфф*КоэфТр*Курс*(1+чНДС/100),0); // до рублей  НДС сверху
				НовСтр.Сумма = НовСтр.Цена * новСтр.Количество;
			Иначе
				НовСтр.Цена = Стр.Цена;
				НовСтр.Сумма = Стр.Сумма;
			КонецЕсли;
			//поступление из ЯШт всегда с НДС	
 			НовСтр.СтавкаНДС = СтавкаНДС_ШТ;   //10.01.2019
			НовСтр.СуммаНДС = Окр( НовСтр.Сумма * чНДС/(100+чНДС), 2);
		КонецЦикла;
	КонецЦикла;
	Поступление.Суммадокумента = поступление.Товары.итог("Сумма");
	Сообщить(строка(ТекущаяДата())+"Заполнили реализацию. ");
	
	Поступление.Записать();
	Сообщить(строка(ТекущаяДата())+"Загрузка окончена. ");

конецПроцедуры	

Функция ПолучитьСуммуТр(ДокССылка)

// Попробуем найти сумму транспортных расходов
Запрос = Новый Запрос("ВЫБРАТЬ
                      |	ПЗ1.Реализация,
                      |	СУММА(ПЗ2.ДоставкаНал) КАК ДоставкаНал,
                      |	СУММА(ПЗ2.ДоставкаВЦене) КАК ДоставкаВЦене
                      |ИЗ
                      |	(ВЫБРАТЬ
                      |		ЗаданиеНаОтгрузкуЗаказыПокупателей.Ссылка КАК Ссылка,
                      |		ЗаданиеНаОтгрузкуЗаказыПокупателей.Реализация КАК Реализация,
                      |		ЗаданиеНаОтгрузкуЗаказыПокупателей.Реализация.Сделка КАК ЗАказ
                      |	ИЗ
                      |		Документ.ЗаданиеНаОтгрузку.ЗаказыПокупателей КАК ЗаданиеНаОтгрузкуЗаказыПокупателей
                      |	ГДЕ
                      |		ЗаданиеНаОтгрузкуЗаказыПокупателей.Реализация = &Реализация) КАК ПЗ1
                      |		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ 
                      |			ИнформацияПоПроезду.Задание КАК Задание,
                      |			ИнформацияПоПроезду.Заказ КАК Заказ,
                      |			ИнформацияПоПроезду.ДоставкаНал КАК ДоставкаНал,
                      |			ИнформацияПоПроезду.ДоставкаВЦене КАК ДоставкаВЦене
                      |		ИЗ
                      |			РегистрСведений.ИнформацияПоПроезду КАК ИнформацияПоПроезду) КАК ПЗ2
                      |		ПО ПЗ1.Ссылка = ПЗ2.Задание
                      |			И ПЗ1.ЗАказ = ПЗ2.Заказ
                      |
                      |СГРУППИРОВАТЬ ПО
                      |	ПЗ1.Реализация");
Запрос.УстановитьПараметр("Реализация",ДокСсылка);
Выб = Запрос.Выполнить().Выбрать();

Если (Выб.Следующий()) Тогда 
	ЗначениеГрязное = ?(ЗначениеЗаполнено(Выб.ДоставкаНал),Выб.ДоставкаНал,0) + ?(ЗначениеЗаполнено(Выб.ДоставкаВЦене),Выб.ДоставкаВЦене,0);
	Если (ЗначениеГрязное<0) Тогда 
		Значение = 0;
	Иначе 
		Значение = ЗначениеГрязное;
	КонецЕсли;
Иначе 
	Значение = 0;
КонецЕсли;
возврат Значение;	
конецФункции


Процедура ПриОткрытии()
	коф=0.5;
	Если ТекущаяДата()<Дата('20180101')тогда
		коф = 0.5;	
	иначе
		коф = 5.75;	
	конецесли;
	
КонецПроцедуры

