
Процедура КнопкаВыполнитьНажатие(Кнопка)
	Ответ = Вопрос("Вы действительно хотите изменить даты оплаты у указанных заказов?", РежимДиалогаВопрос.ДаНет );
	Если Ответ = КодВозвратаДиалога.нет тогда
		Возврат;
	КонецЕсли;
	
	Если не ЗначениеЗаполнено(ДатаОплаты) тогда
		Предупреждение("Не заполнена дата оплаты");
		Возврат;
	КонецЕсли;
	
	Для каждого стр из ТабЗаказов цикл
		Если стр.фл тогда
			ДоговорНаименование = "";
			ДоговорНаименование = стр.ДоговорКонтрагента.Наименование;
			Если Найти(нрег(ДоговорНаименование),"перенос/возврат")>0 или стр.ДоговорКонтрагента.ТипДоговора = Справочники.ТипыДоговоров.ПеремещениеОТХ тогда
				ЗаказОб = стр.ЗаказПокупателя.ПолучитьОбъект();
				ЗаказОб.ОбменДанными.Загрузка = Истина;
				ЗаказОб.ЧислоДнейСМоментаОтгрузки = (ДатаОплаты - ?(ЗаказОб.ДатаОтгрузки='00010101', НачалоДня(ТекущаяДата()), ЗаказОб.ДатаОтгрузки ) )/86400;
				ЗаказОб.ДатаОплаты = ДатаОплаты;
				обЗаписатьПротоколИзменений(ЗаказОб, ЛОЖЬ);
				ЗаказОб.Записать();
				Сообщить(""+ ЗаказОб+" дата оплаты изменена на "+Формат(ДатаОплаты,"ДФ=dd.MM.yyyy"));
				стр.ДатаОплаты = ДатаОплаты;
			Иначе	
				Сообщить("В "+ стр.Значение+" договор не <перенос/возврат> и не договор ОТХ",СтатусСообщения.Важное);
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры

Процедура кнОтобратьНажатие(Элемент)
	Запрос = новый Запрос;
	Запрос.Текст="ВЫБРАТЬ
	             |	ДоговорыКонтрагентов.Ссылка КАК Договор
	             |ПОМЕСТИТЬ втДоговоры
	             |ИЗ
	             |	Справочник.ДоговорыКонтрагентов КАК ДоговорыКонтрагентов
	             |ГДЕ
	             |	99 = 99
	             |	И (ДоговорыКонтрагентов.Наименование ПОДОБНО ""%перенос/возврат%""
	             |			ИЛИ ДоговорыКонтрагентов.ТипДоговора = ЗНАЧЕНИЕ(справочник.ТипыДоговоров.ПеремещениеОТХ))
	             |;
	             |
	             |////////////////////////////////////////////////////////////////////////////////
	             |ВЫБРАТЬ
	             |	ВЫРАЗИТЬ(ВзаиморасчетыСКонтрагентамиОстатки.Сделка КАК Документ.ЗаказПокупателя) КАК ЗаказПокупателя,
	             |	ВзаиморасчетыСКонтрагентамиОстатки.СуммаВзаиморасчетовОстаток КАК Остаток,
	             |	ВзаиморасчетыСКонтрагентамиОстатки.ДоговорКонтрагента.Владелец КАК Контрагент,
	             |	ВЫРАЗИТЬ(ВзаиморасчетыСКонтрагентамиОстатки.Сделка КАК Документ.ЗаказПокупателя).ДатаОплаты КАК ДатаОплаты,
	             |	ВзаиморасчетыСКонтрагентамиОстатки.ДоговорКонтрагента
	             |ИЗ
	             |	РегистрНакопления.ВзаиморасчетыСКонтрагентами.Остатки(
	             |			,
	             |			ДоговорКонтрагента В
	             |				(ВЫБРАТЬ
	             |					втДоговоры.Договор
	             |				ИЗ
	             |					втДоговоры)) КАК ВзаиморасчетыСКонтрагентамиОстатки
	             |
	             |УПОРЯДОЧИТЬ ПО
	             |	Контрагент,
	             |	ЗаказПокупателя
	             |АВТОУПОРЯДОЧИВАНИЕ";
				 
				 Если ЗначениеЗаполнено(Контрагент) тогда
					 Запрос.Текст = СтрЗаменить(Запрос.Текст,"99 = 99", "ДоговорыКонтрагентов.Владелец = &Владелец");
				 КонецЕсли;
				 
				 Запрос.УстановитьПараметр("Владелец",Контрагент);
				 Рез = Запрос.Выполнить().Выбрать();
				 
				 ТабЗаказов.Очистить();
				 Пока Рез.Следующий() Цикл
					 Если  Рез.Остаток > 0 тогда
						 нстр = ТабЗаказов.Добавить();
						 нстр.фл = истина;
						 нстр.ЗаказПокупателя = рез.ЗаказПокупателя;
						 нстр.Контрагент = рез.Контрагент;
						 нстр.ДатаОплаты = рез.ДатаОплаты;
						 нстр.ДоговорКонтрагента = рез.ДоговорКонтрагента;

						 
						 нстр.ДЗ = Рез.Остаток;
					 КонецЕсли;
				 КонецЦикла;
КонецПроцедуры
