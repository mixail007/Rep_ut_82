процедура Загрузить()  Экспорт
	
	ДиалогВыбораФайла = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	
	ДиалогВыбораФайла.Заголовок = "Прочитать табличный документ из файла";
	ДиалогВыбораФайла.Фильтр    = "Лист Excel (*.xls)|*.xls";
	Если ДиалогВыбораФайла.Выбрать() Тогда
		ФайлНаДиске = Новый Файл(ДиалогВыбораФайла.ПолноеИмяФайла);
		Если нРег(ФайлНаДиске.Расширение) = ".xls" Тогда
			ИмяФайла=ДиалогВыбораФайла.ПолноеИмяФайла;
		КонецЕсли;
	конецЕсли;	
		ВыбФайл = Новый Файл(ИмяФайла);
		Если НЕ ВыбФайл.Существует() Тогда
			Сообщить("Файл не существует!");
		КонецЕсли;
		
		Попытка
			Excel = Новый COMОбъект("Excel.Application");
			Excel.WorkBooks.Open(ИмяФайла);
			Состояние("Обработка файла Microsoft Excel...");
			ExcelЛист = Excel.Sheets(2);
		Исключение
			Сообщить("Ошибка. Возможно неверно указан номер листа книги Excel.");
		КонецПопытки;	
		
		сообщить("Начало ----------"+строка(ТекущаяДата())+"---------" );
		отказ = Ложь;
		КодКонтрагента = СокрЛП(строка(Формат(ExcelЛист.Cells(4,2).Value, "ЧГ=0")));  		
		
		Контрагент = Справочники.Контрагенты.НайтиПоКоду(КодКонтрагента);
		Если Контрагент = Справочники.Контрагенты.ПустаяСсылка() Тогда
			Сообщить("Не найден контрагент по указанному коду!");
			отказ= истина;
		иначе
			// найдем элемент справочника с доп. информацией
			ДопИнфоВыборка = Справочники.ДополнительнаяИнформацияПоКонтрагентам.Выбрать(,Контрагент,,);
			Если ДопИнфоВыборка.Следующий() тогда
				ДопИнфо = ДопИнфоВыборка.ПолучитьОбъект();
			иначе
				ДопИнфо = Справочники.ДополнительнаяИнформацияПоКонтрагентам.СоздатьЭлемент();
				Допинфо.Владелец = контрагент;
			конецЕсли;	
		конецЕсли;
		перваяСтрока = 10;
		КоличествоСтрок = 43;
		
		//производитель -1
		//дилер/субдилер - 2
		//количество лето - 3
		//количество зима - 6
		//основной поставщик -9
		ПроизводителиОтеч = новый СписокЗначений();
		ПроизводителиОтеч.добавить(Справочники.Производители.НайтиПоКоду("39"));
		ПроизводителиОтеч.добавить(Справочники.Производители.НайтиПоКоду("67"));
		ПроизводителиОтеч.добавить(Справочники.Производители.НайтиПоКоду("22"));
		ПроизводителиОтеч.добавить(Справочники.Производители.НайтиПоКоду("777"));
		
		
		//рассчтаем продажи по брендам и сезонам
		Список = Новый списокЗначений();
		Список.Добавить(перечисления.ТипыСезонности.грузовые);
		Список.Добавить(перечисления.ТипыСезонности.сельхоз);
		
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	ЗначенияСвойствОбъектов.Объект
		|ПОМЕСТИТЬ ПодчиненныеКонтрагенты
		|ИЗ
		|	РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
		|ГДЕ
		|	ЗначенияСвойствОбъектов.Свойство = &Свойство
		|	И ЗначенияСвойствОбъектов.Значение = &Контрагент
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	СУММА(ПродажиОбороты.КоличествоОборот) КАК Количество,
		|	ВЫБОР
		|		КОГДА ПродажиОбороты.Номенклатура.НоменклатурнаяГруппа.Наименование ПОДОБНО ""%зим%""
		|			ТОГДА ""Зима""
		|		ИНАЧЕ ""Лето""
		|	КОНЕЦ КАК сезон,
		|	ВЫБОР
		|		КОГДА ПродажиОбороты.Номенклатура.Модель.Наименование ПОДОБНО ""%Nordman%""
		|			ТОГДА &Nordman
		|		КОГДА ПродажиОбороты.Номенклатура.Модель.Наименование ПОДОБНО ""%FORMULA Energy%""
		|			ТОГДА &FORMULA
		|		ИНАЧЕ ПродажиОбороты.Номенклатура.Производитель
		|	КОНЕЦ КАК Производитель
		|ИЗ
		|	РегистрНакопления.Продажи.Обороты(
		|			&Нач,
		|			&Кон,
		|			,
		|			(ДоговорКонтрагента.Владелец = &Контрагент
		|				ИЛИ ДоговорКонтрагента.Владелец В
		|					(ВЫБРАТЬ
		|						ПодчиненныеКонтрагенты.Объект
		|					ИЗ
		|						ПодчиненныеКонтрагенты КАК ПодчиненныеКонтрагенты))
		|				И НЕ Номенклатура.Модель.Сезон В (&Грузовые)) КАК ПродажиОбороты
		|
		|СГРУППИРОВАТЬ ПО
		|	ВЫБОР
		|		КОГДА ПродажиОбороты.Номенклатура.НоменклатурнаяГруппа.Наименование ПОДОБНО ""%зим%""
		|			ТОГДА ""Зима""
		|		ИНАЧЕ ""Лето""
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА ПродажиОбороты.Номенклатура.Модель.Наименование ПОДОБНО ""%Nordman%""
		|			ТОГДА &Nordman
		|		КОГДА ПродажиОбороты.Номенклатура.Модель.Наименование ПОДОБНО ""%FORMULA Energy%""
		|			ТОГДА &FORMULA
		|		ИНАЧЕ ПродажиОбороты.Номенклатура.Производитель
		|	КОНЕЦ";
		
		
		Запрос.УстановитьПараметр("нач", НачалоГода(ДобавитьМесяц(ТекущаяДата(),-12)));
		Запрос.УстановитьПараметр("кон", КонецГода(ДобавитьМесяц(ТекущаяДата(),-12)));
		Запрос.УстановитьПараметр("Грузовые", Список);
		Запрос.УстановитьПараметр("Контрагент", Контрагент);
		Запрос.УстановитьПараметр("Свойство", ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоКоду("90230"));
		Запрос.УстановитьПараметр("Nordman", Справочники.Производители.НайтиПоКоду("3795"));
		Запрос.УстановитьПараметр("FORMULA", Справочники.Производители.НайтиПоКоду("3796"));
		ПродажиПроизводители = Запрос.Выполнить().Выгрузить();
		
		
		
		Для Row = перваяСтрока По КоличествоСтрок Цикл
			
			ОбработкаПрерыванияПользователя();
			
			Состояние("Идет загрузка из Excel: "+строка(Row)+" / "+строка(31)+" ("+строка(окр(Row*100/39,1))+"%)");
			
			ПроизводительФ  =	СокрЛП(строка(Формат(ExcelЛист.Cells(Row,1).Value, "ЧГ=0")));  			
			УровеньЗакупок  =	СокрЛП(строка(Формат(ExcelЛист.Cells(Row,2).Value, "ЧГ=0")));  			
			ОсновнойПоставщик  = СокрЛП(строка(Формат(ExcelЛист.Cells(Row,9).Value, "ЧГ=0"))); 
			количествоЛето = ExcelЛист.Cells(Row,3).Value;
			количествоЗима = ExcelЛист.Cells(Row,6).Value;
			Если количествоЗима <> Неопределено тогда
			количествоЗима = Число(ExcelЛист.Cells(Row,6).Value);
		    иначе
			количествоЗима = 0;
			конецЕсли;
			Если КоличествоЛето <> Неопределено тогда	
			количествоЛето = Число(ExcelЛист.Cells(Row,3).Value);
		    иначе
			количествоЛето=0;
			конецЕсли;
			Если (количествоЛето<>0 или количествоЗима<>0)и (УровеньЗакупок<>"+" и УровеньЗакупок<>"-" и УровеньЗакупок<>"да" и УровеньЗакупок<>"нет" и УровеньЗакупок<>"") тогда
				Сообщить("В строке "+Row+" не корректно указано наличие прямого контракта с производителем!");
				отказ= Истина;
			конецесли;	
			//проверим производителей
			//Модель="";
			//Если найти(ПроизводительФ,"Nordman")<> 0  тогда //Nokian Nordman
			//	Модель="Nordman";	
			//ИначеЕсли найти(ПроизводительФ,"Formula")<> 0 тогда //Formula (Pirelli)
			//	Модель="Formula";
			//КонецЕсли;	
			Если  найти(ПроизводительФ,"КАМА")<> 0 тогда  //НкШЗ
				производитель = Справочники.Производители.НайтиПоКоду("39");
			иначеЕсли  найти(ПроизводительФ,"Белшина")<> 0 тогда  //БШК
				производитель = Справочники.Производители.НайтиПоКоду("67");
			иначе //общая схема
				Производитель = Справочники.Производители.НайтиПоНаименованию(ПроизводительФ);
			конецЕсли;	
			Если производитель = Справочники.Производители.ПустаяСсылка() и ПроизводительФ<>"" тогда
				Сообщить("В строке "+Row+" не удалось определить производителя!");
				отказ= Истина;
			конецЕсли;
			
			
			Если не отказ тогда
				//найдем нужную строку, если нет, то добавим
				Если ПроизводителиОтеч.НайтиПоЗначению(Производитель)=Неопределено Тогда
					Прозрачность=Справочники.ПрозрачностьКонтрагентов.НайтиПоКоду("000000006");//легковые импортные
				иначе
					Прозрачность=Справочники.ПрозрачностьКонтрагентов.НайтиПоКоду("000000005");//легковые отечественные
				конецесли;
				отбор = Новый Структура;
				Отбор.Вставить("Год","2017");
				Отбор.Вставить("Полугодие","целый год");
				Отбор.Вставить("Производитель",Производитель);
				Отбор.Вставить("Прозрачность",Прозрачность);
				Строки = ДопИнфо.Прозрачностьконтрагента.НайтиСтроки(Отбор);
				Если строки.Количество()> 0 Тогда //меняем существующую строку
					строка = строки[0];	
				иначе	
					Строка = ДопИнфо.Прозрачностьконтрагента.Добавить();
					Строка.Год = "2017";
					Строка.Полугодие = "целый год";
					Строка.Прозрачность = Прозрачность;
					Строка.Производитель = Производитель;
				конецЕсли;   
				строка.ОсновнойПоставщик = ОсновнойПоставщик;
				Если КоличествоЗима=0 и КоличествоЛето= 0 Тогда
					строка.УровеньЗакупок = "не закупает";
				иначеЕсли УровеньЗакупок = "+" или УровеньЗакупок = "да" Тогда
					строка.УровеньЗакупок = "дилер";
				иначе
					строка.УровеньЗакупок = "субдилер";
				конецЕсли;
				Строка.КоличествоЗима = КоличествоЗима;
				Строка.КоличествоЛето = КоличествоЛето;
				строка.КоличествоГодовойОбъем = КоличествоЗима+КоличествоЛето;
				//рассчитаем количество ЯШТ
                НужныеСтроки=ПродажиПроизводители.НайтиСтроки(Новый Структура("Производитель",производитель));
				Для каждого стр из НужныеСтроки Цикл
					Если стр.сезон = "Лето" тогда
						строка.КоличествоЛетоЯШТ = Стр.количество;
					иначе
						строка.КоличествоЗимаЯШТ = стр.Количество;
					конецЕсли;	
				конецЦикла;
				строка.КоличествоЯШТ = строка.КоличествоЗимаЯШТ+строка.КоличествоЛетоЯШТ;
			конецЕсли;
			
			
			
			
		конецЦикла;	
			Если не отказ Тогда
				ДопИнфо.Записать();
				форма = ДопИнфо.ПолучитьФорму();
				Форма.Открыть();
			иначе
				Сообщить("Данные не были загружены!!!",СтатусСообщения.Важное);	
			конецЕсли;
	
	Excel.WorkBooks.Close();
	Excel = 0;
	сообщить("Конец--------"+строка(ТекущаяДата())+"-------" );	
	
	
	
	
конецпроцедуры	