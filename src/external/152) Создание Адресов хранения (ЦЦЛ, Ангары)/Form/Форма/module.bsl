
Процедура КнопкаВыполнитьНажатие(Кнопка)
	Если Склад.Пустая() тогда
		Предупреждение("        Выберите сначала склад! 
					  |У склада должен быть признак адр. хранения!",30);
		Возврат;			  
	КонецЕсли;
	Если ДлинаРяд=0 или ДлинаЯч=0 тогда 
		Предупреждение("   Выберите длину кода ряда и ячейки!",30);
		Возврат;			  
	КонецЕсли;
		
	i=0;
для ряд=ряд1 по ряд2 цикл
	для яч=яч1 по яч2 цикл
		для эт=эт1 по эт2 цикл
			для пм=пм1 по пм2 цикл
				Назв = строка(эт)+Разделитель+формат(ряд,"ЧЦ="+строка(ДлинаРяд)+"; ЧН=; ЧВН=")
				+Разделитель+формат(яч,"ЧЦ="+строка(ДлинаЯч)+"; ЧН=; ЧВН=")
				+?(пм=0,"", Разделитель+формат(пм,"ЧЦ="+строка(ДлинаПм)+"; ЧН=; ЧВН=") );  //4 числа!
				
					ряд1 = число( прав(строка(ряд),1) );   // 3 ангар -яч: 21,22 по 2 пм
					//Если лев(строка(ряд),1)="3" 
					//	 и ( ряд1>=2 и ряд1<=5 )
					//	 и яч>20 и пм=3 тогда
					//	 сообщить("Не требуется 3-го пм для "+назв);
					//	 продолжить;
					//КонецЕсли;  	 
					
				//НайтиПоНаименованию(<Наименование>, <Точное соответствие>, <Родитель>, <Владелец>) 
				эл1ссылка = справочники.АдресаХранения.НайтиПоНаименованию(назв, истина,,Склад);
				//+++ доп.поиск по коду
				Если эл1ссылка = справочники.АдресаХранения.ПустаяСсылка() или эл1ссылка = неопределено тогда
					Код = строка(Префикс)+стрЗаменить(Назв, Разделитель, "")+?(пм=0,"00","");
					//Разделитель+формат(пм,"ЧЦ="+строка(ДлинаПм)+"; ЧН=; ЧВН=") );
                    эл1ссылка = справочники.АдресаХранения.НайтиПоКоду(Код);
				КонецЕсли;
				
				Если эл1ссылка = справочники.АдресаХранения.ПустаяСсылка() или эл1ссылка = неопределено тогда
					
					Если Порядок тогда сообщить("НЕ Найден адрес "+назв); продолжить; КонецЕсли;
					
					эл1 = справочники.АдресаХранения.СоздатьЭлемент();
					нов=истина;
				Иначе
					нов=ложь;
					эл1 = эл1ссылка.получитьОбъект();
				КонецЕсли;
				
				эл1.Наименование = ПрефиксНазвания + Назв;
				эл1.Владелец     = Склад;
				эл1.Код = Строка(Префикс)+стрЗаменить(Назв, Разделитель, "")+?(пм=0,"00", ""); //Разделитель+формат(пм,"ЧЦ="+строка(ДлинаПм)+"; ЧН=; ЧВН=") );
				Если Порядок тогда
					
					Если флЗмейка тогда
					//змейка по проходам 1-2 ряд=1 проход, 3-4, 5-6
					проход = ?(ряд%2=0,ряд/2,(ряд+1)/2 );
					
					//туда-обратно по проходам
					ячч    = ?(проход%2=0,
					              ?(ряд%2=0, яч2*2 - яч*2, яч2*2 -(яч*2-1)) ,
								  ?(ряд%2=0, яч*2, яч*2-1) ); 
					
					эл1.Порядок =формат( проход ,"ЧЦ="+строка(ДлинаРяд)+"; ЧН=; ЧВН=")+"."
							+ формат(ячч,"ЧЦ="+строка(ДлинаЯч)+"; ЧН=; ЧВН=")
						+Разделитель+строка(пм)+строка(эт);
					ИначеЕсли ЧетНечет тогда
					//туда(НеЧет)-обратно(Чет)
					эл1.Порядок =формат( ряд ,"ЧЦ="+строка(ДлинаРяд)+"; ЧН=; ЧВН=")+"."
						+?(ряд%2=0, формат(яч2+1-яч,"ЧЦ="+строка(ДлинаЯч)+"; ЧН=; ЧВН="),
								формат(яч,"ЧЦ="+строка(ДлинаЯч)+"; ЧН=; ЧВН=") )
						+Разделитель+строка(пм)+строка(эт);
					Иначе // просто с 1 до последней ячейки
					эл1.Порядок =эл1.Код;
					КонецЕсли;
					
				эл1.Этаж = эт;
				эл1.Ряд  = ряд;
				эл1.ячейка = яч;
				эл1.пм = пм;
						
			//	иначе
			//		эл1.Порядок = Назв;	
				КонецЕсли;
				
				i=i+1;
				попытка 
					эл1.Записать(); 
					Сообщить(строка(i)+") "+?(нов, "Новый", "Существующий")+" адрес: "+ПрефиксНазвания+Назв+?(Порядок," Порядок:"+эл1.Порядок,"") );
				Исключение
					Сообщить(строка(i)+") ОШИБКА записи "+?(нов, "Нового", "Существующего")+" адреса: "+ПрефиксНазвания+Назв+" : "+ОписаниеОшибки(), СтатусСообщения.Внимание);
				КонецПопытки;	
					
			 КонецЦикла;
		КонецЦикла;
	КонецЦикла;
КонецЦикла;


////====4000============================================================	
//// проход(1-5) - ячейка по порядку обхода (01-18) - эт(1-4) - пм(1-3) 
//	
//Если Порядок Тогда   //Заполнять порядок	
//	
//	Для ряд=0 По 9 Цикл
//		Если Флажок1 Тогда
//			Если ряд<>ПолеВвода1 Тогда
//				Продолжить;
//			КонецЕсли;
//		КонецЕсли;
//		
//		Для яч=1 По 9 Цикл  //чет: 4,3,2,1 ...14,15,16,17,18; нечет: 5-13
//			яч1=?(ряд%2=0, ?(яч<6, 6-яч, 24-яч),  яч+5);
//			сообщить("-------Ячейка: "+строка(ряд)+"-"+строка(яч)+"------");
//			для эт=1 по 4 цикл
//				
//				сообщ="";
//				для пм=1 по 3 цикл
//				Код = строка(эт)+строка(ряд)+строка(яч)+строка(пм);  //4 числа!
//				эл1ссылка = справочники.АдресаХранения.НайтиПоКоду(Код);
//					Если эл1ссылка = справочники.АдресаХранения.ПустаяСсылка()
//					 или эл1ссылка = неопределено тогда
//					 	сообщить("Нет ячейки "+Код, СтатусСообщения.Внимание);
//						продолжить; // просто не учитываем, идем дальше
//					КонецЕсли;
//					// порядок определяется проходами - от 1 до 5
//					проход = цел( ряд/2 ) + 1; // 1 проход = 0 и 1 ряд, 2 - 2 и 3
//					эл1 = эл1ссылка.получитьОбъект();
//					эл1.Порядок = строка(проход)+"."+формат(яч1,"ЧЦ=2; ЧВН=")+"-"+строка(пм)+строка(эт); //сначала пм, затем этаж!
//					эл1.Записать();
//					сообщ = сообщ + эл1.наименование+ " >> "+эл1.Порядок+"; ";
//				КонецЦикла;
//				сообщить(сообщ);
//		
//			КонецЦикла;
//		КонецЦикла;	
//			
//	КонецЦикла;	
//КонецЕсли;		
	
КонецПроцедуры

Процедура Адрес1НачалоВыбора(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка=ложь;
	форма1 = справочники.АдресаХранения.ПолучитьФормуСписка();
	
	Если не Склад.Пустая() тогда
	форма1.отбор.Владелец.ВидСравнения =ВидСравнения.Равно;
	форма1.отбор.Владелец.Значение = Склад;
	форма1.отбор.Владелец.Использование = Истина;
	КонецЕсли;

	форма1.РежимВыбора = истина;
	Адрес1 = форма1.ОткрытьМодально();
	
КонецПроцедуры

Процедура ПрефиксРегулирование(Элемент, Направление, СтандартнаяОбработка)
	СтандартнаяОбработка = ложь;
    Элемент.Значение = строка(  число(?(Элемент.Значение="", "0", Элемент.Значение)) + Направление ); 
КонецПроцедуры
