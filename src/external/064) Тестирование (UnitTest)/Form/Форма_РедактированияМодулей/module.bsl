Процедура ДобавитьЭкспорт(Файл, Результат)
	
	Текст = Новый ТекстовыйДокумент;
	Текст.УстановитьТекст(Результат);
	Текст.Записать(Файл.ПолноеИмя);

	
КонецПроцедуры

Процедура КнопкаВыполнитьНажатие(Кнопка)
	// Вставить содержимое обработчика.
	Для Каждого Файл Из СписокФайлов.Строки Цикл
		Если Файл.Пометка И Не ПустаяСтрока(Файл.ПолноеИмя) Тогда
			ДобавитьЭкспорт(Файл.ПолноеИмя, Файл.Результат);
		ИначеЕсли Файл.Строки.Количество() > 0 Тогда
			ОбойтиСтроки(Файл.Строки);			
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры

Процедура ОбойтиСтроки(Строки)
	// Вставить содержимое обработчика.
	Для Каждого Файл Из Строки Цикл
		Если Файл.Пометка И Не ПустаяСтрока(Файл.ПолноеИмя) Тогда
			ДобавитьЭкспорт(Файл.ПолноеИмя, Файл.Результат);
		КонецЕсли;
		ОбойтиСтроки(Файл.Строки);			
	КонецЦикла;
КонецПроцедуры


Процедура ДобавитьОстаток(Массив, Строки, ПолноеИмя)
	
	Если Массив.Количество() > 0 Тогда
		Строка = Строки.Найти(Массив[0], "Имя");
		Если Строка = Неопределено Тогда
			Строка = Строки.Добавить();
			Строка.Имя = Массив[0];
		КонецЕсли;
		Если Массив.Количество() = 1 Тогда
			Строка.ПолноеИмя = ПолноеИмя;
			Текст = Новый ТекстовыйДокумент;
			Текст.Прочитать(ПолноеИмя);
			Строка.ИсходныйТекст = Текст.ПолучитьТекст();
			Кол = Текст.КоличествоСтрок();
			Если Кол = 0 Тогда
				Возврат;
			КонецЕсли;
			А = 0;
			Для ит = 0 По кол - 1 Цикл
				Стр = Текст.ПолучитьСтроку(ит);
				Перфикс = Лев(СокрЛ(Стр),2);
				Если Не ПустаяСтрока(Стр) И Перфикс <> "//" Тогда
					Если Найти(Стр,"Процедура") + Найти(Стр,"Функция") <> 0 Тогда
						Если Найти(Стр,"Процедура _Выполнить(_,_1) Экспорт") > 0 Тогда
							Прервать;
						КонецЕсли;
						Текст.ВставитьСтроку(А+1,ЭлементыФормы.Вставка.ПолучитьТекст());
						Прервать;
					Иначе
						А = ит;
					КонецЕсли;
				КонецЕсли;
			КонецЦикла;
			Строка.Результат = Текст.ПолучитьТекст();
		Иначе
			Массив.Удалить(0);
			ДобавитьОстаток(Массив, Строка.Строки, ПолноеИмя);
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры


Процедура КаталогНачалоВыбора(Элемент, СтандартнаяОбработка)
	// Вставить содержимое обработчика.
	Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.ВыборКаталога);
	Диалог.Каталог = Каталог;
	Если Диалог.Выбрать() Тогда
		Каталог = Диалог.Каталог;
		
		Массив = НайтиФайлы(Каталог, "*.*", Ложь);
		СписокФайлов.Строки.Очистить();
		Кол = Массив.Количество();
		Сч = 0;
		Для Каждого Файл Из Массив Цикл
			Сч = Сч + 1;
			Состояние(Файл.ИмяБезРасширения, Цел(Сч * 100/Кол));
			 МассивЧастейИмен = РазложитьСтрокуВМассивПодстрок(Файл.ИмяБезРасширения, ".");  //ОбщегоНазначения>>РегламентированнаяОтчетность
			 Если МассивЧастейИмен.Количество() > 0 Тогда
				 Строка = СписокФайлов.Строки.Найти(МассивЧастейИмен[0], "Имя");
				 Если Строка = Неопределено Тогда
				 	Строка = СписокФайлов.Строки.Добавить();
					Строка.Имя = МассивЧастейИмен[0];
					Если МассивЧастейИмен.Количество() = 1 Тогда
						Строка.ПолноеИмя = Файл.ПолноеИмя;
						Текст = Новый ТекстовыйДокумент;
						Текст.Прочитать(Файл.ПолноеИмя);
						Строка.ИсходныйТекст = Текст.ПолучитьТекст();
						Кол = Текст.КоличествоСтрок();
						Если Кол = 0 Тогда
							Продолжить;
						КонецЕсли;
						А = 0;
						Для ит = 0 По кол - 1 Цикл
							Стр = Текст.ПолучитьСтроку(ит);
							Перфикс = Лев(СокрЛ(Стр),2);
							Если Не ПустаяСтрока(Стр) И Перфикс <> "//" Тогда
								Если Найти(Стр,"Процедура") + Найти(Стр,"Функция") <> 0 Тогда
									Если Найти(Стр,"Процедура _Выполнить(_,_1) Экспорт") > 0 Тогда
										Прервать;
									КонецЕсли;
									Текст.ВставитьСтроку(А+1,ЭлементыФормы.Вставка.ПолучитьТекст());
									Прервать;
								Иначе
									А = ит;
								КонецЕсли;
							КонецЕсли;
						КонецЦикла;
						Строка.Результат = Текст.ПолучитьТекст();
					КонецЕсли;
				КонецЕсли;
				МассивЧастейИмен.Удалить(0);
				Если МассивЧастейИмен.Количество() > 0 Тогда 
					ДобавитьОстаток(МассивЧастейИмен, Строка.Строки, Файл.ПолноеИмя);
				КонецЕсли;
			Конецесли;			
		КонецЦикла;
		
	КонецЕсли;
	
КонецПроцедуры


Процедура ПриОткрытии()
	// Вставить содержимое обработчика.
	ЭлементыФормы.Вставка.УстановитьТекст("
	|//---------------------------------
	|// Процедура отладки модулей
	|//---------------------------------
	|Процедура _Выполнить(_,_0) Экспорт
	|	Выполнить(_);
	|КонецПроцедуры
	|//---------------------------------
	|");
КонецПроцедуры


Процедура СписокФайловПриАктивизацииСтроки(Элемент)
	// Вставить содержимое обработчика.
	ТекущиеДанные = ЭлементыФормы.СписокФайлов.ТекущиеДанные;
	ЭлементыФормы.ИсходныйТекст.Очистить();
	ЭлементыФормы.Результат.Очистить();
	Если ТекущиеДанные <> Неопределено Тогда
		Если Не ПустаяСтрока(ТекущиеДанные.ИсходныйТекст) ТОгда
			ЭлементыФормы.ИсходныйТекст.УстановитьТекст(ТекущиеДанные.ИсходныйТекст);
			ЭлементыФормы.Результат.УстановитьТекст(ТекущиеДанные.Результат);
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры

Процедура ОбработатьДочерние(Строки, Флаг, Колонка)
	Для Каждого Строка ИЗ Строки Цикл
		Строка[Колонка] = Флаг;
		ОбработатьДочерние(Строка.Строки, Флаг, Колонка);
	КонецЦикла;
КонецПроцедуры


Процедура СписокФайловПриИзмененииФлажка(Элемент, Колонка)
	// Вставить содержимое обработчика.
	ТекущиеДанные = ЭлементыФормы.СписокФайлов.ТекущиеДанные;
	Если ТекущиеДанные <> Неопределено Тогда 
		ОбработатьДочерние(ТекущиеДанные.Строки, ТекущиеДанные.Пометка, "Пометка");
	КонецЕсли;
КонецПроцедуры

Процедура ОбновитьСтроки(Строки, ТекстВставки)
	Для Каждого Строка Из Строки Цикл
		Если Строка.Строки.Количество() > 0 Тогда
			ОбновитьСтроки(Строка.Строки, ТекстВставки);
		Иначе
			Текст = Новый ТекстовыйДокумент;
			Текст.УстановитьТекст(Строка.ИсходныйТекст);
			Кол = Текст.КоличествоСтрок();
			Если Кол = 0 Тогда
				Продолжить;
			КонецЕсли;
			А = 0;
			Для ит = 0 По кол - 1 Цикл
				Стр = Текст.ПолучитьСтроку(ит);
				Перфикс = Лев(СокрЛ(Стр),2);
				Если Не ПустаяСтрока(Стр) И Перфикс <> "//" Тогда
					Если Найти(Стр,"Процедура") + Найти(Стр,"Функция") <> 0 Тогда
						Если Найти(Стр,"Процедура _Выполнить(_,_1) Экспорт") > 0 Тогда
							Прервать;
						КонецЕсли;
						Текст.ВставитьСтроку(А+1,ТекстВставки);
						Прервать;
					Иначе
						А = ит;
					КонецЕсли;
				КонецЕсли;
			КонецЦикла;
			Строка.Результат = Текст.ПолучитьТекст();
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры


Процедура КоманднаяПанель1Обновить(Кнопка)
	// Вставить содержимое обработчика.
	ОбновитьСтроки(СписокФайлов.Строки, ЭлементыФормы.Вставка.ПолучитьТекст());
	СписокФайловПриАктивизацииСтроки(Неопределено);
КонецПроцедуры

Процедура ПолучитьИменаОбрабатываемыхФайлов(Массив, Строки)
	Для Каждого Строка Из Строки Цикл
		Если Строка.Пометка И Не ПустаяСтрока(Строка.ПолноеИмя) Тогда
			Файл = Новый Файл(Строка.ПолноеИмя);
			НоваяСтрока = Массив.Добавить();
			НоваяСтрока.Имя = Файл.Имя;
			НоваяСтрока.Алгоритм = "
			|Текст = Новый ТекстовыйДокумент;
			|Текст.Прочитать(Файл);
			|Кол = Текст.КоличествоСтрок();
			|Если Кол <> 0 Тогда
			|	А = 0;
			|	Для ит = 0 По кол - 1 Цикл
			|		Стр = Текст.ПолучитьСтроку(ит);
			|		Перфикс = Лев(СокрЛ(Стр),2);
			|		Если Не ПустаяСтрока(Стр) И Перфикс <> ""//"" Тогда
			|			Если Найти(Стр,""Процедура"") + Найти(Стр,""Функция"") <> 0 Тогда
			|				Если Найти(Стр,""Процедура _Выполнить(_,_1) Экспорт"") > 0 Тогда
			|					Прервать;
			|				КонецЕсли;
			|				Для Каждого Параметр Из Параметры Цикл
			|					Текст.ВставитьСтроку(А+1,Параметр.Значение);
			|				КонецЦикла;
			|				Прервать;
			|			Иначе
			|				А = ит;
			|			КонецЕсли;
			|		КонецЕсли;
			|	КонецЦикла;
			|	Текст.Записать(Файл);
			|КонецЕсли;
			|";
			НоваяСтрока.Параметры.Добавить(ЭлементыФормы.Вставка.ПолучитьТекст(), ЭлементыФормы.Вставка.ПолучитьСтроку(3));
		КонецЕсли;
		ПолучитьИменаОбрабатываемыхФайлов(Массив, Строка.Строки);
	КонецЦикла;
КонецПроцедуры

Процедура ПередЗакрытием(Отказ, СтандартнаяОбработка)
	// Вставить содержимое обработчика.
	Если ВладелецФормы <> Неопределено Тогда
		ПолучитьИменаОбрабатываемыхФайлов(ВладелецФормы.СписокОбработки, СписокФайлов.Строки);
	КонецЕсли;			
КонецПроцедуры

Процедура ПометкаФильтр(Строки, Родитель=Ложь)
	// Вставить содержимое обработчика.
	Для Каждого Файл Из Строки Цикл
		СР = Родитель;
		Если Найти(Файл.Имя, Условие) > 0 Или Родитель Тогда
			Файл.Пометка = Пометка;
			Родитель = Истина;
		КонецЕсли;
		ПометкаФильтр(Файл.Строки, Родитель);
		Родитель = СР;
	КонецЦикла;
КонецПроцедуры


Процедура УсловиеОткрытие(Элемент, СтандартнаяОбработка)
	// Вставить содержимое обработчика.
	СтандартнаяОбработка = Ложь;
	ПометкаФильтр(СписокФайлов.Строки);
КонецПроцедуры

