перем таблЗакладок, ПолныйПутьИИмяФайла;

Процедура ПриОткрытии()
	Контрагент = справочники.Контрагенты.НайтиПоКоду("92498");
	КонтрагентРО = справочники.Контрагенты.НайтиПоКоду("11022");
	КонтрагентРР = справочники.Контрагенты.НайтиПоКоду("11011");
	ПолныйПуть = "C:\";
	
	таблЗакладок = новый ТаблицаЗначений;
	таблЗакладок.Колонки.Добавить("Номер");
	таблЗакладок.Колонки.Добавить("Производитель");
	
	стр1 = таблЗакладок.Добавить();стр1.Номер = 1; стр1.Производитель = "REPLICA TD"; //"Replica TD");
	стр1 = таблЗакладок.Добавить();стр1.Номер = 2; стр1.Производитель = "REPLICA"; // "LA");
	стр1 = таблЗакладок.Добавить();стр1.Номер = 3; стр1.Производитель = "CROSS STREET";//,"Cross");
	стр1 = таблЗакладок.Добавить();стр1.Номер = 4; стр1.Производитель = "Megami";//,"Megami");
	стр1 = таблЗакладок.Добавить();стр1.Номер = 5; стр1.Производитель = "ALCASTA";//,"ALCASTA");
	стр1 = таблЗакладок.Добавить();стр1.Номер = 6; стр1.Производитель = "X-RACE";//,"X-race");
	стр1 = таблЗакладок.Добавить();стр1.Номер = 7; стр1.Производитель = "NZ";//,"NZ");
	стр1 = таблЗакладок.Добавить();стр1.Номер = 8; стр1.Производитель = "YST";//,"YST");
	стр1 = таблЗакладок.Добавить();стр1.Номер = 9; стр1.Производитель = "YOKATTA";//,"Yokatta");
	стр1 = таблЗакладок.Добавить();стр1.Номер = 10;стр1.Производитель = "REPLICA TD Special Series";//, "Replica TD S");
	
//+++ 17.09.2018 +++++++++++++++++++++++++++	
	стр1 = таблЗакладок.Добавить();стр1.Номер = 11;стр1.Производитель = "Steger";
	стр1 = таблЗакладок.Добавить();стр1.Номер = 12;стр1.Производитель = "SDT";
	стр1 = таблЗакладок.Добавить();стр1.Номер = 13;стр1.Производитель = "TREBL";
	стр1 = таблЗакладок.Добавить();стр1.Номер = 14;стр1.Производитель = "ARRIVO";
	
//+++ 29.03.2019 ++++	
	стр1 = таблЗакладок.Добавить();стр1.Номер = 15;стр1.Производитель = "VISSOL";
	стр1 = таблЗакладок.Добавить();стр1.Номер = 16;стр1.Производитель = "HARP";
	стр1 = таблЗакладок.Добавить();стр1.Номер = 17;стр1.Производитель = "BUFFALO";

КонецПроцедуры

Процедура КнопкаВыполнитьНажатие(Кнопка)
	
	Если Контрагент.Пустая() или СокрЛП(ПолныйПуть)="" тогда
		Предупреждение("Не выбран контрагент или файл выгрузки!",30);
		возврат;
	КонецЕсли;	
	
	Если прав(ПолныйПуть,1)<>"\" тогда
		ПолныйПуть = ПолныйПуть+"\";
	КонецЕсли;	
	ПолныйПутьИИмяФайла = ПолныйПуть + "Прайс-лист "+СокрЛП(Контрагент.Наименование)+" от "+формат(ТекущаяДата(),"ДЛФ=D")+".xls";
	
	сообщить(строка(ТекущаяДата())+" начало формирования -----------------------");
	СписокНоменклатуры = ПолучитьВсеДискиСНеНулевойЦеной();
	сообщить(строка(ТекущаяДата())+" получено "+строка(СписокНоменклатуры.Количество())+" дисков с ненулевой ценой-------");
	
	ЦеныПредоплатные = истина;
		
	таблК = ОбменСУТИнтернетМагазин.ПолучитьЦеныДляКонтрагента_РегСв(Контрагент,СписокНоменклатуры);
	сообщить(строка(ТекущаяДата())+" получены "+строка(таблК.Количество())+" цен ("+?(ЦеныПредоплатные,"Предоплаты","Отсрочки")+")для Клиента "+строка(Контрагент)+"-------");
	
	таблРО = ОбменСУТИнтернетМагазин.ПолучитьЦеныДляКонтрагента_РегСв(КонтрагентРО,СписокНоменклатуры);
	сообщить(строка(ТекущаяДата())+" получено "+строка(таблК.Количество())+" цен для Клиента "+строка(КонтрагентРО)+" -------");
	
	таблРР = ОбменСУТИнтернетМагазин.ПолучитьЦеныДляКонтрагента_РегСв(КонтрагентРР,СписокНоменклатуры);
	сообщить(строка(ТекущаяДата())+" получено "+строка(таблК.Количество())+" цен для Клиента "+строка(КонтрагентРР)+" -------");
	
СклеитьТриТаблицыИВывестиВТабличныйДокумент(таблК, таблРО, таблРР, ЦеныПредоплатные);
	
КонецПроцедуры

функция ПолучитьВсеДискиСНеНулевойЦеной()
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	ЦеныНоменклатурыСрезПоследних.Номенклатура
	//|	, ЦеныНоменклатурыСрезПоследних.Цена
	|ИЗ
	|	РегистрСведений.ЦеныНоменклатуры.СрезПоследних( ,
	|			Номенклатура.ВидТовара = &Диски
	|	и Номенклатура.Производитель.Наименование в (&масПроизодителей)
	|				И ТипЦен = &Базовая) КАК ЦеныНоменклатурыСрезПоследних";
	Запрос.УстановитьПараметр("Диски", перечисления.ВидыТоваров.Диски );
	Запрос.УстановитьПараметр("Базовая", справочники.ТипыЦенНоменклатуры.НайтиПоКоду("00008") );
	
	//сразу режем лишнее	
	масПроизодителей = таблЗакладок.ВыгрузитьКолонку("Производитель");
	Запрос.УстановитьПараметр("масПроизодителей",масПроизодителей);
	
	Результат = Запрос.Выполнить();
	табл = результат.Выгрузить();	
	
	спис = новый СписокЗначений;
	спис.ЗагрузитьЗначения( табл.ВыгрузитьКолонку("Номенклатура") );
	возврат спис;
КонецФункции

процедура СклеитьТриТаблицыИВывестиВТабличныйДокумент(таблК, таблРО, таблРР, ЦенаПредоплаты=Истина)
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	ТаблК.Номенклатура,
	               |	Выразить(ТаблК.ЦенаСоСкидкойПредоплаты как число(15,0)) КАК ЦенаКлиента,
	               |	Выразить(ТаблК.ЦенаПоТипуЦен как число(15,0)) КАК ЦенаПоТипуЦен,
	               |	ТаблК.Приоритет КАК НомерПравила
	               |ПОМЕСТИТЬ ВТ_ЦеныК
	               |ИЗ
	               |	&ТаблК КАК ТаблК
				   |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ТаблРР.Номенклатура,
	               |	Выразить(ТаблРР.МинимальнаяЦена как число(15,0)) КАК ЦенаРР
	               |ПОМЕСТИТЬ ВТ_ЦеныРР
	               |ИЗ
	               |	&ТаблРР КАК ТаблРР
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ТаблРО.Номенклатура,
	               |	Выразить(ТаблРО.МинимальнаяЦена как число (15,0)) КАК ЦенаРО
	               |ПОМЕСТИТЬ ВТ_ЦеныРО
	               |ИЗ
	               |	&ТаблРО КАК ТаблРО
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	спрНоменклатура.Производитель.Наименование КАК Производитель,
	               |	спрНоменклатура.Код КАК Код,
	               |	спрНоменклатура.Наименование КАК Номенклатура,
	               |	ЕСТЬNULL(ЦеныК.ЦенаКлиента,0) КАК ЦенаКлиента,
	              // |	ВЫРАЗИТЬ(ЦеныК.ЦенаКлиента * 100 / ЦеныК.ЦенаПоТипуЦен - 100 КАК ЧИСЛО(10, 2)) КАК СкидкаКлиента,
	               |	ЕСТЬNULL(ЦеныК.ЦенаПоТипуЦен,0) КАК ЦенаПоТипуЦен,
	               |	ЕСТЬNULL(ЦеныРР.ЦенаРР, 0) КАК ЦенаРР,
	               |	ЕСТЬNULL(ЦеныРО.ЦенаРО, 0) КАК ЦенаРО,
	               |	ЦеныК.НомерПравила КАК НомерПравила
	               |ИЗ
	               |	ВТ_ЦеныК КАК ЦеныК
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК спрНоменклатура
	               |		ПО ЦеныК.Номенклатура = спрНоменклатура.Ссылка
	               |		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ЦеныРР КАК ЦеныРР
	               |		ПО ЦеныК.Номенклатура = ЦеныРР.Номенклатура
	               |		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ЦеныРО КАК ЦеныРО
	               |		ПО ЦеныК.Номенклатура = ЦеныРО.Номенклатура
	              |ИТОГИ
	               |	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Код)
	               |ПО
	               |	Производитель
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ ВТ_ЦеныК
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ ВТ_ЦеныРР
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ ВТ_ЦеныРО";
 Если не ЦенаПредоплаты тогда
	 Запрос.Текст = стрЗаменить(Запрос.Текст, "ТаблК.ЦенаСоСкидкойПредоплаты","ТаблК.МинимальнаяЦена");
 КонецЕсли;		
	Запрос.УстановитьПараметр("таблК",таблК );
	Запрос.УстановитьПараметр("ТаблРР",ТаблРР );
	Запрос.УстановитьПараметр("ТаблРО",ТаблРО );
		
	Результат = Запрос.Выполнить();
	выборкаП = Результат.Выбрать( ОбходРезультатаЗапроса.ПоГруппировкам );
	
	таблДок = Новый ТабличныйДокумент;
	
	МасКолонки  = новый массив;
	МасКолонки.Добавить("итого"); //0
	
	МасКолонки.Добавить("Производитель"); //1
	МасКолонки.Добавить("Код");           //2
	МасКолонки.Добавить("Номенклатура");
	МасКолонки.Добавить("ЦенаПоТипуЦен"); //База,
	МасКолонки.Добавить("ЦенаКлиента");   //Ваша цена
	МасКолонки.Добавить("ЦенаРО");        //РО
	МасКолонки.Добавить("ЦенаРР");        //РР
	МасКолонки.Добавить("НомерПравила");  //7
	
	//таблДок = новый ТабличныйДокумент;
	попытка
		АктивныйДокумент = ЭтотОбъект.ПолучитьМакет("МакетExcel");
		Excel = АктивныйДокумент.Получить();
				
		Excel.Application.DisplayAlerts = 0;
		Excel.Application.WorkBooks(1).Activate();
		
		Excel.Application.Visible = ?(Флажок1,1,0);
	
		Сообщить("Открыт макет Excel с закладками.");
	исключение
		Excel = 0;
		Сообщить("Ошибка открытия макета Excel. Открыт файл - шаблон шс.xls, НЕ сохраняйте данные в шаблон!", СтатусСообщения.Внимание);
		Возврат;
	КонецПопытки;
	
	пока выборкаП.Следующий() цикл
		закладка = таблЗакладок.Найти(выборкаП.Производитель, "Производитель" );
		Если закладка = неопределено тогда //не надо значит!
			Сообщить("... не нужен производитель: "+выборкаП.Производитель);
			продолжить;
		КонецЕсли;	
		Сообщить(" -> Идет заполнение закладки № "+строка(закладка.Номер)+" - Производитель: "+закладка.Производитель);
		
		ExcelЛист = Excel.Sheets(закладка.Номер);
		ExcelЛист.Activate();
		
		номСтр = 1;  //шапка в 1-ой строки
		//для i=1 по МасКолонки.Количество()-1 цикл
	 	// таблДок.Область(номСтр, i, номСтр,i).Текст = МасКолонки[i];
		//КонецЦикла;
		//таблДок.Область(номСтр, 1, номСтр,1).Текст = выборкаП.Производитель;
		//таблДок.Область(номСтр, 2, номСтр,2).Текст = выборкаП.Код;
		
		номСтр = номСтр + 1;  // со второй
		
		выборка = выборкаП.Выбрать();
		//таблДок.НачатьГруппуСтрок();    //+++++++++++++++++++
		пока выборка.Следующий() цикл
			ОбработкаПрерыванияПользователя();
			
			для i=2 по МасКолонки.Количество()-1 цикл
			//таблДок.Область(номСтр, i, номСтр,i).Текст = выборка[ МасКолонки[i] ];
			ExcelЛист.cells(номСтр,i-1).value = выборка[ МасКолонки[i] ];
			КонецЦикла;
		
			Если номСтр%100=0 тогда
				Состояние(строка(номСтр)+" строк заполнено --- " + выборка.Номенклатура );
			КонецЕсли;	
		номСтр = номСтр + 1;
		КонецЦикла;	
	    //таблДок.ЗакончитьГруппуСтрок(); //+++++++++++++++++++
		
	КонецЦикла;
	Сообщить( строка(ТекущаяДата())+" ---- идёт запись файла Excel... " );
	
	//таблДок.Показать();
	попытка
		Excel.SaveAs(ПолныйПутьИИмяФайла); 
		Сообщить("Файл Excel сохранен "+ПолныйПутьИИмяФайла, СтатусСообщения.Информация );
		Excel.Application.WorkBooks.Close();  //всё закрывает!
		Excel = 0;
	исключение
		Сообщить("Ошибка записи файла "+ПолныйПутьИИмяФайла+" : "+ОписаниеОшибки(), СтатусСообщения.Важное);
		//---------Закрываем----------------------
		Excel.Application.WorkBooks.Close();
		Excel = 0;
	КонецПопытки;

	
КонецПроцедуры	

Процедура ПолныйПутьНачалоВыбора(Элемент, СтандартнаяОбработка)
	СтандартнаяОбработка = ложь;
	
	Режим = РежимДиалогаВыбораФайла.ВыборКаталога;
	ДиалогОткрытияФайла = Новый ДиалогВыбораФайла(Режим);
	ДиалогОткрытияФайла.Каталог = ПолныйПуть;
	ДиалогОткрытияФайла.Заголовок = "Выберите путь к файлу";
	Если ДиалогОткрытияФайла.Выбрать() Тогда
	ПолныйПуть = ДиалогОткрытияФайла.Каталог;
	КонецЕсли;
	
КонецПроцедуры

Процедура Надпись5Нажатие(Элемент)
	ТаблДок = новый ТабличныйДокумент;
	ТаблДок.Область(1,1,1,1).текст = "№";
	ТаблДок.Область(1,2,1,2).текст = "Брэнд";
	для i=0 по ТаблЗакладок.Количество()-1 цикл
	ТаблДок.Область(i+2,1,i+2,1).текст = ТаблЗакладок[i].Номер;
	ТаблДок.Область(i+2,2,i+2,2).текст = ТаблЗакладок[i].Производитель;
	КонецЦикла;
	ТаблДок.Показать();
КонецПроцедуры
