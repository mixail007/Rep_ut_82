Перем СохраненнаяНастройка Экспорт;
Перем Построитель Экспорт;

#Если Клиент Тогда

// Процедура сохраняет настройку
//
Процедура СохранитьНастройку() Экспорт
	НастройкиПостроителя = Построитель.ПолучитьНастройки(Истина, Истина, Истина, Ложь, Ложь);
	//СтруктураНастроек = ТиповыеОтчеты.ПолучитьСтруктуруПараметровТиповогоОтчета(ЭтотОбъект);
	//СохранениеНастроек.СохранитьНастройкуОбъекта(СохраненнаяНастройка, СтруктураНастроек);
	
КонецПроцедуры // СохранитьНастройку()

// Процедура заполняет параметры отчета по элементу справочника из переменной СохраненнаяНастройка.
//
Процедура ПрименитьНастройку() Экспорт
	
	Если СохраненнаяНастройка.Пустая() Тогда
		Возврат;
	КонецЕсли;
	 
	СтруктураПараметров = СохраненнаяНастройка.ХранилищеНастроек.Получить();
	//ТиповыеОтчеты.ПрименитьСтруктуруПараметровОтчета(ЭтотОбъект, СтруктураПараметров);
	Если НастройкиПостроителя <> Неопределено Тогда
		Построитель.УстановитьНастройки(НастройкиПостроителя, Истина, Истина, Истина, Ложь, Ложь);
	КонецЕсли;

КонецПроцедуры // ПрименитьНастройку()

// Процедура инициализирует настройку обработки
//
Процедура ИнициализацияОтчета(Форма = Неопределено) Экспорт

	Если НЕ Форма = Неопределено Тогда
		Для Каждого Настройка Из Форма.НастройкиОтчета Цикл
			ЭтотОбъект[Настройка.Ключ] = Настройка.Значение;
		КонецЦикла;
	КонецЕсли;

КонецПроцедуры // ИнициализацияОтчета()

#КонецЕсли


// Процедура получает текст запроса для формирования обработки
//
Процедура ИнициализироватьПостроитель() Экспорт
	Построитель.Текст ="ВЫБРАТЬ
	                   |	ЕСТЬNULL(ЗначенияТочкиЗаказаСрезПоследних.Номенклатура, ТоварыНаСкладахОстатки.Номенклатура) КАК Номенклатура,
	                   |	ЕСТЬNULL(ТоварыНаСкладахОстатки.КоличествоОстаток - ЕСТЬNULL(ЗаказыПокупателейОстатки.КоличествоОстаток, 0), 0) КАК СвободныйОстаток,
	                   |	ЗначенияТочкиЗаказаСрезПоследних.ЗначениеТочкиЗаказа,
	                   |	ЗначенияТочкиЗаказаСрезПоследних.МинимальныйСтраховойЗапас,
	                   |	ВЫБОР
	                   |		КОГДА ЕСТЬNULL(ТоварыНаСкладахОстатки.КоличествоОстаток - ЕСТЬNULL(ЗаказыПокупателейОстатки.КоличествоОстаток, 0), 0) <= ЗначенияТочкиЗаказаСрезПоследних.МинимальныйСтраховойЗапас
	                   |			ТОГДА ЗначенияТочкиЗаказаСрезПоследних.ЗначениеТочкиЗаказа - ЕСТЬNULL(ТоварыНаСкладахОстатки.КоличествоОстаток - ЕСТЬNULL(ЗаказыПокупателейОстатки.КоличествоОстаток, 0), 0)
	                   |		ИНАЧЕ 0
	                   |	КОНЕЦ КАК КЗаказу,
	                   |	ЕСТЬNULL(ЗначенияТочкиЗаказаСрезПоследних.Номенклатура.ОсновнойПоставщик, ТоварыНаСкладахОстатки.Номенклатура.ОсновнойПоставщик) КАК Поставщик,
	                   |	ЦеныНоменклатурыСрезПоследних.Цена,
	                   |	ЕСТЬNULL(ЗначенияТочкиЗаказаСрезПоследних.Номенклатура.ЕдиницаХраненияОстатков, ТоварыНаСкладахОстатки.Номенклатура.ЕдиницаХраненияОстатков) КАК ЕдиницаИзмеренияОстаток
	                   |ПОМЕСТИТЬ Пром
	                   |ИЗ
	                   |	РегистрСведений.ЗначенияТочкиЗаказа.СрезПоследних(, Номенклатура.НоменклатурнаяГруппа.Ответственный = &Ответственный) КАК ЗначенияТочкиЗаказаСрезПоследних
	                   |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыНаСкладах.Остатки(
	                   |				,
	                   |				Номенклатура.НоменклатурнаяГруппа.Ответственный = &Ответственный
	                   |						И НЕ Склад.Транзитный
	                   |						И НЕ Склад.ЗапретитьИспользование
	                   |					ИЛИ Склад В (&СписокСкладов)
	                   |						И Номенклатура.НоменклатурнаяГруппа.Ответственный = &Ответственный) КАК ТоварыНаСкладахОстатки
	                   |			ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ЗаказыПокупателей.Остатки(
	                   |					,
	                   |					НЕ ЗаказПокупателя.Транзит
	                   |						И ЗаказПокупателя.Проверен) КАК ЗаказыПокупателейОстатки
	                   |			ПО ТоварыНаСкладахОстатки.Номенклатура = ЗаказыПокупателейОстатки.Номенклатура
	                   |		ПО ЗначенияТочкиЗаказаСрезПоследних.Номенклатура = ТоварыНаСкладахОстатки.Номенклатура
	                   |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры.СрезПоследних(, ТипЦен = &Закупочная) КАК ЦеныНоменклатурыСрезПоследних
	                   |		ПО ЗначенияТочкиЗаказаСрезПоследних.Номенклатура = ЦеныНоменклатурыСрезПоследних.Номенклатура
	                   |ГДЕ
	                   |	ЗначенияТочкиЗаказаСрезПоследних.СпособОпределенияЗначенияТочкиЗаказа = &Фикс
	                   |;
	                   |
	                   |////////////////////////////////////////////////////////////////////////////////
	                   |ВЫБРАТЬ
	                   |	Пром.Поставщик КАК Поставщик,
	                   |	Пром.Номенклатура КАК Номенклатура,
	                   |	Пром.Цена,
	                   |	Пром.Цена * (Пром.КЗаказу - ЕСТЬNULL(ЗаказыПоставщикамОстатки.КоличествоОстаток, 0)) КАК СуммаЗаказа,
	                   |	ЛОЖЬ КАК Пометка,
	                   |	ЗаказыПоставщикамОстатки.КоличествоОстаток,
	                   |	Пром.КЗаказу - ЕСТЬNULL(ЗаказыПоставщикамОстатки.КоличествоОстаток, 0) КАК КЗаказу,
	                   |	Пром.ЕдиницаИзмеренияОстаток
	                   |ПОМЕСТИТЬ СОтр
	                   |ИЗ
	                   |	Пром КАК Пром
	                   |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ЗаказыПоставщикам.Остатки КАК ЗаказыПоставщикамОстатки
	                   |		ПО Пром.Номенклатура = ЗаказыПоставщикамОстатки.Номенклатура
	                   |ГДЕ
	                   |	Пром.КЗаказу > 0
	                   |;
	                   |
	                   |////////////////////////////////////////////////////////////////////////////////
	                   |ВЫБРАТЬ
	                   |	СОтр.Поставщик КАК Поставщик,
	                   |	СОтр.Номенклатура КАК Номенклатура,
	                   |	СОтр.Цена,
	                   |	СОтр.КЗаказу,
	                   |	СОтр.СуммаЗаказа КАК СуммаЗаказа,
	                   |	СОтр.Пометка,
	                   |	СОтр.ЕдиницаИзмеренияОстаток,
	                   |	СОтр.Номенклатура.Артикул КАК Артикул
	                   |ИЗ
	                   |	СОтр КАК СОтр
	                   |ГДЕ
	                   |	СОтр.КЗаказу > 0
	                   |
	                   |УПОРЯДОЧИТЬ ПО
	                   |	Поставщик,
	                   |	Номенклатура
	                   |ИТОГИ
	                   |	СУММА(СуммаЗаказа)
	                   |ПО
	                   |	Поставщик";
	// 0 таблица остатки
	КонецПроцедуры

Построитель = Новый ПостроительОтчета();
