
Процедура КнопкаВыполнитьНажатие(Кнопка)

	ТабДок = Новый ТабличныйДокумент;
	Макет = ПолучитьМакет("Макет");
	
	ОбластьШапка = Макет.ПолучитьОбласть("Шапка");
	ОбластьСтрока = Макет.ПолучитьОбласть("Строка");
	ОбластьИтоги = Макет.ПолучитьОбласть("Итоги");
	ОбластьПодвал = Макет.ПолучитьОбласть("Подвал");
	
	ТабДок.Вывести(Областьшапка);
	
	СписокДоговоров = Новый СписокЗначений;
	СписокДоговоров.Добавить(Справочники.ТипыДоговоров.ШинтрейдЯрославль);
	СписокДоговоров.Добавить(Справочники.ТипыДоговоров.ФормулаАвтоПлюс);
	СписокДоговоров.Добавить(Справочники.ТипыДоговоров.НайтиПоКоду("Я0004")); //Формула Авто
	
	СписокПеревозчиков = Новый СписокЗначений;
	СписокПеревозчиков.Добавить("ИП Малышев Егор Игоревич");
	СписокПеревозчиков.Добавить("ИП Землянский Александр Николаевич");
	СписокПеревозчиков.Добавить("Акционерное общество ""ДПД РУС""");
	СписокПеревозчиков.Добавить("ООО ""Корпорация Волга""");
	СписокПеревозчиков.Добавить("Армадилло Бизнес Посылка");
	СписокПеревозчиков.Добавить("Филиал ЗАО ТК ""Яршинторг"" г.Санкт-Петербург");
	СписокПеревозчиков.Добавить("Филиал ЗАО ТК ""Яршинторг"" г. Ростов-на-Дону");
	СписокПеревозчиков.Добавить("ЕКБ ЯШТ перевозчик");
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ДатаНачала", ДатаНачала);
	Запрос.УстановитьПараметр("ДатаОкончания", КонецДня(ДатаОкончания));
	Запрос.УстановитьПараметр("СписокДоговоров", СписокДоговоров);
	Запрос.УстановитьПараметр("СписокПеревозчиков", СписокПеревозчиков);
	Запрос.Текст = "ВЫБРАТЬ
	               |	РеализацияТоваровУслуг.Ссылка,
	               |	ВЫРАЗИТЬ(РеализацияТоваровУслуг.Перевозчик КАК Строка(200)) КАК Перевозчик,
	               |	РеализацияТоваровУслуг.МаркаАвтомобиля,
	               |	РеализацияТоваровУслуг.ГосНомерАвтомобиля
	               |ИЗ
	               |	Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
	               |ГДЕ
	               |	РеализацияТоваровУслуг.Проведен
	               |	И РеализацияТоваровУслуг.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания
	               |	И НЕ РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""%*%""
	               |	И НЕ РеализацияТоваровУслуг.ДоговорКонтрагента.ТипДоговора В (&СписокДоговоров)
	               |	И НЕ РеализацияТоваровУслуг.Перевозчик В (&СписокПеревозчиков)
	               |	И РеализацияТоваровУслуг.Перевозчик <> """"";
	Результат = Запрос.Выполнить().Выгрузить();
	Для каждого СтрТЗ ИЗ Результат Цикл
		СтрТЗ.Перевозчик = СокрЛП(СтрТЗ.Перевозчик) + Символы.ПС + СокрЛП(СтрТЗ.МаркаАвтомобиля) + Символы.ПС + СокрЛП(СтрТЗ.ГосНомерАвтомобиля);
	КонецЦикла;			
	ТаблицаПеревозчиков = Результат.Скопировать();
	ТаблицаПеревозчиков.Свернуть("Перевозчик");
	НомерПП = 0;
	СуммаИтого = 0;
	Для каждого СтрПеревозчик ИЗ ТаблицаПеревозчиков Цикл
		Отбор = Новый Структура;
		Отбор.Вставить("Перевозчик", СтрПеревозчик.Перевозчик);
		СтрокиТЗ = Результат.НайтиСтроки(Отбор);
		НомерПП = НомерПП + 1;
		ОбластьСтрока.Параметры.НомерПП = НомерПП;
		ОбластьСтрока.Параметры.Начало = ДатаНачала;
		ОбластьСтрока.Параметры.Окончание = ДатаНачала + 7*24*60*60;
		ОбластьСтрока.Параметры.ВидТранспорта = СтрПеревозчик.Перевозчик;
		НомераНакладных = "";
		ПунктНазначения = "";
		НомерСтроки = 0;
		СуммаСтроки = 0;
		Пунктотправления = "";
		Для каждого НайдСтр ИЗ СтрокиТЗ Цикл
			НомерСтроки = НомерСтроки + 1;
			НомераНакладных = НомераНакладных + НайдСтр.Ссылка.Номер + Символы.ПС;
			ПунктНазначения = ПунктНазначения + Символы.ПС + Строка(НомерСтроки) + ". " + НайдСтр.Ссылка.Контрагент.НаименованиеПолное + ", " + Символы.ПС + СокрЛП(НайдСтр.Ссылка.ПунктРазгрузки);
			Пунктотправления = ПолучитьАдресФилиала(НайдСтр.Ссылка.Подразделение.Код);
			СуммаСтроки = СуммаСтроки + НайдСтр.Ссылка.СуммаДокумента;
		КонецЦикла;
		ОбластьСтрока.Параметры.НомераНакладных = НомераНакладных;
		ОбластьСтрока.Параметры.ДатаНакладных = ДатаНачала;
		ОбластьСтрока.Параметры.ПунктНазначения = ПунктНазначения;
		ОбластьСтрока.Параметры.ПунктОтправления = ПунктОтправления;
		ОбластьСтрока.Параметры.Сумма = СуммаСтроки;
		СуммаИтого = СуммаИтого + СуммаСтроки;
		ТабДок.Вывести(ОбластьСтрока);
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ДатаНачала", ДатаНачала);
	Запрос.УстановитьПараметр("ДатаОкончания", КонецДня(ДатаОкончания));
	Запрос.УстановитьПараметр("СписокПеревозчиков", СписокПеревозчиков);
	Запрос.Текст = "ВЫБРАТЬ
	               |	ПеремещениеТоваров.Ссылка,
	               |	ВЫРАЗИТЬ(ПеремещениеТоваров.Перевозчик КАК СТРОКА(200)) КАК Перевозчик,
	               |	ПеремещениеТоваров.МаркаАвтомобиля,
	               |	ПеремещениеТоваров.ГосНомерАвтомобиля,
	               |	А.СуммаДокумента
	               |ИЗ
	               |	Документ.ПеремещениеТоваров КАК ПеремещениеТоваров
	               |		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	               |			ПеремещениеТоваровТовары.Ссылка КАК Ссылка,
	               |			СУММА(ПеремещениеТоваровТовары.Количество * ЗаказПокупателяТовары.Цена) КАК СуммаДокумента
	               |		ИЗ
	               |			Документ.ПеремещениеТоваров.Товары КАК ПеремещениеТоваровТовары
	               |				ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказПокупателя.Товары КАК ЗаказПокупателяТовары
	               |				ПО ПеремещениеТоваровТовары.Ссылка.ВнутреннийЗаказ.ДокументОснование = ЗаказПокупателяТовары.Ссылка
	               |					И ПеремещениеТоваровТовары.Номенклатура = ЗаказПокупателяТовары.Номенклатура
	               |		ГДЕ
	               |			ПеремещениеТоваровТовары.Ссылка.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания
	               |		
	               |		СГРУППИРОВАТЬ ПО
	               |			ПеремещениеТоваровТовары.Ссылка) КАК А
	               |		ПО ПеремещениеТоваров.Ссылка = А.Ссылка
	               |ГДЕ
	               |	ПеремещениеТоваров.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания
	               |	И ПеремещениеТоваров.Проведен
	               |	И ПеремещениеТоваров.ВнутреннийЗаказ.ДокументОснование.ПечататьСтраховоеЗаявление
	               |	И НЕ ПеремещениеТоваров.Перевозчик В (&СписокПеревозчиков)
	               |	И НЕ ПеремещениеТоваров.Перевозчик = """"";
	Результат = Запрос.Выполнить().Выгрузить();
	Для каждого СтрТЗ ИЗ Результат Цикл
		СтрТЗ.Перевозчик = СокрЛП(СтрТЗ.Перевозчик) + Символы.ПС + СокрЛП(СтрТЗ.МаркаАвтомобиля) + Символы.ПС + СокрЛП(СтрТЗ.ГосНомерАвтомобиля);
	КонецЦикла;			
	ТаблицаПеревозчиков = Результат.Скопировать();
	ТаблицаПеревозчиков.Свернуть("Перевозчик");
	Для каждого СтрПеревозчик ИЗ ТаблицаПеревозчиков Цикл
		Отбор = Новый Структура;
		Отбор.Вставить("Перевозчик", СтрПеревозчик.Перевозчик);
		СтрокиТЗ = Результат.НайтиСтроки(Отбор);
		НомерПП = НомерПП + 1;
		ОбластьСтрока.Параметры.НомерПП = НомерПП;
		ОбластьСтрока.Параметры.Начало = ДатаНачала;
		ОбластьСтрока.Параметры.Окончание = ДатаНачала + 7*24*60*60;
		ОбластьСтрока.Параметры.ВидТранспорта = СтрПеревозчик.Перевозчик;
		НомераНакладных = "";
		ПунктНазначения = "";
		НомерСтроки = 0;
		СуммаСтроки = 0;
		Пунктотправления = "";
		Для каждого НайдСтр ИЗ СтрокиТЗ Цикл
			НомерСтроки = НомерСтроки + 1;
			НомераНакладных = НомераНакладных + НайдСтр.Ссылка.Номер + Символы.ПС;
			АдресДоставки = ПолучитьАдресФилиала(НайдСтр.Ссылка.СкладПолучатель.Подразделение.Код);
			ПунктНазначения = ПунктНазначения + Символы.ПС + Строка(НомерСтроки) + ". " + НайдСтр.Ссылка.ВнутреннийЗаказ.ДокументОснование.Контрагент.НаименованиеПолное + ", " + Символы.ПС +  АдресДоставки;
			Пунктотправления = ПолучитьАдресФилиала(НайдСтр.Ссылка.Подразделение.Код);
			СуммаСтроки = СуммаСтроки + НайдСтр.СуммаДокумента;
		КонецЦикла;
		ОбластьСтрока.Параметры.НомераНакладных = НомераНакладных;
		ОбластьСтрока.Параметры.ДатаНакладных = ДатаНачала;
		ОбластьСтрока.Параметры.ПунктНазначения = ПунктНазначения;
		ОбластьСтрока.Параметры.ПунктОтправления = ПунктОтправления;
		ОбластьСтрока.Параметры.Сумма = СуммаСтроки;
		СуммаИтого = СуммаИтого + СуммаСтроки;
		ТабДок.Вывести(ОбластьСтрока);
	КонецЦикла;
	
	ОбластьИтоги.Параметры.СуммаИтого = СуммаИтого;
	ТабДок.Вывести(ОбластьИтоги);
	ТабДок.Вывести(ОбластьПодвал);
	
	ТабДок.ОтображатьЗаголовки = Ложь;
	ТабДок.ОтображатьСетку = Ложь;
	
	ТабДок.Показать();
	
КонецПроцедуры

Процедура КнопкаВыбораПериодаНажатие(Элемент)
	
	НастройкаПериода = Новый НастройкаПериода;
	НастройкаПериода.УстановитьПериод(ДатаНачала, ?(ДатаОкончания='0001-01-01', ДатаОкончания, КонецДня(ДатаОкончания)));
	НастройкаПериода.РедактироватьКакИнтервал = Истина;
	НастройкаПериода.РедактироватьКакПериод = Истина;
	НастройкаПериода.ВариантНастройки = ВариантНастройкиПериода.Период;
	Если НастройкаПериода.Редактировать() Тогда
		ДатаНачала = НастройкаПериода.ПолучитьДатуНачала();
		ДатаОкончания = НастройкаПериода.ПолучитьДатуОкончания();
	КонецЕсли;
	
КонецПроцедуры

Процедура ПриОткрытии()
	
	ДатаНачала = НачалоДня(НачалоДня(ТекущаяДата()) - 1);
	ДатаОкончания = НачалоДня(ТекущаяДата()) - 1;
	
КонецПроцедуры

Функция ПолучитьАдресФилиала(КодПодразделения)
	
	Если КодПодразделения = "00005" Тогда 
		Пунктотправления = "г.Ярославль, ул.Базовая, д.3, стр.2";
	ИначеЕсли КодПодразделения = "00112" Тогда
		Пунктотправления = "г.С.Петербург, Грузовой Проезд, д.14, кор.2, лит.А";
	ИначеЕсли КодПодразделения = "00172" Тогда
		Пунктотправления = "Самарская обл., г.Тольятти, ул.Северная, д.18Б";
	ИначеЕсли КодПодразделения = "00106" Тогда
		Пунктотправления = "Ростовская обл., г.Ростов-на-Дону, ул.Доватора, д.154/5";
	ИначеЕсли КодПодразделения = "00138" Тогда
		Пунктотправления = "г.Екатеринбург, пл.Жуковского, д.1-Я";
	ИначеЕсли КодПодразделения = "00133" Тогда
		ПунктОтправления = "г.Москва, ул.Южнопортовая, д.7, корп.1, оф.338";
	КонецЕсли;
	
	Возврат ПунктОтправления;
	
КонецФункции