перем Категория;


Процедура ПриОткрытии()
	ОбновитьСписок();
	ОбновитьАдреса();
КонецПроцедуры

Процедура ОбновитьСписок()
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ЛОЖЬ КАК Флаг,
		|	КатегорииОбъектов.Объект КАК Контрагент,
		|	КатегорииОбъектов.Объект.ЗапретитьВводЗаказаПокупателя КАК ЗапретВводаЗаказа,
		|	КатегорииОбъектов.Объект.ЗапретОтгрузки КАК ЗапретОтгрузки
		|ИЗ
		|	РегистрСведений.КатегорииОбъектов КАК КатегорииОбъектов
		|ГДЕ
		|	КатегорииОбъектов.Категория = &Категория";
	
	Запрос.УстановитьПараметр("Категория", Категория);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Контрагенты.Очистить();
	Контрагенты = РезультатЗапроса.Выгрузить();
	
конецПроцедуры	


Процедура ОбновитьАдреса()
	Адреса.Очистить();
	стр1 = Адреса.Добавить();
	стр1.Менеджер = справочники.Пользователи.НайтиПоКоду("Горохов");
	стр1.Адрес = "gorohov@yst.ru";
	
	стр1 = Адреса.Добавить();
	стр1.Менеджер = справочники.Пользователи.НайтиПоКоду("Серков");
	стр1.Адрес = "serkov@yst.ru";
КонецПроцедуры	
	
Процедура КоманднаяПанель1Обновить(Кнопка)
ОбновитьСписок();
КонецПроцедуры

Процедура КонтрагентыПередОкончаниемРедактирования(Элемент, НоваяСтрока, ОтменаРедактирования, Отказ)
	Если НоваяСтрока и ЭлементыФормы.Контрагенты.ТекущиеДанные.Контрагент<>Справочники.Контрагенты.ПустаяСсылка() Тогда
		//ответ = Вопрос("Установить для контрагента категорию ответчики по судам?",РежимДиалогаВопрос.ДаНет);	
		//Если ответ = КодВозвратаДиалога.Да Тогда
		Отбор = Новый Структура;
		Отбор.Вставить("Контрагент",ЭлементыФормы.Контрагенты.ТекущиеДанные.Контрагент);
		ЕстьУже = Контрагенты.НайтиСтроки(Отбор);
		Если ЕстьУже.количество()>1 Тогда
			предупреждение("Контрагент уже есть в списке!");	
			Контрагенты.Удалить(ЭлементыФормы.Контрагенты.ТекущиеДанные);
		иначе
			МенеджерЗаписи = РегистрыСведений.КатегорииОбъектов.СоздатьМенеджерЗаписи(); 
			МенеджерЗаписи.Объект   = ЭлементыФормы.Контрагенты.ТекущиеДанные.Контрагент; 
			МенеджерЗаписи.Категория = Категория; 
			МенеджерЗаписи.Записать(); 
		КонецЕсли;
		//иначе	
		//	Контрагенты.Удалить(ЭлементыФормы.Контрагенты.ТекущиеДанные);
		//конецЕсли;	
	КонецЕсли;	
КонецПроцедуры

Процедура КонтрагентыПередУдалением(Элемент, Отказ)
	//ответ = Вопрос("Удалить контрагента категорию ответчики по судам?",РежимДиалогаВопрос.ДаНет);	
	//Если ответ = КодВозвратаДиалога.Да Тогда
		МенеджерЗаписи = РегистрыСведений.КатегорииОбъектов.СоздатьМенеджерЗаписи(); 
        МенеджерЗаписи.Объект   = ЭлементыФормы.Контрагенты.ТекущиеДанные.Контрагент; 
        МенеджерЗаписи.Категория = Категория; 
        МенеджерЗаписи.Удалить(); 
	//иначе	
	//отказ =Истина;	
	//конецЕсли;	
КонецПроцедуры

Процедура КонтрагентыПередНачаломИзменения(Элемент, Отказ)
	Элемент.Колонки.Контрагент.ЭлементУправления.КнопкаВыбора = Ложь;
КонецПроцедуры

Процедура КонтрагентыПередНачаломДобавления(Элемент, Отказ, Копирование)
	Элемент.Колонки.Контрагент.ЭлементУправления.КнопкаВыбора = Истина;
КонецПроцедуры


процедура Флаги(уст=0)
	для каждого стр1 из Контрагенты цикл
		стр1.Флаг = (уст=1);
	КонецЦикла;	
КонецПроцедуры	

Процедура КоманднаяПанель1Установить(Кнопка)
	Флаги(1);
КонецПроцедуры

Процедура КоманднаяПанель1Убрать(Кнопка)
	Флаги(0);
КонецПроцедуры

Процедура КоманднаяПанель1Действие2(Кнопка)
	ОбновитьСписок()
КонецПроцедуры

Процедура КоманднаяПанель1Отправить(Кнопка)
	
	СписокАдресов = "";
	для каждого стр1 из Адреса цикл
		СписокАдресов = СписокАдресов +стр1.Адрес+";";
	КонецЦикла;

	ТекстСообщения = "";
	для каждого стр1 из Контрагенты цикл
		Если стр1.Флаг тогда
		ТекстСообщения = ТекстСообщения +строка(стр1.Контрагент.Код)+ ") "+СокрЛП(стр1.Контрагент)+" - "+стр1.Контрагент.НаименованиеПолное+"
		|";
		КонецЕсли;
	КонецЦикла;	

	ОповеститьМенеджеров(СписокАдресов, ТекстСообщения);
	
КонецПроцедуры

Процедура АдресаМенеджерПриИзменении(Элемент)
	текСтр = ЭлементыФормы.Адреса.ТекущиеДанные;
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	КонтактнаяИнформация.Представление
	|ИЗ
	|	РегистрСведений.КонтактнаяИнформация КАК КонтактнаяИнформация
	|ГДЕ
	|	КонтактнаяИнформация.Объект = &Объект
	|	И КонтактнаяИнформация.Тип = &Тип
	|	И КонтактнаяИнформация.Вид = &Вид";
	
	Запрос.УстановитьПараметр("Объект", текСтр.Менеджер);
	Запрос.УстановитьПараметр("Тип", перечисления.ТипыКонтактнойИнформации.АдресЭлектроннойПочты);
	Запрос.УстановитьПараметр("Вид", справочники.ВидыКонтактнойИнформации.СлужебныйАдресЭлектроннойПочтыПользователя);
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	Если Выборка.Следующий() тогда
		текСтр.Адрес = Выборка.Представление;
	Иначе
		текСтр.Адрес ="";
	КонецЕсли;
	
КонецПроцедуры

Категория =Справочники.КатегорииОбъектов.НайтиПоКоду("00035");	
	