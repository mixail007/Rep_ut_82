

Процедура ПриОткрытии()
	Если НЕ РОЛЬДОСТУПНА("ПолныеПрава") тогда
		Предупреждение("           Это служебная обработка!
						|Вы не имеете права пользоваться этой обработкой!", 60);
		возврат;
	КонецЕсли;
	
	Флажок4 = истина;
	ПолеВвода3 = перечисления.СтатусыСтрокЗаказа.Подтвержден;
	
	Флажок5 = истина;
	ДатаЗадачиНач = НачалоДня(ТекущаяДата());
	ДатаЗадачиКон = КонецДня(ТекущаяДата());
	
КонецПроцедуры

Процедура ОсновныеДействияФормыПолучить(Кнопка)
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
				   |	Истина как Флаг,
	               |	ЗадачиПользователя.Ссылка КАК Задача,
				   |	ЗадачиПользователя.Ссылка.Исполнитель как Исполнитель,
				   |	ЗадачиПользователя.Ссылка.Инициатор как Инициатор
	               |ИЗ
	               |	Задача.ЗадачиПользователя КАК ЗадачиПользователя
	               |ГДЕ
				   |	ЗадачиПользователя.НаСогласование
				   |
	               |"+?(ПолеВвода1.Пустая(),""," И ЗадачиПользователя.Исполнитель = &Исполнитель")+"
	               |"+?(Флажок4,"	И НЕ ЗадачиПользователя.Выполнена","")+"
				   |"+?(Флажок5,"	И ЗадачиПользователя.Дата>=&ДатаНач И ЗадачиПользователя.Дата<=&ДатаКон","")+"
	               |";
	
	Запрос.УстановитьПараметр("Исполнитель", ПолеВвода1);
	Запрос.УстановитьПараметр("ДатаНач", ДатаЗадачиНач);
	Запрос.УстановитьПараметр("ДатаКон", ДатаЗадачиКон);
	
	Результат = Запрос.Выполнить();
	
	ТабличноеПоле1.Очистить();
	ТабличноеПоле1 = Результат.Выгрузить();

КонецПроцедуры
	
Процедура КнопкаВыполнитьНажатие(Кнопка)
	
	Если Вопрос("Вы уверены, что хотите выполнить выбранные действия
				|для списка из "+строка(ТабличноеПоле1.Количество())+" задач?", РежимДиалогаВопрос.ДаНет, 0) 
			<> КодВозвратаДиалога.Да тогда
			возврат;
	КонецЕсли;		

	для каждого выборка из ТабличноеПоле1 Цикл
		Если не выборка.флаг тогда
			продолжить; 
	  	КонецЕсли;
	  задОб = выборка.Задача.ПолучитьОбъект();
	  
	  //--------1 ---------------------------------------
	  Если флажок1 тогда
	  	задОб.Исполнитель = ПолеВвода2;
	  КонецЕсли;
	
	  //--------2 ---------------------------------------
	  Если флажок2 тогда
		  для каждого стр1 из задОб.Товары цикл
			  стр1.Статус = ПолеВвода3;//  перечисления.СтатусыСтрокЗаказа.Подтвержден;
		  КонецЦикла;
		  задОб.Выполнена = Истина;
		  задОб.ДатаИсполнения = ТекущаяДата();
		  
		//{  --------- изменение ТЧТовары в Заказе покупателя -------------
		Если задОб.Товары.Количество()>0 
			и ЗначениеЗаполнено(задОб.Объект) тогда
			
			Если ТипЗнч(задОб.Объект)=Тип("ДокументСсылка.ЗаказПокупателя") тогда
				задОб.ИзменитьЦеныВЗаказеПокупателяПриСогласовании();
			ИначеЕсли ТипЗнч(задОб.Объект)=Тип("СправочникСсылка.Контрагенты") тогда
				задОб.ИзменитьПравилаПокупателяПриСогласовании();
			КонецЕсли;
			
			задОб.ИзменитьНазваниеЗадачиИОписаниеПриСогласовании();
		
		КонецЕсли;
		//}

	  КонецЕсли;
	  
		  //--------3 ---------------------------------------
	  Если Флажок3 тогда
		  задОб.Выполнена = истина; // флаг выполнена
		  задОб.Оповещение= ложь;   // никому больше напоминаний не надо!
		  задОб.ДатаИсполнения = ТекущаяДата();
		   задОб.Описание = "# Задача ""выключена"" "+?(флажок2, "", "без каких-либо согласований!")+" #
		   |"+задОб.Описание;
	  КонецЕсли;
	  
	  Если Флажок6 тогда
		  задОб.ПометкаУдаления = Истина;
	  КонецЕсли;	 
	  
	  Если флажок1 или флажок2 или флажок3 или Флажок6 тогда
		  попытка 
			  задОб.Записать();
			  сообщить("Изменена задача "+строка(задОб.ссылка));
		  исключение
			  сообщить("Ошибка при записи задачи "+строка(задОб.ссылка)+" : "+ОписаниеОшибки());
			  нетОшибки = ложь;
		  КонецПопытки;	
	  КонецЕсли;
	  
	КонецЦикла;
	
КонецПроцедуры

Процедура Флажок1ПриИзменении(Элемент)
	ЭлементыФормы.Флажок1.Шрифт = новый Шрифт(ЭлементыФормы.Флажок1.Шрифт ,,, Флажок1);
	ЭлементыФормы.ПолеВвода2.Доступность = Флажок1;
КонецПроцедуры

Процедура Флажок2ПриИзменении(Элемент)
	ЭлементыФормы.Флажок2.Шрифт = новый Шрифт(ЭлементыФормы.Флажок2.Шрифт ,,, Флажок2);
КонецПроцедуры

Процедура Флажок3ПриИзменении(Элемент)
	ЭлементыФормы.Флажок3.Шрифт = новый Шрифт(ЭлементыФормы.Флажок3.Шрифт ,,, Флажок3);
КонецПроцедуры

Процедура ВыбПериодНажатие(Элемент)
	НастройкаПериода = Новый НастройкаПериода;
	НастройкаПериода.РедактироватьКакИнтервал = Истина;
	НастройкаПериода.РедактироватьКакПериод = Истина;
	НастройкаПериода.ВариантНастройки = ВариантНастройкиПериода.Период;
	НастройкаПериода.УстановитьПериод(ДатаЗадачиНач, ?(ДатаЗадачиКон='0001-01-01', ДатаЗадачиКон, КонецДня(ДатаЗадачиКон)));
	Если НастройкаПериода.Редактировать() Тогда
		ДатаЗадачиНач = НастройкаПериода.ПолучитьДатуНачала();
		ДатаЗадачиКон = КонецДня(НастройкаПериода.ПолучитьДатуОкончания());
	КонецЕсли;
КонецПроцедуры

Процедура КоманднаяПанель2Действие9(Кнопка)
	флаги(1);
КонецПроцедуры

Процедура КоманднаяПанель2Действие10(Кнопка)
	флаги(0);
КонецПроцедуры

Процедура КоманднаяПанель2Действие11(Кнопка)
	флаги(2);
КонецПроцедуры

процедура флаги(ном)
	Для Каждого стр1 из ТабличноеПоле1 Цикл
		стр1.Флаг = ?(ном=1,Истина, ?(ном=0,ЛОЖЬ, не стр1.Флаг) );
	КонецЦикла;		
КонецПроцедуры
