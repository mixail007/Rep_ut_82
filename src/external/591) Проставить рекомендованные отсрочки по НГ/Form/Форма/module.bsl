
Процедура КнопкаВыполнитьНажатие(Кнопка)
	Если глТекущийПользователь = НоменклатурнаяГруппа.Ответственный или не ЗначениеЗаполнено(НоменклатурнаяГруппа)  тогда
		Для каждого стр из ТабличноеПоле1 цикл
			Если ЗначениеЗаполнено(стр.ДатаОплаты) или ЗначениеЗаполнено(стр.ДнейОтсрочки) тогда
				МенеджерЗаписи = РегистрыСведений.РекомендованыеДатыОтсрочкиПоНоменклатурнымГруппам.СоздатьМенеджерЗаписи();
				МенеджерЗаписи.ВидТовара  = ВидТовара;
				МенеджерЗаписи.НоменклатурнаяГруппа = НоменклатурнаяГруппа;
				МенеджерЗаписи.Производитель = Производитель;
				МенеджерЗаписи.Месяц = стр.Месяц;
				МенеджерЗаписи.ДатаОплаты = стр.ДатаОплаты;
				МенеджерЗаписи.ДнейОтсрочки = стр.ДнейОтсрочки;
				МенеджерЗаписи.Записать(истина);
			конецесли;
		КонецЦикла;
	Иначе
		Если ЗначениеЗаполнено(НоменклатурнаяГруппа) тогда
			Сообщить("Ответственный за НГ "+НоменклатурнаяГруппа+" - "+НоменклатурнаяГруппа.Ответственный);
			Сообщить("Отсрочки не проставлены");
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры

Процедура ВыбПериодНажатие(Элемент)
	НастройкаПериода = Новый НастройкаПериода;
	НастройкаПериода.РедактироватьКакИнтервал = Истина;
	НастройкаПериода.РедактироватьКакПериод = Истина;
	НастройкаПериода.ВариантНастройки = ВариантНастройкиПериода.Период;
	НастройкаПериода.УстановитьПериод(НачПериода, ?(КонПериода='0001-01-01', КонПериода, КонецДня(КонПериода)));
	Если НастройкаПериода.Редактировать() Тогда
		НачПериода = НастройкаПериода.ПолучитьДатуНачала();
		КонПериода = НастройкаПериода.ПолучитьДатуОкончания();
	КонецЕсли;
КонецПроцедуры

Процедура ВидТовараПриИзменении(Элемент)
	ОбновитьТаб();
КонецПроцедуры

Процедура ОбновитьТаб()
	Если не ЗначениеЗаполнено(ВидТовара) тогда
		Сообщить("Не выбран вид товара");
		возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
Запрос.УстановитьПараметр("ДатаН",?(ЗначениеЗаполнено((НачПериода)),НачалоМесяца(НачПериода),НачалоГода(ТекущаяДата())));
Запрос.УстановитьПараметр("ДатаК",?(ЗначениеЗаполнено((КонПериода)),КонецМесяца(КонПериода),КонецГода(ТекущаяДата())));
Запрос.УстановитьПараметр("ВидТовара",ВидТовара);
Запрос.УстановитьПараметр("Производитель",Производитель);
Запрос.УстановитьПараметр("НоменклатурнаяГруппа",НоменклатурнаяГруппа);

Запрос.Текст="ВЫБРАТЬ
             |	РекомендованыеДатыОтсрочкиПоНоменклатурнымГруппам.Месяц КАК Месяц,
             |	РекомендованыеДатыОтсрочкиПоНоменклатурнымГруппам.ДатаОплаты,
             |	РекомендованыеДатыОтсрочкиПоНоменклатурнымГруппам.ДнейОтсрочки
             |ИЗ
             |	РегистрСведений.РекомендованыеДатыОтсрочкиПоНоменклатурнымГруппам КАК РекомендованыеДатыОтсрочкиПоНоменклатурнымГруппам
             |ГДЕ
             |	РекомендованыеДатыОтсрочкиПоНоменклатурнымГруппам.Месяц МЕЖДУ &ДатаН И &ДатаК
             |	И РекомендованыеДатыОтсрочкиПоНоменклатурнымГруппам.ВидТовара = &ВидТовара
             |	И РекомендованыеДатыОтсрочкиПоНоменклатурнымГруппам.Производитель = &Производитель
             |	И РекомендованыеДатыОтсрочкиПоНоменклатурнымГруппам.НоменклатурнаяГруппа = &НоменклатурнаяГруппа
             |
             |УПОРЯДОЧИТЬ ПО
             |	Месяц
             |АВТОУПОРЯДОЧИВАНИЕ";
			 Рез=Запрос.Выполнить().Выгрузить();
			 
			 ДатаНач = НачалоМесяца(НачПериода);
			 ДатаКон = НачалоМесяца(КонПериода);
			 
			 Пока ДатаНач<=ДатаКон цикл
				 Если Рез.Найти(ДатаНач,"Месяц")=неопределено тогда
					 нстр = Рез.Добавить();
					 нстр.Месяц = ДатаНач;
				 КонецЕсли;
				 ДатаНач = добавитьМесяц(ДатаНач,1);
			 КонецЦикла;
             Рез.Сортировать("Месяц");
			 
			 ТабличноеПоле1.Очистить();
			 ТабличноеПоле1=Рез;
КонецПроцедуры

Процедура НачПериодаПриИзменении(Элемент)
	ОбновитьТаб();
КонецПроцедуры

Процедура КонПериодаПриИзменении(Элемент)
	ОбновитьТаб();
КонецПроцедуры

Процедура ПроизводительПриИзменении(Элемент)
	ОбновитьТаб();
КонецПроцедуры

Процедура НоменклатурнаяГруппаПриИзменении(Элемент)
	ОбновитьТаб();
КонецПроцедуры

Процедура Панель1ПриСменеСтраницы(Элемент, ТекущаяСтраница)
	Запрос = Новый Запрос;
	Запрос.Текст="ВЫБРАТЬ
	             |	РекомендованыеДатыОтсрочкиПоНоменклатурнымГруппам.Месяц КАК Месяц,
	             |	РекомендованыеДатыОтсрочкиПоНоменклатурнымГруппам.ВидТовара КАК ВидТовара,
	             |	РекомендованыеДатыОтсрочкиПоНоменклатурнымГруппам.Производитель КАК Производитель,
	             |	РекомендованыеДатыОтсрочкиПоНоменклатурнымГруппам.НоменклатурнаяГруппа КАК НоменклатурнаяГруппа,
	             |	РекомендованыеДатыОтсрочкиПоНоменклатурнымГруппам.ДатаОплаты,
	             |	РекомендованыеДатыОтсрочкиПоНоменклатурнымГруппам.ДнейОтсрочки
	             |ИЗ
	             |	РегистрСведений.РекомендованыеДатыОтсрочкиПоНоменклатурнымГруппам КАК РекомендованыеДатыОтсрочкиПоНоменклатурнымГруппам
	             |ГДЕ
	             |	РекомендованыеДатыОтсрочкиПоНоменклатурнымГруппам.Месяц МЕЖДУ &ДатаН И &ДатаК
	             |	//ОтборВидТовара И РекомендованыеДатыОтсрочкиПоНоменклатурнымГруппам.ВидТовара = &ВидТовара
	             |	//ОтборПроизводитель И РекомендованыеДатыОтсрочкиПоНоменклатурнымГруппам.Производитель = &Производитель
	             |	//ОтборНГ И РекомендованыеДатыОтсрочкиПоНоменклатурнымГруппам.НоменклатурнаяГруппа = &НоменклатурнаяГруппа
	             |
	             |УПОРЯДОЧИТЬ ПО
	             |	Месяц,
	             |	ВидТовара,
	             |	Производитель,
	             |	НоменклатурнаяГруппа
	             |АВТОУПОРЯДОЧИВАНИЕ";
				 
				 Если ЗначениеЗаполнено(ВидТовара) тогда
					 Запрос.Текст = СтрЗаменить(Запрос.Текст,"//ОтборВидТовара","");
				 КонецЕсли;
				 Если ЗначениеЗаполнено(Производитель) тогда
					 Запрос.Текст = СтрЗаменить(Запрос.Текст,"//ОтборПроизводитель","");
				 КонецЕсли;
				 Если ЗначениеЗаполнено(НоменклатурнаяГруппа) тогда
					 Запрос.Текст = СтрЗаменить(Запрос.Текст,"//ОтборНГ","");
				 КонецЕсли;
				 
				 Запрос.УстановитьПараметр("ВидТовара",ВидТовара);
				 Запрос.УстановитьПараметр("Производитель",Производитель);
				 Запрос.УстановитьПараметр("НоменклатурнаяГруппа",НоменклатурнаяГруппа);
				 Запрос.УстановитьПараметр("ДатаН",?(ЗначениеЗаполнено((НачПериода)),НачалоМесяца(НачПериода),Дата("20000101")));
				 Запрос.УстановитьПараметр("ДатаК",?(ЗначениеЗаполнено((КонПериода)),КонецМесяца(КонПериода),Дата("30000101")));

				 ТабОтсрочек = Запрос.Выполнить().Выгрузить();
				 ЭлементыФормы.ТабОтсрочек.СоздатьКолонки();
КонецПроцедуры
