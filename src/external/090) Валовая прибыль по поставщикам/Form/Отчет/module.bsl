
Процедура ДействияФормыОтчетСформировать(Кнопка)
	//{{КОНСТРУКТОР_ВЫХОДНЫХ_ФОРМ_ПРОЦЕДУРА_ВЫЗОВА(Отчет)
	// Данный фрагмент построен конструктором.
	// При повторном использовании конструктора, внесенные вручную изменения будут утеряны!!!

	ТабДок = ЭлементыФормы.ПолеТабличногоДокумента;
	Отчет(ТабДок);

	//}}КОНСТРУКТОР_ВЫХОДНЫХ_ФОРМ_ПРОЦЕДУРА_ВЫЗОВА
КонецПроцедуры

Процедура Отчет(ТабДок) Экспорт
	
	Макет = ПолучитьМакет("Отчет");
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ВложенныйЗапрос.Поставщик,
	|	ВложенныйЗапрос.Номенклатура,
	|	ВложенныйЗапрос.ДокументОприходования,
	|	ВложенныйЗапрос.Количество,
	|	ВложенныйЗапрос.Стоимость,
	|	ВложенныйЗапрос.ВаловаяПрибыль
	|ПОМЕСТИТЬ ВТ_Базовая
	|ИЗ
	|	(ВЫБРАТЬ
	|		ВложенныйЗапрос.Подразделение КАК Подразделение,
	|		ВложенныйЗапрос.ДокументОприходования.Контрагент КАК Поставщик,
	|		ВложенныйЗапрос.Покупатель КАК Покупатель,
	|		ВложенныйЗапрос.ДоговорПокупателя КАК ДоговорПокупателя,
	|		ВложенныйЗапрос.Номенклатура КАК Номенклатура,
	|		ВложенныйЗапрос.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
	|		ВложенныйЗапрос.ЗаказПокупателя КАК ЗаказПокупателя,
	|		ВложенныйЗапрос.ДокументПродажи КАК ДокументПродажи,
	|		ВложенныйЗапрос.ДокументОприходования КАК ДокументОприходования,
	|		ВложенныйЗапрос.Регистратор КАК Регистратор,
	|		ВложенныйЗапрос.Период КАК Период,
	|		СУММА(ВложенныйЗапрос.Количество) КАК Количество,
	|		СУММА(ВложенныйЗапрос.КоличествоЕдиницОтчетов) КАК КоличествоЕдиницОтчетов,
	|		СУММА(ВложенныйЗапрос.КоличествоБазовыхЕдиниц) КАК КоличествоБазовыхЕдиниц,
	|		СУММА(ВЫБОР
	|				КОГДА ВложенныйЗапрос.КоличествоПродажи = 0
	|					ТОГДА ВложенныйЗапрос.Стоимость
	|				ИНАЧЕ ВложенныйЗапрос.Стоимость * ВложенныйЗапрос.Количество / ВложенныйЗапрос.КоличествоПродажи
	|			КОНЕЦ) КАК Стоимость,
	|		СУММА(ВложенныйЗапрос.Себестоимость) КАК Себестоимость,
	|		СУММА(ВЫБОР
	|				КОГДА ВложенныйЗапрос.КоличествоПродажи = 0
	|					ТОГДА ВложенныйЗапрос.Стоимость
	|				ИНАЧЕ ВложенныйЗапрос.Стоимость * ВложенныйЗапрос.Количество / ВложенныйЗапрос.КоличествоПродажи
	|			КОНЕЦ) - СУММА(ВложенныйЗапрос.Себестоимость) КАК ВаловаяПрибыль
	|	ИЗ
	|		(ВЫБРАТЬ
	|			ПродажиОбороты.Подразделение КАК Подразделение,
	|			ПродажиОбороты.ДоговорКонтрагента.Владелец КАК Покупатель,
	|			ПродажиОбороты.ДоговорКонтрагента КАК ДоговорПокупателя,
	|			ПродажиОбороты.Номенклатура КАК Номенклатура,
	|			ПродажиОбороты.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
	|			ПродажиОбороты.ЗаказПокупателя КАК ЗаказПокупателя,
	|			ПродажиОбороты.ДокументПродажи КАК ДокументПродажи,
	|			ТаблицаРегистраПродажиСебестоимость.ДокументОприходования КАК ДокументОприходования,
	|			ПродажиОбороты.Регистратор КАК Регистратор,
	|			ПродажиОбороты.Период КАК Период,
	|			ПродажиОбороты.КоличествоОборот КАК КоличествоПродажи,
	|			ТаблицаРегистраПродажиСебестоимость.Количество КАК Количество,
	|			ТаблицаРегистраПродажиСебестоимость.Количество * ЕСТЬNULL(ПродажиОбороты.Номенклатура.ЕдиницаХраненияОстатков.Коэффициент, 1) / ЕСТЬNULL(ПродажиОбороты.Номенклатура.ЕдиницаДляОтчетов.Коэффициент, 1) КАК КоличествоЕдиницОтчетов,
	|			ТаблицаРегистраПродажиСебестоимость.Количество * ЕСТЬNULL(ПродажиОбороты.Номенклатура.ЕдиницаХраненияОстатков.Коэффициент, 1) КАК КоличествоБазовыхЕдиниц,
	|			ПродажиОбороты.СтоимостьОборот КАК Стоимость,
	|			ТаблицаРегистраПродажиСебестоимость.СтоимостьОборот КАК Себестоимость
	|		ИЗ
	|			РегистрНакопления.Продажи.Обороты(&ДатаНач, &ДатаКон, Регистратор, НЕ Номенклатура.Услуга) КАК ПродажиОбороты
	|				ВНУТРЕННЕЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|					ПродажиСебестоимость.Номенклатура КАК Номенклатура,
	|					ПродажиСебестоимость.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
	|					ПродажиСебестоимость.ЗаказПокупателя КАК ЗаказПокупателя,
	|					ПродажиСебестоимость.ДокументОприходования КАК ДокументОприходования,
	|					ВЫБОР
	|						КОГДА ПродажиСебестоимость.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|							ТОГДА ПродажиСебестоимость.ДокументДвижения
	|						ИНАЧЕ ПродажиСебестоимость.Регистратор
	|					КОНЕЦ КАК Регистратор,
	|					СУММА(ПродажиСебестоимость.Количество) КАК Количество,
	|					СУММА(ПродажиСебестоимость.Стоимость) КАК СтоимостьОборот
	|				ИЗ
	|					РегистрНакопления.ПродажиСебестоимость КАК ПродажиСебестоимость
	|				ГДЕ
	|					ПродажиСебестоимость.Период МЕЖДУ &ДатаНач И &ДатаКон //И НЕ Номенклатура.Услуга
	|				
	|				СГРУППИРОВАТЬ ПО
	|					ПродажиСебестоимость.Номенклатура,
	|					ПродажиСебестоимость.ХарактеристикаНоменклатуры,
	|					ПродажиСебестоимость.ЗаказПокупателя,
	|					ПродажиСебестоимость.ДокументОприходования,
	|					ВЫБОР
	|						КОГДА ПродажиСебестоимость.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|							ТОГДА ПродажиСебестоимость.ДокументДвижения
	|						ИНАЧЕ ПродажиСебестоимость.Регистратор
	|					КОНЕЦ) КАК ТаблицаРегистраПродажиСебестоимость
	|				ПО (ТаблицаРегистраПродажиСебестоимость.Номенклатура = ПродажиОбороты.Номенклатура)
	|					И (ТаблицаРегистраПродажиСебестоимость.ХарактеристикаНоменклатуры = ПродажиОбороты.ХарактеристикаНоменклатуры)
	|					И (ТаблицаРегистраПродажиСебестоимость.ЗаказПокупателя = ПродажиОбороты.ЗаказПокупателя)
	|					И (ТаблицаРегистраПродажиСебестоимость.Регистратор = ПродажиОбороты.Регистратор)
	|		
	|		ОБЪЕДИНИТЬ ВСЕ
	|		
	|		ВЫБРАТЬ
	|			ПродажиОбороты.Подразделение,
	|			ПродажиОбороты.ДоговорКонтрагента.Владелец,
	|			ПродажиОбороты.ДоговорКонтрагента,
	|			ПродажиОбороты.Номенклатура,
	|			ПродажиОбороты.ХарактеристикаНоменклатуры,
	|			ПродажиОбороты.ЗаказПокупателя,
	|			ПродажиОбороты.ДокументПродажи,
	|			НЕОПРЕДЕЛЕНО,
	|			ПродажиОбороты.Регистратор,
	|			ПродажиОбороты.Период,
	|			ПродажиОбороты.КоличествоОборот,
	|			ПродажиОбороты.КоличествоОборот - ЕСТЬNULL(ТаблицаРегистраПродажиСебестоимость.Количество, 0),
	|			(ПродажиОбороты.КоличествоОборот - ЕСТЬNULL(ТаблицаРегистраПродажиСебестоимость.Количество, 0)) * ЕСТЬNULL(ПродажиОбороты.Номенклатура.ЕдиницаХраненияОстатков.Коэффициент, 1) / ЕСТЬNULL(ПродажиОбороты.Номенклатура.ЕдиницаДляОтчетов.Коэффициент, 1),
	|			(ПродажиОбороты.КоличествоОборот - ЕСТЬNULL(ТаблицаРегистраПродажиСебестоимость.Количество, 0)) * ЕСТЬNULL(ПродажиОбороты.Номенклатура.ЕдиницаХраненияОстатков.Коэффициент, 1),
	|			ПродажиОбороты.СтоимостьОборот,
	|			0
	|		ИЗ
	|			РегистрНакопления.Продажи.Обороты(&ДатаНач, &ДатаКон, Регистратор, НЕ Номенклатура.Услуга) КАК ПродажиОбороты
	|				ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|					ПродажиСебестоимость.Номенклатура КАК Номенклатура,
	|					ПродажиСебестоимость.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
	|					ПродажиСебестоимость.ЗаказПокупателя КАК ЗаказПокупателя,
	|					ВЫБОР
	|						КОГДА ПродажиСебестоимость.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|							ТОГДА ПродажиСебестоимость.ДокументДвижения
	|						ИНАЧЕ ПродажиСебестоимость.Регистратор
	|					КОНЕЦ КАК Регистратор,
	|					СУММА(ПродажиСебестоимость.Количество) КАК Количество,
	|					СУММА(ПродажиСебестоимость.Стоимость) КАК СтоимостьОборот
	|				ИЗ
	|					РегистрНакопления.ПродажиСебестоимость КАК ПродажиСебестоимость
	|				ГДЕ
	|					ПродажиСебестоимость.Период МЕЖДУ &ДатаНач И &ДатаКон // И НЕ Номенклатура.Услуга
	|				
	|				СГРУППИРОВАТЬ ПО
	|					ПродажиСебестоимость.Номенклатура,
	|					ПродажиСебестоимость.ХарактеристикаНоменклатуры,
	|					ПродажиСебестоимость.ЗаказПокупателя,
	|					ВЫБОР
	|						КОГДА ПродажиСебестоимость.ДокументДвижения <> НЕОПРЕДЕЛЕНО
	|							ТОГДА ПродажиСебестоимость.ДокументДвижения
	|						ИНАЧЕ ПродажиСебестоимость.Регистратор
	|					КОНЕЦ) КАК ТаблицаРегистраПродажиСебестоимость
	|				ПО (ТаблицаРегистраПродажиСебестоимость.Номенклатура = ПродажиОбороты.Номенклатура)
	|					И (ТаблицаРегистраПродажиСебестоимость.ХарактеристикаНоменклатуры = ПродажиОбороты.ХарактеристикаНоменклатуры)
	|					И (ТаблицаРегистраПродажиСебестоимость.ЗаказПокупателя = ПродажиОбороты.ЗаказПокупателя)
	|					И (ТаблицаРегистраПродажиСебестоимость.Регистратор = ПродажиОбороты.Регистратор)) КАК ВложенныйЗапрос
	|	
	|	СГРУППИРОВАТЬ ПО
	|		ВложенныйЗапрос.Подразделение,
	|		ВложенныйЗапрос.ДокументОприходования.Контрагент,
	|		ВложенныйЗапрос.Покупатель,
	|		ВложенныйЗапрос.ДоговорПокупателя,
	|		ВложенныйЗапрос.Номенклатура,
	|		ВложенныйЗапрос.ХарактеристикаНоменклатуры,
	|		ВложенныйЗапрос.ЗаказПокупателя,
	|		ВложенныйЗапрос.ДокументПродажи,
	|		ВложенныйЗапрос.ДокументОприходования,
	|		ВложенныйЗапрос.Регистратор,
	|		ВложенныйЗапрос.Период
	|	
	|	ИМЕЮЩИЕ
	|		(СУММА(ВложенныйЗапрос.Количество) <> 0
	|			ИЛИ СУММА(ВложенныйЗапрос.Себестоимость) <> 0
	|			ИЛИ СУММА(ВЫБОР
	|					КОГДА ВложенныйЗапрос.КоличествоПродажи = 0
	|						ТОГДА ВложенныйЗапрос.Стоимость
	|					ИНАЧЕ ВложенныйЗапрос.Стоимость * ВложенныйЗапрос.Количество / ВложенныйЗапрос.КоличествоПродажи
	|				КОНЕЦ) <> 0)) КАК ВложенныйЗапрос
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_Базовая.Поставщик,
	|	ВТ_Базовая.Номенклатура,
	|	ВТ_Базовая.ДокументОприходования,
	|	ВТ_Базовая.Количество,
	|	ВТ_Базовая.Стоимость,
	|	ВТ_Базовая.ВаловаяПрибыль
	|ПОМЕСТИТЬ ВТ_1
	|ИЗ
	|	ВТ_Базовая КАК ВТ_Базовая
	|ГДЕ
	|	ВТ_Базовая.ДокументОприходования ССЫЛКА Документ.КомплектацияНоменклатуры
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПартииТоваровНаСкладах.Регистратор,
	|	ПартииТоваровНаСкладах.ДокументОприходования.Контрагент КАК Поставщик
	|ПОМЕСТИТЬ ВТ_2
	|ИЗ
	|	РегистрНакопления.ПартииТоваровНаСкладах КАК ПартииТоваровНаСкладах
	|ГДЕ
	|	ПартииТоваровНаСкладах.Период МЕЖДУ &ДатаНачПартии И &ДатаКон
	|	И ПартииТоваровНаСкладах.ВидДвижения = &Расход
	|	И ПартииТоваровНаСкладах.Регистратор В
	|			(ВЫБРАТЬ РАЗЛИЧНЫЕ
	|				ВТ_1.ДокументОприходования
	|			ИЗ
	|				ВТ_1)
	|	И (ПартииТоваровНаСкладах.Номенклатура.ВидТовара = ЗНАЧЕНИЕ(Перечисление.ВидыТоваров.Шины)
	|			ИЛИ ПартииТоваровНаСкладах.Номенклатура.ВидТовара = ЗНАЧЕНИЕ(Перечисление.ВидыТоваров.Диски))
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_2.Поставщик КАК Поставщик,
	|	ВТ_1.Номенклатура,
	|	ВТ_1.ДокументОприходования,
	|	ВТ_1.Количество,
	|	ВТ_1.Стоимость,
	|	ВТ_1.ВаловаяПрибыль
	|ПОМЕСТИТЬ ВТ_ГотоваяПродукция
	|ИЗ
	|	ВТ_1 КАК ВТ_1
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_2 КАК ВТ_2
	|		ПО ВТ_1.ДокументОприходования = ВТ_2.Регистратор
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Общая.Поставщик,
	|	СУММА(Общая.Количество) КАК Количество,
	|	СУММА(Общая.Стоимость) КАК Стоимость,
	|	СУММА(Общая.ВаловаяПрибыль) КАК ВаловаяПрибыль
	|ПОМЕСТИТЬ ВТ_Результат
	|ИЗ
	|	(ВЫБРАТЬ
	|		ВТ_Базовая.Поставщик КАК Поставщик,
	|		ВТ_Базовая.Номенклатура КАК Номенклатура,
	|		ВТ_Базовая.ДокументОприходования КАК ДокументОприходования,
	|		ВТ_Базовая.Количество КАК Количество,
	|		ВТ_Базовая.Стоимость КАК Стоимость,
	|		ВТ_Базовая.ВаловаяПрибыль КАК ВаловаяПрибыль
	|	ИЗ
	|		ВТ_Базовая КАК ВТ_Базовая
	|	ГДЕ
	|		(НЕ ВТ_Базовая.ДокументОприходования ССЫЛКА Документ.КомплектацияНоменклатуры)
	|	
	|	ОБЪЕДИНИТЬ
	|	
	|	ВЫБРАТЬ
	|		ВТ_ГотоваяПродукция.Поставщик,
	|		ВТ_ГотоваяПродукция.Номенклатура,
	|		ВТ_ГотоваяПродукция.ДокументОприходования,
	|		ВТ_ГотоваяПродукция.Количество,
	|		ВТ_ГотоваяПродукция.Стоимость,
	|		ВТ_ГотоваяПродукция.ВаловаяПрибыль
	|	ИЗ
	|		ВТ_ГотоваяПродукция КАК ВТ_ГотоваяПродукция) КАК Общая
	|
	|СГРУППИРОВАТЬ ПО
	|	Общая.Поставщик
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СУММА(ВТ_Результат.Количество) КАК Количество,
	|	СУММА(ВТ_Результат.Стоимость) КАК Стоимость,
	|	СУММА(ВТ_Результат.ВаловаяПрибыль) КАК ВаловаяПрибыль
	|ПОМЕСТИТЬ ВТ_ОбщийРезультат
	|ИЗ
	|	ВТ_Результат КАК ВТ_Результат
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ ПЕРВЫЕ 30
	|	А.Поставщик,
	|	А.Стоимость,
	|	А.ВаловаяПрибыль КАК ВаловаяПрибыль,
	|	А.ДоляВОбороте,
	|	А.ДоляВПрибыли
	|ИЗ
	|	(ВЫБРАТЬ
	|		ВТ_Результат.Поставщик КАК Поставщик,
	|		ВТ_Результат.Количество КАК Количество,
	|		ВТ_Результат.Стоимость КАК Стоимость,
	|		ВТ_Результат.ВаловаяПрибыль КАК ВаловаяПрибыль,
	|		(ВЫРАЗИТЬ(ЕСТЬNULL(ВТ_Результат.Стоимость, 0) / ВТ_ОбщийРезультат.Стоимость КАК ЧИСЛО(15, 2))) * 100 КАК ДоляВОбороте,
	|		(ВЫРАЗИТЬ(ЕСТЬNULL(ВТ_Результат.ВаловаяПрибыль, 0) / ВТ_ОбщийРезультат.ВаловаяПрибыль КАК ЧИСЛО(15, 2))) * 100 КАК ДоляВПрибыли
	|	ИЗ
	|		ВТ_Результат КАК ВТ_Результат
	|			ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ОбщийРезультат КАК ВТ_ОбщийРезультат
	|			ПО (ИСТИНА)) КАК А
	|
	|УПОРЯДОЧИТЬ ПО
	|	ВаловаяПрибыль УБЫВ";

	Запрос.УстановитьПараметр("ДатаНач",НачПериода);
	Запрос.УстановитьПараметр("ДатаКон",КонецДня(КонПериода));
	Запрос.УстановитьПараметр("ДатаНачПартии",ДобавитьМесяц(НачПериода,-8)); // Партии считаются от 8 месяцев 
	Запрос.УстановитьПараметр("Расход",ВидДвиженияНакопления.Расход); 
	
	Результат = Запрос.Выполнить();

	ОбластьЗаголовок = Макет.ПолучитьОбласть("Заголовок");
	ОбластьЗаголовок.Параметры.ПредставлениеПериода= ПредставлениеПериода(НачПериода,КонецДня(КонПериода),"ФП=Истина");
	ОбластьПодвал = Макет.ПолучитьОбласть("Подвал");
	ОбластьШапкаТаблицы = Макет.ПолучитьОбласть("ШапкаТаблицы");
	ОбластьПодвалТаблицы = Макет.ПолучитьОбласть("ПодвалТаблицы");
	ОбластьДетальныхЗаписей = Макет.ПолучитьОбласть("Детали");

	ТабДок.Очистить();
	ТабДок.Вывести(ОбластьЗаголовок);
	ТабДок.Вывести(ОбластьШапкаТаблицы);
	ТабДок.НачатьАвтогруппировкуСтрок();

	ВыборкаДетали = Результат.Выбрать();

	Пока ВыборкаДетали.Следующий() Цикл
		ОбластьДетальныхЗаписей.Параметры.Заполнить(ВыборкаДетали);
		ТабДок.Вывести(ОбластьДетальныхЗаписей, ВыборкаДетали.Уровень());
	КонецЦикла;

	ТабДок.ЗакончитьАвтогруппировкуСтрок();
	ТабДок.Вывести(ОбластьПодвалТаблицы);
	ТабДок.Вывести(ОбластьПодвал);

	//}}КОНСТРУКТОР_ВЫХОДНЫХ_ФОРМ
КонецПроцедуры

Процедура ВыбПериодНажатие(Элемент)
	НастройкаПериода = Новый НастройкаПериода;
	НастройкаПериода.УстановитьПериод(НачПериода, ?(КонПериода='0001-01-01', КонПериода, КонецДня(КонПериода)));
	НастройкаПериода.РедактироватьКакИнтервал = Истина;
	НастройкаПериода.РедактироватьКакПериод = Истина;
	НастройкаПериода.ВариантНастройки = ВариантНастройкиПериода.Период;
	Если НастройкаПериода.Редактировать() Тогда
		НачПериода = НастройкаПериода.ПолучитьДатуНачала();
		КонПериода = НастройкаПериода.ПолучитьДатуОкончания();
	КонецЕсли;
КонецПроцедуры

Процедура ВыбПериодНажатие1(Элемент)
	НастройкаПериода = Новый НастройкаПериода;
	НастройкаПериода.УстановитьПериод(НачПериода, ?(КонПериода='0001-01-01', КонПериода, КонецДня(КонПериода)));
	НастройкаПериода.РедактироватьКакИнтервал = Истина;
	НастройкаПериода.РедактироватьКакПериод = Истина;
	НастройкаПериода.ВариантНастройки = ВариантНастройкиПериода.Период;
	Если НастройкаПериода.Редактировать() Тогда
		НачПериода = НастройкаПериода.ПолучитьДатуНачала();
		КонПериода = НастройкаПериода.ПолучитьДатуОкончания();
	КонецЕсли;
КонецПроцедуры
