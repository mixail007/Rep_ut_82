
Функция Печать() Экспорт
	
    Стоимость=0;
	ДопКолонка = Константы.ДополнительнаяКолонкаПечатныхФормДокументов.Получить();
	Если ДопКолонка = Перечисления.ДополнительнаяКолонкаПечатныхФормДокументов.Артикул Тогда
		ТоварКод = "Артикул";
	Иначе
		ТоварКод = "Код";
	КонецЕсли;

	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ДатаСреза",          СсылкаНаОбъект.Дата);
	Запрос.УстановитьПараметр("СтруктурнаяЕдиница", СсылкаНаОбъект.Склад);
	Запрос.УстановитьПараметр("ТекущийДокумент",    СсылкаНаОбъект);
	Запрос.УстановитьПараметр("ПустойКонтрагент",   Справочники.Контрагенты.ПустаяСсылка());

	Запрос.Текст =
	"ВЫБРАТЬ
	|	Номер,
	|	Дата КАК ДатаДокумента,
	|	Организация,
	|	Организация КАК ЮрФизЛицо,
	|	Организация КАК Поставщик,
	|	Контрагент КАК Контрагент,
	|	Организация КАК Руководители,
	|	АдресДоставки КАК АдресДоставки,
	|	ВЫБОР КОГДА Грузополучатель = &ПустойКонтрагент
	|	      ТОГДА ВЫБОР КОГДА КонтрагентДляПечати = &ПустойКонтрагент
	|               	  ТОГДА Контрагент
	|					  ИНАЧЕ КонтрагентДляПечати КОНЕЦ
	|	      ИНАЧЕ Грузополучатель КОНЕЦ КАК Грузополучатель,
	|	ВЫБОР КОГДА Грузоотправитель = &ПустойКонтрагент
	|	      ТОГДА Организация
	|	      ИНАЧЕ Грузоотправитель КОНЕЦ КАК Грузоотправитель,
	|	БанковскийСчетОрганизации КАК БанковскийСчет,
	|	ВЫБОР КОГДА КонтрагентДляПечати = &ПустойКонтрагент
	|		  ТОГДА Контрагент
	|		  ИНАЧЕ КонтрагентДляПечати КОНЕЦ КАК Покупатель,
	|	ВЫБОР КОГДА КонтрагентДляПечати = &ПустойКонтрагент
	|		  ТОГДА Контрагент
	|		  ИНАЧЕ КонтрагентДляПечати КОНЕЦ КАК Плательщик,
	|	ДоговорКонтрагента.Представление  КАК Основание,
	|	ДоговорКонтрагента.ВедениеВзаиморасчетов КАК ВедениеВзаиморасчетов,
	|	ОтветственныеЛица.ФизическоеЛицо КАК ОтветственноеЛицо,
	|	СуммаДокумента,
	|	НомерДоверенности,
	|	ДатаДоверенности,
	|	ОрганизацияВыдавшаяДоверенность,
	|	ФизЛицоДоверенности
	|ИЗ
	|	Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг,
	|
	|ЛЕВОЕ СОЕДИНЕНИЕ
	|	РегистрСведений.ОтветственныеЛица.СрезПоследних(&ДатаСреза, СтруктурнаяЕдиница = &СтруктурнаяЕдиница) КАК ОтветственныеЛица
	|ПО
	|	ОтветственныеЛица.СтруктурнаяЕдиница = РеализацияТоваровУслуг.Склад
	|
	|ГДЕ
	|	РеализацияТоваровУслуг.Ссылка = &ТекущийДокумент
	|";

	Шапка = Запрос.Выполнить().Выбрать();
	Шапка.Следующий();

	
	ТабДокумент  = Новый ТабличныйДокумент;
	ТабДокумент.ИмяПараметровПечати = "ПАРАМЕТРЫ_ПЕЧАТИ_РеализацияТоваровУслуг_СтраховоеЗаявление";

	Макет = ПолучитьМакет("МакетСтраховогоЗаявления");

	// Выводим общие реквизиты шапки
	СведенияОПоставщике       = СведенияОЮрФизЛице(Шапка.ЮрФизЛицо,        Шапка.ДатаДокумента);	
	СведенияОПокупателе       	  = СведенияОЮрФизЛице(Шапка.Покупатель,       Шапка.ДатаДокумента);
	//СведенияОГрузополучателе  = СведенияОЮрФизЛице(Шапка.Грузополучатель,  Шапка.ДатаДокумента);
	//СведенияОГрузоотправитель = СведенияОЮрФизЛице(Шапка.Грузоотправитель, Шапка.ДатаДокумента);	
	
	ОбластьМакета = Макет.ПолучитьОбласть("Шапка");
	ОбластьПодвал=Макет.ПолучитьОбласть("Подвал");
	
	ОбластьПодвал.Параметры.ДатаДокумента  = Формат(Шапка.ДатаДокумента,"ДФ=dd.MM.yyyy");

		ОбластьМакета.Параметры.ПредставлениеОрганизации = ОписаниеОрганизации(СведенияОПоставщике,"ПолноеНаименование,");
		ОбластьМакета.Параметры.ЮридическийАдрес = ОписаниеОрганизации(СведенияОПоставщике,"ЮридическийАдрес,");
		ОбластьМакета.Параметры.ФактическийАдрес = ОписаниеОрганизации(СведенияОПоставщике,"ФактическийАдрес,");
		ОбластьМакета.Параметры.Телефоны = ОписаниеОрганизации(СведенияОПоставщике,"Телефоны,");
		
	СписокКонтрагентов=Новый СписокЗначений;	
	Перевозчик=Справочники.Контрагенты.ПустаяСсылка();	
	Если НЕ ЗначениеНеЗаполнено(СсылкаНаОбъект.Перевозчик) Тогда
		Запрос = Новый Запрос;
		Запрос.Текст= "ВЫБРАТЬ
		|	Контрагенты.Ссылка  Перевозчик
		|ИЗ
		|	Справочник.Контрагенты КАК Контрагенты
		|	ГДЕ Ссылка.НаименованиеПолное ПОДОБНО &Перевозчик";
		
		Запрос.УстановитьПараметр("Перевозчик","%"+СсылкаНаОбъект.Перевозчик+"%");
		Выборка=Запрос.Выполнить().Выбрать();
		
		Если Выборка.Следующий() Тогда
			Перевозчик=Выборка.Перевозчик;
			СведенияОПеревозчике       = СведенияОЮрФизЛице(Выборка.Перевозчик,Шапка.ДатаДокумента);
			ОбластьМакета.Параметры.ПредставлениеПеревозчика=ОписаниеОрганизации( СведенияОПеревозчике,"ПолноеНаименование,ЮридическийАдрес,ИНН,");
			
		Иначе
			ОбластьМакета.Параметры.ПредставлениеПеревозчика="";
		КонецЕсли;		 
	КонецЕсли;  
			 
	Если Не ЗначениеНеЗаполнено(Перевозчик) И СокрЛП(СсылкаНаОбъект.ГосНомерАвтомобиля)<>"" Тогда 		 
		
		ЗапросНакладные = Новый Запрос;
		ЗапросНакладные.Текст="ВЫБРАТЬ
		|	Номер,
		|	Ссылка,
		|	Контрагент,
		|	СуммаДокумента,
		|	Перевозчик,
		|	ГосНомерАвтомобиля
		|ИЗ
		|	Документ.РеализацияТоваровУслуг 
		|ГДЕ
		|	НАЧАЛОПЕРИОДА(Дата,ДЕНЬ) =&КонДата		
		|	И Перевозчик ПОДОБНО &Перевозчик
		|	И ГосНомерАвтомобиля=&ГосНомерАвтомобиля
		|	И Проведен
		//+++ Шарафутдинов 06.02.2018  чтобы не попадали договоры со звездочкой
		|   И НЕ ДоговорКонтрагента.Наименование ПОДОБНО ""%*%"" ";
		//--- Шарафутдинов 06.02.2018  чтобы не попадали договоры со звездочкой
		
		ЗапросНакладные.УстановитьПараметр("КонДата",НачалоДня(Шапка.ДатаДокумента));		
		ЗапросНакладные.УстановитьПараметр("Перевозчик","%"+СсылкаНаОбъект.Перевозчик+"%");//+++ 
		ЗапросНакладные.УстановитьПараметр("ГосНомерАвтомобиля",СсылкаНаОбъект.ГосНомерАвтомобиля);
		
		РезультатНакладные=ЗапросНакладные.Выполнить();
		ВыборкаНакладные=РезультатНакладные.Выбрать();
		
		Если НЕ РезультатНакладные.Пустой() Тогда
			Стоимость=РезультатНакладные.Выгрузить().Итог("СуммаДокумента");
			ОбластьМакета.Параметры.СтоимостьПрописью = СформироватьСуммуПрописью(Стоимость, Константы.ВалютаУправленческогоУчета.Получить());	
			
			СписокПолучателейГруза=РезультатНакладные.Выгрузить().ВыгрузитьКолонку("Контрагент");
			Для сч=0 по СписокПолучателейГруза.Количество()-1 Цикл
				Если СписокКонтрагентов.НайтиПоЗначению(СписокПолучателейГруза[сч])=Неопределено Тогда
					СписокКонтрагентов.Добавить(СписокПолучателейГруза[сч]);
				ОбластьМакета.Параметры.ПредставлениеПолучателя=Строка(ОбластьМакета.Параметры.ПредставлениеПолучателя)+","+Строка(СписокПолучателейГруза[сч].Наименование);
				КонецЕсли;
			КонецЦикла;	
			
		КонецЕсли;	
		
		
		
		ТабДокумент.Вывести(ОбластьМакета);
		
		
		Пока ВыборкаНакладные.Следующий() Цикл
			ОбластьДанные=Макет.ПолучитьОбласть("Данные");	
			ОбластьДанные.Параметры.ПредставлениеПолучателя=ВыборкаНакладные.Контрагент.НаименованиеПолное ;
			ОбластьДанные.Параметры.Номер=	ВыборкаНакладные.Номер;
			ОбластьДанные.Параметры.ДатаДокумента=Формат(Шапка.ДатаДокумента,"ДФ=dd.MM.yyyy") ;
			ТабДокумент.Вывести(ОбластьДанные);
		КонецЦикла; 
		
	Для сч=0 по СписокКонтрагентов.Количество()-1 Цикл
		
		СведенияОКонтрагенте       = СведенияОЮрФизЛице(СписокКонтрагентов[сч].Значение,Шапка.ДатаДокумента);
		
		АдресДоставикСтрока=ПолучитьАдресДоставки (СписокКонтрагентов[сч].Значение);
		
		ОбластьПодвал.Параметры.МаршрутПеревозки=Строка(ОбластьПодвал.Параметры.МаршрутПеревозки)+Символы.ПС+Строка(сч+1)+"."+?(АдресДоставикСтрока="",ОписаниеОрганизации( СведенияОКонтрагенте,"ПолноеНаименование,ФактическийАдрес,"),ОписаниеОрганизации( СведенияОКонтрагенте,"ПолноеНаименование,")+" "+АдресДоставикСтрока);
	КонецЦикла;	
	
	ОбластьПодвал.Параметры.ПринадлежностьТранспорта=СсылкаНаОбъект.Перевозчик+", "+СокрЛП(СсылкаНаОбъект.МаркаАвтомобиля)+СокрЛП(СсылкаНаОбъект.ГосНомерАвтомобиля);
	
	Для сч=0 по СписокКонтрагентов.Количество()-1 Цикл
		ОбластьПодвал.Параметры.ДатаПрибытия=Строка(ОбластьПодвал.Параметры.ДатаПрибытия)+Символы.ПС+Строка(сч+1)+"."+Строка(СписокКонтрагентов[сч].Значение)+" - "+Формат(КонецДня(Шапка.ДатаДокумента)+1,"ДФ=dd.MM.yyyy");
	КонецЦикла;	

	ОбластьПодвал.Параметры.СтраховаяПремия=ФОрмат(0.00085*Стоимость,"ЧДЦ=2") + "руб.";
	
	ТабДокумент.Вывести(ОбластьПодвал);
		
	Иначе
		ТабДокумент.Вывести(ОбластьМакета);
	КонецЕсли;	
	
			// Зададим параметры макета
	ТабДокумент.ПолеСверху              = 0;
	ТабДокумент.ПолеСлева               = 0;
	ТабДокумент.ПолеСнизу               = 0;
	ТабДокумент.ПолеСправа              = 0;
	ТабДокумент.РазмерКолонтитулаСверху = 0;
	ТабДокумент.РазмерКолонтитулаСнизу  = 0;
	ТабДокумент.АвтоМасштаб             = Истина;
	ТабДокумент.ОриентацияСтраницы      = ОриентацияСтраницы.Портрет;

	Возврат ТабДокумент;
	
КонецФункции // Печать

Функция ПолучитьАдресДоставки(КонтрагентСсылка)
	   Запрос=Новый Запрос;
	   Запрос.Текст="ВЫБРАТЬ
	|КонтактнаяИнформация.Объект,
	|КонтактнаяИнформация.Тип,
	|КонтактнаяИнформация.Вид,
	|КонтактнаяИнформация.Представление Представление
	|ИЗ
	|РегистрСведений.КонтактнаяИнформация КАК КонтактнаяИнформация
	|ГДЕ КонтактнаяИнформация.Объект=&Контрагент И КонтактнаяИнформация.Вид=&АдресДоставки";
	Запрос.УстановитьПараметр("Контрагент",КонтрагентСсылка);
	Запрос.УстановитьПараметр("АдресДоставки",Справочники.ВидыКонтактнойИнформации.НайтиПоКоду("00021"));
	Результат=Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат "";
	Иначе	
		Выборка=Результат.Выбрать();
		Выборка.Следующий();
		Возврат Выборка.Представление;
	КонецЕсли;	
КонецФункции	
