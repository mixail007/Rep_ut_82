
Функция ПолучитьТекстЗапросаПоЗаказуПоставщику()
	
	ТекстЗапроса =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ЗаказыПоставщикамОстатки.Номенклатура КАК Номенклатура,
	|	ЕСТЬNULL(ЗаказПоставщикуТовары.НомерСтроки, 1000) КАК НомерСтроки,
	|	ЗаказыПоставщикамОстатки.КоличествоОстаток КАК КоличествоЗаказано,
	|	ТоварыАдресноеХранениеОбороты.АдресХранения,
	|	ТоварыАдресноеХранениеОбороты.КоличествоПриход,
	|	ЗаказПоставщикуТовары.Номенклатура.Код КАК Код,
	|	ЗаказПоставщикуТовары.Номенклатура.Артикул КАК Артикул
	|ИЗ
	|	РегистрНакопления.ЗаказыПоставщикам.Остатки(, ЗаказПоставщику = &ТекущийДокумент) КАК ЗаказыПоставщикамОстатки
	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			ЗаказПоставщикуТовары.НомерСтроки КАК НомерСтроки,
	|			ЗаказПоставщикуТовары.Номенклатура КАК Номенклатура
	|		ИЗ
	|			Документ.ЗаказПоставщику.Товары КАК ЗаказПоставщикуТовары
	|		ГДЕ
	|			ЗаказПоставщикуТовары.Ссылка = &ТекущийДокумент) КАК ЗаказПоставщикуТовары
	|		ПО ЗаказыПоставщикамОстатки.Номенклатура = ЗаказПоставщикуТовары.Номенклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыАдресноеХранение.Обороты(, , , Склад = &СкладЦЦЛ) КАК ТоварыАдресноеХранениеОбороты
	|		ПО ЗаказыПоставщикамОстатки.Номенклатура = ТоварыАдресноеХранениеОбороты.Номенклатура
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки
	|ИТОГИ
	|	МАКСИМУМ(НомерСтроки),
	|	МАКСИМУМ(КоличествоЗаказано),
	|	МАКСИМУМ(Код),
	|	МАКСИМУМ(Артикул)
	|ПО
	|	Номенклатура";
	
	Возврат ТекстЗапроса;
	
КонецФункции // ПолучитьТекстЗапросаПоЗаказуПоставщику()

Функция ПолучитьТекстЗапросаПоПеремещениюТоваров()
	
	ТекстЗапроса = 
	"ВЫБРАТЬ
	|	ПеремещениеТоваровТовары.Номенклатура КАК Номенклатура,
	|	ПеремещениеТоваровТовары.НомерСтроки КАК НомерСтроки,
	|	ПеремещениеТоваровТовары.Номенклатура.Код КАК Код,
	|	ПеремещениеТоваровТовары.Номенклатура.Артикул КАК Артикул,
	|	ПеремещениеТоваровТовары.Количество КАК КоличествоЗаказано
	|ПОМЕСТИТЬ втТовары
	|ИЗ
	|	Документ.ПеремещениеТоваров.Товары КАК ПеремещениеТоваровТовары
	|ГДЕ
	|	ПеремещениеТоваровТовары.Ссылка = &ТекущийДокумент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	втТовары.Номенклатура КАК Номенклатура,
	|	втТовары.НомерСтроки КАК НомерСтроки,
	|	втТовары.Код КАК Код,
	|	втТовары.Артикул КАК Артикул,
	|	втТовары.КоличествоЗаказано КАК КоличествоЗаказано,
	|	ТоварыАдресноеХранениеОбороты.АдресХранения,
	|	ТоварыАдресноеХранениеОбороты.КоличествоПриход
	|ИЗ
	|	втТовары КАК втТовары
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыАдресноеХранение.Обороты(
	|				,
	|				,
	|				,
	|				Номенклатура В
	|						(ВЫБРАТЬ
	|							втТовары.Номенклатура
	|						ИЗ
	|							втТовары КАК втТовары)
	|					И Склад = &СкладЦЦЛ) КАК ТоварыАдресноеХранениеОбороты
	|		ПО втТовары.Номенклатура = ТоварыАдресноеХранениеОбороты.Номенклатура
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки
	|ИТОГИ
	|	МАКСИМУМ(НомерСтроки),
	|	МАКСИМУМ(Код),
	|	МАКСИМУМ(Артикул),
	|	МАКСИМУМ(КоличествоЗаказано)
	|ПО
	|	Номенклатура";
	
	Возврат ТекстЗапроса;
	
КонецФункции // ПолучитьТекстЗапросаПоПеремещениюТоваров()

Функция ПолучитьДанные()
	
	Запрос = Новый Запрос;
	Если ТипЗнч(СсылкаНаОбъект) = Тип("ДокументСсылка.ЗаказПоставщику") Тогда
		ТекстЗапроса = ПолучитьТекстЗапросаПоЗаказуПоставщику();
	ИначеЕсли ТипЗнч(СсылкаНаОбъект) = Тип("ДокументСсылка.ПеремещениеТоваров") Тогда
		ТекстЗапроса = ПолучитьТекстЗапросаПоПеремещениюТоваров();
	Иначе
		ТекстЗапроса = "";
		Сообщить("Не удалось определить источник данных");
		Возврат Неопределено;
	КонецЕсли;
	
	Запрос.Текст = ТекстЗапроса;
	Запрос.УстановитьПараметр("ТекущийДокумент", СсылкаНаОбъект);
	Запрос.УстановитьПараметр("СкладЦЦЛ"       , Справочники.Склады.НайтиПоКоду("02091"));
	
	Результат = Запрос.Выполнить();
	
	Возврат Результат;
	
КонецФункции // ПолучитьДанные()

Функция Печать() Экспорт
	
	ТабДок = Новый ТабличныйДокумент;
	Макет = ЭтотОбъект.ПолучитьМакет("ЗаказПоставщикуНаЦЦЛ");
	
	// Заголовок
	Обл = Макет.ПолучитьОбласть("Заголовок");
	Если ТипЗнч(СсылкаНаОбъект) = Тип("ДокументСсылка.ЗаказПоставщику") Тогда
		ЗаголовокЛок = "Заказ поставщику";
		ПредставлениеПоставщика = ОписаниеОрганизации(СведенияОЮрФизЛице(СсылкаНаОбъект.Контрагент, СсылкаНаОбъект.Дата), "ИНН,КПП,ПолноеНаименование,ЮридическийАдрес,Телефоны,");
		ПредставлениеПолучателя = ОписаниеОрганизации(СведенияОЮрФизЛице(СсылкаНаОбъект.Организация, СсылкаНаОбъект.Дата), "ИНН,КПП,ПолноеНаименование,ЮридическийАдрес,Телефоны,");
	ИначеЕсли ТипЗнч(СсылкаНаОбъект) = Тип("ДокументСсылка.ПеремещениеТоваров") Тогда
		ЗаголовокЛок = "Перемещение товаров";
		ПредставлениеПоставщика = СсылкаНаОбъект.СкладОтправитель.Наименование;
		ПредставлениеПолучателя = СсылкаНаОбъект.СкладПолучатель.Наименование;
	Иначе
		ЗаголовокЛок = "Не удалось определить источник";
		ПредставлениеПоставщика = "";
		ПредставлениеПолучателя = "";
	КонецЕсли;
	ТекстЗаголовка = СформироватьЗаголовокДокумента(СсылкаНаОбъект, ЗаголовокЛок);
	Обл.Параметры.ТекстЗаголовка = ТекстЗаголовка;
	ШтрихКод = глТорговоеОборудование.ПолучитьШтрихКодПоДокументу(СсылкаНаОбъект);  // 20 или 30 префикс
	попытка
		ОбШтрихКод = Обл.Рисунки.ШК.Объект;
		ОбШтрихКод.Сообщение = ШтрихКод; 
		ОбШтрихКод.ТекстКода = ШтрихКод; 
	исключение
		//нет компоненты 1CBarCode.exe
	КонецПопытки;
	ТабДок.Вывести(Обл);
	
	
	Обл = Макет.ПолучитьОбласть("Поставщик");
	Обл.Параметры.ПоставщикТекст = "Поставщик: ";
	Обл.Параметры.ПредставлениеПоставщика = ПредставлениеПоставщика;
	ТабДок.Вывести(Обл);
	
	Обл = Макет.ПолучитьОбласть("Покупатель");
	Обл.Параметры.ПокупательТекст = "Покупатель: ";
	Обл.Параметры.ПредставлениеПолучателя = ПредставлениеПолучателя;
	ТабДок.Вывести(Обл);
	
	Обл = Макет.ПолучитьОбласть("ШапкаТаблицы");
	ТабДок.Вывести(Обл);
	
	Данные  = ПолучитьДанные();
	ВыборкаНоменкл = Данные.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	
	ОблНоменкл = Макет.ПолучитьОбласть("Строка");
	ОблАдрес   = Макет.ПолучитьОбласть("Строка1");
	КоличествоВзятьИтого = 0;
	Пока ВыборкаНоменкл.Следующий() Цикл
		КоличествоВзятьИтого = КоличествоВзятьИтого + ВыборкаНоменкл.КоличествоЗаказано;
		ОблНоменкл.Параметры.Заполнить(ВыборкаНоменкл);
		ТабДок.Вывести(ОблНоменкл);
		Выборка = ВыборкаНоменкл.Выбрать();
		Пока Выборка.Следующий() Цикл
			Если НЕ Выборка.АдресХранения = NULL Тогда
				ОблАдрес.Параметры.Заполнить(Выборка);
				ТабДок.Вывести(ОблАдрес);
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	// Итоги
	Обл = Макет.ПолучитьОбласть("Итого");
	Обл.Параметры.КоличествоВзятьИтого = КоличествоВзятьИтого;
	ТабДок.Вывести(Обл);
	
	Обл = Макет.ПолучитьОбласть("Примечание");
	Обл.Параметры.Комментарий = СсылкаНаОбъект.Комментарий;
	ТабДок.Вывести(Обл);
	
	
	Возврат ТабДок;
	
КонецФункции // Печать()