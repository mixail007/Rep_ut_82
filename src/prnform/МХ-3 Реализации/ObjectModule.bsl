
Перем КоличествоСтрокНаЛисте;
Перем КоличествоСтрокШапки;
Перем КоличествоСтрокПодвала;	
Перем КоличествоСтрокШапкиВторойСтраницы;

Функция ПолучитьСуммуПрописью(ВсегоКоличество,ВсегоСумма, ВалютаДокумента)
	СтрокаВозврата = "Всего получено: " + Лев(ЧислоПрописью(ВсегоКоличество,"НД=ложь"),Найти(ЧислоПрописью(ВсегоКоличество,"НД=ложь"),"00") - 1) + "единиц(ы) товара. На сумму: " + ЧислоПрописью(ВсегоСумма, ,ВалютаДокумента.ПараметрыПрописиНаРусском);	
	Возврат СтрокаВозврата;
КонецФункции

Процедура УстановитьЗначенияКоличестваСтрокНаЛисте()
	КоличествоСтрокНаЛисте	= 57;
	КоличествоСтрокШапки 	= 28;
	КоличествоСтрокПодвала	= 33;	
	КоличествоСтрокШапкиВторойСтраницы = 6;
КонецПроцедуры

// Функция берет реквизиты шапки документа и возвращает структуру.
Функция ЗаполнитьРеквизитыШапки(ДокументСсылка)
	СтруктураШапки = Новый Структура;
	ЗапросПоРеквизитам = Новый Запрос;
	ЗапросПоРеквизитам.УстановитьПараметр("Ссылка",ДокументСсылка);
	ЗапросПоРеквизитам.УстановитьПараметр("Скрипченко",Справочники.Контрагенты.НайтиПоКоду("П017979"));
	ЗапросПоРеквизитам.Текст = "ВЫБРАТЬ
	                           |	ВЫБОР
	                           |		КОГДА Док.Грузоотправитель = &Скрипченко
	                           |			ТОГДА Док.Грузоотправитель
	                           |		ИНАЧЕ Док.Организация
	                           |	КОНЕЦ КАК Организация,
	                           |	ВЫБОР
	                           |		КОГДА Док.Грузоотправитель = &Скрипченко
	                           |			ТОГДА Док.Организация
	                           |		ИНАЧЕ Док.Контрагент
	                           |	КОНЕЦ КАК Контрагент,
	                           |	Док.Номер,
	                           |	Док.Дата
	                           |ИЗ
	                           |	Документ.РеализацияТоваровУслуг КАК Док
	                           |ГДЕ
	                           |	Док.Ссылка = &Ссылка";
	
	Шапка = ЗапросПоРеквизитам.Выполнить().Выбрать();
	Если Шапка.Следующий() Тогда
		СведенияОбОрганизации 				= СведенияОЮрФизЛице(Шапка.Организация, Шапка.Дата);
		СведенияОПоклажедателе 				= "";
		Если не ЗначениеНеЗаполнено(Шапка.Контрагент) Тогда
			СведенияОПоклажедателе 				= СведенияОЮрФизЛице(Шапка.Контрагент, Шапка.Дата);
		КонецЕсли;

	    ПредставлениеОрганизации 			= ОписаниеОрганизации(СведенияОбОрганизации,"ПолноеНаименование,ИНН,ЮридическийАдрес,Телефоны,НомерСчета,Банк,БИК,КоррСчет");
		ПредставлениеПоклажедателя     		= ОписаниеОрганизации(СведенияОПоклажедателе);
		Валюта								= Шапка.Организация.ОсновнойБанковскийСчет.ВалютаДенежныхСредств;
		СтруктураШапки.Вставить("Организация",ПредставлениеОрганизации);
		СтруктураШапки.Вставить("Поклажедатель",ПредставлениеПоклажедателя);
		СтруктураШапки.Вставить("Номер",Шапка.Номер);
		СтруктураШапки.Вставить("Дата",Формат(Шапка.Дата,"ДФ = ""дд.мм.гггг"""));
		СтруктураШапки.Вставить("Валюта",Валюта);
		Возврат СтруктураШапки;
	КонецЕсли; 
	Возврат Неопределено;
КонецФункции

Процедура ПечатьДокумента(СтруктураШапки,ДокументОприходования,КоличествоКопий=1,НаПринтер=Истина);
	
	ЗапросПоТоварам = Новый Запрос;
	ЗапросПоТоварам.УстановитьПараметр("Ссылка",ДокументОприходования);
	ЗапросПоТоварам.УстановитьПараметр("Дата",ДокументОприходования.Дата);
	ЗапросПоТоварам.УстановитьПараметр("Склад",ДокументОприходования.склад);

	ТабДок = новый ТабличныйДокумент;
	
	
	
	//ЗапросПоТоварам.Текст =   "ВЫБРАТЬ
	//						  |	Док.Наименование КАК Наименование,
	//						  |	Док.Код КАК Код,
	//						  |	Док.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	//						  |	Док.КодЕдиницы КАК КодЕдиницы,
	//						  |	Док.Количество КАК Количество,
	//						  |	Док.Количество * ЕСТЬNULL(ПартииТоваровНаСкладах.Цена, 1) КАК Сумма,
	//						  |	ЕСТЬNULL(ПартииТоваровНаСкладах.Цена, 1) КАК Цена
	//						  |ИЗ
	//						  |	(ВЫБРАТЬ
	//						  |		РеализацияТоваровУслугТовары.Номенклатура.Наименование КАК Наименование,
	//						  |		РеализацияТоваровУслугТовары.Номенклатура КАК Номенклатура,
	//						  |		РеализацияТоваровУслугТовары.Номенклатура.Код КАК Код,
	//						  |		РеализацияТоваровУслугТовары.Номенклатура.БазоваяЕдиницаИзмерения.Наименование КАК ЕдиницаИзмерения,
	//						  |		РеализацияТоваровУслугТовары.Номенклатура.БазоваяЕдиницаИзмерения.Код КАК КодЕдиницы,
	//						  |		РеализацияТоваровУслугТовары.Склад КАК Склад,
	//						  |		РеализацияТоваровУслугТовары.Количество КАК Количество
	//						  |	ИЗ
	//						  |		Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
	//						  |	ГДЕ
	//						  |		РеализацияТоваровУслугТовары.Ссылка = &Ссылка) КАК Док
	//						  |		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	//						  |			ПартииТоваровНаСкладахОбороты.Номенклатура КАК Номенклатура,
	//						  |			ВЫБОР
	//						  |				КОГДА ПартииТоваровНаСкладахОбороты.КоличествоОборот = 0
	//						  |					ТОГДА 0
	//						  |				ИНАЧЕ ПартииТоваровНаСкладахОбороты.СтоимостьОборот / ПартииТоваровНаСкладахОбороты.КоличествоОборот
	//						  |			КОНЕЦ КАК Цена
	//						  |		ИЗ
	//						  |			РегистрНакопления.ПартииТоваровНаСкладах.Обороты(, , Авто, Склад = &Склад) КАК ПартииТоваровНаСкладахОбороты
	//						  |		ГДЕ
	//						  |			ПартииТоваровНаСкладахОбороты.Регистратор = &Ссылка) КАК ПартииТоваровНаСкладах
	//						  |		ПО Док.Номенклатура = ПартииТоваровНаСкладах.Номенклатура";
							  
	Если  ДокументОприходования.Грузоотправитель = Справочники.Контрагенты.НайтиПоКоду("П017979") тогда //если скрипченко, тогда цены оиз отчета отх, задача 56613 (Прошу настроить печать МХ-3 из реализаций на скрипченко по цене заказа "Перемещение ОТХ")
		ЗапросПоТоварам.Текст =   "ВЫБРАТЬ
		                          |	Док.Наименование КАК Наименование,
		                          |	Док.Код КАК Код,
		                          |	Док.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
		                          |	Док.КодЕдиницы КАК КодЕдиницы,
		                          |	Док.Количество КАК Количество,
		                          |	Док.Количество * ЕСТЬNULL(ВложенныйЗапрос.ЦенаОТХ, 0) КАК Сумма,
		                          |	ЕСТЬNULL(ВложенныйЗапрос.ЦенаОТХ, 0) КАК Цена
		                          |ИЗ
		                          |	(ВЫБРАТЬ
		                          |		РеализацияТоваровУслугТовары.Номенклатура.Наименование КАК Наименование,
		                          |		РеализацияТоваровУслугТовары.Номенклатура КАК Номенклатура,
		                          |		РеализацияТоваровУслугТовары.Номенклатура.Код КАК Код,
		                          |		РеализацияТоваровУслугТовары.Номенклатура.БазоваяЕдиницаИзмерения.Наименование КАК ЕдиницаИзмерения,
		                          |		РеализацияТоваровУслугТовары.Номенклатура.БазоваяЕдиницаИзмерения.Код КАК КодЕдиницы,
		                          |		РеализацияТоваровУслугТовары.Склад КАК Склад,
		                          |		РеализацияТоваровУслугТовары.Количество КАК Количество,
		                          |		РеализацияТоваровУслугТовары.Цена КАК Цена
		                          |	ИЗ
		                          |		Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
		                          |	ГДЕ
		                          |		РеализацияТоваровУслугТовары.Ссылка = &Ссылка) КАК Док
		                          |		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		                          |			взСтоимостьИзОТХ.Номенклатура КАК Номенклатура,
		                          |			ВЫБОР
		                          |				КОГДА взСтоимостьИзОТХ.Количество <> 0
		                          |					ТОГДА взСтоимостьИзОТХ.Сумма / взСтоимостьИзОТХ.Количество
		                          |				ИНАЧЕ 0
		                          |			КОНЕЦ КАК ЦенаОТХ
		                          |		ИЗ
		                          |			(ВЫБРАТЬ
		                          |				ОтчетПоОТХТоварыПоЗаказам.Номенклатура КАК Номенклатура,
		                          |				СУММА(ОтчетПоОТХТоварыПоЗаказам.Сумма) КАК Сумма,
		                          |				СУММА(ОтчетПоОТХТоварыПоЗаказам.Количество) КАК Количество
		                          |			ИЗ
		                          |				Документ.ОтчетПоОТХ.СформированныеДокументы КАК ОтчетПоОТХСформированныеДокументы
		                          |					ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ОтчетПоОТХ.ТоварыПоЗаказам КАК ОтчетПоОТХТоварыПоЗаказам
		                          |					ПО ОтчетПоОТХСформированныеДокументы.Ссылка = ОтчетПоОТХТоварыПоЗаказам.Ссылка
		                          |			ГДЕ
		                          |				(ВЫРАЗИТЬ(ОтчетПоОТХСформированныеДокументы.Документ КАК Документ.РеализацияТоваровУслуг)) = &Ссылка
		                          |			
		                          |			СГРУППИРОВАТЬ ПО
		                          |				ОтчетПоОТХТоварыПоЗаказам.Номенклатура) КАК взСтоимостьИзОТХ) КАК ВложенныйЗапрос
		                          |		ПО Док.Номенклатура = ВложенныйЗапрос.Номенклатура";
	иначе
		ЗапросПоТоварам.Текст =   "ВЫБРАТЬ
		                          |	Док.Наименование КАК Наименование,
		                          |	Док.Код КАК Код,
		                          |	Док.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
		                          |	Док.КодЕдиницы КАК КодЕдиницы,
		                          |	Док.Количество КАК Количество,
		                          |	Док.Количество * Док.Цена КАК Сумма,
		                          |	Док.Цена КАК Цена
		                          |ИЗ
		                          |	(ВЫБРАТЬ
		                          |		РеализацияТоваровУслугТовары.Номенклатура.Наименование КАК Наименование,
		                          |		РеализацияТоваровУслугТовары.Номенклатура КАК Номенклатура,
		                          |		РеализацияТоваровУслугТовары.Номенклатура.Код КАК Код,
		                          |		РеализацияТоваровУслугТовары.Номенклатура.БазоваяЕдиницаИзмерения.Наименование КАК ЕдиницаИзмерения,
		                          |		РеализацияТоваровУслугТовары.Номенклатура.БазоваяЕдиницаИзмерения.Код КАК КодЕдиницы,
		                          |		РеализацияТоваровУслугТовары.Склад КАК Склад,
		                          |		РеализацияТоваровУслугТовары.Количество КАК Количество,
		                          |		РеализацияТоваровУслугТовары.Цена КАК Цена
		                          |	ИЗ
		                          |		Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
		                          |	ГДЕ
		                          |		РеализацияТоваровУслугТовары.Ссылка = &Ссылка) КАК Док";
	КонецЕсли;


	
	Выборка = ЗапросПоТоварам.Выполнить().Выбрать();
	
	Если (Выборка.Количество()>0) Тогда 
		Если (Выборка.Количество() + КоличествоСтрокШапки + КоличествоСтрокПодвала)> КоличествоСтрокНаЛисте Тогда	 		
			// Многостраничный вывод
			// Первая страница
        	МакетОсновной 							= ПолучитьМакет("МакетПервойСтраницы");
			МакетОстальные 							= ПолучитьМакет("МакетВторойСтраницы");
			ШапкаОсновная							= МакетОсновной.ПолучитьОбласть("Шапка");
			
		Если Найти(СсылкаНаОбъект.ДоговорКонтрагента.Наименование,"*")=0 тогда //24.04.2018
 			ШапкаОсновная.Параметры.Организация 	= СтруктураШапки.Организация;
			ШапкаОсновная.Параметры.Поклажедатель 	= СтруктураШапки.Поклажедатель;
		КонецЕсли;
			ШапкаОсновная.Параметры.Номер 			= СтруктураШапки.Номер;				
			ШапкаОсновная.Параметры.Дата 			= ДокументОприходования.Дата;	
			
			ШапкаОсновная.Параметры.Страница		= "Страница 1";
			
			ТабДок.Вывести(ШапкаОсновная);
			СтрокаОсновная							= МакетОсновной.ПолучитьОбласть("Строка");
			Номер 									= 1;
			ИтогоКоличество 						= 0;
			ИтогоСумма 								= 0;
			НомерПозиции							= КоличествоСтрокШапки + 1;
			КоличествоВВыборке						= Выборка.Количество();
			
			Условие = Выборка.Следующий();
			Пока (Условие) и (НомерПозиции<=(КоличествоСтрокНаЛисте)) Цикл
				СтрокаОсновная.Параметры.Номер 			= 	Номер;
				СтрокаОсновная.Параметры.Наименование 	= 	Выборка.Наименование;
				СтрокаОсновная.Параметры.Код			=	Выборка.Код;
				СтрокаОсновная.Параметры.ЕдНаим			=   Выборка.ЕдиницаИзмерения;
				СтрокаОсновная.Параметры.ЕдКод			= 	Выборка.КодЕдиницы;
				СтрокаОсновная.Параметры.Количество		= 	Выборка.Количество;
				СтрокаОсновная.Параметры.Цена			= 	Выборка.Цена;
				СтрокаОсновная.Параметры.Стоимость		= 	Выборка.Сумма;
				Номер 									= 	Номер 	+ 1;
				ИтогоКоличество 						= 	ИтогоКоличество 	+ Выборка.Количество;
				ИтогоСумма 								= 	ИтогоСумма		+ Выборка.Сумма;
				ТабДок.Вывести(СтрокаОсновная);
				НомерПозиции							= 	НомерПозиции + 1;
				Условие 								= 	Выборка.Следующий();
				КоличествоВВыборке						= 	КоличествоВВыборке - 1;
			КонецЦикла;
			СтрокаИтого 							= МакетОсновной.ПолучитьОбласть("СтрокаИтого"); 
			СтрокаИтого.Параметры.ИтогоКоличество 	= ИтогоКоличество;
			СтрокаИтого.Параметры.ИтогоСтоимость 	= ИтогоСумма;
			ТабДок.Вывести(СтрокаИтого);
			// Остальные страницы
			ВсегоКоличество 						= ИтогоКоличество;
			ВсегоСумма								= ИтогоСумма;
			ИтогоКоличество							= 0;
			ИтогоСумма								= 0;
			Страница 								= 1;

			Если (Условие) Тогда
				ТабДок.ВывестиГоризонтальныйРазделительСтраниц();
				Страница 								= Страница 								+ 1;
				НомерПозиции = КоличествоСтрокШапкиВторойСтраницы;
				ШапкаВторая								= МакетОстальные.ПолучитьОбласть("Шапка");
				ШапкаВторая.Параметры.Страница			= "Страница " + Строка(Страница);
				ТабДок.Вывести(ШапкаВторая);			
				СтрокаОстальные							= МакетОстальные.ПолучитьОбласть("Строка");			
				Условие 								= Истина;				
				НачалоСтраницы = Ложь;
				
				Пока Условие Цикл								
					СтрокаОстальные.Параметры.Номер 			= 	Номер;
					СтрокаОстальные.Параметры.Наименование 		= 	Выборка.Наименование;
					СтрокаОстальные.Параметры.Код				=	Выборка.Код;
					СтрокаОстальные.Параметры.ЕдНаим			=   Выборка.ЕдиницаИзмерения;
					СтрокаОстальные.Параметры.ЕдКод				= 	Выборка.КодЕдиницы;
					СтрокаОстальные.Параметры.Количество		= 	Выборка.Количество;
					СтрокаОстальные.Параметры.Цена				= 	Выборка.Цена;
					СтрокаОстальные.Параметры.Стоимость			= 	Выборка.Сумма;
					Номер 										= 	Номер 	+ 1;
					ИтогоКоличество 							= 	ИтогоКоличество 	+ Выборка.Количество;
					ИтогоСумма 									= 	ИтогоСумма			+ Выборка.Сумма;
					ТабДок.Вывести(СтрокаОстальные);
					НомерПозиции								= НомерПозиции + 1;
					Если ((НомерПозиции>=(КоличествоСтрокНаЛисте))) Тогда
				// Выведем итого
						НомерПозиции 							= КоличествоСтрокШапкиВторойСтраницы;
						СтрокаИтого 							= МакетОсновной.ПолучитьОбласть("СтрокаИтого"); 
						СтрокаИтого.Параметры.ИтогоКоличество 	= ИтогоКоличество;
						СтрокаИтого.Параметры.ИтогоСтоимость 	= ИтогоСумма;
						ВсегоСумма 								= ВсегоСумма + ИтогоСумма;
						ВсегоКоличество 						= ВсегоКоличество + ИтогоКоличество;
						ТабДок.Вывести(СтрокаИтого);
						ИтогоКоличество 						= 0;
						ИтогоСумма 								= 0;					
						НачалоСтраницы = Истина;
					КонецЕсли;
					Условие 									= Выборка.Следующий(); 
					КоличествоВВыборке						= 	КоличествоВВыборке - 1;
					Если (Условие и НачалоСтраницы) Тогда
						ТабДок.ВывестиГоризонтальныйРазделительСтраниц();	
						Страница								= Страница + 1;
						ШапкаВторая.Параметры.Страница			= "Страница " + Строка(Страница);
						ТабДок.Вывести(ШапкаВторая);			
						НачалоСтраницы 							= Ложь;
					ИначеЕсли((Не(Условие))) Тогда 
						СтрокаИтого 							= МакетОсновной.ПолучитьОбласть("СтрокаИтого"); 
						СтрокаИтого.Параметры.ИтогоКоличество 	= ИтогоКоличество;
						СтрокаИтого.Параметры.ИтогоСтоимость 	= ИтогоСумма;
						ВсегоСумма 								= ВсегоСумма + ИтогоСумма;
						ВсегоКоличество 						= ВсегоКоличество + ИтогоКоличество;
						ТабДок.Вывести(СтрокаИтого);						
					КонецЕсли;	
				КонецЦикла;
				КонецЕсли; 				
				// Выводим последний подвал
					//ВсегоКоличество = ВсегоКоличество + ИтогоКоличество;
					//ВсегоСумма = ВсегоСумма + ИтогоСумма;
					СтрокаИтого									= МакетОстальные.ПолучитьОбласть("СтрокаИтого");  
					СтрокаИтого.Параметры.АктКоличество	 		= ВсегоКоличество;
					СтрокаИтого.Параметры.АктСтоимость 			= ВсегоСумма;			
					ТабДок.Вывести(СтрокаИтого);
					Подвал										= МакетОстальные.ПолучитьОбласть("Подвал");
					Если ((НомерПозиции + КоличествоСтрокПодвала)>КоличествоСтрокНаЛисте) Тогда
						ТабДок.ВывестиГоризонтальныйРазделительСтраниц();
						Подвал.Параметры.Страница				= "Страница " + Строка(Страница + 1);
					КонецЕсли;
					СуммаПрописью = ПолучитьСуммуПрописью(ВсегоКоличество,ВсегоСумма, СтруктураШапки.Валюта);
					Подвал.Параметры.Принято					= СуммаПрописью; 
					ТабДок.Вывести(Подвал);
		Иначе
			// Одностраничный вывод 
			Макет 		= ПолучитьМакет("МакетПервойСтраницы");
			МакетВторой = ПолучитьМакет("МакетВторойСтраницы");
			Шапка = Макет.ПолучитьОбласть("Шапка");
			
		Если Найти(СсылкаНаОбъект.ДоговорКонтрагента.Наименование,"*")=0 тогда //24.04.2018
			Шапка.Параметры.Организация = СтруктураШапки.Организация;
			Шапка.Параметры.Поклажедатель = СтруктураШапки.Поклажедатель;
		КонецЕсли;	
			Шапка.Параметры.Номер = СтруктураШапки.Номер;				
			Шапка.Параметры.Дата = СтруктураШапки.Дата;	
			ТабДок.Вывести(Шапка);
			Строка = Макет.ПолучитьОбласть("Строка");
			Номер 			= 1;
			ИтогоКоличество = 0;
			ИтогоСумма 		= 0;
			Пока Выборка.Следующий() Цикл
				Строка.Параметры.Номер 			= 	Номер;
				Строка.Параметры.Наименование 	= 	Выборка.Наименование;
				Строка.Параметры.Код			=	Выборка.Код;
				Строка.Параметры.ЕдНаим			=   Выборка.ЕдиницаИзмерения;
				Строка.Параметры.ЕдКод			= 	Выборка.КодЕдиницы;
				Строка.Параметры.Количество		= 	Выборка.Количество;
				Строка.Параметры.Цена			= 	Выборка.Цена;
				Строка.Параметры.Стоимость		= 	Выборка.Сумма;
				Номер 					= 	Номер 	+ 1;
				ИтогоКоличество = ИтогоКоличество 	+ Выборка.Количество;
				ИтогоСумма 		= ИтогоСумма		+ Выборка.Сумма;
				ТабДок.Вывести(Строка);
			КонецЦикла;
			СтрокаИтого 							= Макет.ПолучитьОбласть("СтрокаИтого"); 
			СтрокаИтого.Параметры.ИтогоКоличество 	= ИтогоКоличество;
			СтрокаИтого.Параметры.ИтогоСтоимость 	= ИтогоСумма;
			ТабДок.Вывести(СтрокаИтого);
			СтрокаИтого 							= МакетВторой.ПолучитьОбласть("СтрокаИтого"); 
			СтрокаИтого.Параметры.АктКоличество		= ИтогоКоличество;
			СтрокаИтого.Параметры.АктСтоимость		= ИтогоСумма;
			ТабДок.Вывести(СтрокаИтого);
			СуммаПрописью = ПолучитьСуммуПрописью(ИтогоКоличество,ИтогоСумма, СтруктураШапки.Валюта);
			Подвал 									= Макет.ПолучитьОбласть("Подвал");  
			Подвал.Параметры.Принято				= СуммаПрописью; 
			ТабДок.Вывести(Подвал);
		КонецЕсли;		
		ТабДок.АвтоМасштаб	=	Истина;
		ТабДок.Показать();
	КонецЕсли;
	
КонецПроцедуры

Функция Печать() Экспорт
	
	//Если СсылкаНаОбъект.ВидОперации=Перечисления.ВидыОперацийПоОтветственномуХранению.Списание  Тогда
		УстановитьЗначенияКоличестваСтрокНаЛисте();
		СтруктураШапки = ЗаполнитьРеквизитыШапки(СсылкаНаОбъект);
		Если СтруктураШапки<>Неопределено Тогда
			ПечатьДокумента(СтруктураШапки,СсылкаНаОбъект,1,Ложь);
		КонецЕсли;
	//КОнецЕсли;
КонецФункции
