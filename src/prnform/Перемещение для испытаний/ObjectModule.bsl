Функция Печать() Экспорт
	
	ТабДокумент = ПечатьПеремещения();
	Возврат ТабДокумент;
			
КонецФункции // Печать

Функция ПечатьПеремещения()
	ТабДокумент = Новый ТабличныйДокумент;
	Макет = ПолучитьМакет("Макет");
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ПеремещениеТоваровТовары.Номенклатура.Код КАК Код,
		|	ПеремещениеТоваровТовары.Номенклатура КАК Номенклатура,
		|	ПеремещениеТоваровТовары.Ссылка.ДокументОснование КАК Поступление,
		|	ПеремещениеТоваровТовары.Ссылка.ДокументОснование.Сделка.НомерКонтейнера КАК НомерКонтейнера,
		|	СУММА(ПеремещениеТоваровТовары.Количество) КАК Количество
		|ПОМЕСТИТЬ втПеремещение
		|ИЗ
		|	Документ.ПеремещениеТоваров.Товары КАК ПеремещениеТоваровТовары
		|ГДЕ
		|	ПеремещениеТоваровТовары.Ссылка = &Ссылка
		|	И ПеремещениеТоваровТовары.Номенклатура.ВидТовара = ЗНАЧЕНИЕ(Перечисление.ВидыТоваров.Диски)
		|
		|СГРУППИРОВАТЬ ПО
		|	ПеремещениеТоваровТовары.Номенклатура,
		|	ПеремещениеТоваровТовары.Ссылка.ДокументОснование,
		|	ПеремещениеТоваровТовары.Номенклатура.Код,
		|	ПеремещениеТоваровТовары.Ссылка.ДокументОснование.Сделка.НомерКонтейнера
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ЗначенияСвойствОбъектов.Объект КАК Номенклатура
		|ПОМЕСТИТЬ втОстатокПроверен
		|ИЗ
		|	РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
		|ГДЕ
		|	ЗначенияСвойствОбъектов.Объект В
		|			(ВЫБРАТЬ
		|				втПеремещение.Номенклатура
		|			ИЗ
		|				втПеремещение)
		|	И ЗначенияСвойствОбъектов.Свойство = &ПроверенОстаток
		|	И ЗначенияСвойствОбъектов.Значение = ИСТИНА
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ПровереннаяНагрузкаДисков.ПрошедшаяНагрузка,
		|	ПровереннаяНагрузкаДисков.Номенклатура
		|ПОМЕСТИТЬ НАгрузка
		|ИЗ
		|	РегистрСведений.ПровереннаяНагрузкаДисков КАК ПровереннаяНагрузкаДисков
		|ГДЕ
		|	ПровереннаяНагрузкаДисков.Номенклатура В
		|			(ВЫБРАТЬ
		|				втПеремещение.Номенклатура
		|			ИЗ
		|				втПеремещение)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ТоварыНаСкладахОстатки.Номенклатура,
		|	СУММА(ТоварыНаСкладахОстатки.КоличествоОстаток) КАК КоличествоОстаток
		|ПОМЕСТИТЬ втКоличествоНепроверенных
		|ИЗ
		|	РегистрНакопления.ТоварыНаСкладах.Остатки(
		|			,
		|			НЕ Номенклатура В
		|						(ВЫБРАТЬ
		|							втОстатокПроверен.Номенклатура
		|						ИЗ
		|							втОстатокПроверен)
		|				И Номенклатура В
		|					(ВЫБРАТЬ
		|						втПеремещение.Номенклатура
		|					ИЗ
		|						втПеремещение)
		|				И Склад.ЗапретитьИспользование = ЛОЖЬ
		|				И (Склад.Подразделение.Код = ""00005""
		|					ИЛИ Склад.Подразделение = ЗНАЧЕНИЕ(Справочник.Подразделения.ПустаяСсылка))) КАК ТоварыНаСкладахОстатки
		|
		|СГРУППИРОВАТЬ ПО
		|	ТоварыНаСкладахОстатки.Номенклатура
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ПоступлениеТоваровУслугТовары.Номенклатура,
		|	СУММА(ПоступлениеТоваровУслугТовары.Количество) КАК Количество
		|ПОМЕСТИТЬ втПоступление
		|ИЗ
		|	Документ.ПоступлениеТоваровУслуг.Товары КАК ПоступлениеТоваровУслугТовары
		|ГДЕ
		|	(ПоступлениеТоваровУслугТовары.Ссылка, ПоступлениеТоваровУслугТовары.Номенклатура) В
		|			(ВЫБРАТЬ
		|				втПеремещение.Поступление,
		|				втПеремещение.Номенклатура
		|			ИЗ
		|				втПеремещение)
		|
		|СГРУППИРОВАТЬ ПО
		|	ПоступлениеТоваровУслугТовары.Номенклатура
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	втПеремещение.Код,
		|	втПеремещение.Номенклатура КАК Номенклатура,
		|	втПеремещение.Поступление,
		|	втПеремещение.НомерКонтейнера,
		|	ЕСТЬNULL(втКоличествоНепроверенных.КоличествоОстаток, 0) КАК КоличествоНепроверенных,
		|	ЕСТЬNULL(НАгрузка.ПрошедшаяНагрузка, 0) КАК ПрошедшаяНагрузка,
		|	втПоступление.Количество КАК КоличествоПоступило,
		|	втПеремещение.Количество КАК КоличествоПеремещено
		|ИЗ
		|	втПеремещение КАК втПеремещение
		|		ЛЕВОЕ СОЕДИНЕНИЕ втКоличествоНепроверенных КАК втКоличествоНепроверенных
		|		ПО втПеремещение.Номенклатура = втКоличествоНепроверенных.Номенклатура
		|		ЛЕВОЕ СОЕДИНЕНИЕ НАгрузка КАК НАгрузка
		|		ПО втПеремещение.Номенклатура = НАгрузка.Номенклатура
		|		ЛЕВОЕ СОЕДИНЕНИЕ втПоступление КАК втПоступление
		|		ПО втПеремещение.Номенклатура = втПоступление.Номенклатура
		|
		|УПОРЯДОЧИТЬ ПО
		|	Номенклатура,
		|	ПрошедшаяНагрузка
		|ИТОГИ ПО
		|	Номенклатура
		|АВТОУПОРЯДОЧИВАНИЕ";
		
    Запрос.УстановитьПараметр("Ссылка", СсылкаНаОбъект);
	Запрос.УстановитьПараметр("ПроверенОстаток",планыВидовХарактеристик.СвойстваОбъектов.НайтиПоКоду("90255"));
	РезультатПоНоменклатуре = Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	
	РезультатПоНоменклатуре.Следующий();
	ВыборкаДетали = РезультатПоНоменклатуре.Выбрать();
	ВыборкаДетали.Следующий();

	Шапка = Макет.ПолучитьОбласть("Шапка");
	ОбластьШапкаПФ = Макет.ПолучитьОбласть("ШапкаПФ");
	ОбластьШапкаПФ.Параметры.ТекстЗаголовка = СформироватьЗаголовокДокумента(СсылкаНаОбъект, "Накладная на перемещение");

	ОбластьШапкаПФ.Параметры.Поступление = ВыборкаДетали.Поступление;

	ОбластьШапкаПФ.Параметры.Контейнер = ВыборкаДетали.НомерКонтейнера;
	
	Если СсылкаНаОбъект.Товары.Количество()=1 Тогда
		ОбластьШапкаПФ.Параметры.ПредставлениеПоставщика = Строка(?(СсылкаНаОбъект.Товары[0].Склад.Пустая(),?(СсылкаНаОбъект.ВнутреннийЗаказ.Пустая(), СсылкаНаОбъект.СкладПолучатель, СсылкаНаОбъект.СкладОтправитель),СсылкаНаОбъект.Товары[0].Склад)  );   //27.04.2016
		ОбластьШапкаПФ.Параметры.Поставщик = СсылкаНаОбъект.Товары[0].Склад;
		
	Иначе    //27.04.2016
		//Если Найти(СкладПолучатель.Наименование,"Буфер")>0 Тогда // при перемещении на буферный склад - печатаем Склад!
		//ТабЗнач1 = СсылкаНаОбъект.Товары.Выгрузить();
		//ТабЗнач1.Свернуть("Склад");
		//ТабЗнач1.Колонки.Добавить("ГруппаСкладов");
		//текст1 = "";
		//Для i=0 по ТабЗнач1.Количество()-1 цикл
		//	ТабЗнач1[i].ГруппаСкладов = ?(ЗначениеЗаполнено(ТабЗнач1[i].Склад.ГруппаСкладов), СокрЛП(ТабЗнач1[i].Склад.ГруппаСкладов), "Основной склад");
		//КонецЦикла;	
		//ТабЗнач1.Свернуть("ГруппаСкладов");
		//Список = ТабЗнач1.ВыгрузитьКолонку("ГруппаСкладов");
		//для i=0 по Список.Количество()-1 цикл
		//	текст1 = текст1+СокрЛП(Список[i])+", ";
		//КонецЦикла;	
		//текст1 = ?(текст1="", "", Лев(текст1, стрДлина(текст1)-2) );
		//
		//Если сокрЛП(текст1)="" Тогда
			ОбластьШапкаПФ.Параметры.ПредставлениеПоставщика = СсылкаНаОбъект.СкладОтправитель;
			ОбластьШапкаПФ.Параметры.Поставщик = СсылкаНаОбъект.СкладОтправитель;
		//иначе
		//	ОбластьШапкаПФ.Параметры.ПредставлениеПоставщика = текст1;
		//	ОбластьШапкаПФ.Параметры.Поставщик = СсылкаНаОбъект.СкладОтправитель;
		//КонецЕсли;	

	КонецЕсли;

	ОбластьШапкаПФ.Параметры.ПредставлениеПолучателя = СсылкаНаОбъект.СкладПолучатель;
	
	ТабДокумент.Вывести(ОбластьШапкаПФ);
	ТабДокумент.Вывести(Шапка);
	Областьстроки = Макет.ПолучитьОбласть("Строка");
	//ОбластьКартинка = Макет.ПолучитьОбласть("строка");
	
	РезультатПоНоменклатуре.Сбросить();	
	Пока РезультатПоНоменклатуре.Следующий() цикл
		ВыборкаДетали = РезультатПоНоменклатуре.Выбрать();
		ПрошедшаяНагрузка = "";
		Пока ВыборкаДетали.Следующий() цикл
			ОбластьСтроки.Параметры.Код = ВыборкаДетали.Код;
		 	ОбластьСтроки.Параметры.Номенклатура  = ВыборкаДетали.Номенклатура;
			ОбластьСтроки.Параметры.КоличествоПоступило  = ВыборкаДетали.КоличествоПоступило;
			ОбластьСтроки.Параметры.КоличествоПеремещено  = ВыборкаДетали.КоличествоПеремещено;
			ОбластьСтроки.Параметры.КоличествоНепроверенных  = ВыборкаДетали.КоличествоНепроверенных;

			Если ВыборкаДетали.ПрошедшаяНагрузка>0 тогда
				ПрошедшаяНагрузка = ПрошедшаяНагрузка+ВыборкаДетали.ПрошедшаяНагрузка+"; ";
			КонецЕсли;
		КонецЦикла;
		ПрошедшаяНагрузка = ?(ПрошедшаяНагрузка="","-",ПрошедшаяНагрузка);
		ОбластьСтроки.Параметры.ПрошедшаяНагрузка = ПрошедшаяНагрузка;
		ТабДокумент.Вывести(ОбластьСтроки);

	КонецЦикла;
	
	ОбластьМакета = Макет.ПолучитьОбласть("Подписи");
	ТабДокумент.Вывести(ОбластьМакета);

Возврат ТабДокумент;	
	
КонецФункции