
//Заказ по ОТХ - для операции Списание
Функция ПечатьЗагрузочныйЛист()
	
	ИнфоПоПроезду=ЕстьИнфоПоПроезду();
	Если ИнфоПоПроезду.Количество()>0 тогда
		 ТабДокумент=ПечатьЗагрузочногоЛистаПоИнформацииОПроезде(ИнфоПоПроезду);
	 КонецЕсли;
	 Возврат ТабДокумент;
КонецФункции // ПечатьСчетаЗаказа()

// общая процедура печати
функция Печать() Экспорт
	ТабДокумент = неопределено;
	Если НЕ ЗначениеЗаполнено(СсылкаНаОбъект) тогда
		#Если Клиент тогда
			Предупреждение("Не выбран документ!", 30);		
		#КонецЕсли	
		возврат Неопределено;
	КонецЕсли;
	
	ТабДокумент = ПечатьЗагрузочныйЛист();
			
	Возврат ТабДокумент;
	
КонецФункции

Функция ПечатьЗагрузочногоЛистаПоИнформацииОПроезде(Инфо)
	ТабДокумент=Новый табличныйДокумент;
	Макет=ПолучитьМакет("МакетПроезд");
	ОбластьМакета = Макет.ПолучитьОбласть("Шапка");
	
	ОбластьМакета.Параметры.Водитель = "Водитель: "+СсылкаНаОбъект.Водитель;
	ОбластьМакета.Параметры.АвтомобильГосНомерАвтомобиля = "Автомобиль: "+СсылкаНаОбъект.МаркаАвтомобиля+"  "+СсылкаНаОбъект.ГосНомерАвтомобиля;
	ОбластьМакета.Параметры.ТелефонВодителя = СсылкаНаОбъект.ТелефонВодителя;
	ОбластьМакета.Параметры.Номер = число(прав(СсылкаНаОбъект.Номер,5));
	ОбластьМакета.Параметры.Дата  = Формат(СсылкаНаОбъект.Дата,"ДЛФ=DD");
	ТабДокумент.Вывести(ОбластьМакета);
	ОбластьМакета= Макет.ПолучитьОбласть("ШапкаМенеджер");
	
	//Менеджер телефон
	Менеджеры=Инфо.Скопировать();
	Менеджеры.Свернуть("Менеджер");
	для Каждого стр из Менеджеры цикл
		//-----------определение телефона-------------------------
		ФизЛицо1 = стр.Менеджер.ФизЛицо;
		Если ЗначениеЗаполнено(ФизЛицо1) тогда
			значТел = ПолучитьВсеТелефоны(ФизЛицо1); //+++ 14.08.2017
			ОбластьМакета.Параметры.Телефон  = значТел;
			ОбластьМакета.Параметры.Менеджер = ФизЛицо1.Наименование;
		иначе // по сотруднику
			ОбластьМакета.Параметры.Менеджер = стр.Менеджер;
			сообщить("Для пользователя: "+ стр.Менеджер +" - не установлено Физ.Лицо! Контактная информация - не доступна!", СтатусСообщения.Внимание);
		КонецЕсли;
		
		ТабДокумент.Вывести(ОбластьМакета);
	конецЦикла;
	//----------------------------------------
	ОбластьМакета = Макет.ПолучитьОбласть("ШапкаТаблицы");
	ОбластьМакета.Параметры.Подпись="Порядок загрузки товара:";
	ТабДокумент.Вывести(ОбластьМакета);
	
	
    Инфо2=Инфо.Скопировать();
	Инфо2.Сортировать("НомерОчереди Убыв");
	Инфо2.Свернуть("НомерОчереди, Контрагент, Адрес, Менеджер");
    Инфо2.Колонки.Добавить("Номер");
	Инфо2.Колонки.Добавить("Количество");

	ОбластьМакета = Макет.ПолучитьОбласть("Строка");

	СуммаВсего=0;
	НомерСтроки=1;
	N = Инфо.Количество(); k=0;
	предПоиск = "";
	Для каждого стр из Инфо2 цикл
		стр.Количество=0;
		СтрПоиска2 = Строка(стр.Контрагент)+"-"+Строка(стр.Адрес)+"-"+Строка(стр.Менеджер);
		Если СтрПоиска2=предПоиск тогда // +++ 07.08.2015
			продолжить;
		КонецЕсли;	
		предПоиск = СтрПоиска2;
		номерНакл = "";
		коммент=""; //02.04.2014
		Для i=0 по N-1 Цикл
			стр1 = Инфо[i];
			
			СтрПоиска1 = Строка(стр1.Контрагент)+"-"+Строка(стр1.Адрес)+"-"+Строка(стр1.Менеджер);
			Если СтрПоиска1 = СтрПоиска2 Тогда
				номерНакл = номерНакл  + ?(СокрЛП(НомерНакл)<>"",Символы.ПС,"")+Строка(стр1.Заказ.Номер);
				Для каждого стр2 из СсылкаНаОбъект.ЗаказыПокупателей цикл
					Если стр2.ЗаказПокупателя=стр1.Заказ тогда
						 стр.Количество=стр.Количество+стр2.КоличествоШтук;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;	
			
		КонецЦикла;	
		стр.Номер = номерНакл;
		
		ОбластьМакета.Параметры.Номер = стр.Номер;
		ОбластьМакета.Параметры.Контрагент = стр.Контрагент;
		ОбластьМакета.Параметры.Менеджер   = стр.Менеджер;
		ФизЮрАдрес = ПолучитьАдресИзКонтактнойИнформации(стр.Контрагент,"Фактический");
		ФизЮрАдрес = ?(СокрЛП(ФизЮрАдрес) = "", ПолучитьАдресИзКонтактнойИнформации(стр.Контрагент,"Юридический"), ФизЮрАдрес);
		ОбластьМакета.Параметры.АдресТелефон = ?(СокрЛП(стр.Адрес)="", СокрЛП(ФизЮрАдрес), СокрЛП(стр.Адрес));
		
		ОбластьМакета.Параметры.НомерСтроки = строка(НомерСтроки);
		
		ОбластьМакета.Параметры.Количество = стр.Количество;//+" "+Выборка.Контрагент.ОсновноеКонтактноеЛицо;
		СуммаВсего = СуммаВсего + стр.Количество;
		
		ТабДокумент.Вывести(ОбластьМакета);
		НомерСтроки = НомерСтроки+1;
	КонецЦикла;
	ОбластьМакета = Макет.ПолучитьОбласть("Подвал");
	ОбластьМакета.Параметры.СуммаКоличество = СуммаВсего;
    ТабДокумент.Вывести(ОбластьМакета);
	
	Возврат ТабДокумент;	
КонецФункции

Функция ЕстьИнфоПоПроезду()
	Запрос=новый Запрос;
	Запрос.Текст="ВЫБРАТЬ
	             |	ИнформацияПоПроезду.Задание,
	             |	МИНИМУМ(ИнформацияПоПроезду.НомерОчереди) КАК НомерОчереди,
	             |	ИнформацияПоПроезду.Контрагент,
	             |	ИнформацияПоПроезду.Заказ,
	             |	ВЫРАЗИТЬ(ИнформацияПоПроезду.Адрес КАК СТРОКА(500)) КАК Адрес,
	             |	ИнформацияПоПроезду.Организация,
	             |	СУММА(ИнформацияПоПроезду.ДоставкаНал) КАК ДоставкаНал,
	             |	СУММА(ИнформацияПоПроезду.ДоставкаБНал) КАК ДоставкаБНал,
	             |	СУММА(ИнформацияПоПроезду.ДоставкаВЦене) КАК ДоставкаВЦене,
	             |	ИнформацияПоПроезду.Менеджер,
	             |	ВЫРАЗИТЬ(ИнформацияПоПроезду.Комментарий КАК СТРОКА(500)) КАК Комментарий,
	             |	СУММА(ИнформацияПоПроезду.Объём) КАК Объём,
	             |	ИнформацияПоПроезду.ВсеДокументыСданыВБухгалтерию,
	             |	СУММА(ИнформацияПоПроезду.СуммаЗаТоварНал) КАК СуммаЗаТоварНал
	             |ИЗ
	             |	РегистрСведений.ИнформацияПоПроезду КАК ИнформацияПоПроезду
	             |ГДЕ
	             |	ИнформацияПоПроезду.Задание = &Задание
	             |
	             |СГРУППИРОВАТЬ ПО
	             |	ИнформацияПоПроезду.Контрагент,
	             |	ИнформацияПоПроезду.Задание,
	             |	ИнформацияПоПроезду.Заказ,
	             |	ИнформацияПоПроезду.ВсеДокументыСданыВБухгалтерию,
	             |	ВЫРАЗИТЬ(ИнформацияПоПроезду.Комментарий КАК СТРОКА(500)),
	             |	ИнформацияПоПроезду.Организация,
	             |	ВЫРАЗИТЬ(ИнформацияПоПроезду.Адрес КАК СТРОКА(500)),
	             |	ИнформацияПоПроезду.Менеджер";
	Запрос.УстановитьПараметр("Задание",СсылкаНаОбъект.Ссылка);
	Рез=Запрос.Выполнить().Выгрузить();
	Возврат Рез;
КонецФункции

функция ПолучитьВсеТелефоны(ФизЛицо1)
	рез = "";
	 Запрос = Новый Запрос;
	 Запрос.Текст = "ВЫБРАТЬ
	                |	КонтактнаяИнформация.Представление,
	                |	КонтактнаяИнформация.Вид,
	                |	КонтактнаяИнформация.Объект
	                |ПОМЕСТИТЬ Сотовый
	                |ИЗ
	                |	РегистрСведений.КонтактнаяИнформация КАК КонтактнаяИнформация
	                |ГДЕ
	                |	КонтактнаяИнформация.Тип = &Тип
	                |	И КонтактнаяИнформация.Объект = &Объект
	                |	И КонтактнаяИнформация.Вид = &Вид1
	                |;
	                |
	                |////////////////////////////////////////////////////////////////////////////////
	                |ВЫБРАТЬ
	                |	КонтактнаяИнформация.Представление,
	                |	КонтактнаяИнформация.Вид,
	                |	КонтактнаяИнформация.Объект
	                |ПОМЕСТИТЬ Внутренний
	                |ИЗ
	                |	РегистрСведений.КонтактнаяИнформация КАК КонтактнаяИнформация
	                |ГДЕ
	                |	КонтактнаяИнформация.Тип = &Тип
	                |	И КонтактнаяИнформация.Объект = &Объект
	                |	И КонтактнаяИнформация.Вид = &Вид2
	                |;
	                |
	                |////////////////////////////////////////////////////////////////////////////////
	                |ВЫБРАТЬ
	                |	КонтактнаяИнформация.Представление,
	                |	КонтактнаяИнформация.Вид,
	                |	КонтактнаяИнформация.Объект
	                |ПОМЕСТИТЬ Сотовый2
	                |ИЗ
	                |	РегистрСведений.КонтактнаяИнформация КАК КонтактнаяИнформация
	                |ГДЕ
	                |	КонтактнаяИнформация.Тип = &Тип
	                |	И КонтактнаяИнформация.Объект = &Объект
	                |	И КонтактнаяИнформация.Вид = &Вид3
	                |;
	                |
	                |////////////////////////////////////////////////////////////////////////////////
	                |ВЫБРАТЬ
	                |	Сотовый.Представление КАК Сотовый,
	                |	Внутренний.Представление КАК Внутренний,
	                |	Сотовый2.Представление КАК Помошник
	                |ИЗ
	                |	Сотовый2 КАК Сотовый2
	                |		ПОЛНОЕ СОЕДИНЕНИЕ Внутренний КАК Внутренний
	                |		ПО (ИСТИНА)
	                |		ПОЛНОЕ СОЕДИНЕНИЕ Сотовый КАК Сотовый
	                |		ПО (ИСТИНА)";
	 Запрос.УстановитьПараметр("Вид1", Справочники.ВидыКонтактнойИнформации.НайтиПоКоду("00022"));
	 Запрос.УстановитьПараметр("Вид3", Справочники.ВидыКонтактнойИнформации.НайтиПоКоду("00024"));
	 Запрос.УстановитьПараметр("Вид2", Справочники.ВидыКонтактнойИнформации.НайтиПоКоду("38840"));
	 Запрос.УстановитьПараметр("Тип", перечисления.ТипыКонтактнойИнформации.Телефон);
	 Запрос.УстановитьПараметр("Объект", ФизЛицо1); 
	 Результат = Запрос.Выполнить();
	 Выборка = Результат.Выбрать();
	// Рез = Выборка.Сотовый +"; " + " вн. " +Выборка.Внутренний+"; " + + Выборка.Помошник+"; ";
	 Пока Выборка.Следующий() Цикл
	 //рез = рез +?(строка(выборка.Вид)="Внутренний телефон" и СокрЛП(выборка.Представление)<>"","вн.", "")
	 //			+ СокрЛП(выборка.Представление)+"; ";
	 Рез = "" + Выборка.Сотовый +"; " + " вн. " +Выборка.Внутренний+"; " +  Выборка.Помошник+"; ";
	 КонецЦикла;
	
	возврат рез;
 КонецФункции
 
