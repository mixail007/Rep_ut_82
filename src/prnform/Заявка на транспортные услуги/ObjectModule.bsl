
//Заказ по ОТХ - для операции Списание
Функция ПечатьЗаявки()
	
	ТабДокумент = Новый ТабличныйДокумент;
	ТабДокумент.ИмяПараметровПечати = "ПАРАМЕТРЫ_ПЕЧАТИ_ЗаявкаНаТранспортныеУслуги";
	
	Макет = ПолучитьМакет("Заявка");
	
	Запрос=Новый Запрос;
	Запрос.Текст="ВЫБРАТЬ
	             |	ЗаданиеНаОтгрузкуЗаказыПокупателей.Реализация,
				 
				 |выбор когда ЗаданиеНаОтгрузкуЗаказыПокупателей.ЗаказПокупателя.ДоговорКонтрагента.Наименование подобно ""%*%""
				 |	тогда ""*"" иначе """" конец как РеализацияНал,
				 
	             |	ЗаданиеНаОтгрузкуЗаказыПокупателей.Реализация.Дата,
	             |	ВЫБОР                                               
	             //|		КОГДА ЗаданиеНаОтгрузкуЗаказыПокупателей.ЗаказПокупателя.Контрагент = &ФАп
           		 //|			ТОГДА ""Формула Авто Плюс""
		   
	             |		КОГДА ЗаданиеНаОтгрузкуЗаказыПокупателей.ЗаказПокупателя.ДоговорКонтрагента.ТипДоговора = &ВидФА
	             |			ТОГДА ""Формула Авто""
				 |		КОГДА ЗаданиеНаОтгрузкуЗаказыПокупателей.ЗаказПокупателя.ДоговорКонтрагента.ТипДоговора = &ВидФАп
	             |			ТОГДА ""Формула Авто Плюс""
				 |		КОГДА ЗаданиеНаОтгрузкуЗаказыПокупателей.ЗаказПокупателя.ДоговорКонтрагента.ТипДоговора = &ВидШТ
	             |			ТОГДА ""Шинтрейд""
				 
	             |		КОГДА ЗаданиеНаОтгрузкуЗаказыПокупателей.ЗаказПокупателя.Контрагент.Код = &КодАЭ
	             |			ТОГДА ""АвтоЭксперт""
	             |		КОГДА ЗаданиеНаОтгрузкуЗаказыПокупателей.ЗаказПокупателя.Контрагент.Код = &КодFa
	             |			ТОГДА ""Формула""
	             |		КОГДА ЗаданиеНаОтгрузкуЗаказыПокупателей.ЗаказПокупателя.Контрагент.Код = &КодKV
	             |			ТОГДА ""Корп.Волга""
	             |		ИНАЧЕ ""Яршинторг""
	             |	КОНЕЦ КАК МестоПодачи,
	             |	ЗаданиеНаОтгрузкуЗаказыПокупателей.Ссылка.Водитель,
	             |	ЗаданиеНаОтгрузкуЗаказыПокупателей.Ссылка.ГосНомерАвтомобиля,
	             |	ЗаданиеНаОтгрузкуЗаказыПокупателей.Ссылка.МаркаАвтомобиля,
	             |	ЗаданиеНаОтгрузкуЗаказыПокупателей.Ссылка.Перевозчик,
	             |	ЗаданиеНаОтгрузкуЗаказыПокупателей.Ссылка.Направление,
	             |	ВЫБОР
				 |	 КОГДА ЗаданиеНаОтгрузкуЗаказыПокупателей.ЗаказПокупателя.ДоговорКонтрагента.ТипДоговора = &ВидФАп
				 |			ТОГДА ЗаданиеНаОтгрузкуЗаказыПокупателей.Реализация.Номер
	             |		ИНАЧЕ """"""""
	             |	КОНЕЦ КАК НомерФАп,
				  |	ВЫБОР
				 |	 КОГДА ЗаданиеНаОтгрузкуЗаказыПокупателей.ЗаказПокупателя.ДоговорКонтрагента.ТипДоговора = &ВидШТ
				 |			ТОГДА ЗаданиеНаОтгрузкуЗаказыПокупателей.Реализация.Номер
	             |		ИНАЧЕ """"""""
	             |	КОНЕЦ КАК НомерШТ,
				 
				 |	выбор	КОГДА ЗаданиеНаОтгрузкуЗаказыПокупателей.ЗаказПокупателя.ДоговорКонтрагента.ТипДоговора = &ВидФА
				 |			ТОГДА ЗаданиеНаОтгрузкуЗаказыПокупателей.Реализация.Номер
	             |		ИНАЧЕ """"""""
	             |	КОНЕЦ КАК НомерФА,
				 
	             
	             |	ВЫБОР
	             |		КОГДА ЗаданиеНаОтгрузкуЗаказыПокупателей.ЗаказПокупателя.Контрагент.Код = &КодАЭ
	             |			ТОГДА ЗаданиеНаОтгрузкуЗаказыПокупателей.Реализация.Номер
	             |		ИНАЧЕ """"""""
	             |	КОНЕЦ КАК НомерАЭ,
	             |	ВЫБОР
	             |		КОГДА ЗаданиеНаОтгрузкуЗаказыПокупателей.ЗаказПокупателя.Контрагент.Код = &КодFa
	             |			ТОГДА ЗаданиеНаОтгрузкуЗаказыПокупателей.Реализация.Номер
	             |		ИНАЧЕ """"""""
	             |	КОНЕЦ КАК НомерFa,
	             |	ВЫБОР
	             |		КОГДА ЗаданиеНаОтгрузкуЗаказыПокупателей.ЗаказПокупателя.Контрагент.Код = &КодKV
	             |			ТОГДА ЗаданиеНаОтгрузкуЗаказыПокупателей.Реализация.Номер
	             |		ИНАЧЕ """"""""
	             |	КОНЕЦ КАК НомерKV,
	             |	ВЫБОР
	             |		КОГДА НЕ(ЗаданиеНаОтгрузкуЗаказыПокупателей.ЗаказПокупателя.Контрагент.Код = &КодАЭ
	             |					И НЕ ЗаданиеНаОтгрузкуЗаказыПокупателей.ЗаказПокупателя.ДоговорКонтрагента.ТипДоговора = &ВидФА)
	             |			ТОГДА ЗаданиеНаОтгрузкуЗаказыПокупателей.Реализация.Номер
	             |		ИНАЧЕ """"""""
	             |	КОНЕЦ КАК НомерЯШТ
	             |ИЗ
	             |	Документ.ЗаданиеНаОтгрузку.ЗаказыПокупателей КАК ЗаданиеНаОтгрузкуЗаказыПокупателей
	             |ГДЕ
	             |	ЗаданиеНаОтгрузкуЗаказыПокупателей.Ссылка = &Ссылка
	             |ИТОГИ ПО
	             |	МестоПодачи";
	Запрос.УстановитьПараметр("Ссылка",СсылкаНаОбъект);
	 ВидФА = Справочники.ТипыДоговоров.НайтиПоНаименованию("Формула Авто");
	 ВидФАп = Справочники.ТипыДоговоров.ФормулаАвтоПлюс;
	 ВидШТ = Справочники.ТипыДоговоров.ШинтрейдЯрославль;
	 
	Запрос.УстановитьПараметр("ВидФА", ВидФА);
	Запрос.УстановитьПараметр("ВидФАп",ВидФАп);
	Запрос.УстановитьПараметр("ВидШТ", ВидШТ);
	
	//Запрос.УстановитьПараметр("ФАп",справочники.Контрагенты.НайтиПоКоду("92797") );  //+++
	Запрос.УстановитьПараметр("КодАЭ", "П000382");
	Запрос.УстановитьПараметр("КодFa", "93980");
	Запрос.УстановитьПараметр("КодKV", "92242");
	Рез=Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	
	
	 Пп = 0; N = рез.Количество();
	 
	 
	Пока Рез.Следующий() Цикл
		СуммаФА=0;  ПП = Пп+1;
		Детали=Рез.Выбрать();
		
			ДокументПрихода="";
			ДокументРасхода="";
			МежскладскиеПеремещения="";

		Пока Детали.Следующий() Цикл
			
			Если Рез.МестоПодачи = "Формула Авто" тогда
				ДеталиРеализацияНомер = Детали.НомерФА;
			ИначеЕсли Рез.МестоПодачи = "Формула Авто Плюс" тогда
				ДеталиРеализацияНомер = Детали.НомерФАп;
			ИначеЕсли Рез.МестоПодачи = "Шинтрейд" тогда
				ДеталиРеализацияНомер = Детали.НомерШТ;
				
			ИначеЕсли Рез.МестоПодачи = "АвтоЭксперт" тогда
				ДеталиРеализацияНомер = Детали.НомерАЭ;
			ИначеЕсли Рез.МестоПодачи = "Формула" тогда
				ДеталиРеализацияНомер = Детали.НомерFa;
			ИначеЕсли Рез.МестоПодачи = "Корп.Волга" тогда
				ДеталиРеализацияНомер = Детали.НомерKV;
			Иначе // ЯШТ
				ДеталиРеализацияНомер = Детали.НомерЯШТ;
			КонецЕсли;		
				
			если типЗнч(Детали.Реализация)=тип("ДокументСсылка.ПеремещениеТоваров") тогда
				МежскладскиеПеремещения = СокрЛП(МежскладскиеПеремещения)+СокрЛП(ДеталиРеализацияНомер)+СокрЛП(Детали.РеализацияНал)+", ";
			иначе	
				ДокументРасхода=СокрЛп(ДокументРасхода+ДеталиРеализацияНомер) + СокрЛп(Детали.РеализацияНал)+", ";
			КонецЕсли;	
			
			СрокПодачи = Детали.РеализацияДата;
			
			МаркаИНомерМашины=""+СокрЛП(Детали.МаркаАвтомобиля)+" "+СокрЛП(Детали.ГосНомерАвтомобиля);
			СведенияОПеревозчике=Детали.Перевозчик
			//+Символы.ПС+"водитель: "+Детали.Водитель
			;
			
			Маршрут = Детали.Направление;
		КонецЦикла;
		
		//Если Рез.МестоПодачи="Формула-Авто" тогда
			Запрос2=Новый Запрос;
			Запрос2.Текст="ВЫБРАТЬ
			              |	ЕСТЬNULL(ИнформацияПоПроезду.ДоставкаВЦене, 0) КАК СуммаВЦене,
			              |	ЕСТЬNULL(ИнформацияПоПроезду.ДоставкаНал, 0) КАК СуммаНАЛ,
			              |	ЕСТЬNULL(ИнформацияПоПроезду.ДоставкаБНал, 0) КАК СуммаБНал,
			              |	ЕСТЬNULL(ИнформацияПоПроезду.Объём, 0) КАК Объём,
			              |	ИнформацияПоПроезду.Заказ
			              |ИЗ
			              |	РегистрСведений.ИнформацияПоПроезду КАК ИнформацияПоПроезду
			              |ГДЕ
			              |	ИнформацияПоПроезду.Задание = &Задание
			              |	И (ИнформацияПоПроезду.Организация = &Организация
			              |			ИЛИ ВЫБОР
			              |				КОГДА ИнформацияПоПроезду.Заказ.ДоговорКонтрагента.ТипДоговора = &ВидФА
			              |					ТОГДА ""Формула Авто""
			              |				КОГДА ИнформацияПоПроезду.Заказ.ДоговорКонтрагента.ТипДоговора = &ВидФАп
			              |					ТОГДА ""Формула Авто Плюс""
			              |				КОГДА ИнформацияПоПроезду.Заказ.ДоговорКонтрагента.ТипДоговора = &ВидШТ
			              |					ТОГДА ""Шинтрейд""
			              |				КОГДА ИнформацияПоПроезду.Заказ.Контрагент.Код = &КодАЭ
			              |					ТОГДА ""Автоэксперт""
			              |				КОГДА ИнформацияПоПроезду.Заказ.Контрагент.Код = &КодFa
			              |					ТОГДА ""Формула""
			              |				КОГДА ИнформацияПоПроезду.Заказ.Контрагент.Код = &КодKV
			              |					ТОГДА ""Корп.Волга""
			              |				ИНАЧЕ ""Яршинторг""
			              |			КОНЕЦ = &Организация)";
						  Запрос2.УстановитьПараметр("Задание",СсылкаНаОбъект);
						  Запрос2.УстановитьПараметр("Организация",  Рез.МестоПодачи); //отбор по каждой
						//  Запрос2.УстановитьПараметр("ФАп",справочники.Контрагенты.НайтиПоКоду("92797") );  //+++
			  			  Запрос2.УстановитьПараметр("ВидФА",ВидФА );
						  Запрос2.УстановитьПараметр("ВидФАп",ВидФАп );
						  Запрос2.УстановитьПараметр("ВидШТ",ВидШТ );
						  Запрос2.УстановитьПараметр("КодАЭ", "П000382");
					 	  Запрос2.УстановитьПараметр("КодFa", "93980");
						  Запрос2.УстановитьПараметр("КодKV", "92242");
			РезФА=Запрос2.Выполнить().Выгрузить();
			
			
		  СуммаТР = 0; СуммаНал=0; СуммаБНал = 0; Объём = 0;
		если РезФА.Количество()>0 Тогда
		  	СуммаТР   = РезФА.Итог("СуммаНал") + РезФА.Итог("СуммаБНал") + РезФА.Итог("СуммаВЦене");
			СуммаНал  = РезФА.Итог("СуммаНал");
			СуммаБНал = РезФА.Итог("СуммаБНал");
			Объём     = РезФА.Итог("Объём");
		КонецЕсли;
		
		СуммаЯр = 0; СуммаПитер = 0; СуммаЕКБ = 0; СуммаРСТ = 0; СуммаМСК = 0; СуммаИМ = 0; СуммаДиски = 0; СуммаОтРазв = 0; СуммаТен = 0; СуммаЗак = 0;
		
	Если СсылкаНаОбъект.Дата>='20180101' тогда  //+++ 17.04.2018 - распределение по подразделениям бюджета
		назвПоПодразделениям = "по подразделениям:";
		   таблПодразделений = новый ТаблицаЗначений;
		   таблПодразделений.Колонки.Добавить("Подразделение");
		   таблПодразделений.Колонки.Добавить("Сумма");
		    таблПодразделений.Колонки.Добавить("СуммаКлиенту");

		   Для каждого стр11 из РезФА Цикл
		   сумма1 = стр11.СуммаВЦене;
		   сумма2 =  стр11.СуммаНал + стр11.СуммаБНал;
		   Подразделение1 = ?(стр11.Заказ.ДоговорКонтрагента.ОтветственноеЛицо.ПодразделениеБюджет.Пустая(), 
		   						стр11.Заказ.ДоговорКонтрагента.ОтветственноеЛицо.ОсновноеПодразделение,
								стр11.Заказ.ДоговорКонтрагента.ОтветственноеЛицо.ПодразделениеБюджет);
		   стр1 = таблПодразделений.Найти(Подразделение1,"Подразделение");
		   Если стр1 = неопределено тогда
			   стр1 = таблПодразделений.Добавить();
			   стр1.Подразделение = Подразделение1;
			   стр1.Сумма = сумма1;
			   стр1.СуммаКлиенту = сумма2;
		   Иначе
			   стр1.Сумма = стр1.Сумма + сумма1;
			   стр1.СуммаКлиенту = стр1.СуммаКлиенту + сумма2;
		   КонецЕсли;	   
	    КонецЦикла;
	    ЗатратыПоПодразделениям = "";
		Для каждого стр11 из таблПодразделений Цикл
		ЗатратыПоПодразделениям = ЗатратыПоПодразделениям + "Затраты на "+строка(стр11.Подразделение)+": " + Строка(Формат(стр11.Сумма,"ЧДЦ=2"))+ " руб." + Символы.ПС
		+?(стр11.СуммаКлиенту>0,"     и перевыставляемые клиентам(нал/бнал): "+ Строка(Формат(стр11.СуммаКлиенту,"ЧДЦ=2"))+ " руб."+ Символы.ПС,"");
		КонецЦикла;
	
			
	Иначе //ПО Старому - по направлениям продаж!
		назвПоПодразделениям = "по направлениям:";
		Для каждого стр11 из РезФА Цикл
			Если стр11.Заказ.Контрагент = Справочники.Контрагенты.НайтиПоКоду("94036") Тогда   //ЕКБ
				СуммаЕКБ = СуммаЕКБ + стр11.СуммаНал + стр11.СуммаБНал + стр11.СуммаВЦене;
			ИначеЕсли стр11.Заказ.Контрагент = Справочники.Контрагенты.НайтиПоКоду("П000835") Тогда //питер
				СуммаПитер = СуммаПитер + стр11.СуммаНал + стр11.СуммаБНал + стр11.СуммаВЦене;
			ИначеЕсли стр11.Заказ.Контрагент = Справочники.Контрагенты.НайтиПоКоду("93187") Тогда //Ростов
				СуммаРСТ = СуммаРСТ + стр11.СуммаНал + стр11.СуммаБНал + стр11.СуммаВЦене;
			ИначеЕсли стр11.Заказ.Контрагент = Справочники.Контрагенты.НайтиПоКоду("93870") Тогда  //Мск
				СуммаМСК = СуммаМСК + стр11.СуммаНал + стр11.СуммаБНал + стр11.СуммаВЦене;
			ИначеЕсли ЗначениеЗаполнено(стр11.Заказ.Контрагент.КонтрагентДляРезерваИМ) Тогда   //ИМ
				СуммаИМ = СуммаИМ + стр11.СуммаНал + стр11.СуммаБНал + стр11.СуммаВЦене;
			иначеЕсли Число(Лев(стр11.Заказ.ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж.Наименование,2)) > 0 
				и Число(Лев(стр11.Заказ.ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж.Наименование,2)) < 9 Тогда    //ОтделРазвития
				СуммаОтРазв = СуммаОтРазв + стр11.СуммаНал + стр11.СуммаБНал + стр11.СуммаВЦене;
			иначеЕсли Число(Лев(стр11.Заказ.ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж.Наименование,2)) = 9  Тогда    //Отдел Тендеры
				СуммаТен = СуммаТен + стр11.СуммаНал + стр11.СуммаБНал + стр11.СуммаВЦене;
			иначеЕсли Число(Лев(стр11.Заказ.ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж.Наименование,2)) = 13  
				или Число(Лев(стр11.Заказ.ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж.Наименование,2)) = 15 Тогда    //Отдел Закупки
				СуммаЗак = СуммаЗак + стр11.СуммаНал + стр11.СуммаБНал + стр11.СуммаВЦене;
			иначеЕсли Число(Лев(стр11.Заказ.ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж.Наименование,2)) = 14  Тогда    //Отдел Диски
				СуммаДиски = СуммаДиски + стр11.СуммаНал + стр11.СуммаБНал + стр11.СуммаВЦене;
			иначеЕсли Число(Лев(стр11.Заказ.ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж.Наименование,2)) = 16  Тогда    //ИМ
				СуммаИМ = СуммаИМ + стр11.СуммаНал + стр11.СуммаБНал + стр11.СуммаВЦене;
			иначеЕсли Число(Лев(стр11.Заказ.ДоговорКонтрагента.ОтветственноеЛицо.НаправлениеПродаж.Наименование,2)) = 17  Тогда    //ИМ
				СуммаОтРазв = СуммаОтРазв + стр11.СуммаНал + стр11.СуммаБНал + стр11.СуммаВЦене;
			иначе                                                                          //ЯР
				СуммаОтРазв = СуммаОтРазв + стр11.СуммаНал + стр11.СуммаБНал + стр11.СуммаВЦене;
			КонецЕсли;
		КонецЦикла;
		
		ЗатратыПоПодразделениям = ?(СуммаЯр>0,"Затраты по подразделению Ярославль: " + Строка(Формат(СуммаЯр,"ЧДЦ=2"))+ " руб." + Символы.ПС,"") 
		+ ?(СуммаЗак>0,"Затраты по отделу Закупки: " + Строка(Формат(СуммаЗак,"ЧДЦ=2"))+ " руб." + Символы.ПС,"")
		+ ?(СуммаДиски>0,"Затраты по отделу Диски: " + Строка(Формат(СуммаДиски,"ЧДЦ=2"))+ " руб." + Символы.ПС,"")
		+ ?(СуммаТен>0,"Затраты по отделу Тендеры: " + Строка(Формат(СуммаТен,"ЧДЦ=2"))+ " руб." + Символы.ПС,"")
		+ ?(СуммаОтРазв>0,"Затраты по отделу Развития: " + Строка(Формат(СуммаОтРазв,"ЧДЦ=2"))+ " руб." + Символы.ПС,"")
		+ ?(СуммаПитер>0,"Затраты по подразделению Санкт-Петербург: " + Строка(Формат(СуммаПитер,"ЧДЦ=2"))+ " руб." + Символы.ПС,"")
		+ ?(СуммаЕКБ>0,"Затраты по подразделению Екатеринбург: " + Строка(Формат(СуммаЕКБ,"ЧДЦ=2"))+ " руб." + Символы.ПС,"")
		+ ?(СуммаРСТ>0,"Затраты по подразделению Ростов на Дону: " + Строка(Формат(СуммаРСТ,"ЧДЦ=2"))+ " руб." + Символы.ПС,"")
		+ ?(СуммаМСК>0,"Затраты по подразделению Москва: " + Строка(Формат(СуммаМСК,"ЧДЦ=2"))+ " руб." + Символы.ПС,"")
		+ ?(СуммаИМ>0,"Затраты по подразделению Интернет-Магазин: " + Строка(Формат(СуммаИМ,"ЧДЦ=2"))+ " руб." + Символы.ПС,"");
	КонецЕсли;	
		
		ОбластьМакета = Макет.ПолучитьОбласть("Заголовок");
		//ОбШтрихКод=ОбластьМакета.Рисунки.Штрихкод.Объект;
		//ОбШтрихКод.ТипКода = 4; 
		//ОбШтрихКод.Сообщение = СформироватьШКРеализации(СсылкаНаОбъект,"8");//XMLСтрока(ЭтотОбъект.Ссылка.УникальныйИдентификатор()); 
		//ОбШтрихКод.ОтображатьТекст = Ложь;
		
		
		
		ОбластьМакета.Параметры.Пп = ?(N>1, " ("+строка(Пп)+"/"+строка(N)+")", "");
		ОбластьМакета.Параметры.НомерЧ = строка( число(Прав(СсылкаНаОбъект.Номер, стрДлина(СсылкаНаОбъект.Номер) - 2))); 
		ОбластьМакета.Параметры.Номер = СсылкаНаОбъект.Номер;
		ОбластьМакета.Параметры.Дата = Формат(СсылкаНаОбъект.дата,"ДЛФ=DD");
		ТабДокумент.Вывести(ОбластьМакета);
		
		ОбластьМакета = Макет.ПолучитьОбласть("Тело");
		ОбластьМакета.Параметры.Маршрут=Маршрут;
		
		ОбластьМакета.Параметры.Объём = ?(N>1,Объём, СсылкаНаОбъект.ИтогОбъем);
		ОбластьМакета.Параметры.ОбщийОбъём = СсылкаНаОбъект.ИтогОбъем;
		ОбластьМакета.Параметры.СрокПодачи= СрокПодачи;
		
		ОбластьМакета.Параметры.МестоПодачи=Рез.МестоПодачи;
		ОбластьМакета.Параметры.ДокументПрихода=ДокументПрихода;
		ОбластьМакета.Параметры.ДокументРасхода=ДокументРасхода;
		ОбластьМакета.Параметры.МежскладскиеПеремещения=МежскладскиеПеремещения;
		
		ОбластьМакета.Параметры.СведенияОПеревозчике=СведенияОПеревозчике;
		ОбластьМакета.Параметры.МаркаИНомерМашины=МаркаИНомерМашины;
		ОбластьМакета.Параметры.Водитель = СсылкаНаОбъект.Водитель;
		
		
		ОбластьМакета.Параметры.Стоимость = Формат(СуммаТР,"ЧДЦ=2; ЧН=-")+" р."
			+?(СсылкаНаОбъект.Километров=0,"", "  ( "+строка(СсылкаНаОбъект.Километров)+"км., тариф: "+формат(СсылкаНаОбъект.Тариф/СсылкаНаОбъект.Километров,"ЧДЦ=2")+"р./км. )"); //+++ 28.04.2015
			
		ОбластьМакета.Параметры.назвПоПодразделениям = назвПоПодразделениям;
		ОбластьМакета.Параметры.ПоНаправлениям = ЗатратыПоПодразделениям;	
			
			
		ОбластьМакета.Параметры.ВыставленныеСчета = ПолучитьСписокВыставленныхСчетовОтПоставщикаУслуг( Рез.МестоПодачи );  //+++ 07.05.2015
			
		нал = ПолучитьСписокПКОПокупателей(Рез.МестоПодачи);
		ОбластьМакета.Параметры.СтоимостьНал =?(нал.Текст="", Формат(СуммаНал,"ЧДЦ=2; ЧН=-")+" р.",
			?(СуммаНал - нал.Сумма=0, нал.Текст, нал.Текст+" НЕ сдано: "+Формат(СуммаНал - нал.Сумма,"ЧДЦ=2; ЧН=-")+" р." )
											   )
											   ;
		
		//+++ 18.05.2015
		Бнал = ПолучитьСписокПереВыставленныхСчетовПокупателям( Рез.МестоПодачи ); 
		ОбластьМакета.Параметры.СтоимостьБНал=?(Бнал.текст="", формат(СуммаБНал,"ЧДЦ=2; ЧН=-")+" р.",
			?(СуммаБНал - Бнал.Сумма=0, БНал.Текст, Бнал.Текст+" НЕ выставлено: "+Формат(СуммаБНал - Бнал.Сумма,"ЧДЦ=2; ЧН=-")+" р." ) 
												)
												;
		ВЦене = ПолучитьСписокИзРегистра( Рез.МестоПодачи , "ВЦене");
		разн = СуммаТР - СуммаНал - СуммаБНал - ВЦене.Сумма;
		ОбластьМакета.Параметры.СтоимостьВЦене =?(ВЦене.текст = "",  формат(СуммаТР - СуммаНал - СуммаБНал,"ЧДЦ=2; ЧН=-")+" р.",
			?(разн=0, ВЦене.текст, ВЦене.текст+" В цене: "+ формат(разн, "ЧДЦ=2; ЧН=-")+" р." )
												 )
												 ;
		
		
		ОбластьМакета.Параметры.Исполнитель = ПараметрыСеанса.ТекущийПользователь;
		датаВремя1 = ТекущаяДата(); //СсылкаНаОбъект.ВремяНапоминания;
		ОбластьМакета.Параметры.СрокОформления	= формат(датаВремя1,"ДФ='dd.MM.yyyy hh:mm");
        ОбластьМакета.Параметры.ОтвМенеджер = ""; //строка(ссылкаНаОбъект.ОтвМенеджер);

		ТабДокумент.Вывести(ОбластьМакета);
		
		ТабДокумент.ВывестиГоризонтальныйРазделительСтраниц();
		ОбШтрихКод=ТабДокумент.Рисунки.Штрихкод.Объект;
		Если ОбШтрихКод <> Неопределено Тогда		
		ОбШтрихКод.ТипКода = 4; 
		ОбШтрихКод.Сообщение = СформироватьШКРеализации(СсылкаНаОбъект,"9");//XMLСтрока(ЭтотОбъект.Ссылка.УникальныйИдентификатор()); 
		ОбШтрихКод.ОтображатьТекст = Ложь;
		конецЕсли;

		ТабДокумент.АвтоМасштаб = Истина;
	КонецЦикла;
	
	Возврат ТабДокумент;
	
КонецФункции // ПечатьСчетаЗаказа()

// общая процедура печати
функция Печать() Экспорт
	ТабДокумент = неопределено;
	Если НЕ ЗначениеЗаполнено(СсылкаНаОбъект) тогда
		#Если Клиент тогда
			Предупреждение("Не выбран документ!", 30);		
		#КонецЕсли	
		возврат Неопределено;
	КонецЕсли;
	
		ТабДокумент = ПечатьЗаявки();
			
	Возврат ТабДокумент;
	
КонецФункции

Функция ПолучитьСписокВыставленныхСчетовОтПоставщикаУслуг( Орг )

	//---------------поиск уже сущ. самого "свежего" поступления-------------------
  Запрос = Новый Запрос;
  Запрос.Текст = "ВЫБРАТЬ
                 |	ВЫБОР
                 |		КОГДА РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""%ФА+%""
				 |			ТОГДА ""Формула Авто Плюс""
                 |		КОГДА РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""%ШТ%""
				 |			ТОГДА ""Шинтрейд""
                 |		КОГДА РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""%ФА%""
				 |		и (не РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""% ФАКТОРИНГ%"")
                 |		и (не РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""% ФА+%"")
                 |			ТОГДА ""Формула Авто""
				 
                 |		КОГДА РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""% АЭ""
                 |			ТОГДА ""АвтоЭксперт""
                 |		КОГДА РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""% Fa""
                 |			ТОГДА ""Формула""
                 |		КОГДА РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""% KV""
                 |			ТОГДА ""Корп.Волга""
				 
                 |		ИНАЧЕ ""Яршинторг""
                 |	КОНЕЦ КАК Организация,
                 |	РеализацияТоваровУслуг.СуммаДокумента КАК Сумма,
                 |	РеализацияТоваровУслуг.Ссылка КАК Счет,
				 |	РеализацияТоваровУслуг.Контрагент как Перевозчик,
				 |	&ПустойСписок как СписокРеализаций
                 |ИЗ
                 |	Документ.ПоступлениеТоваровУслуг КАК РеализацияТоваровУслуг
                 |ГДЕ
                 |	РеализацияТоваровУслуг.Дата >= &Дата0
                 //+++ ВСЕ ФА+    |	И НЕ ПоступлениеТоваровУслуг.Ссылка.ПометкаУдаления
                 |	И РеализацияТоваровУслуг.Комментарий ПОДОБНО &Комментарий
                 |  И 	ВЫБОР
                 |		КОГДА РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""%ФА+%""
				 |			ТОГДА ""Формула Авто Плюс""
                 |		КОГДА РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""%ШТ%""
				 |			ТОГДА ""Шинтрейд""
                 |		КОГДА РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""%ФА%""
				 |		и (не РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""% ФАКТОРИНГ%"")
                 |		и (не РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""% ФА+%"")
                 |			ТОГДА ""Формула Авто""
				 
                 |		КОГДА РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""% АЭ""
                 |			ТОГДА ""АвтоЭксперт""
                 |		КОГДА РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""% Fa""
                 |			ТОГДА ""Формула""
                 |		КОГДА РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""% KV""
                 |			ТОГДА ""Корп.Волга""
				 
                 |		ИНАЧЕ ""Яршинторг""
                 |	КОНЕЦ = &Организация
				 |
                 |УПОРЯДОЧИТЬ ПО
                 |	РеализацияТоваровУслуг.Дата УБЫВ
                 |АВТОУПОРЯДОЧИВАНИЕ";
  
  Запрос.УстановитьПараметр("Дата0", НачалоДня(СсылкаНаОбъект.Дата) );  // поступление не может быть раньше Задания на отгрузку!
  ПустойСписок = неопределено;
  Запрос.УстановитьПараметр("ПустойСписок", ПустойСписок  );
  Запрос.УстановитьПараметр("Организация", Орг );  // поступление не может быть раньше Задания на отгрузку!
  //Запрос.УстановитьПараметр("Контрагент", Контр );  // поступление не может быть раньше Задания на отгрузку!
  //Запрос.УстановитьПараметр("ДоговорКонтрагента", ДогКонтр );  // поступление не может быть раньше Задания на отгрузку!
  Запрос.УстановитьПараметр("Комментарий","%Задание "+СсылкаНаОбъект.Номер+"%");
  Результат = Запрос.Выполнить();
   суммаОрг = Результат.Выбрать();
   
  текстНакладных = "";
  пока суммаОрг.Следующий() цикл
	текстНакладных =  текстНакладных          //+++ номер счета Перевозчика!
	+?(СокрЛП(суммаОрг.Счет.НомерВходящегоДокумента)="", 
	 "Поступление услуг "+суммаОрг.Счет.Номер+" от "+строка(суммаОрг.Счет.Дата), 
	 "Счет № "+СокрЛП(суммаОрг.Счет.НомерВходящегоДокумента) +" от "+формат(суммаОрг.Счет.ДатаВходящегоДокумента,"ДЛФ=D") 
	   )
	//+" от "+СокрЛП(суммаОрг.Счет.Контрагент.НаименованиеПолное)
	+" ("+формат(суммаОрг.Сумма,"ЧДЦ=2")+"р.)"; 
	
 КонецЦикла;	 
  //текстНакладных = лев(текстНакладных, стрДлина(текстНакладных) - 2);
	
 возврат текстНакладных;
 
КонецФункции

функция ПолучитьСписокПереВыставленныхСчетовПокупателям( Орг )
 Запрос = Новый Запрос;
  Запрос.Текст = "ВЫБРАТЬ
                 |	ВЫБОР
                 |		КОГДА РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""%ФА+%""
				 |			ТОГДА ""Формула Авто Плюс""
                 |		КОГДА РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""%ШТ%""
				 |			ТОГДА ""Шинтрейд""
                 |		КОГДА РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""%ФА%""
				 |		и (не РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""% ФАКТОРИНГ%"")
                 |		и (не РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""% ФА+%"")
                 |			ТОГДА ""Формула Авто""
				 
                 |		КОГДА РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""% АЭ""
                 |			ТОГДА ""АвтоЭксперт""
                 |		КОГДА РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""% Fa""
                 |			ТОГДА ""Формула""
                 |		КОГДА РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""% KV""
                 |			ТОГДА ""Корп.Волга""
				 
                 |		ИНАЧЕ ""Яршинторг""
                 |	КОНЕЦ КАК Организация,
                 |	РеализацияТоваровУслуг.СуммаДокумента КАК Сумма,
                 |	РеализацияТоваровУслуг.Контрагент,
                 |	РеализацияТоваровУслуг.Номер
                 |ИЗ
                 |	Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
                 |ГДЕ
                 |	РеализацияТоваровУслуг.Дата >= &Дата0
                 |	И НЕ РеализацияТоваровУслуг.Ссылка.ПометкаУдаления
                 |	И РеализацияТоваровУслуг.Комментарий ПОДОБНО &Комментарий
				 //------------------только БНАЛ реализации!------------------------------------
				 |	И НЕ (РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""%*%"")
                 |	И ВЫБОР
                 |		КОГДА РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""%ФА+%""
				 |			ТОГДА ""Формула Авто Плюс""
                 |		КОГДА РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""%ШТ%""
				 |			ТОГДА ""Шинтрейд""
                 |		КОГДА РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""%ФА%""
				 |		и (не РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""% ФАКТОРИНГ%"")
                 |		и (не РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""% ФА+%"")
                 |			ТОГДА ""Формула Авто""
				 
                 |		КОГДА РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""% АЭ""
                 |			ТОГДА ""АвтоЭксперт""
                 |		КОГДА РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""% Fa""
                 |			ТОГДА ""Формула""
                 |		КОГДА РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""% KV""
                 |			ТОГДА ""Корп.Волга""
				 
                 |		ИНАЧЕ ""Яршинторг""
                 |	КОНЕЦ = &Организация
                 |
                 |УПОРЯДОЧИТЬ ПО
                 |	РеализацияТоваровУслуг.Дата УБЫВ
                 |АВТОУПОРЯДОЧИВАНИЕ";
  
  Запрос.УстановитьПараметр("Дата0", НачалоДня(СсылкаНаОбъект.Дата) );  // поступление не может быть раньше Задания на отгрузку!
  Запрос.УстановитьПараметр("Организация", Орг );  // поступление не может быть раньше Задания на отгрузку!
  Запрос.УстановитьПараметр("Комментарий","%Задание "+СсылкаНаОбъект.Номер+"%");
  Результат = Запрос.Выполнить();
  СписДок = Результат.Выбрать();
   
  текстНакладных = новый структура;
  текстНакладных.Вставить("Текст", "");
  текстНакладных.Вставить("Сумма", 0);
  
  пока СписДок.Следующий() цикл
	текстНакладных.Текст = текстНакладных.Текст          //+++ номер счета Перевозчика!
	+"счет № "+строка(списДок.Номер)+" на "+строка(СписДок.Контрагент)+" ("+строка(СписДок.Сумма) + "р.);
	|";
	текстНакладных.Сумма =  текстНакладных.Сумма + СписДок.Сумма;
  КонецЦикла;

 Если текстНакладных.Текст ="" тогда
	текстНакладных = ПолучитьСписокИзРегистра(Орг, "БНал");
 КонецЕсли;
 	
 возврат текстНакладных;
 
КонецФункции

функция ПолучитьСписокПКОПокупателей( Орг )
 Запрос = Новый Запрос;
  Запрос.Текст = "ВЫБРАТЬ
                 |	ВЫБОР
                 |		КОГДА РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""%ФА+%""
				 |			ТОГДА ""Формула Авто Плюс""
                 |		КОГДА РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""%ШТ%""
				 |			ТОГДА ""Шинтрейд""
                 |		КОГДА РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""%ФА%""
				 |		и (не РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""% ФАКТОРИНГ%"")
                 |		и (не РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""% ФА+%"")
                 |			ТОГДА ""Формула Авто""
				 
                 |		КОГДА РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""% АЭ""
                 |			ТОГДА ""АвтоЭксперт""
                 |		КОГДА РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""% Fa""
                 |			ТОГДА ""Формула""
                 |		КОГДА РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""% KV""
                 |			ТОГДА ""Корп.Волга""
				 
                 |		ИНАЧЕ ""Яршинторг""
                 |	КОНЕЦ КАК Организация,
                 |	РеализацияТоваровУслуг.СуммаДокумента КАК Сумма,
                 |	РеализацияТоваровУслуг.Контрагент,
                 |	РеализацияТоваровУслуг.Номер
                 |ИЗ
                 |	Документ.ПриходныйКассовыйОрдер КАК РеализацияТоваровУслуг
                 |ГДЕ
                 |	РеализацияТоваровУслуг.Дата >= &Дата0
                 |	И НЕ РеализацияТоваровУслуг.Ссылка.ПометкаУдаления
                 |	И РеализацияТоваровУслуг.Комментарий ПОДОБНО &Комментарий
                 |	И ВЫБОР
                 |		КОГДА РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""%ФА+%""
				 |			ТОГДА ""Формула Авто Плюс""
                 |		КОГДА РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""%ШТ%""
				 |			ТОГДА ""Шинтрейд""
                 |		КОГДА РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""%ФА%""
				 |		и (не РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""% ФАКТОРИНГ%"")
                 |		и (не РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""% ФА+%"")
                 |			ТОГДА ""Формула Авто""
				 
                 |		КОГДА РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""% АЭ""
                 |			ТОГДА ""АвтоЭксперт""
                 |		КОГДА РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""% Fa""
                 |			ТОГДА ""Формула""
                 |		КОГДА РеализацияТоваровУслуг.ДоговорКонтрагента.Наименование ПОДОБНО ""% KV""
                 |			ТОГДА ""Корп.Волга""
				 
                 |		ИНАЧЕ ""Яршинторг""
                 |	КОНЕЦ = &Организация
                 |
                 |УПОРЯДОЧИТЬ ПО
                 |	РеализацияТоваровУслуг.Дата УБЫВ
                 |АВТОУПОРЯДОЧИВАНИЕ";
  
  Запрос.УстановитьПараметр("Дата0", НачалоДня(СсылкаНаОбъект.Дата) );  // поступление не может быть раньше Задания на отгрузку!
  Запрос.УстановитьПараметр("Организация", Орг );  // поступление не может быть раньше Задания на отгрузку!
  Запрос.УстановитьПараметр("Комментарий","%Задание "+СсылкаНаОбъект.Номер+"%");
  Результат = Запрос.Выполнить();
  СписДок = Результат.Выбрать();
   
 текстНакладных = новый структура;
  текстНакладных.Вставить("Текст", "");
  текстНакладных.Вставить("Сумма", 0);

  пока СписДок.Следующий() цикл
	текстНакладных.Текст = текстНакладных.Текст          //+++ номер счета Перевозчика!
	+"Чек № "+строка(списДок.Номер)+" на "+строка(СписДок.Контрагент)+" ("+строка(СписДок.Сумма) + "р.);
	|";
	текстНакладных.сумма = текстНакладных.Сумма + СписДок.Сумма;
 КонецЦикла;	 
 
 Если текстНакладных.Текст ="" тогда
	текстНакладных = ПолучитьСписокИзРегистра(Орг, "Нал");
 КонецЕсли;
 
 возврат текстНакладных;
 
КонецФункции


функция ПолучитьСписокИзРегистра(Организация="ЯШТ", типСписка = "Нал")
	
 текстНакладных = новый структура;
 текстНакладных.Вставить("Текст", "");
 текстНакладных.Вставить("Сумма", 0);                    
  Запрос = Новый Запрос;
  Запрос.Текст = "ВЫБРАТЬ
                 |	ИнформацияПоПроезду.НомерОчереди КАК НомерОчереди,
                 |	ИнформацияПоПроезду.Контрагент,
                 |	ИнформацияПоПроезду.Менеджер,
                 |	СУММА(ИнформацияПоПроезду.Доставка"+типСписка+") КАК Сумма
                 |ИЗ
                 |	РегистрСведений.ИнформацияПоПроезду КАК ИнформацияПоПроезду
                 |ГДЕ
                 |	ИнформацияПоПроезду.Задание = &Задание
                 |	И ИнформацияПоПроезду.Организация = &Организация
                 |	И ИнформацияПоПроезду.НомерОчереди > 0
                 |	И ИнформацияПоПроезду.Доставка"+типСписка+" > 0
                 |
                 |СГРУППИРОВАТЬ ПО
                 |	ИнформацияПоПроезду.НомерОчереди,
                 |	ИнформацияПоПроезду.Менеджер,
                 |	ИнформацияПоПроезду.Контрагент
                 |
                 |УПОРЯДОЧИТЬ ПО
                 |	НомерОчереди
                 |АВТОУПОРЯДОЧИВАНИЕ";
  
  Запрос.УстановитьПараметр("Задание", СсылкаНаОбъект.Ссылка);
  Запрос.УстановитьПараметр("Организация", Организация);
  
  Результат = Запрос.Выполнить();
  Выборка = Результат.Выбрать();
  
  Пока Выборка.Следующий() Цикл
  текстНакладных.текст = текстНакладных.текст + строка(выборка.НомерОчереди)+") "+строка(выборка.Сумма)+" р. - "+строка(выборка.Контрагент)
  +" ("+строка(выборка.Менеджер)+")
  |";
  текстНакладных.Сумма = текстНакладных.Сумма + выборка.Сумма;
  КонецЦикла;                                                  
 
  возврат текстНакладных;
  
КонецФункции	
	