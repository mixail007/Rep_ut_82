
Функция Печать() Экспорт
	
	
	Стоимость=0;
	ДопКолонка = Константы.ДополнительнаяКолонкаПечатныхФормДокументов.Получить();
	Если ДопКолонка = Перечисления.ДополнительнаяКолонкаПечатныхФормДокументов.Артикул Тогда
		ТоварКод = "Артикул";
	Иначе
		ТоварКод = "Код";
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ДатаСреза",          СсылкаНаОбъект.Дата);
	Запрос.УстановитьПараметр("СтруктурнаяЕдиница", СсылкаНаОбъект.СкладОтправитель);
	Запрос.УстановитьПараметр("ТекущийДокумент",    СсылкаНаОбъект);
	Запрос.УстановитьПараметр("ПустойКонтрагент",   Справочники.Контрагенты.ПустаяСсылка());
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	РеализацияТоваровУслуг.Номер,
	|	РеализацияТоваровУслуг.Дата КАК ДатаДокумента,
	|	РеализацияТоваровУслуг.Организация,
	|	РеализацияТоваровУслуг.Организация КАК ЮрФизЛицо,
	|	РеализацияТоваровУслуг.Организация КАК Поставщик,
	|	РеализацияТоваровУслуг.Организация КАК Руководители,
	|	РеализацияТоваровУслуг.СкладПолучатель.Комментарий КАК АдресДоставки,
	|	ОтветственныеЛица.ФизическоеЛицо КАК ОтветственноеЛицо,
	|	ЕСТЬNULL(РеализацияТоваровУслуг.ВнутреннийЗаказ.ДокументОснование.Контрагент, ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)) КАК Контрагент,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслуг.ВнутреннийЗаказ.ДокументОснование = NULL
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|		ИНАЧЕ ВЫБОР
	|				КОГДА РеализацияТоваровУслуг.ВнутреннийЗаказ.ДокументОснование.Грузополучатель = &ПустойКонтрагент
	|					ТОГДА РеализацияТоваровУслуг.ВнутреннийЗаказ.ДокументОснование.Контрагент
	|				ИНАЧЕ РеализацияТоваровУслуг.ВнутреннийЗаказ.ДокументОснование.Грузополучатель
	|			КОНЕЦ
	|	КОНЕЦ КАК Покупатель
	|ИЗ
	|	Документ.ПеремещениеТоваров КАК РеализацияТоваровУслуг
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ОтветственныеЛица.СрезПоследних(&ДатаСреза, СтруктурнаяЕдиница = &СтруктурнаяЕдиница) КАК ОтветственныеЛица
	|		ПО (ОтветственныеЛица.СтруктурнаяЕдиница = РеализацияТоваровУслуг.СкладОтправитель)
	|ГДЕ
	|	РеализацияТоваровУслуг.Ссылка = &ТекущийДокумент";
	
	Шапка = Запрос.Выполнить().Выбрать();
	Шапка.Следующий();
	
	
	ТабДокумент  = Новый ТабличныйДокумент;
	ТабДокумент.ИмяПараметровПечати = "ПАРАМЕТРЫ_ПЕЧАТИ_ПеремещениеТоваров_СтраховоеЗаявление";
	
	Макет = ПолучитьМакет("МакетСтраховогоЗаявления");
	
	// Выводим общие реквизиты шапки
	СведенияОПоставщике       = СведенияОЮрФизЛице(Шапка.ЮрФизЛицо,        Шапка.ДатаДокумента);	
	СведенияОПокупателе       	  = СведенияОЮрФизЛице(Шапка.Покупатель,       Шапка.ДатаДокумента);
	//СведенияОГрузополучателе  = СведенияОЮрФизЛице(Шапка.Грузополучатель,  Шапка.ДатаДокумента);
	//СведенияОГрузоотправитель = СведенияОЮрФизЛице(Шапка.Грузоотправитель, Шапка.ДатаДокумента);	
	
	ОбластьМакета = Макет.ПолучитьОбласть("Шапка");
	ОбластьПодвал=Макет.ПолучитьОбласть("Подвал");
	
	ОбластьПодвал.Параметры.ДатаДокумента  = Формат(Шапка.ДатаДокумента,"ДФ=dd.MM.yyyy");
	
	ОбластьМакета.Параметры.ПредставлениеОрганизации = ОписаниеОрганизации(СведенияОПоставщике,"ПолноеНаименование,");
	ОбластьМакета.Параметры.ЮридическийАдрес = ОписаниеОрганизации(СведенияОПоставщике,"ЮридическийАдрес,");
	ОбластьМакета.Параметры.ФактическийАдрес = ОписаниеОрганизации(СведенияОПоставщике,"ФактическийАдрес,");
	ОбластьМакета.Параметры.Телефоны = ОписаниеОрганизации(СведенияОПоставщике,"Телефоны,");
	
	СписокКонтрагентов=Новый СписокЗначений;	
	Перевозчик=Справочники.Контрагенты.ПустаяСсылка();	
	Если НЕ ЗначениеНеЗаполнено(СсылкаНаОбъект.Перевозчик) Тогда
		Запрос = Новый Запрос;
		Запрос.Текст= "ВЫБРАТЬ
		|	Контрагенты.Ссылка  Перевозчик
		|ИЗ
		|	Справочник.Контрагенты КАК Контрагенты
		|	ГДЕ Ссылка.НаименованиеПолное ПОДОБНО &Перевозчик";
		
		Запрос.УстановитьПараметр("Перевозчик","%"+СсылкаНаОбъект.Перевозчик+"%");
		Выборка=Запрос.Выполнить().Выбрать();
		
		Если Выборка.Следующий() Тогда
			Перевозчик=Выборка.Перевозчик;
			СведенияОПеревозчике       = СведенияОЮрФизЛице(Выборка.Перевозчик,Шапка.ДатаДокумента);
			ОбластьМакета.Параметры.ПредставлениеПеревозчика=ОписаниеОрганизации( СведенияОПеревозчике,"ПолноеНаименование,ЮридическийАдрес,ИНН,");
			
		Иначе
			ОбластьМакета.Параметры.ПредставлениеПеревозчика="";
		КонецЕсли;		 
	КонецЕсли;  
	
	Если Не ЗначениеНеЗаполнено(Перевозчик) И СокрЛП(СсылкаНаОбъект.ГосНомерАвтомобиля)<>"" Тогда 		 
		
		ЗапросНакладные = Новый Запрос;
		ЗапросНакладные.Текст="ВЫБРАТЬ
		                      |	ПеремещениеТоваровТовары.Ссылка.Номер как Номер,
		                      |	ПеремещениеТоваровТовары.Ссылка.Ссылка,
		                      |	ПеремещениеТоваровТовары.Ссылка.Перевозчик,
		                      |	ПеремещениеТоваровТовары.Ссылка.ГосНомерАвтомобиля,
		                      |	ЕСТЬNULL(ПеремещениеТоваровТовары.Ссылка.ВнутреннийЗаказ.ДокументОснование.Контрагент, ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)) КАК Контрагент,
		                      |	СУММА(ЗаказПокупателяТовары.Цена * ПеремещениеТоваровТовары.Количество) КАК СуммаДокумента
		                      |ИЗ
		                      |	(ВЫБРАТЬ
		                      |		Тов.Ссылка КАК Ссылка,
		                      |		Тов.Номенклатура КАК Номенклатура,
		                      |		СУММА(Тов.Количество) КАК Количество
		                      |	ИЗ
		                      |		Документ.ПеремещениеТоваров.Товары КАК Тов
		                      |	ГДЕ
		                      |		НАЧАЛОПЕРИОДА(Тов.Ссылка.Дата, ДЕНЬ) = &КонДата
		                      |		И Тов.Ссылка.Перевозчик ПОДОБНО &Перевозчик
		                      |		И Тов.Ссылка.ГосНомерАвтомобиля = &ГосНомерАвтомобиля
		                      |	
		                      |	СГРУППИРОВАТЬ ПО
		                      |		Тов.Номенклатура,
		                      |		Тов.Ссылка) КАК ПеремещениеТоваровТовары
		                      |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказПокупателя.Товары КАК ЗаказПокупателяТовары
		                      |		ПО ПеремещениеТоваровТовары.Ссылка.ВнутреннийЗаказ.ДокументОснование = ЗаказПокупателяТовары.Ссылка
		                      |			И ПеремещениеТоваровТовары.Номенклатура = ЗаказПокупателяТовары.Номенклатура
		                      |
		                      |СГРУППИРОВАТЬ ПО
		                      |	ПеремещениеТоваровТовары.Ссылка.Номер,
		                      |	ПеремещениеТоваровТовары.Ссылка.Ссылка,
		                      |	ПеремещениеТоваровТовары.Ссылка.Перевозчик,
		                      |	ПеремещениеТоваровТовары.Ссылка.ГосНомерАвтомобиля,
		                      |	ЕСТЬNULL(ПеремещениеТоваровТовары.Ссылка.ВнутреннийЗаказ.ДокументОснование.Контрагент, ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка))";
		
		ЗапросНакладные.УстановитьПараметр("КонДата",НачалоДня(Шапка.ДатаДокумента));
		//ЗапросНакладные.УстановитьПараметр("Перевозчик",Перевозчик.НаименованиеПолное);
		ЗапросНакладные.УстановитьПараметр("Перевозчик","%"+СсылкаНаОбъект.Перевозчик+"%");//+++ 
		ЗапросНакладные.УстановитьПараметр("ГосНомерАвтомобиля",СсылкаНаОбъект.ГосНомерАвтомобиля);
		
		РезультатНакладные=ЗапросНакладные.Выполнить();
		ВыборкаНакладные=РезультатНакладные.Выбрать();
		
		Если НЕ РезультатНакладные.Пустой() Тогда
			Стоимость=РезультатНакладные.Выгрузить().Итог("СуммаДокумента");
			ОбластьМакета.Параметры.СтоимостьПрописью = СформироватьСуммуПрописью(Стоимость, Константы.ВалютаУправленческогоУчета.Получить());	
			
			СписокПолучателейГруза=РезультатНакладные.Выгрузить().ВыгрузитьКолонку("Контрагент");
			Для сч=0 по СписокПолучателейГруза.Количество()-1 Цикл
				Если СписокКонтрагентов.НайтиПоЗначению(СписокПолучателейГруза[сч])=Неопределено Тогда
					СписокКонтрагентов.Добавить(СписокПолучателейГруза[сч]);
					ОбластьМакета.Параметры.ПредставлениеПолучателя=Строка(ОбластьМакета.Параметры.ПредставлениеПолучателя)+","+Строка(СписокПолучателейГруза[сч].Наименование);
				КонецЕсли;
			КонецЦикла;	
			
		КонецЕсли;	
		
		
		
		ТабДокумент.Вывести(ОбластьМакета);
		
		
		Пока ВыборкаНакладные.Следующий() Цикл
			ОбластьДанные=Макет.ПолучитьОбласть("Данные");	
			ОбластьДанные.Параметры.ПредставлениеПолучателя=ВыборкаНакладные.Контрагент.НаименованиеПолное ;
			ОбластьДанные.Параметры.Номер=	ВыборкаНакладные.Номер;
			ОбластьДанные.Параметры.ДатаДокумента=Формат(Шапка.ДатаДокумента,"ДФ=dd.MM.yyyy") ;
			ТабДокумент.Вывести(ОбластьДанные);
		КонецЦикла; 
		
		Для сч=0 по СписокКонтрагентов.Количество()-1 Цикл
			
			СведенияОКонтрагенте       = СведенияОЮрФизЛице(СписокКонтрагентов[сч].Значение,Шапка.ДатаДокумента);
			
			АдресДоставикСтрока=ПолучитьАдресДоставки (СписокКонтрагентов[сч].Значение);
			
			ОбластьПодвал.Параметры.МаршрутПеревозки=Строка(ОбластьПодвал.Параметры.МаршрутПеревозки)+Символы.ПС+Строка(сч+1)+"."+?(АдресДоставикСтрока="",ОписаниеОрганизации( СведенияОКонтрагенте,"ПолноеНаименование,ФактическийАдрес,"),ОписаниеОрганизации( СведенияОКонтрагенте,"ПолноеНаименование,")+" "+АдресДоставикСтрока);
		КонецЦикла;	
		
		ОбластьПодвал.Параметры.ПринадлежностьТранспорта=СсылкаНаОбъект.Перевозчик+", "+СокрЛП(СсылкаНаОбъект.МаркаАвтомобиля)+СокрЛП(СсылкаНаОбъект.ГосНомерАвтомобиля);
		
		Для сч=0 по СписокКонтрагентов.Количество()-1 Цикл
			ОбластьПодвал.Параметры.ДатаПрибытия=Строка(ОбластьПодвал.Параметры.ДатаПрибытия)+Символы.ПС+Строка(сч+1)+"."+Строка(СписокКонтрагентов[сч].Значение)+" - "+Формат(КонецДня(Шапка.ДатаДокумента)+1,"ДФ=dd.MM.yyyy");
		КонецЦикла;	
		
		ОбластьПодвал.Параметры.СтраховаяПремия=ФОрмат(0.00085*Стоимость,"ЧДЦ=2") + "руб.";
		
		ТабДокумент.Вывести(ОбластьПодвал);
		
	Иначе
		ТабДокумент.Вывести(ОбластьМакета);
	КонецЕсли;	
	
	// Зададим параметры макета
	ТабДокумент.ПолеСверху              = 0;
	ТабДокумент.ПолеСлева               = 0;
	ТабДокумент.ПолеСнизу               = 0;
	ТабДокумент.ПолеСправа              = 0;
	ТабДокумент.РазмерКолонтитулаСверху = 0;
	ТабДокумент.РазмерКолонтитулаСнизу  = 0;
	ТабДокумент.АвтоМасштаб             = Истина;
	ТабДокумент.ОриентацияСтраницы      = ОриентацияСтраницы.Портрет;
	
	Возврат ТабДокумент;
	
КонецФункции // Печать

Функция ПолучитьАдресДоставки(КонтрагентСсылка)
	Запрос=Новый Запрос;
	Запрос.Текст="ВЫБРАТЬ
	|КонтактнаяИнформация.Объект,
	|КонтактнаяИнформация.Тип,
	|КонтактнаяИнформация.Вид,
	|КонтактнаяИнформация.Представление Представление
	|ИЗ
	|РегистрСведений.КонтактнаяИнформация КАК КонтактнаяИнформация
	|ГДЕ КонтактнаяИнформация.Объект=&Контрагент И КонтактнаяИнформация.Вид=&АдресДоставки";
	Запрос.УстановитьПараметр("Контрагент",КонтрагентСсылка);
	Запрос.УстановитьПараметр("АдресДоставки",Справочники.ВидыКонтактнойИнформации.НайтиПоКоду("00021"));
	Результат=Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат "";
	Иначе	
		Выборка=Результат.Выбрать();
		Выборка.Следующий();
		Возврат Выборка.Представление;
	КонецЕсли;	
КонецФункции	
