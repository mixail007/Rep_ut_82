ФУНКЦИЯ Печать() ЭКСПОРТ
	//ОчиститьСообщения();
	
	Если СсылкаНаОбъект.Товары.Количество()=0 Тогда
		Сообщить(нстр("ru=""Нет товаров для печати!"";
		|en=""No goods for printing!""") );
		Возврат неопределено;
	КонецЕсли;	
	
	Если СсылкаНаОбъект.Ссылка.Пустая() Тогда
		Сообщить(нстр("ru=""Для печати необходимо предварительно записать Документ!"";
		|en=""For the printing it is necessary to write down the Document previously!""") );
		Возврат неопределено;
	КонецЕсли;		
	
	ТабДок = ПечатьСтраховка();
	Если НеОтправлятьНаПочту=ложь тогда
		Если Вопрос("Отправить пользователю?",РежимДиалогаВопрос.ДаНет,20,КодВозвратаДиалога.Нет)=КодВозвратаДиалога.Да тогда
			Каталог=КаталогВременныхФайлов();
			ИмяФайла = Каталог + "\"+"Заказ " + СокрЛП(СсылкаНаОбъект.Номер) + " контейнер "+СокрЛП(СсылкаНаОбъект.НомерКонтейнера)+" от " + Формат(СсылкаНаОбъект.Дата, "ДЛФ=D") + ".xls";	
			ТабДок.Записать(ИмяФайла, ТипФайлаТабличногоДокумента.XLS);
			
			Вложение1ZIP=КаталогВременныхФайлов()+"\Вложение.zip";
			Архив = Новый ЗаписьZIPФайла(Вложение1ZIP,,,
			МетодСжатияZIP.Сжатие, УровеньСжатияZIP.Максимальный, МетодШифрованияZIP.Zip20);
			Архив.Добавить(ИмяФайла, РежимСохраненияПутейZIP.НеСохранятьПути);
			Архив.Записать();
			ОтправитьАдресату(Вложение1ZIP);
			УдалитьФайлы(ИмяФайла);
		КонецЕсли;
	КонецЕсли;
	возврат ТабДок;
	
КонецФункции

Функция ПечатьСтраховка(ИмяМакета="Макет")
	мВалютаРегламентированногоУчета   = Константы.ВалютаРегламентированногоУчета.Получить();	
	ТабДок=Новый ТабличныйДокумент;
	Макет = ПолучитьМакет(ИмяМакета); 
	
	СведенияОПокупателе  = СведенияОЮрФизЛице(СсылкаНаОбъект.Организация,        СсылкаНаОбъект.Дата,,);	
	
	СтрВрем=СсылкаНаОбъект.ДопПоля;
	Поз=Найти(СтрВрем,"Номер коносамента");
	Если Поз=0 тогда
		Коносамент="Коносамент:";
	Иначе
		СтрВрем=Сред(СтрВрем,Поз+17);
		ПозКонец=Найти(СтрВрем,";");
		Коносамент="Коносамент: "+СокрЛП(Лев(СтрВрем,ПозКонец));
	КонецЕсли;
	
	Если СокрЛП(КоносаментИзФайла)<>"" Тогда
		 Коносамент=СокрЛП(КоносаментИзФайла);
	КонецЕсли;
	СтрВрем=СсылкаНаОбъект.ДопПоля;
	Поз=Найти(СтрВрем,"Условия поставки");
	Если Поз=0 тогда
		УсловияПоставки="";
	Иначе
		СтрВрем=Сред(СтрВрем,Поз+16);
		ПозКонец=Найти(СтрВрем,";");
		УсловияПоставки=СокрЛП(Лев(СтрВрем,ПозКонец));
	КонецЕсли;
	
	СтрВрем=СсылкаНаОбъект.ДопПоля;
	Поз=Найти(СтрВрем,"Порт назначения");
	Если Поз=0 тогда
		ПортНазначения="";
	Иначе
		СтрВрем=Сред(СтрВрем,Поз+15);
		ПозКонец=Найти(СтрВрем,";");
		ПортНазначения=СокрЛП(Лев(СтрВрем,ПозКонец));
		ПортНазначения=СтрЗаменить(ПортНазначения,";","");
	КонецЕсли;
	
	Если ЗначениеЗаполнено(СсылкаНаОбъект.Грузополучатель) тогда
		ГородГрузополучателя="склады в "+ПолучитьГородКонтрагента(СсылкаНаОбъект.Грузополучатель)+" (Россия)";
	Иначе
		Если СсылкаНаОбъект.Подразделение=Справочники.Подразделения.НайтиПоКоду("00005") тогда
			ГородГрузополучателя=" склады в г. Ярославль (Россия)";
		иначеЕсли СсылкаНаОбъект.Подразделение=Справочники.Подразделения.НайтиПоКоду("00106") тогда
			ГородГрузополучателя=" склады в г. Ростов-на-Дону (Россия)";			
		иначеЕсли СсылкаНаОбъект.Подразделение=Справочники.Подразделения.НайтиПоКоду("00112") тогда
			ГородГрузополучателя=" склады в г. Санкт Петербург (Россия)";	
		иначеЕсли СсылкаНаОбъект.Подразделение=Справочники.Подразделения.НайтиПоКоду("00122") тогда
			ГородГрузополучателя=" склады в г. Екатеринбург (Россия)";	
		конецесли;
	КонецЕсли;		
	//СведенияОТранспорте=ПортНазначения+Символы.ПС+ГородГрузополучателя;
	СведенияОТранспорте="";
	
	Если Найти( врег(СсылкаНаОбъект.Товары[0].Номенклатура.Производитель.Наименование), "TREBL")>0 тогда
		НаименованиеГруза = "Новые стальные диски для автомобилей";
	Иначе
		НаименованиеГруза = "Новые алюминиевые диски для автомобилей";
	КонецЕсли;
	
	ОбластьСтраховка= Макет.ПолучитьОбласть("Страховка");
	
	ОбластьСтраховка.Параметры.НаименованиеГруза=НаименованиеГруза;
	ОбластьСтраховка.Параметры.ДатаДок  = Формат(СсылкаНаОбъект.Дата,"ДЛФ=D");
	
	//ОбластьСтраховка.Параметры.НомерКонтейнера = СокрЛП(СсылкаНаОбъект.НомерКонтейнера); 
    Организация=СсылкаНаОбъект.Организация.Наименование;	
	ОбластьСтраховка.Параметры.Организация=Организация;
	ОрганизацияПолноеНаименование=СсылкаНаОбъект.Организация.НаименованиеПолное;
	ОбластьСтраховка.Параметры.ОрганизацияПолноеНаименование=ОрганизацияПолноеНаименование;
	
	ОбластьСтраховка.Параметры.ФактАдрес = СведенияОПокупателе.ФактическийАдрес; 
	ОбластьСтраховка.Параметры.ЮрАдрес	 = СведенияОПокупателе.ЮридическийАдрес;
	ОбластьСтраховка.Параметры.Телефон	 = СведенияОПокупателе.Телефоны;
	
	СуммаДокумента=СсылкаНаОбъект.Товары.Итог("Сумма");
	Коэфф=1.4;
	ПриходВПитер=ложь;
	ПриходвНовороссийск=ложь;
    Порты=СсылкаНаОбъект.СуднаПортыПерегруза;
	Для каждого стр из порты цикл
		Если Найти(ВРЕГ(стр.ПортПерегруза.Наименование),"УСТЬ")>0 или найти(ВРЕГ(стр.ПортПерегруза.Наименование),"СПБ")>0 тогда
			ПриходВПитер=истина;
			прервать;
		КонецЕсли;	
		Если найти(ВРЕГ(стр.ПортПерегруза.Наименование),"НОВ")>0 тогда
			ПриходвНовороссийск=истина;
			прервать;
		КонецЕсли;	
	КонецЦикла;	
	
	Если Найти( врег(СсылкаНаОбъект.Товары[0].Номенклатура.Производитель.Наименование), "TREBL")>0 тогда//штамп 
		Если ПриходВПитер=истина тогда
			Коэфф=1.43;
		ИначеЕсли ПриходвНовороссийск тогда
			Коэфф=1.45;
		КонецЕсли;
	Иначе//литые
		Если ПриходВПитер=истина тогда
			Коэфф=1.37;
		ИначеЕсли ПриходвНовороссийск тогда
			Коэфф=1.36;
		КонецЕсли;
	КонецЕсли;
	МаксСтоимостьГруза=СуммаДокумента*Коэфф;						
	ОбластьСтраховка.Параметры.МаксСтоимостьГруза			= Формат(МаксСтоимостьГруза,"ЧДЦ=2")+" USD";
	ОбъемОтправки="1 контейнер 40""HQ"+Символы.ПС+СокрЛП(СсылкаНаОбъект.НомерКонтейнера);
	ОбластьСтраховка.Параметры.ОбъемОтправки=ОбъемОтправки;
	МаксСтоимостьГрузаРуб=ПересчитатьИзВалютыВВалюту(МаксСтоимостьГруза, СсылкаНаОбъект.ВалютаДокумента, мВалютаРегламентированногоУчета, ПолучитьКурсВалюты(СсылкаНаОбъект.ВалютаДокумента, СсылкаНаОбъект.Дата).Курс, 1);
	МаксСтоимостьГрузаРубПрописью=СформироватьСуммуПрописью(МаксСтоимостьГрузаРуб, мВалютаРегламентированногоУчета);
	ОбластьСтраховка.Параметры.МаксСтоимостьГрузаРуб=""+МаксСтоимостьГрузаРуб+" "+мВалютаРегламентированногоУчета+"("+МаксСтоимостьГрузаРубПрописью+")"+Символы.ПС+
	" или "+Формат(МаксСтоимостьГруза,"ЧДЦ=2")+" USD по курсу ЦБ РФ на "+Формат(СсылкаНаОбъект.Дата,"ДФ=dd.MM.yyyy")+"г.";
	
	
	СуднаПорты=СсылкаНаОбъект.СуднаПортыПерегруза;
	Если СуднаПорты.Количество()>0 тогда
		ПеревозчикГруза=Строка(СуднаПорты[0].ЛинияПеревозки)+" - морской транспорт";
	Иначе
		ПеревозчикГруза="";
	КонецЕсли;
	МаршрутыПеревозки61="";
	Для каждого стр из СуднаПорты Цикл
		ПеревозчикГруза=ПеревозчикГруза+?(ПеревозчикГруза="","",Символы.ПС)+Строка(стр.Судно);	
		МаршрутыПеревозки61=МаршрутыПеревозки61+?(МаршрутыПеревозки61="","",Символы.ПС)+стр.ПортПерегруза.Наименование;	
	КонецЦикла;
	МаршрутыПеревозки65="";
	к=СуднаПорты.Количество();
	Для каждого стр из СуднаПорты Цикл
		МаршрутыПеревозки65=МаршрутыПеревозки65+?(МаршрутыПеревозки65="","",Символы.ПС)+стр.ПортПерегруза.Наименование;	
		к=к-1;
		Если к<=1 тогда
			Прервать;
		КонецЕсли;
	КонецЦикла;

	
	
	ПеревозчикГруза=ПеревозчикГруза+" - автомобильный транспорт";
	
	ОбластьСтраховка.Параметры.Перевозчики=ПеревозчикГруза;
	ОбластьСтраховка.Параметры.МаршрутыПеревозки61=МаршрутыПеревозки61;
	ОбластьСтраховка.Параметры.МаршрутыПеревозки65=МаршрутыПеревозки65;
	
	ОбластьСтраховка.Параметры.Коносамент=Коносамент;
    ОбластьСтраховка.Параметры.ФОБ_СИФ=УсловияПоставки;				
	
	ОбластьСтраховка.Параметры.СведенияОТранспорте=СведенияОТранспорте;
	
	ТабДок.Вывести(ОбластьСтраховка);
     

	возврат ТабДок;
	
КонецФункции

Функция ПолучитьГородКонтрагента(Контр)
	Адрес="";
	Запрос=новый Запрос;
	Запрос.Текст="ВЫБРАТЬ
	|	КонтактнаяИнформация.Представление,
	|	ВЫБОР
	|		КОГДА КонтактнаяИнформация.Поле2 = ""Москва г""
	|				ИЛИ КонтактнаяИнформация.Поле2 = ""Санкт-Петербуг г""
	|			ТОГДА КонтактнаяИнформация.Поле2
	|		КОГДА КонтактнаяИнформация.Поле4 = """"
	|			ТОГДА КонтактнаяИнформация.Поле5
	|		ИНАЧЕ КонтактнаяИнформация.Поле4
	|	КОНЕЦ КАК Город
	|ИЗ
	|	РегистрСведений.КонтактнаяИнформация КАК КонтактнаяИнформация
	|ГДЕ
	|	КонтактнаяИнформация.Объект = &Объект
	|	И КонтактнаяИнформация.Тип = ЗНАЧЕНИЕ(Перечисление.типыКонтактнойИнформации.Адрес)
	|	И КонтактнаяИнформация.Вид = ЗНАЧЕНИЕ(Справочник.ВидыКонтактнойИнформации.ЮрАдресКонтрагента)";
	Запрос.УстановитьПараметр("Объект",Контр);
	Рез=Запрос.Выполнить().Выбрать();
	Пока Рез.Следующий()Цикл
		Если СокрЛП(Рез.Город)="" тогда
			Адрес=Рез.Представление;
		Иначе	 
			Адрес=Рез.Город;
		КонецЕсли;
		Прервать;
	КонецЦикла;
	Возврат Адрес; 
КонецФункции

Процедура ОтправитьАдресату(Файл)
	Почта=Новый ИнтернетПочта;
	УЗ = Справочники.УчетныеЗаписиЭлектроннойПочты.НайтиПоНаименованию("no-reply@yst76.ru");
	ИПП=Новый ИнтернетПочтовыйПрофиль;
	ИПП.АдресСервераSMTP=УЗ.SMTPСервер;
	ИПП.ПортSMTP=УЗ.ПортSMTP;
	Если УЗ.ТребуетсяSMTPАутентификация Тогда
		ИПП.АутентификацияSMTP = СпособSMTPАутентификации.ПоУмолчанию;
		ИПП.ПарольSMTP         = УЗ.ПарольSMTP;
		ИПП.ПользовательSMTP   = УЗ.ЛогинSMTP;
	Иначе
		ИПП.АутентификацияSMTP = СпособSMTPАутентификации.БезАутентификации;
		ИПП.ПарольSMTP         = "";
		ИПП.ПользовательSMTP   = "";
	КонецЕсли;
	
	Письмо=Новый ИнтернетПочтовоеСообщение;
	Письмо.Отправитель=УЗ.АдресЭлектроннойПочты;
	//Письмо.Получатели.Добавить("medvedev@yst76.ru");
	Письмо.Получатели.Добавить("serebrennikovaa@mail.ru");
	Письмо.Тема="Приход контейнера!";
	Письмо.ИмяОтправителя =""+глТекущийПользователь;
	Письмо.Организация ="ТК ""Яршинторг""";
	Письмо.Вложения.Добавить(Файл);
	Письмо.Тексты.Добавить("Страховое заявление.",ТипТекстаПочтовогоСообщения.ПростойТекст);
	Письмо.ОбработатьТексты();

	попытка
		Почта.Подключиться(ИПП);
		Почта.Послать(Письмо);
		Почта.Отключиться();
		#Если Клиент Тогда
			сообщить(" >>>  Письмо отправлено.", СтатусСообщения.Информация);
		#КонецЕсли
	исключение
		попытка
			Пауза(2);
			Почта.Подключиться(ИПП);
			Почта.Послать(Письмо);
			Почта.Отключиться();
			#Если Клиент Тогда
				сообщить(" >>>  Письмо отправлено со второй попытки", СтатусСообщения.Информация);
			#КонецЕсли
		исключение
			#Если Клиент Тогда
				сообщить("xxxxx Ошибка при отправке письма - "+ОписаниеОшибки()+" попробуем еще раз.", СтатусСообщения.Внимание);
			#КонецЕсли
		конецПопытки;
	конецПопытки;

КонецПроцедуры

Процедура Пауза(Сек)
	scr = Новый COMОбъект("WScript.Shell");
	scr.Run("sleep "+СокрЛП(Число(Сек)),0,1);
КонецПроцедуры
