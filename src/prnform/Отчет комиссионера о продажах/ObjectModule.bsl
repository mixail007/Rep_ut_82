

функция получитьТекстПечФорма()
	текст1 = "ВЫБРАТЬ
	|	Номер,
	|	Дата,
	|	ДоговорКонтрагента,
	|	Контрагент,
	|	Организация,
	|	СуммаДокумента,
	|	ВалютаДокумента,
	|	УчитыватьНДС,
	|	СуммаВключаетНДС,
	|	Товары.(
	|		НомерСтроки,
	|		Номенклатура,
	|		Номенклатура.НаименованиеПолное КАК Товар,
	|		КоличествоМест,
	|		Количество,
	|		ЕдиницаИзмеренияМест.Представление  КАК ЕдиницаИзмеренияМест,
	|		ЕдиницаИзмерения.Представление  КАК ЕдиницаИзмерения,
	|		Цена,
	|		Сумма,
	|		СуммаВознаграждения КАК Вознаграждение,
	|		СуммаНДС,
	|		ХарактеристикаНоменклатуры КАК Характеристика,
	|		СерияНоменклатуры КАК Серия
	|	)
	|ИЗ
	|	Документ.ОтчетКомиссионераОПродажах КАК ОтчетКомиссионераОПродажах
	|
	|ГДЕ
	|	ОтчетКомиссионераОПродажах.Ссылка = &ТекущийДокумент
	|
	|УПОРЯДОЧИТЬ ПО
	|	Товары.НомерСтроки
	|";

	возврат текст1;
КонецФункции	

функция получитьТекстОтчетаПоКомиссионеру()
	текст1 = "ВЫБРАТЬ
	         |	ОтчетКомиссионераОПродажах.Ссылка.Номер КАК Номер,
	         |	ОтчетКомиссионераОПродажах.Ссылка.Дата КАК Дата,
			 //+++ сделка
	         |	ОтчетКомиссионераОПродажах.Ссылка.Сделка КАК Сделка,
	         |	ОтчетКомиссионераОПродажах.Ссылка.ДоговорКонтрагента КАК ДоговорКонтрагента,
	         |	ОтчетКомиссионераОПродажах.Ссылка.Контрагент КАК Контрагент,
	         |	ОтчетКомиссионераОПродажах.Ссылка.Организация КАК Организация,
	         |	ОтчетКомиссионераОПродажах.Ссылка.СуммаДокумента КАК СуммаДокумента,
	         |	ОтчетКомиссионераОПродажах.Ссылка.ВалютаДокумента КАК ВалютаДокумента,
	         |	ОтчетКомиссионераОПродажах.Ссылка.УчитыватьНДС КАК УчитыватьНДС,
	         |	ОтчетКомиссионераОПродажах.Ссылка.СуммаВключаетНДС КАК СуммаВключаетНДС,
	         |	ОтчетКомиссионераОПродажах.Номенклатура,
	         |	Выразить( ОтчетКомиссионераОПродажах.Номенклатура.НаименованиеПолное как Строка(1000) ) КАК Товар,
	         |	ОтчетКомиссионераОПродажах.КоличествоМест КАК КоличествоМест,
	         |	ОтчетКомиссионераОПродажах.Количество КАК Количество,
	         |	ОтчетКомиссионераОПродажах.ЕдиницаИзмеренияМест.Представление КАК ЕдиницаИзмеренияМест,
	         |	ОтчетКомиссионераОПродажах.ЕдиницаИзмерения.Представление КАК ЕдиницаИзмерения,
	         |	ОтчетКомиссионераОПродажах.Цена КАК Цена,
	         |	ОтчетКомиссионераОПродажах.Сумма КАК Сумма,
	         |	ОтчетКомиссионераОПродажах.СуммаВознаграждения КАК Вознаграждение,
	         |	ОтчетКомиссионераОПродажах.СуммаНДС КАК СуммаНДС,
	         |	ОтчетКомиссионераОПродажах.ХарактеристикаНоменклатуры КАК Характеристика,
	         |	ОтчетКомиссионераОПродажах.СерияНоменклатуры КАК Серия
	         |ИЗ
	         |	Документ.ОтчетКомиссионераОПродажах.Товары КАК ОтчетКомиссионераОПродажах
	         |ГДЕ
	         |	ОтчетКомиссионераОПродажах.Ссылка.Контрагент = &Контрагент
	         |"+?(ЗначениеЗаполнено(ЭтотОбъект.ДоговорКонтрагента), "И ОтчетКомиссионераОПродажах.ссылка.ДоговорКонтрагента = &ДоговорКонтрагента
	         |","")+?(ЗначениеЗаполнено(ЭтотОбъект.ДатаОтчета), " И ОтчетКомиссионераОПродажах.ссылка.Дата <= &Дата
	         |","")+"
			 | УПОРЯДОЧИТЬ ПО
	         |	Номенклатура, Дата, Номер";
 	
	возврат текст1;
КонецФункции	


 Функция Печать() Экспорт

	Запрос = Новый Запрос;
	
//печатная форма документа	
Если не ЭтотОбъект.ВариантОтчета тогда	
	Запрос.Текст = получитьТекстПечФорма();
	Запрос.УстановитьПараметр("ТекущийДокумент", ЭтотОбъект.СсылкаНаОбъект);
	Шапка = Запрос.Выполнить().Выбрать();
	Шапка.Следующий();
	ВыборкаСтрокТовары = Шапка.Товары.Выбрать();
ИНАЧЕ
	Запрос.Текст = получитьТекстОтчетаПоКомиссионеру();  //пока не готов
	Запрос.УстановитьПараметр("Контрагент", ЭтотОбъект.Контрагент);
	Запрос.УстановитьПараметр("ДоговорКонтрагента", ЭтотОбъект.ДоговорКонтрагента);
	Запрос.УстановитьПараметр("Дата", ЭтотОбъект.ДатаОтчета);
	Шапка = Запрос.Выполнить().Выбрать();
	Шапка.Следующий();
	ВыборкаСтрокТовары = Шапка;
КонецЕсли;

		ТабДокумент = Новый ТабличныйДокумент;
	ТабДокумент.ИмяПараметровПечати = "ПАРАМЕТРЫ_ПЕЧАТИ_ОтчетКомиссионераОПродажах_ВнешняяПечФорма";

	Макет = ПолучитьМакет("Макет");

	// Выводим шапку накладной

	ОбластьМакета = Макет.ПолучитьОбласть("Заголовок");
	Если не ЭтотОбъект.ВариантОтчета тогда
		ОбластьМакета.Параметры.ТекстЗаголовка = СформироватьЗаголовокДокумента(Шапка, "Отчет комиссионера");
	иначе
		ОбластьМакета.Параметры.ТекстЗаголовка = "Комиссионер: "+ЭтотОбъект.Контрагент.НаименованиеПолное;
	КонецЕсли;		
	ТабДокумент.Вывести(ОбластьМакета);

	ПредставлениеОрганизации = ОписаниеОрганизации(СведенияОЮрФизЛице(Шапка.Организация, Шапка.Дата), "ПолноеНаименование,");
	ПредставлениеКонтрагента = ОписаниеОрганизации(СведенияОЮрФизЛице(Шапка.Контрагент, Шапка.Дата), "ПолноеНаименование,");

	ОбластьМакета = Макет.ПолучитьОбласть("Поставщик");
	ОбластьМакета.Параметры.ПредставлениеПоставщика = ПредставлениеОрганизации;
	ОбластьМакета.Параметры.Поставщик = Шапка.Организация;
	ТабДокумент.Вывести(ОбластьМакета);

	ОбластьМакета = Макет.ПолучитьОбласть("Покупатель");
	ОбластьМакета.Параметры.ПредставлениеПолучателя = ПредставлениеКонтрагента;
	ОбластьМакета.Параметры.Получатель = Шапка.Контрагент;
	ТабДокумент.Вывести(ОбластьМакета);

	ФлагПечатиМест = (СсылкаНаОбъект.Товары.Итог("КоличествоМест") > 0);
	ОбластьМакета  = Макет.ПолучитьОбласть("ШапкаТаблицы" + ?(ФлагПечатиМест, "Мест", ""));
	ОбластьСтроки  = Макет.ПолучитьОбласть("Строка"       + ?(ФлагПечатиМест, "Мест", ""));

	ТабДокумент.Вывести(ОбластьМакета);

	Сумма    = 0;
	СуммаНДС = 0;
    Вознаграждение = 0; //+++
	//+++ ВыборкаСтрокТовары = Шапка.Товары.Выбрать();
	Пока ВыборкаСтрокТовары.Следующий() Цикл

		Если не ЭтотОбъект.ВариантОтчета тогда
			Если ЗначениеНеЗаполнено(ВыборкаСтрокТовары.Номенклатура) Тогда
			Сообщить("В "+строка(ВыборкаСтрокТовары.НомерСтроки)+" строке не заполнено значение Номенклатуры - строка при печати пропущена.", СтатусСообщения.Важное);
			Продолжить;
			КонецЕсли;
		КонецЕсли;

		ОбластьСтроки.Параметры.Заполнить(ВыборкаСтрокТовары);
		//+++( наши поля
		ОбластьСтроки.Параметры.Код     = ВыборкаСтрокТовары.Номенклатура.Код; 
		ОбластьСтроки.Параметры.Артикул = ВыборкаСтрокТовары.Номенклатура.Артикул;
		ОбластьСтроки.Параметры.Характеристика = ПредставлениеСерий(ВыборкаСтрокТовары); //Хар-ка и/или (Серия)
		// найдем сделку
		//СтруктураШапкиДокумента = СформироватьСтруктуруШапкиДокумента(СсылкаНаОбъект); //общ.назначения
		//Сделка                  = ОпределитьСделку(СсылкаНаОбъект, СтруктураШапкиДокумента);
		Если не ЭтотОбъект.ВариантОтчета тогда
			Если ЗначениеЗаполнено(СсылкаНаОбъект.Сделка) тогда
			ОбластьСтроки.Параметры.ДатаПоставки   = СсылкаНаОбъект.Сделка.Дата; //из сделки
			иначе	
			ОбластьСтроки.Параметры.ДатаПоставки   = ""; //сделка не найдена
			КонецЕсли;
		иначе
			Если ЗначениеЗаполнено(ВыборкаСтрокТовары.Сделка) тогда
			ОбластьСтроки.Параметры.ДатаПоставки   = ВыборкаСтрокТовары.Сделка.Дата;
			иначе	
			ОбластьСтроки.Параметры.ДатаПоставки   = ""; //сделка не найдена
			КонецЕсли;
		КонецЕсли;	
		//+++)
		ТабДокумент.Вывести(ОбластьСтроки);

		Сумма    = Сумма    + ВыборкаСтрокТовары.Сумма;
		СуммаНДС = СуммаНДС + ВыборкаСтрокТовары.СуммаНДС;
        Вознаграждение = Вознаграждение+ ВыборкаСтрокТовары.Вознаграждение; //+++
	КонецЦикла;

	// Вывести Итого
	ОбластьМакета = Макет.ПолучитьОбласть("Итого");
	ОбластьМакета.Параметры.Всего = ФорматСумм(Шапка.СуммаДокумента);
	ОбластьМакета.Параметры.ВсегоВознаграждение = ФорматСумм(Вознаграждение);
	
	ТабДокумент.Вывести(ОбластьМакета);

	// Вывести ИтогоНДС
	Если Шапка.УчитыватьНДС тогда
		ОбластьМакета = Макет.ПолучитьОбласть("ИтогоНДС");
		ОбластьМакета.Параметры.ВсегоНДС = ФорматСумм(СсылкаНаОбъект.Товары.Итог("СуммаНДС"));
		ОбластьМакета.Параметры.НДС = ?(Шапка.СуммаВключаетНДС, "В том числе НДС:", "Сумма НДС:");
		ТабДокумент.Вывести(ОбластьМакета);
	КонецЕсли;

	// Вывести Сумму прописью
	ОбластьМакета = Макет.ПолучитьОбласть("СуммаПрописью");
	СуммаКПрописи = Сумма + ?(Шапка.СуммаВключаетНДС, 0, СуммаНДС);
	ОбластьМакета.Параметры.ИтоговаяСтрока ="Всего наименований " + ВыборкаСтрокТовары.Количество()
	+ ", на сумму: " + ФорматСумм(СуммаКПрописи, Шапка.ВалютаДокумента)+", сумма вознаграждения: "+ФорматСумм(Вознаграждение, Шапка.ВалютаДокумента);
	ОбластьМакета.Параметры.СуммаПрописью = 			  "Сумма оплаты комитенту : "+СформироватьСуммуПрописью(СуммаКПрописи, Шапка.ВалютаДокумента);
	ОбластьМакета.Параметры.СуммаПрописьюВознаграждение = "Сумма вознаграждения   : "+СформироватьСуммуПрописью(Вознаграждение, Шапка.ВалютаДокумента);
	ТабДокумент.Вывести(ОбластьМакета);

	// Вывести подписи
	ОбластьМакета = Макет.ПолучитьОбласть("Подписи");
	ТабДокумент.Вывести(ОбластьМакета);

	Возврат ТабДокумент;

КонецФункции // ПечатьОтчетаКомиссионера()

 