
Перем КоличествоСтрокНаЛисте;
Перем КоличествоСтрокШапки;
Перем КоличествоСтрокПодвала;	
Перем КоличествоСтрокШапкиВторойСтраницы;
Перем Контрагент;	

Функция ПолучитьСуммуПрописью(ВсегоКоличество,ВсегоСумма, ВалютаДокумента)
	СтрокаВозврата = "Всего получено: " + Лев(ЧислоПрописью(ВсегоКоличество,"НД=ложь"),Найти(ЧислоПрописью(ВсегоКоличество,"НД=ложь"),"00") - 1) + "единиц(ы) товара. На сумму: " + ЧислоПрописью(ВсегоСумма, ,ВалютаДокумента.ПараметрыПрописиНаРусском);	
	Возврат СтрокаВозврата;
КонецФункции

Процедура УстановитьЗначенияКоличестваСтрокНаЛисте()
	КоличествоСтрокНаЛисте	= 57;
	КоличествоСтрокШапки 	= 28;
	КоличествоСтрокПодвала	= 15;	
	КоличествоСтрокШапкиВторойСтраницы = 6;
КонецПроцедуры

// Функция берет реквизиты шапки документа и возвращает структуру.
Функция ЗаполнитьРеквизитыШапки(ДокументСсылка)
	СтруктураШапки = Новый Структура;
	ЗапросПоРеквизитам = Новый Запрос;
	ЗапросПоРеквизитам.УстановитьПараметр("Ссылка",ДокументСсылка);
	
		Контрагент   = Справочники.Контрагенты.ПустаяСсылка();
		ДоговорКонтр = Справочники.ДоговорыКонтрагентов.ПустаяСсылка();
		
	Если ТипЗнч(ДокументСсылка)=Тип("ДокументСсылка.ПеремещениеТоваров") тогда
		//проверим, что есть вн.заказ!
		Если ЗначениеЗаполнено(ДокументСсылка.ВнутреннийЗаказ) тогда
			Если ЗначениеЗаполнено(ДокументСсылка.ВнутреннийЗаказ.ДокументОснование) тогда
				Контрагент   = ДокументСсылка.ВнутреннийЗаказ.ДокументОснование.Контрагент;
				ДоговорКонтр = ДокументСсылка.ВнутреннийЗаказ.ДокументОснование.ДоговорКонтрагента;
			иначе
				сообщить("В документе ""Внутренний заказ"" не заполнено поле ""Документ основание"" !", СтатусСообщения.Внимание);	
			КонецЕсли;
		иначе
			сообщить("В документе ""Перемещение товаров"" не заполнен ""Внутренний заказ""!", СтатусСообщения.Внимание);	
		КонецЕсли;
		ЗапросПоРеквизитам.УстановитьПараметр("Контрагент", Контрагент);
		ЗапросПоРеквизитам.Текст = "ВЫБРАТЬ
		                           |	Док.Организация,
		                           |	&Контрагент КАК Контрагент,
		                           |	Док.Номер,
		                           |	Док.Дата,
								   |	Док.Комментарий
		                           |ИЗ
		                           |	Документ.ПеремещениеТоваров КАК Док
		                           |ГДЕ
		                           |	Док.Ссылка = &Ссылка";
	иначе
		ЗапросПоРеквизитам.Текст = "
		|ВЫБРАТЬ
		|		Организация,
		|		Контрагент,
		| 		Номер,	
		|		Дата
		|ИЗ 	Документ.ОприходованиеТоваров как Док	 
		|ГДЕ    Док.Ссылка = &Ссылка";
	КонецЕсли;
	
	Шапка = ЗапросПоРеквизитам.Выполнить().Выбрать();
	Если Шапка.Следующий() Тогда
		СведенияОбОрганизации 			= СведенияОЮрФизЛице(Шапка.Организация, Шапка.Дата);
		СведенияОПоклажедателе 			= "";
		ПредставлениеОрганизации   		= "";
		
		Если ЗначениеЗаполнено(Шапка.Контрагент) Тогда
			СведенияОПоклажедателе = СведенияОЮрФизЛице(Шапка.Контрагент, Шапка.Дата);
		   ПредставлениеОрганизации   		= ОписаниеОрганизации(СведенияОПоклажедателе,"ПолноеНаименование,ИНН,ЮридическийАдрес,Телефоны,НомерСчета,Банк,БИК,КоррСчет");
		КонецЕсли;
	 	ПредставлениеПоклажедателя     		= ОписаниеОрганизации(СведенияОбОрганизации,"ПолноеНаименование,ИНН,ЮридическийАдрес,Телефоны,НомерСчета,Банк,БИК,КоррСчет");
		
		Валюта								= Шапка.Организация.ОсновнойБанковскийСчет.ВалютаДенежныхСредств;
		СтруктураШапки.Вставить("Организация",ПредставлениеОрганизации);
		СтруктураШапки.Вставить("Поклажедатель",ПредставлениеПоклажедателя);
		 //+++ 21.02.2012
		СтруктураШапки.Вставить("ДоговорКонтрНомер",ДоговорКонтр.Номер);
		СтруктураШапки.Вставить("ДоговорКонтрДата", ДоговорКонтр.дата);
		СтруктураШапки.Вставить("Комментарий",      Шапка.Комментарий);
		
		СтруктураШапки.Вставить("Номер",Шапка.Номер);
		СтруктураШапки.Вставить("Дата",Шапка.Дата);
		СтруктураШапки.Вставить("Валюта",Валюта);
		Возврат СтруктураШапки;
	КонецЕсли; 
	Возврат Неопределено;
КонецФункции




Процедура ПечатьДокумента(СтруктураШапки,ДокументОприходования,КоличествоКопий=1,НаПринтер=Истина);
	
	ЗапросПоТоварам = Новый Запрос;
	ЗапросПоТоварам.УстановитьПараметр("Ссылка",ДокументОприходования);
	ТабДок = новый ТабличныйДокумент;
	
	Если ТипЗнч(ДокументОприходования)=Тип("ДокументСсылка.ПеремещениеТоваров") тогда
	ЗапросПоТоварам.Текст = "ВЫБРАТЬ
	                        |	Док.Номенклатура.Наименование КАК Наименование,
	                        |	Док.Номенклатура.Код КАК Код,
	                        |	Док.ХарактеристикаНоменклатуры как Характеристика,
	                        |	Док.Номенклатура.БазоваяЕдиницаИзмерения.Наименование КАК ЕдиницаИзмерения,
	                        |	Док.Номенклатура.БазоваяЕдиницаИзмерения.Код КАК КодЕдиницы,
	                        |	Док.Количество КАК Количество,
	                        |	ЕСТЬNULL(ЗаказПокупателяТовары.Цена, 0) КАК Цена,
	                        |	ЕСТЬNULL(ЗаказПокупателяТовары.Цена, 0) * Док.Количество КАК Сумма
	                        |ИЗ
	                        |	Документ.ПеремещениеТоваров.Товары КАК Док
	                        |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказПокупателя.Товары КАК ЗаказПокупателяТовары
	                        |		ПО Док.Ссылка.ВнутреннийЗаказ.ДокументОснование = ЗаказПокупателяТовары.Ссылка
	                        |			И Док.Номенклатура = ЗаказПокупателяТовары.Номенклатура
	                        |			И Док.ХарактеристикаНоменклатуры = ЗаказПокупателяТовары.ХарактеристикаНоменклатуры
	                        |ГДЕ
	                        |	Док.Ссылка = &Ссылка
	                        |
	                        |УПОРЯДОЧИТЬ ПО
	                        |	Док.НомерСтроки
	                        |АВТОУПОРЯДОЧИВАНИЕ";
	иначе
		
//+++( себестоимость оприходования - только для Старших менеджеров
Если ПолучитьЗначениеПоУмолчанию(ПараметрыСеанса.ТекущийПользователь, "УчетТолькоПоПодразделениюПользователя") 
 И НЕ ПолучитьЗначениеПоУмолчанию(ПараметрыСеанса.ТекущийПользователь, "СтаршийМенеджерПодразделения") Тогда
 	Предупреждение("У вас недостаточно прав для печати данной формы!",60);
	Возврат;
КонецЕсли;

	ЗапросПоТоварам.Текст = "ВЫБРАТЬ
	                        |	Док.Номенклатура.Наименование КАК Наименование,
	                        |	Док.Номенклатура.Код КАК Код,
	                        |	Док.ХарактеристикаНоменклатуры как Характеристика,
	                      	|	Док.Номенклатура.БазоваяЕдиницаИзмерения.Наименование КАК ЕдиницаИзмерения,
	                        |	Док.Номенклатура.БазоваяЕдиницаИзмерения.Код КАК КодЕдиницы,
	                        |	Док.Количество КАК Количество,
	                        |	Док.Цена КАК Цена,
	                        |	Док.Сумма КАК Сумма
	                        |ИЗ
	                        |	Документ.ОприходованиеТоваров.Товары КАК Док
	                        |ГДЕ
	                        |	Док.Ссылка = &Ссылка";
	КонецЕсли;

	Выборка = ЗапросПоТоварам.Выполнить().Выбрать();
	
	Если (Выборка.Количество()>0) Тогда 
		Если (Выборка.Количество() + КоличествоСтрокШапки + КоличествоСтрокПодвала)> КоличествоСтрокНаЛисте Тогда	 		
			// Многостраничный вывод
			// Первая страница
        	МакетОсновной 							= ПолучитьМакет("МакетПервойСтраницы");
			МакетОстальные 							= ПолучитьМакет("МакетВторойСтраницы");
			ШапкаОсновная							= МакетОсновной.ПолучитьОбласть("Шапка");
			ШапкаОсновная.Параметры.Организация 	= СтруктураШапки.Организация;
			ШапкаОсновная.Параметры.Поклажедатель 	= СтруктураШапки.Поклажедатель;
			ШапкаОсновная.Параметры.Номер 			= СтруктураШапки.Номер;				
			ШапкаОсновная.Параметры.Дата 			= Формат(СтруктураШапки.Дата,"ДЛФ=D");	
			//+++ 21.02.2012
			ШапкаОсновная.Параметры.НомерДоговора = СтруктураШапки.ДоговорКонтрНомер;
			ШапкаОсновная.Параметры.ДатаДоговора  = Формат(СтруктураШапки.ДоговорКонтрДата,"ДЛФ=D");
			
			
			ШапкаОсновная.Параметры.Страница		= "Страница 1";
			ТабДок.Вывести(ШапкаОсновная);
			СтрокаОсновная							= МакетОсновной.ПолучитьОбласть("Строка");
			Номер 									= 1;
			ИтогоКоличество 						= 0;
			ИтогоСумма 								= 0;
			НомерПозиции							= КоличествоСтрокШапки + 1;
			КоличествоВВыборке						= Выборка.Количество();
			
			Условие = Выборка.Следующий();
			Пока (Условие) и (НомерПозиции<=(КоличествоСтрокНаЛисте)) Цикл
				СтрокаОсновная.Параметры.Номер 			= 	Номер;
				СтрокаОсновная.Параметры.Наименование 	= 	Выборка.Наименование;
				СтрокаОсновная.Параметры.Код			=	Выборка.Код;
				СтрокаОсновная.Параметры.Характеристика =   Выборка.Характеристика;//+++ 21/02/2012
				СтрокаОсновная.Параметры.ЕдНаим			=   Выборка.ЕдиницаИзмерения;
				СтрокаОсновная.Параметры.ЕдКод			= 	Выборка.КодЕдиницы;
				СтрокаОсновная.Параметры.Количество		= 	Выборка.Количество;
				СтрокаОсновная.Параметры.Цена			= 	Формат(Выборка.Цена,"ЧДЦ=2");
				СтрокаОсновная.Параметры.Стоимость		= 	Формат(Выборка.Сумма,"ЧДЦ=2");
				Номер 									= 	Номер 	+ 1;
				ИтогоКоличество 						= 	ИтогоКоличество + Выборка.Количество;
				ИтогоСумма 								= 	ИтогоСумма		+ Выборка.Сумма;
				ТабДок.Вывести(СтрокаОсновная);
				НомерПозиции							= 	НомерПозиции + 1;
				Условие 								= 	Выборка.Следующий();
				КоличествоВВыборке						= 	КоличествоВВыборке - 1;
			КонецЦикла;
			СтрокаИтого 							= МакетОсновной.ПолучитьОбласть("СтрокаИтого"); 
			СтрокаИтого.Параметры.ИтогоКоличество 	= ИтогоКоличество;
			СтрокаИтого.Параметры.ИтогоСтоимость 	= Формат(ИтогоСумма,"ЧДЦ=2");
			ТабДок.Вывести(СтрокаИтого);
			// Остальные страницы
			ВсегоКоличество 						= ИтогоКоличество;
			ВсегоСумма								= ИтогоСумма;
			ИтогоКоличество							= 0;
			ИтогоСумма								= 0;
			Страница 								= 1;

			Если (Условие) Тогда
				ТабДок.ВывестиГоризонтальныйРазделительСтраниц();
				Страница 								= Страница 								+ 1;
				НомерПозиции = КоличествоСтрокШапкиВторойСтраницы;
				ШапкаВторая								= МакетОстальные.ПолучитьОбласть("Шапка");
				ШапкаВторая.Параметры.Страница			= "Страница " + Строка(Страница);
				ТабДок.Вывести(ШапкаВторая);			
				СтрокаОстальные							= МакетОстальные.ПолучитьОбласть("Строка");			
				Условие 								= Истина;				
				НачалоСтраницы = Ложь;
				
				Пока Условие Цикл								
					СтрокаОстальные.Параметры.Номер 			= 	Номер;
					СтрокаОстальные.Параметры.Наименование 		= 	Выборка.Наименование;
					СтрокаОстальные.Параметры.Код				=	Выборка.Код;
					СтрокаОстальные.Параметры.Характеристика 	=   Выборка.Характеристика;//+++ 21/02/2012
					СтрокаОстальные.Параметры.ЕдНаим			=   Выборка.ЕдиницаИзмерения;
					СтрокаОстальные.Параметры.ЕдКод				= 	Выборка.КодЕдиницы;
					СтрокаОстальные.Параметры.Количество		= 	Выборка.Количество;
					СтрокаОстальные.Параметры.Цена				= 	Формат(Выборка.Цена,"ЧДЦ=2");
					СтрокаОстальные.Параметры.Стоимость			= 	Формат(Выборка.Сумма,"ЧДЦ=2");
					Номер 										= 	Номер 	+ 1;
					ИтогоКоличество 							= 	ИтогоКоличество 	+ Выборка.Количество;
					ИтогоСумма 									= 	ИтогоСумма			+ Выборка.Сумма;
					ТабДок.Вывести(СтрокаОстальные);
					НомерПозиции								= НомерПозиции + 1;
					Если ((НомерПозиции>=(КоличествоСтрокНаЛисте))) Тогда
				// Выведем итого
						НомерПозиции 							= КоличествоСтрокШапкиВторойСтраницы;
						СтрокаИтого 							= МакетОсновной.ПолучитьОбласть("СтрокаИтого"); 
						СтрокаИтого.Параметры.ИтогоКоличество 	= ИтогоКоличество;
						СтрокаИтого.Параметры.ИтогоСтоимость 	= Формат(ИтогоСумма,"ЧДЦ=2");
						ВсегоСумма 								= ВсегоСумма + ИтогоСумма;
						ВсегоКоличество 						= ВсегоКоличество + ИтогоКоличество;
						ТабДок.Вывести(СтрокаИтого);
						ИтогоКоличество 						= 0;
						ИтогоСумма 								= 0;					
						НачалоСтраницы = Истина;
					КонецЕсли;
					Условие 									= Выборка.Следующий(); 
					КоличествоВВыборке						= 	КоличествоВВыборке - 1;
					Если (Условие и НачалоСтраницы) Тогда
						ТабДок.ВывестиГоризонтальныйРазделительСтраниц();	
						Страница								= Страница + 1;
						ШапкаВторая.Параметры.Страница			= "Страница " + Строка(Страница);
						ТабДок.Вывести(ШапкаВторая);			
						НачалоСтраницы 							= Ложь;
					ИначеЕсли((Не(Условие))) Тогда 
						СтрокаИтого 							= МакетОсновной.ПолучитьОбласть("СтрокаИтого"); 
						СтрокаИтого.Параметры.ИтогоКоличество 	= ИтогоКоличество;
						СтрокаИтого.Параметры.ИтогоСтоимость 	= Формат(ИтогоСумма,"ЧДЦ=2");
						ВсегоСумма 								= ВсегоСумма + ИтогоСумма;
						ВсегоКоличество 						= ВсегоКоличество + ИтогоКоличество;
						ТабДок.Вывести(СтрокаИтого);						
					КонецЕсли;	
				КонецЦикла;
				КонецЕсли; 				
				// Выводим последний подвал
					//ВсегоКоличество = ВсегоКоличество + ИтогоКоличество;
					//ВсегоСумма = ВсегоСумма + ИтогоСумма;
					СтрокаИтого									= МакетОстальные.ПолучитьОбласть("СтрокаИтого");  
					СтрокаИтого.Параметры.АктКоличество	 		= ВсегоКоличество;
					СтрокаИтого.Параметры.АктСтоимость 			= Формат(ВсегоСумма,"ЧДЦ=2");			
					ТабДок.Вывести(СтрокаИтого);
					Подвал										= МакетОстальные.ПолучитьОбласть("Подвал");
					Если ((НомерПозиции + КоличествоСтрокПодвала)>КоличествоСтрокНаЛисте) Тогда
						ТабДок.ВывестиГоризонтальныйРазделительСтраниц();
						Подвал.Параметры.Страница				= "Страница " + Строка(Страница + 1);
					КонецЕсли;
					СуммаПрописью = ПолучитьСуммуПрописью(ВсегоКоличество,ВсегоСумма, СтруктураШапки.Валюта);
					Подвал.Параметры.Принято					= СуммаПрописью;
					
					строкаНомеров="";
					СтрокаКомментарий = СтрЗаменить(СтруктураШапки.Комментарий, Символы.ПС,"");
					СтрокаКомментарий = СтрЗаменить(СтрокаКомментарий, "ИМ",Символы.ПС);
					Для Счетчик = 2 По СтрЧислоСтрок(СтрокаКомментарий) Цикл 
						строкаНомеров = строкаНомеров + "ИМ" + Лев(СтрПолучитьСтроку(СтрокаКомментарий, Счетчик),8)+";" 
					КонецЦикла; 
					Подвал.Параметры.НомераИМ					= строкаНомеров;
					
					
					ТабДок.Вывести(Подвал);
		Иначе
			// Одностраничный вывод 
			Макет 		= ПолучитьМакет("МакетПервойСтраницы");
			МакетВторой = ПолучитьМакет("МакетВторойСтраницы");
			Шапка = Макет.ПолучитьОбласть("Шапка");
			Шапка.Параметры.Организация = СтруктураШапки.Организация;
			Шапка.Параметры.Поклажедатель = СтруктураШапки.Поклажедатель;
			Шапка.Параметры.Номер = СтруктураШапки.Номер;				
			Шапка.Параметры.Дата  = Формат(СтруктураШапки.Дата,"ДЛФ=D");	
			//+++ 21.02.2012
			Шапка.Параметры.НомерДоговора = СтруктураШапки.ДоговорКонтрНомер;
			Шапка.Параметры.ДатаДоговора  = Формат(СтруктураШапки.ДоговорКонтрДата,"ДЛФ=D");
			
			ТабДок.Вывести(Шапка);
			Строка = Макет.ПолучитьОбласть("Строка");
			Номер 			= 1;
			ИтогоКоличество = 0;
			ИтогоСумма 		= 0;
			Пока Выборка.Следующий() Цикл
				Строка.Параметры.Номер 			= 	Номер;
				Строка.Параметры.Наименование 	= 	Выборка.Наименование;
				Строка.Параметры.Код			=	Выборка.Код;
				Строка.Параметры.Характеристика =   Выборка.Характеристика;//+++ 21/02/2012
				Строка.Параметры.ЕдНаим			=   Выборка.ЕдиницаИзмерения;
				Строка.Параметры.ЕдКод			= 	Выборка.КодЕдиницы;
				Строка.Параметры.Количество		= 	Выборка.Количество;
				Строка.Параметры.Цена			= 	формат(Выборка.Цена,"ЧДЦ=2");
				Строка.Параметры.Стоимость		= 	формат(Выборка.Сумма,"ЧДЦ=2");
				Номер 					= 	Номер 	+ 1;
				ИтогоКоличество = ИтогоКоличество 	+ Выборка.Количество;
				ИтогоСумма 		= ИтогоСумма		+ Выборка.Сумма;
				ТабДок.Вывести(Строка);
			КонецЦикла;
			СтрокаИтого 							= Макет.ПолучитьОбласть("СтрокаИтого"); 
			СтрокаИтого.Параметры.ИтогоКоличество 	= ИтогоКоличество;
			СтрокаИтого.Параметры.ИтогоСтоимость 	= Формат(ИтогоСумма,"ЧДЦ=2");
			ТабДок.Вывести(СтрокаИтого);
			СтрокаИтого 							= МакетВторой.ПолучитьОбласть("СтрокаИтого"); 
			СтрокаИтого.Параметры.АктКоличество		= ИтогоКоличество;
			СтрокаИтого.Параметры.АктСтоимость		= Формат(ИтогоСумма,"ЧДЦ=2");
			ТабДок.Вывести(СтрокаИтого);
			СуммаПрописью = ПолучитьСуммуПрописью(ИтогоКоличество,ИтогоСумма, СтруктураШапки.Валюта);
			Подвал 									= Макет.ПолучитьОбласть("Подвал");  
			Подвал.Параметры.Принято				= СуммаПрописью; 
			
			
			строкаНомеров="";
			СтрокаКомментарий = СтрЗаменить(СтруктураШапки.Комментарий, Символы.ПС,"");
			СтрокаКомментарий = СтрЗаменить(СтрокаКомментарий, "ИМ",Символы.ПС);
			Для Счетчик = 2 По СтрЧислоСтрок(СтрокаКомментарий) Цикл 
				строкаНомеров = строкаНомеров + "ИМ" + Лев(СтрПолучитьСтроку(СтрокаКомментарий, Счетчик),8)+";" 
			КонецЦикла; 
			Подвал.Параметры.НомераИМ					= строкаНомеров;

			
			ТабДок.Вывести(Подвал);
		КонецЕсли;		
		ТабДок.АвтоМасштаб	=	Истина;
		ТабДок.Показать();
	КонецЕсли;
	
КонецПроцедуры

Функция Печать() Экспорт
	
	УстановитьЗначенияКоличестваСтрокНаЛисте();
	СтруктураШапки = ЗаполнитьРеквизитыШапки(СсылкаНаОбъект);
	Если СтруктураШапки<>Неопределено Тогда
		ПечатьДокумента(СтруктураШапки,СсылкаНаОбъект,1,Ложь);
	КонецЕсли;
	
КонецФункции
